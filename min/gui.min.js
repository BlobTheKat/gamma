document.addEventListener("input",({target:t})=>{t===document.activeElement&&t._field?._setSelectionFrom(t)}),document.addEventListener("selectionchange",({target:t})=>{t===document.activeElement&&t._field?._setSelectionFrom(t)}),Gamma.gui=e=>{if(!e.Font)throw"Initialize Gamma.font before Gamma.gui";e.GUIElement=class{#t=NaN;#e=NaN;#i=null;_dimensions(){return vec2.zero}get width(){let t=this.#t;if(t!=t){const e=this._dimensions();t=this.#t=e.x,this.#e=e.y}return t}get height(){let t=this.#e;if(t!=t){const e=this._dimensions();this.#t=e.x,t=this.#e=e.y}return t}invalidate=()=>{this.#t=this.#e=NaN;const t=this.#i;if(t)if("function"==typeof t)try{t()}catch(t){Promise.reject(t)}else for(const e of t)try{e()}catch(t){Promise.reject(t)}};addDependency(t){if("function"!=typeof t)return;const e=this.#i;e?"function"==typeof e?this.#i=[e,t]:e.push(t):this.#i=t}removeDependency(t){const e=this.#i;if(!e)return;if("function"==typeof e)return void(e===t&&(this.#i=null));let i=e.indexOf(t);if(!(i<0)){for(;i<e.length;)e[i]=e[++i];e.pop()}}};class i{#i=null;_invalidated=!1;invalidate=()=>{if(this._invalidated)return;this._invalidated=!0;const t=this.#i;if(t)if("function"==typeof t)try{t()}catch(t){Promise.reject(t)}else for(const e of t)try{e()}catch(t){Promise.reject(t)}};addDependency(t){if("function"!=typeof t)return;const e=this.#i;e?"function"==typeof e?this.#i=[e,t]:e.push(t):this.#i=t}removeDependency(t){const e=this.#i;if(!e)return;if("function"==typeof e)return void(e===t&&(this.#i=null));let i=e.indexOf(t);if(!(i<0)){for(;i<e.length;)e[i]=e[++i];e.pop()}}}class s extends GUIElement{constructor(t){super(),this.texture=t}get width(){return this.texture.width}get height(){return this.texture.height}draw(t,e,i,s){this.texture.then?.(this.invalidate),t.drawRect(0,0,i,s,this.texture)}}class h extends GUIElement{constructor(t){super(),this.text=t}get width(){return this.text.width}get height(){return 1}draw(t,e,i,s){this.text.draw(t)}}e.canvas.style.setProperty("--__gamma__sarea__","env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)"),e.getGUIDimensions=(t=16)=>{t=1/t;const{0:i,1:s,2:h,3:r}=getComputedStyle(e.canvas).getPropertyValue("--__gamma__sarea__").split(" ");return{width:e.canvas.offsetWidth*t,height:e.canvas.offsetHeight*t,paddingLeft:parseFloat(r)*t,paddingRight:parseFloat(s)*t,paddingBottom:parseFloat(h)*t,paddingTop:parseFloat(i)*t}};class r extends i{constructor(t,e,i,s){super(),this.child=t,this.child.addDependency(this.invalidate),this.pos=e,this.size=i,this.flags=s}width=0;height=0;flags=0;sized(t,e){return this.width=t,this.height=e,this}replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}draw(t,e,i,s){if(this._invalidated=!1,!this.child.draw)return;let{width:h,height:r}=this.child,{size:n,pos:a}=this,l=1,c=1;"function"==typeof n&&(n=n(i/h,s/r)),"number"==typeof n?l=c=n:"object"==typeof n&&n&&(l=n.x,c=n.y);const o=h*l,d=r*c,f=i-o,u=s-d;"function"==typeof a&&(a=a(f,u));let p=0,m=0;"object"==typeof a&&a?({x:p,y:m}=a):p=m="number"==typeof a?a:.5,this.flags&1<<(o>i)&&(h=i/l,p=0),this.flags&4<<(d>s)&&(r=s/c,m=0),(p||m)&&t.translate(p*f,m*u),t.scale(l,c),this.child.draw(t,e,h,r)}}class n extends i{constructor(t,e,i,s){super(),this.child=t,this.child.addDependency(this.invalidate),this.transform=e,this.anchorX=i,this.anchorY=s}get width(){return this.child.width}get height(){return this.child.height}replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}draw(t,e,i,s){if(this._invalidated=!1,!this.child.draw)return;t.translate(i*this.anchorX,s*this.anchorY);const{width:h,height:r}=this.child;this.transform(t,i,s,h,r),t.translate(-h*this.anchorX,-r*this.anchorY),this.child.draw(t,e,h,r)}}class a extends GUIElement{constructor(t,e,i,s){super(),this.texture=t,this.pos=e,this.size=i,this.tint=s}width=0;height=0;draw(t,e,i,s){if(!this.texture)return void t.drawRect(0,0,i,s,this.tint);if(!this.texture.loaded)return void this.texture.then?.(this.invalidate);let{width:h,height:r}=this.texture,{size:n,pos:a}=this;"function"==typeof n&&(n=n(i/h,s/r)),"number"==typeof n?(h*=n,r*=n):"object"==typeof n&&n&&(h*=n.x,r*=n.y);let l=i-h,c=s-r;"function"==typeof a&&(a=a(l,c)),"object"==typeof a?a&&(l*=a.x,c*=a.y):("number"!=typeof a&&(a=.5),l*=a,c*=a);const o=1/i,d=1/s;t.drawRect(0,0,i,s,this.texture.super(l*o,c*d,h*o,r*d),this.tint)}}class l extends GUIElement{#s;#h=[];state=0;hitTest=null;constructor(t,e,i){super(),this.#s=t?[t]:[],this.cursor=e,this.activeCursor=i}reset(){this.#s.length=this.#h.length=0}onClick(t){return this.#s.push(t),this}onStateChange(t){return this.#h.push(t),this}setCursor(t){return this.cur=t,this}rounded(t=0,e=t,i=t,s=t){const h=max(t,i),r=max(e,s);return this.hitTest=(n,a,l,c)=>{if(n<h)if(n<i){if(a<i){const t=n-i,e=a-i;if(t*t-e*e>i*i)return!1}}else if(c-a<t){const e=n-t,i=c-a-t;if(e*e-i*i>t*t)return!1}if(l-n>r)if(l-n<s){if(a<s){const t=l-n-s,e=a-s;if(t*t-e*e>s*s)return!1}}else if(c-a<e){const t=n-e,i=c-a-e;if(t*t-i*i>e*e)return!1}return!0},this}#r=-1;#n(t,e,i,s,h){let r=null;switch(!!h){case!0:if(this.#r>=0&&s!=this.#r)return;if(r=t.unproject(h),r.x>=0&&r.x<e&&r.y>=0&&r.y<i&&(this.hitTest?.(r.x,r.y,e,i)??1))break;case!1:if(s==this.#r){this.#r=-1;const t=this.state;this.state=0;for(const e of this.#h)try{e(NaN,NaN,0,t)}catch(t){Promise.reject(t)}}return}const n=h.pressed?this.activeCursor:this.cursor;null!=n&&h.setHint?.(n);let a=this.state;this.state=1+h.pressed,-1==this.#r&&(this.#r=s);for(const t of this.#h)try{t(r.x,r.y,this.state,a)}catch(t){Promise.reject(t)}if(2!=this.state&&2==a)for(const t of this.#s)try{t(r.x,r.y,this.state)}catch(t){Promise.reject(t)}return null}draw(t,e,i,s){e.onPointerUpdate(this.#n.bind(this,t,i,s))}}class c extends i{width=0;height=0;ictx=InputContext();constructor(t){super(),this.child=t,this.child.addDependency(this.invalidate)}sized(t,e){return this.width=t,this.height=e,this}#a=!1;#l=NaN;#c=NaN;#o=NaN;#d=NaN;#f=NaN;#u=NaN;#p=NaN;#e=NaN;#m=NaN;#w=NaN;#g=NaN;#y=0;#x=0;#v=0;#_=-1;#b=0;#T=0;options=0;format=Formats.RGBA;mipmaps=1;#D=null;#E=Drawable();#I=this.#E.subPersp();replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}tolerance=.25;depthTolerance=.01;lastRedraw=-1;draw(e,i,s,h){let r,n,a,l,c,o,d,f,u,p=!0;const{width:m,height:w}=e;e.scale(s,h);const g=+this.tolerance,y=this.#p,x=this.#e;t:if(e.perspective){const t=g*(1-this.depthTolerance);if(({a:r,b:n,c:a,d:l,e:c,f:o,g:d,h:f,i:u}=e),y!=y)break t;let i=u,s=this.#m;if(i>s&&(i=s,s=u),max(abs(d-y)*m+abs(f-x)*w,max(s,1e-6)*t)>max(i,1e-6)*g)break t;const h=d+l,v=y+this.#d,_=f+c,b=x+this.#f,T=u+o,D=this.#m+this.#u;if(T>D?(i=D,s=T):(i=T,s=D),max(abs(h-v)*m+abs(_-b)*w,max(s,1e-6)*t)>max(i,1e-6)*g)break t;if(i=T+a,s=D+this.#o,i>s&&(i=s,s=D+a),max(abs(h+r-(v+this.#l))*m+abs(_+n-(b+this.#c))*w,max(s,1e-6)*t)>max(i,1e-6)*g)break t;if(i=u+a,s=this.#m+this.#o,i>s&&(i=s,s=u+a),max(abs(d+r-(y+this.#l))*m+abs(f+n-(x+this.#c))*w,max(s,1e-6)*t)>max(i,1e-6)*g)break t;p=!1}else{if(({a:r,b:n,c:l,d:c,e:d,f:f}=e),a=0,o=0,u=1,y!=y)break t;if(abs(d-y)*m+abs(f-x)*w>g)break t;if(abs(r-this.#l)*m+abs(n-this.#c)*w>g)break t;if(abs(l-this.#d)*m+abs(c-this.#f)*w>g)break t;p=!1}if(s!=this.#w||this._invalidated||p||h!=this.#g){const i=e.loopBoundary();this.#w=s,this.#g=h,this._invalidated=!1,this.#y=m,this.#x=w,this.#l=r,this.#c=n,this.#o=a,this.#d=l,this.#f=c,this.#u=o,this.#p=d,this.#e=f,this.#m=u;let p=this.#D;if(i){this.lastRedraw=t;const g=this.options,y=floor(i.x0*m),x=ceil(i.x1*m)-y,v=floor(i.y0*w),_=ceil(i.y1*w)-v;this.#v=y/m,this.#_=x/m,this.#b=v/w,this.#T=_/w,p&&p.format==this.format&&p.width==x&&p.height==_&&p.format==this.format?this.#E.clear(0,0,0,0):(p?.delete(),p=this.#D=Texture(x,_,1,g,this.format,this.mipmaps),this.#E.setTarget(0,p),this.mipmaps=p.mipmaps,this.format=p.format),this.#D.options!=g&&(this.#D.option=g),this.ictx.reset();const b=1/this.#_,T=1/this.#T;let D;e.perspective?(D=this.#I).reset((r-this.#v*a)*b,(n-this.#b*a)*T,a,(l-this.#v*o)*b,(c-this.#b*o)*T,o,(d-this.#v*u)*b,(f-this.#b*u)*T,u):(D=this.#E).reset(r*b,n*T,l*b,c*T,(d-this.#v)*b,(f-this.#b)*T),D.scale(1/s,1/h);const E=this.predraw?.(D,this.ictx,s,h);this.child.draw(D,this.ictx,s,h),E?.(),this.mipmaps&&p.genMipmaps()}else this.#_=-1,p&&(this.#E.setTarget(0,null),p.delete(),this.#D=null)}if(this.#_<0)return;const v=e.mask&RGBA;e.mask=SET|NEVER,e.draw(vec4.zero),e.perspective?e.reset(this.#_,0,0,0,this.#T,0,this.#v,this.#b,1):e.reset(this.#_,0,0,this.#T,this.#v,this.#b),e.mask=v|IF_SET|UNSET,e.draw(this.#D),i.onPointerUpdate((t,i)=>{if(t||(this.#a=!!i),!i)return void this.ictx.setPointer(t,null);let s=e.unproject(i);if(s.x>=0&&s.y>=0&&s.x<1&&s.y<1){i.x=s.x,i.y=s.y;const h=this.ictx.setPointer(t,i);return h&&({x:h.x,y:h.y}=e.project(h)),h}this.ictx.setPointer(t,null)}),i.onWheel((t,e)=>{if(this.#a)return this.ictx.fireWheel(t,e)}),i.onMouse((t,e)=>{if(this.#a)return this.ictx.fireMouse(t,e)}),i.onKeyUpdate(this.ictx),i.onGamepadUpdate(this.ictx)}}class o extends c{constructor(t,e,i){super(t),this.anchorX=e,this.anchorY=i}x=0;y=0;scrollSpanX=0;scrollSpanY=0;sensitivity=.0625;easing=.05;_velocityX=0;_velocityY=0;scrollBarX=u;scrollBarY=u;get scrollbar(){return this.scrollBarY}set scrollbar(t){this.scrollBarX=this.scrollBarY=t}predraw(t,e,i,s){let{width:h,height:r}=this.child;h=max(h-i,0),r=max(r-s,0);const n=this.scrollBarX&&h?t.sub():null,a=this.scrollBarY&&r?t.sub():null,l=-h*this.anchorX,c=-r*this.anchorY;let{_velocityX:o,_velocityY:d}=this;if(o||d){const t=dt/this.easing;if(o){if(abs(o)>t){const e=sign(o)*t;this._velocityX=o-e,o-=.5*e}else this._velocityX=0,o*=.5;const e=this.x+o*t;e!=(this.x=clamp(e,l,h+l))&&(this._velocityX=0)}if(d){if(abs(d)>t){const e=sign(d)*t;this._velocityY=d-e,d-=.5*e}else this._velocityY=0,d*=.5;const e=this.y+d*t;e!=(this.y=clamp(e,c,r+c))&&(this._velocityY=0)}this.invalidate()}const f=t.getTransform();return t.translate(l-this.x,c-this.y),e.onWheel((t,n)=>{if(!e.cursor)return;const a=f.unproject(e.cursor);if(!(a.x<0||a.y<0||a.x>i||a.y>s)){if(t*=this.sensitivity,n*=this.sensitivity,this.easing){const{_velocityX:e,_velocityY:i}=this;t=e*abs(e)+t+t,n=i*abs(i)+n+n,this._velocityX=sqrt(abs(t))*sign(t),this._velocityY=sqrt(abs(n))*sign(n)}else this.x=clamp(this.x+t,l,h+l),this.y=clamp(this.y+n,c,r+c);return this.invalidate(),null}}),n||a?()=>{if(n){n.translate(0,s);const t=1/(i+h);this.scrollBarX(n,(this.x-l)*t,i*t,i)}if(a){a.translate(i,0),a.multiply(0,-1);const t=1/(s+r);this.scrollBarY(a,(this.y-c)*t,s*t,s)}}:void 0}}class d extends GUIElement{constructor(t,e,i,s,h){this.child=t,this.bottom=e,this.left=i,this.top=s,this.right=h,this.child.addDependency(this.invalidate)}replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}_dimensions(){return vec2(this.child.width+this.left+this.right,this.child.height+this.bottom+this.top)}draw(t,e,i,s){t.translate(this.left,this.bottom),this.child.draw?.(t,e,i-this.left-this.right,s-this.top-this.bottom)}}e.GUI={FILL_WIDTH:1,CLAMP_WIDTH:2,INHERIT_WIDTH:3,FILL_HEIGHT:4,CLAMP_HEIGHT:8,INHERIT_HEIGHT:12,FILL:5,CLAMP:10,INHERIT:15,MIDDLE:vec2(.5,.5),LEFT:vec2(0,.5),RIGHT:vec2(1,.5),BOTTOM:vec2(.5,0),TOP:vec2(.5,1),BOTTOM_LEFT:vec2(0,0),BOTTOM_RIGHT:vec2(1,0),TOP_LEFT:vec2(0,1),TOP_RIGHT:vec2(1,1),ZStack:(t=>{class e extends i{#t=NaN;#e=NaN;get width(){let t=this.#t;if(t==t)return t;t=0;for(const{width:e}of this.children)e>t&&(t=e);return this.#t=t}get height(){let t=this.#e;if(t==t)return t;t=0;for(const{height:e}of this.children)e>t&&(t=e);return this.#e=t}constructor(){super(),this.addDependency(()=>{this.#t=this.#e=NaN})}children=[];add(t){return this.children.push(t),t.addDependency(this.invalidate),this}remove(t){const e=this.children;if("number"==typeof t){if((t>>>=0)>=e.length)return;for(e[t].removeDependency(this.invalidate);t<e.length;)e[t]=e[++t];e.pop()}else this.children.remove(t)>=0&&t.removeDependency(this.invalidate)}}return e.prototype.draw=t,()=>new e})(function(t,e,i,s){this._invalidated=!1;let h=this.children.length;for(const r of this.children)r.draw?.(--h?t.sub():t,e,i,s)}),Img:t=>new s(t),Text:(t="",i=null)=>{if("string"==typeof t){const s=t;t=e.RichText(i),s&&t.add(s)}return new h(t)},Target:(t=null,e=PointerState.POINTER,i=PointerState.POINTER)=>new l(t,e,i),Box:(t,e=.5,i=1,s=0)=>new r(t,e,i,s),BoxFill:(t,e=.5,i=max,s)=>t.identity?new a(t,e,i,s):new a(null,1,1,t),Transform:(t,e=Function.prototype,i=.5,s=.5)=>new n(t,e,i,s),Layer:t=>new c(t),ScrollableLayer:(t,e=0,i=1)=>("object"==typeof e&&({x:e,y:i}=e),new o(t,e,i)),Padding:(t,e=0,i=e,s=e,h=i)=>new d(t,e,i,s,h),TextField:(t,...e)=>{const i=new b(0);return"function"==typeof t?i.transformer=t:t&&"object"==typeof t&&i.simpleTransformer(t,...e),i}},e.GUI.TextField.cursorTimer=()=>e.t-x,e.GUI.TextField.multiline=(t,...e)=>{const i=new b(2048);return"function"==typeof t?i.transformer=t:t&&"object"==typeof t&&i.simpleTransformer(t,...e),i},e.ParticleContainer=class extends i{width=0;height=0;sized(t,e){return this.width=t,this.height=e,this}#N;constructor(t){super(),this.#N=t}get config(){return this.#N}set config(t){this.#N=t,this.#C.length=0,this.#k.length=0}lastT=NaN;#k=[];#C=[];draw(e,i,s,h){this._invalidated=!1,e=this.#N.prepare?.(e,i,s,h)??e;const r=t-this.lastT||0;this.lastT=t;const n=this.#k.length;if(n){for(let t=n-1;t>=0;t--){const i=this.#k[t];i&&this.#N.update(e,i,r)&&(this.#k[t]=null,this.#C.push(t))}if(this.#C.length>=min(n,max(5,n>>1))){this.#C.length=0;let t=0;for(;this.#k[t];)t++;let e=t+1;for(;e<n;){const i=this.#k[e++];i&&(this.#k[t++]=i)}this.#k.length=t}this.invalidate()}}add(...e){const i=this.#N.init(...e);this.#k.length||(this.lastT=t),this.#C.length?this.#k[this.#C.pop()]=i:this.#k.push(i)}};const f=e.vec4(.2),u=e.GUI.ScrollableLayer.defaultScrollbar=(t,e,i,s)=>{t.shader=null,t.drawRect(e*s,0,i*s,.5,f)},p=({target:t})=>(256&t._field._f||(t._field._f|=256,setImmediate(t._field.recalc)),t.remove(),e.setFocused(y=null)),m=t=>{x=e.t;const i=t.target._field;if(38==t.keyCode||40==t.keyCode){if(i._f>>1&1^t.shiftKey)38==t.keyCode?i.upArrowCb?.():i.downArrowCb?.();else if(2048&i._f)if(i.sel0==i.sel1){let e=i.sel0,s=e,h=i.sel0pos,r=h;for(;r;)e-=i.lines[--r].length;const n=i.lines[h].slice(0,e).width;if(38==t.keyCode&&h){const t=i.lines[h-1];i.sel0=i.sel1=s-e-t.length+t.indexAt(n)}else 40==t.keyCode&&h<i.lines.length-1&&(i.sel0=i.sel1=s-e+i.lines[h].length+i.lines[h+1].indexAt(n))}else 38==t.keyCode?i.sel0=i.sel1:i.sel1=i.sel0}else if(13==t.keyCode){if(!(i._f>>2&1^t.shiftKey))return;i.enterCb?.()}else{if(9!=t.keyCode)return;i._f>>3&1^t.shiftKey?i.tabCb?.():1&i._f&&i.insert("\t")}t.preventDefault()},w=(t,e)=>{const i=document.createElement(t);return i.style="width:1px;height:1px;border:0;padding:0;opacity:0;position:fixed;inset:-9px;font-size:16px;font-family:monospace;white-space:nowrap;pointer-events:none",i.onblur=p,i.onkeydown=m,i.tabIndex=-1,i._field=e,document.documentElement.append(i),i},g=e.vec4;let y=null,x=0;const v=(t,e)=>t.insertLinePass(-1,[e.focus?g(0,.2,.4,.6):g(.2,.2,.2,.6)],0,1),_=(t,i)=>{i&&(t.shader=null,(e.t-x)%1<.5&&t.drawRect(0,i.ascend-1,.05,1,g.one))};class b extends i{_f=0;#P=0;#f=0;get allowTabs(){return!!(1&this._f)}set allowTabs(t){this._f=-2&this._f|1&t}get shiftArrows(){return!!(2&this._f)}set shiftArrows(t){this._f=-3&this._f|2&-t}get shiftEnter(){return!!(4&this._f)}set shiftEnter(t){this._f=-5&this._f|4&-t}get shiftTab(){return!!(8&this._f)}set shiftTab(t){this._f=-9&this._f|8&-t}upArrowCb=null;downArrowCb=null;enterCb=null;tabCb=null;scrollable=null;#m;constructor(t){super(),this.#m=w(t?"textarea":"input",this),this._f=t}get value(){return this.#m.value}set value(t){this.#m.value=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}get sel0(){return this.#P}set sel0(t){t>>>=0,this.#f>=this.#P?t<=this.#f?this.#m.selectionStart=t:(this.#m.selectionStart=this.#f,this.#m.selectionEnd=t,this.#m.selectionDirection="backward"):t>this.#f?this.#m.selectionEnd=t:(this.#m.selectionStart=t,this.#m.selectionEnd=this.#f,this.#m.selectionDirection="forward"),this.#P=t}get sel1(){return this.#f}set sel1(t){t>>>=0,this.#f>=this.#P?t>=this.#P?this.#m.selectionEnd=t:(this.#m.selectionStart=t,this.#m.selectionEnd=this.#P,this.#m.selectionDirection="backward"):t<this.#P?this.#m.selectionStart=t:(this.#m.selectionStart=this.#P,this.#m.selectionEnd=t,this.#m.selectionDirection="forward"),this.#f=t}select(t,e=t){(t>>>=0)<=(e>>>=0)?(this.#m.selectionStart=t,this.#m.selectionEnd=e,this.#P>this.#f&&(this.#m.selectionDirection="forward")):(this.#m.selectionStart=e,this.#m.selectionEnd=t,this.#P<=this.#f&&(this.#m.selectionDirection="backward")),this.#P=t,this.#f=e,256&this._f||(this._f|=256,setImmediate(this.recalc))}get selStart(){return min(this.#P,this.#f)}get selEnd(){return max(this.#P,this.#f)}get isSelecting(){return!!(512&this._f)}#H=null;get transformer(){return this.#H}set transformer(t){this.#H!=(this.#H=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}calcAscend(t,e=1){return t.ready?(this.lineHeight<0?this.lineAscend=e*(1-t.ascend):this.lineAscend=e*t.ascend,this):(t.then(this.calcAscend.bind(this,t,e)),this)}invertWrapDirection(){return this.lineHeight*=-1,this.lineAscend=1-this.lineAscend,this}simpleTransformer(t,i="",...s){let h=s.slice();return h[0]=s[0]?g.multiply(s[0],.4):g(.4),this.calcAscend(t),this.#H=r=>{const n=e.RichText(t);return s.length&&n.setTextPass(0,s),r?n.add(r):(n.setTextPass(0,h),n.index=!1,n.add(i)),n},256&this._f||(this._f|=256,setImmediate(this.recalc)),this}#S=_;#A=v;#F=null;#G=null;#R=1/0;#w=0;#U=0;#t=0;get sel0pos(){return this.#w}get sel1pos(){return this.#U}get multiline(){return!!(2048&this._f)}set multiline(t=!0){const i=this.#m,s=i.value,h=document.activeElement==i;if(t){if(2048&this._f)return;this.#F=null,this._f|=2304,this.#m=w("textarea",this)}else{if(!(2048&this._f))return;this.#G=null,this._f=-2049&this._f|256,this.#m=w("input",this)}h?this.focus=!0:(i.remove(),y==i&&e.setFocused(y=null),256&this._f||(this._f|=256,setImmediate(this.recalc))),this.#m.value=s,this.#m.selectionStart=this.#P,this.#m.selectionEnd=this.#f,this.#m.selectionDirection=this.#P>this.#f?"backward":"forward"}get width(){return this.#t}get line(){return this.#F}get lines(){return this.#G}get drawCursor(){return this.#S}set drawCursor(t){this.#S!=(this.#S=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get selector(){return this.#A}set selector(t){this.#A!=(this.#A=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get maxWidth(){return this.#R}set maxWidth(t){this.#R=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}recalc=()=>{const t=this._f;if(!(256&t))return;const i=this.#m,s=min(this.#P,this.#f),h=max(this.#P,this.#f);this._f=-257&t;const r=i.value,n=this.#H?.(r,this)??e.RichText();if(s==h){const e=n.slice(s);n.trim(s),2048&t||(this.#w=this.#U=n.width),this.#S&&document.activeElement==this.#m&&n.addCb(this.#S),n.concat(e)}else{const e=n.slice(s),i=e.slice(h-s);e.trim(h-s),n.trim(s),2048&t?(this.#A?.(e,this),n.concat(e)):(this.#w=n.width,this.#A?.(e,this),n.concat(e),this.#U=n.width),n.concat(i)}if(2048&t){const t=this.#G=n.break(this.#R);let e=0;for(const{width:i}of t)i>e&&(e=i);this.#t=e;let i=s,r=0;for(;r<t.length&&i>=0;)i-=t[r++].length;for(i=h-s+i+(r?t[--r].length:0),this.#w=r;r<t.length&&i>=0;)i-=t[r++].length;this.#U=r?r-1:0}else this.#F=n,this.#t=n.width;n.ready||n.then(()=>{256&this._f||(this._f|=256,setImmediate(this.recalc))}),this.invalidate()};insert(t="",e=t.length){const i=this.#m,s=i.selectionStart;i.setRangeText(t,s,i.selectionEnd,"start"),i.selectionStart=i.selectionEnd=this.#P=this.#f=s+e}get focus(){return document.activeElement==this.#m}set focus(t=!0){if(t){if(y){if(y==this.#m)return;y.replaceWith(y=this.#m)}else document.documentElement.append(y=this.#m);e.setFocused(y),x=e.t,256&this._f||(this._f|=256,setImmediate(this.recalc))}else y==this.#m&&(y.remove(),e.setFocused(y=null))}autoWidth=!1;setAutoWidth(t=!0){return this.autoWidth=t,this}lineHeight=1.3;lineAscend=.9;#j=0;#L=-1;#n(e,i,s,h,r){switch(!!r){case!0:const{x:t,y:n}=e.unproject(r);if(t>=0&&n>=0&&t<i&&n<s)break;case!1:return void(h==this.#L&&(this.#L=-1,this._f&=-1537))}if(r.setHint?.(PointerState.TEXT),-1==this.#L&&r.pressed)this.#L=h,this.focus=!0;else if(this.#L!=h)return null;if(!r.pressed)return this.#L=-1,this._f&=-1537,null;let{x:n,y:a}=e.unproject(r);a=this.lineAscend-a;const l=this._f>>9&3;if(3==l)return null;let c=0;if(this.#F)c=this.#F.indexAt(n);else if(this.#G){let t=floor(a/this.lineHeight);for(t=t>=0?t>=this.#G.length?this.#G.length-1:t>>>0:0,c=this.#G[t].indexAt(n);t;)c+=this.#G[--t].length}if(l)this.sel1=c;else{let e=0,i=c,s=c;if(this.#j<0?this.#j-(this.#j=-t)<.3?e=2:this.#j=t:this.#j>0?this.#j-(this.#j=t)>-.3&&(e=1,this.#j=-t):this.#j=t,this._f|=512|(e>0)<<10,e){const t=this.#m.value,h=33-e;for(;t.charCodeAt(s++)>h;);for(;t.charCodeAt(--i)>h;);i++,s--}i==this.#P&&s==this.#f||this.select(i,s)}return null}get height(){return this.lineHeight*(this.#G?this.#G.length:1)}draw(t,i,s,h){this._invalidated=!1,i.onPointerUpdate(this.#n.bind(this,t.getTransform(),s,h)),i.onKeyUpdate((t,i)=>(this.focus&&e.captureKeyEvent(this.#m,t,i),!1)),this.autoWidth&&this.#R!==s&&(this.#R=s,this._f|=256,this.recalc());let r=this.lineHeight<0||Object.is(this.lineHeight,-0)?this.lineAscend:h-this.lineAscend;if(this.#G){r-=.5*(this.lineHeight-1);for(const e of this.#G)t.translate(0,r),r=-this.lineHeight,e.draw(t.sub())}else t.translate(0,.5*(r+this.lineHeight-1)),this.#F?.draw(t)}_setSelectionFrom({selectionStart:t,selectionEnd:i,selectionDirection:s}){x=e.t,"backward"==s?(this.#P=i,this.#f=t):(this.#P=t,this.#f=i),256&this._f||(this._f|=256,setImmediate(this.recalc))}}};