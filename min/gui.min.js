Gamma.gui=e=>{if(!e.RichText)throw"Initialize Gamma.font before Gamma.gui";const i=({target:t})=>(256&t._field._f||(t._field._f|=256,setImmediate(t._field.recalc)),t.remove(),r=null),s=t=>{const e=t.target._field;if(38==t.keyCode||40==t.keyCode){if(e._f>>1&1^t.shiftKey)38==t.keyCode?e.upArrowCb?.():e.downArrowCb?.();else if(2048&e._f)if(e.sel0==e.sel1){let i=e.sel0,s=i,h=e.sel0pos,n=h;for(;n;)i-=e.lines[--n].length;const r=e.lines[h].slice(0,i).width;if(38==t.keyCode&&h){const t=e.lines[h-1];e.sel0=e.sel1=s-i-t.length+t.indexAt(r)}else 40==t.keyCode&&h<e.lines.length-1&&(e.sel0=e.sel1=s-i+e.lines[h].length+e.lines[h+1].indexAt(r))}else 38==t.keyCode?e.sel0=e.sel1:e.sel1=e.sel0}else if(13==t.keyCode){if(!(e._f>>2&1^t.shiftKey))return;e.enterCb?.()}else{if(9!=t.keyCode)return;e._f>>3&1^t.shiftKey?e.tabCb?.():1&e._f&&e.insert("\t")}t.preventDefault()},h=(t,e)=>{const h=document.createElement(t);return h.style="width:1px;height:1px;border:0;padding:0;opacity:0;position:absolute;inset:-9px;font-size:1px;font-family:monospace;white-space:nowrap",h.onblur=i,h.onkeydown=s,h.tabIndex=-1,h._field=e,document.documentElement.append(h),h},n=e.vec4;let r=null,l=0;const c=(t,e)=>t.insertLinePass(-1,[e.focus?n(0,.2,.4,.6):n(.2,.2,.2,.6)],0,1),o=(t,i)=>{t.shader=null,(e.t-l)%1<.5&&t.drawRect(0,i.ascend-1,.05,1,n.one)};class a{_f=0;#t=0;#e=0;get allowTabs(){return!!(1&this._f)}set allowTabs(t){this._f=-2&this._f|1&t}get shiftArrows(){return!!(2&this._f)}set shiftArrows(t){this._f=-3&this._f|2&-t}get shiftEnter(){return!!(4&this._f)}set shiftEnter(t){this._f=-5&this._f|4&-t}get shiftTab(){return!!(8&this._f)}set shiftTab(t){this._f=-9&this._f|8&-t}upArrowCb=null;downArrowCb=null;enterCb=null;tabCb=null;scrollable=null;#i;constructor(t){this.#i=h(t?"textarea":"input",this),this._f=t}get value(){return this.#i.value}set value(t){this.#i.value=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}get sel0(){return this.#t}set sel0(t){t>>>=0,this.#e>=this.#t?t<=this.#e?this.#i.selectionStart=t:(this.#i.selectionStart=this.#e,this.#i.selectionEnd=t,this.#i.selectionDirection="backward"):t>this.#e?this.#i.selectionEnd=t:(this.#i.selectionStart=t,this.#i.selectionEnd=this.#e,this.#i.selectionDirection="forward"),this.#t=t}get sel1(){return this.#e}set sel1(t){t>>>=0,this.#e>=this.#t?t>=this.#t?this.#i.selectionEnd=t:(this.#i.selectionStart=t,this.#i.selectionEnd=this.#t,this.#i.selectionDirection="backward"):t<this.#t?this.#i.selectionStart=t:(this.#i.selectionStart=this.#t,this.#i.selectionEnd=t,this.#i.selectionDirection="forward"),this.#e=t}select(t,e=t){(t>>>=0)<=(e>>>=0)?(this.#i.selectionStart=t,this.#i.selectionEnd=e,this.#t>this.#e&&(this.#i.selectionDirection="forward")):(this.#i.selectionStart=e,this.#i.selectionEnd=t,this.#t<=this.#e&&(this.#i.selectionDirection="backward")),this.#t=t,this.#e=e,256&this._f||(this._f|=256,setImmediate(this.recalc))}get selStart(){return min(this.#t,this.#e)}get selEnd(){return max(this.#t,this.#e)}get isSelecting(){return!!(512&this._f)}#s=null;get transformer(){return this.#s}set transformer(t){this.#s!=(this.#s=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}simpleTransformer(t,i="",...s){let h=s.slice();h[0]=s[0]?n.multiply(s[0],.4):n(.4),this.#s=n=>{const r=e.RichText(t);return s.length&&r.addTextPass(0,s),n?r.add(n):(r.addTextPass(0,h),r.index=!1,r.add(i)),r},256&this._f||(this._f|=256,setImmediate(this.recalc))}#h=o;#n=c;#r=null;#l=null;#c=1/0;#o=0;#a=0;#f=0;get sel0pos(){return this.#o}get sel1pos(){return this.#a}get multiline(){return!!(2048&this._f)}set multiline(t=!0){const e=this.#i,i=e.value,s=document.activeElement==e;if(t){if(2048&this._f)return;this.#r=null,this._f|=2304,this.#i=h("textarea",this)}else{if(!(2048&this._f))return;this.#l=null,this._f=-2049&this._f|256,this.#i=h("input",this)}s?this.focus=!0:(e.remove(),r==e&&(r=null),256&this._f||(this._f|=256,setImmediate(this.recalc))),this.#i.value=i,this.#i.selectionStart=this.#t,this.#i.selectionEnd=this.#e,this.#i.selectionDirection=this.#t>this.#e?"backward":"forward"}get width(){return this.#f}get line(){return this.#r}get lines(){return this.#l}get cursor(){return this.#h}set cursor(t){this.#h!=(this.#h=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get selector(){return this.#n}set selector(t){this.#n!=(this.#n=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get maxWidth(){return this.#c}set maxWidth(t){this.#c=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}recalc=()=>{const t=this._f;if(!(256&t))return;const i=this.#i,s=min(this.#t,this.#e),h=max(this.#t,this.#e);this._f=-257&t,l=e.t;const n=i.value,r=this.#s?.(n,this)??e.RichText();if(s==h){const e=r.slice(s);r.trim(s),2048&t||(this.#o=this.#a=r.width),this.#h&&document.activeElement==this.#i&&r.addCb(this.#h),r.concat(e)}else{const e=r.slice(s),i=e.slice(h-s);e.trim(h-s),r.trim(s),2048&t?(this.#n?.(e,this),r.concat(e)):(this.#o=r.width,this.#n?.(e,this),r.concat(e),this.#a=r.width),r.concat(i)}if(2048&t){const t=this.#l=r.break(this.#c);let e=0;for(const{width:i}of t)i>e&&(e=i);this.#f=e;let i=s,n=0;for(;n<t.length&&i>=0;)i-=t[n++].length;for(i=h-s+i+(n?t[--n].length:0),this.#o=n;n<t.length&&i>=0;)i-=t[n++].length;this.#a=n?n-1:0}else this.#r=r,this.#f=r.width};insert(t="",e=t.length){const i=this.#i,s=i.selectionStart;i.setRangeText(t,s,i.selectionEnd,"start"),i.selectionStart=i.selectionEnd=this.#t=this.#e=s+e}get focus(){return document.activeElement==this.#i}set focus(t=!0){if(t){if(r){if(r==this.#i)return;r.replaceWith(r=this.#i)}else document.documentElement.append(r=this.#i);r.focus(),l=e.t}else r==this.#i&&(r.remove(),r=null)}lineHeight=1.3;lineAscend=.9;#d=0;get height(){return this.lineHeight*(this.#l?this.#l.length:1)}consumeInputs(i,{x:s,y:h}=i.from(e.cursor),n=e.keys.has(0)){if(h=this.lineAscend-h,cursorType="text",!n)return void(this._f&=-513);document.activeElement!=this.#i&&(this.focus=!0);const r=this._f>>9&1;let l=0;if(this.#r)l=this.#r.indexAt(s);else if(this.#l){let t=floor(h/this.lineHeight);for(t=t<0?0:t>=this.#l.length?this.#l.length-1:t,l=this.#l[t].indexAt(s);t;)l+=this.#l[--t].length}if(r)this.sel1=l;else{let e=0,i=l,s=l;if(this.#d<0?this.#d-(this.#d=-t)<.3?e=2:this.#d=t:this.#d>0?this.#d-(this.#d=t)>-.3&&(e=1,this.#d=-t):this.#d=t,this._f|=512,e){const t=this.#i.value,h=33-e;for(;t.charCodeAt(s++)>h;);for(;t.charCodeAt(--i)>h;);i++,s--}i==this.#t&&s==this.#e||this.select(i,s)}}get height(){return this.#l?this.#l.length*this.lineHeight:this.lineHeight}get xOffset(){return 0}get yOffset(){return-this.lineAscend}draw(t){if(this.#l)for(const e of this.#l)e.draw(t.sub()),t.translate(0,-this.lineHeight);else this.#r?.draw(t)}static#u=(document.addEventListener("input",({target:t})=>{const e=t._field;if(!e)return;const{selectionStart:i,selectionEnd:s,selectionDirection:h}=t;"backward"==h?(e.#t=s,e.#e=i):(e.#t=i,e.#e=s),256&e._f||(e._f|=256,setImmediate(e.recalc))}),document.addEventListener("selectionchange",({target:t})=>{const e=t._field;if(!e)return;const{selectionStart:i,selectionEnd:s,selectionDirection:h}=t;"backward"==h?(e.#t=s,e.#e=i):(e.#t=i,e.#e=s),256&e._f||(e._f|=256,setImmediate(e.recalc))}))}e.TextField=(t=!1)=>new a(t<<11&2048),e.TextField.cursorTimer=()=>e.t-l};