Gamma.gui=e=>{if(!e.Font)throw"Initialize Gamma.font before Gamma.gui";e.GUIElement=class{#t=NaN;#e=NaN;#i=null;_invalidated=!1;_dimensions(){return vec2.zero}invalidate=()=>{this._invalidated=!0,this.#t=this.#e=NaN;const t=this.#i;if(t)if("function"==typeof t)try{t()}catch(t){Promise.reject(t)}else for(const e of t)try{e()}catch(t){Promise.reject(t)}};addDependency(t){if("function"!=typeof t)return;const e=this.#i;e?"function"==typeof e?this.#i=[e,t]:e.push(t):this.#i=t}removeDependency(t){const e=this.#i;if(!e)return;if("function"==typeof e)return void(e===t&&(this.#i=null));let i=e.indexOf(t);if(!(i<0)){for(;i<e.length;)e[i]=e[++i];e.pop()}}get width(){let t=this.#t;if(t!=t){const e=this._dimensions();t=this.#t=e.x,this.#e=e.y}return t}get height(){let t=this.#e;if(t!=t){const e=this._dimensions();this.#t=e.x,t=this.#e=e.y}return t}};class i extends GUIElement{constructor(t){super(),this.texture=t}get width(){return this.texture.width}get height(){return this.texture.height}draw(t,e,i,s){this.texture.then?.(this.invalidate),t.drawRect(0,0,i,s,this.texture)}}class s extends GUIElement{constructor(t){super(),this.text=t}get width(){return this.text.width}get height(){return 1}draw(t,e,i,s){this.text.draw(t)}}e.canvas.style.setProperty("--__gamma__sarea__","env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)"),e.getUIDimensons=()=>{const{0:t,1:i,2:s,3:h}=getComputedStyle(e.canvas).getPropertyValue("--__gamma__sarea__").split(" ");return{width:.0625*e.canvas.offsetWidth,height:.0625*e.canvas.offsetHeight,paddingLeft:parseFloat(h),paddingRight:parseFloat(i),paddingBottom:parseFloat(s),paddingTop:parseFloat(t)}};class h extends GUIElement{constructor(t,e,i){super(),this.child=t,this.pos=e,this.size=i}width=0;height=0;replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}sized(t,e){return this.width=t,this.height=e,this}draw(t,e,i,s){if(!this.child.draw)return;const{width:h,height:n}=this.child;let{size:r,pos:a}=this,c=1,l=1;"function"==typeof r&&(r=r(i/h,s/n)),"number"==typeof r?c=l=r:"object"==typeof r&&r&&(c=r.x,l=r.y);const o=i-h*c,d=s-n*l;"function"==typeof a&&(a=a(o,d)),"object"==typeof a?a&&t.translate(a.x*o,a.y*d):("number"!=typeof a&&(a=.5),t.translate(a*o,a*d)),t.scale(c,l),this.child.draw(t,e,h,n)}}class n extends GUIElement{constructor(t,e,i,s){super(),this.child=t,this.child.addDependency(this.invalidate),this.transform=e,this.anchorX=i,this.anchorY=s}get width(){return this.child.width}get height(){return this.child.height}replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}draw(t,e,i,s){if(!this.child.draw)return;t.translate(i*this.anchorX,s*this.anchorY),this.transform(t,i,s);const{width:h,height:n}=this.child;t.translate(-h*this.anchorX,-n*this.anchorY),this.child.draw(t,e,h,n)}}class r extends GUIElement{constructor(t,e,i,s){super(),this.texture=t,this.pos=e,this.size=i,this.tint=s}width=0;height=0;draw(t,e,i,s){if(!this.texture)return void t.drawRect(0,0,i,s,this.tint);if(!this.texture.loaded)return void this.texture.then?.(this.invalidate);let{width:h,height:n}=this.texture,{size:r,pos:a}=this;"function"==typeof r&&(r=r(i/h,s/n)),"number"==typeof r?(h*=r,n*=r):"object"==typeof r&&r&&(h*=r.x,n*=r.y);let c=i-h,l=s-n;"function"==typeof a&&(a=a(c,l)),"object"==typeof a?a&&(c*=a.x,l*=a.y):("number"!=typeof a&&(a=.5),c*=a,l*=a);const o=1/i,d=1/s;t.drawRect(0,0,i,s,this.texture.super(c*o,l*d,h*o,n*d),this.tint)}}class a extends GUIElement{#s;#h=[];state=0;hitTest=null;constructor(t,e,i){super(),this.#s=t?[t]:[],this.cursor=e,this.activeCursor=i}reset(){this.#s.length=this.#h.length=0}onClick(t){return this.#s.push(t),this}onStateChange(t){return this.#h.push(t),this}setCursor(t){return this.cur=t,this}rounded(t=0,e=t,i=t,s=t){const h=max(t,i),n=max(e,s);return this.hitTest=(r,a,c,l)=>{if(r<h)if(r<i){if(a<i){const t=r-i,e=a-i;if(t*t-e*e>i*i)return!1}}else if(l-a<t){const e=r-t,i=l-a-t;if(e*e-i*i>t*t)return!1}if(c-r>n)if(c-r<s){if(a<s){const t=c-r-s,e=a-s;if(t*t-e*e>s*s)return!1}}else if(l-a<e){const t=r-e,i=l-a-e;if(t*t-i*i>e*e)return!1}return!0},this}#n=-1;#r(t,e,i,s,h){let n=null;switch(!h){case!1:if(this.#n>=0&&s!=this.#n)return;if(n=t.unproject(h),n.x>=0&&n.x<e&&n.y>=0&&n.y<i&&(this.hitTest?.(n.x,n.y,e,i)??1))break;case!0:if(s==this.#n){this.#n=-1;const t=this.state;this.state=0;for(const e of this.#h)try{e(NaN,NaN,0,t)}catch(t){Promise.reject(t)}}return}const r=h.pressed?this.activeCursor:this.cursor;null!=r&&h.setHint?.(r);let a=this.state;this.state=1+h.pressed,-1==this.#n&&(this.#n=s);for(const t of this.#h)try{t(n.x,n.y,this.state,a)}catch(t){Promise.reject(t)}if(2!=this.state&&2==a)for(const t of this.#s)try{t(n.x,n.y,this.state)}catch(t){Promise.reject(t)}return null}draw(t,e,i,s){e.onPointerUpdate(this.#r.bind(this,t,i,s))}}GUIElement;class c extends GUIElement{width=0;height=0;ictx=InputContext();constructor(t){super(),this.child=t,this.child.addDependency(this.invalidate)}sized(t,e){return this.width=t,this.height=e,this}#a=!1;#c=NaN;#l=NaN;#o=NaN;#d=NaN;#f=NaN;#u=NaN;#p=NaN;#e=NaN;#w=NaN;#m=NaN;#g=NaN;#x=0;#y=0;#_=0;#v=-1;#E=0;#T=0;options=0;format=Formats.RGBA;mipmaps=1;hasStencil=!0;#b=null;#D=Drawable();#N=this.#D.subPersp();replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}draw(t,e,i,s){let h,n,r,a,c,l,o,d,f;t.perspective?({a:h,b:n,c:r,d:a,e:c,f:l,g:o,h:d,i:f}=t):(({a:h,b:n,c:a,d:c,e:o,f:d}=t),r=0,l=0,f=1);const{width:u,height:p}=t;if(t.scale(i,s),i!=this.#m||this._invalidated||h!=this.#c||n!=this.#l||s!=this.#g||r!=this.#o||a!=this.#d||c!=this.#f||l!=this.#u||o!=this.#p||d!=this.#e||f!=this.#w||this.#x!=u||this.#y!=p){const e=t.loopBoundary();this.#m=i,this.#g=s,this._invalidated=!1,this.#x=u,this.#y=p,this.#c=h,this.#l=n,this.#o=r,this.#d=a,this.#f=c,this.#u=l,this.#p=o,this.#e=d,this.#w=f,this.#D.hasStencil=this.hasStencil;let w=this.#b;if(e){const m=this.options,g=floor(e.x0*u),x=ceil(e.x1*u)-g,y=floor(e.y0*p),_=ceil(e.y1*p)-y;this.#_=g/u,this.#v=x/u,this.#E=y/p,this.#T=_/p,w&&w.format==this.format&&w.width==x&&w.height==_&&w.format==this.format?(this.#D.clear(0,0,0,0),this.hasStencil&&this.#D.clearStencil()):(w?.delete(),w=this.#b=Texture(x,_,1,m,this.format,this.mipmaps),this.#D.setTarget(0,w),this.mipmaps=w.mipmaps,this.format=w.format),this.#b.options!=m&&(this.#b.option=m),this.ictx.reset();const v=1/this.#v,E=1/this.#T;t.perspective?(this.#N.reset((h-this.#_*r)*v,(n-this.#E*r)*E,r,(a-this.#_*l)*v,(c-this.#E*l)*E,l,(o-this.#_*f)*v,(d-this.#E*f)*E,f),this.child.draw(this.#N,this.ictx,i,s)):(this.#D.reset(h*v,n*E,a*v,c*E,(o-this.#_)*v,(d-this.#E)*E),this.child.draw(this.#D,this.ictx,i,s)),this.mipmaps&&w.genMipmaps()}else this.#v=-1,w&&(this.#D.setTarget(0,null),w.delete(),this.#b=null)}if(this.#v<0)return;const w=t.mask&RGBA;t.mask=SET|NEVER,t.draw(vec4.zero),t.perspective?t.reset(this.#v,0,0,0,this.#T,0,this.#_,this.#E,1):t.reset(this.#v,0,0,this.#T,this.#_,this.#E),t.mask=w|IF_SET|UNSET,t.draw(this.#b),e.onPointerUpdate((e,i)=>{if(e||(this.#a=!!i),!i)return void this.ictx.setPointer(e,null);let s=t.unproject(i);if(s.x>=0&&s.y>=0&&s.x<1&&s.y<1){i.x=s.x,i.y=s.y;const h=this.ictx.setPointer(e,i);return h&&({x:h.x,y:h.y}=t.project(h)),h}this.ictx.setPointer(e,null)}),e.onWheel((t,e)=>{if(this.#a)return this.ictx.fireWheel(t,e)}),e.onMouse((t,e)=>{if(this.#a)return this.ictx.fireMouse(t,e)}),e.onKeyUpdate(this.ictx),e.onGamepadUpdate(this.ictx)}}class l extends GUIElement{#C;constructor(t){super(),this.#C=t}get config(){return this.#C}set config(t){this.#C=t,this.#I.length=0,this.#P.length=0}lastT=NaN;#P=[];#I=[];draw(e){this.#C.prepare?.(e);const i=t-this.lastT||0;this.lastT=t;const s=this.#P.length;if(s){for(let t=s-1;t>=0;t--){const s=this.#P[t];s&&this.#C.update(e,s,i)&&(this.#P[t]=null,this.#I.push(t))}if(this.#I.length>min(s,max(5,s>>1))){this.#I.length=0;let t=0;for(;this.#P[t];)t++;let e=t+1;for(;e<s;){const i=this.#P[e++];i&&(this.#P[t++]=i)}this.#P.length=t}this.invalidate()}}add(...t){const e=this.#C.init(...t);this.#I.length?this.#P[this.#I.pop()]=e:this.#P.push(e)}}e.GUI={CENTERED:vec2(.5,.5),LEFT:vec2(0,.5),RIGHT:vec2(1,.5),BOTTOM:vec2(.5,0),TOP:vec2(.5,1),BOTTOM_LEFT:vec2(0,0),BOTTOM_RIGHT:vec2(1,0),TOP_LEFT:vec2(0,1),TOP_RIGHT:vec2(1,1),ZStack:(t=>{class e extends GUIElement{children=[];add(t){return this.children.push(t),t.addDependency(this.invalidate),this}remove(t){const e=this.children;if("number"==typeof t){if((t>>>=0)>=e.length)return;for(e[t].removeDependency(this.invalidate);t<e.length;)e[t]=e[++t];e.pop()}else this.children.remove(t)>=0&&t.removeDependency(this.invalidate)}}return e.prototype.draw=t,()=>new e})(function(t,e,i,s){let h=this.children.length;for(const n of this.children)n.draw?.(--h?t.sub():t,e,i,s)}),Img:t=>new i(t),Text:(t="",i=null)=>{if("string"==typeof t){const s=t;t=e.RichText(i),s&&t.add(s)}return new s(t)},Target:(t=null,e=PointerState.POINTER,i=PointerState.POINTER)=>new a(t,e,i),Box:(t,e=.5,i=1)=>new h(t,e,i),BoxFill:(t,e=.5,i=max,s)=>t.identity?new r(t,e,i,s):new r(null,1,1,t),Transform:(t,e=Function.prototype,i=.5,s=.5)=>new n(t,e,i,s),Layer:t=>new c(t),ParticleContainer:t=>new l(t)};e.vec4(.2);const o=({target:t})=>(256&t._field._f||(t._field._f|=256,setImmediate(t._field.recalc)),t.remove(),e.setFocused(p=null)),d=t=>{const e=t.target._field;if(38==t.keyCode||40==t.keyCode){if(e._f>>1&1^t.shiftKey)38==t.keyCode?e.upArrowCb?.():e.downArrowCb?.();else if(2048&e._f)if(e.sel0==e.sel1){let i=e.sel0,s=i,h=e.sel0pos,n=h;for(;n;)i-=e.lines[--n].length;const r=e.lines[h].slice(0,i).width;if(38==t.keyCode&&h){const t=e.lines[h-1];e.sel0=e.sel1=s-i-t.length+t.indexAt(r)}else 40==t.keyCode&&h<e.lines.length-1&&(e.sel0=e.sel1=s-i+e.lines[h].length+e.lines[h+1].indexAt(r))}else 38==t.keyCode?e.sel0=e.sel1:e.sel1=e.sel0}else if(13==t.keyCode){if(!(e._f>>2&1^t.shiftKey))return;e.enterCb?.()}else{if(9!=t.keyCode)return;e._f>>3&1^t.shiftKey?e.tabCb?.():1&e._f&&e.insert("\t")}t.preventDefault()},f=(t,e)=>{const i=document.createElement(t);return i.style="width:1px;height:1px;border:0;padding:0;opacity:0;position:fixed;inset:-9px;font-size:16px;font-family:monospace;white-space:nowrap;pointer-events:none",i.onblur=o,i.onkeydown=d,i.tabIndex=-1,i._field=e,document.documentElement.append(i),i},u=e.vec4;let p=null,w=0;const m=(t,e)=>t.insertLinePass(-1,[e.focus?u(0,.2,.4,.6):u(.2,.2,.2,.6)],0,1),g=(t,i)=>{i&&(t.shader=null,(e.t-w)%1<.5&&t.drawRect(0,i.ascend-1,.05,1,u.one))};class x{_f=0;#S=0;#f=0;get allowTabs(){return!!(1&this._f)}set allowTabs(t){this._f=-2&this._f|1&t}get shiftArrows(){return!!(2&this._f)}set shiftArrows(t){this._f=-3&this._f|2&-t}get shiftEnter(){return!!(4&this._f)}set shiftEnter(t){this._f=-5&this._f|4&-t}get shiftTab(){return!!(8&this._f)}set shiftTab(t){this._f=-9&this._f|8&-t}upArrowCb=null;downArrowCb=null;enterCb=null;tabCb=null;scrollable=null;#w;constructor(t){this.#w=f(t?"textarea":"input",this),this._f=t}get value(){return this.#w.value}set value(t){this.#w.value=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}get sel0(){return this.#S}set sel0(t){t>>>=0,this.#f>=this.#S?t<=this.#f?this.#w.selectionStart=t:(this.#w.selectionStart=this.#f,this.#w.selectionEnd=t,this.#w.selectionDirection="backward"):t>this.#f?this.#w.selectionEnd=t:(this.#w.selectionStart=t,this.#w.selectionEnd=this.#f,this.#w.selectionDirection="forward"),this.#S=t}get sel1(){return this.#f}set sel1(t){t>>>=0,this.#f>=this.#S?t>=this.#S?this.#w.selectionEnd=t:(this.#w.selectionStart=t,this.#w.selectionEnd=this.#S,this.#w.selectionDirection="backward"):t<this.#S?this.#w.selectionStart=t:(this.#w.selectionStart=this.#S,this.#w.selectionEnd=t,this.#w.selectionDirection="forward"),this.#f=t}select(t,e=t){(t>>>=0)<=(e>>>=0)?(this.#w.selectionStart=t,this.#w.selectionEnd=e,this.#S>this.#f&&(this.#w.selectionDirection="forward")):(this.#w.selectionStart=e,this.#w.selectionEnd=t,this.#S<=this.#f&&(this.#w.selectionDirection="backward")),this.#S=t,this.#f=e,256&this._f||(this._f|=256,setImmediate(this.recalc))}get selStart(){return min(this.#S,this.#f)}get selEnd(){return max(this.#S,this.#f)}get isSelecting(){return!!(512&this._f)}#k=null;get transformer(){return this.#k}set transformer(t){this.#k!=(this.#k=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}simpleTransformer(t,i="",...s){let h=s.slice();h[0]=s[0]?u.multiply(s[0],.4):u(.4),this.#k=n=>{const r=e.RichText(t);return s.length&&r.setTextPass(0,s),n?r.add(n):(r.setTextPass(0,h),r.index=!1,r.add(i)),r},256&this._f||(this._f|=256,setImmediate(this.recalc))}#U=g;#G=m;#F=null;#R=null;#A=1/0;#m=0;#H=0;#t=0;get sel0pos(){return this.#m}get sel1pos(){return this.#H}get multiline(){return!!(2048&this._f)}set multiline(t=!0){const i=this.#w,s=i.value,h=document.activeElement==i;if(t){if(2048&this._f)return;this.#F=null,this._f|=2304,this.#w=f("textarea",this)}else{if(!(2048&this._f))return;this.#R=null,this._f=-2049&this._f|256,this.#w=f("input",this)}h?this.focus=!0:(i.remove(),p==i&&e.setFocused(p=null),256&this._f||(this._f|=256,setImmediate(this.recalc))),this.#w.value=s,this.#w.selectionStart=this.#S,this.#w.selectionEnd=this.#f,this.#w.selectionDirection=this.#S>this.#f?"backward":"forward"}get width(){return this.#t}get line(){return this.#F}get lines(){return this.#R}get cursor(){return this.#U}set cursor(t){this.#U!=(this.#U=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get selector(){return this.#G}set selector(t){this.#G!=(this.#G=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get maxWidth(){return this.#A}set maxWidth(t){this.#A=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}recalc=()=>{const t=this._f;if(!(256&t))return;const i=this.#w,s=min(this.#S,this.#f),h=max(this.#S,this.#f);this._f=-257&t,w=e.t;const n=i.value,r=this.#k?.(n,this)??e.RichText();if(s==h){const e=r.slice(s);r.trim(s),2048&t||(this.#m=this.#H=r.width),this.#U&&document.activeElement==this.#w&&r.addCb(this.#U),r.concat(e)}else{const e=r.slice(s),i=e.slice(h-s);e.trim(h-s),r.trim(s),2048&t?(this.#G?.(e,this),r.concat(e)):(this.#m=r.width,this.#G?.(e,this),r.concat(e),this.#H=r.width),r.concat(i)}if(2048&t){const t=this.#R=r.break(this.#A);let e=0;for(const{width:i}of t)i>e&&(e=i);this.#t=e;let i=s,n=0;for(;n<t.length&&i>=0;)i-=t[n++].length;for(i=h-s+i+(n?t[--n].length:0),this.#m=n;n<t.length&&i>=0;)i-=t[n++].length;this.#H=n?n-1:0}else this.#F=r,this.#t=r.width};insert(t="",e=t.length){const i=this.#w,s=i.selectionStart;i.setRangeText(t,s,i.selectionEnd,"start"),i.selectionStart=i.selectionEnd=this.#S=this.#f=s+e}get focus(){return document.activeElement==this.#w}set focus(t=!0){if(t){if(p){if(p==this.#w)return;p.replaceWith(p=this.#w)}else document.documentElement.append(p=this.#w);e.setFocused(p),w=e.t,256&this._f||(this._f|=256,setImmediate(this.recalc))}else p==this.#w&&(p.remove(),e.setFocused(p=null))}lineHeight=1.3;lineAscend=.9;#O=0;#j=-1;#r(e,i,s){if(!s)return void(i==this.#j&&(this.#j=-1,this._f&=-1537));if(s.setHint?.(PointerState.TEXT),-1==this.#j&&s.pressed)this.#j=i,this.focus=!0;else if(this.#j!=i)return null;if(!s.pressed)return this.#j=-1,this._f&=-1537,null;let{x:h,y:n}=e.unproject(s);n=this.lineAscend-n;const r=this._f>>9&3;if(3==r)return null;let a=0;if(this.#F)a=this.#F.indexAt(h);else if(this.#R){let t=floor(n/this.lineHeight);for(t=t>=0?t>=this.#R.length?this.#R.length-1:t>>>0:0,a=this.#R[t].indexAt(h);t;)a+=this.#R[--t].length}if(r)this.sel1=a;else{let e=0,i=a,s=a;if(this.#O<0?this.#O-(this.#O=-t)<.3?e=2:this.#O=t:this.#O>0?this.#O-(this.#O=t)>-.3&&(e=1,this.#O=-t):this.#O=t,this._f|=512|(e>0)<<10,e){const t=this.#w.value,h=33-e;for(;t.charCodeAt(s++)>h;);for(;t.charCodeAt(--i)>h;);i++,s--}i==this.#S&&s==this.#f||this.select(i,s)}return null}get height(){return this.lineHeight*(this.#R?this.#R.length:1)}layout(t,i,s=-1/0,h=-1/0,n=1/0,r=1/0){i.onPointerUpdate(this.#r.bind(this,t)),i.onKeyUpdate((t,i)=>(e.captureKeyEvent(this.#w,t,i),!1))}get height(){return this.#R?this.#R.length*this.lineHeight:this.lineHeight}get xOffset(){return 0}get yOffset(){return-this.lineAscend}draw(t,e){if(this.#R)for(const e of this.#R)e.draw(t.sub()),t.translate(0,-this.lineHeight);else this.#F?.draw(t)}static#z=(document.addEventListener("input",({target:t})=>{const e=t._field;if(!e)return;const{selectionStart:i,selectionEnd:s,selectionDirection:h}=t;"backward"==h?(e.#S=s,e.#f=i):(e.#S=i,e.#f=s),256&e._f||(e._f|=256,setImmediate(e.recalc))}),document.addEventListener("selectionchange",({target:t})=>{const e=t._field;if(!e)return;const{selectionStart:i,selectionEnd:s,selectionDirection:h}=t;"backward"==h?(e.#S=s,e.#f=i):(e.#S=i,e.#f=s),256&e._f||(e._f|=256,setImmediate(e.recalc))}))}e.TextField=(t=!1)=>new x(t<<11&2048),e.TextField.cursorTimer=()=>e.t-w};