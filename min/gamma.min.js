{const $=globalThis;Math.PI2??=2*Math.PI,Math.HALF_SQRT3??=.8660254037844386,Math.clamp??=(t,s,r)=>t<s?s:t>r?r:t;const{clz32:t,cos:s,sin:r,min:o,round:u}=Math;if(!("setImmediate"in $)){let t=0,s=0,r=[],n=new MessageChannel;n.port1.onmessage=()=>{const n=r[s];r[s++]=null,s>3&&s>r.length>>1&&(r.splice(0,s),t+=s,s=0),n?.()},n=n.port2,$.setImmediate=(s,...o)=>(n.postMessage(0),r.push(o.length?s.bind(void 0,...o):s),r.length-1+t),$.clearImmediate=i=>{(i-=t)===i>>>0&&(i>=r.length||(r[i]=null))}}if(!("sin"in $)){const t=Object.getOwnPropertyDescriptors(Math);delete t[Symbol.toStringTag],Object.defineProperties($,t)}const p={imageOrientation:"flipY",premultiplyAlpha:"premultiply"},m=(t,s,r)=>"string"==typeof t?fetch(t).then(a=>a.blob()).then(t=>createImageBitmap(t,p)).then(s,r):t instanceof Blob?createImageBitmap(t,p).then(s,r):s(t);$.Gamma=(p=document.createElement("canvas"),$={},v=15)=>{const _=$.gl=($.canvas=p).getContext("webgl2",{preserveDrawingBuffer:!(8&v),antialias:16&v,depth:!1,premultipliedAlpha:4&v,stencil:1&v,alpha:2&v});_.pixelStorei(37440,1),_.stencilMask(1),_.clearStencil(0),_.disable(2929),_.enable(3042),_.pixelStorei(3317,1),_.pixelStorei(3333,1);const A=_.createBuffer();_.bindBuffer(35052,A);let g=!0,R=null,G=-1,E=!1,L=285217039,$s=null,$v=null,T=0,B=0,$u=0,N=null,$X=0,$x=0,S=5,j=0,F=4,$p=null,I=0;_.bindFramebuffer(36008,_.createFramebuffer());const O=_.createFramebuffer(),$M=_.createBuffer();_.bindBuffer(34962,$M);const P=o(32,_.getParameter(34930)),U=[];for(let i=P<<1;i-- >0;)U.push(null);Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NEVER:48,UNSET:64,SET:128,FLIP:192,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:136,RGB_DST:8,ONE_MINUS_DST:153,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,ADD:17,RGB_ADD:1,A_ADD:16,SUB:85,RGB_SUB:5,A_SUB:80,SUB_REV:102,RGB_SUB_REV:6,A_SUB_REV:96,MIN:34,RGB_MIN:2,A_MIN:32,MAX:51,RGB_MAX:3,A_MAX:48,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:28,FTEXTURE:29,ITEXTURE:30,UTEXTURE:31,COLOR:12,FCOLOR:13,ICOLOR:14,UCOLOR:15,FLAT:64,CW_ONLY:16,CCW_ONLY:32,ANISOTROPY:128,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0}),$.Formats={R:[33321,6403,5121],RG:[33323,33319,5121],RGB:[32849,6407,5121],RGBA:[32856,6408,5121],RGB565:[36194,6407,33635],R11F_G11F_B10F:[35898,6407,35899],RGB5_A1:[32855,6408,32820],RGB10_A2:[32857,6408,33640],RGBA4:[32854,6408,32819],RGB9_E5:[35901,6407,35902],R8:[33330,36244,5121,1<<31],RG8:[33336,33320,5121,1<<31],RGB8:[36221,36248,5121,1<<31],RGBA8:[36220,36249,5121,1<<31],R16:[33332,36244,5123,1<<31],RG16:[33338,33320,5123,1<<31],RGB16:[36215,36248,5123,1<<31],RGBA16:[36214,36249,5123,1<<31],R32:[33334,36244,5125,1<<31],RG32:[33340,33320,5125,1<<31],RGB32:[36209,36248,5125,1<<31],RGBA32:[36208,36249,5125,1<<31],R16F:[33325,6403,5131],RG16F:[33327,33319,5131],RGB16F:[34843,6407,5131],RGBA16F:[34842,6408,5131],R16F_32F:[33325,6403,5126],RG16F_32F:[33327,33319,5126],RGB16F_32F:[34843,6407,5126],RGBA16F_32F:[34842,6408,5126],R32F:[33326,6403,5126],RG32F:[33328,33319,5126],RGB32F:[34837,6407,5126],RGBA32F:[34836,6408,5126]},$.vec2=(x=0,y=x)=>({x:x,y:y}),$.vec2.one=$.vec2(1);const C=$.vec2.zero=$.vec2(0);$.vec2.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b}:{x:a.x+b.x,y:a.y+b.y},$.vec2.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y}:{x:a.x-b.x,y:a.y-b.y},$.vec2.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b}:{x:a.x*b.x,y:a.y*b.y},$.vec2.magnitude=a=>sqrt(a.x*a.x+a.y*a.y),$.vec2.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y);return{x:a.x*d,y:a.y*d}},$.vec3=(x=0,y=x,z=x)=>({x:x,y:y,z:z}),$.vec3.one=$.vec3(1);const M=$.vec3.zero=$.vec3(0);$.vec3.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z},$.vec3.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y,z:a-b.z}:{x:a.x-b.x,y:a.y-b.y,z:a.z-b.z},$.vec3.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z},$.vec3.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z),$.vec3.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z);return{x:a.x*d,y:a.y*d,z:a.z*d}},$.vec4=(x=0,y=x,z=x,w=x)=>({x:x,y:y,z:z,w:w}),$.vec4.one=$.vec4(1);const D=$.vec4.zero=$.vec4(0);$.vec4.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b,w:a.w+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z,w:a.w+b.w},$.vec4.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y,z:a-b.z,w:a-b.w}:{x:a.x-b.x,y:a.y-b.y,z:a.z-b.z,w:a.w-b.w},$.vec4.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b,w:a.w*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z,w:a.w*b.w},$.vec4.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w),$.vec4.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w);return{x:a.x*d,y:a.y*d,z:a.z*d,w:a.w*d}};const X=_.getExtension("EXT_texture_filter_anisotropic")?_.getParameter(34047):0;class $m{get isInteger(){return this.t.f.length>3}get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get mipmaps(){return this.t.m}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get identity(){return this.t}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,x=0,y=0,w=1,h=1,l=0){this.t=t,this.x=x,this.y=y,this.w=w,this.h=h,this.l=l}get loaded(){return!this.t.src}get waiting(){return!this.t.$}get then(){return this.t.src?this.#t:null}load(){this.t.$||$m.load(this.t)}sub(x=0,y=0,w=1,h=1,l=this.l){return new $m(this.t,this.x+x*this.w,this.y+y*this.h,this.w*w,this.h*h,l)}super(x=0,y=0,w=1,h=1,l=this.l){const t=this.w/w,s=this.h/h;return new $m(this.t,this.x-x*t,this.y-y*s,t,s,l)}crop(x=0,y=0,w=0,h=0,l=this.l){const{t:t,x:s,y:r,h:n}=this;if(!t.src)return new $m(t,s+x/t.w,r+n-(y+h)/t.h,w/t.w,h/t.h,l);const i=new $m(t,0,0,0,0,l);return t.$||$m.load(t),t.src.push(i=>{i.x=s+x/t.w,i.y=r+n-(y+h)/t.h,i.w=w/t.w,i.h=h/t.h},void 0,i),i}layer(l=this.l){return new $m(this.t,this.x,this.y,this.w,this.h,l)}#t(t,s){"function"!=typeof t&&(t=Function.prototype),this.t.src?(this.t.$||$m.load(this.t),this.t.src.push(t,s,this)):t(this)}static load(t){let s=t.src,r=0;t.src=[];let w=0,h=0;t.$=_.createTexture();const n=()=>{r=-1,$m.setOptions(t),_.texStorage3D(35866,t.m=1,t.f[0],t.w=w=1,t.h=h=1,t.d),g||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),g=!0),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const s=t.src;t.src=null;for(let i=1;i<s.length;i+=3)s[i]?.(s[i+1])};for(let i=0;i<s.length;i++)m(s[i],u=>{if(r){if(w!=u.width||h!=u.height)return n()}else w=u.width,h=u.height;if(s[i]=u,++r<s.length)return;$m.setOptions(t),_.texStorage3D(35866,t.m=o(t.m,floor(log2(max(w,h)))+1),t.f[0],t.w=w,t.h=h,t.d),g||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),g=!0),_.bindBuffer(35052,null);for(let l=0;l<r;l++)_.texSubImage3D(35866,0,0,0,l,w,h,1,t.f[1],t.f[2],s[l]);_.bindBuffer(35052,A),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const p=t.src;t.src=null;for(let i=0;i<p.length;i+=3)p[i](p[i+2])},n)}paste(t,x=0,y=0,l=0,s=0,r=0,n=0,o=0,u=0,p=0,v=0,R=0){const{t:G}=this;if(G.src)return null;if(t.msaa)return i&&draw(),p=u||t.height,u=o||t.width,_.framebufferRenderbuffer(36008,36064,36161,t.$),N!=O&&(_.bindFramebuffer(36009,N=O),curt=Q=null),_.framebufferTextureLayer(36009,36064,G.$,s,l),_.blitFramebuffer(r,n,r+u,n+p,x,y,x+u,y+p,16384,9728),this;if(!(t instanceof $m))return m(t,i=>($m.fakeBind(G),g||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),g=!0),_.bindBuffer(35052,null),_.texSubImage3D(35866,s,x,y,l,i.width,i.height,1,G.f[1],G.f[2],i),_.bindBuffer(35052,A),G.i<0&&_.bindTexture(35866,null),this));const{t:E}=t;if(E.src)return console.warn("Source texture is not loaded"),this;if(G.$==E.$)return console.warn("Cannot copy from texture to itself"),this;for($m.fakeBind(G),u=u||E.w,p=p||E.h,v=v||E.d;v--;)_.framebufferTextureLayer(36008,36064,E.$,R,o++),_.copyTexSubImage3D(35866,s,x,y,l++,r,n,u,p);return G.i<0&&_.bindTexture(35866,null),this}pasteData(t,x=0,y=0,l=0,w=0,h=0,d=0,s=0){const{t:r}=this;return r.src?null:(w=w||r.w,h=h||r.h,d=d||r.d,$m.fakeBind(r),g&&(_.pixelStorei(37440,0),_.pixelStorei(37441,0),g=!1),_.bufferData(35052,t,35042),_.texSubImage3D(35866,s,x,y,l,w,h,d,r.f[1],r.f[2],0),$t+=.25*t.byteLength,r.i<0&&_.bindTexture(35866,null),this)}readData(x=0,y=0,l=0,w=0,h=0,d=0,t=0){const{t:s}=this;if(s.src)return null;w=w||s.w,h=h||s.h,d=d||s.d,i&&draw();let a=s.f[0],r=33323==a||33338==a||33340==a||33327==a||33328==a||33336==a?2:33321==a||33330==a||33332==a||33334==a||33325==a||33326==a?1:4,n=r<=2?1==r?6403:33319:3==r?6407:6408;a=s.f[2]==5121?1:s.f[2]==5126||s.f[2]==5125||s.f[2]==35899||s.f[2]==33640||s.f[2]==35902?4:2,r*=w*h;let o,u=r*d*a;for(G==u?(o=R,G=-1,E=!0):(_.bindBuffer(35051,o=_.createBuffer()),_.bufferData(35051,u,35041),u>G&&(G=u,R=o,E=!0));d--;)_.framebufferTextureLayer(36008,36064,s.$,t,l),_.readPixels(x,y,w,h,n,s.f[2],r*a*l++);return o!=R&&_.bindBuffer(35051,R),new Promise(t=>{const n=()=>{const $i=1==a?new Uint8Array(r*d):4==a?s.f[2]==5126?new Float32Array(r*d):new Uint32Array(r*d):new Uint16Array(r*d);o!=R&&_.bindBuffer(35051,o),_.getBufferSubData(35051,0,$i),t($i),o!=R&&(u>G?(G=u,R=o):_.bindBuffer(35051,R)),E=!0};n.sync=_.fenceSync(37143,0),wt??=n,xt=xt?xt.next=n:n,vt||(vt=setInterval(bt,0))})}delete(){this.t.$&&(_.deleteTexture(this.t.$),this.t.$=null,this.t.i>=0&&(U[this.t.i]=null,this.t.i=-1),this.t.d=this.t.w=this.t.h=0)}static auto(s,i=0){if(s.f[3]>>31!=i)return-2;if(s.i>=0){const t=-2147483648>>>s.i-(P-T&i);if(!(t&(i^B)))return $X|=t,s.i;U[s.i]=null,s.i=-1}s.$||$m.load(s);const r=t(~($X|i^B));if(r>=P)return-1;$X|=-2147483648>>>r;const n=U[i=i?P+r-T:r];return n&&(n.i=-1),_.activeTexture(33984+i),_.bindTexture(35866,(U[i]=s).$),s.i=i}static fakeBind(t){if(t.i>=0)i&&draw(),_.activeTexture(33984+t.i);else{const s=P-1+(T==P&&P);U[s]&&(U[s].t.i=-1),_.activeTexture(33984+s),_.bindTexture(35866,t.$)}}get options(){return this.t.o}static setOptions(t){$m.fakeBind(t);const{o:s}=t;X&&_.texParameterf(35866,34046,128&s?X:1),t.f[3]>>31?(_.texParameterf(35866,10240,9728),_.texParameterf(35866,10241,9728)):(_.texParameterf(35866,10240,9728+(1&s)),_.texParameterf(35866,10241,t.m>1?9984+(s>>1&3):9728+(s>>1&1))),_.texParameterf(35866,10242,8&s?10497:16&s?33648:33071),_.texParameterf(35866,10243,32&s?10497:64&s?33648:33071)}set options(t){const{t:s}=this;s.o=t,s.src||($m.setOptions(s),s.i<0&&_.bindTexture(35866,null))}setMipmapRange(t=0,e=65535){const{t:s}=this;s.src||($m.fakeBind(s),_.texParameteri(35866,33082,t),_.texParameteri(35866,33083,e),s.i<0&&_.bindTexture(35866,null))}genMipmaps(){i&&draw();const{t:t}=this;t.m<2||($m.fakeBind(t),_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null))}}$.Drawable=(t=!1)=>new q({p:_.createFramebuffer(),_:0,T:t?_.createRenderbuffer():null,w:0,h:0,u:0}),$.Drawable.MAX_TARGETS=_.getParameter(36063),$.Drawable.DRAW_32F=!!_.getExtension("EXT_color_buffer_float"),$.Drawable.DRAW_16F=!!_.getExtension("EXT_color_buffer_half_float");let $i=new Float32Array(1024),$I=new Int32Array($i.buffer),i=0;$.Texture=(w=0,h=0,d=1,t=0,f=Formats.RGBA,s=0)=>{s=o(s>>>0||1,floor(log2(max(w,h)))+1),w>>>=0,h>>>=0;const r={$:_.createTexture(),i:-1,o:t,f:f,src:null,w:w,h:h,d:d=d>>>0||1,m:s},n=new $m(r);return $m.setOptions(r),w&&h?_.texStorage3D(35866,s,r.f[0],w,h,d):_.texStorage3D(35866,1,r.f[0],r.w=1,r.h=1,d),_.bindTexture(35866,null),n},$.Texture.MAX_WIDTH=$.Texture.MAX_HEIGHT=_.getParameter(3379),$.Texture.MAX_LAYERS=_.getParameter(35071),$.Texture.FILTER_32F=!!_.getExtension("OES_texture_float_linear");const V=$.Texture.MAX_MSAA=_.getParameter(36183);$.Texture.MSAA=(w=0,h=0,t=65536,f=Formats.RGBA)=>{t=o(t,V);const s=_.createRenderbuffer();return _.bindRenderbuffer(36161,s),_.renderbufferStorageMultisample(36161,t,f[0],w,h),{$:s,width:w,height:h,msaa:_.getRenderbufferParameter(36161,36011),delete(){_.deleteRenderbuffer(this.$)}}},$.Texture.from=(t,s=0,r=Formats.RGBA,n=0)=>new $m({$:null,i:-1,o:s,f:r,src:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:t?Array.isArray(t)?t.length:1:0,m:n||1});class Y{constructor(a=1,b=0,c=0,d=1,e=0,f=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f}translate(x=0,y=0){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d}=this;this.a=a*n-c*o,this.b=b*n-d*o,this.c=a*o+c*n,this.d=b*o+d*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d;this.a=t*a+r*b,this.b=s*a+n*b,this.c=t*c+r*d,this.d=s*c+n*d,this.e+=t*e+r*f,this.f+=s*e+n*f}skew(x=0,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a+c*y,this.b=b+d*y,this.c=c+a*x,this.d=d+b*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a*x-c*y,this.b=b*x-d*y,this.c=c*x+a*y,this.d=d*x+b*y}box(x=0,y=0,w=1,h=w){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d,this.a*=w,this.b*=w,this.c*=h,this.d*=h}point(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y+this.e,y:this.b*x+this.d*y+this.f}}metric(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y,y:this.b*x+this.d*y}}pointFrom(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:((x-=this.e)*d-(y-=this.f)*c)*t,y:(y*a-x*b)*t}}metricFrom(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:(x*d-y*c)*t,y:(y*a-x*b)*t}}}class k{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i}translate(x=0,y=0){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*n-d*o,this.b=b*n-e*o,this.c=c*n-f*o,this.d=a*o+d*n,this.e=b*o+e*n,this.f=c*o+f*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d,o=this.e,u=this.f;this.a=t*a+n*b,this.b=s*a+o*b,this.c=r*a+u*b,this.d=t*c+n*d,this.e=s*c+o*d,this.f=r*c+u*d,this.g+=t*e+n*f,this.h+=s*e+o*f,this.i+=r*e+u*f}skew(x=0,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a+d*y,this.b=b+e*y,this.c=c+f*y,this.d=d+a*x,this.e=e+b*x,this.f=f+c*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*x-d*y,this.b=b*x-e*y,this.c=c*x-f*y,this.d=a*y+d*x,this.d=b*y+e*x,this.f=c*y+f*x}box(x=0,y=0,w=1,h=w){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h}point(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.d*y+this.g,y:this.b*x+this.e*y+this.h,z:this.c*x+this.f*y+this.i}}metric(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.d*y,y:this.b*x+this.e*y,z:this.c*x+this.f*y}}}class Z{constructor(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h}translate(x=0,y=0,z=0){this.g+=x*this.a+y*this.c+z*this.e,this.h+=x*this.b+y*this.d+z*this.f}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y,this.e*=z,this.f*=z}rotateXZ(t){let n=r(t),o=s(t);const{a:a,b:b,e:e,f:f}=this;this.a=o*a-n*e,this.e=o*e+n*a,this.b=o*b-n*f,this.f=o*f+n*b}rotateXY(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,d:d}=this;this.a=o*a-n*c,this.c=o*c+n*a,this.b=o*b-n*d,this.d=o*d+n*b}rotateZY(t){let n=r(t),o=s(t);const{c:c,d:d,e:e,f:f}=this;this.e=o*e-n*c,this.c=o*c+n*e,this.f=o*f-n*d,this.d=o*d+n*f}multiplyXZ(x=1,y=0){const{a:a,b:b,e:e,f:f}=this;this.a=x*a-y*e,this.e=x*e+y*a,this.b=x*b-y*f,this.f=x*f+y*b}multiplyXY(x=1,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=x*a-y*c,this.c=x*c+y*a,this.b=x*b-y*d,this.d=x*d+y*b}multiplyZY(x=1,y=0){const{c:c,d:d,e:e,f:f}=this;this.e=x*e-y*c,this.c=x*c+y*e,this.f=x*f-y*d,this.d=x*d+y*f}skewX(t=0,s=0){this.a+=s*this.c+t*this.e,this.b+=s*this.d+t*this.f}skewY(t=0,s=0){this.c+=t*this.a+s*this.e,this.d+=t*this.b+s*this.f}skewZ(t=0,s=0){this.e+=t*this.a+s*this.c,this.f+=t*this.b+s*this.d}skew(t=0,s=0,r=0,n=0,o=0,u=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a+s*c+t*e,this.b=b+s*d+t*f,this.c=c+r*a+n*e,this.d=d+r*b+n*f,this.e=e+o*a+u*c,this.f=f+o*b+u*d}transform(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=this.a,o=this.b,u=this.c,p=this.d,m=this.e,v=this.f;this.a=n*a+u*b+m*c,this.b=o*a+p*b+v*c,this.c=n*d+u*e+m*f,this.d=o*d+p*e+v*f,this.e=n*t+u*h+m*i,this.f=o*t+p*h+v*i,this.g+=n*s+u*r+m*l,this.h+=o*s+p*r+v*l}box(x=0,y=0,z=0,w=1,h=w,d=w){this.g+=x*this.a+y*this.c+z*this.e,this.h+=x*this.b+y*this.d+z*this.f,this.a*=w,this.b*=w,this.c*=h,this.d*=h,this.e*=d,this.f*=d}point(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.c*y+this.e*z+this.g,y:this.b*x+this.d*y+this.f*z+this.h}}metric(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.c*y+this.e*z,y:this.b*x+this.d*y+this.f*z}}}class H{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l}translate(x=0,y=0,z=0){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y,this.g*=z,this.h*=z,this.i*=z}rotateXZ(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,g:u,h:h,i:i}=this;this.a=o*a-n*u,this.g=o*u+n*a,this.b=o*b-n*h,this.h=o*h+n*b,this.c=o*c-n*i,this.i=o*i+n*c}rotateXY(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=o*a-n*d,this.d=o*d+n*a,this.b=o*b-n*e,this.e=o*e+n*b,this.c=o*c-n*f,this.f=o*f+n*c}rotateZY(t){let n=r(t),o=s(t);const{d:d,e:e,f:f,g:u,h:h,i:i}=this;this.g=o*u-n*d,this.d=o*d+n*u,this.h=o*h-n*e,this.e=o*e+n*h,this.i=o*i-n*f,this.f=o*f+n*i}multiplyXZ(x=1,y=0){const{a:a,b:b,c:c,g:t,h:h,i:i}=this;this.a=x*a-y*t,this.g=x*t+y*a,this.b=x*b-y*h,this.h=x*h+y*b,this.c=x*c-y*i,this.i=x*i+y*c}multiplyXY(x=1,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=x*a-y*d,this.d=x*d+y*a,this.b=x*b-y*e,this.e=x*e+y*b,this.c=x*c-y*f,this.f=x*f+y*c}multiplyZY(x=1,y=0){const{d:d,e:e,f:f,g:t,h:h,i:i}=this;this.g=x*t-y*d,this.d=x*d+y*t,this.h=x*h-y*e,this.e=x*e+y*h,this.i=x*i-y*f,this.f=x*f+y*i}skewX(t=0,s=0){this.a+=s*this.d+t*this.g,this.b+=s*this.e+t*this.h,this.c+=s*this.f+t*this.i}skewY(t=0,s=0){this.d+=t*this.a+s*this.g,this.e+=t*this.b+s*this.h,this.f+=t*this.c+s*this.i}skewZ(t=0,s=0){this.g+=t*this.a+s*this.d,this.h+=t*this.b+s*this.e,this.i+=t*this.c+s*this.f}skew(t=0,s=0,r=0,n=0,o=0,u=0){const{a:a,b:b,c:c,d:d,e:e,f:f,g:p,h:h,i:i}=this;this.a=a+s*d+t*p,this.b=b+s*e+t*h,this.c=c+s*f+t*i,this.d=d+r*a+n*p,this.e=e+r*b+n*h,this.f=f+r*c+n*i,this.g=p+o*a+u*d,this.h=h+o*b+u*e,this.i=i+o*c+u*f}transform(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=this.a,o=this.b,u=this.c,p=this.d,m=this.e,v=this.f,A=this.g,g=this.h,R=this.i;this.a=n*a+p*b+A*c,this.b=o*a+m*b+g*c,this.c=u*a+v*b+R*c,this.d=n*d+p*e+A*f,this.e=o*d+m*e+g*f,this.f=u*d+v*e+R*f,this.g=n*t+p*h+A*i,this.h=o*t+m*h+g*i,this.i=u*t+v*h+R*i,this.j+=n*s+p*r+A*l,this.k+=o*s+m*r+g*l,this.l+=u*s+v*r+R*l}box(x=0,y=0,z=0,w=1,h=w,d=w){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h,this.g*=d,this.h*=d,this.i*=d}point(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.d*y+this.g*z+this.j,y:this.b*x+this.e*y+this.h*z+this.k,z:this.c*x+this.f*y+this.i*z+this.l}}metric(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.d*y+this.g*z,y:this.b*x+this.e*y+this.h*z,z:this.c*x+this.f*y+this.i*z}}pointFrom(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*(x-=this.j)+(f*t-d*i)*(y-=this.k)+(d*h-e*t)*(z-=this.l))*o,y:(r*x+(a*i-c*t)*y+(b*t-a*h)*z)*o,z:(n*x+(c*d-a*f)*y+(a*e-b*d)*z)*o}}metricFrom(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(f*t-d*i)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(b*t-a*h)*z)*o,z:(n*x+(c*d-a*f)*y+(a*e-b*d)*z)*o}}}const $G=ArrayBuffer.prototype.transfer?t=>{const s=i;return(i=s+t)>$I.length&&($I=new Int32Array($I.buffer.transfer(8*i)),$i=new Float32Array($I.buffer)),s}:t=>{const s=i;if((i=s+t)>$I.length){const t=$I;($I=new Int32Array(2*i)).set(t,0),$i=new Float32Array($I.buffer)}return s};class q extends Y{set shader($s){this.N="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,Q==this&&(Q=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||lt,Q==this&&(Q=null)}constructor(t,s=290787599,r=lt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.M=s,this.S=r,this.N=n}sub(){return new q(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f)}sub3d(){return new J(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,0,0,this.e,this.f)}sub3dProj(t=0,s=1){return new K(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,0,this.c,this.d,0,this.e*s,this.f*s,s,this.e*t,this.f*t,t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.M=290787599,this.N=$.Shader.DEFAULT,this.S=lt}pixelRatio(){return sqrt(abs(this.a*this.d-this.b*this.c)*this.t.w*this.t.h)}project(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y+this.e,y:this.b*x+this.d*y+this.f}}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:((x-=this.e)*d-(y-=this.f)*c)*t,y:(y*a-x*b)*t}}draw(...t){const i=this.N(6,t);$i[i]=this.e,$i[i+1]=this.a,$i[i+2]=this.c,$i[i+3]=this.f,$i[i+4]=this.b,$i[i+5]=this.d}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.N(6,t);$i[i]=this.e+x*this.a+y*this.c,$i[i+1]=this.a*w,$i[i+2]=this.c*h,$i[i+3]=this.f+x*this.b+y*this.d,$i[i+4]=this.b*w,$i[i+5]=this.d*h}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.N(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*e+n*f+u,$i[i+1]=s*a+n*b,$i[i+2]=s*c+n*d,$i[i+3]=r*e+o*f+p,$i[i+4]=r*a+o*b,$i[i+5]=r*c+o*d}drawv(t){const i=this.N(6,t);$i[i]=this.e,$i[i+1]=this.a,$i[i+2]=this.c,$i[i+3]=this.f,$i[i+4]=this.b,$i[i+5]=this.d}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.N(6,t);$i[i]=this.e+x*this.a+y*this.c,$i[i+1]=this.a*w,$i[i+2]=this.c*h,$i[i+3]=this.f+x*this.b+y*this.d,$i[i+4]=this.b*w,$i[i+5]=this.d*h}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.N(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*e+n*f+u,$i[i+1]=s*a+n*b,$i[i+2]=s*c+n*d,$i[i+3]=r*e+o*f+p,$i[i+4]=r*a+o*b,$i[i+5]=r*c+o*d}}class W extends k{set shader($s){this.N="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,Q==this&&(Q=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||lt,Q==this&&(Q=null)}constructor(t,s=290787599,r=lt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=0){super(a,b,c,d,e,f,o,h,i),this.t=t,this.M=s,this.S=r,this.N=n}sub(){return new W(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}sub3d(){return new K(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}sub3dProj(t=0,s=1){return new K(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,this.g*s,this.h*s,this.i*s,this.g*t,this.h*t,this.i*t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.M=290787599,this.N=$.Shader.DEFAULT,this.S=lt}pixelRatio(){const{i:i}=this,t=(this.a*i-this.g*this.c)*(this.e*i-this.h*this.f)-(this.d*i-this.g*this.f)*(this.b*i-this.h*this.c);return sqrt(abs(t)*this.t.w*this.t.h)/(i*i)}project(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);let t=this.c*x+this.f*y+this.i;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g)*t,y:(this.b*x+this.e*y+this.h)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);let u=(n*x+(c*d-a*f)*y+(a*e-b*d))*o;return u<=0?{x:NaN,y:NaN}:(u=1/u,{x:(s*x+(f*t-d*i)*y+(d*h-e*t))*o*u,y:(r*x+(a*i-c*t)*y+(b*t-a*h))*o*u})}draw(...t){const i=this.N(9,t);$i[i]=this.g,$i[i+1]=this.a,$i[i+2]=this.d,$i[i+3]=this.h,$i[i+4]=this.b,$i[i+5]=this.e,$i[i+6]=this.i,$i[i+7]=this.c,$i[i+8]=this.f}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.N(9,t);$i[i]=this.g+x*this.a+y*this.d,$i[i+1]=this.a*w,$i[i+2]=this.d*h,$i[i+3]=this.h+x*this.b+y*this.e,$i[i+4]=this.b*w,$i[i+5]=this.e*h,$i[i+6]=this.i+x*this.c+y*this.f,$i[i+7]=this.c*w,$i[i+8]=this.f*h}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.N(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,m=this.g,v=this.h,A=this.i;$i[i]=s*e+o*f+m,$i[i+1]=s*a+o*b,$i[i+2]=s*c+o*d,$i[i+3]=r*e+u*f+v,$i[i+4]=r*a+u*b,$i[i+5]=r*c+u*d,$i[i+6]=n*e+p*f+A,$i[i+7]=n*a+p*b,$i[i+8]=n*c+p*d}drawv(t){const i=this.N(9,t);$i[i]=this.g,$i[i+1]=this.a,$i[i+2]=this.d,$i[i+3]=this.h,$i[i+4]=this.b,$i[i+5]=this.e,$i[i+6]=this.i,$i[i+7]=this.c,$i[i+8]=this.f}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.N(9,t);$i[i]=this.g+x*this.a+y*this.d,$i[i+1]=this.a*w,$i[i+2]=this.d*h,$i[i+3]=this.h+x*this.b+y*this.e,$i[i+4]=this.b*w,$i[i+5]=this.e*h,$i[i+6]=this.i+x*this.c+y*this.f,$i[i+7]=this.c*w,$i[i+8]=this.f*h}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.N(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,m=this.g,v=this.h,A=this.i;$i[i]=s*e+o*f+m,$i[i+1]=s*a+o*b,$i[i+2]=s*c+o*d,$i[i+3]=r*e+u*f+v,$i[i+4]=r*a+u*b,$i[i+5]=r*c+u*d,$i[i+6]=n*e+p*f+A,$i[i+7]=n*a+p*b,$i[i+8]=n*c+p*d}}class J extends Z{set shader($s){this.N="function"==typeof $s&&!0===$s.three?$s:$.Shader.COLOR_3D_XZ,Q==this&&(Q=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||ct,Q==this&&(Q=null)}constructor(t,s=290787599,r=ct,n=$.Shader.COLOR_3D_XZ,a=1,b=0,c=0,d=1,e=0,f=0,o=0,h=0){super(a,b,c,d,e,f,o,h),this.t=t,this.M=s,this.S=r,this.N=n}sub(){return new J(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}subProj(t=0,s=1){return new K(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,0,this.c,this.d,0,this.g*s+this.e,this.h*s+this.f,s,this.g*t,this.h*t,t)}sub2dXY(){return new q(this.t,this.M,lt,$.Shader.DEFAULT,this.a,this.b,this.c,this.d,this.g,this.h)}sub2dZY(){return new q(this.t,this.M,lt,$.Shader.DEFAULT,this.e,this.f,this.c,this.d,this.g,this.h)}sub2dXZ(){return new q(this.t,this.M,lt,$.Shader.DEFAULT,this.a,this.b,this.e,this.f,this.g,this.h)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.M=290787599,this.N=$.Shader.COLOR_3D_XZ,this.S=ct}project(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z+this.j)*t,y:(this.b*x+this.e*y+this.h*z+this.k)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;x-=this.j,y-=this.k;const z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}origin(){return{x:NaN,y:NaN,z:NaN}}draw(...t){const s=this.N(8,t);$i[s]=this.g,$i[s+1]=this.a,$i[s+2]=this.c,$i[s+3]=this.e,$i[s+4]=this.h,$i[s+5]=this.b,$i[s+6]=this.d,$i[s+7]=this.f}drawCube(x=0,y=0,z=0,t=1,s=1,r=1,...n){const o=this.N(8,n),{a:a,b:b,c:c,d:d,e:e,f:f}=this;$i[o]=this.g+x*a+y*c+z*e,$i[o+1]=a*t,$i[o+2]=c*s,$i[o+3]=e*r,$i[o+4]=this.h+x*b+y*d+z*f,$i[o+5]=b*t,$i[o+6]=d*s,$i[o+7]=f*r}drawMat(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,...n){const o=this.N(8,n),u=this.a,p=this.b,m=this.c,v=this.d,A=this.e,g=this.f;$i[o]=this.g+u*s+m*r+A*l,$i[o+1]=u*a+m*b+A*c,$i[o+2]=u*d+m*e+A*f,$i[o+3]=u*t+m*h+A*i,$i[o+4]=this.h+p*s+v*r+g*l,$i[o+5]=p*a+v*b+g*c,$i[o+6]=p*d+v*e+g*f,$i[o+7]=p*t+v*h+g*i}drawv(t){const s=this.N(8,t);$i[s]=this.g,$i[s+1]=this.a,$i[s+2]=this.c,$i[s+3]=this.e,$i[s+4]=this.h,$i[s+5]=this.b,$i[s+6]=this.d,$i[s+7]=this.f}drawCubev(x=0,y=0,z=0,t=1,s=1,r=1,n){const o=this.N(8,n),{a:a,b:b,c:c,d:d,e:e,f:f}=this;$i[o]=this.g+x*a+y*c+z*e,$i[o+1]=a*t,$i[o+2]=c*s,$i[o+3]=e*r,$i[o+4]=this.h+x*b+y*d+z*f,$i[o+5]=b*t,$i[o+6]=d*s,$i[o+7]=f*r}drawMatv(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,n){const o=this.N(8,n),u=this.a,p=this.b,m=this.c,v=this.d,A=this.e,g=this.f;$i[o]=this.g+u*s+m*r+A*l,$i[o+1]=u*a+m*b+A*c,$i[o+2]=u*d+m*e+A*f,$i[o+3]=u*t+m*h+A*i,$i[o+4]=this.h+p*s+v*r+g*l,$i[o+5]=p*a+v*b+g*c,$i[o+6]=p*d+v*e+g*f,$i[o+7]=p*t+v*h+g*i}}class K extends H{set shader($s){this.N="function"==typeof $s&&!0===$s.three?$s:$.Shader.COLOR_3D_XZ,Q==this&&(Q=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||ct,Q==this&&(Q=null)}constructor(t,s=290787599,r=ct,n=$.Shader.COLOR_3D_XZ,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.M=s,this.S=r,this.N=n}sub(){return new K(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}subProj(t=0,s=1){return new K(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,this.j*s+this.g,this.k*s+this.h,this.l*s+this.i,this.j*t,this.k*t,this.l*t)}sub2dXY(){return new W(this.t,this.M,lt,$.Shader.DEFAULT,this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dZY(){return new W(this.t,this.M,lt,$.Shader.DEFAULT,this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(){return new W(this.t,this.M,lt,$.Shader.DEFAULT,this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.j=t.j,this.k=t.k,this.l=t.l,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l,this.M=290787599,this.N=$.Shader.COLOR_3D_XZ,this.S=ct}project(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z+this.j)*t,y:(this.b*x+this.e*y+this.h*z+this.k)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;x-=this.j,y-=this.k;const z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}origin(){const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=this,n=e*i-f*h,o=c*h-b*i,u=b*f-c*e,p=-1/(a*n+d*o+t*u);return{x:(n*s+(t*f-i*d)*r+(d*h-e*t)*l)*p,y:(o*s+(a*i-c*t)*r+(t*b-h*a)*l)*p,z:(u*s+(d*c-f*a)*r+(a*e-b*d)*l)*p}}ray(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=this,n=e*i-f*h,o=c*h-b*i,u=b*f-c*e,p=1/(a*n+d*o+t*u),m=t*f-i*d,v=d*h-e*t,A=-(n*s+m*r+v*l)*p,g=-(o*s+(a*i-c*t)*r+(t*b-h*a)*l)*p,R=-(u*s+(d*c-f*a)*r+(a*e-b*d)*l)*p,z=1-this.l,G=(n*x+m*y+v*z)*p,E=(n*x+m*y+v*z)*p,L=(n*x+m*y+v*z)*p,T=1/sqrt(G*G+E*E+L*L);return{origin:{x:A,y:g,z:R},direction:{x:G*T,y:E*T,z:L*T}}}draw(...t){const s=this.N(12,t);$i[s]=this.j,$i[s+1]=this.a,$i[s+2]=this.d,$i[s+3]=this.g,$i[s+4]=this.k,$i[s+5]=this.b,$i[s+6]=this.e,$i[s+7]=this.h,$i[s+8]=this.l,$i[s+9]=this.c,$i[s+10]=this.f,$i[s+11]=this.i}drawCube(x=0,y=0,z=0,t=1,s=1,r=1,...n){const o=this.N(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=this.j+x*a+y*d+z*u,$i[o+1]=a*t,$i[o+2]=d*s,$i[o+3]=u*r,$i[o+4]=this.k+x*b+y*e+z*h,$i[o+5]=b*t,$i[o+6]=e*s,$i[o+7]=h*r,$i[o+8]=this.l+x*c+y*f+z*i,$i[o+9]=c*t,$i[o+10]=f*s,$i[o+11]=i*r}drawMat(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,...n){const o=this.N(12,n),u=this.a,p=this.b,m=this.c,v=this.d,A=this.e,g=this.f,R=this.g,G=this.h,E=this.i;$i[o]=this.j+u*s+v*r+R*l,$i[o+1]=u*a+v*b+R*c,$i[o+2]=u*d+v*e+R*f,$i[o+3]=u*t+v*h+R*i,$i[o+4]=this.k+p*s+A*r+G*l,$i[o+5]=p*a+A*b+G*c,$i[o+6]=p*d+A*e+G*f,$i[o+7]=p*t+A*h+G*i,$i[o+8]=this.l+m*s+g*r+E*l,$i[o+9]=m*a+g*b+E*c,$i[o+10]=m*d+g*e+E*f,$i[o+11]=m*t+g*h+E*i}drawv(t){const s=this.N(12,t);$i[s]=this.j,$i[s+1]=this.a,$i[s+2]=this.d,$i[s+3]=this.g,$i[s+4]=this.k,$i[s+5]=this.b,$i[s+6]=this.e,$i[s+7]=this.h,$i[s+8]=this.l,$i[s+9]=this.c,$i[s+10]=this.f,$i[s+11]=this.i}drawCubev(x=0,y=0,z=0,t=1,s=1,r=1,n){const o=this.N(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=this.j+x*a+y*d+z*u,$i[o+1]=a*t,$i[o+2]=d*s,$i[o+3]=u*r,$i[o+4]=this.k+x*b+y*e+z*h,$i[o+5]=b*t,$i[o+6]=e*s,$i[o+7]=h*r,$i[o+8]=this.l+x*c+y*f+z*i,$i[o+9]=c*t,$i[o+10]=f*s,$i[o+11]=i*r}drawMatv(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,n){const o=this.N(12,n),u=this.a,p=this.b,m=this.c,v=this.d,A=this.e,g=this.f,R=this.g,G=this.h,E=this.i;$i[o]=this.j+u*s+v*r+R*l,$i[o+1]=u*a+v*b+R*c,$i[o+2]=u*d+v*e+R*f,$i[o+3]=u*t+v*h+R*i,$i[o+4]=this.k+p*s+A*r+G*l,$i[o+5]=p*a+A*b+G*c,$i[o+6]=p*d+A*e+G*f,$i[o+7]=p*t+A*h+G*i,$i[o+8]=this.l+m*s+g*r+E*l,$i[o+9]=m*a+g*b+E*c,$i[o+10]=m*d+g*e+E*f,$i[o+11]=m*t+g*h+E*i}}const x=Object.getOwnPropertyDescriptors({get width(){return this.t.w},get height(){return this.t.h},get identity(){return this.t},set mask(t){this.M=-256&this.M|255&t,Q==this&&(Q=null)},get mask(){return 255&this.M},set blend(b){this.M=255&this.M|(b||1135889)<<8,Q==this&&(Q=null)},get blend(){return this.M>>8},V(){if(Q==this)return!1;const{t:t,M:s}=this,r=t._;let d=L^s;if(curt!=t&&(i&&draw(),curt&&curt._==t._||(d|=240),N!=t.p&&_.bindFramebuffer(36009,N=t.p),_.viewport(0,0,t.w,t.h),curt=t),d){if(i&&draw(),15&d&&_.colorMask(1&s,2&s,4&s,8&s),240&d)if(240&s){240&L||_.enable(2960),_.stencilMask(1<<r),_.stencilFunc(32&s?16&s?512:517:16&s?514:519,255,1<<r);const t=128&s?64&s?5386:7681:64&s?0:7680;_.stencilOp(t,t,t)}else 240&L&&_.disable(2960);1996488704&d&&_.blendEquationSeparate(32773+(s>>24&7),32773+(s>>28&7)),16776960&d&&_.blendFuncSeparate((s>>8&15)+766*!!(3584&s),(s>>16&15)+766*!!(917504&s),(s>>12&15)+766*!!(57344&s),(s>>20&15)+766*!!(14680064&s)),-2147483648&d&&(-2147483648&s?_.enable(32926):_.disable(32926)),L=s}return Q=this,!0},setTarget(t=0,s=null,l=0,r=0){const{t:n}=this;if(n.p){if(i&&draw(),Q==this&&(Q=null),N!=n.p&&(_.bindFramebuffer(36009,N=n.p),curt=Q=null),!s){if(!n.u)return;return _.framebufferRenderbuffer(36009,36064+t,36161,null),void((n.u&=~(1<<t))||(n.w=n.h=0,_.framebufferRenderbuffer(36009,36128,36161,null)))}if((n.u&=~(1<<t))||(n.w=n.h=0),n.w){if(n.w!=s.width||n.h!=s.height)return}else n.w=s.width,n.h=s.height,n.T&&(_.bindRenderbuffer(36161,n.T),_.renderbufferStorage(36161,36168,n.w,n.h),_.framebufferRenderbuffer(36009,36128,36161,n.T));n.u|=1<<t,s.msaa?_.framebufferRenderbuffer(36009,36064+t,36161,s.$):_.framebufferTextureLayer(36009,36064+t,s.t.$,l,r)}},clearTargets(){const{t:s}=this;if(!s.p)return;i&&draw(),Q==this&&(Q=null);let r=s.u;if(s.u=s.w=s.h=0,s.T&&(_.framebufferRenderbuffer(36009,36128,36161,null),_.deleteRenderbuffer(s.T),s.T=_.createRenderbuffer()),r)for(N!=s.p&&(_.bindFramebuffer(36009,N=s.p),curt=Q=null);r;){const s=31-t(r);r&=~(1<<s),_.framebufferRenderbuffer(36009,36064+s,36161,null)}},get hasStencil(){return this.t.p?!!this.t.T:!!(1&v)},set hasStencil(t){let{t:s}=this,b=s.T;s.p&&!t!=!b&&(i&&draw(),Q==this&&(Q=null),s.T=b=b?(_.deleteRenderbuffer(b),null):_.createRenderbuffer(),s.w&&(N!=s.p&&(_.bindFramebuffer(36009,N=s.p),curt=Q=null),b?(_.bindRenderbuffer(36161,b),_.renderbufferStorage(36161,36168,s.w,s.h),_.framebufferRenderbuffer(36009,36128,36161,b)):_.framebufferRenderbuffer(36009,36128,36161,null)))},clear(t=0,s=t,b=t,a=s){"object"==typeof t&&(a=t.w??0,b=t.z??0,s=t.y,t=t.x),i&&draw(),this.V()&&(Q=null),_.clearColor(t,s,b,a);const r=this.t._=this.t._+1&7;_.clear(r?16384:(_.stencilMask(255),17408)),ft++,_.disable(2960),L&=-241},clearStencil(){i&&draw(),this.V()&&(Q=null);(this.t._=this.t._+1&7)||(_.stencilMask(255),_.clear(1024)),_.disable(2960),L&=-241},projection:!1});Object.defineProperties(q.prototype,x),Object.defineProperties(K.prototype,x),Object.defineProperties(W.prototype,x),K.prototype.projection=W.prototype.projection=!0,Object.defineProperties(J.prototype,x),Object.assign($.Blend=(t=17,s=17,r=0,n=!1)=>t|r<<8|s<<16|n<<23,{REPLACE:1114129,DEFAULT:1135889,ADD:1118465,MULTIPLY:1122816,MULTIPLY_MIX:1136008,SUBTRACT:5574913,REVERSE_SUBTRACT:7737601,MIN:2232593,MAX:3346705,BEHIND:1118583,INVERT:1127321});let Q=null;function draw(b=$x){if(_.bufferData(34962,$I.subarray(0,i),35040),$t+=i,i/=$u,ft++,yt+=i,I?_.drawElementsInstanced(7&S,F,I,j,i):_.drawArraysInstanced(7&S,j,F,i),i=0,$X=b,mt.length){wt??=mt[0];for(const f of mt)f.sync=_.fenceSync(37143,0),xt=xt?xt.next=f:f;mt.length=0}}const tt=(f,t,e)=>{if(e<=t+1)return f(t);const s=t+(e-t>>1);return`if(u<${s}){${tt(f,t,s)}}else{${tt(f,s,e)}}`},st=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"],it=_.getParameter(34921);function $H(t,s,r,c){$s=t,T=s,B=r,$u=c}function $l(t){_.bindVertexArray($v=t)}const $C=new Float32Array(4),$c=new Int32Array($C.buffer),ht=(t,s,$D=[])=>{s="number"==typeof s?[s]:s||[];let r=0;const n=[],o=[],u=[],p=[],m=[""];let v=2+t,A=0,g=2+t,R=2+t;for(const t of s){if((15&t)>=12)throw"Vertex parameter cannot be a texture";const s=1+(3&t),G=st[3&t|(t>>4&15)<<2],E=t>15;$D[r]??=1==s?0:2==s?C:3==s?M:D,p.push(`${r}:a${r}=$D[${r}]`);const L=(63&t)>13?"$I[i+":"$i[i+";if(1==s)m.push(L+R+"]=a"+r);else for(let t=0;t<s;t++)fnBody.push(L+(R+t)+"]=a"+r+"."+"xyzw"[t]);const T=""+(v>>2),B=3&v,N=3&(v+=s)||4;let S=E?A:g;const j=3&S,F=3&(S+=s)||4;E?A=S:g=S;let I="";if(N<=(B||4)){const t=(v>>2)-(s==4+B);o.push(`layout(location=${it-1-t})in uvec4 o${t};`)}I=N<=B?`uvec${s}(o${T}.${"xyzw".slice(B,4)},o${v>>2}.${"xyzw".slice(0,N)})`:4==N&&0==B?"v"+T:`o${T}.`+"xyzw".slice(B,N),E||(I=`uintBitsToFloat(${I})`);const O=`GL_${E?"V":"v"}${T}.`;if(F<=(j||4)&&o.push(`${E?"flat out u":"out "}vec4 ${(E?"GL_V":"GL_v")+((S>>2)-!(s==4+j))};`),F<=j){const o=(E?"GL_V":"GL_v")+(S>>2),p=`${E?"u":""}vec${s}(${O+"xyzw".slice(j)},${O+"xyzw".slice(0,F)})`;n.push(`${E?"flat in u":"in "}vec4 ${o};\n#define vparam${T} ${t>=64&&t<80?`uintBitsToFloat(${p})`:p}\n`),u.push(`${G} t${r}=${I};${O+"xyzw".slice(j,F)}=t${r}.${"xyzw".slice(0,4-j)};${o}.${"xyzw".slice(0,F)}=t${r}.${"xyzw".slice(4-j,s)};`)}else{const s=O+"xyzw".slice(j,F);n.push(`\n#define vparam${T} ${t>=64&&t<80?`uintBitsToFloat(${s})`:s}\n`),u.push(`${O+"xyzw".slice(j,F)}=${I};`)}R+=s,r++}m[0]=`let{i,$i,$I}=this;if((this.i=i+${R})>$i.length){${ArrayBuffer.prototype.transfer?`$I=this.$I=new Int32Array($I.buffer.transfer(i+${R}<<3))`:`const oa=$I;$I=this.$I=new Int32Array(i+${R}<<1);$I.set(oa,0)`};$i=this.$i=new Float32Array($I.buffer)}`,m.push("return i"),A&&(o.push("flat out uvec4 GL_V0;"),n.push("flat in uvec4 GL_V0;"));const G=eval(`(function({${p}}){${m.join(";")}})`);return{three:t,S:G,F:R,fsh:n.join(""),vsh:o.join(""),vshb:u.join("")}};class et extends Y{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.I=s,this.O=r,this.P=n}sub(t=this.t.U,s=0,r=this.P){return new et(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f)}sub3d(t=this.t.U,s=0,r=this.P){return new nt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,0,0,this.e,this.f)}addPoint(x,y,...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.U++}add(...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.U++}addPointv(x,y,t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.U++}addv(t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.U++}}class rt extends k{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1){super(a,b,c,d,e,f,o,h,i),this.t=t,this.I=s,this.O=r,this.P=n}sub(t=this.t.U,s=0,r=this.P){return new rt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}sub3d(t=this.t.U,s=0,r=this.P){return new ot(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}addPoint(x,y,...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+this.g,$i[i+1]=x*this.b+y*this.e+this.h,$i[i+2]=x*this.c+y*this.f+this.i,s.U++}add(...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,$i[i+2]=this.i,s.U++}addPointv(x,y,t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+this.g,$i[i+1]=x*this.b+y*this.e+this.h,$i[i+2]=x*this.c+y*this.f+this.i,s.U++}addv(t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,$i[i+2]=this.i,s.U++}}class nt extends Z{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=1,e=0,f=0,o=0,h=0){super(a,b,c,d,e,f,o,h),this.t=t,this.I=s,this.O=r,this.P=n}sub(t=this.t.U,s=0,r=this.P){return new nt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}sub2dXY(t=this.t.U,s=0,r=this.P){return new et(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.g,this.h)}sub2dXZ(t=this.t.U,s=0,r=this.P){return new et(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.e,this.f,this.g,this.h)}sub2dZY(t=this.t.U,s=0,r=this.P){return new et(this.t,t>>>0,s>>>0,63&r,this.e,this.f,this.c,this.d,this.g,this.h)}addPoint(x,y,z,...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+z*this.e+this.g,$i[i+1]=x*this.b+y*this.d+z*this.f+this.h,s.U++}add(...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,s.U++}addPointv(x,y,z,t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+z*this.e+this.g,$i[i+1]=x*this.b+y*this.d+z*this.f+this.h,s.U++}addv(t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,s.U++}}class ot extends H{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.I=s,this.O=r,this.P=n}sub(t=this.t.U,s=0,r=this.P){return new ot(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}sub2dXY(t=this.t.U,s=0,r=this.P){return new rt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(t=this.t.U,s=0,r=this.P){return new rt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}sub2dZY(t=this.t.U,s=0,r=this.P){return new rt(this.t,t>>>0,s>>>0,63&r,this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}addPoint(x,y,z,...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.U++}add(...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.U++}addPointv(x,y,z,t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.U++}addv(t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.U++}}function $a(t){_.bindBuffer(34962,t.b);const s=it-(t.F+3>>2);for(let i=it-1,r=0;i>=s;i--,r+=16)_.enableVertexAttribArray(i),_.vertexAttribIPointer(i,i==s?3&t.F:4,5125,t.F<<2,r);_.enableVertexAttribArray(0),_.enableVertexAttribArray(1),_.vertexAttribDivisor(0,1),_.vertexAttribDivisor(1,1),_.vertexAttribDivisor(2,1),_.bindBuffer(34962,$M)}_.vertexAttrib4f(2,1,0,0,0);const y=Object.getOwnPropertyDescriptors({get size(){return this.t.U},get uploadCount(){return this.t.C},get vertex(){return this.t.vtx},S(){const{t:t}=this;i&&draw(),$p=this;const s=S>>4,r=(S=this.P)>>4;s!=r&&(r?(s||_.enable(2884),_.frontFace(2304+(r>>1))):_.disable(2884)),j=this.I,F=this.O,I=t.M},get end(){return this.I+this.O},set end(a){(a>>>=0)>=this.I?this.O=a-this.I:(this.O=this.I-a,this.I=a),$p==this&&this.S()},get start(){return this.I},set start(a){this.I=a>>>0,$p==this&&(i&&draw(),j=this.I)},get length(){return this.O},set length(a){this.O=a>>>0,$p==this&&(i&&draw(),F=this.O)},get type(){return this.P},set type(a){this.P=63&a,$p==this&&this.S()},get identity(){return this.t},upload(t=null){const{t:s}=this;if($p&&s==$p.t&&i&&draw(),t){let r=0;if(Array.isArray(t)){let s=0;for(const r of t)r>s&&(s=r);const $M=s>254?s>65534?new Uint32Array(t.length):new Uint16Array(t.length):new Uint8Array(t.length);$M.set(t,0),t=$M}r=5121+(262656>>(t.BYTES_PER_ELEMENT<<2)&15),s.M=r,_.bindVertexArray(s.v),_.bindBuffer(34963,s.E??=_.createBuffer()),_.bufferData(34963,t,35044),s.v?s.Ls||(s.Ls=1,$a(s)):_.bindBuffer(34963,null),_.bindVertexArray($v)}else s.v&&(_.bindVertexArray(s.v),s.Ls||(s.Ls=1,$a(s)),s.E&&_.bindBuffer(34963,null),_.bindVertexArray($v)),s.M=0,s.E&&(s.E.delete(),s.E=null);$p&&$p.t==s&&(I=s.M),_.bindBuffer(34962,s.b),_.bufferData(34962,s.$I.subarray(0,s.i),35044),_.bindBuffer(34962,$M),s.$i=ut,s.$I=at,s.i=0,s.C=this.O=t?t.length:s.U,s.U=0,$p&&s==$p.t&&this.S()},export(){const{t:{$I:$I,i:t}}=this,s=new Uint8Array(4*t);for(let i=0;i<t;i++){const t=4*i,r=$I[i];s[t]=r>>24,s[t+1]=r>>16,s[t+2]=r>>8,s[t+3]=r}return s},import(f){f instanceof ArrayBuffer&&(f=new Uint8Array(f));const{t:t}=this;let{i:i,$I:$I}=t,l=i+(.25*f.length>>>0);if($I.length<l){if(ArrayBuffer.prototype.transfer)$I=t.$I=new Int32Array($I.buffer.transfer(4*l));else{const s=t.$I;$I=t.$I=new Int32Array(l),t.$I.set(s,0)}t.$i=new Float32Array(t.$I.buffer)}let s=0;for(;i<l;)$I[i++]=f[s++]<<24|f[s++]<<16|f[s++]<<8|f[s++];t.i=l}}),ut=new Float32Array,at=new Int32Array(ut.buffer);Object.defineProperties(et.prototype,y),Object.defineProperties(rt.prototype,y),Object.defineProperties(nt.prototype,y),Object.defineProperties(ot.prototype,y),$.Geometry2D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{S:r,F:n,three:o}=t??$.Geometry2D.DEFAULT_VERTEX;if(o)return null;const $i=new Float32Array(16);return new et({$i:$i,$I:new Int32Array($i.buffer),i:0,vtx:t,b:_.createBuffer(),S:r,F:n,U:0,C:0,v:null,E:null,M:0},0,0,s)},$.Geometry3D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{S:r,F:n,three:o}=t??$.Geometry3D.DEFAULT_VERTEX;if(!o)return null;const $i=new Float32Array(16);return new ot({$i:$i,$I:new Int32Array($i.buffer),i:0,vtx:t,b:_.createBuffer(),S:r,F:n,U:0,C:0,v:_.createVertexArray(),L:null,Ls:0,E:null,M:0},0,0,s)},$.Geometry2D.Vertex=ht.bind(null,!1),$.Geometry3D.Vertex=ht.bind(null,!0);const lt=$.Geometry2D.SQUARE=$.Geometry2D($.Geometry2D.DEFAULT_VERTEX=ht(!1,[]),5),ct=$.Geometry3D.CUBE=$.Geometry3D($.Geometry3D.DEFAULT_VERTEX=ht(!0,[]),21);for(let i=0;i<4;i++)lt.addPoint(1&i,i>>1&1),ct.addPoint(0,1&i,i>>1&1),ct.addPoint(1,1&i,i>>1&1);lt.upload(),ct.upload(new Uint8Array([4,6,0,2,3,6,7,4,5,0,1,3,5,7])),$.Geometry3D.INSIDE_CUBE=ct.sub(0,14,37),$.Geometry3D.XZ_FACE=ct.sub(7,4,21),$.Shader=(t,{params:s,defaults:$D,uniforms:r,uniformDefaults:$U,outputs:p=4,vertex:m=$.Geometry2D.DEFAULT_VERTEX,intFrac:v=.5}={})=>{if(s="number"==typeof s?[s]:s||[],r="number"==typeof r?[r]:r||[],$D=void 0!==$D?Array.isArray($D)?[...$D]:[$D]:[],$U=void 0!==$U?Array.isArray($U)?[...$U]:[$U]:[],p="number"==typeof p?[p]:p||[],p.length>Drawable.MAX_TARGETS)throw`Too many shader outputs (Drawable.MAX_TARGETS == ${Drawable.MAX_TARGETS})`;const A=3+m.three,g=[],R=[""],G=[`#version 300 es\nprecision highp float;precision highp int;layout(location=0)in mat3x${A} m;layout(location=${it-1})in uvec4 o0;out vec4 GL_v0;`],E=[`void main(){gl_Position.xyw=vec${A}(1.,GL_v0.xy${m.three?"z":""}=uintBitsToFloat(o0.xy${m.three?"z":""}))*m;gl_Position.xy=gl_Position.xy*2.-gl_Position.w;gl_Position.z=0.;gl_PointSize=1.;`],L=[`#version 300 es\nprecision highp float;precision highp int;in vec4 GL_v0;\n#define color color0\n#define i_depth gl_FragCoord.w\n#define pos GL_v0.xy${A>3?"z":""}\n`+p.map((t,i)=>`layout(location=${i})out ${t?16==t||32==t?"u":"lowp ":""}vec4 color${i};`).join(";"),""];let T=0,B=0,N=0,S=0;const j=[],F=(t=0)=>{const s=""+(S>>2),r=3&S,n=3&(S+=t)||4;if(n<=(r||4)){const s=(S>>2)-(t==4+r),n=""+s;G.push(`layout(location=${s+3})in uvec4 a${n};flat out uvec4 GL_a${n};`),L.push(`flat in uvec4 GL_a${n};`),E.push(`GL_a${n}=a${n};`)}if(n<=r){let o=`uvec${t}(GL_a${s}.`;for(let i=r;i<4;i++)o+="xyzw"[i];o+=`,GL_a${S>>2}.`;for(let i=0;i<n;i++)o+="xyzw"[i];return o+")"}if(4==n&&0==r)return"GL_a"+s;let o=`GL_a${s}.`;for(let i=r;i<n;i++)o+="xyzw"[i];return o};let I=0;for(const t of s){let s=1+(3&t);(15&t)>=12&&(T|=1<<s-1,(15&t)>13?N++:B++),$D[I]??=1==s?0:2==s?C:3==s?M:t>=28&&t<32?null:D,g.push(`${I}:a${I}=$D[${I}]`);const r=t>13?"$I[j+":"$i[j+",n=S;if(t>=12&&t<16){j.push(`let t${I}=-1;if(a${I}.t){if((t${I}=$m.auto(a${I}.t,${-(8==t)}))==-1){i&&draw(b^$X);t${I}=$m.auto(a${I}.t,${-(8==t)})}t${I}|=a${I}.l<<8}`);const o=F(1),u=F(2),p=F(2);L.push(`${4==t?"lowp ":8==t?"u":"highp "}vec4 param${I}(vec2 uv){int v=int(${o});if(v<0)return vec4(uintBitsToFloat(${u}),uintBitsToFloat(${p}));return ${4==t?"g":8==t?"uG":"fG"}etColor(v&255,vec3(uv*uintBitsToFloat(${p})+uintBitsToFloat(${u}),v>>8));}`),R.push(`$I[j+${n}]=t${I};if(t${I}>=0)$i[j+${n+1}]=a${I}.x,$i[j+${n+2}]=a${I}.y,$i[j+${n+3}]=a${I}.w,$i[j+${n+4}]=a${I}.h;else ${r}${n+1}]=a${I}.x,${r}${n+2}]=a${I}.y,${r}${n+3}]=a${I}.z,${r}${n+4}]=a${I}.w`),s=5}else{t>=28&&t<32&&(j.push(`let q${I}=$m.auto(a${I}.t,${-(t>29)});if(q${I}<0)i&&draw(b^$X),q${I}=$m.auto(a${I}.t,${-(t>29)})`),s=1);const o=F(s);if(L.push(`\n#define param${I} ${t<16?"uintBitsToFloat":t<32?st[3&t|4]:""}(${o})\n`),1==s)R.push(r+n+"]=a"+I);else for(let t=0;t<s;t++)R.push(r+(n+t)+"]=a"+I+"."+"xyzw"[t])}I++}L.push(m.fsh),G.push(m.vsh),E.push(m.vshb),I=0;const O=[],U=[""],X=[],V=[],Y=[];for(const t of r){const s=1+(3&t);if((15&t)>=12&&(T|=1<<s-1,(15&t)>13?N++:B++,n="int"),$U[I]??=1==s?0:2==s?C:3==s?M:t>=28&&t<32?null:D,O.push(`a${I}=$U[${I}]`),t>=28&&t<32)X.push(`_.uniform1i($L[${V.length}],s${Y.length}?$m.auto(s${Y.length},${-(t>29)}):-1)`),V.push("uni"+I),L.push(`uniform ${t>29?"u":""}sampler2DArray uni${I};`),U.push(`s${Y.length}=a${I}.t`),Y.push(`,s${Y.length}=null`);else if(t>=12&&t<16){const s="GL_u"+I,r="GL_U"+I,n="GL_L"+I;X.push(`if(s${Y.length})_.uniform1i($L[${V.length}],$m.auto(s${Y.length},${-(t>13)}))`),L.push(t>13?`uniform usampler2DArray ${s};uniform float ${n};uniform uvec4 ${r}; ${14==t?"i":"u"}vec4 uni${I}(vec2 uv){if(${n}<0.)return ${14==t?`ivec4(${r})`:r};return ${14==t?"i":"u"}GetColor(${s},vec3(uv*uintBitsToFloat(${r}.zw)+uintBitsToFloat(${r}.xy),${n}));}`:`uniform sampler2DArray ${s};uniform float ${n};uniform vec4 ${r}; ${12==t?"lowp ":""}vec4 uni${I}(vec2 uv){if(${n}<0.)return ${r};return texture(${s},vec3(uv*${r}.zw+${r}.xy,${n}));}`),U.push(`if(s${Y.length}=a${I}.t){_.uniform1f($L[${V.length+2}],a${I}.l);${t>13?`$C[0]=a${I}.x,$C[1]=a${I}.y,$C[2]=a${I}.w,$C[3]=a${I}.h;_.uniform4ui`:"_.uniform4f"}($L[${V.length+1}],${t>13?"$c[0],$c[1],$c[2],$c[3]":`a${I}.x,a${I}.y,a${I}.w,a${I}.h`})}else _.uniform1f($L[${V.length+2}],-1),_.uniform4${t>13?"ui":"f"}($L[${V.length+1}],a${I}.x,a${I}.y,a${I}.z,a${I}.w)`),V.push(s,r,n),Y.push(`,s${Y.length}=null`)}else{L.push(`uniform ${st[3&t|t>>4<<2]} uni${I};`);let r=`_.uniform${s+(t<16?"f":t<32?"i":"ui")}($L[${V.length}]`;if(V.push("uni"+I),1==s)r+=",a"+I;else for(let t=0;t<s;t++)r+=",a"+I+"."+"xyzw"[t];U.push(r+")")}I++}if(12+(S+3&-4)+(m.F+3&-4)>it<<2)throw"Too many shader parameters";if(B+N>16)throw"Shaders cannot use more than 16 textures/colors";Object.freeze($D),Object.freeze($U);const k=it-(m.F+3>>2);B=B?N?B+u(v*(P-B-N)):P:0,N=N&&P-B;let Z=null,H=`precision highp usampler2DArray; precision ${2&T?"highp":"lowp"} sampler2DArray;`;15&T&&(H+=`uniform sampler2DArray GL_f[${B}];ivec3 textureSize(int u,int l){${tt(i=>`return textureSize(GL_${i<B?"f["+i:"i["+(i-B)}],l);`,0,P)}}\n#define getSize textureSize\n`),12&T&&(H+=`uniform usampler2DArray GL_i[${N}];uvec4 uGetColor(int u,vec3 p){${tt(i=>`return texture(GL_i[${i-P}],p);`,P,2*P-B)}}uvec4 uGetPixel(int u,ivec3 p,int l){${tt(i=>`return texelFetch(GL_i[${i-P}],p,l);`,P,2*P-B)}}uvec4 uGetColor(usampler2DArray u,vec3 p){return texture(u,p);}uvec4 uGetPixel(usampler2DArray u,ivec3 p,int l){return texelFetch(u,p,l);}\n#define iGetColor(a,b) ivec4(uGetColor(a,b))\n#define iGetPixel(a,b,c) ivec4(uGetPixel(a,b,c))\n`),3&T&&(H+=`vec4 fGetColor(int u,vec3 p){${tt(i=>`return texture(GL_f[${i}],p);`,0,B)}}lowp vec4 GL_lp(vec4 x){return x;}vec4 fGetColor(sampler2DArray t,vec3 p){return texture(t,p);}vec4 fGetPixel(sampler2DArray t,ivec3 p,int l){return texelFetch(t,p,l);}vec4 fGetPixel(int u,ivec3 p,int l){${Z||tt(i=>`return texelFetch(GL_f[${i}],p,l);`,0,B)}}\n#define getColor(a,b)GL_lp(fGetColor(a,b))\n#define getPixel(a,b,c)GL_lp(fGetPixel(a,b,c))\n`),L[1]=H;const q=32-B&&-1>>>B|0;U[0]=`i&&draw(0);if($s!=s){_.useProgram($P);$H(s,${B},${q},${A>3?S+A*(A-1)+")":`lv==$Q?${S+9}:${S+6});$l(lv)`}}`;const W=k==it-1?`_.vertexAttribIPointer(${k},${3&m.F},5125,${m.F<<2},0)`:`for(let i=${it-1},j=0;i>=${k};i--,j+=16){_.vertexAttribIPointer(i,i==${k}?${3&m.F}:4,5125,${m.F<<2},j)`;R[0]=`sz+=${S};if(this.V()){const sd=$s!=s,{S}=this,_st=S.t;if(sd||sz!=$u){i&&draw(sd?0:$x);$H(s,${B},${q},sz);if(sd)_.useProgram($P),B();${A>3?`}if($v!=_st.v)i&&draw(),$l(_st.v);if(s!=_st.L||sz!=_st.Ls){i&&draw();if(!_st.Ls)$a(_st);$d(sz>${8+S},0,false);_st.L=s;_st.Ls=sz`:`$l(lv=sz>${8+S}?$Q:$q)}if(lv.geo!=_st.b){i&&draw();_.bindBuffer(34962,lv.geo=_st.b);${W};_.bindBuffer(34962,$M);_.bindBuffer(34963,_st.E)`}}if($p!=S)S.S();}let b=$X^$x;`+j.join(";")+`;const k=$G(sz),j=k+sz-${S}`,R.push("return k");const $d=(t=!1,s=0,r=!0)=>{const n=A*(2+t),u=S+n<<2;_.vertexAttribPointer(0,A,5126,!1,u,s),_.vertexAttribPointer(1,A,5126,!1,u,s+(A<<2)),t?(_.enableVertexAttribArray(2),_.vertexAttribPointer(2,A,5126,!1,u,s+(A<<3))):_.disableVertexAttribArray(2);for(let i=0;i<S;i+=4){const t=3+(i>>2);_.enableVertexAttribArray(t),_.vertexAttribIPointer(t,o(4,S-i),5125,u,s+(i+n<<2)),_.vertexAttribDivisor(t,1)}if(r){_.enableVertexAttribArray(0),_.enableVertexAttribArray(1),_.vertexAttribDivisor(0,1),_.vertexAttribDivisor(1,1),_.vertexAttribDivisor(2,1);for(let i=it-1;i>=k;i--)_.enableVertexAttribArray(i)}return u>>2};let $q=null,$Q=null;A<4&&(_.bindVertexArray($q=_.createVertexArray()),$q.geo=null,$d(!1),_.bindVertexArray($v=$Q=_.createVertexArray()),$Q.geo=null,$d(!0));const J=eval(`let ${A<4?"lv=$Q":"__"}${Y.length?Y.join(""):""};const B=function(){${X.join(";")};$x=$X},s=function(sz,{${g}}){${R.join(";")}};s.uniforms=(function(${O}){${U.join(";")};B()});s`),$P=_.createProgram(),K=_.createShader(35633),f=_.createShader(35632);if(E.push("}"),_.shaderSource(K,G.join("")+E.join("")),_.compileShader(K),_.shaderSource(f,L.join("")+"\n"+t),_.compileShader(f),_.attachShader($P,K),_.attachShader($P,f),Z=_.getShaderInfoLog(f))throw"GLSL Error:\n"+Z;_.linkProgram($P),_.useProgram($P);const $L=V.map(t=>_.getUniformLocation($P,t));for(let i=0;i<P;i++)_.uniform1i(_.getUniformLocation($P,i<B?"GL_f["+i+"]":"GL_i["+(i-B)+"]"),i>=B?P+i-B:i);return J.vertex=m,J.three=m.three,$s=J};let ft=0,yt=0,$t=0;$.Shader.UINT=$.Shader("void main(){color=param0;}",{params:$.UVEC4,outputs:$.UINT}),$.Shader.BLACK=$.Shader("void main(){color=vec4(0,0,0,1);}"),$.Shader.DEFAULT=$.Shader("void main(){color=param0(pos)*param1;}",{params:[$.COLOR,$.VEC4],defaults:[void 0,$.vec4.one]}),$.Shader.COLOR_3D_XZ=$.Shader("void main(){color=param0(pos.xz);}",{params:[$.COLOR],vertex:Geometry3D.DEFAULT_VERTEX}),$.Shader.SHADED_3D=$.Shader("void main(){float a=(1.+dot(normalize(cross(dFdx(pos),dFdy(pos))),param1));color=param0(pos.xy);color.rgb*=a;}",{params:[$.COLOR,$.VEC3],defaults:[void 0,vec3(-.15,-.3,0)],vertex:Geometry3D.DEFAULT_VERTEX});let pt=0;$.flush=()=>{i&&draw(),E?E=!1:R&&(_.bindBuffer(35051,null),_.deleteBuffer(R),R=null,G=-1);for(let i=0;i<P<<1;i++){const t=U[i];t&&(_.activeTexture(33984+i),_.bindTexture(35866,U[i]=null),t.i=-1)}let t=performance.now();t-pt>1e3&&(pt=t,$i=new Float32Array($i.length>>>1),$I=new Int32Array($i.buffer))};const _t=$.ctx=new q(curt={p:null,_:0,T:null,w:0,h:0,u:0});$.setSize=(w=0,h=0)=>{_.canvas.width=w,_.canvas.height=h,_t.t.w=_.drawingBufferWidth,_t.t.h=_.drawingBufferHeight,curt==_t.t&&(curt=Q=null),_t.t._=0};const bt=()=>{for(;wt&&37145==_.getSyncParameter(wt.sync,37140);)_.deleteSync(wt.sync),wt(),wt=wt.next;wt||(xt=null,clearInterval(vt),vt=0)};let wt=null,xt=null;const mt=[];$.wait=()=>new Promise(t=>{i?(t.sync=null,mt.push(t)):(t.sync=_.fenceSync(37143,0),wt??=t,xt=xt?xt.next=t:t),vt||(vt=setInterval(bt,0))});let vt=0;return $.loop=t=>("t"in $||($.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=.001*performance.now(),$.dt=0,$.frameCpu=0,$.glLost??=null,requestAnimationFrame(function f(){if(requestAnimationFrame(f),_.isContextLost())return $.glLost?.(),$.glLost=wt=xt=null;i&&draw(),_.bindFramebuffer(36009,N=curt=Q=null),_t.t._=0,dt=max(.001,o(-($.t-($.t=.001*performance.now())),.5)),_t.reset();try{t()}finally{$.flush(),$.frameCpu=.001*performance.now()-$.t,ft||$.ctx.clear(),$.frameDrawCalls=ft,$.frameSprites=yt,$.frameData=4*$t+24*ft,ft=yt=$t=0}})),$),$},Object.assign($.Gamma,{bitmapOpts:p,STENCIL:1,ALPHA_CHANNEL:2,PREMULTIPLIED_ALPHA:4,AUTO_CLEAR_BUFFER:8,MSAA:16})}