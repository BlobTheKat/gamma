{const $=globalThis;Math.PI2??=2*Math.PI;const{clz32:t,cos:s,sin:n,min:r,round:o}=Math;if(!("setImmediate"in $)){let t=0,s=0,n=[],r=new MessageChannel;r.port1.onmessage=()=>{const r=n[s];n[s++]=null,s>3&&s>n.length>>1&&(n.splice(0,s),t+=s,s=0),r?.()},r=r.port2,$.setImmediate=(s,...o)=>(r.postMessage(0),n.push(o.length?s.bind(void 0,...o):s),n.length-1+t),$.clearImmediate=i=>{(i-=t)===i>>>0&&(i>=n.length||(n[i]=null))}}if(!("sin"in $)){const t=Object.getOwnPropertyDescriptors(Math);delete t[Symbol.toStringTag],Object.defineProperties($,t)}const u={imageOrientation:"flipY",premultiplyAlpha:"premultiply"},p=(t,s,n)=>"string"==typeof t?fetch(t).then(a=>a.blob()).then(t=>createImageBitmap(t,u)).then(s,n):t instanceof Blob?createImageBitmap(t,u).then(s,n):s(t);$.Gamma=(u=document.createElement("canvas"),$={},R=15)=>{const _=$.gl=($.canvas=u).getContext("webgl2",{preserveDrawingBuffer:!(8&R),antialias:16&R,depth:!1,premultipliedAlpha:4&R,stencil:1&R,alpha:2&R});_.pixelStorei(37440,1),_.stencilMask(1),_.clearStencil(0),_.disable(2929),_.enable(3042),_.pixelStorei(3317,1),_.pixelStorei(3333,1);const A=_.createBuffer();_.bindBuffer(35052,A);let m=!0,g=null,v=-1,G=!1,E=285217039,$s=null,S=0,B=0,T=null,$X=0,$x=0,L=5,F=0,I=4,$p=null;_.bindFramebuffer(36008,_.createFramebuffer());const O=_.createFramebuffer(),N=_.createBuffer();_.bindBuffer(34962,N);const U=r(32,_.getParameter(34930)),M=[];for(let i=U<<1;i-- >0;)M.push(null);Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NEVER:48,UNSET:64,SET:128,FLIP:192,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:136,RGB_DST:8,ONE_MINUS_DST:153,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,ADD:17,RGB_ADD:1,A_ADD:16,SUB:85,RGB_SUB:5,A_SUB:80,SUB_REV:102,RGB_SUB_REV:6,A_SUB_REV:96,MIN:34,RGB_MIN:2,A_MIN:32,MAX:51,RGB_MAX:3,A_MAX:48,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:20,UTEXTURE:24,FTEXTURE:28,COLOR:4,UCOLOR:8,FCOLOR:12,FIXED:4,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0}),$.Formats={R:[33321,6403,5121],RG:[33323,33319,5121],RGB:[32849,6407,5121],RGBA:[32856,6408,5121],RGB565:[36194,6407,33635],R11F_G11F_B10F:[35898,6407,35899],RGB5_A1:[32855,6408,32820],RGB10_A2:[32857,6408,33640],RGBA4:[32854,6408,32819],RGB9_E5:[35901,6407,35902],R8:[33330,36244,5121,1<<31],RG8:[33336,33320,5121,1<<31],RGB8:[36221,36248,5121,1<<31],RGBA8:[36220,36249,5121,1<<31],R16:[33332,36244,5123,1<<31],RG16:[33338,33320,5123,1<<31],RGB16:[36215,36248,5123,1<<31],RGBA16:[36214,36249,5123,1<<31],R32:[33334,36244,5125,1<<31],RG32:[33340,33320,5125,1<<31],RGB32:[36209,36248,5125,1<<31],RGBA32:[36208,36249,5125,1<<31],R16F:[33325,6403,5131],RG16F:[33327,33319,5131],RGB16F:[34843,6407,5131],RGBA16F:[34842,6408,5131],R16F_32F:[33325,6403,5126],RG16F_32F:[33327,33319,5126],RGB16F_32F:[34843,6407,5126],RGBA16F_32F:[34842,6408,5126],R32F:[33326,6403,5126],RG32F:[33328,33319,5126],RGB32F:[34837,6407,5126],RGBA32F:[34836,6408,5126]},$.vec2=(x=0,y=x)=>({x:x,y:y}),$.vec2.one=$.vec2(1);const C=$.vec2.zero=$.vec2(0);$.vec2.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b}:{x:a.x+b.x,y:a.y+b.y},$.vec2.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b}:{x:a.x*b.x,y:a.y*b.y},$.vec3=(x=0,y=x,z=x)=>({x:x,y:y,z:z}),$.vec3.one=$.vec3(1);const D=$.vec3.zero=$.vec3(0);$.vec3.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z},$.vec3.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z},$.vec4=(x=0,y=x,z=x,w=x)=>({x:x,y:y,z:z,w:w}),$.vec4.one=$.vec4(1);const P=$.vec4.zero=$.vec4(0);$.vec4.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b,w:a.w+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z,w:a.w+b.w},$.vec4.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b,w:a.w*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z,w:a.w*b.w};class $m{get isInteger(){return this.t.f.length>3}get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get mipmaps(){return this.t.m}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,x=0,y=0,w=1,h=1,l=0){this.t=t,this.x=x,this.y=y,this.w=w,this.h=h,this.l=l}get loaded(){return!this.t.src}get waiting(){return!this.t._}get then(){return this.t.src?this.#t:null}load(){this.t._||$m.load(this.t)}sub(x=0,y=0,w=1,h=1,l=this.l){return new $m(this.t,this.x+x*this.w,this.y+y*this.h,this.w*w,this.h*h,l)}super(x=0,y=0,w=1,h=1,l=this.l){const t=this.w/w,s=this.h/h;return new $m(this.t,this.x-x*t,this.y-y*s,t,s,l)}crop(x=0,y=0,w=0,h=0,l=this.l){const{t:t,x:s,y:n,h:r}=this;if(!t.src)return new $m(t,s+x/t.w,n+r-(y+h)/t.h,w/t.w,h/t.h,l);const i=new $m(t,0,0,0,0,l);return t._||$m.load(t),t.src.push(i=>{i.x=s+x/t.w,i.y=n+r-(y+h)/t.h,i.w=w/t.w,i.h=h/t.h},void 0,i),i}layer(l=this.l){return new $m(this.t,this.x,this.y,this.w,this.h,l)}#t(t,s){"function"!=typeof t&&(t=Function.prototype),this.t.src?(this.t._||$m.load(this.t),this.t.src.push(t,s,this)):t(this)}static load(t){let s=t.src,n=0;t.src=[];let w=0,h=0;t._=_.createTexture();const r=()=>{n=-1,$m.setOptions(t),_.texStorage3D(35866,t.m,t.f[0],t.w=w=1,t.h=h=1,t.d),m||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),m=!0),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const s=t.src;t.src=null;for(let i=1;i<s.length;i+=3)s[i]?.(s[i+1])};for(let i=0;i<s.length;i++)p(s[i],o=>{if(n){if(w!=o.width||h!=o.height)return r()}else w=o.width,h=o.height;if(s[i]=o,++n<s.length)return;$m.setOptions(t),_.texStorage3D(35866,t.m,t.f[0],t.w=w,t.h=h,t.d),m||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),m=!0),_.bindBuffer(35052,null);for(let l=0;l<n;l++)_.texSubImage3D(35866,0,0,0,l,w,h,1,t.f[1],t.f[2],s[l]);_.bindBuffer(35052,A),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const u=t.src;t.src=null;for(let i=0;i<u.length;i+=3)u[i](u[i+2])},r)}paste(t,x=0,y=0,l=0,s=0,n=0,r=0,o=0,u=0,R=0,g=0,v=0){const{t:G}=this;if(G.src)return null;if(t.msaa)return i&&draw(),R=u||t.height,u=o||t.width,_.framebufferRenderbuffer(36008,36064,36161,t._),T!=O&&(_.bindFramebuffer(36009,T=O),curt=null),_.framebufferTextureLayer(36009,36064,G._,s,l),_.blitFramebuffer(n,r,n+u,r+R,x,y,x+u,y+R,16384,9728),this;if(!(t instanceof $m))return p(t,i=>($m.fakeBind(G),m||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),m=!0),_.bindBuffer(35052,null),_.texSubImage3D(35866,s,x,y,l,i.width,i.height,1,G.f[1],G.f[2],i),_.bindBuffer(35052,A),G.i<0&&_.bindTexture(35866,null),this));const{t:E}=t;if(E.src)return console.warn("Source texture is not loaded"),this;if(G._==E._)return console.warn("Cannot copy from texture to itself"),this;for($m.fakeBind(G),u=u||E.w,R=R||E.h,g=g||E.d;g--;)_.framebufferTextureLayer(36008,36064,E._,v,o++),_.copyTexSubImage3D(35866,s,x,y,l++,n,r,u,R);return G.i<0&&_.bindTexture(35866,null),this}pasteData(t,x=0,y=0,l=0,w=0,h=0,d=0,s=0){const{t:n}=this;return n.src?null:(w=w||n.w,h=h||n.h,d=d||n.d,$m.fakeBind(n),m&&(_.pixelStorei(37440,0),_.pixelStorei(37441,0),m=!1),_.bufferData(35052,t,35042),_.texSubImage3D(35866,s,x,y,l,w,h,d,n.f[1],n.f[2],0),J+=.25*t.byteLength,n.i<0&&_.bindTexture(35866,null),this)}readData(x=0,y=0,l=0,w=0,h=0,d=0,t=0){const{t:s}=this;if(s.src)return null;w=w||s.w,h=h||s.h,d=d||s.d,i&&draw();let a=s.f[0],n=33323==a||33338==a||33340==a||33327==a||33328==a||33336==a?2:33321==a||33330==a||33332==a||33334==a||33325==a||33326==a?1:4,r=n<=2?1==n?6403:33319:3==n?6407:6408;a=s.f[2]==5121?1:s.f[2]==5126||s.f[2]==5125||s.f[2]==35899||s.f[2]==33640||s.f[2]==35902?4:2,n*=w*h;let o,u=n*d*a;for(v==u?(o=g,v=-1,G=!0):(_.bindBuffer(35051,o=_.createBuffer()),_.bufferData(35051,u,35041),u>v&&(v=u,g=o,G=!0));d--;)_.framebufferTextureLayer(36008,36064,s._,t,l),_.readPixels(x,y,w,h,r,s.f[2],n*a*l++);return o!=g&&_.bindBuffer(35051,g),new Promise(t=>{const r=()=>{const $i=1==a?new Uint8Array(n*d):4==a?s.f[2]==5126?new Float32Array(n*d):new Uint32Array(n*d):new Uint16Array(n*d);o!=g&&_.bindBuffer(35051,o),_.getBufferSubData(35051,0,$i),t($i),o!=g&&(u>v?(v=u,g=o):_.bindBuffer(35051,g)),G=!0};r.sync=_.fenceSync(37143,0),tt??=r,it=it?it.next=r:r,et||(et=setInterval(Q,0))})}delete(){this.t._&&(_.deleteTexture(this.t._),this.t._=null,this.t.i>=0&&(M[this.t.i]=null,this.t.i=-1),this.t.d=this.t.w=this.t.h=0)}static auto(s,i=0){if(s.f[3]>>31!=i)return-2;if(s.i>=0){const t=-2147483648>>>s.i-(U-S&i);if(!(t&(i^B)))return $X|=t,s.i;M[s.i]=null,s.i=-1}s._||$m.load(s);const n=t(~($X|i^B));if(n>=U)return-1;$X|=-2147483648>>>n;const r=M[i=i?U+n-S:n];return r&&(r.i=-1),_.activeTexture(33984+i),_.bindTexture(35866,(M[i]=s)._),s.i=i}static fakeBind(t){if(t.i>=0)i&&draw(),_.activeTexture(33984+t.i);else{const s=U-1+(S==U&&U);M[s]&&(M[s].t.i=-1),_.activeTexture(33984+s),_.bindTexture(35866,t._)}}get options(){return this.t.o}static setOptions(t){$m.fakeBind(t);const{o:s}=t;t.f[3]>>31?(_.texParameterf(35866,10240,9728),_.texParameterf(35866,10241,9728)):(_.texParameterf(35866,10240,9728+(1&s)),_.texParameterf(35866,10241,t.m>1?9984+(s>>1&3):9728+(s>>1&1))),_.texParameterf(35866,10242,8&s?10497:16&s?33648:33071),_.texParameterf(35866,10243,32&s?10497:64&s?33648:33071)}set options(t){const{t:s}=this;s.o=t,s.src||($m.setOptions(s),s.i<0&&_.bindTexture(35866,null))}setMipmapRange(t=0,e=65535){const{t:s}=this;s.src||($m.fakeBind(s),_.texParameteri(35866,33082,t),_.texParameteri(35866,33083,e),s.i<0&&_.bindTexture(35866,null))}genMipmaps(){const{t:t}=this;t.m<2||($m.fakeBind(t),_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null))}}$.Drawable=(t=!1)=>new V({_:_.createFramebuffer(),$:0,p:t?_.createRenderbuffer():null,w:0,h:0,u:0}),$.Drawable.MAX_TARGETS=_.getParameter(36063);let $i=new Float32Array(1024),$I=new Int32Array($i.buffer),i=0;$.Texture=(w=0,h=0,d=0,t=0,f=Formats.RGBA,s=0)=>{const n={_:_.createTexture(),i:-1,o:t,f:f,src:null,w:w,h:h,d:+d||1,m:s=s||1},r=new $m(n);return $m.setOptions(n),w&&h?_.texStorage3D(35866,s,n.f[0],w,h,n.d):_.texStorage3D(35866,s,n.f[0],n.w=1,n.h=1,n.d),_.bindTexture(35866,null),r},$.Texture.MAX_WIDTH=$.Texture.MAX_HEIGHT=_.getParameter(3379),$.Texture.MAX_LAYERS=_.getParameter(35071),$.Texture.FILTER_32F=!!_.getExtension("OES_texture_float_linear");const j=$.Texture.MAX_MSAA=_.getParameter(36183);$.Texture.MSAA=(w=0,h=0,t=65536,f=Formats.RGBA)=>{t=r(t,j);const s=_.createRenderbuffer();return _.bindRenderbuffer(36161,s),_.renderbufferStorageMultisample(36161,t,f[0],w,h),{_:s,width:w,height:h,msaa:_.getRenderbufferParameter(36161,36011),delete(){_.deleteRenderbuffer(this._)}}},$.Texture.from=(t,s=0,n=Formats.RGBA,r=0)=>new $m({_:null,i:-1,o:s,f:n,src:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:t?Array.isArray(t)?t.length:1:0,m:r||1});const $G=ArrayBuffer.prototype.transfer?t=>{const s=i;return(i=s+t)>$i.length&&($i=new Float32Array($i.buffer.transfer(8*i)),$I=new Int32Array($i.buffer)),s}:t=>{const s=i;if((i=s+t)>$i.length){const t=$i;($i=new Float32Array(2*i)).set(t,0),$I=new Int32Array($i.buffer)}return s};class H{t;s;v=0;get width(){return this.t.w}get height(){return this.t.h}set mask(t){this.v=-256&this.v|255&t}get mask(){return 255&this.v}set blend(b){this.v=255&this.v|(b||1135889)<<8}get blend(){return this.v>>8}get geometry(){return this.S}set geometry(a){this.S=a||$d}constructor(t,s=290787599,n=$d){this.t=t,this.v=s,this.S=n}setTarget(t=0,s=null,l=0,n=0){const{t:r}=this;if(r._){if(i&&draw(),T!=r._&&(_.bindFramebuffer(36009,T=r._),curt=null),!s){if(!r.u)return;return _.framebufferRenderbuffer(36009,36064+t,36161,null),void((r.u&=~(1<<t))||(r.w=r.h=0,_.framebufferRenderbuffer(36009,36128,36161,null)))}if((r.u&=~(1<<t))||(r.w=r.h=0),r.w){if(r.w!=s.width||r.h!=s.height)return}else r.w=s.width,r.h=s.height,r.p&&(_.bindRenderbuffer(36161,r.p),_.renderbufferStorage(36161,36168,r.w,r.h),_.framebufferRenderbuffer(36009,36128,36161,r.p));r.u|=1<<t,s.msaa?_.framebufferRenderbuffer(36009,36064+t,36161,s._):_.framebufferTextureLayer(36009,36064+t,s.t._,l,n)}}clearTargets(){const{t:s}=this;if(!s._)return;i&&draw();let n=s.u;if(s.u=s.w=s.h=0,s.p&&(_.framebufferRenderbuffer(36009,36128,36161,null),_.deleteRenderbuffer(s.p),s.p=_.createRenderbuffer()),n)for(T!=s._&&(_.bindFramebuffer(36009,T=s._),curt=null);n;){const s=31-t(n);n&=~(1<<s),_.framebufferRenderbuffer(36009,36064+s,36161,null)}}get hasStencil(){return this.t._?!!this.t.p:!!(1&R)}set hasStencil(t){let{t:s}=this,b=s.p;s._&&!t!=!b&&(i&&draw(),s.p=b=b?(_.deleteRenderbuffer(b),null):_.createRenderbuffer(),s.w&&(T!=s._&&(_.bindFramebuffer(36009,T=s._),curt=null),b?(_.bindRenderbuffer(36161,b),_.renderbufferStorage(36161,36168,s.w,s.h),_.framebufferRenderbuffer(36009,36128,36161,b)):_.framebufferRenderbuffer(36009,36128,36161,null)))}clear(t=0,s=t,b=t,a=s){"object"==typeof t&&(a=t.w??0,b=t.z??0,s=t.y,t=t.x),i&&draw(),$S(this.t,this.v),_.clearColor(t,s,b,a);const n=this.t.$=this.t.$+1&7;_.clear(n?16384:(_.stencilMask(255),17408)),W++,_.disable(2960),E&=-241}clearStencil(){i&&draw(),$S(this.t,this.v);(this.t.$=this.t.$+1&7)||(_.stencilMask(255),_.clear(1024)),_.disable(2960),E&=-241}}class V extends H{#i;#s;#e;#n;#r;#h;#o;set shader($s){this.#o="function"==typeof $s?$s:$.Shader.DEFAULT}get shader(){return this.#o}constructor(t,s=290787599,n=$d,r=$.Shader.DEFAULT,a=1,b=0,c=0,d=1,e=0,f=0){super(t,s,n),this.#o=r,this.#i=a,this.#s=b,this.#e=c,this.#n=d,this.#r=e,this.#h=f}translate(x=0,y=0){this.#r+=x*this.#i+y*this.#e,this.#h+=x*this.#s+y*this.#n}scale(x=1,y=x){this.#i*=x,this.#s*=x,this.#e*=y,this.#n*=y}rotate(t=0){const r=s(t),o=n(t),a=this.#i,b=this.#s,c=this.#e,d=this.#n;this.#i=a*r-c*o,this.#s=b*r-d*o,this.#e=a*o+c*r,this.#n=b*o+d*r}transform(a,b,c,d,e,f){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.#i,s=this.#s,n=this.#e,r=this.#n,o=this.#r,u=this.#h;this.#i=t*a+n*b,this.#s=s*a+r*b,this.#e=t*c+n*d,this.#n=s*c+r*d,this.#r=t*e+n*f+o,this.#h=s*e+r*f+u}skew(x=0,y=0){const t=this.#i,s=this.#s;this.#i+=this.#e*y,this.#s+=this.#n*y,this.#e+=t*x,this.#n+=s*x}multiply(x=1,y=0){const t=this.#i,s=this.#s;this.#i=t*x-this.#e*y,this.#s=s*x-this.#n*y,this.#e=t*y+this.#e*x,this.#n=s*y+this.#n*x}getTransform(){return{a:this.#i,b:this.#s,c:this.#e,d:this.#n,e:this.#r,f:this.#h}}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.#i=a,this.#s=b,this.#e=c,this.#n=d,this.#r=e,this.#h=f,this.v=290787599,this.#o=$.Shader.DEFAULT,this.S=$d}box(x=0,y=0,w=1,h=w){this.#r+=x*this.#i+y*this.#e,this.#h+=x*this.#s+y*this.#n,this.#i*=w,this.#s*=w,this.#e*=h,this.#n*=h}to(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.#i*x+this.#e*y+this.#r,y:this.#s*x+this.#n*y+this.#h}}from(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const a=this.#i,b=this.#s,c=this.#e,d=this.#n,t=a*d-b*c;return{x:(x*d-y*c+c*this.#h-d*this.#r)/t,y:(y*a-x*b+b*this.#r-a*this.#h)/t}}toDelta(t=0,s=0){return"object"==typeof t&&({x:t,y:s}=t),{x:this.#i*t+this.#e*s,y:this.#s*t+this.#n*s}}fromDelta(t=0,s=0){"object"==typeof t&&({x:t,y:s}=t);const a=this.#i,b=this.#s,c=this.#e,d=this.#n,n=a*d-b*c;return{x:(t*d-s*c)/n,y:(s*a-t*b)/n}}determinant(){return this.#i*this.#n-this.#s*this.#e}pixelRatio(){return sqrt(abs(this.#i*this.#n-this.#s*this.#e)*this.t.w*this.t.h)}sub(){return new V(this.t,this.v,this.S,this.#o,this.#i,this.#s,this.#e,this.#n,this.#r,this.#h)}resetTo(t){this.#i=t.#i,this.#s=t.#s,this.#e=t.#e,this.#n=t.#n,this.#r=t.#r,this.#h=t.#h,this.v=t.v,this.#o=t.#o,this.S=t.S}draw(...t){const i=this.#o(t);$i[i]=this.#i,$i[i+1]=this.#e,$i[i+2]=this.#r,$i[i+3]=this.#s,$i[i+4]=this.#n,$i[i+5]=this.#h}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.#o(t);$i[i]=this.#i*w,$i[i+1]=this.#e*h,$i[i+2]=this.#r+x*this.#i+y*this.#e,$i[i+3]=this.#s*w,$i[i+4]=this.#n*h,$i[i+5]=this.#h+x*this.#s+y*this.#n}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.#o(t),s=this.#i,n=this.#s,r=this.#e,o=this.#n,u=this.#r,p=this.#h;$i[i]=s*a+r*b,$i[i+1]=s*c+r*d,$i[i+2]=s*e+r*f+u,$i[i+3]=n*a+o*b,$i[i+4]=n*c+o*d,$i[i+5]=n*e+o*f+p}drawv(t){const i=this.#o(t);$i[i]=this.#i,$i[i+1]=this.#e,$i[i+2]=this.#r,$i[i+3]=this.#s,$i[i+4]=this.#n,$i[i+5]=this.#h}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.#o(t);$i[i]=this.#i*w,$i[i+1]=this.#e*h,$i[i+2]=this.#r+x*this.#i+y*this.#e,$i[i+3]=this.#s*w,$i[i+4]=this.#n*h,$i[i+5]=this.#h+x*this.#s+y*this.#n}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.#o(t),s=this.#i,n=this.#s,r=this.#e,o=this.#n,u=this.#r,p=this.#h;$i[i]=s*a+r*b,$i[i+1]=s*c+r*d,$i[i+2]=s*e+r*f+u,$i[i+3]=n*a+o*b,$i[i+4]=n*c+o*d,$i[i+5]=n*e+o*f+p}dup(){if(!i)return;const t=$s.count,s=$G(t);for(let n=s-t;n<s;n++)$I[n+t]=$I[n];$i[s]=this.#i,$i[s+1]=this.#e,$i[s+2]=this.#r,$i[s+3]=this.#s,$i[s+4]=this.#n,$i[s+5]=this.#h}dupRect(x=0,y=0,w=1,h=1){if(!i)return;const t=$s.count,s=$G(t);for(let n=s-t;n<s;n++)$I[n+t]=$I[n];$i[s]=this.#i*w,$i[s+1]=this.#e*h,$i[s+2]=this.#r+x*this.#i+y*this.#e,$i[s+3]=this.#s*w,$i[s+4]=this.#n*h,$i[s+5]=this.#h+x*this.#s+y*this.#n}dupMat(a=1,b=0,c=0,d=1,e=0,f=0){if(!i)return;const t=$s.count,s=$G(t);for(let n=s-t;n<s;n++)$I[n+t]=$I[n];const n=this.#i,r=this.#s,o=this.#e,u=this.#n,p=this.#r,R=this.#h;$i[s]=n*a+o*b,$i[s+1]=n*c+o*d,$i[s+2]=n*e+o*f+p,$i[s+3]=r*a+u*b,$i[s+4]=r*c+u*d,$i[s+5]=r*e+u*f+R}}function $S(t,s){const n=t.$;let d=E^s;if(curt!=t&&(i&&draw(),curt&&curt.$!=t.$&&(d|=240),T!=t._&&_.bindFramebuffer(36009,T=t._),_.viewport(0,0,t.w,t.h),curt=t),d){if(i&&draw(),15&d&&_.colorMask(1&s,2&s,4&s,8&s),240&d)if(240&s){240&E||_.enable(2960),_.stencilMask(1<<n),_.stencilFunc(32&s?16&s?512:517:16&s?514:519,255,1<<n);const t=128&s?64&s?5386:7681:64&s?0:7680;_.stencilOp(t,t,t)}else 240&E&&_.disable(2960);1996488704&d&&_.blendEquationSeparate(32773+(s>>24&7),32773+(s>>28&7)),16776960&d&&_.blendFuncSeparate((s>>8&15)+766*!!(3584&s),(s>>16&15)+766*!!(917504&s),(s>>12&15)+766*!!(57344&s),(s>>20&15)+766*!!(14680064&s)),-2147483648&d&&(-2147483648&s?_.enable(32926):_.disable(32926)),E=s}}function draw(b=$x){if(_.bufferData(34962,$I.subarray(0,i),35040),J+=i,i/=$s.count,W++,Z+=i,_.drawArraysInstanced(L,F,I,i),i=0,$X=b,st.length){tt??=st[0];for(const f of st)f.sync=_.fenceSync(37143,0),it=it?it.next=f:f;st.length=0}}function X(t=0,l=this.length-t,s=this.type){return{type:s,b:this.b,start:this.start+t,length:l,sub:X}}Object.assign($.Blend=(t=17,s=17,n=0,r=!1)=>t|n<<8|s<<16|r<<23,{REPLACE:1114129,DEFAULT:1135889,ADD:1118465,MULTIPLY:1122816,SUBTRACT:5574913,REVERSE_SUBTRACT:7737601,MIN:2232593,MAX:3346705,BEHIND:1118583,INVERT:1127321}),$.Geometry=(t,s)=>{if(3&s.length)throw"points.length is not a multiple of 4";if(!(s instanceof Float32Array)){const t=new Float32Array(s.length);t.set(s,0),s=t}const b=_.createBuffer();return _.bindBuffer(34962,b),_.bufferData(34962,s,35044),b.type=t,_.bindBuffer(34962,N),{type:t,b:b,start:0,length:s.length>>2,sub:X}};const $d=$.Geometry.DEFAULT=$.Geometry($.TRIANGLE_STRIP,[0,0,0,0,0,1,0,1,1,0,1,0,1,1,1,1]),k=(f,t,e)=>{let s="switch(u){";for(;t<e;)s+=`case ${t}:${f(t++)}`;return s+"}"},Y=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"],q=_.getParameter(34921)<<2;function $l(t,s,n){$s=t,S=s,B=n}function $h(t){i&&draw(),$p=t,L=t.type,F=t.start,I=t.length}$.Shader=(t,{params:s,$D:$D,uniforms:n,$U:$U,outputs:u=4,intFrac:p=.5}={})=>{if(s="number"==typeof s?[s]:s||[],n="number"==typeof n?[n]:n||[],$D=void 0!==$D?Array.isArray($D)?[...$D]:[$D]:[],$U=void 0!==$U?Array.isArray($U)?[...$U]:[$U]:[],u="number"==typeof u?[u]:u||[],u.length>Drawable.MAX_TARGETS)throw`Too many shader outputs (Drawable.MAX_TARGETS == ${Drawable.MAX_TARGETS})`;const R=[],A=[""],m=["#version 300 es\nprecision highp float;precision highp int;layout(location=0)in vec4 _pos;centroid out vec2 uv,xy;layout(location=1)in mat2x3 m;",""],g=["void main(){gl_PointSize=1.0;uv=_pos.zw;gl_Position=vec4((xy=vec3(_pos.xy,1.)*m)*2.-1.,0.,1.);"],v=["#version 300 es\nprecision highp float;precision highp int;centroid in vec2 uv,xy;\n#define color color0\n"+u.map((t,i)=>`layout(location=${i})out ${t?16==t||32==t?"u":"lowp ":""}vec4 color${i};`).join(";"),""];let G=6,E=0,S=0,B=0;const T=[];let L=0;const F=t=>{const s=""+L>>2,n=3&L,r=3&(L+=t)||4;if(r<=n){const o=""+L>>2;m.push(`layout(location=${3+(L>>2)})in uvec4 a${o};flat out uvec4 GL_a${o};`),v.push(`flat in uvec4 GL_a${o};`),g.push(`GL_a${o}=a${o};`);let u=`uvec${t}(GL_a${s}.`;for(let i=n;i<4;i++)u+="xyzw"[i];u+=`,GL_a${o}.`;for(let i=0;i<r;i++)u+="xyzw"[i];return u+")"}if(4==r&&0==n)return"GL_a"+s;let o=`GL_a${s}.`;for(let i=n;i<r;i++)o+="xyzw"[i];return o};let I=0;for(const t of s){let c=1+(3&t),s=Y[3&t|t>>4<<2];const n=4==t||8==t||12==t;$D[I]??=4==t?P:1==c?0:2==c?C:3==c?D:P,R.push(I+":a"+G+"=$D["+I+"]");const r=t>15||8==t?"$I[j+":"$i[j+";if(20!=t&&24!=t&&28!=t||(s="int",E|=1<<(t>>2)-3,S++,T.push(`a${G}=($m.auto(a${G+(24==t?".t,-1":".t,0")})+1||(i&&draw(b^$X),$m.auto(a${G+(24==t?".t,-1":".t,0")})+1))-1`)),12!=t&&28!=t||(E|=2),8!=t&&24!=t||(B++,S--),n){T.push(`let a${G+1}=-1;if(a${G}.t){if((a${G+1}=$m.auto(a${G}.t,${-(8==t)}))==-1){i&&draw(b^$X);a${G+1}=$m.auto(a${G}.t,${-(8==t)})}a${G+1}|=a${G}.l<<8}`),S++;const s=F(1),n=F(2),o=F(2);v.push(`${4==t?"lowp ":8==t?"u":"highp "}vec4 arg${I}(vec2 uv){int v=int(${s});if(v<0)return vec4(uintBitsToFloat(${n}),uintBitsToFloat(${o}));return ${4==t?"g":8==t?"uG":"fG"}etColor(v&255,vec3(uv*uintBitsToFloat(${o})+uintBitsToFloat(${n}),v>>8));}`),E|=1<<1+(t>>2),A.push(`$I[j+${G}]=a${G+1};if(a${G+1}>=0)$i[j+${G+1}]=a${G}.x,$i[j+${G+2}]=a${G}.y,$i[j+${G+3}]=a${G}.w,$i[j+${G+4}]=a${G}.h;else ${r}${G+1}]=a${G}.x,${r}${G+2}]=a${G}.y,${r}${G+3}]=a${G}.z,${r}${G+4}]=a${G}.w`),c=5}else{const s=F(c);if(v.push(`\n#define arg${I} ${t<16?"uintBitsToFloat":t<32?Y[3&t|4]:""}(${s})\n`),1==c)A.push(r+G+"]=a"+G);else for(let t=0;t<c;t++)A.push(r+(G+t)+"]=a"+G+"."+"xyzw"[t])}G+=c,I++}I=0;let O=0;const M=[],j=[""],H=[],V=[];let X=[];for(const t of n){let c=1+(3&t),s=Y[3&t|t>>4<<2];if($U[I]??=4==t?P:1==c?0:2==c?C:3==c?D:P,M.push("a"+O+"=$U["+I+"]"),12!=t&&28!=t||(E|=2),8!=t&&24!=t||(B++,S--),20==t||24==t||28==t)E|=1<<(t>>2)-3,S++,H.push(`_.uniform1i($L[${V.length}],s${X.length}?$m.auto(s${X.length}${24==t?",-1":",0"}):${24==t?U:0})`),V.push("uni"+I),v.push("uniform int uni"+I+";"),j.push(`s${X.length}=a${O}.t`),X.push(`s${X.length}=null`);else if(4==t||8==t||12==t){const s="GL_u"+I,n="GL_U"+I;H.push(`_.uniform1i($L[${V.length}],(s${X.length}?$m.auto(s${X.length}${8==t?",-1":",0"}):${8==t?U:0})|s${X.length+1})`),S++,v.push(8==t?`uniform uint ${s};uniform uvec4 ${n}; ${4==t?"lowp ":8==t?"u":""}vec4 uni${I}(vec2 uv){if(${s}<0)return ${n};return ${4==t?"g":8==t?"uG":"fG"}etColor(${s}&255,vec3(uv*uintBitsToFloat(${n}.zw)+uintBitsToFloat(${n}.xy),${s}>>8));}`:`uniform uint ${s};uniform vec4 ${n}; ${4==t?"lowp ":8==t?"u":""}vec4 uni${I}(vec2 uv){if(${s}<0)return ${n};return ${4==t?"g":8==t?"uG":"fG"}etColor(${s}&255,vec3(uv*${n}.zw+${n}.xy,${s}>>8));}`),E|=1<<1+(t>>2),j.push(`s${X.length}=a${O}.t;s${X.length+1}=a${O}.l<<8;_.uniform4f($L[${V.length-1}],a${O}.x,a${O}.y,a${O}.w,a${O}.h)`),V.push(s,n),X.push(`s${X.length}=null,s${X.length+1}=0`)}else{v.push("uniform "+s+" uni"+I+";");let n=`_.uniform${c+(t<16?"f":t<32?"i":"ui")}($L[${V.length}]`;if(V.push("uni"+I),1==c)n+=",a"+O;else for(let t=-1;++t<c;)n+=",a"+O+"."+"xyzw"[t];j.push(n+")")}O+=c,I++}if(S+B>16)throw"Shaders cannot use more than 16 textures/colors";S=S?B?S+o(p*(U-S-B)):U:0,B=B&&U-S;let W=null;v[1]=(20&E?"uniform "+(2&E?"highp":"lowp")+" sampler2DArray GL_f["+S+"];":"")+(8&E?"uniform highp usampler2DArray GL_i["+B+"];":"")+(4&E?`lowp vec4 getColor(int u,vec3 p){${W=k(i=>"return texture(GL_f["+i+"],p);",0,S)}}`:"")+(16&E?`highp vec4 fGetColor(int u,vec3 p){${W||k(i=>"return texture(GL_f["+i+"],p);",0,S)}}`:"")+(8&E?`uvec4 uGetColor(int u,vec3 p){${k(i=>"return texture(GL_i["+(i-U)+"],p);",U,2*U-S)}}`:""),v[1]+=(4&E?`lowp vec4 getPixel(int u,ivec3 p,int l){${W=k(i=>"return texelFetch(GL_f["+i+"],p,l);",0,S)}}`:"")+(16&E?`highp vec4 fGetPixel(int u,ivec3 p,int l){${W||k(i=>"return texelFetch(GL_f["+i+"],p,l);",0,S)}}`:"")+(8&E?`uvec4 uGetPixel(int u,ivec3 p,int l){${k(i=>"return texelFetch(GL_i["+(i-U)+"],p,l);",U,2*U-S)}}`:"")+(28&E?`ivec3 getSize(int u,int l){${k(i=>"return textureSize(GL_"+(i<S?"f["+i:"i["+(i-S))+"],l);",0,U)}}`:"");const Z=32-S&&-1>>>S;j[0]=`i&&draw(0);if($s!=s){_.useProgram($P);_.bindVertexArray($V);$l(s,${S},${Z})}`,A[0]=`$S(this.t,this._mask);if($s!=s){i&&draw(0);$l(s,${S},${Z});_.useProgram($P);_.bindVertexArray($V);B()};if($p!=this.S)$h(this.S);if(geo!=this.S.b){_.bindBuffer(34962,geo=this.S.b);_.vertexAttribPointer(0,4,5126,0,0,0);_.bindBuffer(34962,buf)};let b=$X^$x;`+T.join(";")+`;const j=$G(${G})`,A.push("return j");const J=eval(`let geo=$d.b${X.length?","+X.join(","):""};const B=function(){${H.join(";")};$x=$X},s=function({${R}}){${A.join(";")}};s.uniforms=(function(${M}){${j.join(";")};B()});s`),$P=_.createProgram(),K=_.createShader(35633),f=_.createShader(35632);g.push("}"),L&&(m[0]+="layout(location=3)in uvec4 a0;flat out uvec4 GL_a0;",g[0]+="GL_a0=a0;",v[0]+="flat in uvec4 GL_a0;"),_.shaderSource(K,m.join("")+g.join("")),_.compileShader(K),_.shaderSource(f,v.join("")+"\n"+t),_.compileShader(f),_.attachShader($P,K),_.attachShader($P,f),(W=_.getShaderInfoLog(f))?console.warn("GLSL Error:\n"+W):_.linkProgram($P),_.useProgram($P);const $L=V.map(t=>_.getUniformLocation($P,t));for(let i=0;i<U;i++)_.uniform1i(_.getUniformLocation($P,i<S?"GL_f["+i+"]":"GL_i["+(i-S)+"]"),i>=S?U+i-S:i);J.count=G;const $V=_.createVertexArray();if(_.bindVertexArray($V),_.bindBuffer(34962,$d.b),_.enableVertexAttribArray(0),_.vertexAttribPointer(0,4,5126,0,0,0),_.bindBuffer(34962,N),G+6>q)throw"Exceeded maximum number of shader parameters";G<<=2;for(let t=0;t<2;t++)_.enableVertexAttribArray(t+1),_.vertexAttribPointer(t+1,3,5126,!1,G,12*t),_.vertexAttribDivisor(t+1,1);for(let t=0;t<L;t+=4){const s=3+(t>>2);_.enableVertexAttribArray(s),_.vertexAttribIPointer(s,r(4,L-t),5125,G,t+6<<2),_.vertexAttribDivisor(s,1)}return $s=J,J};let W=0,Z=0,J=0;$.Shader.MAX_PARAMS=q-12,$.Shader.UINT=$.Shader("void main(){color=arg0;}",{params:$.UVEC4,outputs:$.UINT}),$.Shader.BLACK=$.Shader("void main(){color=vec4(0,0,0,1);}"),$.Shader.DEFAULT=$.Shader("void main(){color=arg0(uv)*arg1;}",{params:[$.COLOR,$.VEC4],$D:[void 0,$.vec4.one]}),$.flush=()=>{i&&draw(),G?G=!1:g&&(_.bindBuffer(35051,null),_.deleteBuffer(g),g=null,v=-1);for(let i=0;i<U<<1;i++){const t=M[i];t&&(_.activeTexture(33984+i),_.bindTexture(35866,M[i]=null),t.i=-1)}$i=new Float32Array(1024),$I=new Int32Array($i.buffer)};const K=$.ctx=new V(curt={_:null,$:0,p:null,w:0,h:0,u:0});$.setSize=(w=0,h=0)=>{_.canvas.width=w,_.canvas.height=h,K.t.w=_.drawingBufferWidth,K.t.h=_.drawingBufferHeight,curt==K.t&&(curt=null),K.t.$=0};const Q=()=>{for(;tt&&37145==_.getSyncParameter(tt.sync,37140);)_.deleteSync(tt.sync),tt(),tt=tt.next;tt||(it=null,clearInterval(et),et=0)};let tt=null,it=null;const st=[];$.wait=()=>new Promise(t=>{i?(t.sync=null,st.push(t)):(t.sync=_.fenceSync(37143,0),tt??=t,it=it?it.next=t:t),et||(et=setInterval(Q,0))});let et=0;return $.loop=t=>("t"in $||($.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=.001*performance.now(),$.dt=0,$.timeToFrame=0,$.glLost??=null,requestAnimationFrame(function f(){if(requestAnimationFrame(f),_.isContextLost())return $.glLost?.(),$.glLost=tt=it=null;i&&draw(),_.bindFramebuffer(36009,T=curt=null),K.t.$=0,dt=max(.001,r(-($.t-($.t=.001*performance.now())),.5)),K.reset();try{t()}finally{$.flush(),$.timeToFrame=.001*performance.now()-$.t,W||$.ctx.clear(),$.frameDrawCalls=W,$.frameSprites=Z,$.frameData=4*J+24*W,W=Z=J=0}})),$),$},Object.assign($.Gamma,{bitmapOpts:u,STENCIL:1,ALPHA_CHANNEL:2,PREMULTIPLIED_ALPHA:4,AUTO_CLEAR_BUFFER:8,MSAA:16})}