{const $=globalThis;Math.PI2??=2*Math.PI,Math.HALF_SQRT3??=.8660254037844386,Math.clamp??=(t,s,r)=>t<s?s:t>r?r:t;const{clz32:t,cos:s,sin:r,min:o,round:u}=Math;if(!("setImmediate"in $)){let T=0,L=0,B=[],N=new MessageChannel;N.port1.onmessage=()=>{const t=B[L];B[L++]=null,L>3&&L>B.length>>1&&(B.splice(0,L),T+=L,L=0),t?.()},N=N.port2,$.setImmediate=(t,...s)=>(N.postMessage(0),B.push(s.length?t.bind(void 0,...s):t),B.length-1+T),$.clearImmediate=i=>{(i-=T)===i>>>0&&(i>=B.length||(B[i]=null))}}if(!("sin"in $)){const F=Object.getOwnPropertyDescriptors(Math);delete F[Symbol.toStringTag],Object.defineProperties($,F)}const p={imageOrientation:"flipY",premultiplyAlpha:"premultiply"},v=(t,s,r)=>"string"==typeof t?fetch(t).then(a=>a.blob()).then(t=>createImageBitmap(t,p)).then(s,r):t instanceof Blob?createImageBitmap(t,p).then(s,r):s(t);let g=[];function _loopBoundary2(){if(!g.length)return null;let t=1,s=0,r=1,n=0,o=g[0],u=g[1],p=abs(u-.5)<=.5;for(let i=g.length;i;){i-=2;const x=g[i],y=g[i+1];if(!p){let f=((u>=y)-y)/(u-y);abs(f-.5)<=.5&&(f=x+f*(o-x),f<t&&(t=f),f>s&&(s=f))}if(p=abs(y-.5)<=.5,p)x<t&&(t=x),x>s&&(s=x);else{let f=((y>=u)-u)/(y-u);abs(f-.5)<=.5&&(f=o+f*(x-o),f<t&&(t=f),f>s&&(s=f))}o=x,u=y}p=abs(o-.5)<=.5;for(let i=g.length;i;){i-=2;const x=g[i],y=g[i+1];if(!p){let f=((o>=x)-x)/(o-x);abs(f-.5)<=.5&&(f=y+f*(u-y),f<r&&(r=f),f>n&&(n=f))}if(p=abs(x-.5)<=.5,p)y<r&&(r=y),y>n&&(n=y);else{let f=((x>=o)-o)/(x-o);abs(f-.5)<=.5&&(f=u+f*(y-u),f<r&&(r=f),f>n&&(n=f))}o=x,u=y}return g.length=0,s>t&&n>r?{x0:t,y0:r,x1:s,y1:n}:null}function _loopBoundary3(){if(!g.length)return null;let t=1,s=0,r=1,n=0,o=g[0],u=g[1],p=g[2];o*=p,u*=p;let m=abs(u-.5)<=.5,v=1,A=0;for(let i=g.length;i;){i-=3;let x=g[i],y=g[i+1],z=g[i+2];x*=z,y*=z;let r=abs(y-.5)<=.5;t:if(z*p>=0){if(!m){let f=((u>=y)-y)/(u-y);abs(f-.5)<=.5&&(f=x+f*(o-x),z>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>A&&(A=f)))}let f;if(r)f=x;else{if(f=((y>=u)-u)/(y-u),!(abs(f-.5)<=.5))break t;f=o+f*(x-o)}z>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>A&&(A=f))}else{if(!r){let f=((u>=y)-u)/(u-y);f>=0&&(f=o+f*(o-x),p>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>A&&(A=f)))}if(r&&(z>=0?(x<t&&(t=x),x>s&&(s=x)):(x<v&&(v=x),x>A&&(A=x))),!m){let f=((y>=u)-y)/(y-u);f>=0&&(f=x+f*(x-o),z>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>A&&(A=f)))}}o=x,u=y,p=z,m=r}t:if(A>=v){if(A<t){s=1;break t}if(v>s){t=0;break t}s=1,t=0}v=1,A=0,m=p>0&&abs(o-.5)<=.5;for(let i=g.length;i;){i-=3;let x=g[i],y=g[i+1],z=g[i+2];x*=z,y*=z;let t=abs(x-.5)<=.5;t:if(z*p>=0){if(!m){let f=((o>=x)-x)/(o-x);abs(f-.5)<=.5&&(f=y+f*(u-y),z>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>A&&(A=f)))}let f;if(t)f=y;else{if(f=((x>=o)-o)/(x-o),!(abs(f-.5)<=.5))break t;f=u+f*(y-u)}z>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>A&&(A=f))}else{if(!t){let f=((o>=x)-o)/(o-x);f>=0&&(f=u+f*(u-y),p>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>A&&(A=f)))}if(t&&(z>=0?(y<r&&(r=y),y>n&&(n=y)):(y<v&&(v=y),y>A&&(A=y))),!m){let f=((x>=o)-x)/(x-o);f>=0&&(f=y+f*(y-u),z>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>A&&(A=f)))}}o=x,u=y,p=z,m=t}t:if(A>=v){if(A<r){n=1;break t}if(v>n){r=0;break t}n=1,r=0}return g.length=0,s>t&&n>r?{x0:t<0?0:t,y0:r<0?0:r,x1:s>1?1:s,y1:n>1?1:n}:null}class A{constructor(a=1,b=0,c=0,d=1,e=0,f=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f}sub(){return new A(this.a,this.b,this.c,this.d,this.e,this.f)}subPersp(t=1){return new R(this.a,this.b,this.c,this.d,this.e,this.f,0,0,t)}sub3d(){return new G(this.a,this.b,this.c,this.d,0,0,this.e,this.f)}sub3dPersp(t=0,s=1){return new E(this.a,this.b,0,this.c,this.d,0,this.e*s,this.f*s,s,this.e*t,this.f*t,t)}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f}project(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y+this.e,y:this.b*x+this.d*y+this.f}}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:((x-=this.e)*d-(y-=this.f)*c)*t,y:(y*a-x*b)*t}}translate(x=0,y=0){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d}=this;this.a=a*n-c*o,this.b=b*n-d*o,this.c=a*o+c*n,this.d=b*o+d*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d;this.a=t*a+r*b,this.b=s*a+n*b,this.c=t*c+r*d,this.d=s*c+n*d,this.e+=t*e+r*f,this.f+=s*e+n*f}transformInverse(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=1/(a*d-b*c),s=this.a,r=this.b,n=this.c,o=this.d;this.a=(s*d-n*b)*t,this.b=(r*d-o*b)*t,this.c=(n*a-s*c)*t,this.d=(o*a-r*c)*t;const u=(c*f-d*e)*t,p=(b*e-a*f)*t;this.e+=s*u+n*p,this.f+=r*u+o*p}skew(x=0,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a+c*y,this.b=b+d*y,this.c=c+a*x,this.d=d+b*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a*x-c*y,this.b=b*x-d*y,this.c=c*x+a*y,this.d=d*x+b*y}box(x=0,y=0,w=1,h=w){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d,this.a*=w,this.b*=w,this.c*=h,this.d*=h}point(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y+this.e,y:this.b*x+this.d*y+this.f}}metric(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y,y:this.b*x+this.d*y}}pointFrom(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:((x-=this.e)*d-(y-=this.f)*c)*t,y:(y*a-x*b)*t}}metricFrom(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:(x*d-y*c)*t,y:(y*a-x*b)*t}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;if(t)for(const{x:x,y:y}of t)g.push(a*x+c*y+e,b*x+d*y+f);else{const t=e+a,s=f+b;g.push(e,f,t,s,t+c,s+d,e+c,f+d)}return _loopBoundary2()}}class R{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i}sub(){return new R(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}subPersp(t=1){return new R(this.a,this.b,this.c,this.d,this.e,this.f,this.g*t,this.h*t,this.i*t)}sub3d(){return new E(this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}sub3dPersp(t=0,s=1){return new E(this.a,this.b,this.c,this.d,this.e,this.f,this.g*s,this.h*s,this.i*s,this.g*t,this.h*t,this.i*t)}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i}project(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);let t=this.c*x+this.f*y+this.i;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g)*t,y:(this.b*x+this.e*y+this.h)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);let u=(n*x+(c*d-a*f)*y+(a*e-b*d))*o;return u<=0?{x:NaN,y:NaN}:(u=1/u,{x:(s*x+(f*t-d*i)*y+(d*h-e*t))*o*u,y:(r*x+(a*i-c*t)*y+(b*t-a*h))*o*u})}translate(x=0,y=0){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*n-d*o,this.b=b*n-e*o,this.c=c*n-f*o,this.d=a*o+d*n,this.e=b*o+e*n,this.f=c*o+f*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d,o=this.e,u=this.f;this.a=t*a+n*b,this.b=s*a+o*b,this.c=r*a+u*b,this.d=t*c+n*d,this.e=s*c+o*d,this.f=r*c+u*d,this.g+=t*e+n*f,this.h+=s*e+o*f,this.i+=r*e+u*f}transformInverse(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=1/(a*d-b*c),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;this.a=(s*d-o*b)*t,this.b=(r*d-u*b)*t,this.c=(n*d-p*b)*t,this.d=(o*a-s*c)*t,this.e=(u*a-r*c)*t,this.f=(p*a-n*c)*t;const m=(c*f-d*e)*t,v=(b*e-a*f)*t;this.g+=s*m+o*v,this.h+=r*m+u*v,this.i+=n*m+p*v}skew(x=0,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a+d*y,this.b=b+e*y,this.c=c+f*y,this.d=d+a*x,this.e=e+b*x,this.f=f+c*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*x-d*y,this.b=b*x-e*y,this.c=c*x-f*y,this.d=a*y+d*x,this.e=b*y+e*x,this.f=c*y+f*x}box(x=0,y=0,w=1,h=w){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h}point(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.d*y+this.g,y:this.b*x+this.e*y+this.h,z:this.c*x+this.f*y+this.i}}metric(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.d*y,y:this.b*x+this.e*y,z:this.c*x+this.f*y}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h,i:i}=this;if(t)for(const{x:x,y:y}of t)g.push(a*x+d*y+s,b*x+e*y+h,1/(c*x+f*y+i));else{const t=s+a,r=h+b,n=i+c;g.push(s,h,1/i,t,r,1/n,t+d,r+e,1/(n+f),s+d,h+e,1/(i+f))}return _loopBoundary3()}}class G{constructor(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h}sub(){return new G(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}subPersp(t=0,s=1){return new E(this.a,this.b,0,this.c,this.d,0,this.g*s+this.e,this.h*s+this.f,s,this.g*t,this.h*t,t)}sub2dXY(){return new A(this.a,this.b,this.c,this.d,this.g,this.h)}sub2dZY(){return new A(this.e,this.f,this.c,this.d,this.g,this.h)}sub2dXZ(){return new A(this.a,this.b,this.e,this.f,this.g,this.h)}reset(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h}project(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z+this.j)*t,y:(this.b*x+this.e*y+this.h*z+this.k)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;x-=this.j,y-=this.k;const z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}perspectiveOrigin(){return{x:NaN,y:NaN,z:NaN}}perspectiveRay(t=0,s=0,r=null){return{x:NaN,y:NaN,z:NaN}}translate(x=0,y=0,z=0){this.g+=x*this.a+y*this.c+z*this.e,this.h+=x*this.b+y*this.d+z*this.f}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y,this.e*=z,this.f*=z}rotateXZ(t){let n=r(t),o=s(t);const{a:a,b:b,e:e,f:f}=this;this.a=o*a-n*e,this.e=o*e+n*a,this.b=o*b-n*f,this.f=o*f+n*b}rotateXY(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,d:d}=this;this.a=o*a-n*c,this.c=o*c+n*a,this.b=o*b-n*d,this.d=o*d+n*b}rotateZY(t){let n=r(t),o=s(t);const{c:c,d:d,e:e,f:f}=this;this.e=o*e-n*c,this.c=o*c+n*e,this.f=o*f-n*d,this.d=o*d+n*f}multiplyXZ(x=1,y=0){const{a:a,b:b,e:e,f:f}=this;this.a=x*a-y*e,this.e=x*e+y*a,this.b=x*b-y*f,this.f=x*f+y*b}multiplyXY(x=1,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=x*a-y*c,this.c=x*c+y*a,this.b=x*b-y*d,this.d=x*d+y*b}multiplyZY(x=1,y=0){const{c:c,d:d,e:e,f:f}=this;this.e=x*e-y*c,this.c=x*c+y*e,this.f=x*f-y*d,this.d=x*d+y*f}skewX(t=0,s=0){this.a+=s*this.c+t*this.e,this.b+=s*this.d+t*this.f}skewY(t=0,s=0){this.c+=t*this.a+s*this.e,this.d+=t*this.b+s*this.f}skewZ(t=0,s=0){this.e+=t*this.a+s*this.c,this.f+=t*this.b+s*this.d}skew(t=0,s=0,r=0,n=0,o=0,u=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a+s*c+t*e,this.b=b+s*d+t*f,this.c=c+r*a+n*e,this.d=d+r*b+n*f,this.e=e+o*a+u*c,this.f=f+o*b+u*d}transform(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=this.a,o=this.b,u=this.c,p=this.d,m=this.e,v=this.f;this.a=n*a+u*b+m*c,this.b=o*a+p*b+v*c,this.c=n*d+u*e+m*f,this.d=o*d+p*e+v*f,this.e=n*t+u*h+m*i,this.f=o*t+p*h+v*i,this.g+=n*s+u*r+m*l,this.h+=o*s+p*r+v*l}transformInverse(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=1/(a*(e*i-f*h)+d*(c*h-b*i)+t*(b*f-c*e)),o=(e*i-f*h)*n,u=(c*h-b*i)*n,p=(b*f-c*e)*n,m=(f*t-d*i)*n,v=(a*i-c*t)*n,g=(c*d-a*f)*n,A=(d*h-e*t)*n,R=(b*t-a*h)*n,G=(a*e-b*d)*n,E=-(ia*s+id_*r+ig*l),T=-(ib*s+ie*r+ih*l),L=-(ic*s+if_*r+ii*l);return this.transform(o,u,p,m,v,g,A,R,G,E,T,L)}box(x=0,y=0,z=0,w=1,h=w,d=w){this.g+=x*this.a+y*this.c+z*this.e,this.h+=x*this.b+y*this.d+z*this.f,this.a*=w,this.b*=w,this.c*=h,this.d*=h,this.e*=d,this.f*=d}point(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.c*y+this.e*z+this.g,y:this.b*x+this.d*y+this.f*z+this.h}}metric(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.c*y+this.e*z,y:this.b*x+this.d*y+this.f*z}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h}=this;for(const{x:x,y:y,z:z}of t)g.push(a*x+c*y+e*z+s,b*x+d*y+f*z+h);return _loopBoundary2()}}class E{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l}sub(){return new E(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}subPersp(t=0,s=1){return new E(this.a,this.b,this.c,this.d,this.e,this.f,this.j*s+this.g,this.k*s+this.h,this.l*s+this.i,this.j*t,this.k*t,this.l*t)}sub2dXY(){return new R(this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dZY(){return new R(this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(){return new R(this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l}project(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z+this.j)*t,y:(this.b*x+this.e*y+this.h*z+this.k)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;x-=this.j,y-=this.k;const z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}perspectiveOrigin(){const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=this,n=e*i-f*h,o=c*h-b*i,u=b*f-c*e,p=-1/(a*n+d*o+t*u);return{x:(n*s+(t*f-i*d)*r+(d*h-e*t)*l)*p,y:(o*s+(a*i-c*t)*r+(t*b-h*a)*l)*p,z:(u*s+(d*c-f*a)*r+(a*e-b*d)*l)*p}}perspectiveRay(x=0,y=0,t=null){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h,i:i,j:r,k:n,l:l}=this,o=e*i-f*h,u=c*h-b*i,p=b*f-c*e,m=1/(a*o+d*u+s*p),v=s*f-i*d,g=a*i-c*s,A=d*c-f*a,R=d*h-e*s,G=s*b-h*a,E=a*e-b*d;t&&(t.x=-(o*r+v*n+R*l)*m,t.y=-(u*r+g*n+G*l)*m,t.z=-(p*r+A*n+E*l)*m);const z=1-this.l,T=(o*x+v*y+R*z)*m,L=(o*x+v*y+R*z)*m,B=(o*x+v*y+R*z)*m,N=1/sqrt(T*T+L*L+B*B);return{x:T*N,y:L*N,z:B*N}}translate(x=0,y=0,z=0){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y,this.g*=z,this.h*=z,this.i*=z}rotateXZ(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,g:u,h:h,i:i}=this;this.a=o*a-n*u,this.g=o*u+n*a,this.b=o*b-n*h,this.h=o*h+n*b,this.c=o*c-n*i,this.i=o*i+n*c}rotateXY(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=o*a-n*d,this.d=o*d+n*a,this.b=o*b-n*e,this.e=o*e+n*b,this.c=o*c-n*f,this.f=o*f+n*c}rotateZY(t){let n=r(t),o=s(t);const{d:d,e:e,f:f,g:u,h:h,i:i}=this;this.g=o*u-n*d,this.d=o*d+n*u,this.h=o*h-n*e,this.e=o*e+n*h,this.i=o*i-n*f,this.f=o*f+n*i}multiplyXZ(x=1,y=0){const{a:a,b:b,c:c,g:t,h:h,i:i}=this;this.a=x*a-y*t,this.g=x*t+y*a,this.b=x*b-y*h,this.h=x*h+y*b,this.c=x*c-y*i,this.i=x*i+y*c}multiplyXY(x=1,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=x*a-y*d,this.d=x*d+y*a,this.b=x*b-y*e,this.e=x*e+y*b,this.c=x*c-y*f,this.f=x*f+y*c}multiplyZY(x=1,y=0){const{d:d,e:e,f:f,g:t,h:h,i:i}=this;this.g=x*t-y*d,this.d=x*d+y*t,this.h=x*h-y*e,this.e=x*e+y*h,this.i=x*i-y*f,this.f=x*f+y*i}skewX(t=0,s=0){this.a+=s*this.d+t*this.g,this.b+=s*this.e+t*this.h,this.c+=s*this.f+t*this.i}skewY(t=0,s=0){this.d+=t*this.a+s*this.g,this.e+=t*this.b+s*this.h,this.f+=t*this.c+s*this.i}skewZ(t=0,s=0){this.g+=t*this.a+s*this.d,this.h+=t*this.b+s*this.e,this.i+=t*this.c+s*this.f}skew(t=0,s=0,r=0,n=0,o=0,u=0){const{a:a,b:b,c:c,d:d,e:e,f:f,g:p,h:h,i:i}=this;this.a=a+s*d+t*p,this.b=b+s*e+t*h,this.c=c+s*f+t*i,this.d=d+r*a+n*p,this.e=e+r*b+n*h,this.f=f+r*c+n*i,this.g=p+o*a+u*d,this.h=h+o*b+u*e,this.i=i+o*c+u*f}transform(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=this.a,o=this.b,u=this.c,p=this.d,m=this.e,v=this.f,g=this.g,A=this.h,R=this.i;this.a=n*a+p*b+g*c,this.b=o*a+m*b+A*c,this.c=u*a+v*b+R*c,this.d=n*d+p*e+g*f,this.e=o*d+m*e+A*f,this.f=u*d+v*e+R*f,this.g=n*t+p*h+g*i,this.h=o*t+m*h+A*i,this.i=u*t+v*h+R*i,this.j+=n*s+p*r+g*l,this.k+=o*s+m*r+A*l,this.l+=u*s+v*r+R*l}transformInverse(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=1/(a*(e*i-f*h)+d*(c*h-b*i)+t*(b*f-c*e)),o=(e*i-f*h)*n,u=(c*h-b*i)*n,p=(b*f-c*e)*n,m=(f*t-d*i)*n,v=(a*i-c*t)*n,g=(c*d-a*f)*n,A=(d*h-e*t)*n,R=(b*t-a*h)*n,G=(a*e-b*d)*n,E=-(o*s+m*r+A*l),T=-(u*s+v*r+R*l),L=-(p*s+g*r+G*l);return this.transform(o,u,p,m,v,g,A,R,G,E,T,L)}box(x=0,y=0,z=0,w=1,h=w,d=w){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h,this.g*=d,this.h*=d,this.i*=d}point(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.d*y+this.g*z+this.j,y:this.b*x+this.e*y+this.h*z+this.k,z:this.c*x+this.f*y+this.i*z+this.l}}metric(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.d*y+this.g*z,y:this.b*x+this.e*y+this.h*z,z:this.c*x+this.f*y+this.i*z}}pointFrom(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*(x-=this.j)+(f*t-d*i)*(y-=this.k)+(d*h-e*t)*(z-=this.l))*o,y:(r*x+(a*i-c*t)*y+(b*t-a*h)*z)*o,z:(n*x+(c*d-a*f)*y+(a*e-b*d)*z)*o}}metricFrom(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(f*t-d*i)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(b*t-a*h)*z)*o,z:(n*x+(c*d-a*f)*y+(a*e-b*d)*z)*o}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h,i:i,j:r,k:n,l:l}=this;for(const{x:x,y:y,z:z}of t)g.push(a*x+d*y+s*z+r,b*x+e*y+h*z+n,1/(c*x+f*y+i*z+l));return _loopBoundary3()}}$.Transform2D=A,$.Transform2D.to3D=R,$.Transform3D=E,$.Transform3D.to2D=G,$.Gamma=(s=document.createElement("canvas"),$={},r=15)=>{$.flags=r;const _=$.gl=($.canvas=s).getContext("webgl2",{preserveDrawingBuffer:!(8&r),antialias:16&r,depth:!1,premultipliedAlpha:4&r,stencil:1&r,alpha:2&r});_.pixelStorei(37440,1),_.stencilMask(1),_.clearStencil(0),_.pixelStorei(3317,1),_.pixelStorei(3333,1);const p=_.getExtension("EXT_clip_control");p?.clipControlEXT(36001,37727);const g=_.createBuffer();_.bindBuffer(35052,g);let T=!0,L=null,B=-1,N=!1,F=302024719,$s=null,$v=null,j=0,I=0,$u=0,S=null,$X=0,$x=0,P=5,O=0,C=4,$p=null,U=0;_.bindFramebuffer(36008,_.createFramebuffer());const D=_.createFramebuffer(),$M=_.createBuffer();_.bindBuffer(34962,$M);const M=o(32,_.getParameter(34930)),k=[];for(let i=M<<1;i-- >0;)k.push(null);Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NEVER:48,UNSET:64,SET:128,FLIP:192,IF_CLOSER:512,IF_FURTHER:1024,DEPTH_NEVER:1536,DEPTH:256,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:104,RGB_DST:8,ONE_MINUS_DST:121,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,ADD:9,RGB_ADD:1,A_ADD:8,SUB:45,RGB_SUB:5,A_SUB:40,SUB_REV:54,RGB_SUB_REV:6,A_SUB_REV:48,MIN:18,RGB_MIN:2,A_MIN:16,MAX:27,RGB_MAX:3,A_MAX:24,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:28,FTEXTURE:29,ITEXTURE:30,UTEXTURE:31,COLOR:12,FCOLOR:13,ICOLOR:14,UCOLOR:15,FLAT:64,CW_ONLY:16,CCW_ONLY:32,ANISOTROPY:128,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0}),$.Formats={R:[33321,6403,5121,0],RG:[33323,33319,5121,0],RGB:[32849,6407,5121,0],RGBA:[32856,6408,5121,0],RGB565:[36194,6407,33635,0],R11F_G11F_B10F:[35898,6407,35899,0],RGB5_A1:[32855,6408,32820,0],RGB10_A2:[32857,6408,33640,0],RGBA4:[32854,6408,32819,0],RGB9_E5:[35901,6407,35902,0],R8:[33330,36244,5121,-2147447584],RG8:[33336,33320,5121,-2147447584],RGB8:[36221,36248,5121,-2147447584],RGBA8:[36220,36249,5121,-2147447584],R16:[33332,36244,5123,-2147447584],RG16:[33338,33320,5123,-2147447584],RGB16:[36215,36248,5123,-2147447584],RGBA16:[36214,36249,5123,-2147447584],R32:[33334,36244,5125,-2147447584],RG32:[33340,33320,5125,-2147447584],RGB32:[36209,36248,5125,-2147447584],RGBA32:[36208,36249,5125,-2147447584],R16F:[33325,6403,5131,0],RG16F:[33327,33319,5131,0],RGB16F:[34843,6407,5131,0],RGBA16F:[34842,6408,5131,0],R16F_32F:[33325,6403,5126,0],RG16F_32F:[33327,33319,5126,0],RGB16F_32F:[34843,6407,5126,0],RGBA16F_32F:[34842,6408,5126,0],R32F:[33326,6403,5126,0],RG32F:[33328,33319,5126,0],RGB32F:[34837,6407,5126,0],RGBA32F:[34836,6408,5126,0],DEPTH32F:[36012,6402,5126,101632],DEPTH32F_STENCIL:[36013,6402,5126,360986],STENCIL:[36168,0,0,298272]},$.vec2=(x=0,y=x)=>({x:x,y:y}),$.vec2.one=$.vec2(1);const X=$.vec2.zero=$.vec2(0);$.vec2.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b}:{x:a.x+b.x,y:a.y+b.y},$.vec2.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y}:{x:a.x-b.x,y:a.y-b.y},$.vec2.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b}:{x:a.x*b.x,y:a.y*b.y},$.vec2.magnitude=a=>sqrt(a.x*a.x+a.y*a.y),$.vec2.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y);return{x:a.x*d,y:a.y*d}},$.vec3=(x=0,y=x,z=x)=>({x:x,y:y,z:z}),$.vec3.one=$.vec3(1);const Y=$.vec3.zero=$.vec3(0);$.vec3.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z},$.vec3.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y,z:a-b.z}:{x:a.x-b.x,y:a.y-b.y,z:a.z-b.z},$.vec3.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z},$.vec3.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z),$.vec3.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z);return{x:a.x*d,y:a.y*d,z:a.z*d}},$.vec4=(x=0,y=x,z=x,w=x)=>({x:x,y:y,z:z,w:w}),$.vec4.one=$.vec4(1);const V=$.vec4.zero=$.vec4(0);$.vec4.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b,w:a.w+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z,w:a.w+b.w},$.vec4.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y,z:a-b.z,w:a-b.w}:{x:a.x-b.x,y:a.y-b.y,z:a.z-b.z,w:a.w-b.w},$.vec4.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b,w:a.w*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z,w:a.w*b.w},$.vec4.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w),$.vec4.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w);return{x:a.x*d,y:a.y*d,z:a.z*d,w:a.w*d}};const Z=_.getExtension("EXT_texture_filter_anisotropic")?_.getParameter(34047):0;class $m{get isInteger(){return this.t.f[3]<0}get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get mipmaps(){return this.t.m}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get identity(){return this.t}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,x=0,y=0,w=1,h=1,l=0){this.t=t,this.x=x,this.y=y,this.w=w,this.h=h,this.l=l}get loaded(){return!this.t.src}get usable(){return!this.t.src||(this.t.u||$m.load(this.t),!1)}get then(){return this.t.src?this.#t:null}load(){this.t.u||$m.load(this.t)}sub(x=0,y=0,w=1,h=1,l=this.l){return new $m(this.t,this.x+x*this.w,this.y+y*this.h,this.w*w,this.h*h,l)}super(x=0,y=0,w=1,h=1,l=this.l){const t=this.w/w,s=this.h/h;return new $m(this.t,this.x-x*t,this.y-y*s,t,s,l)}crop(x=0,y=0,w=0,h=0,l=this.l){const{t:t,x:s,y:r,h:n}=this;if(!t.src)return new $m(t,s+x/t.w,r+n-(y+h)/t.h,w/t.w,h/t.h,l);const i=new $m(t,0,0,0,0,l);return t.u||$m.load(t),t.src.push(i=>{i.x=s+x/t.w,i.y=r+n-(y+h)/t.h,i.w=w/t.w,i.h=h/t.h},void 0,i),i}layer(l=this.l){return new $m(this.t,this.x,this.y,this.w,this.h,l)}#t(t,s){"function"!=typeof t&&(t=Function.prototype),this.t.src?(this.t.u||$m.load(this.t),this.t.src.push(t,s,this)):t(this)}static load(t){let s=t.src,r=0;t.src=[];let w=0,h=0;if(t.u=_.createTexture(),262144&t.f[3]){const a=[];for(let i=t.d*t.mips;i>0;i--)a.push({s:0});t.u.s=a}const n=()=>{r=-1,$m.setOptions(t),_.texStorage3D(35866,t.m=1,t.f[0],t.w=w=1,t.h=h=1,t.d),T||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),T=!0),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const s=t.src;t.src=null;for(let i=1;i<s.length;i+=3)s[i]?.(s[i+1])};for(let i=0;i<s.length;i++)v(s[i],u=>{if(r){if(w!=u.width||h!=u.height)return n()}else w=u.width,h=u.height;if(s[i]=u,++r<s.length)return;$m.setOptions(t),_.texStorage3D(35866,t.m=o(t.m,floor(log2(max(w,h)))+1),t.f[0],t.w=w,t.h=h,t.d),T||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),T=!0),_.bindBuffer(35052,null);for(let l=0;l<r;l++)_.texSubImage3D(35866,0,0,0,l,w,h,1,t.f[1],t.f[2],s[l]);_.bindBuffer(35052,g),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const p=t.src;t.src=null;for(let i=0;i<p.length;i+=3)p[i](p[i+2])},n)}paste(t,x=0,y=0,l=0,s=0,r=0,n=0,o=0,u=0,p=0,A=0,R=0){const{t:G}=this;if(G.src)return null;const E=G.f[3]||4230368;if(t.msaa){const m=t.f[3]||4230368,v=(E&m)>>16;return i&&draw(),p=u||t.height,u=o||t.width,S!=D&&(_.bindFramebuffer(36009,S=D),curt=ht=null),64&v?15&~F&&(_.colorMask(1,1,1,1),F|=15,ht=null):1&v&&256&~F&&(_.depthMask(1),F|=256,ht=null),_.framebufferRenderbuffer(36008,65535&m,36161,t.u),298272==E?_.framebufferRenderbuffer(36009,36128,36161,G.u[s+l++*G.m]):_.framebufferTextureLayer(36009,65535&E,G.u,s,l),_.blitFramebuffer(r,n,r+u,n+p,x,y,x+u,y+p,v<<8,9728),_.framebufferRenderbuffer(36009,65535&E,36161,null),_.framebufferRenderbuffer(36008,65535&m,36161,null),this}if(298272==E){i&&draw();const{t:v}=t,g=v.f[3];if(!(262144&g))return this;for(S!=D&&(_.bindFramebuffer(36009,S=D),curt=ht=null),64&m?15&~F&&(_.colorMask(1,1,1,1),F|=15,ht=null):1&m&&256&~F&&(_.depthMask(1),F|=256,ht=null);A--;)36128==(65535&g)?_.framebufferRenderbuffer(36008,36128,36161,v.u[R+o++*v.m]):_.framebufferTextureLayer(36009,65535&g,t.u,R,o++),_.framebufferRenderbuffer(36009,36128,36161,G.u[s+l++*G.m]),_.blitFramebuffer(r,n,r+u,n+p,x,y,x+u,y+p,m<<8,9728);return _.framebufferRenderbuffer(36009,36128,36161,null),_.framebufferRenderbuffer(36008,65535&g,36161,null),this}if(!(t instanceof $m))return v(t,i=>($m.fakeBind(G),T||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),T=!0),_.bindBuffer(35052,null),_.texSubImage3D(35866,s,x,y,l,i.width,i.height,1,G.f[1],G.f[2],i),_.bindBuffer(35052,g),G.i<0&&_.bindTexture(35866,null),this));const{t:L}=t;if(L.f[3]!=E||L.src||G.u==L.u)return this;for($m.fakeBind(G),u=u||L.w,p=p||L.h,A=A||L.d;A--;)_.framebufferTextureLayer(36008,36064,L.u,R,o++),_.copyTexSubImage3D(35866,s,x,y,l++,r,n,u,p);return _.framebufferRenderbuffer(36008,65535&E,36161,null),G.i<0&&_.bindTexture(35866,null),this}pasteData(t,x=0,y=0,l=0,w=0,h=0,d=0,s=0){const{t:r}=this;return null!==r.src||(w=w||r.w,h=h||r.h,d=d||r.d,$m.fakeBind(r),T&&(_.pixelStorei(37440,0),_.pixelStorei(37441,0),T=!1),_.bufferData(35052,t,35042),_.texSubImage3D(35866,s,x,y,l,w,h,d,r.f[1],r.f[2],0),wt+=.25*t.byteLength,r.i<0&&_.bindTexture(35866,null)),this}readData(x=0,y=0,l=0,w=0,h=0,d=0,t=0){const{t:s}=this;return null!==s.src?null:(w=w||s.w,h=h||s.h,d=d||s.d,W(s.f,(r,n,o)=>{let i=0;for(;d--;)_.framebufferTextureLayer(36008,r,s.u,t,l++),_.readPixels(x,y,w,h,n,o,sz*a*i++)}))}delete(){const{t:t}=this;if(t.u){if(Array.isArray(t.u))for(const s of t.u)_.deleteRenderbuffer(s);else _.deleteTexture(t.u);t.u=null,t.d=t.w=t.h=0,t.i>=0&&(k[t.i]=null,t.i=-1)}}static auto(s,i=0){if(s.f[3]>>31!==i)return-2;if(s.i>=0){const t=-2147483648>>>s.i-(M-j&i);if(!(t&(i^I)))return $X|=t,s.i;k[s.i]=null,s.i=-1}s.u||$m.load(s);const r=t(~($X|i^I));if(r>=M)return-1;$X|=-2147483648>>>r;const n=k[i=i?M+r-j:r];return n&&(n.i=-1),_.activeTexture(33984+i),_.bindTexture(35866,(k[i]=s).u),s.i=i}static fakeBind(t){if(t.i>=0)i&&draw(),_.activeTexture(33984+t.i);else{const s=M-1+(j==M&&M);k[s]&&(k[s].t.i=-1),_.activeTexture(33984+s),_.bindTexture(35866,t.u)}}get options(){return this.t.o}static setOptions(t){$m.fakeBind(t);const{o:s}=t;Z&&_.texParameterf(35866,34046,128&s?Z:1),t.f[3]?(_.texParameterf(35866,10240,9728),_.texParameterf(35866,10241,9728)):(_.texParameterf(35866,10240,9728+(1&s)),_.texParameterf(35866,10241,t.m>1?9984+(s>>1&3):9728+(s>>1&1))),_.texParameterf(35866,10242,8&s?10497:16&s?33648:33071),_.texParameterf(35866,10243,32&s?10497:64&s?33648:33071)}set options(t){const{t:s}=this;s.o=t,null===s.src&&($m.setOptions(s),s.i<0&&_.bindTexture(35866,null))}setMipmapRange(t=0,e=65535){const{t:s}=this;null===s.src&&($m.fakeBind(s),_.texParameteri(35866,33082,t),_.texParameteri(35866,33083,e),s.i<0&&_.bindTexture(35866,null))}genMipmaps(){i&&draw();const{t:t}=this;null!==t.src||t.f[3]||($m.fakeBind(t),_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null))}}$m.prototype.msaa=0,$.Drawable=()=>new K({s:null,p:_.createFramebuffer(),w:0,h:0,m:0,t:[]}),$.Drawable.MAX_TARGETS=_.getParameter(36063),$.Drawable.DRAW_16F=!!_.getExtension("EXT_color_buffer_half_float"),$.Drawable.DRAW_32F=!!_.getExtension("EXT_color_buffer_float"),$.Drawable.BLEND_32F=$.Drawable.DRAW_32F&&!!_.getExtension("EXT_float_blend");let $i=new Float32Array(1024),$I=new Int32Array($i.buffer),i=0;$.Texture=(w=0,h=0,d=1,t=0,f=Formats.RGBA,s=0)=>{if(s=o(s>>>0||1,floor(log2(max(w,h)))+1),w=w>>>0||1,h=h>>>0||1,d=d>>>0||1,298272===f[3]){const r=[];for(let i=d;i>=0;i--){let t=w,s=h;for(;;){const n=_.createRenderbuffer();if(n.s=0,_.bindRenderbuffer(36161,n),r.push(n),_.renderbufferStorage(36161,f[0],t,s),t+s==2)break;t=t+1>>>1,s=s+1>>>1}}return new $m({u:r,i:-1,o:t,f:f,src:void 0,w:w,h:h,d:d,m:s})}{const r={u:_.createTexture(),i:-1,o:t,f:f,src:null,w:w,h:h,d:d,m:s};if(262144&f[3]){const a=[];for(let i=d*s;i>0;i--)a.push({s:0});r.u.s=a}return $m.setOptions(r),_.texStorage3D(35866,s,r.f[0],w,h,d),_.bindTexture(35866,null),new $m(r)}},$.Texture.MAX_WIDTH=$.Texture.MAX_HEIGHT=_.getParameter(3379),$.Texture.MAX_LAYERS=_.getParameter(35071),$.Texture.FILTER_32F=!!_.getExtension("OES_texture_float_linear"),$.Texture.ANISOTROPY=Z;const H=$.Texture.MAX_MSAA=_.getParameter(36183);function q(){_.deleteRenderbuffer(this.u)}const W=(f,t)=>{i&&draw();let a=f[0],s=33323==a||33338==a||33340==a||33327==a||33328==a||33336==a?2:33321==a||33330==a||33332==a||33334==a||33325==a||33326==a?1:4,r=s<=2?1==s?6403:33319:3==s?6407:6408;36012!=a&&36013!=a||(s=1,r=6402),a=f[2]==5121?1:f[2]==5126||f[2]==5125||f[2]==35899||f[2]==33640||f[2]==35902?4:2,s*=w*h;let n,o=65535&f[3]||36064;return B==s*a?(n=L,B=-1,N=!0):(_.bindBuffer(35051,n=_.createBuffer()),_.bufferData(35051,s*a,35041),s*a>B&&(B=s*a,L=n,N=!0)),t(o,r,f[2]),_.framebufferRenderbuffer(36008,o,36161,null),n!=L&&_.bindBuffer(35051,L),new Promise(t=>{const o=()=>{const $i=1==a?new Uint8Array(s):4==a?f[2]==5126?new Float32Array(s):new Uint32Array(s):new Uint16Array(s);if(n!=L&&_.bindBuffer(35051,n),_.getBufferSubData(35051,0,$i),r==6402)for(let i=$i.length;i--;)$i[i]=1e-19/$i[i];t($i),n!=L&&(s*a>B?(B=s*a,L=n):_.bindBuffer(35051,L)),N=!0};o.sync=_.fenceSync(37143,0),At??=o,Rt=Rt?Rt.next=o:o,Et||(Et=setInterval(gt,0))})};function J(x=0,y=0,w=0,h=0){return W(this.f,(t,s,r)=>{w=w||this.width,h=h||this.height,_.framebufferRenderbuffer(36008,t,36161,this.u),_.readPixels(x,y,w,h,s,r,0)})}$.Texture.Surface=(w=0,h=0,t=0,f=Formats.RGBA)=>{t=o(t>>>0,H)||1;const s=_.createRenderbuffer();return 262144&f[3]&&(s.s=0),_.bindRenderbuffer(36161,s),t>1?_.renderbufferStorageMultisample(36161,t,f[0],w,h):_.renderbufferStorage(36161,f[0],w,h),{u:s,width:w,height:h,msaa:t>1?_.getRenderbufferParameter(36161,36011):1,format:f,f:f,delete:q,readData:J}},$.Texture.from=(t,s=0,r=Formats.RGBA,n=0)=>new $m({u:null,i:-1,o:s,f:r,src:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:t?Array.isArray(t)?t.length:1:0,m:n||1});const $G=ArrayBuffer.prototype.transfer?t=>{const s=i;return(i=s+t)>$I.length&&($I=new Int32Array($I.buffer.transfer(8*i)),$i=new Float32Array($I.buffer)),s}:t=>{const s=i;if((i=s+t)>$I.length){const t=$I;($I=new Int32Array(2*i)).set(t,0),$i=new Float32Array($I.buffer)}return s};class K extends A{set shader($s){this.$="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,ht==this&&(ht=null)}get shader(){return this.$}get geometry(){return this.S}set geometry(a){this.S=a||pt,ht==this&&(ht=null)}constructor(t,s=324306959,r=pt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.M=s,this.S=r,this.$=n}getTransform(){return new A(this.a,this.b,this.c,this.d,this.e,this.f)}sub(){return new K(this.t,this.M,this.S,this.$,this.a,this.b,this.c,this.d,this.e,this.f)}subPersp(){return new Q(this.t,this.M,this.S,this.$,this.a,this.b,this.c,this.d,this.e,this.f,0,0,1)}sub3d(){return new tt(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,0,0,this.e,this.f)}sub3dPersp(t=0,s=1){return new st(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,0,this.c,this.d,0,this.e*s,this.f*s,s,this.e*t,this.f*t,t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.M=t.M,this.$=t.$,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.M=324306959,this.$=$.Shader.DEFAULT,this.S=pt}pixelRatio(){return sqrt(abs(this.a*this.d-this.b*this.c)*this.t.w*this.t.h)}draw(...t){const i=this.$(6,t);$i[i]=this.e,$i[i+1]=this.a,$i[i+2]=this.c,$i[i+3]=this.f,$i[i+4]=this.b,$i[i+5]=this.d}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.$(6,t);$i[i]=this.e+x*this.a+y*this.c,$i[i+1]=this.a*w,$i[i+2]=this.c*h,$i[i+3]=this.f+x*this.b+y*this.d,$i[i+4]=this.b*w,$i[i+5]=this.d*h}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.$(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*e+n*f+u,$i[i+1]=s*a+n*b,$i[i+2]=s*c+n*d,$i[i+3]=r*e+o*f+p,$i[i+4]=r*a+o*b,$i[i+5]=r*c+o*d}drawv(t){const i=this.$(6,t);$i[i]=this.e,$i[i+1]=this.a,$i[i+2]=this.c,$i[i+3]=this.f,$i[i+4]=this.b,$i[i+5]=this.d}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.$(6,t);$i[i]=this.e+x*this.a+y*this.c,$i[i+1]=this.a*w,$i[i+2]=this.c*h,$i[i+3]=this.f+x*this.b+y*this.d,$i[i+4]=this.b*w,$i[i+5]=this.d*h}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.$(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*e+n*f+u,$i[i+1]=s*a+n*b,$i[i+2]=s*c+n*d,$i[i+3]=r*e+o*f+p,$i[i+4]=r*a+o*b,$i[i+5]=r*c+o*d}}class Q extends R{set shader($s){this.$="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,ht==this&&(ht=null)}get shader(){return this.$}get geometry(){return this.S}set geometry(a){this.S=a||pt,ht==this&&(ht=null)}constructor(t,s=324306959,r=pt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=0){super(a,b,c,d,e,f,o,h,i),this.t=t,this.M=s,this.S=r,this.$=n}getTransform(){return new R(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}sub(){return new Q(this.t,this.M,this.S,this.$,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}subPersp(){return this.sub()}sub3d(){return new st(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}sub3dPersp(t=0,s=1){return new st(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,this.g*s,this.h*s,this.i*s,this.g*t,this.h*t,this.i*t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.M=t.M,this.$=t.$,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.M=324306959,this.$=$.Shader.DEFAULT,this.S=pt}pixelRatio(){const{i:i}=this,t=(this.a*i-this.g*this.c)*(this.e*i-this.h*this.f)-(this.d*i-this.g*this.f)*(this.b*i-this.h*this.c);return sqrt(abs(t)*this.t.w*this.t.h)/(i*i)}draw(...t){const i=this.$(9,t);$i[i]=this.g,$i[i+1]=this.a,$i[i+2]=this.d,$i[i+3]=this.h,$i[i+4]=this.b,$i[i+5]=this.e,$i[i+6]=this.i,$i[i+7]=this.c,$i[i+8]=this.f}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.$(9,t);$i[i]=this.g+x*this.a+y*this.d,$i[i+1]=this.a*w,$i[i+2]=this.d*h,$i[i+3]=this.h+x*this.b+y*this.e,$i[i+4]=this.b*w,$i[i+5]=this.e*h,$i[i+6]=this.i+x*this.c+y*this.f,$i[i+7]=this.c*w,$i[i+8]=this.f*h}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.$(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,m=this.g,v=this.h,g=this.i;$i[i]=s*e+o*f+m,$i[i+1]=s*a+o*b,$i[i+2]=s*c+o*d,$i[i+3]=r*e+u*f+v,$i[i+4]=r*a+u*b,$i[i+5]=r*c+u*d,$i[i+6]=n*e+p*f+g,$i[i+7]=n*a+p*b,$i[i+8]=n*c+p*d}drawv(t){const i=this.$(9,t);$i[i]=this.g,$i[i+1]=this.a,$i[i+2]=this.d,$i[i+3]=this.h,$i[i+4]=this.b,$i[i+5]=this.e,$i[i+6]=this.i,$i[i+7]=this.c,$i[i+8]=this.f}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.$(9,t);$i[i]=this.g+x*this.a+y*this.d,$i[i+1]=this.a*w,$i[i+2]=this.d*h,$i[i+3]=this.h+x*this.b+y*this.e,$i[i+4]=this.b*w,$i[i+5]=this.e*h,$i[i+6]=this.i+x*this.c+y*this.f,$i[i+7]=this.c*w,$i[i+8]=this.f*h}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.$(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,m=this.g,v=this.h,g=this.i;$i[i]=s*e+o*f+m,$i[i+1]=s*a+o*b,$i[i+2]=s*c+o*d,$i[i+3]=r*e+u*f+v,$i[i+4]=r*a+u*b,$i[i+5]=r*c+u*d,$i[i+6]=n*e+p*f+g,$i[i+7]=n*a+p*b,$i[i+8]=n*c+p*d}}class tt extends G{set shader($s){this.$="function"==typeof $s&&!0===$s.three?$s:$.Shader.COLOR_3D_XZ,ht==this&&(ht=null)}get shader(){return this.$}get geometry(){return this.S}set geometry(a){this.S=a||bt,ht==this&&(ht=null)}constructor(t,s=324306959,r=bt,n=$.Shader.COLOR_3D_XZ,a=1,b=0,c=0,d=1,e=0,f=0,o=0,h=0){super(a,b,c,d,e,f,o,h),this.t=t,this.M=s,this.S=r,this.$=n}getTransform(){return new G(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}sub(){return new tt(this.t,this.M,this.S,this.$,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}subPersp(t=0,s=1){return new st(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,0,this.c,this.d,0,this.g*s+this.e,this.h*s+this.f,s,this.g*t,this.h*t,t)}sub2dXY(){return new K(this.t,this.M,pt,$.Shader.DEFAULT,this.a,this.b,this.c,this.d,this.g,this.h)}sub2dZY(){return new K(this.t,this.M,pt,$.Shader.DEFAULT,this.e,this.f,this.c,this.d,this.g,this.h)}sub2dXZ(){return new K(this.t,this.M,pt,$.Shader.DEFAULT,this.a,this.b,this.e,this.f,this.g,this.h)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.M=t.M,this.$=t.$,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.M=324306959,this.$=$.Shader.COLOR_3D_XZ,this.S=bt}draw(...t){const s=this.$(8,t);$i[s]=this.g,$i[s+1]=this.a,$i[s+2]=this.c,$i[s+3]=this.e,$i[s+4]=this.h,$i[s+5]=this.b,$i[s+6]=this.d,$i[s+7]=this.f}drawCube(x=0,y=0,z=0,t=1,s=1,r=1,...n){const o=this.$(8,n),{a:a,b:b,c:c,d:d,e:e,f:f}=this;$i[o]=this.g+x*a+y*c+z*e,$i[o+1]=a*t,$i[o+2]=c*s,$i[o+3]=e*r,$i[o+4]=this.h+x*b+y*d+z*f,$i[o+5]=b*t,$i[o+6]=d*s,$i[o+7]=f*r}drawMat(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,...n){const o=this.$(8,n),u=this.a,p=this.b,m=this.c,v=this.d,g=this.e,A=this.f;$i[o]=this.g+u*s+m*r+g*l,$i[o+1]=u*a+m*b+g*c,$i[o+2]=u*d+m*e+g*f,$i[o+3]=u*t+m*h+g*i,$i[o+4]=this.h+p*s+v*r+A*l,$i[o+5]=p*a+v*b+A*c,$i[o+6]=p*d+v*e+A*f,$i[o+7]=p*t+v*h+A*i}drawv(t){const s=this.$(8,t);$i[s]=this.g,$i[s+1]=this.a,$i[s+2]=this.c,$i[s+3]=this.e,$i[s+4]=this.h,$i[s+5]=this.b,$i[s+6]=this.d,$i[s+7]=this.f}drawCubev(x=0,y=0,z=0,t=1,s=1,r=1,n){const o=this.$(8,n),{a:a,b:b,c:c,d:d,e:e,f:f}=this;$i[o]=this.g+x*a+y*c+z*e,$i[o+1]=a*t,$i[o+2]=c*s,$i[o+3]=e*r,$i[o+4]=this.h+x*b+y*d+z*f,$i[o+5]=b*t,$i[o+6]=d*s,$i[o+7]=f*r}drawMatv(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,n){const o=this.$(8,n),u=this.a,p=this.b,m=this.c,v=this.d,g=this.e,A=this.f;$i[o]=this.g+u*s+m*r+g*l,$i[o+1]=u*a+m*b+g*c,$i[o+2]=u*d+m*e+g*f,$i[o+3]=u*t+m*h+g*i,$i[o+4]=this.h+p*s+v*r+A*l,$i[o+5]=p*a+v*b+A*c,$i[o+6]=p*d+v*e+A*f,$i[o+7]=p*t+v*h+A*i}}class st extends E{set shader($s){this.$="function"==typeof $s&&!0===$s.three?$s:$.Shader.COLOR_3D_XZ,ht==this&&(ht=null)}get shader(){return this.$}get geometry(){return this.S}set geometry(a){this.S=a||bt,ht==this&&(ht=null)}constructor(t,s=324306959,r=bt,n=$.Shader.COLOR_3D_XZ,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.M=s,this.S=r,this.$=n}getTransform(){return new E(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}sub(){return new st(this.t,this.M,this.S,this.$,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}subPersp(t=0,s=1){return new st(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,this.j*s+this.g,this.k*s+this.h,this.l*s+this.i,this.j*t,this.k*t,this.l*t)}sub2dXY(){return new Q(this.t,this.M,pt,$.Shader.DEFAULT,this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dZY(){return new Q(this.t,this.M,pt,$.Shader.DEFAULT,this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(){return new Q(this.t,this.M,pt,$.Shader.DEFAULT,this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.j=t.j,this.k=t.k,this.l=t.l,this.M=t.M,this.$=t.$,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l,this.M=324306959,this.$=$.Shader.COLOR_3D_XZ,this.S=bt}draw(...t){const s=this.$(12,t);$i[s]=this.j,$i[s+1]=this.a,$i[s+2]=this.d,$i[s+3]=this.g,$i[s+4]=this.k,$i[s+5]=this.b,$i[s+6]=this.e,$i[s+7]=this.h,$i[s+8]=this.l,$i[s+9]=this.c,$i[s+10]=this.f,$i[s+11]=this.i}drawCube(x=0,y=0,z=0,t=1,s=1,r=1,...n){const o=this.$(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=this.j+x*a+y*d+z*u,$i[o+1]=a*t,$i[o+2]=d*s,$i[o+3]=u*r,$i[o+4]=this.k+x*b+y*e+z*h,$i[o+5]=b*t,$i[o+6]=e*s,$i[o+7]=h*r,$i[o+8]=this.l+x*c+y*f+z*i,$i[o+9]=c*t,$i[o+10]=f*s,$i[o+11]=i*r}drawMat(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,...n){const o=this.$(12,n),u=this.a,p=this.b,m=this.c,v=this.d,g=this.e,A=this.f,R=this.g,G=this.h,E=this.i;$i[o]=this.j+u*s+v*r+R*l,$i[o+1]=u*a+v*b+R*c,$i[o+2]=u*d+v*e+R*f,$i[o+3]=u*t+v*h+R*i,$i[o+4]=this.k+p*s+g*r+G*l,$i[o+5]=p*a+g*b+G*c,$i[o+6]=p*d+g*e+G*f,$i[o+7]=p*t+g*h+G*i,$i[o+8]=this.l+m*s+A*r+E*l,$i[o+9]=m*a+A*b+E*c,$i[o+10]=m*d+A*e+E*f,$i[o+11]=m*t+A*h+E*i}drawv(t){const s=this.$(12,t);$i[s]=this.j,$i[s+1]=this.a,$i[s+2]=this.d,$i[s+3]=this.g,$i[s+4]=this.k,$i[s+5]=this.b,$i[s+6]=this.e,$i[s+7]=this.h,$i[s+8]=this.l,$i[s+9]=this.c,$i[s+10]=this.f,$i[s+11]=this.i}drawCubev(x=0,y=0,z=0,t=1,s=1,r=1,n){const o=this.$(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=this.j+x*a+y*d+z*u,$i[o+1]=a*t,$i[o+2]=d*s,$i[o+3]=u*r,$i[o+4]=this.k+x*b+y*e+z*h,$i[o+5]=b*t,$i[o+6]=e*s,$i[o+7]=h*r,$i[o+8]=this.l+x*c+y*f+z*i,$i[o+9]=c*t,$i[o+10]=f*s,$i[o+11]=i*r}drawMatv(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,n){const o=this.$(12,n),u=this.a,p=this.b,m=this.c,v=this.d,g=this.e,A=this.f,R=this.g,G=this.h,E=this.i;$i[o]=this.j+u*s+v*r+R*l,$i[o+1]=u*a+v*b+R*c,$i[o+2]=u*d+v*e+R*f,$i[o+3]=u*t+v*h+R*i,$i[o+4]=this.k+p*s+g*r+G*l,$i[o+5]=p*a+g*b+G*c,$i[o+6]=p*d+g*e+G*f,$i[o+7]=p*t+g*h+G*i,$i[o+8]=this.l+m*s+A*r+E*l,$i[o+9]=m*a+A*b+E*c,$i[o+10]=m*d+A*e+E*f,$i[o+11]=m*t+A*h+E*i}}const it=t=>{if(t)if(t.msaa)t.delete();else if(t.u){if(Array.isArray(t.u))for(const s of t.u)_.deleteRenderbuffer(s);else _.deleteTexture(t.u);t.u=null,t.d=t.w=t.h=0,t.i>=0&&(k[t.i]=null,t.i=-1)}},x=Object.getOwnPropertyDescriptors({get width(){return this.t.w},get height(){return this.t.h},get identity(){return this.t},set mask(t){this.M=-2048&this.M|2047&t,ht==this&&(ht=null)},get mask(){return 2047&this.M},set blend(b){this.M=2047&this.M|(b||1135889)<<11,ht==this&&(ht=null)},get blend(){return this.M>>11},V(){const{t:t,M:s}=this,r=0|t.s?.s;let d=F^s;if(curt!=t){i&&draw(),curt&&(0|curt.s?.s)==r||(d|=240),S!=t.p&&_.bindFramebuffer(36009,S=t.p),_.viewport(0,0,t.w,t.h);for(const s of t.t)s?.i>=0&&(_.activeTexture(33984+s.i),_.bindTexture(35866,null),k[s.i]=null,s.i=-1);curt=t}if(d){if(i&&draw(),15&d&&_.colorMask(1&s,2&s,4&s,8&s),240&d)if(240&s){240&F||_.enable(2960),_.stencilMask(1<<r),_.stencilFunc(32&s?16&s?512:517:16&s?514:519,255,1<<r);const t=128&s?64&s?5386:7681:64&s?0:7680;_.stencilOp(t,t,t)}else 240&F&&_.disable(2960);if(256&d&&_.depthMask(256&s),1536&d&&(1536&s?(1536&F||_.enable(2929),_.depthFunc(521-3*(s>>9&3))):_.disable(2929)),d>>11){if(s<<1>>12==147473)_.disable(3042);else if(F<<1>>12==147473&&_.enable(3042),2113929216&d&&_.blendEquationSeparate(32773+(s>>25&7),32773+(s>>28&7)),33552384&d){const a=s>>11&15,b=s>>18&15,c=s>>15&7,d=s>>22&7;_.blendFuncSeparate(a+766*(a>1),b+766*(b>1),c+766*(c>1),d+766*(d>1))}-2147483648&d&&(-2147483648&s?_.enable(32926):_.disable(32926))}F=s}ht=this},setTarget(t=0,s=null,l=0,r=0){const{t:n}=this;if(!n.p)return;if(i&&draw(),ht==this&&(ht=null),S!=n.p&&(_.bindFramebuffer(36009,S=n.p),curt=ht=null),t=t+1>>>0,!s){if(!n.w)return;if(!t)return void(n.t[0]&&(_.framebufferRenderbuffer(36009,33306,36161,null),1==n.t.length?n.w=n.h=n.m=n.t.length=0:n.t[0]=null));if(n.t[t]&&(_.framebufferRenderbuffer(36009,36063+t,36161,null),n.t[t]=null,t==n.t.length-1))do{if(n.t.pop(),!t){n.w=n.h=n.m=0;break}}while(!n.t[--t]);return}const o=s.msaa;if(o||(s=s.t).i>=0&&(_.activeTexture(33984+s.i),_.bindTexture(35866,null),k[s.i]=null,s.i=-1),n.t.length<=t){for(n.t.length||(o?(n.w=s.width,n.h=s.height,n.m=o):(n.w=s.w,n.h=s.h,n.m=0));n.t.push(null)<t;);n.t.push(s)}else{n.t[0]&&!t&&_.framebufferRenderbuffer(36009,33306,36161,null),n.t[t]=s;t:{for(let i=t;i--;)if(n.t[i])break t;o?(n.w=s.width,n.h=s.height,n.m=o):(n.w=s.w,n.h=s.h,n.m=0)}}let u=0;t=t?36063+t:65535&(u=s.f[3]),o?(_.framebufferRenderbuffer(36009,t,36161,s.u),u&&(n.s=262144&u?s.u:null)):t==36128?_.framebufferRenderbuffer(36009,t,36161,n.s=s.u[r+l*s.m]):(_.framebufferTextureLayer(36009,t,s.u,r,l),u&&(n.s=262144&u)&&s.u.s[r+l*s.m])},auto(w,h,t=0,...f){const s=this.t,r=f=>f?t?$.Texture.Surface(w,h,t,f):$.Texture(w,h,1,0,f,99):null;if(w==s.w&&h==s.h&&t==s.m){let d=s.t.length-f.length;if(d>0)for(let i=f.length;d--;)it(s.t[i]),this.setTarget(i++-1,null);else if(d<0)for(let i=s.t.length;d++;)this.setTarget(i-1,r(f[i++]));for(let i=f.length;i--;)s.t[i]?.f!=f[i]&&(it(s.t[i]),this.setTarget(i-1,r(f[i])))}else{for(const t of s.t)it(t);this.clearTargets();let i=-1;if(t>=0)for(const s of f)this.setTarget(i++,$.Texture.Surface(w,h,t,s));else for(const t of f)this.setTarget(i++,$.Texture(w,h,1,0,t,99))}const a=s.t.slice(1);return a[-1]=s.t[0],a},clearTargets(){const{t:t}=this;if(t.p&&t.t.length){i&&draw(),ht==this&&(ht=null),t.t[0]&&_.framebufferRenderbuffer(36009,33306,36161,null),t.w=t.h=t.m=0,S!=t.p&&(_.bindFramebuffer(36009,S=t.p),curt=ht=null);for(let b=t.t.length;--b;)_.framebufferRenderbuffer(36009,b?36064+b:33306,36161,null);t.s=null,t.t.length=0}},clear(t,s,b,a,d=1/0,r=!0){"object"==typeof t?(d=s??1/0,r=b??!0,a=t.w??0,b=t.z??0,s=t.y,t=t.x):(t??=0,s??=t,b??=t,a??=t),i&&draw(),ht!==this&&(this.V(),ht=null),15&F&&_.clearColor(t,s,b,a),256&F&&_.clearDepth(1e-19/d);const n=r?this.t.s:null;if(n){const t=n.s=n.s+1&7;_.clear(t?16640:(_.stencilMask(255),17664)),_.stencilMask(1<<t)}else _.clear(16640);$t++},clearStencil(){i&&draw(),ht!==this&&(this.V(),ht=null);const t=this.t.s,s=t?t.s=t.s+1&7:1;s||(_.stencilMask(255),_.clear(1024),$t++),_.stencilMask(1<<s)},delete(){i&&draw();const{t:t}=this;t.p&&(_.deleteFramebuffer(t.p),S==t.p&&(_.bindFramebuffer(36009,S=null),ht=null))},perspective:!1});Object.defineProperties(K.prototype,x),Object.defineProperties(st.prototype,x),Object.defineProperties(Q.prototype,x),Object.defineProperties(tt.prototype,x),K.prototype.setTransform=A.prototype.reset,st.prototype.setTransform=E.prototype.reset,Q.prototype.setTransform=R.prototype.reset,tt.prototype.setTransform=G.prototype.reset,st.prototype.perspective=Q.prototype.perspective=!0,Object.assign($.Blend=(t=17,s=9,r=0,n=!1)=>t|r<<7|s<<14|n<<20,{REPLACE:147473,DEFAULT:158353,ADD:149633,MULTIPLY:151808,MULTIPLY_MIX:158440,SUBTRACT:739457,REVERSE_SUBTRACT:1017985,MIN:297105,MAX:444561,BEHIND:149751,INVERT:154105});let ht=null;function draw(b=$x){if(_.bufferData(34962,$I.subarray(0,i),35040),wt+=i,i/=$u,$t++,_t+=i,U?_.drawElementsInstanced(7&P,C,U,O,i):_.drawArraysInstanced(7&P,O,C,i),i=0,$X=b,Gt.length){At??=Gt[0];for(const f of Gt)f.sync=_.fenceSync(37143,0),Rt=Rt?Rt.next=f:f;Gt.length=0}}const et=(f,t,e)=>{if(e<=t+1)return f(t);const s=t+(e-t>>1);return`if(u<${s}){${et(f,t,s)}}else{${et(f,s,e)}}`},rt=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"],nt=_.getParameter(34921);function $H(t,s,r,c){$s=t,j=s,I=r,$u=c}function $l(t){_.bindVertexArray($v=t)}const $C=new Float32Array(4),$c=new Int32Array($C.buffer),ot=(t,s,$D=[])=>{s="number"==typeof s?[s]:s||[];let r=0;const n=[],o=[],u=[],p=[],m=[""];let v=2+t,g=0,A=2+t,R=2+t;for(const t of s){if((15&t)>=12)throw"Vertex parameter cannot be a texture";const s=1+(3&t),G=rt[3&t|(t>>4&15)<<2],E=t>15;$D[r]??=1==s?0:2==s?X:3==s?Y:V,p.push(`${r}:a${r}=$D[${r}]`);const T=(63&t)>13?"$I[i+":"$i[i+";if(1==s)m.push(T+R+"]=a"+r);else for(let t=0;t<s;t++)m.push(T+(R+t)+"]=a"+r+"."+"xyzw"[t]);const L=""+(v>>2),B=3&v,N=3&(v+=s)||4;let F=E?g:A;const j=3&F,I=3&(F+=s)||4;E?g=F:A=F;let S="";if(N<=(B||4)){const t=(v>>2)-(s==4+B);o.push(`layout(location=${nt-1-t})in uvec4 o${t};`)}S=N<=B?`uvec${s}(o${L}.${"xyzw".slice(B,4)},o${v>>2}.${"xyzw".slice(0,N)})`:4==N&&0==B?"v"+L:`o${L}.`+"xyzw".slice(B,N),E||(S=`uintBitsToFloat(${S})`);const P=`GL_${E?"V":"v"}${L}.`;if(I<=(j||4)&&o.push(`${E?"flat out u":"out "}vec4 ${(E?"GL_V":"GL_v")+((F>>2)-(s==4+j))};`),I<=j){const o=(E?"GL_V":"GL_v")+(F>>2),p=`${E?"u":""}vec${s}(${P+"xyzw".slice(j)},${o+"."+"xyzw".slice(0,I)})`;n.push(`${E?"flat in u":"in "}vec4 ${o};\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${p})`:p}\n`),u.push(`${G} t${r}=${S};${P+"xyzw".slice(j)}=t${r}.${"xyzw".slice(0,4-j)};${o}.${"xyzw".slice(0,I)}=t${r}.${"xyzw".slice(4-j,s)};`)}else{const s=P+"xyzw".slice(j,I);n.push(`\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${s})`:s}\n`),u.push(`${P+"xyzw".slice(j,I)}=${S};`)}R+=s,r++}m[0]=`let{i,$i,$I}=this;if((this.i=i+${R})>$i.length){${ArrayBuffer.prototype.transfer?`$I=this.$I=new Int32Array($I.buffer.transfer(i+${R}<<3))`:`const oa=$I;$I=this.$I=new Int32Array(i+${R}<<1);$I.set(oa,0)`};$i=this.$i=new Float32Array($I.buffer)}`,m.push("return i"),g&&(o.push("flat out uvec4 GL_V0;"),n.push("flat in uvec4 GL_V0;"));const G=eval(`(function({${p}}){${m.join(";")}})`);return{three:t,_:G,T:R,fsh:n.join(""),vsh:o.join(""),vshb:u.join("")}};class lt extends A{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.N=s,this.F=r,this.I=n}sub(t=this.t.S,s=0,r=this.I){return new lt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f)}sub3d(t=this.t.S,s=0,r=this.I){return new at(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,0,0,this.e,this.f)}addPoint(x,y,...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.S++}add(...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.S++}addPointv(x,y,t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.S++}addv(t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.S++}}class ut extends R{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1){super(a,b,c,d,e,f,o,h,i),this.t=t,this.N=s,this.F=r,this.I=n}sub(t=this.t.S,s=0,r=this.I){return new ut(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}sub3d(t=this.t.S,s=0,r=this.I){return new ct(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}addPoint(x,y,...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+this.g,$i[i+1]=x*this.b+y*this.e+this.h,$i[i+2]=x*this.c+y*this.f+this.i,s.S++}add(...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,$i[i+2]=this.i,s.S++}addPointv(x,y,t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+this.g,$i[i+1]=x*this.b+y*this.e+this.h,$i[i+2]=x*this.c+y*this.f+this.i,s.S++}addv(t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,$i[i+2]=this.i,s.S++}}class at extends G{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=1,e=0,f=0,o=0,h=0){super(a,b,c,d,e,f,o,h),this.t=t,this.N=s,this.F=r,this.I=n}sub(t=this.t.S,s=0,r=this.I){return new at(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}sub2dXY(t=this.t.S,s=0,r=this.I){return new lt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.g,this.h)}sub2dXZ(t=this.t.S,s=0,r=this.I){return new lt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.e,this.f,this.g,this.h)}sub2dZY(t=this.t.S,s=0,r=this.I){return new lt(this.t,t>>>0,s>>>0,63&r,this.e,this.f,this.c,this.d,this.g,this.h)}addPoint(x,y,z,...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+z*this.e+this.g,$i[i+1]=x*this.b+y*this.d+z*this.f+this.h,s.S++}add(...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,s.S++}addPointv(x,y,z,t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+z*this.e+this.g,$i[i+1]=x*this.b+y*this.d+z*this.f+this.h,s.S++}addv(t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,s.S++}}class ct extends E{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.N=s,this.F=r,this.I=n}sub(t=this.t.S,s=0,r=this.I){return new ct(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}sub2dXY(t=this.t.S,s=0,r=this.I){return new ut(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(t=this.t.S,s=0,r=this.I){return new ut(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}sub2dZY(t=this.t.S,s=0,r=this.I){return new ut(this.t,t>>>0,s>>>0,63&r,this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}addPoint(x,y,z,...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.S++}add(...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.S++}addPointv(x,y,z,t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.S++}addv(t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.S++}}function $a(t){_.bindBuffer(34962,t.b);const s=nt-(t.T+3>>2);for(let i=nt-1,r=0;i>=s;i--,r+=16)_.enableVertexAttribArray(i),_.vertexAttribIPointer(i,i==s?3&t.T:4,5125,t.T<<2,r);_.enableVertexAttribArray(0),_.enableVertexAttribArray(1),_.vertexAttribDivisor(0,1),_.vertexAttribDivisor(1,1),_.vertexAttribDivisor(2,1),_.bindBuffer(34962,$M)}_.vertexAttrib4f(2,1,0,0,0);const y=Object.getOwnPropertyDescriptors({get size(){return this.t.S},get uploadCount(){return this.t.P},get vertex(){return this.t.vtx},S(){const{t:t}=this;i&&draw(),$p=this;const s=P>>4,r=(P=this.I)>>4;s!=r&&(r?(s||_.enable(2884),_.frontFace(2304+(r>>1))):_.disable(2884)),O=this.N,C=this.F,U=t.O},get end(){return this.N+this.F},set end(a){(a>>>=0)>=this.N?this.F=a-this.N:(this.F=this.N-a,this.N=a),$p==this&&this.S()},get start(){return this.N},set start(a){this.N=a>>>0,$p==this&&(i&&draw(),O=this.N)},get length(){return this.F},set length(a){this.F=a>>>0,$p==this&&(i&&draw(),C=this.F)},get type(){return this.I},set type(a){this.I=63&a,$p==this&&this.S()},get identity(){return this.t},upload(t=null){const{t:s}=this;if($p&&s==$p.t&&i&&draw(),t){let r=0;if(Array.isArray(t)){let s=0;for(const r of t)r>s&&(s=r);const $M=s>254?s>65534?new Uint32Array(t.length):new Uint16Array(t.length):new Uint8Array(t.length);$M.set(t,0),t=$M}r=5121+(262656>>(t.BYTES_PER_ELEMENT<<2)&15),s.O=r,_.bindVertexArray(s.v),_.bindBuffer(34963,s.E??=_.createBuffer()),_.bufferData(34963,t,35044),s.v?s.Ls||(s.Ls=1,$a(s)):_.bindBuffer(34963,null),_.bindVertexArray($v)}else s.v&&(_.bindVertexArray(s.v),s.Ls||(s.Ls=1,$a(s)),s.E&&_.bindBuffer(34963,null),_.bindVertexArray($v)),s.O=0,s.E&&(s.E.delete(),s.E=null);$p&&$p.t==s&&(U=s.O),_.bindBuffer(34962,s.b),_.bufferData(34962,s.$I.subarray(0,s.i),35044),_.bindBuffer(34962,$M),s.$i=ft,s.$I=yt,s.i=0,s.P=this.F=t?t.length:s.S,s.S=0,$p&&s==$p.t&&this.S()},export(){const{t:{$I:$I,i:t}}=this,s=new Uint8Array(4*t);for(let i=0;i<t;i++){const t=4*i,r=$I[i];s[t]=r>>24,s[t+1]=r>>16,s[t+2]=r>>8,s[t+3]=r}return s},import(f){f instanceof ArrayBuffer&&(f=new Uint8Array(f));const{t:t}=this;let{i:i,$I:$I}=t,l=i+(.25*f.length>>>0);if($I.length<l){if(ArrayBuffer.prototype.transfer)$I=t.$I=new Int32Array($I.buffer.transfer(4*l));else{const s=t.$I;$I=t.$I=new Int32Array(l),t.$I.set(s,0)}t.$i=new Float32Array(t.$I.buffer)}let s=0;for(;i<l;)$I[i++]=f[s++]<<24|f[s++]<<16|f[s++]<<8|f[s++];t.i=l},dup(){const{t:t}=this;if(!t.i)return-1;let i=t.i,s=i-t.T,{$I:$I}=t,r=t.i=i+t.T;if($I.length<r){if(ArrayBuffer.prototype.transfer)$I=t.$I=new Int32Array($I.buffer.transfer(8*r));else{const s=t.$I;$I=t.$I=new Int32Array(2*r),t.$I.set(s,0)}t.$i=new Float32Array(t.$I.buffer)}for(;i<r;)$I[i++]=$I[s++];return t.S++}}),ft=new Float32Array,yt=new Int32Array(ft.buffer);Object.defineProperties(lt.prototype,y),Object.defineProperties(ut.prototype,y),Object.defineProperties(at.prototype,y),Object.defineProperties(ct.prototype,y),$.Geometry2D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{_:r,T:n,three:o}=t??$.Geometry2D.Vertex.DEFAULT;if(o)return null;const $i=new Float32Array(16);return new lt({$i:$i,$I:new Int32Array($i.buffer),i:0,vtx:t,b:_.createBuffer(),_:r,T:n,S:0,P:0,v:null,E:null,O:0},0,0,s)},$.Geometry3D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{_:r,T:n,three:o}=t??$.Geometry3D.Vertex.DEFAULT;if(!o)return null;const $i=new Float32Array(16);return new ct({$i:$i,$I:new Int32Array($i.buffer),i:0,vtx:t,b:_.createBuffer(),_:r,T:n,S:0,P:0,v:_.createVertexArray(),L:null,Ls:0,E:null,O:0},0,0,s)},$.Geometry2D.Vertex=ot.bind(null,!1),$.Geometry3D.Vertex=ot.bind(null,!0);const pt=$.Geometry2D.SQUARE=$.Geometry2D($.Geometry2D.Vertex.DEFAULT=ot(!1,[]),5),bt=$.Geometry3D.CUBE=$.Geometry3D($.Geometry3D.Vertex.DEFAULT=ot(!0,[]),21);$.Geometry3D.Vertex.WITH_NORMALS=ot(!0,[$.VEC3]);for(let i=0;i<4;i++)pt.addPoint(1&i,i>>1&1),bt.addPoint(0,1&i,i>>1&1),bt.addPoint(1,1&i,i>>1&1);pt.upload(),bt.upload(new Uint8Array([4,6,0,2,3,6,7,4,5,0,1,3,5,7])),$.Geometry3D.INSIDE_CUBE=bt.sub(0,14,37),$.Geometry3D.XZ_FACE=bt.sub(7,4,21),$.Shader=(t,{params:s,defaults:$D,uniforms:r,uniformDefaults:$U,outputs:m=4,vertex:v=$.Geometry2D.Vertex.DEFAULT,intFrac:g=.5}={})=>{if(s="number"==typeof s?[s]:s||[],r="number"==typeof r?[r]:r||[],$D=void 0!==$D?Array.isArray($D)?[...$D]:[$D]:[],$U=void 0!==$U?Array.isArray($U)?[...$U]:[$U]:[],m="number"==typeof m?[m]:m||[],m.length>Drawable.MAX_TARGETS)throw`Too many shader outputs (Drawable.MAX_TARGETS == ${Drawable.MAX_TARGETS})`;const A=3+v.three,R=[],G=[""],E=[`#version 300 es\nprecision highp float;precision highp int;layout(location=0)in mat3x${A} m;layout(location=${nt-1})in uvec4 o0;out vec4 GL_v0;`],T=[`void main(){gl_Position.xyw=vec${A}(1.,GL_v0.xy${v.three?"z":""}=uintBitsToFloat(o0.xy${v.three?"z":""}))*m;gl_Position.xy=gl_Position.xy*2.-gl_Position.w;gl_Position.z=1e-19;gl_PointSize=1.;`],L=[`#version 300 es\nprecision highp float;precision highp int;in vec4 GL_v0;\n#define color color0\n#define depth (1./gl_FragCoord.w)\n#define setDepth(f) (gl_FragDepth=1e-19/(f))\n#define dGetValue(a,b) (1e-19/fGetColor(a,b).x)\n#define dGetPixel(a,b,c) (1e-19/fGetPixel(a,b,c).x)\n#define pos GL_v0.xy${A>3?"z":""}\n`+m.map((t,i)=>`layout(location=${i})out ${t?16==t||32==t?"u":"lowp ":""}vec4 color${i};`).join(";"),""];p||(L[0]+="void GL_main();void main(){gl_FragDepth=1e-19*gl_FragCoord.w;GL_main();}\n#define main GL_main\n");let B=0,N=0,F=0,j=0;const I=[],S=(t=0)=>{const s=""+(j>>2),r=3&j,n=3&(j+=t)||4;if(n<=(r||4)){const s=(j>>2)-(t==4+r),n=""+s;E.push(`layout(location=${s+3})in uvec4 a${n};flat out uvec4 GL_a${n};`),L.push(`flat in uvec4 GL_a${n};`),T.push(`GL_a${n}=a${n};`)}if(n<=r){let o=`uvec${t}(GL_a${s}.`;for(let i=r;i<4;i++)o+="xyzw"[i];o+=`,GL_a${j>>2}.`;for(let i=0;i<n;i++)o+="xyzw"[i];return o+")"}if(4==n&&0==r)return"GL_a"+s;let o=`GL_a${s}.`;for(let i=r;i<n;i++)o+="xyzw"[i];return o};let P=0;for(const t of s){let s=1+(3&t);(15&t)>=12&&(B|=1<<s-1,(15&t)>13?F++:N++),$D[P]??=1==s?0:2==s?X:3==s?Y:t>=28&&t<32?null:V,R.push(`${P}:a${P}=$D[${P}]`);const r=t>13?"$I[j+":"$i[j+",n=j;if(t>=12&&t<16){I.push(`let t${P}=-1;if(a${P}.t){if((t${P}=$m.auto(a${P}.t,${-(8==t)}))==-1){i&&draw(b^$X);t${P}=$m.auto(a${P}.t,${-(8==t)})}t${P}|=a${P}.l<<8}`);const o=S(1),u=S(2),p=S(2);L.push(`${4==t?"lowp ":8==t?"u":"highp "}vec4 param${P}(vec2 uv){int v=int(${o});if(v<0)return vec4(uintBitsToFloat(${u}),uintBitsToFloat(${p}));return ${4==t?"g":8==t?"uG":"fG"}etColor(v&255,vec3(uv*uintBitsToFloat(${p})+uintBitsToFloat(${u}),v>>8));}`),G.push(`$I[j+${n}]=t${P};if(t${P}>=0)$i[j+${n+1}]=a${P}.x,$i[j+${n+2}]=a${P}.y,$i[j+${n+3}]=a${P}.w,$i[j+${n+4}]=a${P}.h;else ${r}${n+1}]=a${P}.x,${r}${n+2}]=a${P}.y,${r}${n+3}]=a${P}.z,${r}${n+4}]=a${P}.w`),s=5}else{t>=28&&t<32&&(I.push(`let q${P}=$m.auto(a${P}.t,${-(t>29)});if(q${P}<0)i&&draw(b^$X),q${P}=$m.auto(a${P}.t,${-(t>29)})`),s=1);const o=S(s);if(L.push(`\n#define param${P} ${t<16?"uintBitsToFloat":t<32?rt[3&t|4]:""}(${o})\n`),1==s)G.push(r+n+"]=a"+P);else for(let t=0;t<s;t++)G.push(r+(n+t)+"]=a"+P+"."+"xyzw"[t])}P++}L.push(v.fsh),E.push(v.vsh),T.push(v.vshb),P=0;const O=[],C=[""],U=[],D=[],k=[];for(const t of r){const s=1+(3&t);if((15&t)>=12&&(B|=1<<s-1,(15&t)>13?F++:N++,n="int"),$U[P]??=1==s?0:2==s?X:3==s?Y:t>=28&&t<32?null:V,O.push(`a${P}=$U[${P}]`),t>=28&&t<32)U.push(`_.uniform1i($L[${D.length}],s${k.length}?$m.auto(s${k.length},${-(t>29)}):-1)`),D.push("uni"+P),L.push(`uniform ${t>29?"u":""}sampler2DArray uni${P};`),C.push(`s${k.length}=a${P}.t`),k.push(`,s${k.length}=null`);else if(t>=12&&t<16){const s="GL_u"+P,r="GL_U"+P,n="GL_L"+P;U.push(`if(s${k.length})_.uniform1i($L[${D.length}],$m.auto(s${k.length},${-(t>13)}))`),L.push(t>13?`uniform usampler2DArray ${s};uniform float ${n};uniform uvec4 ${r}; ${14==t?"i":"u"}vec4 uni${P}(vec2 uv){if(${n}<0.)return ${14==t?`ivec4(${r})`:r};return ${14==t?"i":"u"}GetColor(${s},vec3(uv*uintBitsToFloat(${r}.zw)+uintBitsToFloat(${r}.xy),${n}));}`:`uniform sampler2DArray ${s};uniform float ${n};uniform vec4 ${r}; ${12==t?"lowp ":""}vec4 uni${P}(vec2 uv){if(${n}<0.)return ${r};return texture(${s},vec3(uv*${r}.zw+${r}.xy,${n}));}`),C.push(`if(s${k.length}=a${P}.t){_.uniform1f($L[${D.length+2}],a${P}.l);${t>13?`$C[0]=a${P}.x,$C[1]=a${P}.y,$C[2]=a${P}.w,$C[3]=a${P}.h;_.uniform4ui`:"_.uniform4f"}($L[${D.length+1}],${t>13?"$c[0],$c[1],$c[2],$c[3]":`a${P}.x,a${P}.y,a${P}.w,a${P}.h`})}else _.uniform1f($L[${D.length+2}],-1),_.uniform4${t>13?"ui":"f"}($L[${D.length+1}],a${P}.x,a${P}.y,a${P}.z,a${P}.w)`),D.push(s,r,n),k.push(`,s${k.length}=null`)}else{L.push(`uniform ${rt[3&t|t>>4<<2]} uni${P};`);let r=`_.uniform${s+(t<16?"f":t<32?"i":"ui")}($L[${D.length}]`;if(D.push("uni"+P),1==s)r+=",a"+P;else for(let t=0;t<s;t++)r+=",a"+P+"."+"xyzw"[t];C.push(r+")")}P++}if(12+(j+3&-4)+(v.T+3&-4)>nt<<2)throw"Too many shader parameters";if(N+F>16)throw"Shaders cannot use more than 16 textures/colors";Object.freeze($D),Object.freeze($U);const Z=nt-(v.T+3>>2);N=N?F?N+u(g*(M-N-F)):M:0,F=F&&M-N;let H=null,q=`precision highp usampler2DArray; precision ${2&B?"highp":"lowp"} sampler2DArray;`;15&B&&(q+=`uniform sampler2DArray GL_f[${N}];ivec3 textureSize(int u,int l){${et(i=>`return textureSize(GL_${i<N?"f["+i:"i["+(i-N)}],l);`,0,M)}}\n#define getSize textureSize\n`),12&B&&(q+=`uniform usampler2DArray GL_i[${F}];uvec4 uGetColor(int u,vec3 p){${et(i=>`return texture(GL_i[${i-M}],p);`,M,2*M-N)}}uvec4 uGetPixel(int u,ivec3 p,int l){${et(i=>`return texelFetch(GL_i[${i-M}],p,l);`,M,2*M-N)}}uvec4 uGetColor(usampler2DArray u,vec3 p){return texture(u,p);}uvec4 uGetPixel(usampler2DArray u,ivec3 p,int l){return texelFetch(u,p,l);}\n#define iGetColor(a,b) ivec4(uGetColor(a,b))\n#define iGetPixel(a,b,c) ivec4(uGetPixel(a,b,c))\n`),3&B&&(q+=`vec4 fGetColor(int u,vec3 p){${et(i=>`return texture(GL_f[${i}],p);`,0,N)}}lowp vec4 GL_lp(vec4 x){return x;}vec4 fGetColor(sampler2DArray t,vec3 p){return texture(t,p);}vec4 fGetPixel(sampler2DArray t,ivec3 p,int l){return texelFetch(t,p,l);}vec4 fGetPixel(int u,ivec3 p,int l){${H||et(i=>`return texelFetch(GL_f[${i}],p,l);`,0,N)}}\n#define getColor(a,b)GL_lp(fGetColor(a,b))\n#define getPixel(a,b,c)GL_lp(fGetPixel(a,b,c))\n`),L[1]=q;const W=32-N&&-1>>>N|0;C[0]=`i&&draw(0);if($s!=s){_.useProgram($P);$H(s,${N},${W},${A>3?j+A*(A-1)+")":`lv==$Q?${j+9}:${j+6});$l(lv)`}}`;const J=Z==nt-1?`_.vertexAttribIPointer(${Z},${3&v.T},5125,${v.T<<2},0)`:`for(let i=${nt-1},j=0;i>=${Z};i--,j+=16){_.vertexAttribIPointer(i,i==${Z}?${3&v.T}:4,5125,${v.T<<2},j)`;G[0]=`sz+=${j};if(lastd!==this){this.V();const sd=$s!=s,{S}=this,_st=S.t;if(sd||sz!=$u){i&&draw(sd?0:$x);$H(s,${N},${W},sz);if(sd)_.useProgram($P),B();${A>3?`}if($v!=_st.v)i&&draw(),$l(_st.v);if(s!=_st.L||sz!=_st.Ls){i&&draw();if(!_st.Ls)$a(_st);$d(sz>${8+j},0,false);_st.L=s;_st.Ls=sz`:`$l(lv=sz>${8+j}?$Q:$q)}if(lv.geo!=_st.b){i&&draw();_.bindBuffer(34962,lv.geo=_st.b);${J};_.bindBuffer(34962,$M);_.bindBuffer(34963,_st.E)`}}if($p!=S)S.S();}let b=$X^$x;`+I.join(";")+`;const k=$G(sz),j=k+sz-${j}`,G.push("return k");const $d=(t=!1,s=0,r=!0)=>{const n=A*(2+t),u=j+n<<2;_.vertexAttribPointer(0,A,5126,!1,u,s),_.vertexAttribPointer(1,A,5126,!1,u,s+(A<<2)),t?(_.enableVertexAttribArray(2),_.vertexAttribPointer(2,A,5126,!1,u,s+(A<<3))):_.disableVertexAttribArray(2);for(let i=0;i<j;i+=4){const t=3+(i>>2);_.enableVertexAttribArray(t),_.vertexAttribIPointer(t,o(4,j-i),5125,u,s+(i+n<<2)),_.vertexAttribDivisor(t,1)}if(r){_.enableVertexAttribArray(0),_.enableVertexAttribArray(1),_.vertexAttribDivisor(0,1),_.vertexAttribDivisor(1,1),_.vertexAttribDivisor(2,1);for(let i=nt-1;i>=Z;i--)_.enableVertexAttribArray(i)}return u>>2};let $q=null,$Q=null;A<4&&(_.bindVertexArray($q=_.createVertexArray()),$q.geo=null,$d(!1),_.bindVertexArray($v=$Q=_.createVertexArray()),$Q.geo=null,$d(!0));const K=eval(`let ${A<4?"lv=$Q":"__"}${k.length?k.join(""):""};const B=function(){${U.join(";")};$x=$X},s=function(sz,{${R}}){${G.join(";")}};s.uniforms=(function(${O}){${C.join(";")};B()});s`),$P=_.createProgram(),Q=_.createShader(35633),f=_.createShader(35632);if(T.push("}"),_.shaderSource(Q,E.join("")+T.join("")),_.compileShader(Q),K.src=L.join("")+"\n"+t,_.shaderSource(f,L.join("")+"\n"+t),_.compileShader(f),_.attachShader($P,Q),_.attachShader($P,f),H=_.getShaderInfoLog(f))throw"GLSL Error:\n"+H;if(_.linkProgram($P),H=_.getShaderInfoLog(Q))throw"GLSL Error:\n"+E.join("")+T.join("");_.useProgram($P);const $L=D.map(t=>_.getUniformLocation($P,t));for(let i=0;i<M;i++)_.uniform1i(_.getUniformLocation($P,i<N?"GL_f["+i+"]":"GL_i["+(i-N)+"]"),i>=N?M+i-N:i);return K.vertex=v,K.three=v.three,$s=K};let $t=0,_t=0,wt=0;$.Shader.UINT=$.Shader("void main(){color=param0;}",{params:$.UVEC4,outputs:$.UINT}),$.Shader.BLACK=$.Shader("void main(){color=vec4(0,0,0,1);}"),$.Shader.SIMPLE=$.Shader("void main(){color=param0;}",{params:[$.VEC4]}),$.Shader.DEFAULT=$.Shader("void main(){color=param0(pos)*param1;}",{params:[$.COLOR,$.VEC4],defaults:[void 0,$.vec4.one]}),$.Shader.COLOR_3D_XZ=$.Shader("void main(){color=param0(pos.xz);}",{params:[$.COLOR],vertex:Geometry3D.Vertex.DEFAULT}),$.Shader.SHADED_3D=$.Shader("void main(){color=param0(pos.xy);color.rgb*=1.+dot(normalize(cross(dFdx(pos),dFdy(pos))),param1);}",{params:[$.COLOR,$.VEC3],defaults:[void 0,vec3(-.15,-.3,0)],vertex:Geometry3D.Vertex.DEFAULT});let xt=0;const mt=[];$.onFlush=f=>mt.push(f),$.flush=()=>{i&&draw(),N?N=!1:L&&(_.bindBuffer(35051,null),_.deleteBuffer(L),L=null,B=-1);for(let i=0;i<M<<1;i++){const t=k[i];t&&(_.activeTexture(33984+i),_.bindTexture(35866,k[i]=null),t.i=-1)}let t=performance.now();t-xt>1e3&&(xt=t,$i=new Float32Array($i.length>>>1),$I=new Int32Array($i.buffer));for(const f of mt)try{f()}catch(t){Promise.reject(t)}};const vt=$.ctx=new K(curt={s:{s:0},p:null,w:0,h:0,m:0,t:[]});$.setSize=(w=0,h=0)=>{_.canvas.width=w,_.canvas.height=h,vt.t.w=_.drawingBufferWidth,vt.t.h=_.drawingBufferHeight,curt==vt.t&&(curt=ht=null),vt.t.s.s=0};const gt=()=>{for(;At&&37145==_.getSyncParameter(At.sync,37140);)_.deleteSync(At.sync),At(),At=At.next;At||(Rt=null,clearInterval(Et),Et=0)};let At=null,Rt=null;const Gt=[];$.wait=()=>new Promise(t=>{i?(t.sync=null,Gt.push(t)):(t.sync=_.fenceSync(37143,0),At??=t,Rt=Rt?Rt.next=t:t),Et||(Et=setInterval(gt,0))});let Et=0;return $.loop=t=>("t"in $||($.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=.001*performance.now(),$.dt=0,$.frameCpu=0,$.glLost??=null,requestAnimationFrame(function f(){if(requestAnimationFrame(f),_.isContextLost())return $.glLost?.(),$.glLost=At=Rt=null;i&&draw(),_.bindFramebuffer(36009,S=curt=ht=null),vt.t.s.s=0,dt=max(.001,o(-($.t-($.t=.001*performance.now())),.5)),vt.reset();try{t()}finally{$.flush(),$.frameCpu=.001*performance.now()-$.t,$t||$.ctx.clear(),$.frameDrawCalls=$t,$.frameSprites=_t,$.frameData=4*wt+24*$t,$t=_t=wt=0}})),$),$},Object.assign($.Gamma,{bitmapOpts:p,STENCIL:1,ALPHA_CHANNEL:2,PREMULTIPLIED_ALPHA:4,AUTO_CLEAR_BUFFER:8,MSAA:16})}