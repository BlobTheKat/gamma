{const $=globalThis;Math.PI2??=2*Math.PI;const{clz32:t,cos:s,sin:n,min:r,round:o}=Math;if(!("setImmediate"in $)){let t=0,s=0,n=[],r=new MessageChannel;r.port1.onmessage=()=>{const r=n[s];n[s++]=null,s>3&&s>n.length>>1&&(n.splice(0,s),t+=s,s=0),r?.()},r=r.port2,$.setImmediate=(s,...o)=>(r.postMessage(0),n.push(o.length?s.bind(void 0,...o):s),n.length-1+t),$.clearImmediate=i=>{(i-=t)===i>>>0&&(i>=n.length||(n[i]=null))}}if(!("sin"in $)){const t=Object.getOwnPropertyDescriptors(Math);delete t[Symbol.toStringTag],Object.defineProperties($,t)}const u={imageOrientation:"flipY",premultiplyAlpha:"premultiply"},_=(t,s,n)=>"string"==typeof t?fetch(t).then(a=>a.blob()).then(t=>createImageBitmap(t,u)).then(s,n):t instanceof Blob?createImageBitmap(t,u).then(s,n):s(t);$.Gamma=(u=document.createElement("canvas"),$={},p=15)=>{const g=$.g=($.canvas=u).getContext("webgl2",{preserveDrawingBuffer:!(8&p),antialias:16&p,depth:!1,premultipliedAlpha:4&p,stencil:1&p,alpha:2&p});g.pixelStorei(37440,1),g.stencilMask(1),g.clearStencil(0),g.disable(2929),g.enable(3042),g.pixelStorei(3317,1),g.pixelStorei(3333,1);const R=g.createBuffer();g.bindBuffer(35052,R);let m=!0,v=null,G=-1,E=!1;class B{get isInteger(){return this.t.f.length>3}get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get mipmaps(){return this.t.m}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,x=0,y=0,w=1,h=1,l=0){this.t=t,this.x=x,this.y=y,this.w=w,this.h=h,this.l=l}get loaded(){return!this.t.src}get waiting(){return!this.t._}get then(){return this.t.src?this.#t:null}load(){this.t._||B.load(this.t)}sub(x=0,y=0,w=1,h=1,l=this.l){return new B(this.t,this.x+x*this.w,this.y+y*this.h,this.w*w,this.h*h,l)}super(x=0,y=0,w=1,h=1,l=this.l){const t=this.w/w,s=this.h/h;return new B(this.t,this.x-x*t,this.y-y*s,t,s,l)}crop(x=0,y=0,w=0,h=0,l=this.l){const{t:t,x:s,y:n,h:r}=this;if(!t.src)return new B(t,s+x/t.w,n+r-(y+h)/t.h,w/t.w,h/t.h,l);const i=new B(t,0,0,0,0,l);return t._||B.load(t),t.src.push(i=>{i.x=s+x/t.w,i.y=n+r-(y+h)/t.h,i.w=w/t.w,i.h=h/t.h},void 0,i),i}layer(l=this.l){return new B(this.t,this.x,this.y,this.w,this.h,l)}#t(t,s){"function"!=typeof t&&(t=Function.prototype),this.t.src?(this.t._||B.load(this.t),this.t.src.push(t,s,this)):t(this)}static load(t){let s=t.src,n=0;t.src=[];let w=0,h=0;t._=g.createTexture();const r=()=>{n=-1,B.setOptions(t),g.texStorage3D(35866,t.m,t.f[0],t.w=w=1,t.h=h=1,t.d),m||(g.pixelStorei(37440,1),g.pixelStorei(37441,1),m=!0),t.m>1&&g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null);const s=t.src;t.src=null;for(let i=1;i<s.length;i+=3)s[i]?.(s[i+1])};for(let i=0;i<s.length;i++)_(s[i],o=>{if(n){if(w!=o.width||h!=o.height)return r()}else w=o.width,h=o.height;if(s[i]=o,++n<s.length)return;B.setOptions(t),g.texStorage3D(35866,t.m,t.f[0],t.w=w,t.h=h,t.d),m||(g.pixelStorei(37440,1),g.pixelStorei(37441,1),m=!0),g.bindBuffer(35052,null);for(let l=0;l<n;l++)g.texSubImage3D(35866,0,0,0,l,w,h,1,t.f[1],t.f[2],s[l]);g.bindBuffer(35052,R),t.m>1&&g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null);const u=t.src;t.src=null;for(let i=0;i<u.length;i+=3)u[i](u[i+2])},r)}paste(t,x=0,y=0,l=0,s=0,n=0,r=0,o=0,u=0,p=0,v=0,G=0){const{t:E}=this;if(E.src)return null;if(t.msaa)return i&&A(),p=u||t.height,u=o||t.width,g.framebufferRenderbuffer(36008,36064,36161,t._),P!=j&&(g.bindFramebuffer(36009,P=j),curt=null),g.framebufferTextureLayer(36009,36064,E._,s,l),g.blitFramebuffer(n,r,n+u,r+p,x,y,x+u,y+p,16384,9728),this;if(!(t instanceof B))return _(t,i=>(B.fakeBind(E),m||(g.pixelStorei(37440,1),g.pixelStorei(37441,1),m=!0),g.bindBuffer(35052,null),g.texSubImage3D(35866,s,x,y,l,i.width,i.height,1,E.f[1],E.f[2],i),g.bindBuffer(35052,R),E.i<0&&g.bindTexture(35866,null),this));const{t:T}=t;if(T.src)return console.warn("Source texture is not loaded"),this;if(E._==T._)return console.warn("Cannot copy from texture to itself"),this;for(B.fakeBind(E),u=u||T.w,p=p||T.h,v=v||T.d;v--;)g.framebufferTextureLayer(36008,36064,T._,G,o++),g.copyTexSubImage3D(35866,s,x,y,l++,n,r,u,p);return E.i<0&&g.bindTexture(35866,null),this}pasteData(t,x=0,y=0,l=0,w=0,h=0,d=0,s=0){const{t:n}=this;return n.src?null:(w=w||n.w,h=h||n.h,d=d||n.d,B.fakeBind(n),m&&(g.pixelStorei(37440,0),g.pixelStorei(37441,0),m=!1),g.bufferData(35052,t,35042),g.texSubImage3D(35866,s,x,y,l,w,h,d,n.f[1],n.f[2],0),tt+=.25*t.byteLength,n.i<0&&g.bindTexture(35866,null),this)}readData(x=0,y=0,l=0,w=0,h=0,d=0,t=0){const{t:s}=this;if(s.src)return null;w=w||s.w,h=h||s.h,d=d||s.d,i&&A();let a=s.f[0],n=33323==a||33338==a||33340==a||33327==a||33328==a||33336==a?2:33321==a||33330==a||33332==a||33334==a||33325==a||33326==a?1:4,r=n<=2?1==n?6403:33319:3==n?6407:6408;a=s.f[2]==5121?1:s.f[2]==5126||s.f[2]==5125||s.f[2]==35899||s.f[2]==33640||s.f[2]==35902?4:2,n*=w*h;let o,u=n*d*a;for(G==u?(o=v,G=-1,E=!0):(g.bindBuffer(35051,o=g.createBuffer()),g.bufferData(35051,u,35041),u>G&&(G=u,v=o,E=!0));d--;)g.framebufferTextureLayer(36008,36064,s._,t,l),g.readPixels(x,y,w,h,r,s.f[2],n*a*l++);return o!=v&&g.bindBuffer(35051,v),new Promise(t=>{const r=()=>{const arr=1==a?new Uint8Array(n*d):4==a?s.f[2]==5126?new Float32Array(n*d):new Uint32Array(n*d):new Uint16Array(n*d);o!=v&&g.bindBuffer(35051,o),g.getBufferSubData(35051,0,arr),t(arr),o!=v&&(u>G?(G=u,v=o):g.bindBuffer(35051,v)),E=!0};r.sync=g.fenceSync(37143,0),et??=r,nt=nt?nt.next=r:r,ht||(ht=setInterval(st,0))})}delete(){this.t._&&(g.deleteTexture(this.t._),this.t._=null,this.t.i>=0&&(X[this.t.i]=null,this.t.i=-1),this.t.d=this.t.w=this.t.h=0)}static auto(s,i=0){if(s.f[3]>>31!=i)return-2;if(s.i>=0){const t=-2147483648>>>s.i-(V-shfCount&i);if(!(t&(i^shfMask)))return boundUsed|=t,s.i;X[s.i]=null,s.i=-1}s._||B.load(s);const n=t(~(boundUsed|i^shfMask));if(n>=V)return-1;boundUsed|=-2147483648>>>n;const r=X[i=i?V+n-shfCount:n];return r&&(r.i=-1),g.activeTexture(33984+i),g.bindTexture(35866,(X[i]=s)._),s.i=i}static fakeBind(t){if(t.i>=0)i&&A(),g.activeTexture(33984+t.i);else{const s=V-1+(shfCount==V&&V);X[s]&&(X[s].t.i=-1),g.activeTexture(33984+s),g.bindTexture(35866,t._)}}get options(){return this.t.o}static setOptions(t){B.fakeBind(t);const{o:s}=t;t.f[3]>>31?(g.texParameterf(35866,10240,9728),g.texParameterf(35866,10241,9728)):(g.texParameterf(35866,10240,9728+(1&s)),g.texParameterf(35866,10241,t.m>1?9984+(s>>1&3):9728+(s>>1&1))),g.texParameterf(35866,10242,8&s?10497:16&s?33648:33071),g.texParameterf(35866,10243,32&s?10497:64&s?33648:33071)}set options(t){const{t:s}=this;s.o=t,s.src||(B.setOptions(s),s.i<0&&g.bindTexture(35866,null))}setMipmapRange(t=0,e=65535){const{t:s}=this;s.src||(B.fakeBind(s),g.texParameteri(35866,33082,t),g.texParameteri(35866,33083,e),s.i<0&&g.bindTexture(35866,null))}genMipmaps(){const{t:t}=this;t.m<2||(B.fakeBind(t),g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null))}}$.Drawable=(t=!1)=>new U({_:g.createFramebuffer(),p:0,$:t?g.createRenderbuffer():null,w:0,h:0,u:0}),$.Drawable.MAX_TARGETS=g.getParameter(36063);let arr=new Float32Array(16),iarr=new Int32Array(arr.buffer),i=0;$.Texture=(w=0,h=0,d=0,t=0,f=Formats.RGBA,s=0)=>{const n={_:g.createTexture(),i:-1,o:t,f:f,src:null,w:w,h:h,d:+d||1,m:s=s||1},r=new B(n);return B.setOptions(n),w&&h?g.texStorage3D(35866,s,n.f[0],w,h,n.d):g.texStorage3D(35866,s,n.f[0],n.w=1,n.h=1,n.d),g.bindTexture(35866,null),r},$.Texture.MAX_WIDTH=$.Texture.MAX_HEIGHT=g.getParameter(3379),$.Texture.MAX_LAYERS=g.getParameter(35071),$.Texture.FILTER_32F=!!g.getExtension("OES_texture_float_linear");const S=$.Texture.MAX_MSAA=g.getParameter(36183);$.Texture.MSAA=(w=0,h=0,t=65536,f=Formats.RGBA)=>{t=r(t,S);const s=g.createRenderbuffer();return g.bindRenderbuffer(36161,s),g.renderbufferStorageMultisample(36161,t,f[0],w,h),{_:s,width:w,height:h,msaa:g.getRenderbufferParameter(36161,36011),delete(){g.deleteRenderbuffer(this._)}}},$.Texture.from=(t,s=0,n=Formats.RGBA,r=0)=>new B({_:null,i:-1,o:s,f:n,src:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:t?Array.isArray(t)?t.length:1:0,m:r||1}),Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NEVER:48,UNSET:64,SET:128,FLIP:192,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:136,RGB_DST:8,ONE_MINUS_DST:153,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,ADD:17,RGB_ADD:1,A_ADD:16,SUB:85,RGB_SUB:5,A_SUB:80,SUB_REV:102,RGB_SUB_REV:6,A_SUB_REV:96,MIN:34,RGB_MIN:2,A_MIN:32,MAX:51,RGB_MAX:3,A_MAX:48,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:20,UTEXTURE:24,FTEXTURE:28,COLOR:4,UCOLOR:8,FCOLOR:12,FIXED:4,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0}),$.vec2=(x=0,y=x)=>({x:x,y:y}),$.vec2.one=$.vec2(1);const L=$.vec2.zero=$.vec2(0);$.vec2.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b}:{x:a.x+b.x,y:a.y+b.y},$.vec2.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b}:{x:a.x*b.x,y:a.y*b.y},$.vec3=(x=0,y=x,z=x)=>({x:x,y:y,z:z}),$.vec3.one=$.vec3(1);const F=$.vec3.zero=$.vec3(0);$.vec3.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z},$.vec3.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z},$.vec4=(x=0,y=x,z=x,w=x)=>({x:x,y:y,z:z,w:w}),$.vec4.one=$.vec4(1);const I=$.vec4.zero=$.vec4(0);$.vec4.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b,w:a.w+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z,w:a.w+b.w},$.vec4.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b,w:a.w*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z,w:a.w*b.w},$.Formats={R:[33321,6403,5121],RG:[33323,33319,5121],RGB:[32849,6407,5121],RGBA:[32856,6408,5121],RGB565:[36194,6407,33635],R11F_G11F_B10F:[35898,6407,35899],RGB5_A1:[32855,6408,32820],RGB10_A2:[32857,6408,33640],RGBA4:[32854,6408,32819],RGB9_E5:[35901,6407,35902],R8:[33330,36244,5121,1<<31],RG8:[33336,33320,5121,1<<31],RGB8:[36221,36248,5121,1<<31],RGBA8:[36220,36249,5121,1<<31],R16:[33332,36244,5123,1<<31],RG16:[33338,33320,5123,1<<31],RGB16:[36215,36248,5123,1<<31],RGBA16:[36214,36249,5123,1<<31],R32:[33334,36244,5125,1<<31],RG32:[33340,33320,5125,1<<31],RGB32:[36209,36248,5125,1<<31],RGBA32:[36208,36249,5125,1<<31],R16F:[33325,6403,5131],RG16F:[33327,33319,5131],RGB16F:[34843,6407,5131],RGBA16F:[34842,6408,5131],R16F_32F:[33325,6403,5126],RG16F_32F:[33327,33319,5126],RGB16F_32F:[34843,6407,5126],RGBA16F_32F:[34842,6408,5126],R32F:[33326,6403,5126],RG32F:[33328,33319,5126],RGB32F:[34837,6407,5126],RGBA32F:[34836,6408,5126]};const O=ArrayBuffer.prototype.transfer?()=>{arr=new Float32Array(arr.buffer.transfer(8*i)),iarr=new Int32Array(arr.buffer)}:()=>{const t=arr;(arr=new Float32Array(2*i)).set(t,0),iarr=new Int32Array(arr.buffer)};class N{t;s;v=0;T=null;get width(){return this.t.w}get height(){return this.t.h}set shader(t){this.T="function"==typeof t?t:$.Shader.DEFAULT}get shader(){return this.T}set mask(t){this.v=-256&this.v|255&t}get mask(){return 255&this.v}set blend(b){this.v=255&this.v|(b||1135889)<<8}get blend(){return this.v>>8}get geometry(){return this.S}set geometry(a){this.S=a||q}constructor(t,s=290787599,n=$.Shader.DEFAULT,r=q){this.t=t,this.v=s,this.T=n,this.S=r}setTarget(t=0,s=null,l=0,n=0){const{t:r}=this;if(r._){if(i&&A(),P!=r._&&(g.bindFramebuffer(36009,P=r._),curt=null),!s){if(!r.u)return;return g.framebufferRenderbuffer(36009,36064+t,36161,null),void((r.u&=~(1<<t))||(r.w=r.h=0,g.framebufferRenderbuffer(36009,36128,36161,null)))}if((r.u&=~(1<<t))||(r.w=r.h=0),r.w){if(r.w!=s.width||r.h!=s.height)return}else r.w=s.width,r.h=s.height,r.$&&(g.bindRenderbuffer(36161,r.$),g.renderbufferStorage(36161,36168,r.w,r.h),g.framebufferRenderbuffer(36009,36128,36161,r.$));r.u|=1<<t,s.msaa?g.framebufferRenderbuffer(36009,36064+t,36161,s._):g.framebufferTextureLayer(36009,36064+t,s.t._,l,n)}}clearTargets(){const{t:s}=this;if(!s._)return;i&&A();let n=s.u;if(s.u=s.w=s.h=0,s.$&&(g.framebufferRenderbuffer(36009,36128,36161,null),g.deleteRenderbuffer(s.$),s.$=g.createRenderbuffer()),n)for(P!=s._&&(g.bindFramebuffer(36009,P=s._),curt=null);n;){const s=31-t(n);n&=~(1<<s),g.framebufferRenderbuffer(36009,36064+s,36161,null)}}get hasStencil(){return this.t._?!!this.t.$:!!(1&p)}set hasStencil(t){let{t:s}=this,b=s.$;s._&&!t!=!b&&(i&&A(),s.$=b=b?(g.deleteRenderbuffer(b),null):g.createRenderbuffer(),s.w&&(P!=s._&&(g.bindFramebuffer(36009,P=s._),curt=null),b?(g.bindRenderbuffer(36161,b),g.renderbufferStorage(36161,36168,s.w,s.h),g.framebufferRenderbuffer(36009,36128,36161,b)):g.framebufferRenderbuffer(36009,36128,36161,null)))}clear(t=0,g=t,b=t,a=g){"object"==typeof t&&(a=t.w??0,b=t.z??0,g=t.y,t=t.x),i&&A(),C(this.t,this.v),g.clearColor(t,g,b,a);const s=this.t.p=this.t.p+1&7;g.clear(s?16384:(g.stencilMask(255),17408)),K++,g.disable(2960),M&=-241}clearStencil(){i&&A(),C(this.t,this.v);(this.t.p=this.t.p+1&7)||(g.stencilMask(255),g.clear(1024)),g.disable(2960),M&=-241}}class U extends N{#i;#s;#e;#n;#r;#h;constructor(t,s=290787599,n=$.Shader.DEFAULT,r=q,a=1,b=0,c=0,d=1,e=0,f=0){super(t,s,n,r),this.#i=a,this.#s=b,this.#e=c,this.#n=d,this.#r=e,this.#h=f}translate(x=0,y=0){this.#r+=x*this.#i+y*this.#e,this.#h+=x*this.#s+y*this.#n}scale(x=1,y=x){this.#i*=x,this.#s*=x,this.#e*=y,this.#n*=y}rotate(t=0){const r=s(t),o=n(t),a=this.#i,b=this.#s,c=this.#e,d=this.#n;this.#i=a*r-c*o,this.#s=b*r-d*o,this.#e=a*o+c*r,this.#n=b*o+d*r}transform(a,b,c,d,e,f){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const A=this.#i,t=this.#s,s=this.#e,n=this.#n,r=this.#r,o=this.#h;this.#i=A*a+s*b,this.#s=t*a+n*b,this.#e=A*c+s*d,this.#n=t*c+n*d,this.#r=A*e+s*f+r,this.#h=t*e+n*f+o}skew(x=0,y=0){const t=this.#i,s=this.#s;this.#i+=this.#e*y,this.#s+=this.#n*y,this.#e+=t*x,this.#n+=s*x}multiply(x=1,y=0){const t=this.#i,s=this.#s;this.#i=t*x-this.#e*y,this.#s=s*x-this.#n*y,this.#e=t*y+this.#e*x,this.#n=s*y+this.#n*x}getTransform(){return{a:this.#i,b:this.#s,c:this.#e,d:this.#n,e:this.#r,f:this.#h}}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.#i=a,this.#s=b,this.#e=c,this.#n=d,this.#r=e,this.#h=f,this.v=290787599,this.T=$.Shader.DEFAULT,this.S=q}box(x=0,y=0,w=1,h=w){this.#r+=x*this.#i+y*this.#e,this.#h+=x*this.#s+y*this.#n,this.#i*=w,this.#s*=w,this.#e*=h,this.#n*=h}to(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.#i*x+this.#e*y+this.#r,y:this.#s*x+this.#n*y+this.#h}}from(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const a=this.#i,b=this.#s,c=this.#e,d=this.#n,t=a*d-b*c;return{x:(x*d-y*c+c*this.#h-d*this.#r)/t,y:(y*a-x*b+b*this.#r-a*this.#h)/t}}toDelta(t=0,s=0){return"object"==typeof t&&({x:t,y:s}=t),{x:this.#i*t+this.#e*s,y:this.#s*t+this.#n*s}}fromDelta(t=0,s=0){"object"==typeof t&&({x:t,y:s}=t);const a=this.#i,b=this.#s,c=this.#e,d=this.#n,n=a*d-b*c;return{x:(t*d-s*c)/n,y:(s*a-t*b)/n}}determinant(){return this.#i*this.#n-this.#s*this.#e}pixelRatio(){return sqrt(abs(this.#i*this.#n-this.#s*this.#e)*this.t.w*this.t.h)}sub(){return new U(this.t,this.v,this.T,this.S,this.#i,this.#s,this.#e,this.#n,this.#r,this.#h)}resetTo(t){this.#i=t.#i,this.#s=t.#s,this.#e=t.#e,this.#n=t.#n,this.#r=t.#r,this.#h=t.#h,this.v=t.v,this.T=t.T,this.S=t.S}A(...t){const i=this.T(t);arr[i]=this.#i,arr[i+1]=this.#e,arr[i+2]=this.#r,arr[i+3]=this.#s,arr[i+4]=this.#n,arr[i+5]=this.#h}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.T(t);arr[i]=this.#i*w,arr[i+1]=this.#e*h,arr[i+2]=this.#r+x*this.#i+y*this.#e,arr[i+3]=this.#s*w,arr[i+4]=this.#n*h,arr[i+5]=this.#h+x*this.#s+y*this.#n}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.T(t),s=this.#i,n=this.#s,r=this.#e,o=this.#n,u=this.#r,_=this.#h;arr[i]=s*a+r*b,arr[i+1]=s*c+r*d,arr[i+2]=s*e+r*f+u,arr[i+3]=n*a+o*b,arr[i+4]=n*c+o*d,arr[i+5]=n*e+o*f+_}drawv(t){const i=this.T(t);arr[i]=this.#i,arr[i+1]=this.#e,arr[i+2]=this.#r,arr[i+3]=this.#s,arr[i+4]=this.#n,arr[i+5]=this.#h}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.T(t);arr[i]=this.#i*w,arr[i+1]=this.#e*h,arr[i+2]=this.#r+x*this.#i+y*this.#e,arr[i+3]=this.#s*w,arr[i+4]=this.#n*h,arr[i+5]=this.#h+x*this.#s+y*this.#n}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.T(t),s=this.#i,n=this.#s,r=this.#e,o=this.#n,u=this.#r,_=this.#h;arr[i]=s*a+r*b,arr[i+1]=s*c+r*d,arr[i+2]=s*e+r*f+u,arr[i+3]=n*a+o*b,arr[i+4]=n*c+o*d,arr[i+5]=n*e+o*f+_}dup(){if(!i)return;const t=D.count;i+t>arr.length&&O();for(let s=i-t;s<i;s++)iarr[s+t]=iarr[s];arr[i]=this.#i,arr[i+1]=this.#e,arr[i+2]=this.#r,arr[i+3]=this.#s,arr[i+4]=this.#n,arr[i+5]=this.#h,i+=t}dupRect(x=0,y=0,w=1,h=1){if(!i)return;const t=D.count;i+t>arr.length&&O();for(let s=i-t;s<i;s++)iarr[s+t]=iarr[s];arr[i]=this.#i*w,arr[i+1]=this.#e*h,arr[i+2]=this.#r+x*this.#i+y*this.#e,arr[i+3]=this.#s*w,arr[i+4]=this.#n*h,arr[i+5]=this.#h+x*this.#s+y*this.#n,i+=t}dupMat(a=1,b=0,c=0,d=1,e=0,f=0){if(!i)return;const t=D.count;i+t>arr.length&&O();for(let s=i-t;s<i;s++)iarr[s+t]=iarr[s];const s=this.#i,n=this.#s,r=this.#e,o=this.#n,u=this.#r,_=this.#h;arr[i]=s*a+r*b,arr[i+1]=s*c+r*d,arr[i+2]=s*e+r*f+u,arr[i+3]=n*a+o*b,arr[i+4]=n*c+o*d,arr[i+5]=n*e+o*f+_,i+=t}}let M=285217039;function C(t,s){const n=t.p;let d=M^s;if(curt!=t&&(i&&A(),curt&&curt.p!=t.p&&(d|=240),P!=t._&&g.bindFramebuffer(36009,P=t._),g.viewport(0,0,t.w,t.h),curt=t),d){if(i&&A(),15&d&&g.colorMask(1&s,2&s,4&s,8&s),240&d)if(240&s){240&M||g.enable(2960),g.stencilMask(1<<n),g.stencilFunc(32&s?16&s?512:517:16&s?514:519,255,1<<n);const t=128&s?64&s?5386:7681:64&s?0:7680;g.stencilOp(t,t,t)}else 240&M&&g.disable(2960);1996488704&d&&g.blendEquationSeparate(32773+(s>>24&7),32773+(s>>28&7)),16776960&d&&g.blendFuncSeparate((s>>8&15)+766*!!(3584&s),(s>>16&15)+766*!!(917504&s),(s>>12&15)+766*!!(57344&s),(s>>20&15)+766*!!(14680064&s)),-2147483648&d&&(-2147483648&s?g.enable(32926):g.disable(32926)),M=s}}function A(){g.bufferData(34962,iarr.subarray(0,i),35040);const{type:t,start:s,length:l}=Y;if(tt+=i,i/=D.count,K++,Q+=i,g.drawArraysInstanced(t,s,l,i),i=0,boundUsed=shuniBind,rt.length){et??=rt[0];for(const f of rt)f.sync=g.fenceSync(37143,0),nt=nt?nt.next=f:f;rt.length=0}}$.Blend=T=(t=17,s=17,n=0,r=!1)=>t|n<<8|s<<16|r<<23,Object.assign(T,{REPLACE:1114129,DEFAULT:1135889,ADD:1118465,MULTIPLY:1122816,SUBTRACT:5574913,REVERSE_SUBTRACT:7737601,MIN:2232593,MAX:3346705,BEHIND:1118583,INVERT:1127321});let D=null,shfCount=0,shfMask=0,P=null;g.bindFramebuffer(36008,g.createFramebuffer());const j=g.createFramebuffer(),H=g.createBuffer();g.bindBuffer(34962,H);const V=r(32,g.getParameter(34930)),X=[];for(let i=V<<1;i-- >0;)X.push(null);function k(t=0,l=this.length-t,s=this.type){return{type:s,b:this.b,start:this.start+t,length:l,sub:k}}T=$.Geometry=(t,s)=>{if(3&s.length)throw"points.length is not a multiple of 4";if(!(s instanceof Float32Array)){const t=new Float32Array(s.length);t.set(s,0),s=t}const b=g.createBuffer();return g.bindBuffer(34962,b),g.bufferData(34962,s,35044),b.type=t,g.bindBuffer(34962,H),{type:t,b:b,start:0,length:s.length>>2,sub:k}};let boundUsed=0,Y=T.DEFAULT=T($.TRIANGLE_STRIP,[0,0,0,0,0,1,0,1,1,0,1,0,1,1,1,1]),shuniBind=0;T=$.Geometry3D=(t,s)=>{if(7&s.length)throw"points.length is not a multiple of 8";if(!(s instanceof Float32Array)){const t=new Float32Array(s.length);t.set(s,0),s=t}const b=g.createBuffer();return g.bindBuffer(34962,b),g.bufferData(34962,s,35044),b.type=t,g.bindBuffer(34962,H),{type:t,b:b,start:0,length:s.length>>3,sub:k}};const q=Y,W=(f,t,e)=>{let s="switch(u){";for(;t<e;)s+=`case ${t}:${f(t++)}`;return s+"}"},Z=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"],J=g.getParameter(34921);T=$.Shader=(t,{params:s,defaults:n,uniforms:u,uniformDefaults:_,outputs:p=4,intFrac:R=.5}={})=>{if(s="number"==typeof s?[s]:s||[],u="number"==typeof u?[u]:u||[],Object.freeze(n=void 0!==n?Array.isArray(n)?[...n]:[n]:[]),Object.freeze(_=void 0!==_?Array.isArray(_)?[..._]:[_]:[]),p="number"==typeof p?[p]:p||[],p.length>Drawable.MAX_TARGETS)throw`Too many shader outputs (Drawable.MAX_TARGETS == ${Drawable.MAX_TARGETS})`;const m=[],v=["",""],G=["#version 300 es\nprecision highp float;precision highp int;layout(location=0)in vec4 _pos;centroid out vec2 uv,xy;layout(location=1)in mat2x3 m;",""],E=["void main(){gl_PointSize=1.0;uv=_pos.zw;gl_Position=vec4((xy=vec3(_pos.xy,1.)*m)*2.-1.,0.,1.);"],T=["#version 300 es\nprecision highp float;precision highp int;centroid in vec2 uv,xy;\n#define color color0\n"+p.map((t,i)=>`layout(location=${i})out ${t?16==t||32==t?"u":"lowp ":""}vec4 color${i};`).join(";"),""];let B=6,S=0,O=0,N=0;const U=[3,3],M=[];let C=0;const D=t=>{const s=""+C>>2,n=3&C,r=3&(C+=t)||4;if(r<=n){const o=""+C>>2;G.push(`layout(location=${3+(C>>2)})in uvec4 a${o};flat out uvec4 GL_a${o};`),T.push(`flat in uvec4 GL_a${o};`),E.push(`GL_a${o}=a${o};`);let u=`uvec${t}(GL_a${s}.`;for(let i=n;i<4;i++)u+="xyzw"[i];u+=`,GL_a${o}.`;for(let i=0;i<r;i++)u+="xyzw"[i];return u+")"}if(4==r&&0==n)return"GL_a"+s;let o=`GL_a${s}.`;for(let i=n;i<r;i++)o+="xyzw"[i];return o};let P=0;for(const t of s){let c=1+(3&t),s=Z[3&t|t>>4<<2];const r=4==t||8==t||12==t;n[P]??=4==t?I:1==c?0:2==c?L:3==c?F:I,m.push(P+":a"+B+"=defaults["+P+"]");const A=t>15?(S|=1,"iarr[j+"):"arr[j+";if(20!=t&&24!=t&&28!=t||(s="int",S|=1<<(t>>2)-3,O++,M.push(`a${B}=(img.auto(a${B+(24==t?".t,-1":".t,0")})+1||(i&&A(b^boundUsed),img.auto(a${B+(24==t?".t,-1":".t,0")})+1))-1`)),12!=t&&28!=t||(S|=2),8!=t&&24!=t||(N++,O--),r){M.push(`let a${B+1}=${4==t?`-1;if(a${B}.t&&(a${B+1}=img.auto(a${B}.t,0))==-1)`:`img.auto(a${B+(8==t?".t,-1":".t,0")});if(a${B+1}==-1)`}{i&&A(b^boundUsed);a${B+1}=img.auto(a${B+(8==t?".t,-1":".t,0")})}`),O++;const s=D(1),n=D(2),r=D(2);for(T.push(`${4==t?"lowp ":8==t?"u":"highp "}vec4 arg${P}(vec2 uv){int v=int(${s});if(v<0)return vec4(uintBitsToFloat(${n}),uintBitsToFloat(${r}));return ${4==t?"g":8==t?"uG":"fG"}etColor(v&255,vec3(uv*uintBitsToFloat(${r})+uintBitsToFloat(${n}),v>>8));}`),S|=1<<1+(t>>2),U.push(17,4),v.push("iarr[j+"+B+"]=a"+(B+1)+"|a"+B+".l<<8"),c=0;++c<3;)v.push(A+(B+c)+"]=a"+B+"."+" xy"[c]);v.push(`if(a${B+1}>=0)${A+(B+3)}]=a${B}.w,${A+(B+4)}]=a${B}.h;else ${A+(B+3)}]=a${B}.z,${A+(B+4)}]=a${B}.w`),c=5}else{const s=D(c);if(T.push(`\n#define arg${P} ${Z[3&t|t>>4<<2]}(${s})\n`),1==c)v.push(A+B+"]=a"+B);else for(let t=0;t<c;t++)v.push(A+(B+t)+"]=a"+B+"."+"xyzw"[t])}B+=c,P++}P=0;let j=0;const X=[],k=[""],Y=[],J=[];let K=[];for(const t of u){let c=1+(3&t),s=Z[3&t|t>>4<<2];if(_[P]??=4==t?I:1==c?0:2==c?L:3==c?F:I,X.push("a"+j+"=uniformDefaults["+P+"]"),12!=t&&28!=t||(S|=2),8!=t&&24!=t||(N++,O--),20==t||24==t||28==t)S|=1<<(t>>2)-3,O++,Y.push(`g.uniform1i(uniLocs[${J.length}],s${K.length}?img.auto(s${K.length}${24==t?",-1":",0"}):${24==t?V:0})`),J.push("uni"+P),T.push("uniform int uni"+P+";"),k.push(`s${K.length}=a${j}.t`),K.push(`s${K.length}=null`);else if(4==t||8==t||12==t){const s="GL_u"+P,n="GL_U"+P;Y.push(`g.uniform1i(uniLocs[${J.length}],(s${K.length}?img.auto(s${K.length}${8==t?",-1":",0"}):${8==t?V:0})|s${K.length+1})`),O++,T.push(8==t?`uniform uint ${s};uniform uvec4 ${n}; ${4==t?"lowp ":8==t?"u":""}vec4 uni${P}(vec2 uv){if(${s}<0)return ${n};return ${4==t?"g":8==t?"uG":"fG"}etColor(${s}&255,vec3(uv*uintBitsToFloat(${n}.zw)+uintBitsToFloat(${n}.xy),${s}>>8));}`:`uniform uint ${s};uniform vec4 ${n}; ${4==t?"lowp ":8==t?"u":""}vec4 uni${P}(vec2 uv){if(${s}<0)return ${n};return ${4==t?"g":8==t?"uG":"fG"}etColor(${s}&255,vec3(uv*${n}.zw+${n}.xy,${s}>>8));}`),S|=1<<1+(t>>2),k.push(`s${K.length}=a${j}.t;s${K.length+1}=a${j}.l<<8;g.uniform4f(uniLocs[${J.length-1}],a${j}.x,a${j}.y,a${j}.w,a${j}.h)`),J.push(s,n),K.push(`s${K.length}=null,s${K.length+1}=0`)}else{T.push("uniform "+s+" uni"+P+";");let n=`g.uniform${c+(t<16?"f":t<32?"i":"ui")}(uniLocs[${J.length}]`;if(J.push("uni"+P),1==c)n+=",a"+j;else for(let t=-1;++t<c;)n+=",a"+j+"."+"xyzw"[t];k.push(n+")")}j+=c,P++}if(O+N>16)throw"Shaders cannot use more than 16 textures/colors";O=O?N?O+o(R*(V-O-N)):V:0,N=N&&V-O;let Q=null;T[1]=(20&S?"uniform "+(2&S?"highp":"lowp")+" sampler2DArray GL_f["+O+"];":"")+(8&S?"uniform highp usampler2DArray GL_i["+N+"];":"")+(4&S?`lowp vec4 getColor(int u,vec3 p){${Q=W(i=>"return texture(GL_f["+i+"],p);",0,O)}}`:"")+(16&S?`highp vec4 fGetColor(int u,vec3 p){${Q||W(i=>"return texture(GL_f["+i+"],p);",0,O)}}`:"")+(8&S?`uvec4 uGetColor(int u,vec3 p){${W(i=>"return texture(GL_i["+(i-V)+"],p);",V,2*V-O)}}`:""),T[1]+=(4&S?`lowp vec4 getPixel(int u,ivec3 p,int l){${Q=W(i=>"return texelFetch(GL_f["+i+"],p,l);",0,O)}}`:"")+(16&S?`highp vec4 fGetPixel(int u,ivec3 p,int l){${Q||W(i=>"return texelFetch(GL_f["+i+"],p,l);",0,O)}}`:"")+(8&S?`uvec4 uGetPixel(int u,ivec3 p,int l){${W(i=>"return texelFetch(GL_i["+(i-V)+"],p,l);",V,2*V-O)}}`:"")+(28&S?`ivec3 getSize(int u,int l){${W(i=>"return textureSize(GL_"+(i<O?"f["+i:"i["+(i-O))+"],l);",0,V)}}`:"");const tt=32-O&&-1>>>O;k[0]=`fd+=${j};i&&A();boundUsed=0;if(sh!=s){shfCount=${O};shfMask=${tt};g.useProgram(p);sh=s;g.bindVertexArray(vao)}`,v[0]=`setv(this.t,this._mask);if(sh!=s){i&&A();boundUsed=0;shfCount=${O};shfMask=${tt};g.useProgram(p);sh=s;g.bindVertexArray(vao);B()}if(shp!=this._shp){i&&A();shp=this._shp}if(geo!=this._shp.b){g.bindBuffer(34962,geo=this._shp.b);g.vertexAttribPointer(0,4,5126,0,0,0);g.bindBuffer(34962,buf)}const b=boundUsed^shuniBind;`+M.join(";")+";const j=i;if((i=j+"+B+")>arr.length)"+(ArrayBuffer.prototype.transfer?"arr=new Float32Array(arr.buffer.transfer(i*8)),iarr=new Int32Array(arr.buffer)":"{const oa=arr;(arr=new Float32Array(i*2)).set(oa,0);iarr=new Int32Array(arr.buffer)}"),v.push("return j");const{u:it,s:st}=eval(`let geo=defaultShape.b${K.length?","+K:""};function B(){${Y.join(";")};shuniBind=boundUsed};({u(${X}){${k.join(";")};B()},s({${m}}){${v.join(";")}}})`),et=g.createProgram();st.uniforms=it;const nt=g.createShader(35633),f=g.createShader(35632);E.push("}"),C&&(G[0]+="layout(location=3)in uvec4 a0;flat out uvec4 GL_a0;",T[0]+="flat in uvec4 GL_a0;"),g.shaderSource(nt,G.join("")+E.join("")),g.compileShader(nt),g.shaderSource(f,T.join("")+"\n"+t),g.compileShader(f),g.attachShader(et,nt),g.attachShader(et,f),(Q=g.getShaderInfoLog(f))&&console.warn("GLSL Error:\n"+Q),g.linkProgram(et),g.useProgram(et);const uniLocs=J.map(t=>g.getUniformLocation(et,t));for(let i=0;i<V;i++)g.uniform1i(g.getUniformLocation(et,i<O?"GL_f["+i+"]":"GL_i["+(i-O)+"]"),i>=O?V+i-O:i);st.count=B;const rt=g.createVertexArray();g.bindVertexArray(rt),g.bindBuffer(34962,q.b),g.enableVertexAttribArray(0),g.vertexAttribPointer(0,4,5126,0,0,0),g.bindBuffer(34962,H);for(let t=0;t<C;t+=4){const s=3+(t>>2);g.enableVertexAttribArray(s),g.vertexAttribIPointer(s,r(4,C-t),5125,B<<2,t<<2),g.vertexAttribDivisor(s,1)}return st};let K=0,Q=0,tt=0;T.UINT=T("void main(){color=arg0;}",{params:$.UVEC4,outputs:$.UINT}),T.BLACK=T("void main(){color=vec4(0,0,0,1);}"),T.DEFAULT=D=T("void main(){color=arg0(uv)*arg1;}",{params:[$.COLOR,$.VEC4],defaults:[void 0,$.vec4.one]}),$.flush=()=>{i&&A(),E?E=!1:v&&(g.bindBuffer(35051,null),g.deleteBuffer(v),v=null,G=-1);for(let i=0;i<V<<1;i++){const t=X[i];t&&(g.activeTexture(33984+i),g.bindTexture(35866,X[i]=null),t.i=-1)}};const it=$.ctx=new U(curt={_:null,p:0,$:null,w:0,h:0,u:0});$.setSize=(w=0,h=0)=>{g.canvas.width=w,g.canvas.height=h,it.t.w=g.drawingBufferWidth,it.t.h=g.drawingBufferHeight,curt==it.t&&(curt=null),it.t.p=0};const st=()=>{for(;et&&37145==g.getSyncParameter(et.sync,37140);)g.deleteSync(et.sync),et(),et=et.next;et||(nt=null,clearInterval(ht),ht=0)};let et=null,nt=null;const rt=[];$.wait=()=>new Promise(t=>{i?(t.sync=null,rt.push(t)):(t.sync=g.fenceSync(37143,0),et??=t,nt=nt?nt.next=t:t),ht||(ht=setInterval(st,0))});let ht=0;return $.loop=t=>("t"in $||($.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=.001*performance.now(),$.dt=0,$.timeToFrame=0,$.glLost??=null,requestAnimationFrame(function f(){if(requestAnimationFrame(f),g.isContextLost())return $.glLost?.(),$.glLost=et=nt=null;i&&A(),g.bindFramebuffer(36009,P=curt=null),it.t.p=0,dt=max(.001,r(-($.t-($.t=.001*performance.now())),.5)),it.reset();try{t()}finally{$.flush(),$.timeToFrame=.001*performance.now()-$.t,K||$.ctx.clear(),$.frameDrawCalls=K,$.frameSprites=Q,$.frameData=4*tt+24*K,K=Q=tt=0}})),$),$},Object.assign($.Gamma,{bitmapOpts:u,STENCIL:1,ALPHA_CHANNEL:2,PREMULTIPLIED_ALPHA:4,AUTO_CLEAR_BUFFER:8,MSAA:16})}