{const $=globalThis;Math.PI2??=2*Math.PI,Math.HALF_SQRT3??=.8660254037844386,Math.clamp??=(t,s,r)=>t<s?s:t>r?r:t;const{clz32:t,cos:s,sin:r,min:o,round:u}=Math;if(!("setImmediate"in $)){let t=0,s=0,r=[],n=new MessageChannel;n.port1.onmessage=()=>{const n=r[s];r[s++]=null,s>3&&s>r.length>>1&&(r.splice(0,s),t+=s,s=0),n?.()},n=n.port2,$.setImmediate=(s,...o)=>(n.postMessage(0),r.push(o.length?s.bind(void 0,...o):s),r.length-1+t),$.clearImmediate=i=>{(i-=t)===i>>>0&&(i>=r.length||(r[i]=null))}}if(!("sin"in $)){const t=Object.getOwnPropertyDescriptors(Math);delete t[Symbol.toStringTag],Object.defineProperties($,t)}const p={imageOrientation:"flipY",premultiplyAlpha:"premultiply"},v=(t,s,r)=>"string"==typeof t?fetch(t).then(a=>a.blob()).then(t=>createImageBitmap(t,p)).then(s,r):t instanceof Blob?createImageBitmap(t,p).then(s,r):s(t);$.Gamma=(p=document.createElement("canvas"),$={},m=15)=>{const _=$.gl=($.canvas=p).getContext("webgl2",{preserveDrawingBuffer:!(8&m),antialias:16&m,depth:!1,premultipliedAlpha:4&m,stencil:1&m,alpha:2&m});_.pixelStorei(37440,1),_.stencilMask(1),_.clearStencil(0),_.disable(2929),_.enable(3042),_.pixelStorei(3317,1),_.pixelStorei(3333,1);const A=_.createBuffer();_.bindBuffer(35052,A);let R=!0,g=null,G=-1,E=!1,T=285217039,$s=null,$v=null,L=0,B=0,$u=0,N=null,$X=0,$x=0,S=5,F=0,I=4,$p=null,O=0;_.bindFramebuffer(36008,_.createFramebuffer());const P=_.createFramebuffer(),$M=_.createBuffer();_.bindBuffer(34962,$M);const U=o(32,_.getParameter(34930)),j=[];for(let i=U<<1;i-- >0;)j.push(null);Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NEVER:48,UNSET:64,SET:128,FLIP:192,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:136,RGB_DST:8,ONE_MINUS_DST:153,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,ADD:17,RGB_ADD:1,A_ADD:16,SUB:85,RGB_SUB:5,A_SUB:80,SUB_REV:102,RGB_SUB_REV:6,A_SUB_REV:96,MIN:34,RGB_MIN:2,A_MIN:32,MAX:51,RGB_MAX:3,A_MAX:48,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:28,FTEXTURE:29,ITEXTURE:30,UTEXTURE:31,COLOR:12,FCOLOR:13,ICOLOR:14,UCOLOR:15,FLAT:64,CW_ONLY:16,CCW_ONLY:32,ANISOTROPY:128,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0}),$.Formats={R:[33321,6403,5121],RG:[33323,33319,5121],RGB:[32849,6407,5121],RGBA:[32856,6408,5121],RGB565:[36194,6407,33635],R11F_G11F_B10F:[35898,6407,35899],RGB5_A1:[32855,6408,32820],RGB10_A2:[32857,6408,33640],RGBA4:[32854,6408,32819],RGB9_E5:[35901,6407,35902],R8:[33330,36244,5121,1<<31],RG8:[33336,33320,5121,1<<31],RGB8:[36221,36248,5121,1<<31],RGBA8:[36220,36249,5121,1<<31],R16:[33332,36244,5123,1<<31],RG16:[33338,33320,5123,1<<31],RGB16:[36215,36248,5123,1<<31],RGBA16:[36214,36249,5123,1<<31],R32:[33334,36244,5125,1<<31],RG32:[33340,33320,5125,1<<31],RGB32:[36209,36248,5125,1<<31],RGBA32:[36208,36249,5125,1<<31],R16F:[33325,6403,5131],RG16F:[33327,33319,5131],RGB16F:[34843,6407,5131],RGBA16F:[34842,6408,5131],R16F_32F:[33325,6403,5126],RG16F_32F:[33327,33319,5126],RGB16F_32F:[34843,6407,5126],RGBA16F_32F:[34842,6408,5126],R32F:[33326,6403,5126],RG32F:[33328,33319,5126],RGB32F:[34837,6407,5126],RGBA32F:[34836,6408,5126]},$.vec2=(x=0,y=x)=>({x:x,y:y}),$.vec2.one=$.vec2(1);const C=$.vec2.zero=$.vec2(0);$.vec2.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b}:{x:a.x+b.x,y:a.y+b.y},$.vec2.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b}:{x:a.x*b.x,y:a.y*b.y},$.vec2.magnitude=a=>sqrt(a.x*a.x+a.y*a.y),$.vec2.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y);return{x:a.x*d,y:a.y*d}},$.vec3=(x=0,y=x,z=x)=>({x:x,y:y,z:z}),$.vec3.one=$.vec3(1);const M=$.vec3.zero=$.vec3(0);$.vec3.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z},$.vec3.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z},$.vec3.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z),$.vec3.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z);return{x:a.x*d,y:a.y*d,z:a.z*d}},$.vec4=(x=0,y=x,z=x,w=x)=>({x:x,y:y,z:z,w:w}),$.vec4.one=$.vec4(1);const D=$.vec4.zero=$.vec4(0);$.vec4.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b,w:a.w+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z,w:a.w+b.w},$.vec4.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b,w:a.w*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z,w:a.w*b.w},$.vec4.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w),$.vec4.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w);return{x:a.x*d,y:a.y*d,z:a.z*d,w:a.w*d}};const V=_.getExtension("EXT_texture_filter_anisotropic")?_.getParameter(34047):0;class $m{get isInteger(){return this.t.f.length>3}get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get mipmaps(){return this.t.m}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get identity(){return this.t}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,x=0,y=0,w=1,h=1,l=0){this.t=t,this.x=x,this.y=y,this.w=w,this.h=h,this.l=l}get loaded(){return!this.t.src}get waiting(){return!this.t.$}get then(){return this.t.src?this.#t:null}load(){this.t.$||$m.load(this.t)}sub(x=0,y=0,w=1,h=1,l=this.l){return new $m(this.t,this.x+x*this.w,this.y+y*this.h,this.w*w,this.h*h,l)}super(x=0,y=0,w=1,h=1,l=this.l){const t=this.w/w,s=this.h/h;return new $m(this.t,this.x-x*t,this.y-y*s,t,s,l)}crop(x=0,y=0,w=0,h=0,l=this.l){const{t:t,x:s,y:r,h:n}=this;if(!t.src)return new $m(t,s+x/t.w,r+n-(y+h)/t.h,w/t.w,h/t.h,l);const i=new $m(t,0,0,0,0,l);return t.$||$m.load(t),t.src.push(i=>{i.x=s+x/t.w,i.y=r+n-(y+h)/t.h,i.w=w/t.w,i.h=h/t.h},void 0,i),i}layer(l=this.l){return new $m(this.t,this.x,this.y,this.w,this.h,l)}#t(t,s){"function"!=typeof t&&(t=Function.prototype),this.t.src?(this.t.$||$m.load(this.t),this.t.src.push(t,s,this)):t(this)}static load(t){let s=t.src,r=0;t.src=[];let w=0,h=0;t.$=_.createTexture();const n=()=>{r=-1,$m.setOptions(t),_.texStorage3D(35866,t.m=1,t.f[0],t.w=w=1,t.h=h=1,t.d),R||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),R=!0),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const s=t.src;t.src=null;for(let i=1;i<s.length;i+=3)s[i]?.(s[i+1])};for(let i=0;i<s.length;i++)v(s[i],u=>{if(r){if(w!=u.width||h!=u.height)return n()}else w=u.width,h=u.height;if(s[i]=u,++r<s.length)return;$m.setOptions(t),_.texStorage3D(35866,t.m=o(t.m,floor(log2(max(w,h)))+1),t.f[0],t.w=w,t.h=h,t.d),R||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),R=!0),_.bindBuffer(35052,null);for(let l=0;l<r;l++)_.texSubImage3D(35866,0,0,0,l,w,h,1,t.f[1],t.f[2],s[l]);_.bindBuffer(35052,A),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const p=t.src;t.src=null;for(let i=0;i<p.length;i+=3)p[i](p[i+2])},n)}paste(t,x=0,y=0,l=0,s=0,r=0,n=0,o=0,u=0,p=0,m=0,g=0){const{t:G}=this;if(G.src)return null;if(t.msaa)return i&&draw(),p=u||t.height,u=o||t.width,_.framebufferRenderbuffer(36008,36064,36161,t.$),N!=P&&(_.bindFramebuffer(36009,N=P),curt=J=null),_.framebufferTextureLayer(36009,36064,G.$,s,l),_.blitFramebuffer(r,n,r+u,n+p,x,y,x+u,y+p,16384,9728),this;if(!(t instanceof $m))return v(t,i=>($m.fakeBind(G),R||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),R=!0),_.bindBuffer(35052,null),_.texSubImage3D(35866,s,x,y,l,i.width,i.height,1,G.f[1],G.f[2],i),_.bindBuffer(35052,A),G.i<0&&_.bindTexture(35866,null),this));const{t:E}=t;if(E.src)return console.warn("Source texture is not loaded"),this;if(G.$==E.$)return console.warn("Cannot copy from texture to itself"),this;for($m.fakeBind(G),u=u||E.w,p=p||E.h,m=m||E.d;m--;)_.framebufferTextureLayer(36008,36064,E.$,g,o++),_.copyTexSubImage3D(35866,s,x,y,l++,r,n,u,p);return G.i<0&&_.bindTexture(35866,null),this}pasteData(t,x=0,y=0,l=0,w=0,h=0,d=0,s=0){const{t:r}=this;return r.src?null:(w=w||r.w,h=h||r.h,d=d||r.d,$m.fakeBind(r),R&&(_.pixelStorei(37440,0),_.pixelStorei(37441,0),R=!1),_.bufferData(35052,t,35042),_.texSubImage3D(35866,s,x,y,l,w,h,d,r.f[1],r.f[2],0),ut+=.25*t.byteLength,r.i<0&&_.bindTexture(35866,null),this)}readData(x=0,y=0,l=0,w=0,h=0,d=0,t=0){const{t:s}=this;if(s.src)return null;w=w||s.w,h=h||s.h,d=d||s.d,i&&draw();let a=s.f[0],r=33323==a||33338==a||33340==a||33327==a||33328==a||33336==a?2:33321==a||33330==a||33332==a||33334==a||33325==a||33326==a?1:4,n=r<=2?1==r?6403:33319:3==r?6407:6408;a=s.f[2]==5121?1:s.f[2]==5126||s.f[2]==5125||s.f[2]==35899||s.f[2]==33640||s.f[2]==35902?4:2,r*=w*h;let o,u=r*d*a;for(G==u?(o=g,G=-1,E=!0):(_.bindBuffer(35051,o=_.createBuffer()),_.bufferData(35051,u,35041),u>G&&(G=u,g=o,E=!0));d--;)_.framebufferTextureLayer(36008,36064,s.$,t,l),_.readPixels(x,y,w,h,n,s.f[2],r*a*l++);return o!=g&&_.bindBuffer(35051,g),new Promise(t=>{const n=()=>{const $i=1==a?new Uint8Array(r*d):4==a?s.f[2]==5126?new Float32Array(r*d):new Uint32Array(r*d):new Uint16Array(r*d);o!=g&&_.bindBuffer(35051,o),_.getBufferSubData(35051,0,$i),t($i),o!=g&&(u>G?(G=u,g=o):_.bindBuffer(35051,g)),E=!0};n.sync=_.fenceSync(37143,0),_t??=n,yt=yt?yt.next=n:n,wt||(wt=setInterval($t,0))})}delete(){this.t.$&&(_.deleteTexture(this.t.$),this.t.$=null,this.t.i>=0&&(j[this.t.i]=null,this.t.i=-1),this.t.d=this.t.w=this.t.h=0)}static auto(s,i=0){if(s.f[3]>>31!=i)return-2;if(s.i>=0){const t=-2147483648>>>s.i-(U-L&i);if(!(t&(i^B)))return $X|=t,s.i;j[s.i]=null,s.i=-1}s.$||$m.load(s);const r=t(~($X|i^B));if(r>=U)return-1;$X|=-2147483648>>>r;const n=j[i=i?U+r-L:r];return n&&(n.i=-1),_.activeTexture(33984+i),_.bindTexture(35866,(j[i]=s).$),s.i=i}static fakeBind(t){if(t.i>=0)i&&draw(),_.activeTexture(33984+t.i);else{const s=U-1+(L==U&&U);j[s]&&(j[s].t.i=-1),_.activeTexture(33984+s),_.bindTexture(35866,t.$)}}get options(){return this.t.o}static setOptions(t){$m.fakeBind(t);const{o:s}=t;t.f[3]>>31?(_.texParameterf(35866,10240,9728),_.texParameterf(35866,10241,9728)):(_.texParameterf(35866,10240,9728+(1&s)),_.texParameterf(35866,10241,t.m>1?9984+(s>>1&3):9728+(s>>1&1))),_.texParameterf(35866,10242,8&s?10497:16&s?33648:33071),_.texParameterf(35866,10243,32&s?10497:64&s?33648:33071),V&&_.texParameterf(35866,34046,128&s?V:1)}set options(t){const{t:s}=this;s.o=t,s.src||($m.setOptions(s),s.i<0&&_.bindTexture(35866,null))}setMipmapRange(t=0,e=65535){const{t:s}=this;s.src||($m.fakeBind(s),_.texParameteri(35866,33082,t),_.texParameteri(35866,33083,e),s.i<0&&_.bindTexture(35866,null))}genMipmaps(){const{t:t}=this;t.m<2||($m.fakeBind(t),_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null))}}$.Drawable=(t=!1)=>new q({_:_.createFramebuffer(),p:0,T:t?_.createRenderbuffer():null,w:0,h:0,u:0}),$.Drawable.MAX_TARGETS=_.getParameter(36063);let $i=new Float32Array(1024),$I=new Int32Array($i.buffer),i=0;$.Texture=(w=0,h=0,d=1,t=0,f=Formats.RGBA,s=0)=>{s=o(s>>>0||1,floor(log2(max(w,h)))+1),w>>>=0,h>>>=0;const r={$:_.createTexture(),i:-1,o:t,f:f,src:null,w:w,h:h,d:d=d>>>0||1,m:s},n=new $m(r);return $m.setOptions(r),w&&h?_.texStorage3D(35866,s,r.f[0],w,h,d):_.texStorage3D(35866,1,r.f[0],r.w=1,r.h=1,d),_.bindTexture(35866,null),n},$.Texture.MAX_WIDTH=$.Texture.MAX_HEIGHT=_.getParameter(3379),$.Texture.MAX_LAYERS=_.getParameter(35071),$.Texture.FILTER_32F=!!_.getExtension("OES_texture_float_linear");const k=$.Texture.MAX_MSAA=_.getParameter(36183);$.Texture.MSAA=(w=0,h=0,t=65536,f=Formats.RGBA)=>{t=o(t,k);const s=_.createRenderbuffer();return _.bindRenderbuffer(36161,s),_.renderbufferStorageMultisample(36161,t,f[0],w,h),{$:s,width:w,height:h,msaa:_.getRenderbufferParameter(36161,36011),delete(){_.deleteRenderbuffer(this.$)}}},$.Texture.from=(t,s=0,r=Formats.RGBA,n=0)=>new $m({$:null,i:-1,o:s,f:r,src:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:t?Array.isArray(t)?t.length:1:0,m:n||1});class H{constructor(a=1,b=0,c=0,d=1,e=0,f=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f}translate(x=0,y=0){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d}=this;this.a=a*n-c*o,this.b=b*n-d*o,this.c=a*o+c*n,this.d=b*o+d*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d;this.a=t*a+r*b,this.b=s*a+n*b,this.c=t*c+r*d,this.d=s*c+n*d,this.e+=t*e+r*f,this.f+=s*e+n*f}skew(x=0,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a+c*y,this.b=b+d*y,this.c=c+a*x,this.d=d+b*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a*x+c*y,this.b=b*x+d*y,this.c=c*x-a*y,this.d=d*x-b*y}box(x=0,y=0,w=1,h=w){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d,this.a*=w,this.b*=w,this.c*=h,this.d*=h}to(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y+this.e,y:this.b*x+this.d*y+this.f}}from(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:((x-=this.e)*d-(y-=this.f)*c)*t,y:(y*a-x*b)*t}}toDelta(t=0,s=0){return"object"==typeof t&&({x:t,y:s}=t),{x:this.a*t+this.c*s,y:this.b*t+this.d*s}}fromDelta(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:(x*d-y*c)*t,y:(y*a-x*b)*t}}determinant(){return this.a*this.d-this.b*this.c}}class X{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i}translate(x=0,y=0){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*n-d*o,this.b=b*n-e*o,this.c=c*n-f*o,this.d=a*o+d*n,this.e=b*o+e*n,this.f=c*o+f*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d,o=this.e,u=this.f;this.a=t*a+n*b,this.b=s*a+o*b,this.c=r*a+u*b,this.d=t*c+n*d,this.e=s*c+o*d,this.f=r*c+u*d,this.g+=t*e+n*f,this.h+=s*e+o*f,this.i+=r*e+u*f}skew(x=0,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a+d*y,this.b=b+e*y,this.c=c+f*y,this.d=d+a*x,this.e=e+b*x,this.f=f+c*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*x-d*y,this.b=b*x-e*y,this.c=c*x-f*y,this.d=a*y+d*x,this.d=b*y+e*x,this.f=c*y+f*x}box(x=0,y=0,w=1,h=w){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h}}class Y{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l}translate(x=0,y=0,z=0){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y,this.g*=z,this.h*=z,this.i*=z}rotateXZ(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,g:u,h:h,i:i}=this;this.a=o*a-n*u,this.g=o*u+n*a,this.b=o*b-n*h,this.h=o*h+n*b,this.c=o*c-n*i,this.i=o*i+n*c}rotateXY(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=o*a-n*d,this.d=o*d+n*a,this.b=o*b-n*e,this.e=o*e+n*b,this.c=o*c-n*f,this.f=o*f+n*c}rotateZY(t){let n=r(t),o=s(t);const{d:d,e:e,f:f,g:u,h:h,i:i}=this;this.g=o*u-n*d,this.d=o*d+n*u,this.h=o*h-n*e,this.e=o*e+n*h,this.i=o*i-n*f,this.f=o*f+n*i}transform(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=this.a,o=this.b,u=this.c,p=this.d,v=this.e,m=this.f,A=this.g,R=this.h,g=this.i;this.a=n*a+p*b+A*c,this.b=o*a+v*b+R*c,this.c=u*a+m*b+g*c,this.d=n*d+p*e+A*f,this.e=o*d+v*e+R*f,this.f=u*d+m*e+g*f,this.g=n*t+p*h+A*i,this.h=o*t+v*h+R*i,this.i=u*t+m*h+g*i,this.j+=n*s+p*r+A*l,this.k+=o*s+v*r+R*l,this.l+=u*s+m*r+g*l}box(x=0,y=0,z=0,w=1,h=w,d=w){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h,this.g*=d,this.h*=d,this.i*=d}to(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z+this.j)*t,y:(this.b*x+this.e*y+this.h*z+this.k)*t})}from(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;x-=this.j,y-=this.k;const z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}toDelta(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z)*t,y:(this.b*x+this.e*y+this.h*z)*t})}fromDelta(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}determinant(){const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;return a*(e*i-f*h)-d*(h*c-i*b)+t*(b*f-c*e)}origin(){const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=this,n=e*i-f*h,o=c*h-b*i,u=b*f-c*e,p=-1/(a*n+d*o+t*u);return{x:(n*s+(t*f-i*d)*r+(d*h-e*t)*l)*p,y:(o*s+(a*i-c*t)*r+(t*b-h*a)*l)*p,z:(u*s+(d*c-f*a)*r+(a*e-b*d)*l)*p}}ray(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=this,n=e*i-f*h,o=c*h-b*i,u=b*f-c*e,p=1/(a*n+d*o+t*u),v=t*f-i*d,m=d*h-e*t,A=-(n*s+v*r+m*l)*p,R=-(o*s+(a*i-c*t)*r+(t*b-h*a)*l)*p,g=-(u*s+(d*c-f*a)*r+(a*e-b*d)*l)*p,z=1-this.l,G=(n*x+v*y+m*z)*p,E=(n*x+v*y+m*z)*p,T=(n*x+v*y+m*z)*p,L=1/sqrt(G*G+E*E+T*T);return{origin:{x:A,y:R,z:g},direction:{x:G*L,y:E*L,z:T*L}}}}const $G=ArrayBuffer.prototype.transfer?t=>{const s=i;return(i=s+t)>$i.length&&($i=new Float32Array($i.buffer.transfer(8*i)),$I=new Int32Array($i.buffer)),s}:t=>{const s=i;if((i=s+t)>$i.length){const t=$i;($i=new Float32Array(2*i)).set(t,0),$I=new Int32Array($i.buffer)}return s};class q extends H{set shader($s){this.N="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,J==this&&(J=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||nt,J==this&&(J=null)}constructor(t,s=290787599,r=nt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.M=s,this.S=r,this.N=n}pixelRatio(){return sqrt(abs(this.a*this.d-this.b*this.c)*this.t.w*this.t.h)}sub(){return new q(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f)}sub3dProj(t=0,s=1){return new W(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,0,this.c,this.d,0,this.e*s,this.f*s,s,this.e*t,this.f*t,t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.M=290787599,this.N=$.Shader.DEFAULT,this.S=nt}draw(...t){const i=this.N(6,t);$i[i]=this.a,$i[i+1]=this.c,$i[i+2]=this.e,$i[i+3]=this.b,$i[i+4]=this.d,$i[i+5]=this.f}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.N(6,t);$i[i]=this.a*w,$i[i+1]=this.c*h,$i[i+2]=this.e+x*this.a+y*this.c,$i[i+3]=this.b*w,$i[i+4]=this.d*h,$i[i+5]=this.f+x*this.b+y*this.d}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.N(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*a+n*b,$i[i+1]=s*c+n*d,$i[i+2]=s*e+n*f+u,$i[i+3]=r*a+o*b,$i[i+4]=r*c+o*d,$i[i+5]=r*e+o*f+p}drawv(t){const i=this.N(6,t);$i[i]=this.a,$i[i+1]=this.c,$i[i+2]=this.e,$i[i+3]=this.b,$i[i+4]=this.d,$i[i+5]=this.f}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.N(6,t);$i[i]=this.a*w,$i[i+1]=this.c*h,$i[i+2]=this.e+x*this.a+y*this.c,$i[i+3]=this.b*w,$i[i+4]=this.d*h,$i[i+5]=this.f+x*this.b+y*this.d}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.N(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*a+n*b,$i[i+1]=s*c+n*d,$i[i+2]=s*e+n*f+u,$i[i+3]=r*a+o*b,$i[i+4]=r*c+o*d,$i[i+5]=r*e+o*f+p}}class Z extends X{set shader($s){this.N="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,J==this&&(J=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||nt,J==this&&(J=null)}constructor(t,s=290787599,r=nt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=0){super(a,b,c,d,e,f,o,h,i),this.t=t,this.M=s,this.S=r,this.N=n}pixelRatio(){const{i:i}=this,t=(this.a*i-this.g*this.c)*(this.e*i-this.h*this.f)-(this.d*i-this.g*this.f)*(this.b*i-this.h*this.c);return sqrt(abs(t)*this.t.w*this.t.h)/(i*i)}to(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);let t=this.c*x+this.f*y+this.i;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g)*t,y:(this.b*x+this.e*y+this.h)*t})}from(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f}=this;return{x:NaN,y:NaN}}toDelta(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);let i=this.i,t=this.c*x+this.f*y+this.i;return i<=0||t<=0?{x:NaN,y:NaN}:(i=1/i,t=1/t,{x:(this.g+this.a*x+this.d*y)*t-this.g*i,y:(this.h+this.b*x+this.e*y)*t-this.h*i})}fromDelta(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f}=this;return{x:NaN,y:NaN}}sub(){return new Z(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}sub3dProj(t=0,s=1){return new W(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,this.g*s,this.h*s,this.i*s,this.g*t,this.h*t,this.i*t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.M=290787599,this.N=$.Shader.DEFAULT,this.S=nt}draw(...t){const i=this.N(9,t);$i[i]=this.a,$i[i+1]=this.d,$i[i+2]=this.g,$i[i+3]=this.b,$i[i+4]=this.e,$i[i+5]=this.h,$i[i+6]=this.c,$i[i+7]=this.f,$i[i+8]=this.i}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.N(9,t);$i[i]=this.a*w,$i[i+1]=this.d*h,$i[i+2]=this.g+x*this.a+y*this.d,$i[i+3]=this.b*w,$i[i+4]=this.e*h,$i[i+5]=this.h+x*this.b+y*this.e,$i[i+6]=this.c*w,$i[i+7]=this.f*h,$i[i+8]=this.i+x*this.c+y*this.f}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.N(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,v=this.g,m=this.h,A=this.i;$i[i]=s*a+o*b,$i[i+1]=s*c+o*d,$i[i+2]=s*e+o*f+v,$i[i+3]=r*a+u*b,$i[i+4]=r*c+u*d,$i[i+5]=r*e+u*f+m,$i[i+6]=n*a+p*b,$i[i+7]=n*c+p*d,$i[i+8]=n*e+p*f+A}drawv(t){const i=this.N(9,t);$i[i]=this.a,$i[i+1]=this.d,$i[i+2]=this.g,$i[i+3]=this.b,$i[i+4]=this.e,$i[i+5]=this.h,$i[i+6]=this.c,$i[i+7]=this.f,$i[i+8]=this.i}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.N(9,t);$i[i]=this.a*w,$i[i+1]=this.d*h,$i[i+2]=this.g+x*this.a+y*this.d,$i[i+3]=this.b*w,$i[i+4]=this.e*h,$i[i+5]=this.h+x*this.b+y*this.e,$i[i+6]=this.c*w,$i[i+7]=this.f*h,$i[i+8]=this.i+x*this.c+y*this.f}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.N(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,v=this.g,m=this.h,A=this.i;$i[i]=s*a+o*b,$i[i+1]=s*c+o*d,$i[i+2]=s*e+o*f+v,$i[i+3]=r*a+u*b,$i[i+4]=r*c+u*d,$i[i+5]=r*e+u*f+m,$i[i+6]=n*a+p*b,$i[i+7]=n*c+p*d,$i[i+8]=n*e+p*f+A}}class W extends Y{set shader($s){this.N="function"==typeof $s&&!0===$s.three?$s:$.Shader.COLOR_3D_XZ,J==this&&(J=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||ot,J==this&&(J=null)}constructor(t,s=290787599,r=ot,n=$.Shader.COLOR_3D_XZ,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.M=s,this.S=r,this.N=n}sub(){return new W(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}sub2dXY(){return new Z(this.t,this.M,nt,$.Shader.DEFAULT,this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dZY(){return new Z(this.t,this.M,nt,$.Shader.DEFAULT,this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(){return new Z(this.t,this.M,nt,$.Shader.DEFAULT,this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.j=t.j,this.k=t.k,this.l=t.l,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l,this.M=290787599,this.N=$.Shader.COLOR_3D_XZ,this.S=ot}draw(...t){const s=this.N(12,t);$i[s]=this.a,$i[s+1]=this.d,$i[s+2]=this.g,$i[s+3]=this.j,$i[s+4]=this.b,$i[s+5]=this.e,$i[s+6]=this.h,$i[s+7]=this.k,$i[s+8]=this.c,$i[s+9]=this.f,$i[s+10]=this.i,$i[s+11]=this.l}drawCube(x=0,y=0,z=0,t=1,s=1,r=1,...n){const o=this.N(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=a*t,$i[o+1]=d*s,$i[o+2]=u*r,$i[o+3]=this.j+x*a+y*d+z*u,$i[o+4]=b*t,$i[o+5]=e*s,$i[o+6]=h*r,$i[o+7]=this.k+x*b+y*e+z*h,$i[o+8]=c*t,$i[o+9]=f*s,$i[o+10]=i*r,$i[o+11]=this.l+x*c+y*f+z*i}drawMat(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,...n){const o=this.N(12,n),u=this.a,p=this.b,v=this.c,m=this.d,A=this.e,R=this.f,g=this.g,G=this.h,E=this.i;$i[o]=u*a+m*b+g*c,$i[o+1]=u*d+m*e+g*f,$i[o+2]=u*t+m*h+g*i,$i[o+3]=this.j+u*s+m*r+g*l,$i[o+4]=p*a+A*b+G*c,$i[o+5]=p*d+A*e+G*f,$i[o+6]=p*t+A*h+G*i,$i[o+7]=this.k+p*s+A*r+G*l,$i[o+8]=v*a+R*b+E*c,$i[o+9]=v*d+R*e+E*f,$i[o+10]=v*t+R*h+E*i,$i[o+11]=this.l+v*s+R*r+E*l}drawv(t){const s=this.N(12,t);$i[s]=this.a,$i[s+1]=this.d,$i[s+2]=this.g,$i[s+3]=this.j,$i[s+4]=this.b,$i[s+5]=this.e,$i[s+6]=this.h,$i[s+7]=this.k,$i[s+8]=this.c,$i[s+9]=this.f,$i[s+10]=this.i,$i[s+11]=this.l}drawCubev(x=0,y=0,z=0,t=1,s=1,r=1,n){const o=this.N(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=a*t,$i[o+1]=d*s,$i[o+2]=u*r,$i[o+3]=this.j+x*a+y*d+z*u,$i[o+4]=b*t,$i[o+5]=e*s,$i[o+6]=h*r,$i[o+7]=this.k+x*b+y*e+z*h,$i[o+8]=c*t,$i[o+9]=f*s,$i[o+10]=i*r,$i[o+11]=this.l+x*c+y*f+z*i}drawMatv(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,n){const o=this.N(12,n),u=this.a,p=this.b,v=this.c,m=this.d,A=this.e,R=this.f,g=this.g,G=this.h,E=this.i;$i[o]=u*a+m*b+g*c,$i[o+1]=u*d+m*e+g*f,$i[o+2]=u*t+m*h+g*i,$i[o+3]=this.j+u*s+m*r+g*l,$i[o+4]=p*a+A*b+G*c,$i[o+5]=p*d+A*e+G*f,$i[o+6]=p*t+A*h+G*i,$i[o+7]=this.k+p*s+A*r+G*l,$i[o+8]=v*a+R*b+E*c,$i[o+9]=v*d+R*e+E*f,$i[o+10]=v*t+R*h+E*i,$i[o+11]=this.l+v*s+R*r+E*l}}const x=Object.getOwnPropertyDescriptors({get width(){return this.t.w},get height(){return this.t.h},get identity(){return this.t},set mask(t){this.M=-256&this.M|255&t,J==this&&(J=null)},get mask(){return 255&this.M},set blend(b){this.M=255&this.M|(b||1135889)<<8,J==this&&(J=null)},get blend(){return this.M>>8},V(){if(J==this)return!1;const{t:t,M:s}=this,r=t.p;let d=T^s;if(curt!=t&&(i&&draw(),curt&&curt.p==t.p||(d|=240),N!=t._&&_.bindFramebuffer(36009,N=t._),_.viewport(0,0,t.w,t.h),curt=t),d){if(i&&draw(),15&d&&_.colorMask(1&s,2&s,4&s,8&s),240&d)if(240&s){240&T||_.enable(2960),_.stencilMask(1<<r),_.stencilFunc(32&s?16&s?512:517:16&s?514:519,255,1<<r);const t=128&s?64&s?5386:7681:64&s?0:7680;_.stencilOp(t,t,t)}else 240&T&&_.disable(2960);1996488704&d&&_.blendEquationSeparate(32773+(s>>24&7),32773+(s>>28&7)),16776960&d&&_.blendFuncSeparate((s>>8&15)+766*!!(3584&s),(s>>16&15)+766*!!(917504&s),(s>>12&15)+766*!!(57344&s),(s>>20&15)+766*!!(14680064&s)),-2147483648&d&&(-2147483648&s?_.enable(32926):_.disable(32926)),T=s}return J=this,!0},setTarget(t=0,s=null,l=0,r=0){const{t:n}=this;if(n._){if(i&&draw(),J==this&&(J=null),N!=n._&&(_.bindFramebuffer(36009,N=n._),curt=J=null),!s){if(!n.u)return;return _.framebufferRenderbuffer(36009,36064+t,36161,null),void((n.u&=~(1<<t))||(n.w=n.h=0,_.framebufferRenderbuffer(36009,36128,36161,null)))}if((n.u&=~(1<<t))||(n.w=n.h=0),n.w){if(n.w!=s.width||n.h!=s.height)return}else n.w=s.width,n.h=s.height,n.T&&(_.bindRenderbuffer(36161,n.T),_.renderbufferStorage(36161,36168,n.w,n.h),_.framebufferRenderbuffer(36009,36128,36161,n.T));n.u|=1<<t,s.msaa?_.framebufferRenderbuffer(36009,36064+t,36161,s.$):_.framebufferTextureLayer(36009,36064+t,s.t.$,l,r)}},clearTargets(){const{t:s}=this;if(!s._)return;i&&draw(),J==this&&(J=null);let r=s.u;if(s.u=s.w=s.h=0,s.T&&(_.framebufferRenderbuffer(36009,36128,36161,null),_.deleteRenderbuffer(s.T),s.T=_.createRenderbuffer()),r)for(N!=s._&&(_.bindFramebuffer(36009,N=s._),curt=J=null);r;){const s=31-t(r);r&=~(1<<s),_.framebufferRenderbuffer(36009,36064+s,36161,null)}},get hasStencil(){return this.t._?!!this.t.T:!!(1&m)},set hasStencil(t){let{t:s}=this,b=s.T;s._&&!t!=!b&&(i&&draw(),J==this&&(J=null),s.T=b=b?(_.deleteRenderbuffer(b),null):_.createRenderbuffer(),s.w&&(N!=s._&&(_.bindFramebuffer(36009,N=s._),curt=J=null),b?(_.bindRenderbuffer(36161,b),_.renderbufferStorage(36161,36168,s.w,s.h),_.framebufferRenderbuffer(36009,36128,36161,b)):_.framebufferRenderbuffer(36009,36128,36161,null)))},clear(t=0,s=t,b=t,a=s){"object"==typeof t&&(a=t.w??0,b=t.z??0,s=t.y,t=t.x),i&&draw(),this.V()&&(J=null),_.clearColor(t,s,b,a);const r=this.t.p=this.t.p+1&7;_.clear(r?16384:(_.stencilMask(255),17408)),at++,_.disable(2960),T&=-241},clearStencil(){i&&draw(),this.V()&&(J=null);(this.t.p=this.t.p+1&7)||(_.stencilMask(255),_.clear(1024)),_.disable(2960),T&=-241},projection:!1});Object.defineProperties(q.prototype,x),Object.defineProperties(W.prototype,x),Object.defineProperties(Z.prototype,x),W.prototype.projection=Z.prototype.projection=!0,Object.assign($.Blend=(t=17,s=17,r=0,n=!1)=>t|r<<8|s<<16|n<<23,{REPLACE:1114129,DEFAULT:1135889,ADD:1118465,MULTIPLY:1122816,MULTIPLY_MIX:1136008,SUBTRACT:5574913,REVERSE_SUBTRACT:7737601,MIN:2232593,MAX:3346705,BEHIND:1118583,INVERT:1127321});let J=null;function draw(b=$x){if(_.bufferData(34962,$I.subarray(0,i),35040),ut+=i,i/=$u,at++,lt+=i,O?_.drawElementsInstanced(7&S,I,O,F,i):_.drawArraysInstanced(7&S,F,I,i),i=0,$X=b,pt.length){_t??=pt[0];for(const f of pt)f.sync=_.fenceSync(37143,0),yt=yt?yt.next=f:f;pt.length=0}}const K=(f,t,e)=>{let s="switch(u){";for(;t<e;)s+=`case ${t}:${f(t++)}`;return s+"}"},Q=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"],tt=_.getParameter(34921);function $H(t,s,r,c){$s=t,L=s,B=r,$u=c}function $l(t){_.bindVertexArray($v=t)}const $C=new Float32Array(4),$c=new Int32Array($C.buffer),st=(t,s,$D=[])=>{s="number"==typeof s?[s]:s||[];let r=0;const n=[],o=[],u=[],p=[],v=[""];let m=2+t,A=0,R=2+t,g=2+t;for(const t of s){if((15&t)>=12)throw"Vertex parameter cannot be a texture";const s=1+(3&t),G=Q[3&t|(t>>4&15)<<2],E=t>15;$D[r]??=1==s?0:2==s?C:3==s?M:D,p.push(`${r}:a${r}=$D[${r}]`);const T=(63&t)>13?"$I[i+":"$i[i+";if(1==s)v.push(T+g+"]=a"+r);else for(let t=0;t<s;t++)fnBody.push(T+(g+t)+"]=a"+r+"."+"xyzw"[t]);const L=""+(m>>2),B=3&m,N=3&(m+=s)||4;let S=E?A:R;const F=3&S,I=3&(S+=s)||4;E?A=S:R=S;let O="";if(N<=(B||4)){const t=(m>>2)-(s==4+B);o.push(`layout(location=${tt-1-t})in uvec4 o${t};`)}O=N<=B?`uvec${s}(o${L}.${"xyzw".slice(B,4)},o${m>>2}.${"xyzw".slice(0,N)})`:4==N&&0==B?"v"+L:`o${L}.`+"xyzw".slice(B,N),E||(O=`uintBitsToFloat(${O})`);const P=`GL_${E?"V":"v"}${L}.`;if(I<=(F||4)&&o.push(`${E?"flat out u":"out "}vec4 ${(E?"GL_V":"GL_v")+((S>>2)-!(s==4+F))};`),I<=F){const o=(E?"GL_V":"GL_v")+(S>>2),p=`${E?"u":""}vec${s}(${P+"xyzw".slice(F)},${P+"xyzw".slice(0,I)})`;n.push(`${E?"flat in u":"in "}vec4 ${o};\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${p})`:p}\n`),u.push(`${G} t${r}=${O};${P+"xyzw".slice(F,I)}=t${r}.${"xyzw".slice(0,4-F)};${o}.${"xyzw".slice(0,I)}=t${r}.${"xyzw".slice(4-F,s)};`)}else{const s=P+"xyzw".slice(F,I);n.push(`\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${s})`:s}\n`),u.push(`${P+"xyzw".slice(F,I)}=${O};`)}g+=s,r++}v[0]=`let{i,$i,$I}=this;if((this.i=i+${g})>$i.length){${ArrayBuffer.prototype.transfer?`$i=this.$i=new Float32Array($i.buffer.transfer(i+${g}<<3))`:`const oa=$i;$i=this.$i=new Float32Array(i+${g}<<1);$i.set(oa,0)`};$I=this.$I=new Int32Array($i.buffer)}`,v.push("return i"),A&&(o.push("flat out uvec4 GL_V0;"),n.push("flat in uvec4 GL_V0;"));const G=eval(`(function({${p}}){${v.join(";")}})`);return{three:t,S:G,F:g,fsh:n.join(""),vsh:o.join(""),vshb:u.join("")}};class it extends H{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.I=s,this.O=r,this.P=n,t.b.for=t}sub(t=this.t.U,s=0,r=this.P){return new it(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f)}addPoint(x,y,...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.U++}add(...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.U++}addPointv(x,y,t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.U++}addv(t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.U++}}$M.for="main";class ht extends Y{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.I=s,this.O=r,this.P=n,t.b.for=t}sub(t=this.t.U,s=0,r=this.P){return new ht(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}addPoint(x,y,z,...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.U++}add(...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.U++}addPointv(x,y,z,t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.U++}addv(t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.U++}}const y=Object.getOwnPropertyDescriptors({get size(){return this.t.U},get uploadCount(){return this.t.C},S(){const{t:t}=this;i&&draw(),$p=this;const s=S>>4,r=(S=this.P)>>4;s!=r&&(r?(s||_.enable(2884),_.frontFace(2304+(r>>1))):_.disable(2884)),F=this.I,I=this.O,O=t.M},get end(){return this.I+this.O},set end(a){(a>>>=0)>=this.I?this.O=a-this.I:(this.O=this.I-a,this.I=a),$p==this&&this.S()},get start(){return this.I},set start(a){this.I=a>>>0,$p==this&&(i&&draw(),F=this.I)},get length(){return this.O},set length(a){this.O=a>>>0,$p==this&&(i&&draw(),I=this.O)},get type(){return this.P},set type(a){this.P=63&a,$p==this&&this.S()},get identity(){return this.t},upload(t=null){const{t:s}=this;if($p&&s==$p.t&&i&&draw(),t){let r=0;if(Array.isArray(t)){let s=0;for(const r of t)r>s&&(s=r);const $M=s>254?s>65534?new Uint32Array(t.length):new Uint16Array(t.length):new Uint8Array(t.length);$M.set(t,0),t=$M}if(r=5121+(262656>>(t.BYTES_PER_ELEMENT<<2)&15),s.M=r,_.bindVertexArray(s.v),_.bindBuffer(34963,s.E??=_.createBuffer()),_.bufferData(34963,t,35044),s.v){if(!s.Ls){s.Ls=1,_.bindBuffer(34962,s.b);const t=tt-(s.F+3>>2);for(let i=tt-1,r=0;i>=t;i--,r+=16)_.enableVertexAttribArray(i),_.vertexAttribIPointer(i,i==t?3&s.F:4,5125,s.F<<2,r);_.bindBuffer(34962,$M)}}else _.bindBuffer(34963,null);_.bindVertexArray($v)}else{if(s.v){if(_.bindVertexArray(s.v),!s.Ls){s.Ls=1,_.bindBuffer(34962,s.b);const t=tt-(s.F+3>>2);for(let i=tt-1,r=0;i>=t;i--,r+=16)_.enableVertexAttribArray(i),_.vertexAttribIPointer(i,i==t?3&s.F:4,5125,s.F<<2,r);_.bindBuffer(34962,$M)}s.E&&_.bindBuffer(34963,null),_.bindVertexArray($v)}s.M=0,s.E&&(s.E.delete(),s.E=null)}$p&&$p.t==s&&(O=s.M),_.bindBuffer(34962,s.b),_.bufferData(34962,s.$I.subarray(0,s.i),35044),_.bindBuffer(34962,$M),s.$i=et,s.$I=rt,s.i=0,s.C=this.O=t?t.length:s.U,s.U=0,$p&&s==$p.t&&this.S()}}),et=new Float32Array,rt=new Int32Array(et.buffer);Object.defineProperties(it.prototype,y),Object.defineProperties(ht.prototype,y),$.Geometry2D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{S:r,F:n}=t??$.Geometry2D.DEFAULT_VERTEX,$i=new Float32Array(16);return new it({$i:$i,$I:new Int32Array($i.buffer),i:0,b:_.createBuffer(),S:r,F:n,U:0,C:0,v:null,E:null,M:0},0,0,s)},$.Geometry3D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{S:r,F:n}=t??$.Geometry3D.DEFAULT_VERTEX,$i=new Float32Array(16);return new ht({$i:$i,$I:new Int32Array($i.buffer),i:0,b:_.createBuffer(),S:r,F:n,U:0,C:0,v:_.createVertexArray(),L:null,Ls:0,E:null,M:0},0,0,s)},$.Geometry2D.Vertex=st.bind(null,!1),$.Geometry3D.Vertex=st.bind(null,!0);const nt=$.Geometry2D.SQUARE=$.Geometry2D($.Geometry2D.DEFAULT_VERTEX=st(!1,[]),5),ot=$.Geometry3D.CUBE=$.Geometry3D($.Geometry3D.DEFAULT_VERTEX=st(!0,[]),21);for(let i=0;i<4;i++)nt.addPoint(1&i,i>>1&1),ot.addPoint(0,1&i,i>>1&1),ot.addPoint(1,1&i,i>>1&1);nt.upload(),ot.upload(new Uint8Array([4,6,0,2,3,6,7,4,5,0,1,3,5,7])),$.Geometry3D.INSIDE_CUBE=ot.sub(0,14,37),$.Geometry3D.XZ_FACE=ot.sub(7,4,21),$.Shader=(t,{params:s,defaults:$D,uniforms:r,uniformDefaults:$U,outputs:p=4,vertex:v=$.Geometry2D.DEFAULT_VERTEX,intFrac:m=.5}={})=>{if(s="number"==typeof s?[s]:s||[],r="number"==typeof r?[r]:r||[],$D=void 0!==$D?Array.isArray($D)?[...$D]:[$D]:[],$U=void 0!==$U?Array.isArray($U)?[...$U]:[$U]:[],p="number"==typeof p?[p]:p||[],p.length>Drawable.MAX_TARGETS)throw`Too many shader outputs (Drawable.MAX_TARGETS == ${Drawable.MAX_TARGETS})`;const A=3+v.three,R=[],g=[""],G=[`#version 300 es\nprecision highp float;precision highp int;layout(location=0)in mat3x${A} m;layout(location=${tt-1})in uvec4 o0;out vec4 GL_v0;`],E=[`void main(){gl_PointSize=1.;gl_Position.z=0.;gl_Position.xyw=vec${A}(GL_v0.xy${v.three?"z":""}=uintBitsToFloat(o0.xy${v.three?"z":""}),1.)*m;gl_Position.xy=gl_Position.xy*2.-gl_Position.w;`],T=[`#version 300 es\nprecision highp float;precision highp int;in vec4 GL_v0;\n#define color color0\n#define pos GL_v0.xy${A>3?"z":""}\n`+p.map((t,i)=>`layout(location=${i})out ${t?16==t||32==t?"u":"lowp ":""}vec4 color${i};`).join(";"),""];let L=0,B=0,N=0,S=0;const F=[],I=(t=0)=>{const s=""+(S>>2),r=3&S,n=3&(S+=t)||4;if(n<=(r||4)){const s=(S>>2)-(t==4+r),n=""+s;G.push(`layout(location=${s+3})in uvec4 a${n};flat out uvec4 GL_a${n};`),T.push(`flat in uvec4 GL_a${n};`),E.push(`GL_a${n}=a${n};`)}if(n<=r){let o=`uvec${t}(GL_a${s}.`;for(let i=r;i<4;i++)o+="xyzw"[i];o+=`,GL_a${S>>2}.`;for(let i=0;i<n;i++)o+="xyzw"[i];return o+")"}if(4==n&&0==r)return"GL_a"+s;let o=`GL_a${s}.`;for(let i=r;i<n;i++)o+="xyzw"[i];return o};let O=0;for(const t of s){let s=1+(3&t);(15&t)>=12&&(L|=1<<s-1,(15&t)>13?N++:B++),$D[O]??=1==s?0:2==s?C:3==s?M:t>=28&&t<32?null:D,R.push(`${O}:a${O}=$D[${O}]`);const r=t>13?"$I[j+":"$i[j+",n=S;if(t>=12&&t<16){F.push(`let t${O}=-1;if(a${O}.t){if((t${O}=$m.auto(a${O}.t,${-(8==t)}))==-1){i&&draw(b^$X);t${O}=$m.auto(a${O}.t,${-(8==t)})}t${O}|=a${O}.l<<8}`);const o=I(1),u=I(2),p=I(2);T.push(`${4==t?"lowp ":8==t?"u":"highp "}vec4 param${O}(vec2 uv){int v=int(${o});if(v<0)return vec4(uintBitsToFloat(${u}),uintBitsToFloat(${p}));return ${4==t?"g":8==t?"uG":"fG"}etColor(v&255,vec3(uv*uintBitsToFloat(${p})+uintBitsToFloat(${u}),v>>8));}`),g.push(`$I[j+${n}]=t${O};if(t${O}>=0)$i[j+${n+1}]=a${O}.x,$i[j+${n+2}]=a${O}.y,$i[j+${n+3}]=a${O}.w,$i[j+${n+4}]=a${O}.h;else ${r}${n+1}]=a${O}.x,${r}${n+2}]=a${O}.y,${r}${n+3}]=a${O}.z,${r}${n+4}]=a${O}.w`),s=5}else{t>=28&&t<32&&(F.push(`let q${O}=$m.auto(a${O}.t,${-(t>29)});if(q${O}<0)i&&draw(b^$X),q${O}=$m.auto(a${O}.t,${-(t>29)})`),s=1);const o=I(s);if(T.push(`\n#define param${O} ${t<16?"uintBitsToFloat":t<32?Q[3&t|4]:""}(${o})\n`),1==s)g.push(r+n+"]=a"+O);else for(let t=0;t<s;t++)g.push(r+(n+t)+"]=a"+O+"."+"xyzw"[t])}O++}T.push(v.fsh),G.push(v.vsh),E.push(v.vshb),O=0;const P=[],j=[""],V=[],k=[],H=[];for(const t of r){const s=1+(3&t);if((15&t)>=12&&(L|=1<<s-1,(15&t)>13?N++:B++,n="int"),$U[O]??=1==s?0:2==s?C:3==s?M:t>=28&&t<32?null:D,P.push(`a${O}=$U[${O}]`),t>=28&&t<32)V.push(`_.uniform1i($L[${k.length}],s${H.length}?$m.auto(s${H.length},${-(t>29)}):-1)`),k.push("uni"+O),T.push(`uniform int uni${O};`),j.push(`s${H.length}=a${O}.t`),H.push(`,s${H.length}=null`);else if(t>=12&&t<16){const s="GL_u"+O,r="GL_U"+O;V.push(`_.uniform1i($L[${k.length}],(s${H.length}?$m.auto(s${H.length},${-(t>13)}):-1)|s${H.length+1})`),T.push(t>13?`uniform int ${s};uniform uvec4 ${r}; ${14==t?"i":"u"}vec4 uni${O}(vec2 uv){if(${s}<0)return ${14==t?`ivec4(${r})`:r};return ${14==t?"i":"u"}GetColor(${s}&255,vec3(uv*uintBitsToFloat(${r}.zw)+uintBitsToFloat(${r}.xy),${s}>>8));}`:`uniform int ${s};uniform vec4 ${r}; ${12==t?"lowp ":""}vec4 uni${O}(vec2 uv){if(${s}<0)return ${r};return fGetColor(${s}&255,vec3(uv*${r}.zw+${r}.xy,${s}>>8));}`),j.push(`if(s${H.length}=a${O}.t){s${H.length+1}=a${O}.l<<8;${t>13?`$C[0]=a${O}.x,$C[1]=a${O}.y,$C[2]=a${O}.w,$C[3]=a${O}.h;_.uniform4ui`:"_.uniform4f"}($L[${k.length-1}],${t>13?"$c[0],$c[1],$c[2],$c[3]":`a${O}.x,a${O}.y,a${O}.w,a${O}.h`})}else _.uniform4${t>13?"ui":"f"}($L[${k.length-1}],a${O}.x,a${O}.y,a${O}.z,a${O}.w)`),k.push(s,r),H.push(`,s${H.length}=null,s${H.length+1}=0`)}else{T.push(`uniform ${Q[3&t|t>>4<<2]} uni${O};`);let r=`_.uniform${s+(t<16?"f":t<32?"i":"ui")}($L[${k.length}]`;if(k.push("uni"+O),1==s)r+=",a"+O;else for(let t=0;t<s;t++)r+=",a"+O+"."+"xyzw"[t];j.push(r+")")}O++}if(12+(S+3&-4)+(v.F+3&-4)>tt<<2)throw"Too many shader parameters";if(B+N>16)throw"Shaders cannot use more than 16 textures/colors";Object.freeze($D),Object.freeze($U);const X=tt-(v.F+3>>2);B=B?N?B+u(m*(U-B-N)):U:0,N=N&&U-B;let Y=null,q="";15&L&&(q+=`uniform ${2&L?"highp":"lowp"} sampler2DArray GL_f[${B}];ivec3 getSize(int u,int l){${K(i=>`return textureSize(GL_${i<B?"f["+i:"i["+(i-B)}],l);`,0,U)}}`),12&L&&(q+=`uniform highp usampler2DArray GL_i[${N}];uvec4 uGetColor(int u,vec3 p){${K(i=>`return texture(GL_i[${i-U}],p);`,U,2*U-B)}}uvec4 uGetPixel(int u,ivec3 p,int l){${K(i=>`return texelFetch(GL_i[${i-U}],p,l);`,U,2*U-B)}}\n#define iGetColor(a,b) ivec4(uGetColor(a,b))\n#define iGetPixel(a,b,c) ivec4(uGetPixel(a,b,c))\n`),3&L&&(q+=`vec4 fGetColor(int u,vec3 p){${K(i=>`return texture(GL_f[${i}],p);`,0,B)}}lowp vec4 GL_lp(vec4 x){return x;}vec4 fGetPixel(int u,ivec3 p,int l){${Y||K(i=>`return texelFetch(GL_f[${i}],p,l);`,0,B)}}\n#define getColor(a,b)GL_lp(fGetColor(a,b))\n#define getPixel(a,b,c)GL_lp(fGetPixel(a,b,c))\n`),T[1]=q;const Z=32-B&&-1>>>B|0;j[0]=`i&&draw(0);if($s!=s){_.useProgram($P);$H(s,${B},${Z},${A>3?S+A*(A-1)+")":`lv==$Q?${S+9}:${S+6});$l(lv)`}}`;const W=X==tt-1?`_.vertexAttribIPointer(${X},${3&v.F},5125,${v.F<<2},0)`:`for(let i=${tt-1},j=0;i>=${X};i--,j+=16){_.vertexAttribIPointer(i,i==${X}?${3&v.F}:4,5125,${v.F<<2},j)`;g[0]=`sz+=${S};if(this.V()){const sd=$s!=s,{S}=this,_st=S.t;if(sd||sz!=$u){i&&draw(sd?0:$x);$H(s,${B},${Z},sz);if(sd)_.useProgram($P),B();${A>3?`}if($v!=_st.v)i&&draw(),$l(_st.v);if(s!=_st.L||sz!=_st.Ls){i&&draw();$d(sz>${8+S},0,false);_st.L=s;_st.Ls=sz`:`$l(lv=sz>${8+S}?$Q:$q)}if(lv.geo!=_st.b){i&&draw();_.bindBuffer(34962,lv.geo=_st.b);${W}`};_.bindBuffer(34963,_st.E);_.bindBuffer(34962,$M)}if($p!=S)S.S();}let b=$X^$x;`+F.join(";")+`;const k=$G(sz),j=k+sz-${S}`,g.push("return k");const $d=(t=!1,s=0,r=!0)=>{const n=A*(2+t),u=S+n<<2;for(let r=1+t;r>=0;r--)_.enableVertexAttribArray(r),_.vertexAttribPointer(r,A,5126,!1,u,s+r*(A<<2)),_.vertexAttribDivisor(r,1);t||(3==A?_.vertexAttrib3f(2,0,0,1):_.vertexAttrib4f(2,0,0,0,1));for(let i=0;i<S;i+=4){const t=3+(i>>2);_.enableVertexAttribArray(t),_.vertexAttribIPointer(t,o(4,S-i),5125,u,s+(i+n<<2)),_.vertexAttribDivisor(t,1)}if(r)for(let i=tt-1;i>=X;i--)_.enableVertexAttribArray(i);return u>>2};let $q=null,$Q=null;A<4&&(_.bindVertexArray($q=_.createVertexArray()),$q.geo=null,$d(!1),_.bindVertexArray($v=$Q=_.createVertexArray()),$Q.geo=null,$d(!0));const J=eval(`let ${A<4?"lv=$Q":"__"}${H.length?H.join(""):""};const B=function(){${V.join(";")};$x=$X},s=function(sz,{${R}}){${g.join(";")}};s.uniforms=(function(${P}){${j.join(";")};B()});s`),$P=_.createProgram(),st=_.createShader(35633),f=_.createShader(35632);if(E.push("}"),_.shaderSource(st,G.join("")+E.join("")),_.compileShader(st),_.shaderSource(f,T.join("")+"\n"+t),_.compileShader(f),_.attachShader($P,st),_.attachShader($P,f),Y=_.getShaderInfoLog(f))throw"GLSL Error:\n"+Y;_.linkProgram($P),_.useProgram($P);const $L=k.map(t=>_.getUniformLocation($P,t));for(let i=0;i<U;i++)_.uniform1i(_.getUniformLocation($P,i<B?"GL_f["+i+"]":"GL_i["+(i-B)+"]"),i>=B?U+i-B:i);return J.vertex=v,J.three=v.three,$s=J};let at=0,lt=0,ut=0;$.Shader.UINT=$.Shader("void main(){color=param0;}",{params:$.UVEC4,outputs:$.UINT}),$.Shader.BLACK=$.Shader("void main(){color=vec4(0,0,0,1);}"),$.Shader.DEFAULT=$.Shader("void main(){color=param0(pos)*param1;}",{params:[$.COLOR,$.VEC4],defaults:[void 0,$.vec4.one]}),$.Shader.COLOR_3D_XZ=$.Shader("void main(){color=param0(pos.xz);}",{params:[$.COLOR],defaults:[void 0,$.vec4.one],vertex:Geometry3D.DEFAULT_VERTEX}),$.Shader.SHADED_3D=$.Shader("void main(){float a=(1.-dot(normalize(cross(dFdx(pos),dFdy(pos))),param1));color.rgb=param0.rgb*a;color.a=param0.a;}",{params:[$.VEC4,$.VEC3],defaults:[$.vec4.one,vec3(.15,.3,0)],vertex:Geometry3D.DEFAULT_VERTEX});let ct=0;$.flush=()=>{i&&draw(),E?E=!1:g&&(_.bindBuffer(35051,null),_.deleteBuffer(g),g=null,G=-1);for(let i=0;i<U<<1;i++){const t=j[i];t&&(_.activeTexture(33984+i),_.bindTexture(35866,j[i]=null),t.i=-1)}let t=performance.now();t-ct>1e3&&(ct=t,$i=new Float32Array($i.length>>>1),$I=new Int32Array($i.buffer))};const ft=$.ctx=new q(curt={_:null,p:0,T:null,w:0,h:0,u:0});$.setSize=(w=0,h=0)=>{_.canvas.width=w,_.canvas.height=h,ft.t.w=_.drawingBufferWidth,ft.t.h=_.drawingBufferHeight,curt==ft.t&&(curt=J=null),ft.t.p=0};const $t=()=>{for(;_t&&37145==_.getSyncParameter(_t.sync,37140);)_.deleteSync(_t.sync),_t(),_t=_t.next;_t||(yt=null,clearInterval(wt),wt=0)};let _t=null,yt=null;const pt=[];$.wait=()=>new Promise(t=>{i?(t.sync=null,pt.push(t)):(t.sync=_.fenceSync(37143,0),_t??=t,yt=yt?yt.next=t:t),wt||(wt=setInterval($t,0))});let wt=0;return $.loop=t=>("t"in $||($.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=.001*performance.now(),$.dt=0,$.frameCpu=0,$.glLost??=null,requestAnimationFrame(function f(){if(requestAnimationFrame(f),_.isContextLost())return $.glLost?.(),$.glLost=_t=yt=null;i&&draw(),_.bindFramebuffer(36009,N=curt=J=null),ft.t.p=0,dt=max(.001,o(-($.t-($.t=.001*performance.now())),.5)),ft.reset();try{t()}finally{$.flush(),$.frameCpu=.001*performance.now()-$.t,at||$.ctx.clear(),$.frameDrawCalls=at,$.frameSprites=lt,$.frameData=4*ut+24*at,at=lt=ut=0}})),$),$},Object.assign($.Gamma,{bitmapOpts:p,STENCIL:1,ALPHA_CHANNEL:2,PREMULTIPLIED_ALPHA:4,AUTO_CLEAR_BUFFER:8,MSAA:16})}