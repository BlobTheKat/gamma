{const $=globalThis;Math.PI2??=2*Math.PI,Math.HALF_SQRT3??=.8660254037844386;const{clz32:t,cos:s,sin:r,min:o,round:u}=Math;if(!("setImmediate"in $)){let t=0,s=0,n=[],r=new MessageChannel;r.port1.onmessage=()=>{const r=n[s];n[s++]=null,s>3&&s>n.length>>1&&(n.splice(0,s),t+=s,s=0),r?.()},r=r.port2,$.setImmediate=(s,...o)=>(r.postMessage(0),n.push(o.length?s.bind(void 0,...o):s),n.length-1+t),$.clearImmediate=i=>{(i-=t)===i>>>0&&(i>=n.length||(n[i]=null))}}if(!("sin"in $)){const t=Object.getOwnPropertyDescriptors(Math);delete t[Symbol.toStringTag],Object.defineProperties($,t)}const p={imageOrientation:"flipY",premultiplyAlpha:"premultiply"},v=(t,s,n)=>"string"==typeof t?fetch(t).then(a=>a.blob()).then(t=>createImageBitmap(t,p)).then(s,n):t instanceof Blob?createImageBitmap(t,p).then(s,n):s(t);$.Gamma=(p=document.createElement("canvas"),$={},A=15)=>{const _=$.gl=($.canvas=p).getContext("webgl2",{preserveDrawingBuffer:!(8&A),antialias:16&A,depth:!1,premultipliedAlpha:4&A,stencil:1&A,alpha:2&A});_.pixelStorei(37440,1),_.stencilMask(1),_.clearStencil(0),_.disable(2929),_.enable(3042),_.pixelStorei(3317,1),_.pixelStorei(3333,1);const R=_.createBuffer();_.bindBuffer(35052,R);let m=!0,G=null,g=-1,E=!1,T=285217039,$s=null,L=0,B=0,$u=0,S=null,$X=0,$x=0,I=5,F=0,O=4,$p=null,N=null,P=0;_.bindFramebuffer(36008,_.createFramebuffer());const U=_.createFramebuffer(),C=_.createBuffer();_.bindBuffer(34962,C);const M=o(32,_.getParameter(34930)),D=[];for(let i=M<<1;i-- >0;)D.push(null);Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NEVER:48,UNSET:64,SET:128,FLIP:192,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:136,RGB_DST:8,ONE_MINUS_DST:153,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,ADD:17,RGB_ADD:1,A_ADD:16,SUB:85,RGB_SUB:5,A_SUB:80,SUB_REV:102,RGB_SUB_REV:6,A_SUB_REV:96,MIN:34,RGB_MIN:2,A_MIN:32,MAX:51,RGB_MAX:3,A_MAX:48,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:28,FTEXTURE:29,ITEXTURE:30,UTEXTURE:31,COLOR:12,FCOLOR:13,ICOLOR:14,UCOLOR:15,FLAT:64,CW_ONLY:16,CCW_ONLY:32,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0}),$.Formats={R:[33321,6403,5121],RG:[33323,33319,5121],RGB:[32849,6407,5121],RGBA:[32856,6408,5121],RGB565:[36194,6407,33635],R11F_G11F_B10F:[35898,6407,35899],RGB5_A1:[32855,6408,32820],RGB10_A2:[32857,6408,33640],RGBA4:[32854,6408,32819],RGB9_E5:[35901,6407,35902],R8:[33330,36244,5121,1<<31],RG8:[33336,33320,5121,1<<31],RGB8:[36221,36248,5121,1<<31],RGBA8:[36220,36249,5121,1<<31],R16:[33332,36244,5123,1<<31],RG16:[33338,33320,5123,1<<31],RGB16:[36215,36248,5123,1<<31],RGBA16:[36214,36249,5123,1<<31],R32:[33334,36244,5125,1<<31],RG32:[33340,33320,5125,1<<31],RGB32:[36209,36248,5125,1<<31],RGBA32:[36208,36249,5125,1<<31],R16F:[33325,6403,5131],RG16F:[33327,33319,5131],RGB16F:[34843,6407,5131],RGBA16F:[34842,6408,5131],R16F_32F:[33325,6403,5126],RG16F_32F:[33327,33319,5126],RGB16F_32F:[34843,6407,5126],RGBA16F_32F:[34842,6408,5126],R32F:[33326,6403,5126],RG32F:[33328,33319,5126],RGB32F:[34837,6407,5126],RGBA32F:[34836,6408,5126]},$.vec2=(x=0,y=x)=>({x:x,y:y}),$.vec2.one=$.vec2(1);const j=$.vec2.zero=$.vec2(0);$.vec2.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b}:{x:a.x+b.x,y:a.y+b.y},$.vec2.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b}:{x:a.x*b.x,y:a.y*b.y},$.vec3=(x=0,y=x,z=x)=>({x:x,y:y,z:z}),$.vec3.one=$.vec3(1);const V=$.vec3.zero=$.vec3(0);$.vec3.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z},$.vec3.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z},$.vec4=(x=0,y=x,z=x,w=x)=>({x:x,y:y,z:z,w:w}),$.vec4.one=$.vec4(1);const H=$.vec4.zero=$.vec4(0);$.vec4.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b,w:a.w+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z,w:a.w+b.w},$.vec4.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b,w:a.w*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z,w:a.w*b.w};class $m{get isInteger(){return this.t.f.length>3}get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get mipmaps(){return this.t.m}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get identity(){return this.t}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,x=0,y=0,w=1,h=1,l=0){this.t=t,this.x=x,this.y=y,this.w=w,this.h=h,this.l=l}get loaded(){return!this.t.src}get waiting(){return!this.t.$}get then(){return this.t.src?this.#t:null}load(){this.t.$||$m.load(this.t)}sub(x=0,y=0,w=1,h=1,l=this.l){return new $m(this.t,this.x+x*this.w,this.y+y*this.h,this.w*w,this.h*h,l)}super(x=0,y=0,w=1,h=1,l=this.l){const t=this.w/w,s=this.h/h;return new $m(this.t,this.x-x*t,this.y-y*s,t,s,l)}crop(x=0,y=0,w=0,h=0,l=this.l){const{t:t,x:s,y:n,h:r}=this;if(!t.src)return new $m(t,s+x/t.w,n+r-(y+h)/t.h,w/t.w,h/t.h,l);const i=new $m(t,0,0,0,0,l);return t.$||$m.load(t),t.src.push(i=>{i.x=s+x/t.w,i.y=n+r-(y+h)/t.h,i.w=w/t.w,i.h=h/t.h},void 0,i),i}layer(l=this.l){return new $m(this.t,this.x,this.y,this.w,this.h,l)}#t(t,s){"function"!=typeof t&&(t=Function.prototype),this.t.src?(this.t.$||$m.load(this.t),this.t.src.push(t,s,this)):t(this)}static load(t){let s=t.src,n=0;t.src=[];let w=0,h=0;t.$=_.createTexture();const r=()=>{n=-1,$m.setOptions(t),_.texStorage3D(35866,t.m,t.f[0],t.w=w=1,t.h=h=1,t.d),m||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),m=!0),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const s=t.src;t.src=null;for(let i=1;i<s.length;i+=3)s[i]?.(s[i+1])};for(let i=0;i<s.length;i++)v(s[i],o=>{if(n){if(w!=o.width||h!=o.height)return r()}else w=o.width,h=o.height;if(s[i]=o,++n<s.length)return;$m.setOptions(t),_.texStorage3D(35866,t.m,t.f[0],t.w=w,t.h=h,t.d),m||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),m=!0),_.bindBuffer(35052,null);for(let l=0;l<n;l++)_.texSubImage3D(35866,0,0,0,l,w,h,1,t.f[1],t.f[2],s[l]);_.bindBuffer(35052,R),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const u=t.src;t.src=null;for(let i=0;i<u.length;i+=3)u[i](u[i+2])},r)}paste(t,x=0,y=0,l=0,s=0,n=0,r=0,o=0,u=0,p=0,A=0,G=0){const{t:g}=this;if(g.src)return null;if(t.msaa)return i&&draw(),p=u||t.height,u=o||t.width,_.framebufferRenderbuffer(36008,36064,36161,t.$),S!=U&&(_.bindFramebuffer(36009,S=U),curt=W=null),_.framebufferTextureLayer(36009,36064,g.$,s,l),_.blitFramebuffer(n,r,n+u,r+p,x,y,x+u,y+p,16384,9728),this;if(!(t instanceof $m))return v(t,i=>($m.fakeBind(g),m||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),m=!0),_.bindBuffer(35052,null),_.texSubImage3D(35866,s,x,y,l,i.width,i.height,1,g.f[1],g.f[2],i),_.bindBuffer(35052,R),g.i<0&&_.bindTexture(35866,null),this));const{t:E}=t;if(E.src)return console.warn("Source texture is not loaded"),this;if(g.$==E.$)return console.warn("Cannot copy from texture to itself"),this;for($m.fakeBind(g),u=u||E.w,p=p||E.h,A=A||E.d;A--;)_.framebufferTextureLayer(36008,36064,E.$,G,o++),_.copyTexSubImage3D(35866,s,x,y,l++,n,r,u,p);return g.i<0&&_.bindTexture(35866,null),this}pasteData(t,x=0,y=0,l=0,w=0,h=0,d=0,s=0){const{t:n}=this;return n.src?null:(w=w||n.w,h=h||n.h,d=d||n.d,$m.fakeBind(n),m&&(_.pixelStorei(37440,0),_.pixelStorei(37441,0),m=!1),_.bufferData(35052,t,35042),_.texSubImage3D(35866,s,x,y,l,w,h,d,n.f[1],n.f[2],0),ht+=.25*t.byteLength,n.i<0&&_.bindTexture(35866,null),this)}readData(x=0,y=0,l=0,w=0,h=0,d=0,t=0){const{t:s}=this;if(s.src)return null;w=w||s.w,h=h||s.h,d=d||s.d,i&&draw();let a=s.f[0],n=33323==a||33338==a||33340==a||33327==a||33328==a||33336==a?2:33321==a||33330==a||33332==a||33334==a||33325==a||33326==a?1:4,r=n<=2?1==n?6403:33319:3==n?6407:6408;a=s.f[2]==5121?1:s.f[2]==5126||s.f[2]==5125||s.f[2]==35899||s.f[2]==33640||s.f[2]==35902?4:2,n*=w*h;let o,u=n*d*a;for(g==u?(o=G,g=-1,E=!0):(_.bindBuffer(35051,o=_.createBuffer()),_.bufferData(35051,u,35041),u>g&&(g=u,G=o,E=!0));d--;)_.framebufferTextureLayer(36008,36064,s.$,t,l),_.readPixels(x,y,w,h,r,s.f[2],n*a*l++);return o!=G&&_.bindBuffer(35051,G),new Promise(t=>{const r=()=>{const $i=1==a?new Uint8Array(n*d):4==a?s.f[2]==5126?new Float32Array(n*d):new Uint32Array(n*d):new Uint16Array(n*d);o!=G&&_.bindBuffer(35051,o),_.getBufferSubData(35051,0,$i),t($i),o!=G&&(u>g?(g=u,G=o):_.bindBuffer(35051,G)),E=!0};r.sync=_.fenceSync(37143,0),at??=r,ct=ct?ct.next=r:r,$t||($t=setInterval(ut,0))})}delete(){this.t.$&&(_.deleteTexture(this.t.$),this.t.$=null,this.t.i>=0&&(D[this.t.i]=null,this.t.i=-1),this.t.d=this.t.w=this.t.h=0)}static auto(s,i=0){if(s.f[3]>>31!=i)return-2;if(s.i>=0){const t=-2147483648>>>s.i-(M-L&i);if(!(t&(i^B)))return $X|=t,s.i;D[s.i]=null,s.i=-1}s.$||$m.load(s);const n=t(~($X|i^B));if(n>=M)return-1;$X|=-2147483648>>>n;const r=D[i=i?M+n-L:n];return r&&(r.i=-1),_.activeTexture(33984+i),_.bindTexture(35866,(D[i]=s).$),s.i=i}static fakeBind(t){if(t.i>=0)i&&draw(),_.activeTexture(33984+t.i);else{const s=M-1+(L==M&&M);D[s]&&(D[s].t.i=-1),_.activeTexture(33984+s),_.bindTexture(35866,t.$)}}get options(){return this.t.o}static setOptions(t){$m.fakeBind(t);const{o:s}=t;t.f[3]>>31?(_.texParameterf(35866,10240,9728),_.texParameterf(35866,10241,9728)):(_.texParameterf(35866,10240,9728+(1&s)),_.texParameterf(35866,10241,t.m>1?9984+(s>>1&3):9728+(s>>1&1))),_.texParameterf(35866,10242,8&s?10497:16&s?33648:33071),_.texParameterf(35866,10243,32&s?10497:64&s?33648:33071)}set options(t){const{t:s}=this;s.o=t,s.src||($m.setOptions(s),s.i<0&&_.bindTexture(35866,null))}setMipmapRange(t=0,e=65535){const{t:s}=this;s.src||($m.fakeBind(s),_.texParameteri(35866,33082,t),_.texParameteri(35866,33083,e),s.i<0&&_.bindTexture(35866,null))}genMipmaps(){const{t:t}=this;t.m<2||($m.fakeBind(t),_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null))}}$.Drawable=(t=!1)=>new q({_:_.createFramebuffer(),p:0,T:t?_.createRenderbuffer():null,w:0,h:0,u:0}),$.Drawable.MAX_TARGETS=_.getParameter(36063);let $i=new Float32Array(1024),$I=new Int32Array($i.buffer),i=0;$.Texture=(w=0,h=0,d=0,t=0,f=Formats.RGBA,s=0)=>{const n={$:_.createTexture(),i:-1,o:t,f:f,src:null,w:w,h:h,d:+d||1,m:s=s||1},r=new $m(n);return $m.setOptions(n),w&&h?_.texStorage3D(35866,s,n.f[0],w,h,n.d):_.texStorage3D(35866,s,n.f[0],n.w=1,n.h=1,n.d),_.bindTexture(35866,null),r},$.Texture.MAX_WIDTH=$.Texture.MAX_HEIGHT=_.getParameter(3379),$.Texture.MAX_LAYERS=_.getParameter(35071),$.Texture.FILTER_32F=!!_.getExtension("OES_texture_float_linear");const k=$.Texture.MAX_MSAA=_.getParameter(36183);$.Texture.MSAA=(w=0,h=0,t=65536,f=Formats.RGBA)=>{t=o(t,k);const s=_.createRenderbuffer();return _.bindRenderbuffer(36161,s),_.renderbufferStorageMultisample(36161,t,f[0],w,h),{$:s,width:w,height:h,msaa:_.getRenderbufferParameter(36161,36011),delete(){_.deleteRenderbuffer(this.$)}}},$.Texture.from=(t,s=0,n=Formats.RGBA,r=0)=>new $m({$:null,i:-1,o:s,f:n,src:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:t?Array.isArray(t)?t.length:1:0,m:r||1});class X{constructor(a=1,b=0,c=0,d=1,e=0,f=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f}translate(x=0,y=0){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y}rotate(t=0){const n=s(t),o=r(t),a=this.a,b=this.b,c=this.c,d=this.d;this.a=a*n-c*o,this.b=b*n-d*o,this.c=a*o+c*n,this.d=b*o+d*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,n=this.c,r=this.d,o=this.e,u=this.f;this.a=t*a+n*b,this.b=s*a+r*b,this.c=t*c+n*d,this.d=s*c+r*d,this.e=t*e+n*f+o,this.f=s*e+r*f+u}skew(x=0,y=0){const t=this.a,s=this.b;this.a+=this.c*y,this.b+=this.d*y,this.c+=t*x,this.d+=s*x}multiply(x=1,y=0){const t=this.a,s=this.b;this.a=t*x-this.c*y,this.b=s*x-this.d*y,this.c=t*y+this.c*x,this.d=s*y+this.d*x}box(x=0,y=0,w=1,h=w){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d,this.a*=w,this.b*=w,this.c*=h,this.d*=h}to(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y+this.e,y:this.b*x+this.d*y+this.f}}from(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const a=this.a,b=this.b,c=this.c,d=this.d,t=a*d-b*c;return{x:(x*d-y*c+c*this.f-d*this.e)/t,y:(y*a-x*b+b*this.e-a*this.f)/t}}toDelta(t=0,s=0){return"object"==typeof t&&({x:t,y:s}=t),{x:this.a*t+this.c*s,y:this.b*t+this.d*s}}fromDelta(t=0,s=0){"object"==typeof t&&({x:t,y:s}=t);const a=this.a,b=this.b,c=this.c,d=this.d,n=a*d-b*c;return{x:(t*d-s*c)/n,y:(s*a-t*b)/n}}determinant(){return this.a*this.d-this.b*this.c}}class Y{constructor(a=1,b=0,c=0,d=0,e=0,f=1,t=0,h=0,i=0,s=0,n=1,l=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=n,this.l=l}translate(x=0,y=0,z=0){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y,this.g*=z,this.h*=z,this.i*=z}transform(a,b,c,d,e,f,t,h,i,s,n,l){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:n,l:l}=a);const r=this.a,o=this.b,u=this.c,p=this.d,v=this.e,A=this.f,R=this.g,m=this.h,G=this.i,g=this.j,E=this.k,T=this.l;this.a=r*a+p*b+R*c,this.b=o*a+v*b+m*c,this.c=u*a+A*b+G*c,this.d=r*d+p*e+R*f,this.e=o*d+v*e+m*f,this.f=u*d+A*e+G*f,this.g=r*t+p*h+R*i,this.h=o*t+v*h+m*i,this.i=u*t+A*h+G*i,this.j=r*s+p*n+R*l+g,this.k=o*s+v*n+m*l+E,this.l=u*s+A*n+G*l+T}box(x=0,y=0,z=0,w=1,h=w,d=w){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i,this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y,this.g*=z,this.h*=z,this.i*=z}to(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.d*y+this.g*z+this.j,y:this.b*x+this.e*y+this.h*z+this.k,z:this.c*x+this.f*y+this.i*z+this.l}}from(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const a=this.a,b=this.b,c=this.c,d=this.d,t=a*d-b*c;return{x:(x*d-y*c+c*this.f-d*this.e)/t,y:(y*a-x*b+b*this.e-a*this.f)/t}}toDelta(t=0,s=0){return"object"==typeof t&&({x:t,y:s}=t),{x:this.a*t+this.c*s,y:this.b*t+this.d*s}}fromDelta(t=0,s=0){"object"==typeof t&&({x:t,y:s}=t);const a=this.a,b=this.b,c=this.c,d=this.d,n=a*d-b*c;return{x:(t*d-s*c)/n,y:(s*a-t*b)/n}}determinant(){return this.a*this.d-this.b*this.c}}const $G=ArrayBuffer.prototype.transfer?t=>{const s=i;return(i=s+t)>$i.length&&($i=new Float32Array($i.buffer.transfer(8*i)),$I=new Int32Array($i.buffer)),s}:t=>{const s=i;if((i=s+t)>$i.length){const t=$i;($i=new Float32Array(2*i)).set(t,0),$I=new Int32Array($i.buffer)}return s};class q extends X{constructor(t,s=290787599,n=$d,r=$.Shader.DEFAULT,a,b,c,d,e,f){super(a,b,c,d,e,f),this.t=t,this.M=s,this.S=n,this.S=r}pixelRatio(){return sqrt(abs(this.a*this.d-this.b*this.c)*this.t.w*this.t.h)}sub(){return new q(this.t,this.M,this.S,this.S,this.a,this.b,this.c,this.d,this.e,this.f)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.M=t.M,this.S=t.S,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.M=290787599,this.S=$.Shader.DEFAULT,this.S=$d}draw(...t){const i=this.S(6,t);$i[i]=this.a,$i[i+1]=this.c,$i[i+2]=this.e,$i[i+3]=this.b,$i[i+4]=this.d,$i[i+5]=this.f}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.S(6,t);$i[i]=this.a*w,$i[i+1]=this.c*h,$i[i+2]=this.e+x*this.a+y*this.c,$i[i+3]=this.b*w,$i[i+4]=this.d*h,$i[i+5]=this.f+x*this.b+y*this.d}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.S(6,t),s=this.a,n=this.b,r=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*a+r*b,$i[i+1]=s*c+r*d,$i[i+2]=s*e+r*f+u,$i[i+3]=n*a+o*b,$i[i+4]=n*c+o*d,$i[i+5]=n*e+o*f+p}drawv(t){const i=this.S(6,t);$i[i]=this.a,$i[i+1]=this.c,$i[i+2]=this.e,$i[i+3]=this.b,$i[i+4]=this.d,$i[i+5]=this.f}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.S(6,t);$i[i]=this.a*w,$i[i+1]=this.c*h,$i[i+2]=this.e+x*this.a+y*this.c,$i[i+3]=this.b*w,$i[i+4]=this.d*h,$i[i+5]=this.f+x*this.b+y*this.d}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.S(6,t),s=this.a,n=this.b,r=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*a+r*b,$i[i+1]=s*c+r*d,$i[i+2]=s*e+r*f+u,$i[i+3]=n*a+o*b,$i[i+4]=n*c+o*d,$i[i+5]=n*e+o*f+p}}const x=Object.getOwnPropertyDescriptors({set shader($s){this.S="function"==typeof $s?$s:$.Shader.DEFAULT},get shader(){return this.S},get width(){return this.t.w},get height(){return this.t.h},get identity(){return this.t},set mask(t){this.M=-256&this.M|255&t,W==this&&(W=null)},get mask(){return 255&this.M},set blend(b){this.M=255&this.M|(b||1135889)<<8,W==this&&(W=null)},get blend(){return this.M>>8},get geometry(){return this.S},set geometry(a){this.S=a||$d,W==this&&(W=null)},V(){if(W==this)return!1;const{t:t,M:s}=this,n=t.p;let d=T^s;if(curt!=t&&(i&&draw(),curt&&curt.p==t.p||(d|=240),S!=t._&&_.bindFramebuffer(36009,S=t._),_.viewport(0,0,t.w,t.h),curt=t),d){if(i&&draw(),15&d&&_.colorMask(1&s,2&s,4&s,8&s),240&d)if(240&s){240&T||_.enable(2960),_.stencilMask(1<<n),_.stencilFunc(32&s?16&s?512:517:16&s?514:519,255,1<<n);const t=128&s?64&s?5386:7681:64&s?0:7680;_.stencilOp(t,t,t)}else 240&T&&_.disable(2960);1996488704&d&&_.blendEquationSeparate(32773+(s>>24&7),32773+(s>>28&7)),16776960&d&&_.blendFuncSeparate((s>>8&15)+766*!!(3584&s),(s>>16&15)+766*!!(917504&s),(s>>12&15)+766*!!(57344&s),(s>>20&15)+766*!!(14680064&s)),-2147483648&d&&(-2147483648&s?_.enable(32926):_.disable(32926)),T=s}return W=this,!0},setTarget(t=0,s=null,l=0,n=0){const{t:r}=this;if(r._){if(i&&draw(),W==this&&(W=null),S!=r._&&(_.bindFramebuffer(36009,S=r._),curt=W=null),!s){if(!r.u)return;return _.framebufferRenderbuffer(36009,36064+t,36161,null),void((r.u&=~(1<<t))||(r.w=r.h=0,_.framebufferRenderbuffer(36009,36128,36161,null)))}if((r.u&=~(1<<t))||(r.w=r.h=0),r.w){if(r.w!=s.width||r.h!=s.height)return}else r.w=s.width,r.h=s.height,r.T&&(_.bindRenderbuffer(36161,r.T),_.renderbufferStorage(36161,36168,r.w,r.h),_.framebufferRenderbuffer(36009,36128,36161,r.T));r.u|=1<<t,s.msaa?_.framebufferRenderbuffer(36009,36064+t,36161,s.$):_.framebufferTextureLayer(36009,36064+t,s.t.$,l,n)}},clearTargets(){const{t:s}=this;if(!s._)return;i&&draw(),W==this&&(W=null);let n=s.u;if(s.u=s.w=s.h=0,s.T&&(_.framebufferRenderbuffer(36009,36128,36161,null),_.deleteRenderbuffer(s.T),s.T=_.createRenderbuffer()),n)for(S!=s._&&(_.bindFramebuffer(36009,S=s._),curt=W=null);n;){const s=31-t(n);n&=~(1<<s),_.framebufferRenderbuffer(36009,36064+s,36161,null)}},get hasStencil(){return this.t._?!!this.t.T:!!(1&A)},set hasStencil(t){let{t:s}=this,b=s.T;s._&&!t!=!b&&(i&&draw(),W==this&&(W=null),s.T=b=b?(_.deleteRenderbuffer(b),null):_.createRenderbuffer(),s.w&&(S!=s._&&(_.bindFramebuffer(36009,S=s._),curt=W=null),b?(_.bindRenderbuffer(36161,b),_.renderbufferStorage(36161,36168,s.w,s.h),_.framebufferRenderbuffer(36009,36128,36161,b)):_.framebufferRenderbuffer(36009,36128,36161,null)))},clear(t=0,s=t,b=t,a=s){"object"==typeof t&&(a=t.w??0,b=t.z??0,s=t.y,t=t.x),i&&draw(),this.V()&&(W=null),_.clearColor(t,s,b,a);const n=this.t.p=this.t.p+1&7;_.clear(n?16384:(_.stencilMask(255),17408)),nt++,_.disable(2960),T&=-241},clearStencil(){i&&draw(),this.V()&&(W=null);(this.t.p=this.t.p+1&7)||(_.stencilMask(255),_.clear(1024)),_.disable(2960),T&=-241}});Object.defineProperties(q.prototype,x),Object.assign($.Blend=(t=17,s=17,n=0,r=!1)=>t|n<<8|s<<16|r<<23,{REPLACE:1114129,DEFAULT:1135889,ADD:1118465,MULTIPLY:1122816,MULTIPLY_MIX:1136008,SUBTRACT:5574913,REVERSE_SUBTRACT:7737601,MIN:2232593,MAX:3346705,BEHIND:1118583,INVERT:1127321});let W=null;function draw(b=$x){if(_.bufferData(34962,$I.subarray(0,i),35040),ht+=i,i/=$u,nt++,rt+=i,P?_.drawElementsInstanced(I,O,P,F,i):_.drawArraysInstanced(I,F,O,i),i=0,$X=b,ft.length){at??=ft[0];for(const f of ft)f.sync=_.fenceSync(37143,0),ct=ct?ct.next=f:f;ft.length=0}}const Z=(f,t,e)=>{let s="switch(u){";for(;t<e;)s+=`case ${t}:${f(t++)}`;return s+"}"},J=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"],K=_.getParameter(34921);function $H(t,s,n,c){$s=t,L=s,B=n,$u=c}const $C=new Float32Array(4),$c=new Int32Array($C.buffer),Q=(t,s,$D=[])=>{s="number"==typeof s?[s]:s||[];let n=0;const r=[],o=[],u=[],p=[],v=[""];let A=2+t,R=0,m=2+t,G=2+t;for(const t of s){if((15&t)>=12)throw"Vertex parameter cannot be a texture";const s=1+(3&t),g=J[3&t|(t>>4&15)<<2],E=t>15;$D[n]??=1==s?0:2==s?j:3==s?V:H,p.push(`${n}:a${n}=$D[${n}]`);const T=(63&t)>13?"$I[i+":"$i[i+";if(1==s)v.push(T+G+"]=a"+n);else for(let t=0;t<s;t++)fnBody.push(T+(G+t)+"]=a"+n+"."+"xyzw"[t]);const L=""+(A>>2),B=3&A,S=3&(A+=s)||4;let I=E?R:m;const F=3&I,O=3&(I+=s)||4;E?R=I:m=I;let N="";if(S<=B){const t=""+(A>>2);o.push(`layout(location=${K-1-(A>>2)})in uvec4 o${t};`),N=`uvec${s}(o${L}.`;for(let i=B;i<4;i++)N+="xyzw"[i];N+=`,o${t}.`;for(let i=0;i<S;i++)N+="xyzw"[i];N+=")"}else if(4==S&&0==B)N="v"+L;else{N=`o${L}.`;for(let i=B;i<S;i++)N+="xyzw"[i]}E||(N=`uintBitsToFloat(${N})`);const P=`GL_${E?"V":"v"}${L}.`;if(O<=F){const p=(E?"GL_V":"GL_v")+(I>>2);o.push(`${E?"flat out u":"centroid out "}vec4 ${p};`);const v=`${E?"u":""}vec${s}(${P+"xyzw".slice(F)},${P+"xyzw".slice(0,O)})`;r.push(`${E?"flat in u":"centroid in "}vec4 ${p};\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${v})`:v}\n`),u.push(`${g} t${n}=${N};${P+"xyzw".slice(F,O)}=t${n}.${"xyzw".slice(0,4-F)};${p}.${"xyzw".slice(0,O)}=t${n}.${"xyzw".slice(4-F,s)};`)}else{const s=P+"xyzw".slice(F,O);r.push(`\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${s})`:s}\n`),u.push(`${P+"xyzw".slice(F,O)}=${N};`)}G+=s,n++}v[0]=`let{i,$i,$I}=this;if((this.i=i+${G})>$i.length){${ArrayBuffer.prototype.transfer?`$i=this.arr=new Float32Array($i.buffer.transfer(i+${G}<<3))`:`const oa=$i;$i=this.arr=new Float32Array(i+${G}<<1);$i.set(oa,0)`};$I=this.iarr=new Int32Array($i.buffer)}`,v.push("return i"),R&&(o.push("flat out uvec4 GL_V0;"),r.push("flat in uvec4 GL_V0;"));const g=eval(`(function({${p}}){${v.join(";")}})`);return{three:t,I:g,F:G,fsh:r.join(""),vsh:o.join(""),vshb:u.join("")}};class tt extends X{constructor(t,s=0,n=0,r=5,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.O=s,this.N=n,this.P=r,this.B=this.t.b}sub(t=this.t.U,s=0,n=this.P){return new tt(this.t,t>>>0,s>>>0,7&n,this.a,this.b,this.c,this.d,this.e,this.f)}addPoint(x,y,...t){const{t:s}=this,i=s.I(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.U++}add(...t){const{t:s}=this,i=s.I(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.U++}addPointv(x,y,t){const{t:s}=this,i=s.I(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.U++}addv(t){const{t:s}=this,i=s.I(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.U++}}class it extends Y{constructor(t,s=0,n=0,r=5,a=1,b=0,c=0,d=0,e=0,f=1,o=0,h=0,i=0,u=0,p=1,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.O=s,this.N=n,this.P=r,this.B=this.t.b}sub(t=this.t.U,s=0,n=this.P){return new tt(this.t,t>>>0,s>>>0,7&n,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}addPoint(x,y,z,...t){const{t:s}=this,i=s.I(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.U++}add(...t){const{t:s}=this,i=s.I(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.U++}addPointv(x,y,z,t){const{t:s}=this,i=s.I(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.U++}addv(t){const{t:s}=this,i=s.I(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.U++}}const y=Object.getOwnPropertyDescriptors({get vertexCount(){return this.t.U},C(){const{t:t}=this;i&&draw(),$p=this,I=this.P,F=this.O,O=this.N,P=t.elT,t.elB!=N&&_.bindBuffer(34963,N=t.elB)},get end(){return this.O+this.N},set end(a){(a>>>=0)>=this.O?this.N=a-this.O:(this.N=this.O-a,this.O=a),$p==this&&this.C()},get start(){return this.O},set start(a){this.O=a>>>0,$p==this&&(i&&draw(),F=this.O)},get length(){return this.N},set length(a){this.N=a>>>0,$p==this&&(i&&draw(),O=this.N)},get type(){return this.P},set type(a){this.P=7&a,$p==this&&(i&&draw(),I=this.P)},get identity(){return this.t},upload(t=null){const{t:s}=this;if(t){let n=0;if(Array.isArray(t)){let s=0;for(const n of t)n>s&&(s=n);const n=s>254?s>65534?new Uint32Array(t.length):new Uint16Array(t.length):new Uint8Array(t.length);n.set(t,0),t=n}n=5121+(262656>>(t.BYTES_PER_ELEMENT<<2)&15),$p&&$p.t==s&&(i&&draw(),P=n),s.elT=n,_.bindBuffer(34963,s.elB??=_.createBuffer()),_.bufferData(34963,t,35044),$p&&$p.t==s?N=s.elB:_.bindBuffer(34963,N)}else s.elB&&($p&&$p.t==s&&(i&&draw(),P=0,_.bindBuffer(34963,null)),s.elT=0,s.elB.delete(),s.elB=null);_.bindBuffer(34962,s.b),_.bufferData(34962,s.iarr.subarray(0,s.i),35044),_.bindBuffer(34962,C),s.arr=st,s.iarr=et,s.i=0,this.N=t?t.length:s.U}}),st=new Float32Array,et=new Int32Array(st.buffer);Object.defineProperties(tt.prototype,y),Object.defineProperties(it.prototype,y),$.Geometry2D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{I:n,F:r}=t??$.Geometry2D.DEFAULT_VERTEX,$i=new Float32Array(16);return new tt({$i:$i,$I:new Int32Array($i.buffer),i:0,b:_.createBuffer(),I:n,F:r,U:0,L:null,v:null,elB:null,elT:0},0,4294967295,s)},$.Geometry3D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{I:n,F:r}=t??$.Geometry3D.DEFAULT_VERTEX,$i=new Float32Array(16);return new it({$i:$i,$I:new Int32Array($i.buffer),i:0,b:_.createBuffer(),I:n,F:r,U:0,L:null,v:null,elB:null,elT:0},0,4294967295,s)},$.Geometry2D.Vertex=Q.bind(null,!1),$.Geometry3D.Vertex=Q.bind(null,!0),$.Geometry3D.DEFAULT_VERTEX=Q(!0,[]);const $d=$.Geometry2D.SQUARE=$.Geometry2D($.Geometry2D.DEFAULT_VERTEX=Q(!1,[]));$d.type=5,$d.addPoint(0,0),$d.addPoint(0,1),$d.addPoint(1,0),$d.addPoint(1,1),$d.upload(),$.Shader=(t,{params:s,defaults:$D,uniforms:r,uniformDefaults:$U,outputs:p=4,vertex:v=$.Geometry2D.DEFAULT_VERTEX,intFrac:A=.5}={})=>{if(s="number"==typeof s?[s]:s||[],r="number"==typeof r?[r]:r||[],$D=void 0!==$D?Array.isArray($D)?[...$D]:[$D]:[],$U=void 0!==$U?Array.isArray($U)?[...$U]:[$U]:[],p="number"==typeof p?[p]:p||[],p.length>Drawable.MAX_TARGETS)throw`Too many shader outputs (Drawable.MAX_TARGETS == ${Drawable.MAX_TARGETS})`;const R=3+v.three,m=[],G=[""],g=[`#version 300 es\nprecision highp float;precision highp int;layout(location=0)in mat3x${R} m;layout(location=${K-1})in uvec4 o0;out vec4 GL_v0;`],E=[`void main(){gl_PointSize=1.;gl_Position.z=0.;gl_Position.xyw=vec${R}(GL_v0.xy${v.three?"z":""}=uintBitsToFloat(o0.xy${v.three?"z":""}),1.)*m;gl_Position.xy=gl_Position.xy*2.-1.;`],T=["#version 300 es\nprecision highp float;precision highp int;in vec4 GL_v0;\n#define color color0\n#define pos GL_v0.xyz\n"+p.map((t,i)=>`layout(location=${i})out ${t?16==t||32==t?"u":"lowp ":""}vec4 color${i};`).join(";"),""];let L=0,B=0,S=0,I=0;const F=[],O=(t=0)=>{const s=""+(I>>2),n=3&I,r=3&(I+=t)||4;if(r<=n){const o=""+(I>>2);g.push(`layout(location=${3+(I>>2)})in uvec4 a${o};flat out uvec4 GL_a${o};`),T.push(`flat in uvec4 GL_a${o};`),E.push(`GL_a${o}=a${o};`);let u=`uvec${t}(GL_a${s}.`;for(let i=n;i<4;i++)u+="xyzw"[i];u+=`,GL_a${o}.`;for(let i=0;i<r;i++)u+="xyzw"[i];return u+")"}if(4==r&&0==n)return"GL_a"+s;let o=`GL_a${s}.`;for(let i=n;i<r;i++)o+="xyzw"[i];return o};let N=0;for(const t of s){let s=1+(3&t);(15&t)>=12&&(L|=1<<s-1,(15&t)>13?S++:B++),$D[N]??=1==s?0:2==s?j:3==s?V:t>=28&&t<32?null:H,m.push(`${N}:a${N}=$D[${N}]`);const n=t>13?"$I[j+":"$i[j+",r=I;if(t>=12&&t<16){F.push(`let t${N}=-1;if(a${N}.t){if((t${N}=$m.auto(a${N}.t,${-(8==t)}))==-1){i&&draw(b^$X);t${N}=$m.auto(a${N}.t,${-(8==t)})}t${N}|=a${N}.l<<8}`);const o=O(1),u=O(2),p=O(2);T.push(`${4==t?"lowp ":8==t?"u":"highp "}vec4 param${N}(vec2 uv){int v=int(${o});if(v<0)return vec4(uintBitsToFloat(${u}),uintBitsToFloat(${p}));return ${4==t?"g":8==t?"uG":"fG"}etColor(v&255,vec3(uv*uintBitsToFloat(${p})+uintBitsToFloat(${u}),v>>8));}`),G.push(`$I[j+${r}]=t${N};if(t${N}>=0)$i[j+${r+1}]=a${N}.x,$i[j+${r+2}]=a${N}.y,$i[j+${r+3}]=a${N}.w,$i[j+${r+4}]=a${N}.h;else ${n}${r+1}]=a${N}.x,${n}${r+2}]=a${N}.y,${n}${r+3}]=a${N}.z,${n}${r+4}]=a${N}.w`),s=5}else{t>=28&&t<32&&(F.push(`let q${N}=$m.auto(a${N}.t,${-(t>29)});if(q${N}<0)i&&draw(b^$X),q${N}=$m.auto(a${N}.t,${-(t>29)})`),s=1);const o=O(s);if(T.push(`\n#define param${N} ${t<16?"uintBitsToFloat":t<32?J[3&t|4]:""}(${o})\n`),1==s)G.push(n+r+"]=a"+N);else for(let t=0;t<s;t++)G.push(n+(r+t)+"]=a"+N+"."+"xyzw"[t])}N++}T.push(v.fsh),g.push(v.vsh),E.push(v.vshb),N=0;const P=[],U=[""],C=[],D=[],k=[];for(const t of r){const s=1+(3&t);if((15&t)>=12&&(L|=1<<s-1,(15&t)>13?S++:B++,n="int"),$U[N]??=1==s?0:2==s?j:3==s?V:t>=28&&t<32?null:H,P.push(`a${N}=$U[${N}]`),t>=28&&t<32)C.push(`_.uniform1i($L[${D.length}],s${k.length}?$m.auto(s${k.length},${-(t>29)}):-1)`),D.push("uni"+N),T.push(`uniform int uni${N};`),U.push(`s${k.length}=a${N}.t`),k.push(`,s${k.length}=null`);else if(t>=12&&t<16){const s="GL_u"+N,n="GL_U"+N;C.push(`_.uniform1i($L[${D.length}],(s${k.length}?$m.auto(s${k.length},${-(t>13)}):-1)|s${k.length+1})`),T.push(t>13?`uniform int ${s};uniform uvec4 ${n}; ${14==t?"i":"u"}vec4 uni${N}(vec2 uv){if(${s}<0)return ${14==t?`ivec4(${n})`:n};return ${14==t?"i":"u"}GetColor(${s}&255,vec3(uv*uintBitsToFloat(${n}.zw)+uintBitsToFloat(${n}.xy),${s}>>8));}`:`uniform int ${s};uniform vec4 ${n}; ${12==t?"lowp ":""}vec4 uni${N}(vec2 uv){if(${s}<0)return ${n};return fGetColor(${s}&255,vec3(uv*${n}.zw+${n}.xy,${s}>>8));}`),U.push(`if(s${k.length}=a${N}.t){s${k.length+1}=a${N}.l<<8;${t>13?`$C[0]=a${N}.x,$C[1]=a${N}.y,$C[2]=a${N}.w,$C[3]=a${N}.h;_.uniform4ui`:"_.uniform4f"}($L[${D.length-1}],${t>13?"$c[0],$c[1],$c[2],$c[3]":`a${N}.x,a${N}.y,a${N}.w,a${N}.h`})}else _.uniform4${t>13?"ui":"f"}($L[${D.length-1}],a${N}.x,a${N}.y,a${N}.z,a${N}.w)`),D.push(s,n),k.push(`,s${k.length}=null,s${k.length+1}=0`)}else{T.push(`uniform ${J[3&t|t>>4<<2]} uni${N};`);let s=`_.uniform${c+(t<16?"f":t<32?"i":"ui")}($L[${D.length}]`;if(D.push("uni"+N),1==c)s+=",a"+N;else for(let t=0;t<c;t++)s+=",a"+N+"."+"xyzw"[t];U.push(s+")")}N++}if(12+(I+3&-4)+(v.F+3&-4)>K<<2)throw"Too many shader parameters";if(B+S>16)throw"Shaders cannot use more than 16 textures/colors";Object.freeze($D),Object.freeze($U);const X=K-(v.F+3>>2);B=B?S?B+u(A*(M-B-S)):M:0,S=S&&M-B;let Y=null,q="";15&L&&(q+=`uniform ${2&L?"highp":"lowp"} sampler2DArray GL_f[${B}];ivec3 getSize(int u,int l){${Z(i=>`return textureSize(GL_${i<B?"f["+i:"i["+(i-B)}],l);`,0,M)}}`),12&L&&(q+=`uniform highp usampler2DArray GL_i[${S}];uvec4 uGetColor(int u,vec3 p){${Z(i=>`return texture(GL_i[${i-M}],p);`,M,2*M-B)}}uvec4 uGetPixel(int u,ivec3 p,int l){${Z(i=>`return texelFetch(GL_i[${i-M}],p,l);`,M,2*M-B)}}\n#define iGetColor(a,b) ivec4(uGetColor(a,b))\n#define iGetPixel(a,b,c) ivec4(uGetPixel(a,b,c))\n`),3&L&&(q+=`vec4 fGetColor(int u,vec3 p){${Z(i=>`return texture(GL_f[${i}],p);`,0,B)}}lowp vec4 GL_lp(vec4 x){return x;}vec4 fGetPixel(int u,ivec3 p,int l){${Y||Z(i=>`return texelFetch(GL_f[${i}],p,l);`,0,B)}}\n#define getColor(a,b)GL_lp(fGetColor(a,b))\n#define getPixel(a,b,c)GL_lp(fGetPixel(a,b,c))\n`),T[1]=q;const W=32-B&&-1>>>B;U[0]=`i&&draw(0);if($s!=s){_.useProgram($P);$H(s,${B},${W},${R>3?I+12:`lv==$Q?${I+9}:${I+6}`})}`,G[0]=`sz+=${I};if(this.V()){const sd=$s!=s;if(sd||sz!=$u){i&&draw(0);$H(s,${B},${W},sz);if(sd){_.useProgram($P);B()};${R>3?"}if(s!=this.S.t.L){/*TODO*/}":`_.bindVertexArray(lv=sz>${8+I}?$Q:$q)}else if(lv!=(lv=sz>${8+I}?$Q:$q)){_.bindVertexArray(lv)};if(lv.geo!=this.S.B){_.bindBuffer(34962,lv.geo=this.S.B);`}${X==K-1?`_.vertexAttribIPointer(${X},${3&v.F},5125,${v.F<<2},0)`:`for(let i=${K-1},j=0;i>=${X};i--,j+=16){_.vertexAttribIPointer(i,i==${X}?${3&v.F}:4,5125,${v.F<<2},j)`};_.bindBuffer(34962,buf)}if($p!=this.S)this.S._setShp();}let b=$X^$x;`+F.join(";")+`;const k=$G(sz),j=k+sz-${I}`,G.push("return k");const Q=(t,s=0)=>{const n=R*(2+t),r=I+n<<2;for(let n=1+t;n>=0;n--)_.enableVertexAttribArray(n),_.vertexAttribPointer(n,R,5126,!1,r,s+n*(R<<2)),_.vertexAttribDivisor(n,1);t||(3==R?_.vertexAttrib3f(2,0,0,1):_.vertexAttrib4f(2,0,0,0,1));for(let i=0;i<I;i+=4){const t=3+(i>>2);_.enableVertexAttribArray(t),_.vertexAttribIPointer(t,o(4,I-i),5125,r,s+(i+n<<2)),_.vertexAttribDivisor(t,1)}for(let i=K-1;i>=X;i--)_.enableVertexAttribArray(i);return r>>2};let $q=null,$Q=null;R<4&&(_.bindVertexArray($q=_.createVertexArray()),$q.geo=null,Q(!1),_.bindVertexArray($Q=_.createVertexArray()),$Q.geo=null,Q(!0));const tt=eval(`let ${R<4?"lv=$Q":"_"}${k.length?k.join(""):""};const B=function(){${C.join(";")};$x=$X},s=function(sz,{${m}}){${G.join(";")}};s.uniforms=(function(${P}){${U.join(";")};B()});s`),$P=_.createProgram(),it=_.createShader(35633),f=_.createShader(35632);if(E.push("}"),I&&(g[0]+="layout(location=3)in uvec4 a0;flat out uvec4 GL_a0;",E[0]+="GL_a0=a0;",T[0]+="flat in uvec4 GL_a0;"),_.shaderSource(it,g.join("")+E.join("")),_.compileShader(it),_.shaderSource(f,T.join("")+"\n"+t),_.compileShader(f),_.attachShader($P,it),_.attachShader($P,f),Y=_.getShaderInfoLog(f))throw"GLSL Error:\n"+Y;_.linkProgram($P),_.useProgram($P);const $L=D.map(t=>_.getUniformLocation($P,t));for(let i=0;i<M;i++)_.uniform1i(_.getUniformLocation($P,i<B?"GL_f["+i+"]":"GL_i["+(i-B)+"]"),i>=B?M+i-B:i);tt.vertex=v,tt.three=v.three;const c=tt.M=I+2*R;return tt.D=$u=c+R,$s=tt};let nt=0,rt=0,ht=0;$.Shader.UINT=$.Shader("void main(){color=param0;}",{params:$.UVEC4,outputs:$.UINT}),$.Shader.BLACK=$.Shader("void main(){color=vec4(0,0,0,1);}"),$.Shader.DEFAULT=$.Shader("void main(){color=param0(pos.xy)*param1;}",{params:[$.COLOR,$.VEC4],defaults:[void 0,$.vec4.one]});let ot=0;$.flush=()=>{i&&draw(),E?E=!1:G&&(_.bindBuffer(35051,null),_.deleteBuffer(G),G=null,g=-1);for(let i=0;i<M<<1;i++){const t=D[i];t&&(_.activeTexture(33984+i),_.bindTexture(35866,D[i]=null),t.i=-1)}let t=performance.now();t-ot>1e3&&(ot=t,$i=new Float32Array($i.length>>>1),$I=new Int32Array($i.buffer))};const lt=$.ctx=new q(curt={_:null,p:0,T:null,w:0,h:0,u:0});$.setSize=(w=0,h=0)=>{_.canvas.width=w,_.canvas.height=h,lt.t.w=_.drawingBufferWidth,lt.t.h=_.drawingBufferHeight,curt==lt.t&&(curt=W=null),lt.t.p=0};const ut=()=>{for(;at&&37145==_.getSyncParameter(at.sync,37140);)_.deleteSync(at.sync),at(),at=at.next;at||(ct=null,clearInterval($t),$t=0)};let at=null,ct=null;const ft=[];$.wait=()=>new Promise(t=>{i?(t.sync=null,ft.push(t)):(t.sync=_.fenceSync(37143,0),at??=t,ct=ct?ct.next=t:t),$t||($t=setInterval(ut,0))});let $t=0;return $.loop=t=>("t"in $||($.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=.001*performance.now(),$.dt=0,$.frameCpu=0,$.glLost??=null,requestAnimationFrame(function f(){if(requestAnimationFrame(f),_.isContextLost())return $.glLost?.(),$.glLost=at=ct=null;i&&draw(),_.bindFramebuffer(36009,S=curt=W=null),lt.t.p=0,dt=max(.001,o(-($.t-($.t=.001*performance.now())),.5)),lt.reset();try{t()}finally{$.flush(),$.frameCpu=.001*performance.now()-$.t,nt||$.ctx.clear(),$.frameDrawCalls=nt,$.frameSprites=rt,$.frameData=4*ht+24*nt,nt=rt=ht=0}})),$),$},Object.assign($.Gamma,{bitmapOpts:p,STENCIL:1,ALPHA_CHANNEL:2,PREMULTIPLIED_ALPHA:4,AUTO_CLEAR_BUFFER:8,MSAA:16})}