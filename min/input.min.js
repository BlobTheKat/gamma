globalThis.BitField??=class t extends Array{constructor(t){if(super(),Array.isArray(t))for(let e=0;e<t.length;e++)this.push(t[e]);else if(t instanceof Uint8Array)for(let e=0;e<t.length;e+=4)this.push(t[e]|t[1|e]<<8|t[2|e]<<16|t[3|e]<<24);else if(t)for(const e of t)this.set(e)}static parse(e){return Array.isArray(e)?Object.setPrototypeOf(e,t.prototype):new t}static decode(e,s=new t){s.length=0;let i=e.v32();for(;i--;)s.push(e.i32())}static encode(t,e){const s=e.length;t.v32(s);for(let e=0;e<s;e++)t.i32(this[e])}static of(...e){const s=new t;for(const t of e)s.set(t);return s}set(t=0){const e=t>>>5;for(;e>=this.length;)this.push(0);this[e]|=1<<(31&t)}unset(t=0){let e=this.length;const s=t>>>5;if(!(s>=e))for(this[s]&=~(1<<(31&t));e&&!this[--e];)super.pop()}setRange(t=0,e=0){if(t>e)return;let s=t>>>5,i=e>>>5,n=e+31>>>5;for(;n>=this.length;)this.push(0);if(s!=i){for(this[s]|=-1<<(31&t);++s<i;)this[s]=-1;(n=31&e)&&(this[i]|=~(-1<<n))}else this[s]|=-1<<(31&t)&~(-1<<(31&e))}unsetRange(t=0,e){if(void 0===e){let e=t+31>>>5;for(;e>0&&!this[e-1];)e--;return this.length=e,void(e&&31&t&&(this[e-1]&=~(-1<<(31&t))))}if(t>e)return;let s=t>>>5,i=e>>>5;if(s>=this.length)return;if(s==i)return void(this[s]&=~(-1<<(31&t))|-1<<(31&e));let n=this.length;for(i<n&&(this[i]&=-1<<(31&e),n=i),this[s]&=~(-1<<(31&t));++s<n;)this[s]=0;if(n==this.length)for(;n&&!this[--n];)super.pop()}anyIn(t=0,e){let s=t>>>5;if(s>=this.length)return!1;if(void 0===e){if(31&t){if(this[s]&-1<<(31&t))return!0;s++}for(;s<this.length;)if(this[s++])return!0;return!1}let i=e>>>5;if(s==i)return!!(this[s]&-1<<(31&t)&~(-1<<(31&e)));if(31&t){if(this[s]&-1<<(31&t))return!0;s++}let n=this.length;if(i<n){if(this[i]&~(-1<<(31&e)))return!0;n=i}for(;++s<n;)if(this[s])return!0;return!1}allIn(t=0,e=0){let s=t>>>5;if(s>=this.length)return!1;let i=e>>>5;if(s==i)return-1==(this[s]|~(-1<<(31&t))|-1<<(31&e));if(31&t){if(~this[s]&-1<<(31&t))return!1;s++}let n=this.length;if(i<n){if(~(this[i]|-1<<(31&e)))return!1;n=i}for(;s<n;)if(~this[s++])return!1;return!0}toggle(t=0){let e=this.length;const s=t>>>5;for(;s>=e;)this.push(0),e++;for(this[s]^=1<<(31&t);e&&!this[--e];)super.pop()}has(t=0){const e=t>>>5;return!(e>=this.length)&&!!(this[e]&1<<(31&t))}pop(t=0){let e=t>>>5;if(e>=this.length)return!1;let s=this[e];if(s^=this[e]=s&~(1<<(31&t)),e==this.length-1)for(;e>=0&&!this[e--];)super.pop();return!!s}put(t=0){let e=t>>>5;for(;e>=this.length;)this.push(0);return!!(this[e]^(this[e]|=1<<(31&t)))}xor(t){let e=this.length;if(e==t.length)for(;e&&this[--e]==t[e];)super.pop();else{let s=e;for(e--;s<t.length;)this.push(t[s++])}for(let s=e;s>=0;s--)this[s]^=t[s]}and(t){let e=this.length;for(this.length>t.length&&(e=this.length=t.length);e&&!(this[--e]&t[e]);)super.pop();for(;e>0;)this[--e]&=t[e]}or(t){let e=this.length-1,s=e;for(;++s<t.length;)this.push(t[s]);for(let s=e;s>=0;s--)this[s]|=t[s]}firstUnset(){let t=-1;for(;++t<this.length;){const e=~this[t];if(e)return t<<5|31-clz32(e&-e)}return t<<5}firstSet(){let t=-1;for(;++t<this.length;)if(this[t])return t<<5|31-clz32(this[t]&-this[t]);return-1}lastSet(){let t=this.length;for(;--t>=0;)if(this[t])return t<<5|31-clz32(this[t]);return-1}popFirst(){let t=-1;for(;++t<this.length;)if(this[t]){let e=31-clz32(this[t]&-this[t]);for(this[t]&=~(1<<e),e|=t<<5,t=this.length;t&&!this[--t];)super.pop();return e}return-1}putFirst(){let t=-1;for(;++t<this.length;){const e=~this[t];if(!e)continue;const s=31-clz32(e&-e);return this[t]|=1<<s,t<<5|s}return this.push(1),t<<5}popLast(){let t=this.length;for(;--t>=0;)if(this[t]){let e=31-Math.clz32(this[t]);for(this[t]&=~(1<<e),e|=t<<5,t=this.length;t&&!this[--t];)super.pop();return e}return-1}clear(){this.length=0}[Symbol.iterator](){const t={value:0,done:!1};let e=0,s=-1;return{[Symbol.iterator](){return this},next:()=>{for(;e<this.length;e++,s=-1){const i=this[e]&s,n=31-clz32(i&-i);if(!(n<0))return s=-2<<n,t.value=e<<5|n,t}return e=1/0,t.done=!0,t}}}iter(t,e=0){let s=-1<<(31&e);for(let i=e>>>5;i<this.length;i++){for(;;){const e=this[i]&s,n=31-clz32(e&-e);if(n<0)break;s=-2<<n,t(i<<5|n)}s=-1}}toUint8Array(){let t=this.length-1,e=this[t],s=0;const i=new Uint8Array(t=(t<<2)+(39-clz32(e)>>3));for(;s<t;s+=4){const t=this[s>>2];i[s]=t,i[1|s]=t>>8,i[2|s]=i>>16,i[3|s]=i>>24}for(s-=4;s<t;)i[s++]=e,e>>=8;return i}},"remove"in Array.prototype||Object.defineProperty(Array.prototype,"remove",{value(t){let e=this.indexOf(t);if(e>=0){for(;e<this.length;)this[e]=this[++e];this.pop()}return e},enumerable:!1,configurable:!0});let lastCan=null,lastInst=null;requestAnimationFrame(function t(){requestAnimationFrame(t)});{const t={__proto__:null,ContextMenu:93,Help:26,Semicolon:186,Quote:222,BracketLeft:219,BracketRight:221,Backquote:192,Backslash:220,Minus:189,EQUAL:187,IntlRo:193,IntlYen:255,MetaLeft:91,MetaRight:91,PrintScreen:44,ScrollLock:145,Pause:19,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NumLock:144,Clear:10,NumpadComma:110,NumpadDecimal:110,Numpad0:96,Numpad1:97,Numpad2:98,Numpad3:99,Numpad4:100,Numpad5:101,Numpad6:102,Numpad7:103,Numpad8:104,Numpad9:105};Gamma.input=(e,s=e.canvas)=>{e.MOUSE=Object.freeze({LEFT:0,RIGHT:2,MIDDLE:1,BACK:3,FORWARD:4}),e.KEY=Object.freeze({A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,can:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,SPACE:32,BACKTICK:192,TAB:9,BACK:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,META:91,METARIGHT:93,CAPSLOCK:20,UP:38,RIGHT:39,DOWN:40,LEFT:37,MOD:navigator.platform.startsWith("Mac")?91:17,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,MINUS:189,EQUAL:187,BR_LEFT:219,BR_RIGHT:221,SEMICOLON:186,APOS:222,BACKSLASH:220,COMMA:188,DOT:190,SLASH:191,PAUSE:19,PAD_ENTER:12,CLEAR:10,HOME:36,END:35,PAGE_UP:33,PAGE_DOWN:34,INS:45,DEL:46,CTX_MENU:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,PAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,PAD_DIV:111,PAD_MULT:106,PAD_SUB:109,PAD_ADD:107,PAD_DOT:110,NUM_LOCK:144,SCROLL_LOCK:145,HELP:26,RO:193,YEN:255,SYSRQ:44,PRINT_SCREEN:44}),e.GAMEPAD=Object.freeze({A:256,B:257,X:258,Y:259,LB:260,RB:261,LT:262,RT:263,UP:268,DOWN:269,LEFT:270,RIGHT:271,MENU:300});const i="undefined"!=typeof ApplePaySession&&!("letterSpacing"in CanvasRenderingContext2D.prototype),n=navigator.platform.startsWith("Linux")||"undefined"!=typeof netscape||i?void 0:{unadjustedMovement:!0};Object.defineProperty(e,"pointerLock",{get:()=>document.pointerLockElement==s,set:t=>{t?document.pointerLockElement!==s&&s.requestPointerLock(n)?.catch(t=>null):document.pointerLockElement===s&&document.exitPointerLock()}}),Object.defineProperty(e,"fullscreen",{get:()=>document.fullscreenElement==s,set:t=>{t?document.fullscreenElement!==s&&s.requestFullscreen()?.catch(t=>null):document.fullscreenElement===s&&document.exitFullscreen()}}),e.Inputs={MOUSE_BUTTONS:1,MOUSE_WHEEL:2,MOUSE_POINTER:4,OTHER_POINTERS:8,KEYBOARD:16,GAMEPADS:32,MOUSE:7,ALL_POINTERS:12,ALL:-1};class r{constructor(t=null){t?(this.x=+t.x,this.y=+t.y,this.tiltX=+t.tiltX,this.tiltY=+t.tiltY,this.pressure=+t.pressure,this.twist=+t.twist,this.buttons=0|t.buttons):(this.x=0,this.y=0,this.tiltX=0,this.tiltY=0,this.pressure=0,this.twist=0,this.buttons=0)}update(t){this.x=+t.x,this.y=+t.y,this.buttons=0|t.buttons,this.tiltX=+t.tiltX,this.tiltY=+t.tiltY,this.pressure=+t.pressure,this.twist=+t.twist}has(t){return!!(this.buttons>>t&1)}anyIn(t=0,e){return!!(this.buttons>>t&("number"==typeof e?~(-1<<e-t):-1))}allIn(t=0,e=0){return-1==(this.buttons>>t|-1<<e-t)}firstUnset(){const t=~this.buttons;return 31-clz32(t&-t)}firstSet(){const t=this.buttons;return 31-clz32(t&-t)}lastSet(){return 31-clz32(this.buttons)}iter(t,e=0){for(;;){const s=this.buttons&-1<<e,i=31-clz32(s&-s);if(i<0)break;e=i+1,t(i)}}}BitField;class o extends BitField{next=null;wheel={x:0,y:0};mouse={x:0,y:0};cursor=null;gamepad=null;_pointers=new Map;pointer(t){return(t|=0)>=0?this._pointers.get(t)??null:null}gamepad(t){return(t=~t)<0?this._pointers.get(t)??null:null}_wcbs=[];_mcbs=[];_rpcbs=[];_rgcbs=[];_rkcbs=[];_npcbs=[];_ngcbs=[];_dpcbs=[];_dgcbs=[];_kcbs=new Map;reset(t=-1){const e=17&t;if(e)if(17==e)this._kcbs.clear();else for(const e of this._kcbs.keys())e>7^t>>3&1&&this._kcbs.delete(e);2&t&&(this._wcbs.length=0),4&t&&(this._mcbs.length=0),8&t&&(this._npcbs.length=this._dpcbs.length=0),32&t&&(this._ngcbs.length=this._dgcbs.length=0)}resetInputs(t=-1){const e=17&t;17==e?this.clear():e&&(1&t&&this.unsetRange(0,7),16&t&&this.unsetRange(8)),2&t&&(this.wheel.x=this.wheel.y=0),4&t&&(this.mouse.x=this.mouse.y=0);let s=40&t;if(40==s)this._pointers.clear();else if(s){s=-(32==s);for(const t of this._pointers.keys())t>>31==s&&this._pointers.delete(t)}}onMouseWheel(t){this._wcbs.push(t)}onMouseMove(t){this._mcbs.push(t)}onPointerUpdate(t){this._rpcbs.push(t)}onGamepadUpdate(t){this._rgcbs.push(t)}onNewPointer(t){this._npcbs.push(t)}onDelPointer(t){this._dpcbs.push(t)}onNewGamepad(t){this._ngcbs.push(t)}onDelGamepad(t){this._dgcbs.push(t)}onKeyDown(t,e){if(Array.isArray(t)){for(const s of t)this.onKeyDown(s,e);return}const s=this._kcbs.get(t&=65535);s?s.push(e):this._kcbs.set(t,[e])}onKeyUp(t,e){if(Array.isArray(t)){for(const s of t)this.onKeyUp(s,e);return}const s=this._kcbs.get(t=~(65535&t));s?s.push(e):this._kcbs.set(t,[e])}onKey(t,e,s){e&&this.onKeyDown(t,e),s&&this.onKeyUp(t,s)}onKeyUpdate(t){this._rkcbs.push(t)}fireKeyUpdate(t,e=!1,s=!1){let i=this;for(;i;){if(!s&&!(e?i.put(t):i.pop(t))){i=i.next;continue}const n=i._kcbs.get(e?65535&t:~(65535&t));if(n)for(const s of n)try{const i=s(e,t);if("boolean"==typeof i&&e!==i){e=i;break}}catch(t){Promise.reject(t)}for(const s of i._rkcbs)try{const i=s(t,e);"boolean"==typeof i&&(e=i)}catch(t){Promise.reject(t)}i=i.next}}refireKey(t){let e=this,s=this.has(t);for(;e;){const i=e._kcbs.get(s?65535&t:~(65535&t));if(i)for(const e of i)try{const i=e(s,t);if("boolean"==typeof i&&s!==i){s=i;break}}catch(t){Promise.reject(t)}for(const i of e._rkcbs)try{const e=i(t,s);"boolean"==typeof e&&(s=e)}catch(t){Promise.reject(t)}e=e.next}}firePointerUpdate(t,e=null,s=!1){if((t|=0)<0)return;let i=this;for(;i;){let n=i._pointers.get(t)??null;if(n)if(e)n.update(e);else{i._pointers.delete(t);for(const s of i._dpcbs)try{const i=s(t,e,n);"object"==typeof i&&(e=i)}catch(t){Promise.reject(t)}}else if(e){n=new r(e),i._pointers.set(t,n);for(const s of i._npcbs)try{const i=s(t,e,null);"object"==typeof i&&(e=i)}catch(t){Promise.reject(t)}}else if(!s){i=i.next;continue}for(const s of i._rpcbs)try{const i=s(t,e);"object"==typeof i&&(e=i)}catch(t){Promise.reject(t)}i=i.next}}refirePointer(t){this.firePointerUpdate(t,this._pointers.get(t)??null,!0)}fireWheelUpdate(t=0,e=0){"object"==typeof t&&(e=+t.y,t=+t.x);let s=this;for(;s;){this.wheel.x+=t,this.wheel.y+=e;for(const s of this._wcbs)try{const i=s(t,e);"object"==typeof i&&(t=+i.x,e=+i.y)}catch(t){Promise.reject(t)}s=s.next}}fireMouseUpdate(t=0,e=0){"object"==typeof t&&(e=+t.y,t=+t.x);let s=this;for(;s;){this.mouse.x+=t,this.mouse.y+=e;for(const s of this._mcbs)try{const i=s(t,e);"object"==typeof i&&(t=+i.x,e=+i.y)}catch(t){Promise.reject(t)}s=s.next}}clearDeltas(){this.mouse.x=this.mouse.y=this.wheel.x=this.wheel.y=0}}const h=e.ictx=new o;e.InputContext=()=>new o,s.style.cursor="default",s.tabIndex=0,e.cursorIcon="";let l="";s.addEventListener("blur",t=>{h.iter(t=>h.fireKeyUpdate(t,!1))}),s.addEventListener("mousedown",t=>{document.activeElement!=s&&s.focus(),t.preventDefault(),h.fireKeyUpdate(t.button,!0)}),s.addEventListener("mouseup",t=>{t.preventDefault(),h.fireKeyUpdate(t.button,!1)}),s.addEventListener("contextmenu",t=>t.preventDefault()),s.addEventListener("wheel",t=>{t.preventDefault(),h.fireWheelDelta(t.wheelDeltaX,t.wheelDeltaY)},{passive:!1});let c=NaN,u=NaN;s.addEventListener("mousemove",t=>{t.preventDefault();let e=0,n=0;try{if(document.pointerLockElement==s){if(e=t.movementX*devicePixelRatio,n=t.movementY*devicePixelRatio,i){const{width:t,height:i}=s.getBoundingClientRect();e*=s.offsetWidth/t,n*=s.offsetHeight/i}}else{if(c!=c)return;e=t.offsetX-c,n=t.offsetY-u}}finally{c=t.offsetX,u=t.offsetY}h.fireMouseUpdate(e,-n)}),e.onFlush(()=>{const t=e.cursorIcon+"";t!==l&&(s.style.cursor=t?"#"==t[0]?t.slice(1):`url(${CSS.escape(t)})`:"",l=t)}),s.addEventListener("keydown",e=>{e.repeat||h.fireKeyUpdate(t[e.code]??e.keyCode,!0)}),s.addEventListener("keyup",e=>{h.fireKeyUpdate(t[e.code]??e.keyCode,!1)})}}