globalThis.BitField??=class t extends Array{constructor(t){if(super(),Array.isArray(t))for(let e=0;e<t.length;e++)this.push(t[e]);else if(t instanceof Uint8Array)for(let e=0;e<t.length;e+=4)this.push(t[e]|t[1|e]<<8|t[2|e]<<16|t[3|e]<<24);else if(t)for(const e of t)this.set(e)}static parse(e){return Array.isArray(e)?Object.setPrototypeOf(e,t.prototype):new t}static decode(e,s=new t){s.length=0;let n=e.v32();for(;n--;)s.push(e.i32())}static encode(t,e){const s=e.length;t.v32(s);for(let e=0;e<s;e++)t.i32(this[e])}static of(...e){const s=new t;for(const t of e)s.set(t);return s}set(t=0){const e=t>>>5;for(;e>=this.length;)this.push(0);this[e]|=1<<(31&t)}unset(t=0){let e=this.length;const s=t>>>5;if(!(s>=e))for(this[s]&=~(1<<(31&t));e&&!this[--e];)super.pop()}setRange(t=0,e=0){if(t>e)return;let s=t>>>5,n=e>>>5,i=e+31>>>5;for(;i>=this.length;)this.push(0);if(s!=n){for(this[s]|=-1<<(31&t);++s<n;)this[s]=-1;(i=31&e)&&(this[n]|=~(-1<<i))}else this[s]|=-1<<(31&t)&~(-1<<(31&e))}unsetRange(t=0,e){if(void 0===e){let e=t+31>>>5;for(;e>0&&!this[e-1];)e--;return this.length=e,void(e&&31&t&&(this[e-1]&=~(-1<<(31&t))))}if(t>e)return;let s=t>>>5,n=e>>>5;if(s>=this.length)return;if(s==n)return void(this[s]&=~(-1<<(31&t))|-1<<(31&e));let i=this.length;for(n<i&&(this[n]&=-1<<(31&e),i=n),this[s]&=~(-1<<(31&t));++s<i;)this[s]=0;if(i==this.length)for(;i&&!this[--i];)super.pop()}anyIn(t=0,e){let s=t>>>5;if(s>=this.length)return!1;if(void 0===e){if(31&t){if(this[s]&-1<<(31&t))return!0;s++}for(;s<this.length;)if(this[s++])return!0;return!1}let n=e>>>5;if(s==n)return!!(this[s]&-1<<(31&t)&~(-1<<(31&e)));if(31&t){if(this[s]&-1<<(31&t))return!0;s++}let i=this.length;if(n<i){if(this[n]&~(-1<<(31&e)))return!0;i=n}for(;++s<i;)if(this[s])return!0;return!1}allIn(t=0,e=0){let s=t>>>5;if(s>=this.length)return!1;let n=e>>>5;if(s==n)return-1==(this[s]|~(-1<<(31&t))|-1<<(31&e));if(31&t){if(~this[s]&-1<<(31&t))return!1;s++}let i=this.length;if(n<i){if(~(this[n]|-1<<(31&e)))return!1;i=n}for(;s<i;)if(~this[s++])return!1;return!0}toggle(t=0){let e=this.length;const s=t>>>5;for(;s>=e;)this.push(0),e++;for(this[s]^=1<<(31&t);e&&!this[--e];)super.pop()}has(t=0){const e=t>>>5;return!(e>=this.length)&&!!(this[e]&1<<(31&t))}pop(t=0){let e=t>>>5;if(e>=this.length)return!1;let s=this[e];if(s^=this[e]=s&~(1<<(31&t)),e==this.length-1)for(;e>=0&&!this[e--];)super.pop();return!!s}put(t=0){let e=t>>>5;for(;e>=this.length;)this.push(0);return!!(this[e]^(this[e]|=1<<(31&t)))}xor(t){let e=this.length;if(e==t.length)for(;e&&this[--e]==t[e];)super.pop();else{let s=e;for(e--;s<t.length;)this.push(t[s++])}for(let s=e;s>=0;s--)this[s]^=t[s]}and(t){let e=this.length;for(this.length>t.length&&(e=this.length=t.length);e&&!(this[--e]&t[e]);)super.pop();for(;e>0;)this[--e]&=t[e]}or(t){let e=this.length-1,s=e;for(;++s<t.length;)this.push(t[s]);for(let s=e;s>=0;s--)this[s]|=t[s]}firstUnset(){let t=-1;for(;++t<this.length;){const e=~this[t];if(e)return t<<5|31-clz32(e&-e)}return t<<5}firstSet(){let t=-1;for(;++t<this.length;)if(this[t])return t<<5|31-clz32(this[t]&-this[t]);return-1}lastSet(){let t=this.length;for(;--t>=0;)if(this[t])return t<<5|31-clz32(this[t]);return-1}popFirst(){let t=-1;for(;++t<this.length;)if(this[t]){let e=31-clz32(this[t]&-this[t]);for(this[t]&=~(1<<e),e|=t<<5,t=this.length;t&&!this[--t];)super.pop();return e}return-1}putFirst(){let t=-1;for(;++t<this.length;){const e=~this[t];if(!e)continue;const s=31-clz32(e&-e);return this[t]|=1<<s,t<<5|s}return this.push(1),t<<5}popLast(){let t=this.length;for(;--t>=0;)if(this[t]){let e=31-Math.clz32(this[t]);for(this[t]&=~(1<<e),e|=t<<5,t=this.length;t&&!this[--t];)super.pop();return e}return-1}clear(){this.length=0}[Symbol.iterator](){const t={value:0,done:!1};let e=0,s=-1;return{[Symbol.iterator](){return this},next:()=>{for(;e<this.length;e++,s=-1){const n=this[e]&s,i=31-clz32(n&-n);if(!(i<0))return s=-2<<i,t.value=e<<5|i,t}return e=1/0,t.done=!0,t}}}iter(t,e=0){let s=-1<<(31&e);for(let n=e>>>5;n<this.length;n++){for(;;){const e=this[n]&s,i=31-clz32(e&-e);if(i<0)break;s=-2<<i,t(n<<5|i)}s=-1}}toUint8Array(){let t=this.length-1,e=this[t],s=0;const n=new Uint8Array(t=(t<<2)+(39-clz32(e)>>3));for(;s<t;s+=4){const t=this[s>>2];n[s]=t,n[1|s]=t>>8,n[2|s]=n>>16,n[3|s]=n>>24}for(s-=4;s<t;)n[s++]=e,e>>=8;return n}};{const t=function(t=1,e=1,s=1,n=1,i=1){this.playEffect?.("dual-rumble",{duration:1e3*i,strongMagnitude:.5*(e+n),weakMagnitude:.5*(t+s)})??this.pulse?.(.25*(t+e+s+n),1e3*i)};function pollGamepads(){e=!1;const s=new Set;let n=document.activeElement?._ictx;if(n instanceof c)for(const t of n._pointers)t<0&&s.add(~t);else n=null;const i=navigator.getGamepads();let r=[];for(const t of i)"standard"==t?.mapping&&r.push(t);const o=r.length;for(const l of r.length?r:i){if(!l)continue;const i=new h,r=l.vibrationActuator??l.hapticActuators?.[0];i.vibrate=r?t.bind(r):null;for(let t=0;t<l.buttons.length;t++)l.buttons[t].pressed&&i.set(t);for(let t=0;t<l.axes.length;t+=2)i._axes.push({x:l.axes[t],y:o?-l.axes[t+1]:l.axes[t+1]});n&&(n.setGamepad(l.index,i),s.delete(l.index)),e=!0}if(n)for(const t of s)n.setGamepad(t,0);e&&requestAnimationFrame(pollGamepads)}let e=!0;requestAnimationFrame(pollGamepads),window.addEventListener("gamepadconnected",()=>{e||(requestAnimationFrame(pollGamepads),e=!0)});const s={__proto__:null,ContextMenu:93,Help:26,Semicolon:186,Quote:222,BracketLeft:219,BracketRight:221,Backquote:192,Backslash:220,Minus:189,EQUAL:187,IntlRo:193,IntlYen:255,MetaLeft:91,MetaRight:91,PrintScreen:44,ScrollLock:145,Pause:19,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NumLock:144,Clear:10,NumpadComma:110,NumpadDecimal:110,Numpad0:96,Numpad1:97,Numpad2:98,Numpad3:99,Numpad4:100,Numpad5:101,Numpad6:102,Numpad7:103,Numpad8:104,Numpad9:105},n=Object.freeze({LEFT:0,RIGHT:2,MIDDLE:1,BACK:3,FORWARD:4}),i=Object.freeze({A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,can:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,SPACE:32,BACKTICK:192,TAB:9,BACK:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,META:91,METARIGHT:93,CAPSLOCK:20,UP:38,RIGHT:39,DOWN:40,LEFT:37,MOD:navigator.platform.startsWith("Mac")?91:17,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,MINUS:189,EQUAL:187,BR_LEFT:219,BR_RIGHT:221,SEMICOLON:186,APOS:222,BACKSLASH:220,COMMA:188,DOT:190,SLASH:191,PAUSE:19,PAD_ENTER:12,CLEAR:10,HOME:36,END:35,PAGE_UP:33,PAGE_DOWN:34,INS:45,DEL:46,CTX_MENU:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,PAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,PAD_DIV:111,PAD_MULT:106,PAD_SUB:109,PAD_ADD:107,PAD_DOT:110,NUM_LOCK:144,SCROLL_LOCK:145,HELP:26,RO:193,YEN:255,SYSRQ:44,PRINT_SCREEN:44}),r=Object.freeze({A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,UP:12,DOWN:13,LEFT:14,RIGHT:15,MENU:16,LEFT_STICK:0,RIGHT_STICK:1,SELECT:8,START:9});class o{static DEFAULT=0;static HIDDEN=1;constructor(t=null){t?(this.x=+t.x,this.y=+t.y,this.tiltX=+t.tiltX,this.tiltY=+t.tiltY,this.pressure=+t.pressure,this.twist=+t.twist,this.buttons=0|t.buttons,this.setHint=t.setHint):(this.x=0,this.y=0,this.tiltX=0,this.tiltY=0,this.pressure=0,this.twist=0,this.buttons=0,this.setHint=null)}update(t){this.x=+t.x,this.y=+t.y,this.buttons=0|t.buttons,this.tiltX=+t.tiltX,this.tiltY=+t.tiltY,this.pressure=+t.pressure,this.twist=+t.twist,this.setHint=t.setHint}has(t){return!!(this.buttons>>t&1)}anyIn(t=0,e){return!!(this.buttons>>t&("number"==typeof e?~(-1<<e-t):-1))}allIn(t=0,e=0){return-1==(this.buttons>>t|-1<<e-t)}firstUnset(){const t=~this.buttons;return 31-clz32(t&-t)}firstSet(){const t=this.buttons;return 31-clz32(t&-t)}lastSet(){return 31-clz32(this.buttons)}[Symbol.iterator](){const t={value:-1,done:!1};return{[Symbol.iterator](){return this},next:()=>{if(t.done)return t;const e=this.buttons&-1<<t.value+1,s=31-clz32(e&-e);return s>=0?(t.value=s,t):(t.value=-1,t.done=!0,t)}}}iter(t,e=0){for(;;){const s=this.buttons&-1<<e,n=31-clz32(s&-s);if(n<0)break;e=n+1,t(n)}}get pressed(){return!!(1&this.buttons)}}const l=["","none","context-menu","help","pointer","progress","wait","cell","crosshair","text","vertical-text","alias","copy","move","no-drop","not-allowed","grab","grabbing","e-resize","n-resize","ne-resize","nw-resize","s-resize","se-resize","sw-resize","w-resize","ew-resize","ns-resize","nesw-resize","nwse-resize","col-resize","row-resize","all-scroll","zoom-in","zoom-out"];for(let a=2;a<l.length;a++)o[l[a].toUpperCase().replace("-","_")]=a;class h extends BitField{_subscribed=[];constructor(t=null){super(t),t?(this._axes=t._axes.slice(),this.vibrate=t.vibrate):(this._axes=[],this.vibrate=null)}update(t){const e=min(this.length,t.length);for(let s=0;s<e;s++){let e=t[s],n=e^this[s];for(this[s]=e;n;){const t=31-clz32(n&-n);for(const n of this._subscribed)n._fireGamepadButtonUpdate(s<<5|t,!!(e>>t&1));n&=-2<<t}}if(e<t.length)for(let s=e;s<t.length;s++){let e=t[s];for(this.push(e);e;){const t=31-clz32(e&-e);for(const e of this._subscribed)e._fireGamepadButtonUpdate(s<<5|t,!0);e&=-2<<t}}else if(e<this.length){for(let t=e;t<this.length;t++){let e=this[t];for(;e;){const s=31-clz32(e&-e);for(const e of this._subscribed)e._fireGamepadButtonUpdate(t<<5|s,!1);e&=-2<<s}}this.length=e}const s=t._axes,n=this._axes,i=min(s.length,n.length);for(let t=0;t<i;t++){const e=s[t],i=n[t];if(e.x!==i.x||e.y!==i.y){i.x=e.x,i.y=e.y;for(const s of this._subscribed)s._fireGamepadAxisUpdate(t,e.x,e.y)}}if(i<s.length)for(let t=i;t<s.length;t++){const e=s[t];if(n.push(e),0!==e.x||0!==e.y)for(const s of this._subscribed)s._fireGamepadAxisUpdate(t,e.x,e.y)}else if(i<n.length){for(let t=i;t<n.length;t++){const e=n[t];if(0!==e.x||0!==e.y)for(const e of this._subscribed)e._fireGamepadAxisUpdate(t,0,0)}n.length=i}this.vibrate=t.vibrate}axis(t){return this._axes[65535&t]??null}}class c extends BitField{next=null;wheel={x:0,y:0};mouse={x:0,y:0};cursor=null;gamepad=null;_pointers=new Map;pointer(t){return(t|=0)>=0?this._pointers.get(t)??null:null}iterPointers(t){for(const{0:e,1:s}of this._pointers)e>=0&&t(e,s)}gamepad(t){return(t=~t)<0?this._pointers.get(t)??null:null}iterGamepads(t){for(const{0:e,1:s}of this._pointers)e<0&&t(~e,s)}#t=[];#e=[];_rpcbs=[];#s=[];_rkcbs=[];_npcbs=[];_ngcbs=[];_dpcbs=[];_dgcbs=[];_kcbs=new Map;reset(){this._kcbs.clear(),this._rkcbs.length=0,this.#t.length=0,this.#e.length=0,this._npcbs.length=this._dpcbs.length=this._rpcbs.length=0,this._ngcbs.length=this._dgcbs.length=this.#s.length=0}clear(){this.reset(),this.clear(),this.wheel.x=this.wheel.y=0,this.mouse.x=this.mouse.y=0,this._pointers.clear()}onWheel(t){this.#t.push(t)}onMouse(t){this.#e.push(t)}onPointerUpdate(t){this._rpcbs.push("function"==typeof t?t:t.setPointer.bind(t))}onGamepadUpdate(t){this.#s.push("function"==typeof t?t:t.setGamepad.bind(t))}onNewPointer(t){this._npcbs.push(t)}onDelPointer(t){this._dpcbs.push(t)}onNewGamepad(t){this._ngcbs.push(t)}onDelGamepad(t){this._dgcbs.push(t)}onKey(t,e){if(Array.isArray(t)){for(const s of t)this.onKey(s,e);return}const s=this._kcbs.get(t&=65535);s?s.push(e):this._kcbs.set(t,[e])}onGamepadButton(t,e){if(Array.isArray(t)){for(const s of t)this.onGamepadButton(s,e);return}const s=this._kcbs.get(t=~(65535&t));s?s.push(e):this._kcbs.set(t,[e])}onGamepadAxis(t,e){if(Array.isArray(t)){for(const s of t)this.onGamepadButton(s,e);return}const s=this._kcbs.get(t=~(65535&t|65536));s?s.push(e):this._kcbs.set(t,[e])}onKeyPress(t,e,s=!1){let n=!1;this.onKey(t,(t,i)=>(n==s&(n=t)===!s&&e(i),s))}onGamepadButtonPress(t,e,s=!1){let n=!1;this.onGamepadButton(t,(t,i)=>(n==s&(n=t)===!s&&e(i),s))}onKeyUpdate(t){this._rkcbs.push("function"==typeof t?t:t.setKey.bind(t))}setKey(t,e=!1,s=!1){t&=65535;let n=this;for(;n;){if(e?n.put(t):n.pop(t)){const s=n._kcbs.get(t);if(s){let i=s.length;for(;i--;)try{const r=s[i](e,t,n);"boolean"==typeof r&&(e=r)}catch(t){Promise.reject(t)}}}else if(!s){n=n.next;continue}let i=n._rkcbs.length;for(;i--;)try{const s=n._rkcbs[i](t,e,n);"boolean"==typeof s&&(e=s)}catch(t){Promise.reject(t)}n=n.next}return e}refireKey(t){this.setKey(t,this.has(t),!0)}_fireGamepadButtonUpdate(t=0,e=!1){const s=this._kcbs.get(~t);if(!s)return;let n=s.length;for(;n--;)try{const i=s[n](e,t,this);"boolean"==typeof i&&(e=i)}catch(t){Promise.reject(t)}}_fireGamepadAxisUpdate(t=0,e=0,s=0){const n=this._kcbs.get(~(65536|t));if(!n)return;let i=n.length;for(;i--;)try{const t=n[i](e,s,this);"object"==typeof t&&(t?(e=+t.x,s=+t.y):e=s=0)}catch(t){Promise.reject(t)}}setPointer(t,e=null,s=!1){if((t|=0)<0)return;let n=this;for(;n;){let i=n._pointers.get(t)??null;if(i)if(e)i.update(e);else{n._pointers.delete(t),t||(n.cursor=null);let s=n._dpcbs.length;for(;s--;)try{const r=n._dpcbs[s](t,e,i,n);"object"==typeof r&&(e=r)}catch(t){Promise.reject(t)}}else if(e){i=new o(e),t||(n.cursor=i),n._pointers.set(t,i);let s=n._npcbs.length;for(;s--;)try{const i=n._npcbs[s](t,e,null,n);"object"==typeof i&&(e=i)}catch(t){Promise.reject(t)}}else if(!s){n=n.next;continue}let r=n._rpcbs.length;for(;r--;)try{const s=n._rpcbs[r](t,e,n);"object"==typeof s&&(e=s)}catch(t){Promise.reject(t)}n=n.next}return e}#n(t){this.gamepad=t,t.iter(t=>this._fireGamepadButtonUpdate(t,!0));const e=t._axes;for(let t=0;t<e.length;t++){const s=e[t];0!==s.x&&0!==s.y&&this._fireGamepadAxisUpdate(t,s.x,s.y)}t._subscribed.push(this)}refirePointer(t){this.setPointer(t,this._pointers.get(t)??null,!0)}setGamepad(t,e=null,s=!1){if((t=~t)>=0)return;let n=this;for(;n;){let i=n._pointers.get(t)??null;if(i)if(e)i.update(e);else{if(n._pointers.delete(t),i==this.gamepad){this.gamepad=null;const t=i._subscribed;let e=t.indexOf(this);if(e>=0){for(;e<t.length;)t[e]=t[++e];t.pop()}i.iter(t=>this._fireGamepadButtonUpdate(t,!1));const s=i._axes;for(let t=0;t<s.length;t++){const e=s[t];0!==e.x&&0!==e.y&&this._fireGamepadAxisUpdate(t,0,0)}for(const{0:t,1:e}of this._pointers)if(t<0){this.#n(i);break}}let s=n._dgcbs.length;for(;s--;)try{const r=n._dgcbs[s](t,e,i,n);"object"==typeof r&&(e=r)}catch(t){Promise.reject(t)}}else if(e){i=new h(e),this.gamepad||this.#n(i),n._pointers.set(t,i);let s=n._ngcbs.length;for(;s--;)try{const i=n._ngcbs[s](t,e,null,n);"object"==typeof i&&(e=i)}catch(t){Promise.reject(t)}}else if(!s){n=n.next;continue}let r=this.#s.length;for(;r--;)try{const s=this.#s[r](t,e,n);"object"==typeof s&&(e=s)}catch(t){Promise.reject(t)}n=n.next}return e}refireGamepad(t){this.setGamepad(t,this._pointers.get(~t)??null,!0)}fireWheel(t=0,e=0){"object"==typeof t&&(e=+t.y,t=+t.x);let s=this;for(;s;){this.wheel.x+=t,this.wheel.y+=e;let n=this.#t.length;for(;n--;)try{const i=this.#t[n](t,e,s);"object"==typeof i&&(i?(t=+i.x,e=+i.y):t=e=0)}catch(t){Promise.reject(t)}s=s.next}return{x:t,y:e}}fireMouse(t=0,e=0){"object"==typeof t&&(e=+t.y,t=+t.x);let s=this;for(;s;){this.mouse.x+=t,this.mouse.y+=e;let n=this.#e.length;for(;n--;)try{const i=this.#e[n](t,e,s);"object"==typeof i&&(i?(t=+i.x,e=+i.y):t=e=0)}catch(t){Promise.reject(t)}s=s.next}return{x:t,y:e}}clearDeltas(){this.mouse.x=this.mouse.y=this.wheel.x=this.wheel.y=0}}Gamma.input=(t,e=t.canvas)=>{if(e._ictx)return;t.MOUSE=n,t.KEY=i,t.GAMEPAD=r,t.PointerState=o,t.GamepadState=h;const a="undefined"!=typeof ApplePaySession&&!("letterSpacing"in CanvasRenderingContext2D.prototype),u=navigator.platform.startsWith("Linux")||"undefined"!=typeof netscape||a?void 0:{unadjustedMovement:!0};Object.defineProperty(t,"pointerLock",{get:()=>document.pointerLockElement==e,set:t=>{t?document.pointerLockElement!==e&&e.requestPointerLock(u)?.catch(t=>null):document.pointerLockElement===e&&document.exitPointerLock()}}),Object.defineProperty(t,"fullscreen",{get:()=>document.fullscreenElement==e,set:t=>{t?document.fullscreenElement!==e&&e.requestFullscreen()?.catch(t=>null):document.fullscreenElement===e&&document.exitFullscreen()}});const f=t.ictx=e._ictx=new c;t.InputContext=()=>new c,e.style.outline="none",e.style.touchAction="none",e.style.setProperty("-webkit-tap-highlight-color","transparent"),e.tabIndex=0;let p=!1;e.addEventListener("mousedown",t=>{document.activeElement?._ictx!=f&&e.focus(),t.preventDefault(),f.setKey(t.button,!0)}),e.addEventListener("mouseup",t=>{t.preventDefault(),f.setKey(t.button,!1)}),e.addEventListener("contextmenu",t=>t.preventDefault()),e.addEventListener("wheel",t=>{t.preventDefault(),f.fireWheel(t.wheelDeltaX,t.wheelDeltaY)},{passive:!1});let d=NaN,g=NaN;e.addEventListener("mousemove",t=>{t.preventDefault();let s=0,n=0;try{if(document.pointerLockElement==e)if(s=t.movementX,n=t.movementY,a){const{width:t,height:i}=e.getBoundingClientRect();s*=devicePixelRatio*e.offsetWidth/t,n*=devicePixelRatio*e.offsetHeight/i}else u||(s*=devicePixelRatio,n*=devicePixelRatio);else{if(d!=d)return;s=t.offsetX-d,n=t.offsetY-g}}finally{d=t.offsetX,g=t.offsetY}f.fireMouse(s,-n)});let m=0,b=0;t.onFlush(()=>{m!==b&&(e.style.cursor="number"==typeof m?l[m]:`url(${CSS.escape(m)})`,b=m)});let _=null,y=0;const x=new BitField,A=t=>{const n=s[t.code]??t.keyCode;if(t.repeat)return x.has(n);_=null;let i=f.setKey(n,!0);return _?(document.activeElement!=_&&(p=!0,_.focus(),p=!1),i=!0):document.activeElement!=e&&(i=!1),i?x.set(n):x.unset(n),i},E=t=>{const n=s[t.code]??t.keyCode;_=null;let i=f.setKey(n,!1);return _?(document.activeElement!=_&&(p=!0,_.focus(),p=!1),i=!0):document.activeElement!=e&&(i=!1),x.unset(n),i},v=t=>{if(!p){f.iter(t=>f.setKey(t,!1));for(const t of f._pointers.keys())t<0&&f.setGamepad(~t,null)}},P=t=>{t._ictx=f,t.addEventListener("keydown",A),t.addEventListener("keyup",E),t.addEventListener("blur",v)};P(e),t.captureKeyEvent=(t,e=0,s=!1)=>{(e|=0)<0||(t._ictx||P(t),_=t,y=e^-s)},t.setFocused=(t=null)=>{t?t._ictx||P(t):t=e,p=!0,t.focus(),p=!1};const w=t=>{m=t},L=[],N=t=>{if(-1==t.pointerId)return;const s=new o;s.x=t.offsetX/e.offsetWidth,s.y=1-t.offsetY/e.offsetHeight,s.buttons=t.buttons,s.pressure=t.pressure,s.tiltX=.017453292519943295*t.tiltX,s.tiltY=.017453292519943295*t.tiltY,s.twist=.017453292519943295*t.twist;let n=0;"mouse"==t.pointerType?s.setHint=w:(n=L.indexOf(t.pointerId)+1,n||(n=L.push(t.pointerId))),f.setPointer(n,s)};e.addEventListener("pointerover",N),e.addEventListener("pointerdown",N),e.addEventListener("pointermove",N),e.addEventListener("pointerup",N),e.addEventListener("pointerleave",t=>{if(-1==t.pointerId)return;let e=0;if("mouse"!=t.pointerType){if(e=L.indexOf(t.pointerId)+1,!e)return;if(e==L.length){let t=L.length-1;do{L.pop()}while(t&&!L[--t])}else L[e-1]=null}f.setPointer(e,null)}),e.addEventListener("touchend",t=>t.preventDefault())}}