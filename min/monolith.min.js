Gamma.font=e=>{const t=e.vec4.one,s={x:0,y:1},n=e.Geometry2D.SQUARE,o=e.Shader.MSDF=e.Shader("void main(){vec3 c=param0(pos).rgb;color=param2*clamp(param1.y*(max(min(c.r,c.g),min(max(c.r,c.g),c.b))-.5+param1.x)+.5,0.,1.);}",{params:[e.COLOR,e.VEC2,e.VEC4],defaults:[null,{x:0,y:1},t]});e.Shader.font=(t,s={})=>{let n="float field(vec2 uv){vec3 c=param0(uv).rgb;return max(min(c.r, c.g), min(max(c.r, c.g), c.b)); }\n#define scale param1\n";Array.isArray(s.params)||(s.params="number"==typeof s.params?[s.params]:[]),Array.isArray(s.defaults)||(s.defaults=void 0===s.defaults?[]:[s.defaults]);for(let e=0;e<s.params.length;e++)n+=`#define value${e} param${e+2}\n`;return s.params.unshift(e.COLOR,e.VEC2),s.defaults.unshift(void 0,{x:0,y:1}),e.Shader(n+t,s)};const r=e.BreakToken=(e,t=0,s="",n=void 0)=>{if(e instanceof RegExp){let t=e.flags,s=t.indexOf("g");s>-1&&(t=t.slice(0,s)+t.slice(s+1)),t.includes("y")||(t+="y"),t!=e.flags&&(e=new RegExp(e.source,t))}else{let t="[";for(const s of e+""){const e=s.codePointAt();t+=e>=92&&e<=94||45==e?"\\"+s:s}e=new RegExp(t+"]","y")}return e.type=t,e.sep=s,e.next=n,e.sepW=e.sepA=e.sepS=0,e.sepL=null,e};r.NORMAL=0,r.NEVER_BREAK=1,r.ALWAYS_BREAK=2,r.OVERFLOW=3,r.VANISH=4,r.TRUNCATE=5,r.SQUISH=6,r.SQUISH_BREAK=7,r.WRAP_AFTER=8,r.WRAP_BEFORE=16,r.INVISIBLE=32;const i=[r(/\r\n?|\n/y,r.WRAP_AFTER|r.INVISIBLE,""),r(/[$£"+]?[\w'-]+[,.!?:;"^%€*]?/iy,r.NORMAL,"-"),r(/[ \t]+/y,r.VANISH)],a=r(/[^]/y,r.ALWAYS_BREAK),c={x:0,y:0},l={off:0,spr:-1,0:null,1:c},f=[0,0,0,l],h=(e,t,s,n=0)=>{if(e.sepL=t,e.sepA=s,e.sepS=n,!t)return e.sepW=0;let o=0;const r=1/s;for(const i of e.sep){const e=i.codePointAt(),a=(t.get(~e)??t._default)._xadv+n+(t.get(e+-1114112)??0);o+=s&&asin(a*s)*r||a}return t.then?.(()=>e.sepL==t&&(e.sepL=null,e.sepW=0)),e.sepW=o};class u extends Array{#e=null;#t=o;#s=n;#n=1;#o=0;#r=1;#i=0;#a=0;#c=0;#l=f;#f=0;#h=NaN;#u=null;#p=!0;static public=class e{constructor(e){this.#b=e}sub(){const t=new e(this.#b);return t.#y=this.#y,t.#g=this.#g,t.#_=this.#_,t.#k=this.#k,t.#m=this.#m,t.#d=this.#d,t.#v=this.#v,t.#A=this.#A,t.#w=this.#w,t}reset(e=null){this.#y="object"==typeof e?e:null,this.#g=o,this.#_=n,this.#k=1,this.#m=0,this.#d=0,this.#v=0,this.#w=null,this.#A=0,this.#b.#u==this&&(this.#b.#u=null)}#b;#y=null;#x=!0;get font(){return this.#y}set font(e){"object"==typeof e&&(this.#y=e),this.#b.#u==this&&(this.#b.#u=null)}#g=o;get shader(){return this.#g}set shader(e){"function"==typeof e&&(this.#g=e),this.#b.#u==this&&(this.#b.#u=null)}#_=n;get geometry(){return this.#_}set geometry(e){this.#_=e,this.#b.#u==this&&(this.#b.#u=null)}#k=1;get scale(){return this.#k}set scale(e){this.#k=+e,this.#b.#u==this&&(this.#b.#u=null)}scaleBy(e=1,t=!0,s=!0){if(1==e)return;const n=this.#b,o=n.length;let r=0,i=0;for(;r<o;){const o=n[r++];"number"==typeof o?(4==o||5==o&&s?(i||(i=1),n[r]*=e):1==o&&t&&(n[r]*=e),r++):"string"!=typeof o&&"function"!=typeof o||i||(i=2)}1!=i&&n.unshift(4,e),n.#n*=e,s&&(n.#o*=e),n.#h=NaN,n.#u=null}#q=0;get yOffset(){return this.#q}set yOffset(e){this.#q=+e,this.#b.#u==this&&(this.#b.#u=null)}offsetBy(e=0,t=!1){if(!e)return;const s=this.#b,n=s.length;let o=0,r=0,i=1,a=!1,c=0;for(;o<n;){const n=s[o++];if("number"==typeof n)5==n?(r||(r=1),c=s[o],s[o]=c+e*i,a=!1):t&&4==n&&(i=1/s[o],a=!0),o++;else if("string"==typeof n||"function"==typeof n){if(a){s.push(null,null);for(let e=s.length-3;e>=o;e--)s[e+2]=s[e];s[o++]=5,s[o++]=c+e*i}r||(r=2)}}1!=r&&s.unshift(5,e),s.#o+=e,s.#u=null}#m=1;get stretch(){return this.#m}set stretch(e){this.#m=+e,this.#b.#u==this&&(this.#b.#u=null)}stretchBy(e=1,t=!0,s=!1){if(1==e)return;const n=this.#b,o=n.length;let r=0,i=0;for(;r<o;){const o=n[r++];"number"==typeof o?(6==o||7==o&&s?(i||(i=1),n[r]*=e):1==o&&t&&(n[r]*=e),r++):"string"!=typeof o&&"function"!=typeof o||i||(i=2)}1!=i&&(s?n.unshift(7,e,6,e):n.unshift(6,e)),n.#r*=e,s&&(n.#i*=e),n.#h=NaN,n.#u=null}get letterWidth(){return this.#k*this.stretch}set letterWidth(e){this.stretch=e/this.#k}#d=0;get skew(){return this.#d}set skew(e){this.#d=+e,this.#b.#u==this&&(this.#b.#u=null)}skewBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,o=0;for(;n<s;){const s=t[n++];"number"==typeof s?(7==s&&(o||(o=1),t[n]+=e),n++):"string"!=typeof s&&"function"!=typeof s||o||(o=2)}1!=o&&t.unshift(7,e),t.#i+=e,t.#u=null}#v=0;get letterSpacing(){return this.#v}set letterSpacing(e){this.#v=+e,this.#b.#u==this&&(this.#b.#u=null)}spaceBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,o=0;for(;n<s;){const s=t[n++];"number"==typeof s?(8==s&&(o||(o=1),t[n]+=e),n++):"string"!=typeof s&&"function"!=typeof s||o||(o=2)}1!=o&&t.unshift(8,e),t.#a+=e,t.#h=NaN,t.#u=null}#A=0;get curve(){return this.#A}set curve(e){this.#A=+e,this.#b.#u==this&&(this.#b.#u=null)}curveBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,o=0;for(;n<s;){const s=t[n++];"number"==typeof s?(9==s?(o||(o=1),t[n]+=e):1!=s||o||(o=2),n++):"string"!=typeof s&&"function"!=typeof s||o||(o=2)}1!=o&&t.unshift(9,e),t.#c+=e,t.#h=NaN,t.#u=null}#w=f;addTextPass(e,t,s=0,n=0,o=0,r=-.5){const i={off:o,spr:.5/r,0:null,1:c};if(t)for(let e=0;e<t.length;e++)i[e+2]=t[e];const a=this.#w,l=this.#w=[];let f=0;for(;f<a.length;f+=4){if(!(a[f]<e)){a[f]==e&&(f+=4);break}l.push(a[f],a[f+1],a[f+2],a[f+3])}for(l.push(e,+s,+n,i);f<a.length;)l.push(a[f],a[f+1],a[f+2],a[f+3]),f+=4;this.#b.#u=null}addLinePass(e,n,o=0,r=1){const i={0:t,1:s};for(let e=0;e<n.length;e++)i[e+2]=n[e];const a=this.#w,c=this.#w=[];let l=0;for(;l<a.length;l+=4){if(!(a[l]<e)){a[l]==e&&(l+=4);break}c.push(a[l],a[l+1],a[l+2],a[l+3])}for(c.push(e,i,+o,+r);l<a.length;)c.push(a[l],a[l+1],a[l+2],a[l+3]),l+=4;this.#b.#u=null}delPass(e){const t=this.#w,s=this.#w=[];let n=0;for(;n<t.length;n+=4){if(!(t[n]<e)){t[n]==e&&(n+=4);break}s.push(t[n],t[n+1],t[n+2],t[n+3])}for(;n<t.length;)s.push(t[n],t[n+1],t[n+2],t[n+3]),n+=4;this.#b.#u=null}insertTextPass(e,t,s=0,n=0,o=0,r=-.5){const i={off:o,spr:.5/r,0:null,1:c};if(t)for(let e=0;e<t.length;e++)i[e+2]=t[e];const a=this.#b,f=a.length;let h=0,u=0;for(;h<f;){let t=a[h++];if("number"==typeof t&&t>0)h++;else if("string"==typeof t||"function"==typeof t)u||(u=2);else if(Array.isArray(t)){u||(u=1);const o=a[h-1]=[];let r=0;for(;r<t.length;r+=4){if(!(t[r]<e)){t[r]==e&&(r+=4);break}o.push(t[r],t[r+1],t[r+2],t[r+3])}for(o.push(e,+s,+n,i);r<t.length;)o.push(t[r],t[r+1],t[r+2],t[r+3]),r+=4}}1!=u&&a.unshift(e>0?[0,0,0,l,e,s,n,i]:e<0?[e,s,n,i,0,0,0,l]:[e,s,n,i]),a.#u=null}insertLinePass(e,n,o=0,r=1){const i={0:t,1:s};for(let e=0;e<n.length;e++)i[e+2]=n[e];const a=this.#b,c=a.length;let f=0,h=0;for(;f<c;){let t=a[f++];if("number"==typeof t&&t>0)f++;else if("string"==typeof t||"function"==typeof t)h||(h=2);else if(Array.isArray(t)){h||(h=1);const s=a[f-1]=[];let n=0;for(;n<t.length;n+=4){if(!(t[n]<e)){t[n]==e&&(n+=4);break}s.push(t[n],t[n+1],t[n+2],t[n+3])}for(s.push(e,i,o,r);n<t.length;)s.push(t[n],t[n+1],t[n+2],t[n+3]),n+=4}}1!=h&&a.unshift(e>0?[0,0,0,l,e,i,o,r]:e<0?[e,i,o,r,0,0,0,l]:[e,i,o,r]),a.#u=null}removePass(e){const t=this.#b,s=t.length;let n=0;e:for(;n<s;){let s=t[n++];if("number"==typeof s&&s>0)n++;else if(Array.isArray(s)){let t=0;for(;t<s.length;t+=4){if(s[t]>e)continue e;if(s[t]==e){for(t+=4;t<s.length;)s[t-4]=s[t],s[t-3]=s[t+1],s[t-2]=s[t+2],s[t-1]=s[t+3],t+=4;s.length-=4;break}}}}}get index(){return this.#x}set index(e){this.#x=!!e,this.#b.#u==this&&(this.#b.#u=null)}advance(e=0){const t=this.#b;t.#u!=this&&this.#N(t),t.push(1,+e),t.#h=NaN}#N(e){this.#y!=e.#e&&e.push(e.#e=this.#y),this.#g!=e.#t&&e.push(2,e.#t=this.#g),this.#_!=e.#s&&e.push(3,e.#s=this.#_),this.#k!=e.#n&&e.push(4,e.#n=this.#k),this.#q!=e.#o&&e.push(5,e.#o=this.#q),this.#m!=e.#r&&e.push(6,e.#r=this.#m),this.#d!=e.#i&&e.push(7,e.#i=this.#d),this.#v!=e.#a&&e.push(8,e.#a=this.#v),this.#A!=e.#c&&e.push(9,e.#c=this.#A),this.#w!=e.#l&&(e.push(this.#w),e.#l=this.#w),this.#x!=e.#p&&(e.push(this.#x),e.#p=this.#x),e.#u=this}copy(){const e=this.#b,t=e.slice(),s=t.#u=this.sub();return s.#b=t,t.#e=e.#e,t.#t=e.#t,t.#n=e.#n,t.#o=e.#o,t.#r=e.#r,t.#i=e.#i,t.#a=e.#a,t.#c=e.#c,t.#l=e.#l,t.#p=e.#p,t.#f=e.#f,t.#h=e.#h,s}slice(t=0,s=1/0){const n=this.#b,o=new u;t<0&&(t+=n.#f)<0&&(t=0),s<0&&(s+=n.#f)<0&&(s=0);const r=new e(o);let i=0;if(s<=0){for(;i<n.length;){const e=n[i++];if("number"==typeof e){const t=n[i++];switch(e){case 1:i-=2;break;case 2:r.#g=t;break;case 3:r.#_=t;break;case 4:r.#k=t;break;case 5:r.#q=t;break;case 6:r.#m=t;break;case 7:r.#d=t;break;case 8:r.#v=t;break;case 9:r.#A=t}}else{if("string"==typeof e||"function"==typeof e)break;Array.isArray(e)?"boolean"==typeof e?r.#x=e:r.#w=e:r.#y=e}}return r.#N(o),r}s=s>=t?s-t:0;let a="";for(;t>0&&i<n.length;){const e=n[i++];if("number"==typeof e){const t=n[i++];switch(e){case 2:r.#g=t;break;case 3:r.#_=t;break;case 4:r.#k=t;break;case 5:r.#q=t;break;case 6:r.#m=t;break;case 7:r.#d=t;break;case 8:r.#v=t;break;case 9:r.#A=t}}else if("string"==typeof e){if(!o.#p)continue;if((t-=e.length)<0){a=e.slice(t,(s+=t)+e.length);break}}else Array.isArray(e)?r.#w=e:"object"==typeof e?r.#y=e:"boolean"==typeof e&&(r.#x=e)}for(r.#N(o),a&&(o.push(a),o.#f+=a.length);s>0&&i<n.length;){const e=n[i++];if(o.push(e),"number"==typeof e){const t=n[i++];switch(o.push(t),e){case 2:r.#g=t;break;case 3:r.#_=t;break;case 4:r.#k=t;break;case 5:r.#q=t;break;case 6:r.#m=t;break;case 7:r.#d=t;break;case 8:r.#v=t;break;case 9:r.#A=t}}else if("string"==typeof e){if(!o.#p)continue;s-=e.length,o.#f+=e.length,s<0?(o[o.length-1]=e.slice(0,s),o.#f+=e.length+s):o.#f+=e.length}else Array.isArray(e)?r.#w=e:"object"==typeof e?r.#y=e:"boolean"==typeof e&&(r.#x=e)}return r}trim(e=1/0){const t=this.#b;if(e<0&&(e+=t.#f)<0&&(e=0),e>t.#f)return;let s=0;if(t.#e=null,t.#t=o,t.#n=1,t.#r=1,t.#o=0,t.#i=0,t.#a=0,t.#p=!0,t.#c=0,t.#l=f,t.#f=e<0?0:e)for(;e>0&&s<t.length;){const n=t[s++];if("number"==typeof n){const e=t[s++];switch(n){case 2:t.#t=e;break;case 3:t.#s=e;break;case 4:t.#n=e;break;case 5:t.#o=e;break;case 6:t.#r=e;break;case 7:t.#i=e;break;case 8:t.#a=e;break;case 9:t.#c=e}}else if("string"==typeof n){if(!t.#p)continue;if((e-=n.length)<0){t[s-1]=n.slice(0,e);break}}else Array.isArray(n)?t.#l=n:"object"==typeof n?t.#e=n:"boolean"==typeof n&&(t.#p=n)}else for(;s<t.length;){const e=t[s++];if("number"==typeof e){const n=t[s++];switch(e){case 1:s-=2;break;case 2:t.#t=n;break;case 3:t.#s=n;break;case 4:t.#n=n;break;case 5:t.#o=n;break;case 6:t.#r=n;break;case 7:t.#i=n;break;case 8:t.#a=n;break;case 9:t.#c=n}}else{if("string"==typeof e||"function"==typeof e){s--;break}Array.isArray(e)?t.#l=e:"boolean"==typeof e?t.#p=e:t.#e=e}}this.#y=t.#e,this.#g=t.#t,this.#_=t.#s,this.#k=t.#n,this.#q=t.#o,this.#m=t.#r,this.#d=t.#i,this.#v=t.#a,this.#A=t.#c,this.#w=t.#l,t.length=s,t.#h=NaN}concat(e){const t=this.#b,s=e.#b;t.#f+=s.#f;let r=0;this.#y=null,this.#g=o,this.#_=n,this.#k=1,this.#q=0,this.#m=1,this.#d=0,this.#v=0,this.#A=0,this.#w=f;const i=s.length;e:for(;r<i;){const e=s[r++];if("number"==typeof e){const t=s[r++];switch(e){case 1:r-=2;break e;case 2:this.#g=t;break;case 3:this.#_=t;break;case 4:this.#k=t;break;case 5:this.#q=t;break;case 6:this.#m=t;break;case 7:this.#d=t;break;case 8:this.#v=t;break;case 9:this.#A=t}}else{if("string"==typeof e||"function"==typeof e){r--;break}Array.isArray(e)?this.#w=e:"boolean"==typeof e?this.#x=e:this.#y=e}}for(this.#N(t);r<i;){const e=s[r++];if(t.push(e),"number"==typeof e){const n=s[r++];switch(t.push(n),e){case 2:this.#g=n;break;case 3:this.#_=n;break;case 4:this.#k=n;break;case 5:this.#q=n;break;case 6:this.#m=n;break;case 7:this.#d=n;break;case 8:this.#v=n;break;case 9:this.#A=n}}else"string"==typeof e?t.#p&&(t.#f+=e.length):Array.isArray(e)?this.#w=e:"boolean"==typeof e?this.#x=e:"object"==typeof e&&(this.#y=e)}t.#h=NaN}get length(){return this.#b.#f}set length(e){this.trim(e)}get width(){const e=this.#b;let t=e.#h;if(t==t)return t;t=0;let s=null,n=0,o=1,r=1,i=0,a=0,c=0,l=1,f=-1,h=1;for(;n<e.length;){let u=e[n++];if("number"==typeof u){const s=e[n++];switch(u){case 1:t+=l*s,f=-1;break;case 4:l=(o=s)*r,f=-1;break;case 6:l=(r=s)*o,f=-1;break;case 5:case 7:f=-1;break;case 8:i=s;break;case 9:c=1/s,a=s}}else if("string"==typeof u){if(s)for(const e of u){const n=e.codePointAt(),o=s.get(~n)??s._default;if(!o)continue;const r=(s.get(n+1114112*f)??0)*min(l,h);f=n,h=l;const u=(o._xadv+i)*l+r;t+=a&&asin(u*a)*c||u,o._tex?.waiting&&o._tex.load()}}else if("object"==typeof u){if(!u){s=null;continue}if(Array.isArray(u))continue;s=u,u.then?.(()=>e.#h=NaN)}}return e.#h=t}add(e){const t=this.#b;t.#u!=this&&this.#N(t),t.#p&&(t.#f+=(e+="").length),t.push(e),t.#h=NaN}addCb(e,t=NaN){if("function"!=typeof e)return;const s=this.#b;s.#u!=this&&this.#N(s),t==t?s.push(e,1,t):s.push(e)}indexAt(e=0,t=.5){t--;const s=this.#b;let n=null,o=0,r=1,i=1,a=0,c=!0,l=0,f=0,h=1,u=-1,p=1,b=0,y=0;for(;o<s.length;){let g=s[o++];if("number"==typeof g){const t=s[o++];switch(g){case 1:e-=h*t,u=-1;break;case 4:h=(r=t)*i,u=-1;break;case 6:h=(i=t)*r,u=-1;break;case 5:case 7:u=-1;break;case 8:a=t;break;case 9:f=1/t,l=t}}else if("string"==typeof g)if(n)for(const s of g){const o=s.codePointAt(),r=n.get(~o)??n._default;if(!r){c&&(y=b+=s.length);continue}const i=(n.get(o+1114112*u)??0)*min(h,p);u=o,p=h;const g=(r._xadv+a)*h+i,_=l&&asin(g*l)*f||g;if(e-=_,c){if(e<=_*t)return y;y=b+=s.length}}else c&&(b+=g.length);else if("object"==typeof g){if(!g){n=null;continue}if(Array.isArray(g))continue;n=g}else"boolean"==typeof g&&(c=g)}return y}draw(e){const t=this.#b;let s=null,r=0,i=1,a=1,l=1,h=0,u=0,p=0,b=0,y=0;e.shader=o,e.geometry=n;let g=f,_=3,k=null,m=0,d=-1,v=1,A=e.projection,w=-2*e.pixelRatio(),x=1,q=1,N=1,R=0;e:for(;r<t.length;){let n=t[r++];if("number"==typeof n){const s=t[r++];switch(n){case 1:if(y){u&&e.skew(-u,0);const t=.5/y,n=s*y*2;e.rotate(R),e.translate(sin(n)*t,(1-cos(n))*t),e.rotate(-n),R=0,u&&e.skew(u,0)}else e.translate(s,0);d=-1;continue e;case 4:const t=s*a;a=1/s,e.scale(t),p*=i*=a,b*=i,v*=t,y*=t,i=s,k&&(x=w*i*k.rangeFactor),d=-1;continue e;case 5:p=s*a,b=p*u,d=-1;continue e;case 2:e.shader=s;break;case 3:e.geometry=s;break;case 6:l=s,d=-1;continue e;case 7:e.skew(s-u,0),u=s,b=p*s,d=-1;continue e;case 8:h=.5*s;continue e;case 9:y=s*i;continue e;default:continue e}}else{if("string"==typeof n){if(s)for(const t of n){const n=t.codePointAt(),o=s.get(~n)??s._default;if(!o)continue;A&&(w=-2*e.pixelRatio(),x=w*i*k.rangeFactor);const r=(s.get(n+1114112*d)??0)*min(v,l);d=n,v=l;const a=(o._xadv+h+h)*l+r,f=r-b;y&&(u&&e.skew(-u,0),e.rotate(R+(R=-asin(a*y)||0)),u&&e.skew(u,0));for(let t=0;t<_;t+=4){const s=g[t+1],n=g[t+2]+p,r=g[t+3];if("object"==typeof s){const t=y*a*(n+m);e.drawRectv(f+t,n+m,a-t-t,r,s)}else if(o._tex){r[0]=o._tex,c.x=r.off*N;const{spr:t}=r;c.y=(t<0?x:q)*t,e.drawRectv((o.x+h)*l+s+f,o.y+n,o.w*l,o.h,r)}}e.translate(a,0)}continue}if("function"==typeof n){const t=e.sub();R&&(t.skew(-u,0),t.rotate(R),t.skew(u,0)),n(t,k)}else if("object"==typeof n){if(!n){s=null;continue}if(Array.isArray(n)){if(_=(g=n).length,A=!1,e.projection)for(let e=0;e<_;e+=4)if("object"==typeof g[e+3]&&g[e+3].spr<0){A=!0;break}continue}k=n,m=k.ascend-1,s=n,x=w*i*(q=k.rangeFactor),N=1/q}}}u&&e.skew(-u,0),R&&e.rotate(R),1!=i&&e.scale(a)}break(t=1/0,s=i,n={scale:1,letterSpacing:0,curve:0}){const o=this.#b;let r=!0,c="",l=0;for(;l<o.length;){const e=o[l++];"number"!=typeof e?"boolean"==typeof e?r=e:"string"==typeof e&&r&&(c+=e):l++}const f=[];let p="number"==typeof t?t:"function"==typeof t?t(f.length,n):t[min(f.length,t.length-1)],b=new u,y=b.#u=new e(b),g=0,_="";l=0;let k=null,m=1,d=1,v=-1,A=0,w=!1;for(;l<c.length;){let r=0,i=a,x=b.length,q=A,N=y.#g,R=y.#_,P=y.#k,S=y.#q,F=y.#m,E=y.#d,L=y.#v,O=y.#y,j=y.#A,B=y.#w,W=b.#p,T=b.#f;e:do{if(s)for(i of s)if(i.lastIndex=l,i.test(c)){if(r){i=a;break e}r=i.lastIndex-l,l=i.lastIndex,s=i.next??s;break e}++r}while(++l<c.length);const I=i.type;16&I&&(f.push(y),b.#h=w?NaN:A,w=!1,y=y.sub(),y.#b=b=new u,p="number"==typeof t?t:"function"==typeof t?t(f.length,n):t[min(f.length,t.length-1)],x=q=A=T=0,W||b.push(b.#p=!1),y.#N(b));const C=!!(32&I)&&!!b.#e;if(_){let e=_;r<_.length?(e=_.slice(0,r),_=_.slice(r),r=0):(r-=_.length,_=""),C&&b.push(null),e&&b.push(e),b.#p&&(b.#f+=e.length),C&&b.push(b.#e)}for(;r>0;){const e=o[g++];if(o.length,"number"==typeof e){const t=o[g++];switch(b.push(e,t),e){case 2:y.#g=b.#t=t;break;case 3:y.#_=b.#s=t;break;case 4:y.#k=b.#n=t;break;case 5:y.#q=b.#o=t;break;case 6:y.#m=b.#r=t;break;case 7:y.#d=b.#i=t;break;case 8:y.#v=b.#a=t;break;case 9:y.#A=b.#c=t}}else if("string"==typeof e){if(!b.#e){b.push(e),b.#p&&(b.#f+=e.length);continue}r-=e.length;let t=e;r<0?(t=e.slice(0,r),_=e.slice(r)):_="",C&&b.push(null),b.push(t),b.#p&&(b.#f+=t.length),C&&b.push(b.#e)}else"boolean"==typeof e?b.push(b.#p=e):(b.push(e),Array.isArray(e)?b.#l=y.#w=e:"function"!=typeof e&&(b.#e=y.#y=e))}for(;;){let s=x,o=0,r=0,a=N,c=R,l=P,g=S,_=F,C=E,H=L,V=O,G=B,U=W,K=T,M=j,Y=1/M,D=!1,Q=i.sepL==V&&i.sepA==M&&i.sepS==H?i.sepW:h(i,V,M,H);const $=I?!!(36>>I&1):2*q<p,{scale:z=1,letterSpacing:J=0,curve:X=0}=n;w||=1!=z||0!=J||0!=X;let Z=M+X,ee=H+J;for(X&&(Y=1/Z);s<b.length;){const e=b[s++];if("number"==typeof e){const t=b[s++];switch(e){case 1:if(A+=t,v=-1,A>p-(Q-(k?.get(i.sep.codePointAt()+1114112*v)??0))*m||!$)break;x=s-2,r=0,D=!0,q=A,N=a,R=c,P=l,S=g,F=_,E=C,L=H,O=V,j=M,B=G,W=U,T=K;break;case 2:a=t;break;case 3:c=t;break;case 4:l=t,m=t*_*z;break;case 5:g=t;break;case 6:_=t,m=t*l*z;break;case 7:C=t;break;case 8:H=t,ee=t+J;break;case 9:Z=t+X,Y=1/Z,M=t}}else if("string"==typeof e)if(o=0,k)for(const t of e){const e=t.codePointAt(),n=k.get(~e)??k._default;if(o+=t.length,U&&(K+=t.length),!n)continue;const f=(k.get(e+1114112*v)??0)*min(m,d);d=m,v=e;const h=(n._xadv+ee)*m+f;A+=Z&&asin(h*Z)*Y||h,A<=p-(Q-(k.get(i.sep.codePointAt()+1114112*e)??0))*m&&$&&(D=!0,x=s-1,r=o,q=A,N=a,R=c,P=l,S=g,F=_,E=C,L=H,O=V,j=M,B=G,W=U,T=K)}else U&&(K+=e.length);else if(Array.isArray(e))G=e;else if("boolean"==typeof e)U=e;else{if("function"==typeof e)continue;(V=e)?(k=e,Q=i.sepL==e&&i.sepA==M&&i.sepS==H?i.sepW:h(i,e,M,H)):(k=null,Q=0)}}if(!q||A<=p||!x||3==I)break;if(s=x,o=r,a=N,c=R,l=P,g=S,_=F,C=E,H=L,V=O,G=B,U=W,M=j,K=T,6==I||7==I&&p-q>=A-p){const e=(p-q)/(A-q),t=b.length;for(b.splice(s,0,6,e*_),s+=2;s<t;){const t=b[s++];"number"==typeof t&&(6==t&&(b[s]*=e),s++)}b.push(6,_);break}A=q;const te=new u,se=new e(te),ne=b.length;se.#g=a,se.#_=c,se.#k=l,se.#q=g,se.#m=_,se.#d=C,se.#v=H,se.#w=G,se.#A=M,se.#x=U;let oe=s+=!!o,re=V;const ie=4!=I&&5!=I;if(o){se.#y=re,se.#N(te);const e=b[s-1];b[s-1]=e.slice(0,o),te.push(e.slice(o)),ie?re=null:te.push(se.#y=te.#e=null)}else{e:for(;oe<ne;){const e=b[oe++];if("number"==typeof e){const t=b[oe++];switch(e){case 1:if(ie){oe-=2;break e}break;case 2:se.#g=t;break;case 3:se.#_=t;break;case 4:se.#k=t;break;case 5:se.#q=t;break;case 6:se.#m=t;break;case 7:se.#d=t;break;case 8:se.#v=t;break;case 9:se.#A=t}}else{if("string"==typeof e||"function"==typeof e){oe--;break}"boolean"==typeof e?se.#x=e:Array.isArray(e)?se.#w=e:re=e}}se.#N(te)}if(ie)for(re&&te.push(se.#y=te.#e=re);oe<ne;)te.push(b[oe++]);else for(;oe<ne;){const e=b[oe++];"number"==typeof e?te.push(e,b[oe++]):("object"!=typeof e||Array.isArray(e))&&te.push(e)}te.#f=b.#f-K,b.#f=K,b.#h=w?NaN:A,w=!1,se.#g=te.#t=y.#g,se.#_=te.#s=y.#_,se.#k=te.#n=y.#k,se.#q=te.#o=y.#q,se.#m=te.#r=y.#m,se.#d=te.#i=y.#d,se.#v=te.#a=y.#v,se.#A=te.#c=y.#A,se.#x=te.#p=y.#x,se.#w=te.#l=y.#w,b.length=s,!ie&&re&&te.push(se.#y=te.#e=re),D&&(b.#p&&b.push(b.#p=!1),b.push(i.sep)),f.push(y),y=se,b=te,p="number"==typeof t?t:"function"==typeof t?t(f.length,n):t[min(f.length,t.length-1)],x=r=q=A=T=0}8&I&&(f.push(y),b.#h=w?NaN:A,w=!1,A=0,y=y.sub(),y.#b=b=new u,p="number"==typeof t?t:"function"==typeof t?t(f.length,n):t[min(f.length,t.length-1)],y.#N(b))}for(;g<o.length;){const e=o[g++];if(b.push(e),"number"==typeof e){const t=o[g++];switch(b.push(t),e){case 2:y.#g=b.#t=t;break;case 3:y.#_=b.#s=t;break;case 4:y.#k=b.#n=t;break;case 5:y.#q=b.#o=t;break;case 6:y.#m=b.#r=t;break;case 7:y.#d=b.#i=t;break;case 8:y.#v=b.#a=t;break;case 9:y.#A=b.#c=t}}else Array.isArray(e)?y.#w=b.#l=e:"object"==typeof e?y.#y=b.#e=e:"boolean"==typeof e&&(y.#x=b.#p=e)}return b.#h=w?NaN:A,f.push(y),f}toString(){let e="",t=!0,s=0;const n=this.#b,o=n.length;for(;s<o;){const o=n[s++];"number"!=typeof o?"boolean"==typeof o?t=o:"string"==typeof o&&t&&(e+=o):s++}return e}static ctor=(t=null)=>{const s=new u;if(!t)return s.#u=new e(s);const n=new e(s);return n.#y=t,n}}}e.RichText=u.public.ctor;const p=Texture(4,6,1,0,Formats.RGBA4).pasteData(Uint8Array.fromHex("ffff ffff ffff ffffffff 0000 0000 ffffffff 0000 0000 ffffffff 0000 0000 ffffffff 0000 0000 ffffffff ffff ffff ffff"));class b extends Map{rangeFactor=0;ascend=0;#R=[];_default={x:.05,y:-.0625,w:.5,h:.75,_xadv:.6,_tex:p};get then(){return this.#R?this.#P:void 0}#P(e,t){this.#R?.push(e,t)}done(){const e=this.#R;if(this.#R=null,e)for(let t=0;t<e.length;t+=2)e[t]?.(this)}error(e){const t=this.#R;if(this.#R=null,t)for(let s=1;s<t.length;s+=2)t[s]?.(e)}set(e=-1,t=0,s=null,n=0,o=0,r=0,i=0){if("string"==typeof e&&(e=e.codePointAt()),e<0){const e=this._default;s||t?(e.x=+n,e.y=+o,e.w=+r,e.h=+i,e._xadv=+t,e._tex=s):(e.x=e.y=e.w=e.h=e._xadv=0,e._tex=null)}else{if(!s&&!t)return super.delete(~e);super.set(~e,{x:+n,y:+o,w:+r,h:+i,_xadv:+t,_tex:s})}}getAdvance(e=-1){return"string"==typeof e&&(e=e.codePointAt()),(e<0?this._default:this.get(~e)??this._default)._xadv}setKerning(e,t,s=0){let n=0;if("string"==typeof e){const o=e.codePointAt();n=1114112*o,"number"==typeof t?(s=t,n+=e.codePointAt(1+(o>65535))):n+=t.codePointAt()}else n=1114112*e+t;s?super.set(n,s):super.delete(n)}getKerning(e,t){let s=0;if("string"==typeof e){const n=e.codePointAt();s=1114112*n,s+="string"==typeof t?t.codePointAt():void 0!==t?16777215&t:e.codePointAt(1+(n>65535))}else s=1114112*(16777215&e)+(16777215&t);return this.get(s)??0}chlumsky(t,s="atlas.png",n=e.ANISOTROPY|e.SMOOTH,o=1){return t.endsWith("/")&&(t+="index.json"),fetch(t).then(e=>(t=e.url,e.json())).then(r=>{const{atlas:{type:i,distanceRange:a,size:c,width:l,height:f},metrics:{ascender:h,descender:u},glyphs:p,kerning:b}=r;this.rangeFactor=a/c;const y=e.Texture.from(new URL(s,t).href,n,i.toLowerCase().endsWith("msdf")?e.Formats.RGB:e.Formats.RG,o);this.ascend=h/(h-u);for(const{unicode1:e,unicode2:t,advance:s}of b)super.set(t+1114112*e,s);for(const{unicode:e,advance:t,planeBounds:s,atlasBounds:n}of p)super.set(~e,s?{x:+s.left,y:+s.bottom,w:s.right-s.left,h:s.top-s.bottom,_xadv:t,_tex:y.sub(n.left/l,n.bottom/f,(n.right-n.left)/l,(n.top-n.bottom)/f)}:{x:0,y:0,w:0,h:0,_xadv:t,_tex:null});this.done()},this.error.bind(this)),this}bmfont(t,s=0,n=e.ANISOTROPY|e.SMOOTH,o=1){return fetch(t).then(e=>(t=e.url,e.json())).then(r=>{const{chars:i,distanceField:a,pages:c,common:{base:l,lineHeight:f,scaleW:h,scaleH:u},kernings:p}=r,b=1/r.info.size;this.rangeFactor=a.distanceRange/f;const y=this.ascend=l/f,g=c.map(s=>e.Texture.from(new URL(s,t).href,n,a.fieldType.toLowerCase().endsWith("msdf")?e.Formats.RGB:e.Formats.RG,o));for(const{first:e,second:t,amount:s}of p)super.set(t+1114112*e,s/b);for(const{id:e,x:t,y:n,width:o,height:r,xoffset:a,yoffset:c,xadvance:l,page:f}of i)super.set(e,{x:a*b,y:y-(c-s+r)*b,w:o*b,h:r*b,_xadv:l*b,_tex:o&&r?g[f].sub(t/h,1-(n+r)/u,o/h,r/u):null});this.done()},this.error.bind(this)),this}draw(e,t,s=[],n=0,o=-.5,r=0,i=-1){if(this.#R)return;r*=.5,n/=this.rangeFactor;const a=o<0&&e.projection;let l=o=1/o;a||(l*=(o<0?-e.pixelRatio():.5)*this.rangeFactor);for(const f of t){const t=f.codePointAt(),h=this.get(~t)??this._default;if(!h)continue;a&&(l=-e.pixelRatio()*this.rangeFactor*o);const u=this.get(t+1114112*i)??0;i=t;const p=h._xadv+r+r+u;h._tex&&(c.x=n,c.y=l,e.drawRect(h.x+r+u,h.y,h.w,h.h,h._tex,c,...s)),e.translate(p,0)}return i}measure(e,t=0,s=-1){if(this.#R)return;let n=0;for(const o of e){const e=o.codePointAt(),r=this.get(~e)??this._default;if(!r)continue;const i=this.get(e+1114112*s)??0;s=e,n+=r._xadv+t+i}return n}}e.Font=()=>new b,e.Font.bmfont=(e,t)=>(new b).bmfont(e,t),e.Font.chlumsky=(e,t)=>(new b).chlumsky(e,t)};{Object.defineProperties(Array.prototype,{best:{enumerable:!1,value(t,e=-1/0){let s;const i=this.length;for(let r=0;r<i;r++){const i=this[r],h=t(i,r,this);h>=e&&(e=h,s=i)}return s}},mmap:{enumerable:!1,value(t){const e=this.length;for(let s=0;s<e;s++)this[s]=t(this[s]);return this}},bind:{enumerable:!1,value(t,e=-1){if((e>>>=0)>=this.length)return this.push(t);let s;for(;e<this.length;)s=this[e],this[e++]=t,t=s;return this.push(s)}},fire:{enumerable:!1,value(...t){for(const e of this)try{e(...t)}catch(t){Promise.reject(t)}}},mapFire:{enumerable:!1,value(...t){const e=[];for(const s of this)try{e.push(s(...t))}catch(t){Promise.reject(t),e.push(void 0)}return e}}}),Uint8Array.fromHex=function(t){const e=new Uint8Array(t.length>>>1);let s=1,i=0;for(let r=0;r<t.length;r++){const h=t.charCodeAt(r);h>47&&h<58?s=s<<4|h-48:h>64&&h<71?s=s<<4|h-55:h>96&&h<103&&(s=s<<4|h-87),256&s&&(e[i++]=s,s=1)}return e.slice(0,i)},Uint16Array.fromHex=function(t){const e=new Uint16Array(t.length>>>2);let s=1,i=0;for(let r=0;r<t.length;r++){const h=t.charCodeAt(r);h>47&&h<58?s=s<<4|h-48:h>64&&h<71?s=s<<4|h-55:h>96&&h<103&&(s=s<<4|h-87),65536&s&&(e[i++]=s,s=1)}return e.slice(0,i)};const t="0123456789abcdef";Number.prototype.toHex=function(){return t[this>>>28]+t[this>>24&15]+t[this>>20&15]+t[this>>16&15]+t[this>>12&15]+t[this>>8&15]+t[this>>4&15]+t[15&this]},Number.formatData=t=>t<512?t.toFixed(0)+"B":t<524288?(t/1024).toFixed(1)+"KiB":t<536870912?(t/1048576).toFixed(1)+"MiB":t<549755813888?(t/1073741824).toFixed(1)+"GiB":(t/1099511627776).toFixed(1)+"TiB",Date.safestamp=(t=new Date)=>`${t.getYear()+1900}-${("0"+t.getMonth()).slice(-2)}-${("0"+t.getDate()).slice(-2)}-at-${("0"+t.getHours()).slice(-2)}-${("0"+t.getMinutes()).slice(-2)}-${("0"+t.getSeconds()).slice(-2)}`,Math.randint??=()=>4294967296*Math.random()|0;const e=document.createElement("a");globalThis.download=(t,s=t.name??("@"==t.type[0]?"file":t.type.split("/",1)[0]))=>{e.href=URL.createObjectURL(t),e.download=s,e.click(),URL.revokeObjectURL(e.href)},globalThis.loader=({url:t})=>(t=t.slice(0,t.lastIndexOf("/")+1),(...e)=>{if(e[0].raw){const s=[e[0][0]];for(let t=1;t<=e.length;t++)s.push(e[t],e[0][t]);const i=s.join("");return"/"==i[0]?i:t+i}return 1==e.length?"/"==e[0][0]?e[0]:t+e[0]:e.map(e=>"/"==e[0]?e:t+e)}),Array.map??=(t=0,e)=>{const s=[];for(let i=0;i<t;i++)s.push(e(i));return s},Gamma.utils=t=>{t.screenshot=(e="image/png",s)=>new Promise(i=>requestAnimationFrame(()=>t.canvas.toBlob(i,e,s)));class e{x=0;y=0;sensitivity=.5;constructor(t,e,s){this.contents=t,this.width=e,this.height=s}scrollBarX=i;scrollBarY=i;get scrollbar(){return this.scrollBarY}set scrollbar(t){this.scrollBarX=this.scrollBarY=t}consumeInputs(t){const{x:e,y:s}=t.fromDelta(scrollDelta),i=this.sensitivity;scrollDelta.x=scrollDelta.y=0;const r=this.contents.width,h=this.contents.height;this.x=this.width>0?max(0,min(this.x+e*i,r-this.width)):min(0,max(this.x+e*i,-r-this.width)),this.y=this.height>0?max(0,min(this.y+s*i,h-this.height)):min(0,max(this.y+s*i,-h-this.height)),rawWheel.x=rawWheel.y=0;const n=this.contents;n&&((t=t.sub()).translate((n.xOffset??0)-this.x,(n.yOffset??0)-this.y),n.consumeInputs?.(t))}draw(t,...e){const s=this.contents;if(!s?.draw)return;const i=t.mask,r=t.sub();if(r.mask=128,r.drawRect(0,0,this.width,this.height),r.mask=15&i|16,r.translate((s.xOffset??0)-this.x,(s.yOffset??0)-this.y),this.contents.draw(r,...e),t.clearStencil(),this.scrollBarX&&this.height){const e=t.sub();e.translate(0,this.height),this.height>0&&e.scale(1,-1);const i=abs(this.width),r=i/s.width;r<1&&this.scrollBarX(e,abs(this.x)*r,i*r)}if(this.scrollBarY&&this.width){const e=t.sub();e.translate(this.width,0),e.multiply(0,1),this.width>0&&e.scale(1,-1);const i=abs(this.height),r=i/s.height;r<1&&this.scrollBarY(e,abs(this.y)*r,i*r)}}}t.Scrollable=(t,s=1,i=-1)=>new e(t,+s,+i);const s=t.vec4(.2),i=t.Scrollable.defaultScrollbar=(t,e,i)=>{t.shader=null,t.drawRect(e,0,i,.1,s)}}}Gamma.gui=e=>{if(!e.RichText)throw"Initialize Gamma.font before Gamma.gui";const i=({target:t})=>(256&t._field._f||(t._field._f|=256,setImmediate(t._field.recalc)),t.remove(),r=null),s=t=>{const e=t.target._field;if(38==t.keyCode||40==t.keyCode){if(e._f>>1&1^t.shiftKey)38==t.keyCode?e.upArrowCb?.():e.downArrowCb?.();else if(2048&e._f)if(e.sel0==e.sel1){let i=e.sel0,s=i,h=e.sel0pos,n=h;for(;n;)i-=e.lines[--n].length;const r=e.lines[h].slice(0,i).width;if(38==t.keyCode&&h){const t=e.lines[h-1];e.sel0=e.sel1=s-i-t.length+t.indexAt(r)}else 40==t.keyCode&&h<e.lines.length-1&&(e.sel0=e.sel1=s-i+e.lines[h].length+e.lines[h+1].indexAt(r))}else 38==t.keyCode?e.sel0=e.sel1:e.sel1=e.sel0}else if(13==t.keyCode){if(!(e._f>>2&1^t.shiftKey))return;e.enterCb?.()}else{if(9!=t.keyCode)return;e._f>>3&1^t.shiftKey?e.tabCb?.():1&e._f&&e.insert("\t")}t.preventDefault()},h=(t,e)=>{const h=document.createElement(t);return h.style="width:1px;height:1px;border:0;padding:0;opacity:0;position:absolute;inset:-9px;font-size:1px;font-family:monospace;white-space:nowrap",h.onblur=i,h.onkeydown=s,h.tabIndex=-1,h._field=e,document.documentElement.append(h),h},n=e.vec4;let r=null,l=0;const c=(t,e)=>t.insertLinePass(-1,[e.focus?n(0,.2,.4,.6):n(.2,.2,.2,.6)],0,1),o=(t,i)=>{t.shader=null,(e.t-l)%1<.5&&t.drawRect(0,i.ascend-1,.05,1,n.one)};class a{_f=0;#t=0;#e=0;get allowTabs(){return!!(1&this._f)}set allowTabs(t){this._f=-2&this._f|1&t}get shiftArrows(){return!!(2&this._f)}set shiftArrows(t){this._f=-3&this._f|2&-t}get shiftEnter(){return!!(4&this._f)}set shiftEnter(t){this._f=-5&this._f|4&-t}get shiftTab(){return!!(8&this._f)}set shiftTab(t){this._f=-9&this._f|8&-t}upArrowCb=null;downArrowCb=null;enterCb=null;tabCb=null;scrollable=null;#i;constructor(t){this.#i=h(t?"textarea":"input",this),this._f=t}get value(){return this.#i.value}set value(t){this.#i.value=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}get sel0(){return this.#t}set sel0(t){t>>>=0,this.#e>=this.#t?t<=this.#e?this.#i.selectionStart=t:(this.#i.selectionStart=this.#e,this.#i.selectionEnd=t,this.#i.selectionDirection="backward"):t>this.#e?this.#i.selectionEnd=t:(this.#i.selectionStart=t,this.#i.selectionEnd=this.#e,this.#i.selectionDirection="forward"),this.#t=t}get sel1(){return this.#e}set sel1(t){t>>>=0,this.#e>=this.#t?t>=this.#t?this.#i.selectionEnd=t:(this.#i.selectionStart=t,this.#i.selectionEnd=this.#t,this.#i.selectionDirection="backward"):t<this.#t?this.#i.selectionStart=t:(this.#i.selectionStart=this.#t,this.#i.selectionEnd=t,this.#i.selectionDirection="forward"),this.#e=t}select(t,e=t){(t>>>=0)<=(e>>>=0)?(this.#i.selectionStart=t,this.#i.selectionEnd=e,this.#t>this.#e&&(this.#i.selectionDirection="forward")):(this.#i.selectionStart=e,this.#i.selectionEnd=t,this.#t<=this.#e&&(this.#i.selectionDirection="backward")),this.#t=t,this.#e=e,256&this._f||(this._f|=256,setImmediate(this.recalc))}get selStart(){return min(this.#t,this.#e)}get selEnd(){return max(this.#t,this.#e)}get isSelecting(){return!!(512&this._f)}#s=null;get transformer(){return this.#s}set transformer(t){this.#s!=(this.#s=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}simpleTransformer(t,i="",...s){let h=s.slice();h[0]=s[0]?n.multiply(s[0],.4):n(.4),this.#s=n=>{const r=e.RichText(t);return s.length&&r.addTextPass(0,s),n?r.add(n):(r.addTextPass(0,h),r.index=!1,r.add(i)),r},256&this._f||(this._f|=256,setImmediate(this.recalc))}#h=o;#n=c;#r=null;#l=null;#c=1/0;#o=0;#a=0;#f=0;get sel0pos(){return this.#o}get sel1pos(){return this.#a}get multiline(){return!!(2048&this._f)}set multiline(t=!0){const e=this.#i,i=e.value,s=document.activeElement==e;if(t){if(2048&this._f)return;this.#r=null,this._f|=2304,this.#i=h("textarea",this)}else{if(!(2048&this._f))return;this.#l=null,this._f=-2049&this._f|256,this.#i=h("input",this)}s?this.focus=!0:(e.remove(),r==e&&(r=null),256&this._f||(this._f|=256,setImmediate(this.recalc))),this.#i.value=i,this.#i.selectionStart=this.#t,this.#i.selectionEnd=this.#e,this.#i.selectionDirection=this.#t>this.#e?"backward":"forward"}get width(){return this.#f}get line(){return this.#r}get lines(){return this.#l}get cursor(){return this.#h}set cursor(t){this.#h!=(this.#h=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get selector(){return this.#n}set selector(t){this.#n!=(this.#n=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get maxWidth(){return this.#c}set maxWidth(t){this.#c=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}recalc=()=>{const t=this._f;if(!(256&t))return;const i=this.#i,s=min(this.#t,this.#e),h=max(this.#t,this.#e);this._f=-257&t,l=e.t;const n=i.value,r=this.#s?.(n,this)??e.RichText();if(s==h){const e=r.slice(s);r.trim(s),2048&t||(this.#o=this.#a=r.width),this.#h&&document.activeElement==this.#i&&r.addCb(this.#h),r.concat(e)}else{const e=r.slice(s),i=e.slice(h-s);e.trim(h-s),r.trim(s),2048&t?(this.#n?.(e,this),r.concat(e)):(this.#o=r.width,this.#n?.(e,this),r.concat(e),this.#a=r.width),r.concat(i)}if(2048&t){const t=this.#l=r.break(this.#c);let e=0;for(const{width:i}of t)i>e&&(e=i);this.#f=e;let i=s,n=0;for(;n<t.length&&i>=0;)i-=t[n++].length;for(i=h-s+i+(n?t[--n].length:0),this.#o=n;n<t.length&&i>=0;)i-=t[n++].length;this.#a=n?n-1:0}else this.#r=r,this.#f=r.width};insert(t="",e=t.length){const i=this.#i,s=i.selectionStart;i.setRangeText(t,s,i.selectionEnd,"start"),i.selectionStart=i.selectionEnd=this.#t=this.#e=s+e}get focus(){return document.activeElement==this.#i}set focus(t=!0){if(t){if(r){if(r==this.#i)return;r.replaceWith(r=this.#i)}else document.documentElement.append(r=this.#i);r.focus(),l=e.t}else r==this.#i&&(r.remove(),r=null)}lineHeight=1.3;lineAscend=.9;#d=0;get height(){return this.lineHeight*(this.#l?this.#l.length:1)}consumeInputs(i,{x:s,y:h}=i.from(e.cursor),n=e.keys.has(0)){if(h=this.lineAscend-h,cursorType="text",!n)return void(this._f&=-513);document.activeElement!=this.#i&&(this.focus=!0);const r=this._f>>9&1;let l=0;if(this.#r)l=this.#r.indexAt(s);else if(this.#l){let t=floor(h/this.lineHeight);for(t=t<0?0:t>=this.#l.length?this.#l.length-1:t,l=this.#l[t].indexAt(s);t;)l+=this.#l[--t].length}if(r)this.sel1=l;else{let e=0,i=l,s=l;if(this.#d<0?this.#d-(this.#d=-t)<.3?e=2:this.#d=t:this.#d>0?this.#d-(this.#d=t)>-.3&&(e=1,this.#d=-t):this.#d=t,this._f|=512,e){const t=this.#i.value,h=33-e;for(;t.charCodeAt(s++)>h;);for(;t.charCodeAt(--i)>h;);i++,s--}i==this.#t&&s==this.#e||this.select(i,s)}}get height(){return this.#l?this.#l.length*this.lineHeight:this.lineHeight}get xOffset(){return 0}get yOffset(){return-this.lineAscend}draw(t){if(this.#l)for(const e of this.#l)e.draw(t.sub()),t.translate(0,-this.lineHeight);else this.#r?.draw(t)}static#u=(document.addEventListener("input",({target:t})=>{const e=t._field;if(!e)return;const{selectionStart:i,selectionEnd:s,selectionDirection:h}=t;"backward"==h?(e.#t=s,e.#e=i):(e.#t=i,e.#e=s),256&e._f||(e._f|=256,setImmediate(e.recalc))}),document.addEventListener("selectionchange",({target:t})=>{const e=t._field;if(!e)return;const{selectionStart:i,selectionEnd:s,selectionDirection:h}=t;"backward"==h?(e.#t=s,e.#e=i):(e.#t=i,e.#e=s),256&e._f||(e._f|=256,setImmediate(e.recalc))}))}e.TextField=(t=!1)=>new a(t<<11&2048),e.TextField.cursorTimer=()=>e.t-l};globalThis.BitField??=class e extends Array{constructor(e){if(super(),Array.isArray(e))for(let t=0;t<e.length;t++)this.push(e[t]);else if(e instanceof Uint8Array)for(let t=0;t<e.length;t+=4)this.push(e[t]|e[1|t]<<8|e[2|t]<<16|e[3|t]<<24);else if(e)for(const t of e)this.set(t)}static parse(t){return Array.isArray(t)?Object.setPrototypeOf(t,e.prototype):new e}static decode(t,r=new e){r.length=0;let o=t.v32();for(;o--;)r.push(t.i32())}static encode(e,t){const r=t.length;e.v32(r);for(let t=0;t<r;t++)e.i32(this[t])}static of(...t){const r=new e;for(const e of t)r.set(e);return r}set(e){const t=e>>>5;for(;t>=this.length;)this.push(0);this[t]|=1<<(31&e)}unset(e){let t=this.length;const r=e>>>5;if(!(r>=t))for(this[r]&=~(1<<(31&e));t&&!this[--t];)super.pop()}toggle(e){let t=this.length;const r=e>>>5;for(;r>=t;)this.push(0),t++;for(this[r]^=1<<(31&e);t&&!this[--t];)super.pop()}has(e){const t=e>>>5;return!(t>=this.length)&&!!(this[t]&1<<(31&e))}pop(e){let t=e>>>5;if(t>=this.length)return!1;let r=this[t];if(r^=this[t]=r&~(1<<(31&e)),t==this.length-1)for(;t>=0&&!this[t--];)super.pop();return!!r}put(e){let t=e>>>5;for(;t>=this.length;)this.push(0);return!!(this[t]^(this[t]|=1<<(31&e)))}xor(e){let t=this.length;if(t==e.length)for(;t&&this[--t]==e[t];)super.pop();else{let r=t;for(t--;r<e.length;)this.push(e[r++])}for(let r=t;r>=0;r--)this[r]^=e[r]}and(e){let t=this.length;for(this.length>e.length&&(t=this.length=e.length);t&&!(this[--t]&e[t]);)super.pop();for(;t>0;)this[--t]&=e[t]}or(e){let t=this.length-1,r=t;for(;++r<e.length;)this.push(e[r]);for(let r=t;r>=0;r--)this[r]|=e[r]}firstUnset(){let e=-1;for(;++e<this.length;){const t=~this[e];if(t)return e<<5|31-clz32(t&-t)}return e<<5}firstSet(){let e=-1;for(;++e<this.length;)if(this[e])return e<<5|31-clz32(this[e]&-this[e]);return-1}lastSet(){let e=this.length;for(;--e>=0;)if(this[e])return e<<5|31-clz32(this[e]);return-1}popFirst(){let e=-1;for(;++e<this.length;)if(this[e]){let t=31-clz32(this[e]&-this[e]);for(this[e]&=~(1<<t),t|=e<<5,e=this.length;e&&!this[--e];)super.pop();return t}return-1}putFirst(){let e=-1;for(;++e<this.length;){const t=~this[e];if(!t)continue;const r=31-clz32(t&-t);return this[e]|=1<<r,e<<5|r}return this.push(1),e<<5}popLast(){let e=this.length;for(;--e>=0;)if(this[e]){let t=31-Math.clz32(this[e]);for(this[e]&=~(1<<t),t|=e<<5,e=this.length;e&&!this[--e];)super.pop();return t}return-1}clear(){this.length=0}[Symbol.iterator](){const e={value:0,done:!1};let t=0,r=-1;return{[Symbol.iterator](){return this},next:()=>{for(;t<this.length;t++,r=-1){const o=this[t]&r,n=31-clz32(o&-o);if(!(n<0))return r=-2<<n,e.value=t<<5|n,e}return t=1/0,e.done=!0,e}}}iter(e){for(let t=0;t<this.length;t++){let r=-1;for(;;){const o=this[t]&r,n=31-clz32(o&-o);if(n<0)break;r=-2<<n,e(t<<5|n)}}}[Symbol.for("nodejs.util.inspect.custom")](){let e="",t=0;for(let r=0;r<this.length;r++){let o=-1;for(;;){const n=this[r]&o,s=31-clz32(n&-n);if(s<0)break;o=-2<<s,e+=" "+(r<<5|s),t++}}return`BitField(${t}) {[33m${e} [m}`}toUint8Array(){let e=this.length-1,t=this[e],r=0;const o=new Uint8Array(e=(e<<2)+(39-clz32(t)>>3));for(;r<e;r+=4){const e=this[r>>2];o[r]=e,o[1|r]=e>>8,o[2|r]=o>>16,o[3|r]=o>>24}for(r-=4;r<e;)o[r++]=t,t>>=8;return o}},"remove"in Array.prototype||Object.defineProperty(Array.prototype,"remove",{value(e){let t=this.indexOf(e);if(t>=0){for(;t<b.length;)b[t]=b[++t];b.pop()}return t},enumerable:!1,configurable:!0});{let e=null,t=null;const r={__proto__:null,ContextMenu:93,Help:26,Semicolon:186,Quote:222,BracketLeft:219,BracketRight:221,Backquote:192,Backslash:220,Minus:189,EQUAL:187,IntlRo:193,IntlYen:255,MetaLeft:91,MetaRight:91,PrintScreen:44,ScrollLock:145,Pause:19,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NumLock:144,Clear:10,NumpadComma:110,NumpadDecimal:110,Numpad0:96,Numpad1:97,Numpad2:98,Numpad3:99,Numpad4:100,Numpad5:101,Numpad6:102,Numpad7:103,Numpad8:104,Numpad9:105};Gamma.input=(r,o=r.canvas)=>{const n=r.keys=new BitField;r.MOUSE=Object.freeze({LEFT:0,RIGHT:2,MIDDLE:1,BACK:3,FORWARD:4}),r.KEY=Object.freeze({A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,can:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,SPACE:32,BACKTICK:192,TAB:9,BACK:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,META:91,METARIGHT:93,CAPSLOCK:20,UP:38,RIGHT:39,DOWN:40,LEFT:37,MOD:navigator.platform.startsWith("Mac")?91:17,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,MINUS:189,EQUAL:187,BR_LEFT:219,BR_RIGHT:221,SEMICOLON:186,APOS:222,BACKSLASH:220,COMMA:188,DOT:190,SLASH:191,PAUSE:19,PAD_ENTER:12,CLEAR:10,HOME:36,END:35,PAGE_UP:33,PAGE_DOWN:34,INS:45,DEL:46,CTX_MENU:93,PAD_0:96,PAD_1:97,PAD_2:98,PAD_3:99,PAD_4:100,PAD_5:101,PAD_6:102,PAD_7:103,PAD_8:104,PAD_9:105,PAD_DIV:111,PAD_MULT:106,PAD_SUB:109,PAD_ADD:107,PAD_DOT:110,NUM_LOCK:144,SCROLL_LOCK:145,HELP:26,RO:193,YEN:255,SYSRQ:44,PRINT_SCREEN:44}),r.GAMEPAD=Object.freeze({A:256,B:257,X:258,Y:259,LB:260,RB:261,LT:262,RT:263,UP:268,DOWN:269,LEFT:270,RIGHT:271,MENU:300}),r.rawMouse=r.vec2(.5),r.rawWheel=r.vec2(),r.cursor=r.vec2(.5),r.scrollDelta=r.vec2();const s="undefined"!=typeof ApplePaySession&&!("letterSpacing"in CanvasRenderingContext2D.prototype);navigator.platform.startsWith("Linux");Object.defineProperty(r,"pointerLock",{get:()=>document.pointerLockElement==o,set:e=>{e?document.pointerLockElement!==o&&o.requestPointerLock()?.catch(e=>null):document.pointerLockElement===o&&document.exitPointerLock()}}),Object.defineProperty(r,"fullscreen",{get:()=>document.fullscreenElement==o,set:e=>{e?document.fullscreenElement!==o&&o.requestFullscreen()?.catch(e=>null):document.fullscreenElement===o&&document.exitFullscreen()}});const i=new Map;(r.onKey=(e,t)=>{if(Array.isArray(e)){for(const o of e)r.onKey(o,t);return}const o=i.get(e&=65535);o?o.push(t):i.set(e,[t])}).remove=(e,t)=>{if(Array.isArray(e)){for(const o of e)r.onKey.remove(o,t);return}const o=i.get(e&=65535);o&&(o.remove(t),!o.length)&&i.delete(e)},(r.onKeyRelease=(e,t)=>{if(Array.isArray(e)){for(const o of e)r.onKeyRelease(o,t);return}const o=i.get(e=~(65535&e));o?o.push(t):i.set(e,[t])}).remove=(e,t)=>{if(Array.isArray(e)){for(const o of e)r.onKeyRelease.remove(o,t);return}const o=i.get(e=~(65535&e));o&&(o.remove(t),!o.length)&&i.delete(e)};const l=[],c=[];(r.onWheel=e=>{l.push(e)}).remove=e=>{l.remove(e)},(r.onMouse=e=>{c.push(e)}).remove=e=>{c.remove(e)},o.style.cursor="default",Object.defineProperty(r,"cursorType",{get:()=>o.style.cursor,set(e){o.style.cursor=e||"default"}}),o.addEventListener("mouseover",r=>{e||(e=n,t=i)}),o.addEventListener("mouseout",r=>{e==n&&(n.iter(e=>{const t=i.get(~e);if(t)for(const r of t)try{r(e)}catch(e){Promise.reject(e)}}),n.clear(),e=t=null)}),o.addEventListener("mousedown",e=>{e.preventDefault();const t=e.button;n.set(t);const r=i.get(t);if(r)for(const o of r)try{o(t)}catch(e){Promise.reject(e)}}),o.addEventListener("mouseup",e=>{e.preventDefault();const t=e.button;if(!n.pop(t))return;const r=i.get(~t);if(r)for(const o of r)try{o(t)}catch(e){Promise.reject(e)}}),o.addEventListener("contextmenu",e=>e.preventDefault()),o.addEventListener("wheel",e=>{e.preventDefault(),r.rawWheel.x+=e.wheelDeltaX,r.rawWheel.y+=e.wheelDeltaY,r.scrollDelta.x+=e.wheelDeltaX/innerWidth,r.scrollDelta.y+=e.wheelDeltaY/innerHeight;for(const t of l)t(e.wheelDeltaX,e.wheelDeltaY)},{passive:!1});let h=NaN,u=NaN;o.addEventListener("mousemove",e=>{e.preventDefault();const t=o.offsetWidth,n=o.offsetHeight;r.cursor.x=e.offsetX/t,r.cursor.y=1-e.offsetY/n;let i=0,c=0;if(document.pointerLockElement==o)if(i=e.movementX,c=e.movementY,s){const{width:e,height:r}=o.getBoundingClientRect();i*=devicePixelRatio*t/e,c*=devicePixelRatio*n/r}else i*=devicePixelRatio,c*=devicePixelRatio;else h==h&&(i=e.offsetX-h,c=e.offsetY-u);r.rawMouse.x+=i,r.rawMouse.y-=c;for(const e of l)e(i,c);h=e.offsetX,u=e.offsetY})},document.addEventListener("keydown",o=>{if(!e)return;if(document.activeElement!=document.body&&document.activeElement||o.preventDefault(),o.repeat)return;const n=r[o.code]??o.keyCode;e.set(n);const s=t.get(n);if(s)for(const e of s)try{e(n)}catch(o){Promise.reject(o)}}),document.addEventListener("keyup",o=>{if(!e)return;document.activeElement!=document.body&&document.activeElement||o.preventDefault();const n=r[o.code]??o.keyCode;if(!e.pop(n))return;const s=t.get(~n);if(s)for(const e of s)try{e(n)}catch(o){Promise.reject(o)}})}{const $=globalThis;Math.PI2??=2*Math.PI,Math.HALF_SQRT3??=.8660254037844386,Math.clamp??=(t,s,r)=>t<s?s:t>r?r:t;const{clz32:t,cos:s,sin:r,min:o,round:u}=Math;if(!("setImmediate"in $)){let t=0,s=0,r=[],n=new MessageChannel;n.port1.onmessage=()=>{const n=r[s];r[s++]=null,s>3&&s>r.length>>1&&(r.splice(0,s),t+=s,s=0),n?.()},n=n.port2,$.setImmediate=(s,...o)=>(n.postMessage(0),r.push(o.length?s.bind(void 0,...o):s),r.length-1+t),$.clearImmediate=i=>{(i-=t)===i>>>0&&(i>=r.length||(r[i]=null))}}if(!("sin"in $)){const t=Object.getOwnPropertyDescriptors(Math);delete t[Symbol.toStringTag],Object.defineProperties($,t)}const p={imageOrientation:"flipY",premultiplyAlpha:"premultiply"},v=(t,s,r)=>"string"==typeof t?fetch(t).then(a=>a.blob()).then(t=>createImageBitmap(t,p)).then(s,r):t instanceof Blob?createImageBitmap(t,p).then(s,r):s(t);$.Gamma=(p=document.createElement("canvas"),$={},m=15)=>{const _=$.gl=($.canvas=p).getContext("webgl2",{preserveDrawingBuffer:!(8&m),antialias:16&m,depth:!1,premultipliedAlpha:4&m,stencil:1&m,alpha:2&m});_.pixelStorei(37440,1),_.stencilMask(1),_.clearStencil(0),_.disable(2929),_.enable(3042),_.pixelStorei(3317,1),_.pixelStorei(3333,1);const g=_.createBuffer();_.bindBuffer(35052,g);let A=!0,R=null,G=-1,E=!1,T=285217039,$s=null,$v=null,L=0,B=0,$u=0,N=null,$X=0,$x=0,S=5,F=0,I=4,$p=null,O=0;_.bindFramebuffer(36008,_.createFramebuffer());const P=_.createFramebuffer(),$M=_.createBuffer();_.bindBuffer(34962,$M);const j=o(32,_.getParameter(34930)),U=[];for(let i=j<<1;i-- >0;)U.push(null);Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NEVER:48,UNSET:64,SET:128,FLIP:192,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:136,RGB_DST:8,ONE_MINUS_DST:153,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,ADD:17,RGB_ADD:1,A_ADD:16,SUB:85,RGB_SUB:5,A_SUB:80,SUB_REV:102,RGB_SUB_REV:6,A_SUB_REV:96,MIN:34,RGB_MIN:2,A_MIN:32,MAX:51,RGB_MAX:3,A_MAX:48,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:28,FTEXTURE:29,ITEXTURE:30,UTEXTURE:31,COLOR:12,FCOLOR:13,ICOLOR:14,UCOLOR:15,FLAT:64,CW_ONLY:16,CCW_ONLY:32,ANISOTROPY:128,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0}),$.Formats={R:[33321,6403,5121],RG:[33323,33319,5121],RGB:[32849,6407,5121],RGBA:[32856,6408,5121],RGB565:[36194,6407,33635],R11F_G11F_B10F:[35898,6407,35899],RGB5_A1:[32855,6408,32820],RGB10_A2:[32857,6408,33640],RGBA4:[32854,6408,32819],RGB9_E5:[35901,6407,35902],R8:[33330,36244,5121,1<<31],RG8:[33336,33320,5121,1<<31],RGB8:[36221,36248,5121,1<<31],RGBA8:[36220,36249,5121,1<<31],R16:[33332,36244,5123,1<<31],RG16:[33338,33320,5123,1<<31],RGB16:[36215,36248,5123,1<<31],RGBA16:[36214,36249,5123,1<<31],R32:[33334,36244,5125,1<<31],RG32:[33340,33320,5125,1<<31],RGB32:[36209,36248,5125,1<<31],RGBA32:[36208,36249,5125,1<<31],R16F:[33325,6403,5131],RG16F:[33327,33319,5131],RGB16F:[34843,6407,5131],RGBA16F:[34842,6408,5131],R16F_32F:[33325,6403,5126],RG16F_32F:[33327,33319,5126],RGB16F_32F:[34843,6407,5126],RGBA16F_32F:[34842,6408,5126],R32F:[33326,6403,5126],RG32F:[33328,33319,5126],RGB32F:[34837,6407,5126],RGBA32F:[34836,6408,5126]},$.vec2=(x=0,y=x)=>({x:x,y:y}),$.vec2.one=$.vec2(1);const C=$.vec2.zero=$.vec2(0);$.vec2.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b}:{x:a.x+b.x,y:a.y+b.y},$.vec2.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b}:{x:a.x*b.x,y:a.y*b.y},$.vec2.magnitude=a=>sqrt(a.x*a.x+a.y*a.y),$.vec2.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y);return{x:a.x*d,y:a.y*d}},$.vec3=(x=0,y=x,z=x)=>({x:x,y:y,z:z}),$.vec3.one=$.vec3(1);const M=$.vec3.zero=$.vec3(0);$.vec3.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z},$.vec3.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z},$.vec3.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z),$.vec3.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z);return{x:a.x*d,y:a.y*d,z:a.z*d}},$.vec4=(x=0,y=x,z=x,w=x)=>({x:x,y:y,z:z,w:w}),$.vec4.one=$.vec4(1);const D=$.vec4.zero=$.vec4(0);$.vec4.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b,w:a.w+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z,w:a.w+b.w},$.vec4.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b,w:a.w*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z,w:a.w*b.w},$.vec4.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w),$.vec4.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w);return{x:a.x*d,y:a.y*d,z:a.z*d,w:a.w*d}};const X=_.getExtension("EXT_texture_filter_anisotropic")?_.getParameter(34047):0;class $m{get isInteger(){return this.t.f.length>3}get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get mipmaps(){return this.t.m}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get identity(){return this.t}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,x=0,y=0,w=1,h=1,l=0){this.t=t,this.x=x,this.y=y,this.w=w,this.h=h,this.l=l}get loaded(){return!this.t.src}get waiting(){return!this.t.$}get then(){return this.t.src?this.#t:null}load(){this.t.$||$m.load(this.t)}sub(x=0,y=0,w=1,h=1,l=this.l){return new $m(this.t,this.x+x*this.w,this.y+y*this.h,this.w*w,this.h*h,l)}super(x=0,y=0,w=1,h=1,l=this.l){const t=this.w/w,s=this.h/h;return new $m(this.t,this.x-x*t,this.y-y*s,t,s,l)}crop(x=0,y=0,w=0,h=0,l=this.l){const{t:t,x:s,y:r,h:n}=this;if(!t.src)return new $m(t,s+x/t.w,r+n-(y+h)/t.h,w/t.w,h/t.h,l);const i=new $m(t,0,0,0,0,l);return t.$||$m.load(t),t.src.push(i=>{i.x=s+x/t.w,i.y=r+n-(y+h)/t.h,i.w=w/t.w,i.h=h/t.h},void 0,i),i}layer(l=this.l){return new $m(this.t,this.x,this.y,this.w,this.h,l)}#t(t,s){"function"!=typeof t&&(t=Function.prototype),this.t.src?(this.t.$||$m.load(this.t),this.t.src.push(t,s,this)):t(this)}static load(t){let s=t.src,r=0;t.src=[];let w=0,h=0;t.$=_.createTexture();const n=()=>{r=-1,$m.setOptions(t),_.texStorage3D(35866,t.m=1,t.f[0],t.w=w=1,t.h=h=1,t.d),A||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),A=!0),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const s=t.src;t.src=null;for(let i=1;i<s.length;i+=3)s[i]?.(s[i+1])};for(let i=0;i<s.length;i++)v(s[i],u=>{if(r){if(w!=u.width||h!=u.height)return n()}else w=u.width,h=u.height;if(s[i]=u,++r<s.length)return;$m.setOptions(t),_.texStorage3D(35866,t.m=o(t.m,floor(log2(max(w,h)))+1),t.f[0],t.w=w,t.h=h,t.d),A||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),A=!0),_.bindBuffer(35052,null);for(let l=0;l<r;l++)_.texSubImage3D(35866,0,0,0,l,w,h,1,t.f[1],t.f[2],s[l]);_.bindBuffer(35052,g),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const p=t.src;t.src=null;for(let i=0;i<p.length;i+=3)p[i](p[i+2])},n)}paste(t,x=0,y=0,l=0,s=0,r=0,n=0,o=0,u=0,p=0,m=0,R=0){const{t:G}=this;if(G.src)return null;if(t.msaa)return i&&draw(),p=u||t.height,u=o||t.width,_.framebufferRenderbuffer(36008,36064,36161,t.$),N!=P&&(_.bindFramebuffer(36009,N=P),curt=Q=null),_.framebufferTextureLayer(36009,36064,G.$,s,l),_.blitFramebuffer(r,n,r+u,n+p,x,y,x+u,y+p,16384,9728),this;if(!(t instanceof $m))return v(t,i=>($m.fakeBind(G),A||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),A=!0),_.bindBuffer(35052,null),_.texSubImage3D(35866,s,x,y,l,i.width,i.height,1,G.f[1],G.f[2],i),_.bindBuffer(35052,g),G.i<0&&_.bindTexture(35866,null),this));const{t:E}=t;if(E.src)return console.warn("Source texture is not loaded"),this;if(G.$==E.$)return console.warn("Cannot copy from texture to itself"),this;for($m.fakeBind(G),u=u||E.w,p=p||E.h,m=m||E.d;m--;)_.framebufferTextureLayer(36008,36064,E.$,R,o++),_.copyTexSubImage3D(35866,s,x,y,l++,r,n,u,p);return G.i<0&&_.bindTexture(35866,null),this}pasteData(t,x=0,y=0,l=0,w=0,h=0,d=0,s=0){const{t:r}=this;return r.src?null:(w=w||r.w,h=h||r.h,d=d||r.d,$m.fakeBind(r),A&&(_.pixelStorei(37440,0),_.pixelStorei(37441,0),A=!1),_.bufferData(35052,t,35042),_.texSubImage3D(35866,s,x,y,l,w,h,d,r.f[1],r.f[2],0),_t+=.25*t.byteLength,r.i<0&&_.bindTexture(35866,null),this)}readData(x=0,y=0,l=0,w=0,h=0,d=0,t=0){const{t:s}=this;if(s.src)return null;w=w||s.w,h=h||s.h,d=d||s.d,i&&draw();let a=s.f[0],r=33323==a||33338==a||33340==a||33327==a||33328==a||33336==a?2:33321==a||33330==a||33332==a||33334==a||33325==a||33326==a?1:4,n=r<=2?1==r?6403:33319:3==r?6407:6408;a=s.f[2]==5121?1:s.f[2]==5126||s.f[2]==5125||s.f[2]==35899||s.f[2]==33640||s.f[2]==35902?4:2,r*=w*h;let o,u=r*d*a;for(G==u?(o=R,G=-1,E=!0):(_.bindBuffer(35051,o=_.createBuffer()),_.bufferData(35051,u,35041),u>G&&(G=u,R=o,E=!0));d--;)_.framebufferTextureLayer(36008,36064,s.$,t,l),_.readPixels(x,y,w,h,n,s.f[2],r*a*l++);return o!=R&&_.bindBuffer(35051,R),new Promise(t=>{const n=()=>{const $i=1==a?new Uint8Array(r*d):4==a?s.f[2]==5126?new Float32Array(r*d):new Uint32Array(r*d):new Uint16Array(r*d);o!=R&&_.bindBuffer(35051,o),_.getBufferSubData(35051,0,$i),t($i),o!=R&&(u>G?(G=u,R=o):_.bindBuffer(35051,R)),E=!0};n.sync=_.fenceSync(37143,0),bt??=n,vt=vt?vt.next=n:n,gt||(gt=setInterval(pt,0))})}delete(){this.t.$&&(_.deleteTexture(this.t.$),this.t.$=null,this.t.i>=0&&(U[this.t.i]=null,this.t.i=-1),this.t.d=this.t.w=this.t.h=0)}static auto(s,i=0){if(s.f[3]>>31!=i)return-2;if(s.i>=0){const t=-2147483648>>>s.i-(j-L&i);if(!(t&(i^B)))return $X|=t,s.i;U[s.i]=null,s.i=-1}s.$||$m.load(s);const r=t(~($X|i^B));if(r>=j)return-1;$X|=-2147483648>>>r;const n=U[i=i?j+r-L:r];return n&&(n.i=-1),_.activeTexture(33984+i),_.bindTexture(35866,(U[i]=s).$),s.i=i}static fakeBind(t){if(t.i>=0)i&&draw(),_.activeTexture(33984+t.i);else{const s=j-1+(L==j&&j);U[s]&&(U[s].t.i=-1),_.activeTexture(33984+s),_.bindTexture(35866,t.$)}}get options(){return this.t.o}static setOptions(t){$m.fakeBind(t);const{o:s}=t;X&&_.texParameterf(35866,34046,128&s?X:1),t.f[3]>>31?(_.texParameterf(35866,10240,9728),_.texParameterf(35866,10241,9728)):(_.texParameterf(35866,10240,9728+(1&s)),_.texParameterf(35866,10241,t.m>1?9984+(s>>1&3):9728+(s>>1&1))),_.texParameterf(35866,10242,8&s?10497:16&s?33648:33071),_.texParameterf(35866,10243,32&s?10497:64&s?33648:33071)}set options(t){const{t:s}=this;s.o=t,s.src||($m.setOptions(s),s.i<0&&_.bindTexture(35866,null))}setMipmapRange(t=0,e=65535){const{t:s}=this;s.src||($m.fakeBind(s),_.texParameteri(35866,33082,t),_.texParameteri(35866,33083,e),s.i<0&&_.bindTexture(35866,null))}genMipmaps(){const{t:t}=this;t.m<2||($m.fakeBind(t),_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null))}}$.Drawable=(t=!1)=>new q({_:_.createFramebuffer(),p:0,T:t?_.createRenderbuffer():null,w:0,h:0,u:0}),$.Drawable.MAX_TARGETS=_.getParameter(36063);let $i=new Float32Array(1024),$I=new Int32Array($i.buffer),i=0;$.Texture=(w=0,h=0,d=1,t=0,f=Formats.RGBA,s=0)=>{s=o(s>>>0||1,floor(log2(max(w,h)))+1),w>>>=0,h>>>=0;const r={$:_.createTexture(),i:-1,o:t,f:f,src:null,w:w,h:h,d:d=d>>>0||1,m:s},n=new $m(r);return $m.setOptions(r),w&&h?_.texStorage3D(35866,s,r.f[0],w,h,d):_.texStorage3D(35866,1,r.f[0],r.w=1,r.h=1,d),_.bindTexture(35866,null),n},$.Texture.MAX_WIDTH=$.Texture.MAX_HEIGHT=_.getParameter(3379),$.Texture.MAX_LAYERS=_.getParameter(35071),$.Texture.FILTER_32F=!!_.getExtension("OES_texture_float_linear");const V=$.Texture.MAX_MSAA=_.getParameter(36183);$.Texture.MSAA=(w=0,h=0,t=65536,f=Formats.RGBA)=>{t=o(t,V);const s=_.createRenderbuffer();return _.bindRenderbuffer(36161,s),_.renderbufferStorageMultisample(36161,t,f[0],w,h),{$:s,width:w,height:h,msaa:_.getRenderbufferParameter(36161,36011),delete(){_.deleteRenderbuffer(this.$)}}},$.Texture.from=(t,s=0,r=Formats.RGBA,n=0)=>new $m({$:null,i:-1,o:s,f:r,src:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:t?Array.isArray(t)?t.length:1:0,m:n||1});class Y{constructor(a=1,b=0,c=0,d=1,e=0,f=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f}translate(x=0,y=0){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d}=this;this.a=a*n-c*o,this.b=b*n-d*o,this.c=a*o+c*n,this.d=b*o+d*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d;this.a=t*a+r*b,this.b=s*a+n*b,this.c=t*c+r*d,this.d=s*c+n*d,this.e+=t*e+r*f,this.f+=s*e+n*f}skew(x=0,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a+c*y,this.b=b+d*y,this.c=c+a*x,this.d=d+b*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a*x-c*y,this.b=b*x-d*y,this.c=c*x+a*y,this.d=d*x+b*y}box(x=0,y=0,w=1,h=w){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d,this.a*=w,this.b*=w,this.c*=h,this.d*=h}}class k{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i}translate(x=0,y=0){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*n-d*o,this.b=b*n-e*o,this.c=c*n-f*o,this.d=a*o+d*n,this.e=b*o+e*n,this.f=c*o+f*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d,o=this.e,u=this.f;this.a=t*a+n*b,this.b=s*a+o*b,this.c=r*a+u*b,this.d=t*c+n*d,this.e=s*c+o*d,this.f=r*c+u*d,this.g+=t*e+n*f,this.h+=s*e+o*f,this.i+=r*e+u*f}skew(x=0,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a+d*y,this.b=b+e*y,this.c=c+f*y,this.d=d+a*x,this.e=e+b*x,this.f=f+c*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*x-d*y,this.b=b*x-e*y,this.c=c*x-f*y,this.d=a*y+d*x,this.d=b*y+e*x,this.f=c*y+f*x}box(x=0,y=0,w=1,h=w){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h}}class Z{constructor(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h}translate(x=0,y=0,z=0){this.g+=x*this.a+y*this.c+z*this.e,this.h+=x*this.b+y*this.d+z*this.f}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y,this.e*=z,this.f*=z}rotateXZ(t){let n=r(t),o=s(t);const{a:a,b:b,e:e,f:f}=this;this.a=o*a-n*e,this.e=o*e+n*a,this.b=o*b-n*f,this.f=o*f+n*b}rotateXY(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,d:d}=this;this.a=o*a-n*c,this.c=o*c+n*a,this.b=o*b-n*d,this.d=o*d+n*b}rotateZY(t){let n=r(t),o=s(t);const{c:c,d:d,e:e,f:f}=this;this.e=o*e-n*c,this.c=o*c+n*e,this.f=o*f-n*d,this.d=o*d+n*f}multiplyXZ(x=1,y=0){const{a:a,b:b,e:e,f:f}=this;this.a=x*a-y*e,this.e=x*e+y*a,this.b=x*b-y*f,this.f=x*f+y*b}multiplyXY(x=1,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=x*a-y*c,this.c=x*c+y*a,this.b=x*b-y*d,this.d=x*d+y*b}multiplyZY(x=1,y=0){const{c:c,d:d,e:e,f:f}=this;this.e=x*e-y*c,this.c=x*c+y*e,this.f=x*f-y*d,this.d=x*d+y*f}skewX(t=0,s=0){this.a+=s*this.c+t*this.e,this.b+=s*this.d+t*this.f}skewY(t=0,s=0){this.c+=t*this.a+s*this.e,this.d+=t*this.b+s*this.f}skewZ(t=0,s=0){this.e+=t*this.a+s*this.c,this.f+=t*this.b+s*this.d}skew(t=0,s=0,r=0,n=0,o=0,u=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a+s*c+t*e,this.b=b+s*d+t*f,this.c=c+r*a+n*e,this.d=d+r*b+n*f,this.e=e+o*a+u*c,this.f=f+o*b+u*d}transform(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=this.a,o=this.b,u=this.c,p=this.d,v=this.e,m=this.f;this.a=n*a+u*b+v*c,this.b=o*a+p*b+m*c,this.c=n*d+u*e+v*f,this.d=o*d+p*e+m*f,this.e=n*t+u*h+v*i,this.f=o*t+p*h+m*i,this.g+=n*s+u*r+v*l,this.h+=o*s+p*r+m*l}box(x=0,y=0,z=0,w=1,h=w,d=w){this.g+=x*this.a+y*this.c+z*this.e,this.h+=x*this.b+y*this.d+z*this.f,this.a*=w,this.b*=w,this.c*=h,this.d*=h,this.e*=d,this.f*=d}}class H{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l}translate(x=0,y=0,z=0){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y,this.g*=z,this.h*=z,this.i*=z}rotateXZ(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,g:u,h:h,i:i}=this;this.a=o*a-n*u,this.g=o*u+n*a,this.b=o*b-n*h,this.h=o*h+n*b,this.c=o*c-n*i,this.i=o*i+n*c}rotateXY(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=o*a-n*d,this.d=o*d+n*a,this.b=o*b-n*e,this.e=o*e+n*b,this.c=o*c-n*f,this.f=o*f+n*c}rotateZY(t){let n=r(t),o=s(t);const{d:d,e:e,f:f,g:u,h:h,i:i}=this;this.g=o*u-n*d,this.d=o*d+n*u,this.h=o*h-n*e,this.e=o*e+n*h,this.i=o*i-n*f,this.f=o*f+n*i}multiplyXZ(x=1,y=0){const{a:a,b:b,c:c,g:t,h:h,i:i}=this;this.a=x*a-y*t,this.g=x*t+y*a,this.b=x*b-y*h,this.h=x*h+y*b,this.c=x*c-y*i,this.i=x*i+y*c}multiplyXY(x=1,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=x*a-y*d,this.d=x*d+y*a,this.b=x*b-y*e,this.e=x*e+y*b,this.c=x*c-y*f,this.f=x*f+y*c}multiplyZY(x=1,y=0){const{d:d,e:e,f:f,g:t,h:h,i:i}=this;this.g=x*t-y*d,this.d=x*d+y*t,this.h=x*h-y*e,this.e=x*e+y*h,this.i=x*i-y*f,this.f=x*f+y*i}skewX(t=0,s=0){this.a+=s*this.d+t*this.g,this.b+=s*this.e+t*this.h,this.c+=s*this.f+t*this.i}skewY(t=0,s=0){this.d+=t*this.a+s*this.g,this.e+=t*this.b+s*this.h,this.f+=t*this.c+s*this.i}skewZ(t=0,s=0){this.g+=t*this.a+s*this.d,this.h+=t*this.b+s*this.e,this.i+=t*this.c+s*this.f}skew(t=0,s=0,r=0,n=0,o=0,u=0){const{a:a,b:b,c:c,d:d,e:e,f:f,g:p,h:h,i:i}=this;this.a=a+s*d+t*p,this.b=b+s*e+t*h,this.c=c+s*f+t*i,this.d=d+r*a+n*p,this.e=e+r*b+n*h,this.f=f+r*c+n*i,this.g=p+o*a+u*d,this.h=h+o*b+u*e,this.i=i+o*c+u*f}transform(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=this.a,o=this.b,u=this.c,p=this.d,v=this.e,m=this.f,g=this.g,A=this.h,R=this.i;this.a=n*a+p*b+g*c,this.b=o*a+v*b+A*c,this.c=u*a+m*b+R*c,this.d=n*d+p*e+g*f,this.e=o*d+v*e+A*f,this.f=u*d+m*e+R*f,this.g=n*t+p*h+g*i,this.h=o*t+v*h+A*i,this.i=u*t+m*h+R*i,this.j+=n*s+p*r+g*l,this.k+=o*s+v*r+A*l,this.l+=u*s+m*r+R*l}box(x=0,y=0,z=0,w=1,h=w,d=w){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h,this.g*=d,this.h*=d,this.i*=d}}const $G=ArrayBuffer.prototype.transfer?t=>{const s=i;return(i=s+t)>$i.length&&($i=new Float32Array($i.buffer.transfer(8*i)),$I=new Int32Array($i.buffer)),s}:t=>{const s=i;if((i=s+t)>$i.length){const t=$i;($i=new Float32Array(2*i)).set(t,0),$I=new Int32Array($i.buffer)}return s};class q extends Y{set shader($s){this.N="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,Q==this&&(Q=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||lt,Q==this&&(Q=null)}constructor(t,s=290787599,r=lt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.M=s,this.S=r,this.N=n}sub(){return new q(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f)}sub3d(){return new J(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,0,0,this.e,this.f)}sub3dProj(t=0,s=1){return new K(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,0,this.c,this.d,0,this.e*s,this.f*s,s,this.e*t,this.f*t,t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.M=290787599,this.N=$.Shader.DEFAULT,this.S=lt}pixelRatio(){return sqrt(abs(this.a*this.d-this.b*this.c)*this.t.w*this.t.h)}to(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y+this.e,y:this.b*x+this.d*y+this.f}}from(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:((x-=this.e)*d-(y-=this.f)*c)*t,y:(y*a-x*b)*t}}draw(...t){const i=this.N(6,t);$i[i]=this.e,$i[i+1]=this.a,$i[i+2]=this.c,$i[i+3]=this.f,$i[i+4]=this.b,$i[i+5]=this.d}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.N(6,t);$i[i]=this.e+x*this.a+y*this.c,$i[i+1]=this.a*w,$i[i+2]=this.c*h,$i[i+3]=this.f+x*this.b+y*this.d,$i[i+4]=this.b*w,$i[i+5]=this.d*h}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.N(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*e+n*f+u,$i[i+1]=s*a+n*b,$i[i+2]=s*c+n*d,$i[i+3]=r*e+o*f+p,$i[i+4]=r*a+o*b,$i[i+5]=r*c+o*d}drawv(t){const i=this.N(6,t);$i[i]=this.e,$i[i+1]=this.a,$i[i+2]=this.c,$i[i+3]=this.f,$i[i+4]=this.b,$i[i+5]=this.d}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.N(6,t);$i[i]=this.e+x*this.a+y*this.c,$i[i+1]=this.a*w,$i[i+2]=this.c*h,$i[i+3]=this.f+x*this.b+y*this.d,$i[i+4]=this.b*w,$i[i+5]=this.d*h}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.N(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*e+n*f+u,$i[i+1]=s*a+n*b,$i[i+2]=s*c+n*d,$i[i+3]=r*e+o*f+p,$i[i+4]=r*a+o*b,$i[i+5]=r*c+o*d}}class W extends k{set shader($s){this.N="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,Q==this&&(Q=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||lt,Q==this&&(Q=null)}constructor(t,s=290787599,r=lt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=0){super(a,b,c,d,e,f,o,h,i),this.t=t,this.M=s,this.S=r,this.N=n}sub(){return new W(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}sub3d(){return new K(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}sub3dProj(t=0,s=1){return new K(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,this.g*s,this.h*s,this.i*s,this.g*t,this.h*t,this.i*t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.M=290787599,this.N=$.Shader.DEFAULT,this.S=lt}pixelRatio(){const{i:i}=this,t=(this.a*i-this.g*this.c)*(this.e*i-this.h*this.f)-(this.d*i-this.g*this.f)*(this.b*i-this.h*this.c);return sqrt(abs(t)*this.t.w*this.t.h)/(i*i)}to(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);let t=this.c*x+this.f*y+this.i;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g)*t,y:(this.b*x+this.e*y+this.h)*t})}from(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);let u=(n*x+(c*d-a*f)*y+(a*e-b*d))*o;return u<=0?{x:NaN,y:NaN}:(u=1/u,{x:(s*x+(f*t-d*i)*y+(d*h-e*t))*o*u,y:(r*x+(a*i-c*t)*y+(b*t-a*h))*o*u})}draw(...t){const i=this.N(9,t);$i[i]=this.g,$i[i+1]=this.a,$i[i+2]=this.d,$i[i+3]=this.h,$i[i+4]=this.b,$i[i+5]=this.e,$i[i+6]=this.i,$i[i+7]=this.c,$i[i+8]=this.f}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.N(9,t);$i[i]=this.g+x*this.a+y*this.d,$i[i+1]=this.a*w,$i[i+2]=this.d*h,$i[i+3]=this.h+x*this.b+y*this.e,$i[i+4]=this.b*w,$i[i+5]=this.e*h,$i[i+6]=this.i+x*this.c+y*this.f,$i[i+7]=this.c*w,$i[i+8]=this.f*h}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.N(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,v=this.g,m=this.h,g=this.i;$i[i]=s*e+o*f+v,$i[i+1]=s*a+o*b,$i[i+2]=s*c+o*d,$i[i+3]=r*e+u*f+m,$i[i+4]=r*a+u*b,$i[i+5]=r*c+u*d,$i[i+6]=n*e+p*f+g,$i[i+7]=n*a+p*b,$i[i+8]=n*c+p*d}drawv(t){const i=this.N(9,t);$i[i]=this.g,$i[i+1]=this.a,$i[i+2]=this.d,$i[i+3]=this.h,$i[i+4]=this.b,$i[i+5]=this.e,$i[i+6]=this.i,$i[i+7]=this.c,$i[i+8]=this.f}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.N(9,t);$i[i]=this.g+x*this.a+y*this.d,$i[i+1]=this.a*w,$i[i+2]=this.d*h,$i[i+3]=this.h+x*this.b+y*this.e,$i[i+4]=this.b*w,$i[i+5]=this.e*h,$i[i+6]=this.i+x*this.c+y*this.f,$i[i+7]=this.c*w,$i[i+8]=this.f*h}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.N(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,v=this.g,m=this.h,g=this.i;$i[i]=s*e+o*f+v,$i[i+1]=s*a+o*b,$i[i+2]=s*c+o*d,$i[i+3]=r*e+u*f+m,$i[i+4]=r*a+u*b,$i[i+5]=r*c+u*d,$i[i+6]=n*e+p*f+g,$i[i+7]=n*a+p*b,$i[i+8]=n*c+p*d}}class J extends Z{set shader($s){this.N="function"==typeof $s&&!0===$s.three?$s:$.Shader.COLOR_3D_XZ,Q==this&&(Q=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||ct,Q==this&&(Q=null)}constructor(t,s=290787599,r=ct,n=$.Shader.COLOR_3D_XZ,a=1,b=0,c=0,d=1,e=0,f=0,o=0,h=0){super(a,b,c,d,e,f,o,h),this.t=t,this.M=s,this.S=r,this.N=n}sub(){return new J(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}subProj(t=0,s=1){return new K(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,0,this.c,this.d,0,this.g*s+this.e,this.h*s+this.f,s,this.g*t,this.h*t,t)}sub2dXY(){return new q(this.t,this.M,lt,$.Shader.DEFAULT,this.a,this.b,this.c,this.d,this.g,this.h)}sub2dZY(){return new q(this.t,this.M,lt,$.Shader.DEFAULT,this.e,this.f,this.c,this.d,this.g,this.h)}sub2dXZ(){return new q(this.t,this.M,lt,$.Shader.DEFAULT,this.a,this.b,this.e,this.f,this.g,this.h)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.M=290787599,this.N=$.Shader.COLOR_3D_XZ,this.S=ct}to(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z+this.j)*t,y:(this.b*x+this.e*y+this.h*z+this.k)*t})}from(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;x-=this.j,y-=this.k;const z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}origin(){return{x:NaN,y:NaN,z:NaN}}draw(...t){const s=this.N(8,t);$i[s]=this.g,$i[s+1]=this.a,$i[s+2]=this.c,$i[s+3]=this.e,$i[s+4]=this.h,$i[s+5]=this.b,$i[s+6]=this.d,$i[s+7]=this.f}drawCube(x=0,y=0,z=0,t=1,s=1,r=1,...n){const o=this.N(8,n),{a:a,b:b,c:c,d:d,e:e,f:f}=this;$i[o]=this.g+x*a+y*c+z*e,$i[o+1]=a*t,$i[o+2]=c*s,$i[o+3]=e*r,$i[o+4]=this.h+x*b+y*d+z*f,$i[o+5]=b*t,$i[o+6]=d*s,$i[o+7]=f*r}drawMat(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,...n){const o=this.N(8,n),u=this.a,p=this.b,v=this.c,m=this.d,g=this.e,A=this.f;$i[o]=this.g+u*s+v*r+g*l,$i[o+1]=u*a+v*b+g*c,$i[o+2]=u*d+v*e+g*f,$i[o+3]=u*t+v*h+g*i,$i[o+4]=this.h+p*s+m*r+A*l,$i[o+5]=p*a+m*b+A*c,$i[o+6]=p*d+m*e+A*f,$i[o+7]=p*t+m*h+A*i}drawv(t){const s=this.N(8,t);$i[s]=this.g,$i[s+1]=this.a,$i[s+2]=this.c,$i[s+3]=this.e,$i[s+4]=this.h,$i[s+5]=this.b,$i[s+6]=this.d,$i[s+7]=this.f}drawCubev(x=0,y=0,z=0,t=1,s=1,r=1,n){const o=this.N(8,n),{a:a,b:b,c:c,d:d,e:e,f:f}=this;$i[o]=this.g+x*a+y*c+z*e,$i[o+1]=a*t,$i[o+2]=c*s,$i[o+3]=e*r,$i[o+4]=this.h+x*b+y*d+z*f,$i[o+5]=b*t,$i[o+6]=d*s,$i[o+7]=f*r}drawMatv(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,n){const o=this.N(8,n),u=this.a,p=this.b,v=this.c,m=this.d,g=this.e,A=this.f;$i[o]=this.g+u*s+v*r+g*l,$i[o+1]=u*a+v*b+g*c,$i[o+2]=u*d+v*e+g*f,$i[o+3]=u*t+v*h+g*i,$i[o+4]=this.h+p*s+m*r+A*l,$i[o+5]=p*a+m*b+A*c,$i[o+6]=p*d+m*e+A*f,$i[o+7]=p*t+m*h+A*i}}class K extends H{set shader($s){this.N="function"==typeof $s&&!0===$s.three?$s:$.Shader.COLOR_3D_XZ,Q==this&&(Q=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||ct,Q==this&&(Q=null)}constructor(t,s=290787599,r=ct,n=$.Shader.COLOR_3D_XZ,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.M=s,this.S=r,this.N=n}sub(){return new K(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}subProj(t=0,s=1){return new K(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,this.j*s+this.g,this.k*s+this.h,this.l*s+this.i,this.j*t,this.k*t,this.l*t)}sub2dXY(){return new W(this.t,this.M,lt,$.Shader.DEFAULT,this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dZY(){return new W(this.t,this.M,lt,$.Shader.DEFAULT,this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(){return new W(this.t,this.M,lt,$.Shader.DEFAULT,this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.j=t.j,this.k=t.k,this.l=t.l,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l,this.M=290787599,this.N=$.Shader.COLOR_3D_XZ,this.S=ct}to(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z+this.j)*t,y:(this.b*x+this.e*y+this.h*z+this.k)*t})}from(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;x-=this.j,y-=this.k;const z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}origin(){const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=this,n=e*i-f*h,o=c*h-b*i,u=b*f-c*e,p=-1/(a*n+d*o+t*u);return{x:(n*s+(t*f-i*d)*r+(d*h-e*t)*l)*p,y:(o*s+(a*i-c*t)*r+(t*b-h*a)*l)*p,z:(u*s+(d*c-f*a)*r+(a*e-b*d)*l)*p}}ray(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=this,n=e*i-f*h,o=c*h-b*i,u=b*f-c*e,p=1/(a*n+d*o+t*u),v=t*f-i*d,m=d*h-e*t,g=-(n*s+v*r+m*l)*p,A=-(o*s+(a*i-c*t)*r+(t*b-h*a)*l)*p,R=-(u*s+(d*c-f*a)*r+(a*e-b*d)*l)*p,z=1-this.l,G=(n*x+v*y+m*z)*p,E=(n*x+v*y+m*z)*p,T=(n*x+v*y+m*z)*p,L=1/sqrt(G*G+E*E+T*T);return{origin:{x:g,y:A,z:R},direction:{x:G*L,y:E*L,z:T*L}}}draw(...t){const s=this.N(12,t);$i[s]=this.j,$i[s+1]=this.a,$i[s+2]=this.d,$i[s+3]=this.g,$i[s+4]=this.k,$i[s+5]=this.b,$i[s+6]=this.e,$i[s+7]=this.h,$i[s+8]=this.l,$i[s+9]=this.c,$i[s+10]=this.f,$i[s+11]=this.i}drawCube(x=0,y=0,z=0,t=1,s=1,r=1,...n){const o=this.N(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=this.j+x*a+y*d+z*u,$i[o+1]=a*t,$i[o+2]=d*s,$i[o+3]=u*r,$i[o+4]=this.k+x*b+y*e+z*h,$i[o+5]=b*t,$i[o+6]=e*s,$i[o+7]=h*r,$i[o+8]=this.l+x*c+y*f+z*i,$i[o+9]=c*t,$i[o+10]=f*s,$i[o+11]=i*r}drawMat(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,...n){const o=this.N(12,n),u=this.a,p=this.b,v=this.c,m=this.d,g=this.e,A=this.f,R=this.g,G=this.h,E=this.i;$i[o]=this.j+u*s+m*r+R*l,$i[o+1]=u*a+m*b+R*c,$i[o+2]=u*d+m*e+R*f,$i[o+3]=u*t+m*h+R*i,$i[o+4]=this.k+p*s+g*r+G*l,$i[o+5]=p*a+g*b+G*c,$i[o+6]=p*d+g*e+G*f,$i[o+7]=p*t+g*h+G*i,$i[o+8]=this.l+v*s+A*r+E*l,$i[o+9]=v*a+A*b+E*c,$i[o+10]=v*d+A*e+E*f,$i[o+11]=v*t+A*h+E*i}drawv(t){const s=this.N(12,t);$i[s]=this.j,$i[s+1]=this.a,$i[s+2]=this.d,$i[s+3]=this.g,$i[s+4]=this.k,$i[s+5]=this.b,$i[s+6]=this.e,$i[s+7]=this.h,$i[s+8]=this.l,$i[s+9]=this.c,$i[s+10]=this.f,$i[s+11]=this.i}drawCubev(x=0,y=0,z=0,t=1,s=1,r=1,n){const o=this.N(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=this.j+x*a+y*d+z*u,$i[o+1]=a*t,$i[o+2]=d*s,$i[o+3]=u*r,$i[o+4]=this.k+x*b+y*e+z*h,$i[o+5]=b*t,$i[o+6]=e*s,$i[o+7]=h*r,$i[o+8]=this.l+x*c+y*f+z*i,$i[o+9]=c*t,$i[o+10]=f*s,$i[o+11]=i*r}drawMatv(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,n){const o=this.N(12,n),u=this.a,p=this.b,v=this.c,m=this.d,g=this.e,A=this.f,R=this.g,G=this.h,E=this.i;$i[o]=this.j+u*s+m*r+R*l,$i[o+1]=u*a+m*b+R*c,$i[o+2]=u*d+m*e+R*f,$i[o+3]=u*t+m*h+R*i,$i[o+4]=this.k+p*s+g*r+G*l,$i[o+5]=p*a+g*b+G*c,$i[o+6]=p*d+g*e+G*f,$i[o+7]=p*t+g*h+G*i,$i[o+8]=this.l+v*s+A*r+E*l,$i[o+9]=v*a+A*b+E*c,$i[o+10]=v*d+A*e+E*f,$i[o+11]=v*t+A*h+E*i}}const x=Object.getOwnPropertyDescriptors({get width(){return this.t.w},get height(){return this.t.h},get identity(){return this.t},set mask(t){this.M=-256&this.M|255&t,Q==this&&(Q=null)},get mask(){return 255&this.M},set blend(b){this.M=255&this.M|(b||1135889)<<8,Q==this&&(Q=null)},get blend(){return this.M>>8},V(){if(Q==this)return!1;const{t:t,M:s}=this,r=t.p;let d=T^s;if(curt!=t&&(i&&draw(),curt&&curt.p==t.p||(d|=240),N!=t._&&_.bindFramebuffer(36009,N=t._),_.viewport(0,0,t.w,t.h),curt=t),d){if(i&&draw(),15&d&&_.colorMask(1&s,2&s,4&s,8&s),240&d)if(240&s){240&T||_.enable(2960),_.stencilMask(1<<r),_.stencilFunc(32&s?16&s?512:517:16&s?514:519,255,1<<r);const t=128&s?64&s?5386:7681:64&s?0:7680;_.stencilOp(t,t,t)}else 240&T&&_.disable(2960);1996488704&d&&_.blendEquationSeparate(32773+(s>>24&7),32773+(s>>28&7)),16776960&d&&_.blendFuncSeparate((s>>8&15)+766*!!(3584&s),(s>>16&15)+766*!!(917504&s),(s>>12&15)+766*!!(57344&s),(s>>20&15)+766*!!(14680064&s)),-2147483648&d&&(-2147483648&s?_.enable(32926):_.disable(32926)),T=s}return Q=this,!0},setTarget(t=0,s=null,l=0,r=0){const{t:n}=this;if(n._){if(i&&draw(),Q==this&&(Q=null),N!=n._&&(_.bindFramebuffer(36009,N=n._),curt=Q=null),!s){if(!n.u)return;return _.framebufferRenderbuffer(36009,36064+t,36161,null),void((n.u&=~(1<<t))||(n.w=n.h=0,_.framebufferRenderbuffer(36009,36128,36161,null)))}if((n.u&=~(1<<t))||(n.w=n.h=0),n.w){if(n.w!=s.width||n.h!=s.height)return}else n.w=s.width,n.h=s.height,n.T&&(_.bindRenderbuffer(36161,n.T),_.renderbufferStorage(36161,36168,n.w,n.h),_.framebufferRenderbuffer(36009,36128,36161,n.T));n.u|=1<<t,s.msaa?_.framebufferRenderbuffer(36009,36064+t,36161,s.$):_.framebufferTextureLayer(36009,36064+t,s.t.$,l,r)}},clearTargets(){const{t:s}=this;if(!s._)return;i&&draw(),Q==this&&(Q=null);let r=s.u;if(s.u=s.w=s.h=0,s.T&&(_.framebufferRenderbuffer(36009,36128,36161,null),_.deleteRenderbuffer(s.T),s.T=_.createRenderbuffer()),r)for(N!=s._&&(_.bindFramebuffer(36009,N=s._),curt=Q=null);r;){const s=31-t(r);r&=~(1<<s),_.framebufferRenderbuffer(36009,36064+s,36161,null)}},get hasStencil(){return this.t._?!!this.t.T:!!(1&m)},set hasStencil(t){let{t:s}=this,b=s.T;s._&&!t!=!b&&(i&&draw(),Q==this&&(Q=null),s.T=b=b?(_.deleteRenderbuffer(b),null):_.createRenderbuffer(),s.w&&(N!=s._&&(_.bindFramebuffer(36009,N=s._),curt=Q=null),b?(_.bindRenderbuffer(36161,b),_.renderbufferStorage(36161,36168,s.w,s.h),_.framebufferRenderbuffer(36009,36128,36161,b)):_.framebufferRenderbuffer(36009,36128,36161,null)))},clear(t=0,s=t,b=t,a=s){"object"==typeof t&&(a=t.w??0,b=t.z??0,s=t.y,t=t.x),i&&draw(),this.V()&&(Q=null),_.clearColor(t,s,b,a);const r=this.t.p=this.t.p+1&7;_.clear(r?16384:(_.stencilMask(255),17408)),ft++,_.disable(2960),T&=-241},clearStencil(){i&&draw(),this.V()&&(Q=null);(this.t.p=this.t.p+1&7)||(_.stencilMask(255),_.clear(1024)),_.disable(2960),T&=-241},projection:!1});Object.defineProperties(q.prototype,x),Object.defineProperties(K.prototype,x),Object.defineProperties(W.prototype,x),K.prototype.projection=W.prototype.projection=!0,Object.defineProperties(J.prototype,x),Object.assign($.Blend=(t=17,s=17,r=0,n=!1)=>t|r<<8|s<<16|n<<23,{REPLACE:1114129,DEFAULT:1135889,ADD:1118465,MULTIPLY:1122816,MULTIPLY_MIX:1136008,SUBTRACT:5574913,REVERSE_SUBTRACT:7737601,MIN:2232593,MAX:3346705,BEHIND:1118583,INVERT:1127321});let Q=null;function draw(b=$x){if(_.bufferData(34962,$I.subarray(0,i),35040),_t+=i,i/=$u,ft++,$t+=i,O?_.drawElementsInstanced(7&S,I,O,F,i):_.drawArraysInstanced(7&S,F,I,i),i=0,$X=b,mt.length){bt??=mt[0];for(const f of mt)f.sync=_.fenceSync(37143,0),vt=vt?vt.next=f:f;mt.length=0}}const tt=(f,t,e)=>{let s="switch(u){";for(;t<e;)s+=`case ${t}:${f(t++)}`;return s+"}"},st=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"],it=_.getParameter(34921);function $H(t,s,r,c){$s=t,L=s,B=r,$u=c}function $l(t){_.bindVertexArray($v=t)}const $C=new Float32Array(4),$c=new Int32Array($C.buffer),ht=(t,s,$D=[])=>{s="number"==typeof s?[s]:s||[];let r=0;const n=[],o=[],u=[],p=[],v=[""];let m=2+t,g=0,A=2+t,R=2+t;for(const t of s){if((15&t)>=12)throw"Vertex parameter cannot be a texture";const s=1+(3&t),G=st[3&t|(t>>4&15)<<2],E=t>15;$D[r]??=1==s?0:2==s?C:3==s?M:D,p.push(`${r}:a${r}=$D[${r}]`);const T=(63&t)>13?"$I[i+":"$i[i+";if(1==s)v.push(T+R+"]=a"+r);else for(let t=0;t<s;t++)fnBody.push(T+(R+t)+"]=a"+r+"."+"xyzw"[t]);const L=""+(m>>2),B=3&m,N=3&(m+=s)||4;let S=E?g:A;const F=3&S,I=3&(S+=s)||4;E?g=S:A=S;let O="";if(N<=(B||4)){const t=(m>>2)-(s==4+B);o.push(`layout(location=${it-1-t})in uvec4 o${t};`)}O=N<=B?`uvec${s}(o${L}.${"xyzw".slice(B,4)},o${m>>2}.${"xyzw".slice(0,N)})`:4==N&&0==B?"v"+L:`o${L}.`+"xyzw".slice(B,N),E||(O=`uintBitsToFloat(${O})`);const P=`GL_${E?"V":"v"}${L}.`;if(I<=(F||4)&&o.push(`${E?"flat out u":"out "}vec4 ${(E?"GL_V":"GL_v")+((S>>2)-!(s==4+F))};`),I<=F){const o=(E?"GL_V":"GL_v")+(S>>2),p=`${E?"u":""}vec${s}(${P+"xyzw".slice(F)},${P+"xyzw".slice(0,I)})`;n.push(`${E?"flat in u":"in "}vec4 ${o};\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${p})`:p}\n`),u.push(`${G} t${r}=${O};${P+"xyzw".slice(F,I)}=t${r}.${"xyzw".slice(0,4-F)};${o}.${"xyzw".slice(0,I)}=t${r}.${"xyzw".slice(4-F,s)};`)}else{const s=P+"xyzw".slice(F,I);n.push(`\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${s})`:s}\n`),u.push(`${P+"xyzw".slice(F,I)}=${O};`)}R+=s,r++}v[0]=`let{i,$i,$I}=this;if((this.i=i+${R})>$i.length){${ArrayBuffer.prototype.transfer?`$i=this.$i=new Float32Array($i.buffer.transfer(i+${R}<<3))`:`const oa=$i;$i=this.$i=new Float32Array(i+${R}<<1);$i.set(oa,0)`};$I=this.$I=new Int32Array($i.buffer)}`,v.push("return i"),g&&(o.push("flat out uvec4 GL_V0;"),n.push("flat in uvec4 GL_V0;"));const G=eval(`(function({${p}}){${v.join(";")}})`);return{three:t,S:G,F:R,fsh:n.join(""),vsh:o.join(""),vshb:u.join("")}};class et extends Y{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.I=s,this.O=r,this.P=n}sub(t=this.t.U,s=0,r=this.P){return new et(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f)}sub3d(t=this.t.U,s=0,r=this.P){return new nt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,0,0,this.e,this.f)}addPoint(x,y,...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.U++}add(...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.U++}addPointv(x,y,t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.U++}addv(t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.U++}}class rt extends k{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1){super(a,b,c,d,e,f,o,h,i),this.t=t,this.I=s,this.O=r,this.P=n}sub(t=this.t.U,s=0,r=this.P){return new rt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}sub3d(t=this.t.U,s=0,r=this.P){return new ot(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}addPoint(x,y,...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+this.g,$i[i+1]=x*this.b+y*this.e+this.h,$i[i+2]=x*this.c+y*this.f+this.i,s.U++}add(...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,$i[i+2]=this.i,s.U++}addPointv(x,y,t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+this.g,$i[i+1]=x*this.b+y*this.e+this.h,$i[i+2]=x*this.c+y*this.f+this.i,s.U++}addv(t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,$i[i+2]=this.i,s.U++}}class nt extends Z{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=1,e=0,f=0,o=0,h=0){super(a,b,c,d,e,f,o,h),this.t=t,this.I=s,this.O=r,this.P=n}sub(t=this.t.U,s=0,r=this.P){return new nt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}sub2dXY(t=this.t.U,s=0,r=this.P){return new et(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.g,this.h)}sub2dXZ(t=this.t.U,s=0,r=this.P){return new et(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.e,this.f,this.g,this.h)}sub2dZY(t=this.t.U,s=0,r=this.P){return new et(this.t,t>>>0,s>>>0,63&r,this.e,this.f,this.c,this.d,this.g,this.h)}addPoint(x,y,z,...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+z*this.e+this.g,$i[i+1]=x*this.b+y*this.d+z*this.f+this.h,s.U++}add(...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,s.U++}addPointv(x,y,z,t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+z*this.e+this.g,$i[i+1]=x*this.b+y*this.d+z*this.f+this.h,s.U++}addv(t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,s.U++}}class ot extends H{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.I=s,this.O=r,this.P=n}sub(t=this.t.U,s=0,r=this.P){return new ot(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}sub2dXY(t=this.t.U,s=0,r=this.P){return new rt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(t=this.t.U,s=0,r=this.P){return new rt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}sub2dZY(t=this.t.U,s=0,r=this.P){return new rt(this.t,t>>>0,s>>>0,63&r,this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}addPoint(x,y,z,...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.U++}add(...t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.U++}addPointv(x,y,z,t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.U++}addv(t){const{t:s}=this,i=s.S(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.U++}}function $a(t){_.bindBuffer(34962,t.b);const s=it-(t.F+3>>2);for(let i=it-1,r=0;i>=s;i--,r+=16)_.enableVertexAttribArray(i),_.vertexAttribIPointer(i,i==s?3&t.F:4,5125,t.F<<2,r);_.enableVertexAttribArray(0),_.enableVertexAttribArray(1),_.vertexAttribDivisor(0,1),_.vertexAttribDivisor(1,1),_.vertexAttribDivisor(2,1),_.bindBuffer(34962,$M)}_.vertexAttrib4f(2,1,0,0,0);const y=Object.getOwnPropertyDescriptors({get size(){return this.t.U},get uploadCount(){return this.t.C},S(){const{t:t}=this;i&&draw(),$p=this;const s=S>>4,r=(S=this.P)>>4;s!=r&&(r?(s||_.enable(2884),_.frontFace(2304+(r>>1))):_.disable(2884)),F=this.I,I=this.O,O=t.M},get end(){return this.I+this.O},set end(a){(a>>>=0)>=this.I?this.O=a-this.I:(this.O=this.I-a,this.I=a),$p==this&&this.S()},get start(){return this.I},set start(a){this.I=a>>>0,$p==this&&(i&&draw(),F=this.I)},get length(){return this.O},set length(a){this.O=a>>>0,$p==this&&(i&&draw(),I=this.O)},get type(){return this.P},set type(a){this.P=63&a,$p==this&&this.S()},get identity(){return this.t},upload(t=null){const{t:s}=this;if($p&&s==$p.t&&i&&draw(),t){let r=0;if(Array.isArray(t)){let s=0;for(const r of t)r>s&&(s=r);const $M=s>254?s>65534?new Uint32Array(t.length):new Uint16Array(t.length):new Uint8Array(t.length);$M.set(t,0),t=$M}r=5121+(262656>>(t.BYTES_PER_ELEMENT<<2)&15),s.M=r,_.bindVertexArray(s.v),_.bindBuffer(34963,s.E??=_.createBuffer()),_.bufferData(34963,t,35044),s.v?s.Ls||(s.Ls=1,$a(s)):_.bindBuffer(34963,null),_.bindVertexArray($v)}else s.v&&(_.bindVertexArray(s.v),s.Ls||(s.Ls=1,$a(s)),s.E&&_.bindBuffer(34963,null),_.bindVertexArray($v)),s.M=0,s.E&&(s.E.delete(),s.E=null);$p&&$p.t==s&&(O=s.M),_.bindBuffer(34962,s.b),_.bufferData(34962,s.$I.subarray(0,s.i),35044),_.bindBuffer(34962,$M),s.$i=at,s.$I=ut,s.i=0,s.C=this.O=t?t.length:s.U,s.U=0,$p&&s==$p.t&&this.S()}}),at=new Float32Array,ut=new Int32Array(at.buffer);Object.defineProperties(et.prototype,y),Object.defineProperties(rt.prototype,y),Object.defineProperties(nt.prototype,y),Object.defineProperties(ot.prototype,y),$.Geometry2D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{S:r,F:n,three:o}=t??$.Geometry2D.DEFAULT_VERTEX;if(o)return null;const $i=new Float32Array(16);return new et({$i:$i,$I:new Int32Array($i.buffer),i:0,b:_.createBuffer(),S:r,F:n,U:0,C:0,v:null,E:null,M:0},0,0,s)},$.Geometry3D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{S:r,F:n,three:o}=t??$.Geometry3D.DEFAULT_VERTEX;if(!o)return null;const $i=new Float32Array(16);return new ot({$i:$i,$I:new Int32Array($i.buffer),i:0,b:_.createBuffer(),S:r,F:n,U:0,C:0,v:_.createVertexArray(),L:null,Ls:0,E:null,M:0},0,0,s)},$.Geometry2D.Vertex=ht.bind(null,!1),$.Geometry3D.Vertex=ht.bind(null,!0);const lt=$.Geometry2D.SQUARE=$.Geometry2D($.Geometry2D.DEFAULT_VERTEX=ht(!1,[]),5),ct=$.Geometry3D.CUBE=$.Geometry3D($.Geometry3D.DEFAULT_VERTEX=ht(!0,[]),21);for(let i=0;i<4;i++)lt.addPoint(1&i,i>>1&1),ct.addPoint(0,1&i,i>>1&1),ct.addPoint(1,1&i,i>>1&1);lt.upload(),ct.upload(new Uint8Array([4,6,0,2,3,6,7,4,5,0,1,3,5,7])),$.Geometry3D.INSIDE_CUBE=ct.sub(0,14,37),$.Geometry3D.XZ_FACE=ct.sub(7,4,21),$.Shader=(t,{params:s,defaults:$D,uniforms:r,uniformDefaults:$U,outputs:p=4,vertex:v=$.Geometry2D.DEFAULT_VERTEX,intFrac:m=.5}={})=>{if(s="number"==typeof s?[s]:s||[],r="number"==typeof r?[r]:r||[],$D=void 0!==$D?Array.isArray($D)?[...$D]:[$D]:[],$U=void 0!==$U?Array.isArray($U)?[...$U]:[$U]:[],p="number"==typeof p?[p]:p||[],p.length>Drawable.MAX_TARGETS)throw`Too many shader outputs (Drawable.MAX_TARGETS == ${Drawable.MAX_TARGETS})`;const g=3+v.three,A=[],R=[""],G=[`#version 300 es\nprecision highp float;precision highp int;layout(location=0)in mat3x${g} m;layout(location=${it-1})in uvec4 o0;out vec4 GL_v0;`],E=[`void main(){gl_PointSize=1.;gl_Position.z=0.;gl_Position.xyw=vec${g}(1.,GL_v0.xy${v.three?"z":""}=uintBitsToFloat(o0.xy${v.three?"z":""}))*m;gl_Position.xy=gl_Position.xy*2.-gl_Position.w;`],T=[`#version 300 es\nprecision highp float;precision highp int;in vec4 GL_v0;\n#define color color0\n#define pos GL_v0.xy${g>3?"z":""}\n`+p.map((t,i)=>`layout(location=${i})out ${t?16==t||32==t?"u":"lowp ":""}vec4 color${i};`).join(";"),""];let L=0,B=0,N=0,S=0;const F=[],I=(t=0)=>{const s=""+(S>>2),r=3&S,n=3&(S+=t)||4;if(n<=(r||4)){const s=(S>>2)-(t==4+r),n=""+s;G.push(`layout(location=${s+3})in uvec4 a${n};flat out uvec4 GL_a${n};`),T.push(`flat in uvec4 GL_a${n};`),E.push(`GL_a${n}=a${n};`)}if(n<=r){let o=`uvec${t}(GL_a${s}.`;for(let i=r;i<4;i++)o+="xyzw"[i];o+=`,GL_a${S>>2}.`;for(let i=0;i<n;i++)o+="xyzw"[i];return o+")"}if(4==n&&0==r)return"GL_a"+s;let o=`GL_a${s}.`;for(let i=r;i<n;i++)o+="xyzw"[i];return o};let O=0;for(const t of s){let s=1+(3&t);(15&t)>=12&&(L|=1<<s-1,(15&t)>13?N++:B++),$D[O]??=1==s?0:2==s?C:3==s?M:t>=28&&t<32?null:D,A.push(`${O}:a${O}=$D[${O}]`);const r=t>13?"$I[j+":"$i[j+",n=S;if(t>=12&&t<16){F.push(`let t${O}=-1;if(a${O}.t){if((t${O}=$m.auto(a${O}.t,${-(8==t)}))==-1){i&&draw(b^$X);t${O}=$m.auto(a${O}.t,${-(8==t)})}t${O}|=a${O}.l<<8}`);const o=I(1),u=I(2),p=I(2);T.push(`${4==t?"lowp ":8==t?"u":"highp "}vec4 param${O}(vec2 uv){int v=int(${o});if(v<0)return vec4(uintBitsToFloat(${u}),uintBitsToFloat(${p}));return ${4==t?"g":8==t?"uG":"fG"}etColor(v&255,vec3(uv*uintBitsToFloat(${p})+uintBitsToFloat(${u}),v>>8));}`),R.push(`$I[j+${n}]=t${O};if(t${O}>=0)$i[j+${n+1}]=a${O}.x,$i[j+${n+2}]=a${O}.y,$i[j+${n+3}]=a${O}.w,$i[j+${n+4}]=a${O}.h;else ${r}${n+1}]=a${O}.x,${r}${n+2}]=a${O}.y,${r}${n+3}]=a${O}.z,${r}${n+4}]=a${O}.w`),s=5}else{t>=28&&t<32&&(F.push(`let q${O}=$m.auto(a${O}.t,${-(t>29)});if(q${O}<0)i&&draw(b^$X),q${O}=$m.auto(a${O}.t,${-(t>29)})`),s=1);const o=I(s);if(T.push(`\n#define param${O} ${t<16?"uintBitsToFloat":t<32?st[3&t|4]:""}(${o})\n`),1==s)R.push(r+n+"]=a"+O);else for(let t=0;t<s;t++)R.push(r+(n+t)+"]=a"+O+"."+"xyzw"[t])}O++}T.push(v.fsh),G.push(v.vsh),E.push(v.vshb),O=0;const P=[],U=[""],X=[],V=[],Y=[];for(const t of r){const s=1+(3&t);if((15&t)>=12&&(L|=1<<s-1,(15&t)>13?N++:B++,n="int"),$U[O]??=1==s?0:2==s?C:3==s?M:t>=28&&t<32?null:D,P.push(`a${O}=$U[${O}]`),t>=28&&t<32)X.push(`_.uniform1i($L[${V.length}],s${Y.length}?$m.auto(s${Y.length},${-(t>29)}):-1)`),V.push("uni"+O),T.push(`uniform int uni${O};`),U.push(`s${Y.length}=a${O}.t`),Y.push(`,s${Y.length}=null`);else if(t>=12&&t<16){const s="GL_u"+O,r="GL_U"+O;X.push(`_.uniform1i($L[${V.length}],(s${Y.length}?$m.auto(s${Y.length},${-(t>13)}):-1)|s${Y.length+1})`),T.push(t>13?`uniform int ${s};uniform uvec4 ${r}; ${14==t?"i":"u"}vec4 uni${O}(vec2 uv){if(${s}<0)return ${14==t?`ivec4(${r})`:r};return ${14==t?"i":"u"}GetColor(${s}&255,vec3(uv*uintBitsToFloat(${r}.zw)+uintBitsToFloat(${r}.xy),${s}>>8));}`:`uniform int ${s};uniform vec4 ${r}; ${12==t?"lowp ":""}vec4 uni${O}(vec2 uv){if(${s}<0)return ${r};return fGetColor(${s}&255,vec3(uv*${r}.zw+${r}.xy,${s}>>8));}`),U.push(`if(s${Y.length}=a${O}.t){s${Y.length+1}=a${O}.l<<8;${t>13?`$C[0]=a${O}.x,$C[1]=a${O}.y,$C[2]=a${O}.w,$C[3]=a${O}.h;_.uniform4ui`:"_.uniform4f"}($L[${V.length-1}],${t>13?"$c[0],$c[1],$c[2],$c[3]":`a${O}.x,a${O}.y,a${O}.w,a${O}.h`})}else _.uniform4${t>13?"ui":"f"}($L[${V.length-1}],a${O}.x,a${O}.y,a${O}.z,a${O}.w)`),V.push(s,r),Y.push(`,s${Y.length}=null,s${Y.length+1}=0`)}else{T.push(`uniform ${st[3&t|t>>4<<2]} uni${O};`);let r=`_.uniform${s+(t<16?"f":t<32?"i":"ui")}($L[${V.length}]`;if(V.push("uni"+O),1==s)r+=",a"+O;else for(let t=0;t<s;t++)r+=",a"+O+"."+"xyzw"[t];U.push(r+")")}O++}if(12+(S+3&-4)+(v.F+3&-4)>it<<2)throw"Too many shader parameters";if(B+N>16)throw"Shaders cannot use more than 16 textures/colors";Object.freeze($D),Object.freeze($U);const k=it-(v.F+3>>2);B=B?N?B+u(m*(j-B-N)):j:0,N=N&&j-B;let Z=null,H="";15&L&&(H+=`uniform ${2&L?"highp":"lowp"} sampler2DArray GL_f[${B}];ivec3 getSize(int u,int l){${tt(i=>`return textureSize(GL_${i<B?"f["+i:"i["+(i-B)}],l);`,0,j)}}`),12&L&&(H+=`uniform highp usampler2DArray GL_i[${N}];uvec4 uGetColor(int u,vec3 p){${tt(i=>`return texture(GL_i[${i-j}],p);`,j,2*j-B)}}uvec4 uGetPixel(int u,ivec3 p,int l){${tt(i=>`return texelFetch(GL_i[${i-j}],p,l);`,j,2*j-B)}}\n#define iGetColor(a,b) ivec4(uGetColor(a,b))\n#define iGetPixel(a,b,c) ivec4(uGetPixel(a,b,c))\n`),3&L&&(H+=`vec4 fGetColor(int u,vec3 p){${tt(i=>`return texture(GL_f[${i}],p);`,0,B)}}lowp vec4 GL_lp(vec4 x){return x;}vec4 fGetPixel(int u,ivec3 p,int l){${Z||tt(i=>`return texelFetch(GL_f[${i}],p,l);`,0,B)}}\n#define getColor(a,b)GL_lp(fGetColor(a,b))\n#define getPixel(a,b,c)GL_lp(fGetPixel(a,b,c))\n`),T[1]=H;const q=32-B&&-1>>>B|0;U[0]=`i&&draw(0);if($s!=s){_.useProgram($P);$H(s,${B},${q},${g>3?S+g*(g-1)+")":`lv==$Q?${S+9}:${S+6});$l(lv)`}}`;const W=k==it-1?`_.vertexAttribIPointer(${k},${3&v.F},5125,${v.F<<2},0)`:`for(let i=${it-1},j=0;i>=${k};i--,j+=16){_.vertexAttribIPointer(i,i==${k}?${3&v.F}:4,5125,${v.F<<2},j)`;R[0]=`sz+=${S};if(this.V()){const sd=$s!=s,{S}=this,_st=S.t;if(sd||sz!=$u){i&&draw(sd?0:$x);$H(s,${B},${q},sz);if(sd)_.useProgram($P),B();${g>3?`}if($v!=_st.v)i&&draw(),$l(_st.v);if(s!=_st.L||sz!=_st.Ls){i&&draw();if(!_st.Ls)$a(_st);$d(sz>${8+S},0,false);_st.L=s;_st.Ls=sz`:`$l(lv=sz>${8+S}?$Q:$q)}if(lv.geo!=_st.b){i&&draw();_.bindBuffer(34962,lv.geo=_st.b);${W};_.bindBuffer(34962,$M);_.bindBuffer(34963,_st.E)`}}if($p!=S)S.S();}let b=$X^$x;`+F.join(";")+`;const k=$G(sz),j=k+sz-${S}`,R.push("return k");const $d=(t=!1,s=0,r=!0)=>{const n=g*(2+t),u=S+n<<2;_.vertexAttribPointer(0,g,5126,!1,u,s),_.vertexAttribPointer(1,g,5126,!1,u,s+(g<<2)),t?(_.enableVertexAttribArray(2),_.vertexAttribPointer(2,g,5126,!1,u,s+(g<<3))):_.disableVertexAttribArray(2);for(let i=0;i<S;i+=4){const t=3+(i>>2);_.enableVertexAttribArray(t),_.vertexAttribIPointer(t,o(4,S-i),5125,u,s+(i+n<<2)),_.vertexAttribDivisor(t,1)}if(r){_.enableVertexAttribArray(0),_.enableVertexAttribArray(1),_.vertexAttribDivisor(0,1),_.vertexAttribDivisor(1,1),_.vertexAttribDivisor(2,1);for(let i=it-1;i>=k;i--)_.enableVertexAttribArray(i)}return u>>2};let $q=null,$Q=null;g<4&&(_.bindVertexArray($q=_.createVertexArray()),$q.geo=null,$d(!1),_.bindVertexArray($v=$Q=_.createVertexArray()),$Q.geo=null,$d(!0));const J=eval(`let ${g<4?"lv=$Q":"__"}${Y.length?Y.join(""):""};const B=function(){${X.join(";")};$x=$X},s=function(sz,{${A}}){${R.join(";")}};s.uniforms=(function(${P}){${U.join(";")};B()});s`),$P=_.createProgram(),K=_.createShader(35633),f=_.createShader(35632);if(E.push("}"),_.shaderSource(K,G.join("")+E.join("")),_.compileShader(K),_.shaderSource(f,T.join("")+"\n"+t),_.compileShader(f),_.attachShader($P,K),_.attachShader($P,f),Z=_.getShaderInfoLog(f))throw"GLSL Error:\n"+Z;_.linkProgram($P),_.useProgram($P);const $L=V.map(t=>_.getUniformLocation($P,t));for(let i=0;i<j;i++)_.uniform1i(_.getUniformLocation($P,i<B?"GL_f["+i+"]":"GL_i["+(i-B)+"]"),i>=B?j+i-B:i);return J.vertex=v,J.three=v.three,$s=J};let ft=0,$t=0,_t=0;$.Shader.UINT=$.Shader("void main(){color=param0;}",{params:$.UVEC4,outputs:$.UINT}),$.Shader.BLACK=$.Shader("void main(){color=vec4(0,0,0,1);}"),$.Shader.DEFAULT=$.Shader("void main(){color=param0(pos)*param1;}",{params:[$.COLOR,$.VEC4],defaults:[void 0,$.vec4.one]}),$.Shader.COLOR_3D_XZ=$.Shader("void main(){color=param0(pos.xz);}",{params:[$.COLOR],defaults:[void 0,$.vec4.one],vertex:Geometry3D.DEFAULT_VERTEX}),$.Shader.SHADED_3D=$.Shader("void main(){float a=(1.+dot(normalize(cross(dFdx(pos),dFdy(pos))),param1));color=param0(pos.xy);color.rgb*=a;}",{params:[$.COLOR,$.VEC3],defaults:[void 0,vec3(-.15,-.3,0)],vertex:Geometry3D.DEFAULT_VERTEX});let yt=0;$.flush=()=>{i&&draw(),E?E=!1:R&&(_.bindBuffer(35051,null),_.deleteBuffer(R),R=null,G=-1);for(let i=0;i<j<<1;i++){const t=U[i];t&&(_.activeTexture(33984+i),_.bindTexture(35866,U[i]=null),t.i=-1)}let t=performance.now();t-yt>1e3&&(yt=t,$i=new Float32Array($i.length>>>1),$I=new Int32Array($i.buffer))};const wt=$.ctx=new q(curt={_:null,p:0,T:null,w:0,h:0,u:0});$.setSize=(w=0,h=0)=>{_.canvas.width=w,_.canvas.height=h,wt.t.w=_.drawingBufferWidth,wt.t.h=_.drawingBufferHeight,curt==wt.t&&(curt=Q=null),wt.t.p=0};const pt=()=>{for(;bt&&37145==_.getSyncParameter(bt.sync,37140);)_.deleteSync(bt.sync),bt(),bt=bt.next;bt||(vt=null,clearInterval(gt),gt=0)};let bt=null,vt=null;const mt=[];$.wait=()=>new Promise(t=>{i?(t.sync=null,mt.push(t)):(t.sync=_.fenceSync(37143,0),bt??=t,vt=vt?vt.next=t:t),gt||(gt=setInterval(pt,0))});let gt=0;return $.loop=t=>("t"in $||($.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=.001*performance.now(),$.dt=0,$.frameCpu=0,$.glLost??=null,requestAnimationFrame(function f(){if(requestAnimationFrame(f),_.isContextLost())return $.glLost?.(),$.glLost=bt=vt=null;i&&draw(),_.bindFramebuffer(36009,N=curt=Q=null),wt.t.p=0,dt=max(.001,o(-($.t-($.t=.001*performance.now())),.5)),wt.reset();try{t()}finally{$.flush(),$.frameCpu=.001*performance.now()-$.t,ft||$.ctx.clear(),$.frameDrawCalls=ft,$.frameSprites=$t,$.frameData=4*_t+24*ft,ft=$t=_t=0}})),$),$},Object.assign($.Gamma,{bitmapOpts:p,STENCIL:1,ALPHA_CHANNEL:2,PREMULTIPLIED_ALPHA:4,AUTO_CLEAR_BUFFER:8,MSAA:16})}