{const $=globalThis,{clz32,cos,sin,min,round}=Math;Math.PI2??=2*Math.PI;if(!('setImmediate'in $)){let t=0,o=0,m=new MessageChannel,c=[];m.port1.onmessage=v=>{v=c[o];c[o++]=null;if(o>3&&o>(c.length>>1))c.splice(0,o),t+=o,o=0;v?.()};m=m.port2;$.setImmediate=(f,...a)=>(m.postMessage(0),c.push(a.length?f.bind(void 0,...a):f)+t-1);$.clearImmediate=i=>{(i-=t)===i>>>0&&i<c.length&&(c[i]=null)}}if(!('sin'in $)){let p=Object.getOwnPropertyDescriptors(Math);delete p[Symbol.toStringTag];Object.defineProperties($,p)};const q={imageOrientation:"flipY",premultiplyAlpha:"premultiply"},R=(t,e,i)=>"string"==typeof t?fetch(t).then((t=>t.blob())).then((t=>createImageBitmap(t,q))).then(e,i):t instanceof Blob?createImageBitmap(t,q).then(e,i):t instanceof ImageBitmap?e(t):(i??Promise.reject)(new TypeError('Invalid src'));($.Gamma=(T=document.createElement('canvas'),$={})=>{const g=$.gl=($.canvas=T).getContext("webgl2",{preserveDrawingBuffer:!1,antialias:!1,depth:!1,premultipliedAlpha:!0,stencil:!0}),pp=g.createBuffer();g.pixelStorei(37440,1),g.stencilMask(1),g.clearStencil(0),g.disable(2929),g.enable(3042),g.disable(3024),g.pixelStorei(3317,1),g.pixelStorei(3333,1),g.bindBuffer(35052,pp);class c{get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,e=0,i=0,s=1,r=1,n=0){this.t=t,this.x=e,this.y=i,this.w=s,this.h=r,this.l=n}get loaded(){return!this.t.S}get then(){return this.t.S?this.#t:null}load(){this.t.T||c.load(this.t)}sub(t=0,e=0,i=1,s=1,r=this.l){return new c(this.t,this.x+t*this.w,this.y+e*this.h,this.w*i,this.h*s,r)}sup(t=0,e=0,i=1,s=1){const r=this.w/i,n=this.h/s;return new c(this.t,this.x-t*r,this.y-e*n,r,n)}crop(t=0,e=0,i=1,s=1,r=this.l){const{t:n,x:h,y:a,h:u}=this;if(!n.S)return new c(n,h+t/n.w,a+u-(e+s)/n.h,i/n.w,s/n.h,r);const o=new c(n,0,0,0,0,r);return n.T||c.load(n),n.S.push((r=>{r.x=h+t/n.w,r.y=a+u-(e+s)/n.h,r.w=i/n.w,r.h=s/n.h}),void 0,o),o}layer(t=this.l){return new c(this.t,this.x,this.y,this.w,this.h,t)}#t(t,e){"function"!=typeof t&&(t=Function.prototype),this.t.S?(this.t.T||c.load(this.t),this.t.S.push(t,e,this)):t(this)}static load(t){let e=t.S,i=0,s=0,r=0;t.S=[];t.T=g.createTexture();const n=n=>{i=-1,c.sO(t),g.texStorage3D(35866,t.m||1,t.f[0],t.w=s=1,t.h=r=1,t.d),z||(g.pixelStorei(37440,1),g.pixelStorei(37441,z=1)),t.m&&g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null);const l=t.S;t.S=null;for(let e=1;e<l.length;e+=3)l[e]?.(l[e+1])};for(let h=0;h<e.length;h++)R(e[h],(a=>{if(i){if(s!=a.width||r!=a.height)return n()}else s=a.width,r=a.height;if(e[h]=a,!(++i<e.length)){c.sO(t),g.texStorage3D(35866,t.m||1,t.f[0],t.w=s,t.h=r,t.d),z||(g.pixelStorei(37440,1),g.pixelStorei(37441,z=1));g.bindBuffer(35052,null);for(let n=0;n<i;n++)g.texSubImage3D(35866,0,0,0,n,s,r,1,t.f[1],t.f[2],e[n]);g.bindBuffer(35052,pp);t.m&&g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null);const l=t.S;t.S=null;for(let e=0;e<l.length;e+=3)l[e](l[e+2])}}),n)}paste(t,e=0,s=0,r=0,n=0,h=0,a=0,u=0,o=0,l=0,q=0,w=0){const{t:f}=this;if(f.S)return this;if(!(t instanceof c))return R(t,(t=>(c.fakeBind(f),z||(g.pixelStorei(37440,1),g.pixelStorei(37441,z=1)),g.bindBuffer(35052,null),g.texSubImage3D(35866,0,e,s,r,t.width,t.height,1,f.f[1],f.f[2],t),g.bindBuffer(35052,pp),f.i<0&&g.bindTexture(35866,null),this)));const{t:b}=t;if(b.S)return t.#t((()=>this.paste(t,e,s,r,n,h,a,u,o,l,q,w))),this;if(f.T==b.T)return console.warn("cannot copy from texture to itself"),this;i&&L();c.fakeBind(f),u=u||b.w,o=o||b.h,l=l||b.d;while(l--)g.framebufferTextureLayer(36008,36064,b.T,q,a++),g.copyTexSubImage3D(35866,w,e,s,r++,n,h,u,o);return f.i<0&&g.bindTexture(35866,null),this}pasteData(t,e=0,i=0,s=0,r=0,n=0,h=0,q=0){const{t:a}=this;if(a.S)return null;r=r||a.w,n=n||a.h,h=h||a.d,c.fakeBind(a),z&&(g.pixelStorei(37440,0),g.pixelStorei(37441,z=0)),g.bufferData(35052,t,35042),g.texSubImage3D(35866,q,e,i,s,r,n,h,a.f[1],a.f[2],0),fd+=.25*t.byteLength,a.i<0&&g.bindTexture(35866,null)}readData(t=0,e=0,s=0,r=0,n=0,h=0,a=null,q=0){const{t:u}=this;if(u.S)return null;r=r||u.w,n=n||u.h,h=h||u.d,i&&L();let o=u.f[0],l=(o==33323||o==33338||o==33340||o==33327||o==33328||o==33336?2:o==33321||o==33330||o==33332||o==33334||o==33325||o==33326?1:4)*r*n;o=l==1?6403:l==2?33319:6408;for(a&&a.length==l||(a=5121==u.f[2]?new Uint8Array(l*h):5126==u.f[2]?new Float32Array(l*h):5125==u.f[2]||35899==u.f[2]||33640==u.f[2]||35902==u.f[2]?new Uint32Array(l*h):new Uint16Array(l*h));h--;)g.framebufferTextureLayer(36008,36064,u.T,q,s),g.readPixels(t,e,r,n,o==1?6403:o==2?33319:6408,u.f[2],a.subarray(l*s,l*++s));return a}delete(){this.t.T&&(g.deleteTexture(this.t.T),this.t.T=null,this.t.i>=0&&(bound[this.t.i]=null,this.t.i=-1),this.t.d=this.t.w=this.t.h=0)}static L(t,e=0){if(t.f[3]>>31!=e)return-2;if(t.i>=0){const i=-2147483648>>>t.i-(H-F&e);if(!(i&(e^M)))return Q|=i,t.i;bound[t.i]=null,t.i=-1}t.T||c.load(t);const i=clz32(~(Q|e^M));if(i>=H)return-1;Q|=-2147483648>>>i;const s=bound[e=e?H+i-F:i];return s&&(s.i=-1),g.activeTexture(33984+e),g.bindTexture(35866,(bound[e]=t).T),t.i=e}static fakeBind(t){if(t.i>=0)g.activeTexture(33984+t.i);else{const e=H-1+(F==H&&H);bound[e]&&(bound[e].t.i=-1),g.activeTexture(33984+e),g.bindTexture(35866,t.T)}}get options(){return this.t.o}static sO(t){c.fakeBind(t);const{o:e}=t;t.f[3]>>31?(g.texParameterf(35866,10240,9728),g.texParameterf(35866,10241,9728)):(g.texParameterf(35866,10240,9728+(1&e)),g.texParameterf(35866,10241,t.m?9984+(e>>1&3):9728+(e>>1&1))),g.texParameterf(35866,10242,8&e?10497:16&e?33648:33071),g.texParameterf(35866,10243,32&e?10497:64&e?33648:33071)}set options(t){const{t:e}=this;e.o=t,e.S||(c.sO(e),e.i<0&&g.bindTexture(35866,null))}setMipmapRange(s=0,e=65535){const{t}=this;t.src||(c.fakeBind(t),g.texParameteri(35866,33082,s),g.texParameteri(35866,33083,e),t.i<0&g.bindTexture(35866,null))}genMipmaps(){const{t:t}=this;t.m&&(c.fakeBind(t),g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null))}};$.Drawable=(x,t=x.l,m=0,e=!1)=>{const{t:i}=x;if(i.S)return null;let s=null;return e&&(g.bindRenderbuffer(36161,s=g.createRenderbuffer()),g.renderbufferStorage(36161,36168,i.w,i.h)),new can({T:i.T,c:x,L:t,stencil:0,mip:m,stencilBuf:s,w:i.w,h:i.h})};let C,z=1,ar=new Float32Array(16),ir=new Int32Array(ar.buffer),i=0;T=$.Texture=(t=0,e=0,i=0,s=0,f=Formats.RGBA,m=0)=>{const h={T:g.createTexture(),i:-1,a:-1,o:s,f,S:null,w:t,h:e,d:+i||1,m},a=new c(h);return c.sO(h),t&&e?g.texStorage3D(35866,(h.m=n)||1,h.f[0],h.w=t,h.h=e,h.d=+i||1):g.texStorage3D(35866,(h.m=n)||1,h.f[0],h.w=1,h.h=1,h.d=1),g.bindTexture(35866,null),a},T.MAX_WIDTH=T.MAX_HEIGHT=g.getParameter(3379),T.MAX_LAYERS=g.getParameter(35071),$.Img=(t,e=0,i=Formats.RGBA,s=0)=>new c({T:null,i:-1,a:-1,o:e,f:i,S:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:t?Array.isArray(t)?t.length:1:0,m:s}),Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NO_DRAW:48,UNSET:64,SET:128,FLIP:192,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:136,RGB_DST:8,ONE_MINUS_DST:153,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,SRC_ALPHA_SATURATE:170,RGB_SRC_ALPHA_SATURATE:10,ADD:17,RGB_ADD:1,A_ADD:16,SUB:85,RGB_SUB:5,A_SUB:80,SUB_REV:102,RGB_SUB_REV:6,A_SUB_REV:96,MIN:34,RGB_MIN:2,A_MIN:32,MAX:51,RGB_MAX:3,A_MAX:48,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:20,UTEXTURE:24,FTEXTURE:28,COLOR:4,UCOLOR:8,FCOLOR:12,FIXED:4,_:void 0,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0});const V=class{constructor(t,e){this.x=t,this.y=e}copy(){return new V(this.x,this.y)}plus(t=0){return"number"==typeof t?new V(this.x+t,this.y+t):new V(this.x+t.x,this.y+t.y)}minus(t=0){return"number"==typeof t?new V(this.x-t,this.y-t):new V(this.x-t.x,this.y-t.y)}neg(){return new V(-this.x,-this.y)}recip(){return new V(1/this.x,1/this.y)}times(t=1){return"number"==typeof t?new V(this.x*t,this.y*t):new V(this.x*t.x,this.y*t.y)}div(t=1){return"number"==typeof t?new V(this.x/t,this.y/t):new V(this.x/t.x,this.y/t.y)}pow(t=1){return"number"==typeof t?new V(this.x**t,this.y**t):new V(this.x**t.x,this.y**t.y)}set(t=0){"number"==typeof t?this.x=this.y=t:(this.x=t.x,this.y=t.y)}map(t){return new V(t(this.x),t(this.y))}eq(t){return"number"==typeof t?this.x==t&&this.y==t:this.x==t.x&&this.y==t.y}length(){return hypot(this.x,this.y)}get yx(){return V(this.y,this.x)}},W=class{constructor(t,e,i){this.x=t,this.y=e,this.z=i}copy(){return new W(this.x,this.y,this.z)}plus(t=0){return"number"==typeof t?new W(this.x+t,this.y+t,this.z+t):new W(this.x+t.x,this.y+t.y,this.z+t.z)}minus(t=0){return"number"==typeof t?new W(this.x-t,this.y-t,this.z-t):new W(this.x-t.x,this.y-t.y,this.z-t.z)}neg(){return new W(-this.x,-this.y,-this.z)}recip(){return new W(1/this.x,1/this.y,1/this.z)}times(t=1){return"number"==typeof t?new W(this.x*t,this.y*t,this.z*t):new W(this.x*t.x,this.y*t.y,this.z*t.z)}div(t=1){return"number"==typeof t?new W(this.x/t,this.y/t,this.z/t):new W(this.x/t.x,this.y/t.y,this.z/t.z)}pow(t=1){return"number"==typeof t?new W(this.x**t,this.y**t,this.z**t):new W(this.x**t.x,this.y**t.y,this.z**t.z)}set(t=0){"number"==typeof t?this.x=this.y=this.z=t:(this.x=t.x,this.y=t.y,this.z=t.z)}map(t){return new W(t(this.x),t(this.y),t(this.z))}eq(t){return"number"==typeof t?this.x==t&&this.y==t&&this.z==t:this.x==t.x&&this.y==t.y&&this.z==t.z}length(){return hypot(this.x,this.y,this.z)}get xy(){return new V(this.x,this.y)}get yz(){return new V(this.y,this.z)}get zyx(){return new W(this.z,this.y,this.x)}},X=class{constructor(t,e,i,s){this.x=t,this.y=e,this.z=i,this.w=s}copy(){return new X(this.x,this.y,this.z,this.w)}plus(t=0){return"number"==typeof t?new X(this.x+t,this.y+t,this.z+t,this.w+t):new X(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}minus(t=0){return"number"==typeof t?new X(this.x-t,this.y-t,this.z-t,this.w-t):new X(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}neg(){return new X(-this.x,-this.y,-this.z,-this.w)}recip(){return new X(1/this.x,1/this.y,1/this.z,1/this.w)}times(t=1){return"number"==typeof t?new X(this.x*t,this.y*t,this.z*t,this.w*t):new X(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)}div(t=1){return"number"==typeof t?new X(this.x/t,this.y/t,this.z/t,this.w/t):new X(this.x/t.x,this.y/t.y,this.z/t.z,this.w/t.w)}pow(t=1){return"number"==typeof t?new X(this.x**t,this.y**t,this.z**t,this.w**t):new X(this.x**t.x,this.y**t.y,this.z**t.z,this.w**t.w)}set(t=0){"number"==typeof t?this.x=this.y=this.z=this.w=t:(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w)}map(t){return new X(t(this.x),t(this.y),t(this.z),t(this.w))}eq(t){return"number"==typeof t?this.x==t&&this.y==t&&this.z==t&&this.w==t:this.x==t.x&&this.y==t.y&&this.z==t.z&&this.w==t.w}length(){return hypot(this.x,this.y,this.z,this.w)}get xy(){return new V(this.x,this.y)}get yz(){return new V(this.y,this.z)}get zw(){return new V(this.z,this.w)}get xyz(){return new W(this.x,this.y,this.z)}get yzw(){return new W(this.y,this.z,this.w)}get wzyx(){return new X(this.w,this.z,this.y,this.x)}};T=$.vec2=(t=0,e=t)=>new V(t,e),T.one=T(1);const v2z=T.zero=T(0);T=$.vec3=(t=0,e=t,i=t)=>new W(t,e,i),T.one=T(1);const v3z=T.zero=T(0);T=$.vec4=(t=0,e=t,i=t,s=t)=>new X(t,e,i,s),T.one=T(1);const v4z=T.zero=T(0);$.Formats={LUM:[6409,6409,5121],A:[6406,6406,5121],LUM_A:[6410,6410,5121],R:[33321,6403,5121],RG:[33323,33319,5121],RGB:[32849,6407,5121],RGBA:[32856,T=6408,5121],RGB565:[36194,6407,33635],R11F_G11F_B10F:[35898,6407,35899],RGB5_A1:[32855,T,32820],RGB10_A2:[32857,T,33640],RGBA4:[32854,T,32819],RGB9_E5:[35901,6407,35902],R8:[33330,T=36244,5121,1<<31],RG8:[33336,33320,5121,1<<31],RGB8:[36221,36248,5121,1<<31],RGBA8:[36220,36249,5121,1<<31],R16:[33332,T,5123,1<<31],RG16:[33338,33320,5123,1<<31],RGB16:[36215,36248,5123,1<<31],RGBA16:[36214,36249,5123,1<<31],R32:[33334,T,5125,1<<31],RG32:[33340,33320,5125,1<<31],RGB32:[36209,36248,5125,1<<31],RGBA32:[36208,36249,5125,1<<31],R16F:[33325,6403,5131],RG16F:[33327,33319,5131],RGB16F:[34843,6407,5131],RGBA16F:[34842,6408,5131],R16F_32F:[33325,6403,5126],RG16F_32F:[33327,33319,5126],RGB16F_32F:[34843,6407,5126],RGBA16F_32F:[34842,6408,5126],R32F:[33326,6403,5126],RG32F:[33328,33319,5126],RGB32F:[34837,6407,5126],RGBA32F:[34836,6408,5126]},$.loader=({url:t})=>(t=t.slice(0,t.lastIndexOf("/")+1),(...e)=>{if(e[0].raw){const i=[e[0][0]];for(let t=1;t<=e.length;t++)i.push(e[t],e[0][t]);const s=i.join("");return"/"==s[0]?s:t+s}return 1==e.length?"/"==e[0][0]?e[0]:t+e[0]:e.map((e=>"/"==e[0]?e:t+e))});const gr=new Function(ArrayBuffer.prototype.transfer?"(ar=new Float32Array(ar.buffer.transfer(i*8))),ir=new Int32Array(ar.buffer)":"{const oa=ar;(ar=new Float32Array(i*2)).set(oa,0);ir=new Int32Array(ar.buffer)}");class can{t;#e;#i;#s;#r;#n;#h;#a;#u;s;get width(){return this.t.w}get height(){return this.t.h}get texture(){return this.t.c}set texture(i){let{t}=this;t.c&&i&&(ca==t&&(i&&L(),ca=null),t.c=i)}get hasStencil(){return!this.t.c||!!this.t.stencilBuf}set hasStencil(s){let{t}=this,b=t.stencilBuf;t.c&&(s?b||(ca==t&&(i&&L(),ca=null),g.bindRenderbuffer(36161,t.stencilBuf=b=g.createRenderbuffer()),g.renderbufferStorage(36161,36168,t.w,t.h)):b&&(ca==t&&(i&&L(),ca=null),t.stencilBuf=null,g.deleteRenderbuffer(b)))}get textureLayer(){return this.t.L}get textureMipmap(){return this.t.mip}set textureLayer(l=0){ca==t&&(i&&L(),ca=null);this.t.L=l}set textureMipmap(m=0){ca==t&&(i&&L(),ca=null);this.t.mip=m}constructor(t,e=1,i=0,s=0,r=1,n=0,h=0,a=290787599,u=$.Shader.DEFAULT,o=df){this.t=t,this.#e=e,this.#i=i,this.#s=s,this.#r=r,this.#n=n,this.#h=h,this.#a=a,this.#u=u,this.s=o}translate(t=0,e=0){this.#n+=t*this.#e+e*this.#s,this.#h+=t*this.#i+e*this.#r}scale(t=1,e=t){this.#e*=t,this.#i*=t,this.#s*=e,this.#r*=e}rotate(t=0){const e=cos(t),i=sin(t),s=this.#e,r=this.#i,n=this.#s,h=this.#r;this.#e=s*e-n*i,this.#i=r*e-h*i,this.#s=s*i+n*e,this.#r=r*i+h*e}transform(t,e,i,s,r,n){const h=this.#e,a=this.#i,u=this.#s,o=this.#r,l=this.#n,f=this.#h;this.#e=h*t+u*e,this.#i=a*t+o*e,this.#s=h*i+u*s,this.#r=a*i+o*s,this.#n=h*r+u*n+l,this.#h=a*r+o*n+f}skew(t=0,e=0){const i=this.#e,s=this.#i;this.#e+=this.#s*e,this.#i+=this.#r*e,this.#s+=i*t,this.#r+=s*t}multiply(t=1,e=0){const i=this.#e,s=this.#i;this.#e=i*t-this.#s*e,this.#i=s*t-this.#r*e,this.#s=i*e+this.#s*t,this.#r=s*e+this.#r*t}getTransform(){return{a:this.#e,b:this.#i,c:this.#s,d:this.#r,e:this.#n,f:this.#h}}new(t=1,e=0,i=0,s=1,r=0,n=0){return new can(this.t,t,e,i,s,r,n,this.#a,this.#u,this.s)}reset(t=1,e=0,i=0,s=1,r=0,n=0){this.#e=t,this.#i=e,this.#s=i,this.#r=s,this.#n=r,this.#h=n,this.#a=290787599,this.#u=$.Shader.DEFAULT,this.s=df}box(t=0,e=0,i=1,s=i){this.#n+=t*this.#e+e*this.#s,this.#h+=t*this.#i+e*this.#r,this.#e*=i,this.#i*=i,this.#s*=s,this.#r*=s}to(t=0,e=0){return"object"==typeof t&&(e=t.y,t=t.x),new V(this.#e*t+this.#s*e+this.#n,this.#i*t+this.#r*e+this.#h)}from(t=0,e=0){"object"==typeof t&&(e=t.y,t=t.x);const i=this.#e,s=this.#i,r=this.#s,n=this.#r,h=i*n-s*r;return new V((t*n-e*r+r*this.#h-n*this.#n)/h,(e*i-t*s+s*this.#n-i*this.#h)/h)}toDelta(t=0,e=0){return"object"==typeof t&&(e=t.y,t=t.x),new V(this.#e*t+this.#s*e,this.#i*t+this.#r*e)}fromDelta(t=0,e=0){"object"==typeof t&&(e=t.y,t=t.x);const i=this.#e,s=this.#i,r=this.#s,n=this.#r,h=i*n-s*r;return new V((t*n-e*r)/h,(e*i-t*s)/h)}determinant(){return this.#e*this.#r-this.#i*this.#s}pixelRatio(){return sqrt((this.#e*this.#r-this.#i*this.#s)*this.t.w*this.t.h)}sub(){return new can(this.t,this.#e,this.#i,this.#s,this.#r,this.#n,this.#h,this.#a,this.#u,this.s)}resetTo(t){this.#e=t.#e,this.#i=t.#i,this.#s=t.#s,this.#r=t.#r,this.#n=t.#n,this.#h=t.#h,this.#a=t.#a,this.#u=t.#u,this.s=t.s}set shader(t){this.#u="function"==typeof t?t:$.Shader.DEFAULT}get shader(){return this.#u}set mask(t){this.#a=-256&this.#a|255&t}get mask(){return 255&this.#a}set blend(t){this.#a=255&this.#a|(t||1135889)<<8}get blend(){return this.#a>>8}get geometry(){return this.s}set geometry(t){this.s=t||df}draw(...t){setv(this.t,this.#a);const e=this.#u(t);ar[e]=this.#e,ar[e+1]=this.#s,ar[e+2]=this.#n,ar[e+3]=this.#i,ar[e+4]=this.#r,ar[e+5]=this.#h}drawRect(t=0,e=0,i=1,s=1,...r){setv(this.t,this.#a);const n=this.#u(r);ar[n]=this.#e*i,ar[n+1]=this.#s*s,ar[n+2]=this.#n+t*this.#e+e*this.#s,ar[n+3]=this.#i*i,ar[n+4]=this.#r*s,ar[n+5]=this.#h+t*this.#i+e*this.#r}drawMat(t=1,e=0,i=0,s=1,r=0,n=0,...h){setv(this.t,this.#a);const a=this.#u(h),u=this.#e,o=this.#i,l=this.#s,f=this.#r,c=this.#n,q=this.#h;ar[a]=u*t+l*e,ar[a+1]=u*i+l*s,ar[a+2]=u*r+l*n+c,ar[a+3]=o*t+f*e,ar[a+4]=o*i+f*s,ar[a+5]=o*r+f*n+q}drawv(t){setv(this.t,this.#a);const e=this.#u(t);ar[e]=this.#e,ar[e+1]=this.#s,ar[e+2]=this.#n,ar[e+3]=this.#i,ar[e+4]=this.#r,ar[e+5]=this.#h}drawRectv(t=0,e=0,i=1,s=1,r){setv(this.t,this.#a);const n=this.#u(r);ar[n]=this.#e*i,ar[n+1]=this.#s*s,ar[n+2]=this.#n+t*this.#e+e*this.#s,ar[n+3]=this.#i*i,ar[n+4]=this.#r*s,ar[n+5]=this.#h+t*this.#i+e*this.#r}drawMatv(t=1,e=0,i=0,s=1,r=0,n=0,h){setv(this.t,this.#a);const a=this.#u(h),u=this.#e,o=this.#i,l=this.#s,f=this.#r,c=this.#n,q=this.#h;ar[a]=u*t+l*e,ar[a+1]=u*i+l*s,ar[a+2]=u*r+l*n+c,ar[a+3]=o*t+f*e,ar[a+4]=o*i+f*s,ar[a+5]=o*r+f*n+q}dup(i){if(i){const w=sh.count;if(i+w>ar.length)gr();for(let j=i-w;j<i;j++)ir[j+w]=ir[j];ar[i]=this.#e,ar[i+1]=this.#s,ar[i+2]=this.#n,ar[i+3]=this.#i,ar[i+4]=this.#r,ar[i+5]=this.#h;i+=w}}dupRect(t=0,e=0,i=1,s=1){if(i){const w=sh.count;if(i+w>ar.length)gr();for(let j=i-w;j<i;j++)ir[j+w]=ir[j];ar[i]=this.#e*i,ar[i+1]=this.#s*s,ar[i+2]=this.#n+t*this.#e+e*this.#s,ar[i+3]=this.#i*i,ar[i+4]=this.#r*s,ar[i+5]=this.#h+t*this.#i+e*this.#r;i+=w}}dupMat(t=1,e=0,i=0,s=1,r=0,n=0){if(i){const w=sh.count;if(i+w>ar.length)gr();for(let j=i-w;j<i;j++)ir[j+w]=ir[j];const u=this.#e,o=this.#i,l=this.#s,f=this.#r,c=this.#n,q=this.#h;ar[i]=u*t+l*e,ar[i+1]=u*i+l*s,ar[i+2]=u*r+l*n+c,ar[i+3]=o*t+f*e,ar[i+4]=o*i+f*s,ar[i+5]=o*r+f*n+q;i+=w}}clear(t=0,e=t,s=t,r=e){"object"==typeof t&&(r=t.w??0,s=t.z??0,e=t.y,t=t.x),i&&L(),setv(this.t,this.#a),g.clearColor(t,e,s,r);const n=this.t.stencil=this.t.stencil+1&7;g.clear(n?16384:(g.stencilMask(255),17408)),g.disable(2960),pmask&=-241}clearStencil(){i&&L(),setv(this.t,this.#a);(this.t.stencil=this.t.stencil+1&7)||(g.stencilMask(255),g.clear(1024)),g.disable(2960),pmask&=-241}}let pmask=285217039;function setv(t,e){const s=t.stencil;let r=pmask^e;if(ca!=t){if(i&&L(),t.c){ca==C.t&&g.bindFramebuffer(36009,fb),t.T==fbTex&&t.L==fbLayer&&t.mip==fbMip||g.framebufferTextureLayer(36009,36064,fbTex=t.T,fbMip=t.mip,fbLayer=t.L),t.stencilBuf!=J&&(g.bindRenderbuffer(36161,J=t.stencilBuf),g.framebufferRenderbuffer(36009,36128,36161,J));const e=t.c.t;g.viewport(0,0,e.w>>fbMip,e.h>>fbMip),e.i>=0&&(g.activeTexture(33984+e.i),g.bindTexture(35866,bound[e.i]=null),e.i=-1);if(!ca||ca.stencil!=s)r|=240}else g.bindFramebuffer(36009,null),g.viewport(0,0,t.w,t.h);ca=t}if(r){if(i&&L(),15&r&&g.colorMask(1&e,2&e,4&e,8&e),240&r)if(240&e){240&pmask||g.enable(2960),g.stencilMask(1<<s),g.stencilFunc(32&e?16&e?g.NEVER:g.NOTEQUAL:16&e?g.EQUAL:g.ALWAYS,255,1<<s);const t=128&e?64&e?g.INVERT:g.REPLACE:64&e?g.ZERO:g.KEEP;g.stencilOp(t,t,t)}else 240&pmask&&g.disable(2960);1996488704&r&&g.blendEquationSeparate(32773+(e>>24&7),32773+(e>>28&7)),16776960&r&&g.blendFuncSeparate((e>>8&15)+766*!!(3584&e),(e>>16&15)+766*!!(917504&e),(e>>12&15)+766*!!(57344&e),(e>>20&15)+766*!!(14680064&e)),-2147483648&r&&(-2147483648&e?g.enable(3024):g.disable(3024)),pmask=e}}function L(t=S){g.bufferData(34962,ir.subarray(0,i),35040);const{type:e,start:s,length:r}=sp;fd+=i,i/=sh.count,fdc++,fs+=i,g.drawArraysInstanced(e,s,r,i),i=0,Q=t;if(pf.length){tl??=pf[0];for(let f of pf)f.s=g.fenceSync(37143,0),hd=hd?hd.n=f:f;pf.length=0}}$.Blend=T=(t=17,e=17,i=0,s=!1)=>t|i<<8|e<<16|s<<23,Object.assign(T,{REPLACE:1114129,DEFAULT:1135889,ADD:1118481,MULTIPLY:1122816,SUBTRACT:5574929,REVERSE_SUBTRACT:6689041,MIN:2232593,MAX:3346705,BEHIND:1118583});let sh=null,ca=null,fbTex=null,J=null,fbLayer=0,fbMip=0,F=0,M=0;const fb=g.createFramebuffer(),buf=g.createBuffer();g.bindFramebuffer(36008,g.createFramebuffer());g.bindBuffer(34962,buf);const H=min(32,g.getParameter(34930)),bound=[];for(let t=H<<1;t>0;t--)bound.push(null);T=$.Geometry=(t,e)=>{if(e.length&3)throw"points.length is not a multiple of 4";e instanceof Float32Array||(T=new Float32Array(e.length),T.set(e,0),e=T);const i=g.createBuffer();return g.bindBuffer(34962,i),g.bufferData(34962,e,35044),i.type=t,g.bindBuffer(34962,buf),{type:t,b:i,start:0,length:e.length>>2,sub}};function sub(e=0,i=this.length-e,s=this.type){return{type:s,b:this.b,start:this.start+e,length:i,sub}};let Q=0,sp=T.DEFAULT=T($.TRIANGLE_STRIP,[0,0,0,0,0,1,0,1,1,0,1,0,1,1,1,1]),S=0,w,tl=null,hd=null;const df=sp,pf=[],iv=0,treeIf=(t=0,e=H,i=0)=>{if(e<=t+1)return w(t);const s=t+(1<<31-clz32(e-t-1));return`if(u<${s+i}){${treeIf(t,s,i)}}else{${treeIf(s,e,i)}}`},nm=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"];T=$.Shader=(P,Y,de,U,ud,Z=4,frat=.5)=>{const E1=["(function({"],G=["",""],A=["#version 300 es\nprecision mediump float;precision highp int;layout(location=0)in vec4 _pos;out vec2 uv,xy;layout(location=1)in mat2x3 m;",""],D=["void main(){gl_PointSize=1.0;uv=_pos.zw;gl_Position=vec4((xy=vec3(_pos.xy,1.)*m)*2.-1.,0.,1.);"],C=["#version 300 es\nprecision mediump float;precision highp int;in vec2 uv,xy;uniform vec2 viewport;out "+(0==Z?"highp vec4 color;":16==Z||32==Z?"uvec4 color;":"lowp vec4 color;"),""];let j=6,o=0,K=0,I=0;const tp=[3,3],tc=[];let id=0;Y="number"==typeof Y?[Y]:Y||[],U="number"==typeof U?[U]:U||[],de=null!=de?Array.isArray(de)?de:[de]:[],ud=null!=ud?Array.isArray(ud)?ud:[ud]:[];for(const t of Y){let e=1+(3&t),i=nm[3&t|t>>4<<2];const s=4==t||8==t||12==t;de[id]??=4==t?v4z:1==e?0:2==e?v2z:3==e?v3z:v4z,E1.push(id+":a"+j+"=de["+id+"],");const r=t>15?(o|=1,"ir[j+"):"ar[j+";if(20!=t&&24!=t&&28!=t||(i="int",o|=1<<(t>>2)-3,K++,tc.push(`a${j}=(c.L(a${j+(24==t?".t,-1":".t,0")})+1||(i&&L(b^Q),c.L(a${j+(24==t?".t,-1":".t,0")})+1))-1`)),12!=t&&28!=t||(o|=2),8!=t&&24!=t||(I++,K--),s){tc.push(`let a${j+1}=${4==t?`-1;if(a${j}.t&&(a${j+1}=c.L(a${j}.t,0))==-1)`:`c.L(a${j+(8==t?".t,-1":".t,0")});if(a${j+1}==-1)`}{i&&L(b^Q);a${j+1}=c.L(a${j+(8==t?".t,-1":".t,0")})}`),K++;const i=`arg${id}raw`;for(A.push(`layout(location=${tp.length+1})in int i${j};layout(location=${tp.length+2})in vec4 i${j+1};centroid out vec4 ${i};`),D.push(4!=t?`${i}=vec4(i${j+1}.xy+uv*i${j+1}.zw,i${j}>>8,i${j}&255);`:`if(i${j}==-1){${i}=i${j+1};${i}.w=max(-15856.,${i}.w);}else{${i}=vec4(i${j+1}.xy+uv*i${j+1}.zw,i${j}>>8,(i${j}&255)==0?-15872:((i${j}&255)<<4)-16384);}`),C.push(`centroid in vec4 ${i};${4==t?"lowp ":8==t?"u":"highp "}vec4 arg${id}(){`+(4==t?`if(${i}.w>-15872.)return ${i};return getColor(int(${i}.w)>>4&31,${i}.xyz);}`:8==t?`return uGetColor(int(${i}.w),${i}.xyz);}`:`return fGetColor(int(${i}.w),${i}.xyz);}`)),o|=1<<1+(t>>2),tp.push(17,4),G.push("ir[j+"+j+"]=a"+(j+1)+"|a"+j+".l<<8"),e=0;++e<3;)G.push(r+(j+e)+"]=a"+j+"."+" xy"[e]);G.push(`if(a${j+1}>=0)${r+(j+3)}]=a${j}.w,${r+(j+4)}]=a${j}.h;else ${r+(j+3)}]=a${j}.z,${r+(j+4)}]=a${j}.w`),e=5}else if(A.push("layout(location="+(tp.length+1)+")in "+i+" i"+j+";flat out "+i+" arg"+id+";"),D.push("arg"+id+"=i"+j+";"),C.push("flat in "+i+" arg"+id+";"),tp.push(e|48&t),1==e)G.push(r+j+"]=a"+j);else for(let t=-1;++t<e;)G.push(r+(j+t)+"]=a"+j+"."+"xyzw"[t]);j+=e,id++}id=0;let j2=0,j3=0;const fn2Params=[],E=["fd+=j2;i&&L(0);if(sh!=s){F=K;M=R;g.useProgram((sh=s).p);g.bindVertexArray(s.vao)}"],F1=[],N=[],O=[];for(const t of U){let e=1+(3&t),i=nm[3&t|t>>4<<2];if(ud[id]??=4==t?v4z:1==e?0:2==e?v2z:3==e?v3z:v4z,fn2Params.push("a"+j2+"=ud["+id+"]"),12!=t&&28!=t||(o|=2),8!=t&&24!=t||(I++,K--),20==t||24==t||28==t)o|=1<<(t>>2)-3,K++,F1.push(`g.uniform1i(O[${j3}],N[${N.length}]?c.L(N[${N.length}]${24==t?",-1":",0"}):${24==t?H:0})`),C.push("uniform int uni"+id+";"),E.push(`N[${N.length}]=a${j2}.t`),N.push(null);else if(4==t||8==t||12==t){F1.push(`g.uniform1i((O[${j3++}],N[${N.length}]?c.L(N[${N.length}]${8==t?",-1":",0"}):${8==t?H:0})|N[${N.length+1}])`),N.push(null,0),K++;const e=`uni${id}raw`;A.push(`uniform int u${j2};uniform vec4 u${j2+1};centroid out vec4 ${e};`),D.push(4!=t?`${e}=vec4(u${j2+1}.xy+uv*u${j2+1}.zw,u${j2}>>8,u${j2}&255);`:`if(u${j2}==-1){${e}=u${j2+1};${e}.w=max(-15856.,${e}.w);}else{${e}=vec4(u${j2+1}.xy+uv*u${j2+1}.zw,u${j2}>>8,(u${j2}&255)==0?-15872:((u${j2}&255)<<4)-16384);}`),C.push(`centroid in vec4 ${e};${4==t?"lowp ":8==t?"u":"highp "}vec4 uni${id}(){`+(4==t?`if(${e}.w>-15872.)return ${e};return getColor(int(${e}.w)>>4&31,${e}.xyz);}`:8==t?`return uGetColor(int(${e}.w),${e}.xyz);}`:`return fGetColor(int(${e}.w),${e}.xyz);}`)),o|=1<<1+(t>>2),E.push(`N[${N.length-2}]=a${j2}.t;N[${N.length-1}]=a${j2}.l<<8;g.uniform4f(O[${j3}],a${j2}.x,a${j2}.y,a${j2}.w,a${j2}.h)`)}else{C.push("uniform "+i+" uni"+id+";");let s=`g.uniform${e+(t<16?"f":t<32?"i":"ui")}(O[${j3}]`;if(1==e)s+=",a"+j2;else for(let t=-1;++t<e;)s+=",a"+j2+"."+"xyzw"[t];E.push(s+")")}j2+=e,id++,j3++}if(K+I>16)throw"Shaders cannot use more than 16 textures/colors";K=K?I?K+round(frat*(H-K-I)):H:0,I=I&&H-K,w=t=>"return texture(GL_f["+t+"],p);";let T=null;C[1]=(20&o?"uniform "+(2&o?"highp":"lowp")+" sampler2DArray GL_f["+K+"];":"")+(8&o?"uniform highp usampler2DArray GL_i["+I+"];":"")+(4&o?`lowp vec4 getColor(int u,vec3 p){${T=treeIf(0,K)}}`:"")+(16&o?`highp vec4 fGetColor(int u,vec3 p){${T||treeIf(0,K)}}`:"")+(8&o?`uvec4 uGetColor(int u,vec3 p){${w=t=>"return texture(GL_i["+t+"],p);",treeIf(0,H-K,H)}}`:""),C[1]+=(4&o?`lowp vec4 getPixel(int u,ivec3 p,int l){${w=t=>"return texelFetch(GL_f["+t+"],p,l);",T=treeIf(0,K)}}`:"")+(16&o?`highp vec4 fGetPixel(int u,ivec3 p,int l){${T||treeIf(0,K)}}`:"")+(8&o?`uvec4 uGetPixel(int u,ivec3 p,int l){${w=t=>"return texelFetch(GL_i["+t+"],p,l);",treeIf(0,H-K,H)}}`:"")+(28&o?`ivec3 getSize(int u,int l){${w=t=>"return textureSize(GL_"+(t<K?"f["+t:"i["+(t-K))+"],l);",T=treeIf(0,H)}}`:""),G[0]="}){if(sh!=s){i&&L(0);F=K;M=R;g.useProgram((sh=s).p);g.bindVertexArray(s.vao);B()}if(sp!=this.s){i&&L();sp=this.s}if(s.geometry!=this.s.b){g.bindBuffer(34962,s.geometry=this.s.b);g.vertexAttribPointer(0,4,5126,0,0,0);g.bindBuffer(34962,buf)}const b=Q^S;"+tc.join(";")+";const j=i;if((i=j+"+j+")>ar.length)"+(ArrayBuffer.prototype.transfer?"ar=new Float32Array(ar.buffer.transfer(i*8)),ir=new Int32Array(ar.buffer)":"{const oa=ar;(ar=new Float32Array(i*2)).set(oa,0);ir=new Int32Array(ar.buffer)}"),G.push("return j})");const s=eval(E1.join("")+G.join(";")),p=s.p=g.createProgram();s.uniforms=eval(`(function(${fn2Params}){${E.join(";")};B()})`);const B=eval(`(function(){${F1.join(";")};S=Q})`),R=32-K&&-1>>>K;const v=g.createShader(35633),f=g.createShader(35632);for(D.push("}"),g.shaderSource(v,A.join("")+D.join("")),g.compileShader(v),g.shaderSource(f,P=C.join("")+"\n"+P),g.compileShader(f),g.attachShader(p,v),g.attachShader(p,f),(T=g.getShaderInfoLog(f))&&console.warn("GLSL Error:\n"+T),g.linkProgram(p),g.useProgram(p);j3--;)O.push(g.getUniformLocation(p,"uni"+O.length));for(let t=0;t<H;t++)g.uniform1i(g.getUniformLocation(p,t<K?"GL_f["+t+"]":"GL_i["+(t-K)+"]"),t>=K?H+t-K:t);s.count=j,g.bindVertexArray(s.vao=g.createVertexArray());let i1=1,i2=0;g.bindBuffer(34962,s.geometry=df.b),g.enableVertexAttribArray(0),g.vertexAttribPointer(0,4,5126,0,0,0),g.bindBuffer(34962,buf);for(const t of tp)g.enableVertexAttribArray(i1),t>>4?g.vertexAttribIPointer(i1,15&t,(t>31)+5124,j<<2,i2):g.vertexAttribPointer(i1,15&t,5126,0,j<<2,i2),g.vertexAttribDivisor(i1++,1),i2+=(15&t)<<2;return sh&&(g.useProgram(sh.p),g.bindVertexArray(sh.vao)),s};let fdc=0,fs=0,fd=0;return T.DEFAULT=sh=T("void main(){color=arg0()*arg1;}",[4,3],[void 0,$.vec4.one]),T.UINT=T("void main(){color=arg0();}",8,void 0,void 0,void 0,32),T.NONE=T("void main(){color=vec4(0,0,0,1);}"),g.useProgram(sh.p),g.bindVertexArray(sh.vao),$.flush=()=>i&&L(),C=$.ctx=new can(ca={T:g.canvas,c:null,L:0,stencil:0,mip:0,stencilBuf:null,w:0,h:0}),$.setSize=(w=0,h=0)=>{C.t.w=g.canvas.width=w;C.t.h=g.canvas.height=h,ca==C.t&&g.viewport(0,0,w,h)},$.wait=()=>new Promise(r=>{r.s=i?(pf.push(r),null):(tl??=r,hd=hd?hd.n=r:r,g.fenceSync(37143,0));iv||=setInterval(_=>{while(tl&&g.getSyncParameter(tl.s,37140)==37145)g.deleteSync(tl.s),tl(),tl=tl.n;tl||(hd=null,clearInterval(iv),iv=0)})}),$.loop=F=>{if("t"in $)return $;$.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=performance.now()*.001,$.dt=0,$.timeToFrame=0,$.glLost??=null;let e=0;return requestAnimationFrame(function t(){if(g.isContextLost?.())return $.glLost?.(),$.glLost=tl=hd=null;requestAnimationFrame(t),i&&L,g.bindFramebuffer(36009,null),ca=C.t,g.viewport(0,0,ca.w,ca.h),dt=max(.001,min(-($.t-($.t=performance.now()*.001)),.5)),$.frameDrawCalls=fdc,$.frameSprites=fs,$.frameData=4*fd+24*fdc,fdc=fs=fd=0,C.reset();try{F()}catch(t){Promise.reject(t)}i&&L(),timeToFrame=performance.now()*.001-$.t}),g.canvas},$}).bitmapOpts=q}Gamma.font=t=>{const e=t.vec4.one,s=t.Shader.MSDF=t.Shader("\nvoid main(){\n\tvec3 c = arg0().rgb;\n\tfloat sd = (uni0 < 0. ? c.r : max(min(c.r, c.g), min(max(c.r, c.g), c.b)))-.5+arg3*abs(uni0);\n\tfloat o = clamp(arg1*sd+.5,0.,1.);\n\tcolor = arg2*o;\n}",[t.COLOR,t.FLOAT,t.VEC4,t.FLOAT],[void 0,1,e,0],[t.FLOAT]);s._unifVal=0;const n=t.BreakToken=(t,e=0,s="",n=void 0)=>{if(t instanceof RegExp){let e=t.flags,s=e.indexOf("g");s>-1&&(e=e.slice(0,s)+e.slice(s+1)),e.includes("y")||(e+="y"),t=new RegExp(t.source,e)}else{let e="[";for(const s of t+""){const t=s.codePointAt();e+=t>=92&&t<=94||45==t?"\\"+s:s}t=new RegExp(e+"]","y")}return t.type=e,t.sep=s,t.next=n,t.sepW=t.sepA=t.sepS=0,t.sepL=null,t};n.NORMAL=0,n.NEVER_BREAK=1,n.ALWAYS_BREAK=2,n.OVERFLOW=3,n.VANISH=4,n.TRUNCATE=5,n.SQUISH=6,n.SQUISH_BREAK=7,n.WRAP_AFTER=8,n.WRAP_BEFORE=16,n.INVISIBLE=32;const o=[n(/\r\n?|\n/y,n.WRAP_AFTER|n.INVISIBLE,""),n(/[$£"+]?[\w'-]+[,.!?:;"^%€*]?/iy,n.NORMAL,"-"),n(/\s+/y,n.VANISH)],c=n(/[^]/y),r=new Map,l={0:null,1:0},h=[0,0,0,l],a=-2,f=(t,e,s,n=0)=>{if(t.sepL=e,t.sepA=s,t.sepS=n,!e)return t.sepW=0;let i=0;const{map:o,kmap:c}=e,r=1/s;for(const e of t.sep){const t=e.codePointAt(),l=o.get(t);if(!l)continue;const h=l.xadv+n+(c.get(t+-1114112)??0);i+=s&&asin(h*s)*r||h}return e.then?.(()=>t.sepL==e&&(t.sepL=null,t.sepW=0)),t.sepW=i};class u extends Array{#t=null;#e=s;#s=1;#n=0;#i=1;#o=0;#c=0;#r=0;#l=h;#h=0;#a=NaN;#f=null;#u=-1;static public=class t{constructor(t){this.#p=t}sub(){const e=new t(this.#p);return e.#b=this.#b,e.#g=this.#g,e.#y=this.#y,e.#_=this.#_,e.#k=this.#k,e.#m=this.#m,e.#d=this.#d,e.#v=this.#v,e}reset(t=null){this.#b="object"==typeof t?t:null,this.#g=s,this.#y=1,this.#_=0,this.#k=0,this.#m=0,this.#v=null,this.#d=0,this.#p.#f==this&&(this.#p.#f=null)}#p;#b=null;get font(){return this.#b}set font(t){"object"==typeof t&&(this.#b=t),this.#p.#f==this&&(this.#p.#f=null)}#g=s;get shader(){return this.#g}set shader(t){"function"==typeof t&&(this.#g=t),this.#p.#f==this&&(this.#p.#f=null)}#y=1;get scale(){return this.#y}set scale(t){this.#y=+t,this.#p.#f==this&&(this.#p.#f=null)}scaleBy(t=1,e=!0,s=!0){if(1==t)return;const n=this.#p,i=n.length;let o=0,c=0;for(;o<i;){const i=n[o++];if("number"==typeof i){if(i<0)continue;o++,3==i||4==i&&s?(c||(c=1),n[o-1]*=t):1==i&&e&&(n[o-1]*=t)}else"string"!=typeof i&&"function"!=typeof i||c||(c=2)}1!=c&&n.unshift(3,t),n.#s*=t,s&&(n.#n*=t),n.#a=NaN,n.#f=null}#w=0;get yOffset(){return this.#w}set yOffset(t){this.#w=+t,this.#p.#f==this&&(this.#p.#f=null)}offsetBy(t=0){if(!t)return;const e=this.#p,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,4==s&&(i||(i=1),e[n-1]+=t)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(4,t),e.#n+=t,e.#f=null}#_=1;get stretch(){return this.#_}set stretch(t){this.#_=+t,this.#p.#f==this&&(this.#p.#f=null)}stretchBy(t=1,e=!0,s=!1){if(1==t)return;const n=this.#p,i=n.length;let o=0,c=0;for(;o<i;){const i=n[o++];if("number"==typeof i){if(i<0)continue;o++,5==i||6==i&&s?(c||(c=1),n[o-1]*=t):1==i&&e&&(n[o-1]*=t)}else"string"!=typeof i&&"function"!=typeof i||c||(c=2)}1!=c&&(s?n.unshift(6,t,5,t):n.unshift(5,t)),n.#i*=t,s&&(n.#o*=t),n.#a=NaN,n.#f=null}get letterWidth(){return this.#y*this.stretch}set letterWidth(t){this.stretch=t/this.#y}#k=0;get skew(){return this.#k}set skew(t){this.#k=+t,this.#p.#f==this&&(this.#p.#f=null)}skewBy(t=0){if(!t)return;const e=this.#p,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,6==s&&(i||(i=1),e[n-1]+=t)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(6,t),e.#o+=t,e.#f=null}#m=0;get letterSpacing(){return this.#m}set letterSpacing(t){this.#m=+t,this.#p.#f==this&&(this.#p.#f=null)}spaceBy(t=0){if(!t)return;const e=this.#p,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,7==s&&(i||(i=1),e[n-1]+=t)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(7,t),e.#c+=t,e.#a=NaN,e.#f=null}#d=0;get curve(){return this.#d}set curve(t){this.#d=+t,this.#p.#f==this&&(this.#p.#f=null)}curveBy(t=0){if(!t)return;const e=this.#p,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,8==s?(i||(i=1),e[n-1]+=t):1!=s||i||(i=2)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(8,t),e.#r+=t,e.#a=NaN,e.#f=null}#v=h;addTextPass(t,e,s,...n){const i=n.length?{0:null,1:0}:l;for(let t=0;t<n.length;t++)i[t+2]=n[t];const o=this.#v,c=this.#v=[];let r=0;for(;r<o.length;r+=4){if(!(o[r]<t)){o[r]==t&&(r+=4);break}c.push(o[r],o[r+1],o[r+2],o[r+3])}for(c.push(t,+e,+s,i);r<o.length;)c.push(o[r],o[r+1],o[r+2],o[r+3]),r+=4;this.#p.#f=null}addLinePass(t,e,s,...n){const i=n.length?{0:null,1:0}:l;for(let t=0;t<n.length;t++)i[t+2]=n[t];const o=this.#v,c=this.#v=[];let r=0;for(;r<o.length;r+=4){if(!(o[r]<t)){o[r]==t&&(r+=4);break}c.push(o[r],o[r+1],o[r+2],o[r+3])}for(c.push(t,i,+e,+s);r<o.length;)c.push(o[r],o[r+1],o[r+2],o[r+3]),r+=4;this.#p.#f=null}setValues(t,...e){const s=this.#v=this.#v.slice();for(let n=0;n<s.length;n+=4){if(s[n]==t){let t=s[n+=3];"number"==typeof t&&(t=s[n-=2]),s[n]=t=t?Object.assign({},t):{0:null,1:0};for(let s=e.length-1;s>=0;s--){const n=e[s];void 0!==n&&(t[s+2]=n)}break}if(s[n]>t)break}this.#p.#f=null}delPass(t){const e=this.#v,s=this.#v=[];for(let n=0;n<e.length;n+=4){if(!(e[n]<t)){e[n]==t&&(n+=4);break}s.push(e[n],e[n+1],e[n+2],e[n+3])}for(;i<e.length;)s.push(e[i],e[i+1],e[i+2],e[i+3]),i+=4;this.#p.#f=null}insertTextPass(t,e,s,...n){const i=n.length?{0:null,1:0}:l;for(let t=0;t<n.length;t++)i[t+2]=n[t];const o=this.#p,c=o.length;let r=0,h=0;for(;r<c;){let n=o[r++];if("number"==typeof n&&n>0)r++;else if("string"==typeof n||"function"==typeof n)h||(h=2);else if(Array.isArray(n)){h||(h=1);const c=o[r-1]=[];let l=0;for(;l<n.length;l+=4){if(!(n[l]<t)){n[l]==t&&(l+=4);break}c.push(n[l],n[l+1],n[l+2],n[l+3])}for(c.push(t,+e,+s,i);l<n.length;)c.push(n[l],n[l+1],n[l+2],n[l+3]),l+=4}}1!=h&&o.unshift(t>0?[0,0,0,l,t,e,s,i]:t<0?[t,e,s,i,0,0,0,l]:[t,e,s,i]),o.#f=null}insertLinePass(t,e,s,...n){const i=n.length?{0:null,1:0}:l;for(let t=0;t<n.length;t++)i[t+2]=n[t];const o=this.#p,c=o.length;let r=0,h=0;for(;r<c;){let n=o[r++];if("number"==typeof n&&n>0)r++;else if("string"==typeof n||"function"==typeof n)h||(h=2);else if(Array.isArray(n)){h||(h=1);const c=o[r-1]=[];let l=0;for(;l<n.length;l+=4){if(!(n[l]<t)){n[l]==t&&(l+=4);break}c.push(n[l],n[l+1],n[l+2],n[l+3])}for(c.push(t,i,e,s);l<n.length;)c.push(n[l],n[l+1],n[l+2],n[l+3]),l+=4}}1!=h&&o.unshift(t>0?[0,0,0,l,t,i,e,s]:t<0?[t,i,e,s,0,0,0,l]:[t,i,e,s]),o.#f=null}adjustValues(t,...e){const s=this.#p,n=s.length;let i=0,o=0;for(;i<n;){const n=s[i++];if("number"==typeof n&&n>0)i++;else if("string"==typeof n||"function"==typeof n)o||(o=2);else if(Array.isArray(n)){const o=s[i-1]=n.slice();n==s.#l&&(s.#l=o);let c=0;for(;c<o.length;c+=4)if(o[c]==t){let t=o[c+=3];"number"==typeof t&&(t=o[c-=2]),o[c]=t=t?Object.assign({},t):{0:null,1:0};for(let s=e.length-1;s>=0;s--){const n=e[s];void 0!==n&&(t[s+2]=n)}break}}}s.#f=null}removePass(t){const e=this.#p,s=e.length;let n=0;t:for(;n<s;){let s=e[n++];if("number"==typeof s&&s>0)n++;else if(Array.isArray(s)){let e=0;for(;e<s.length;e+=4){if(s[e]>t)continue t;if(s[e]==t){for(e+=4;e<s.length;)s[e-4]=s[e],s[e-3]=s[e+1],s[e-2]=s[e+2],s[e-1]=s[e+3],e+=4;s.length-=4;break}}}}}get values(){return this.#v}set values(t){this.#v=t?.length?t:null,this.#p.#f==this&&(this.#p.#f=null)}drawOnly(){this.#p.push(this.#p.#u=-3)}indexOnly(){this.#p.push(this.#p.#u=a)}drawAndIndex(){this.#p.push(this.#p.#u=-1)}advance(t=0){const e=this.#p;e.l!=this&&this.#A(e),e.push(1,+t),e.w=NaN}#A(t){this.#b!=t.#t&&t.push(t.#t=this.#b),this.#g!=t.#e&&t.push(2,t.#e=this.#g),this.#y!=t.#s&&t.push(3,t.#s=this.#y),this.#w!=t.#n&&t.push(4,t.#n=this.#w),this.#_!=t.#i&&t.push(5,t.#i=this.#_),this.#k!=t.#o&&t.push(6,t.#o=this.#k),this.#m!=t.#c&&t.push(7,t.#c=this.#m),this.#d!=t.#r&&t.push(8,t.#r=this.#d),this.#v!=t.#l&&(t.push(this.#v),t.#l=this.#v),t.#f=this}copy(){const t=this.#p,e=t.slice(),s=e.#f=this.sub();return s.#p=e,e.#t=t.#t,e.#e=t.#e,e.#s=t.#s,e.#n=t.#n,e.#i=t.#i,e.#o=t.#o,e.#c=t.#c,e.#r=t.#r,e.#l=t.#l,e.#u=t.#u,e.#h=t.#h,e.#a=t.#a,s}slice(e=0,s=1/0){const n=this.#p,i=new u;e<0&&(e+=n.#h)<0&&(e=0),s<0&&(s+=n.#h)<0&&(s=0);const o=new t(i);let c=0;if(s<=0){for(;c<n.length;){const t=n[c++];if("number"==typeof t){if(t<0){i.#u=t;continue}const e=n[c++];switch(t){case 1:c-=2;break;case 2:o.#g=e;break;case 3:o.#y=e;break;case 4:o.#w=e;break;case 5:o.#_=e;break;case 6:o.#k=e;break;case 7:o.#m=e;break;case 8:o.#d=e}}else{if("string"==typeof t||"function"==typeof t)break;Array.isArray(t)?o.#v=t:o.#b=t}}return-1!=i.#u&&i.push(i.#u),o.#A(i),o}s=s>=e?s-e:0;let r="";for(;e>0&&c<n.length;){const t=n[c++];if("number"==typeof t){if(t<0){i.#u=t;continue}const e=n[c++];switch(t){case 2:o.#g=e;break;case 3:o.#y=e;break;case 4:o.#w=e;break;case 5:o.#_=e;break;case 6:o.#k=e;break;case 7:o.#m=e;break;case 8:o.#d=e}}else if("string"==typeof t){if(!(2&i.#u))continue;if((e-=t.length)<0){r=t.slice(e,(s+=e)+t.length);break}}else Array.isArray(t)?o.#v=t:"object"==typeof t&&(o.#b=t)}for(o.#A(i),-1!=i.#u&&i.push(i.#u),r&&(i.push(r),i.#h+=r.length);s>0&&c<n.length;){const t=n[c++];if(i.push(t),"number"==typeof t){if(t<0){i.#u=t;continue}const e=n[c++];switch(i.push(e),t){case 2:o.#g=e;break;case 3:o.#y=e;break;case 4:o.#w=e;break;case 5:o.#_=e;break;case 6:o.#k=e;break;case 7:o.#m=e;break;case 8:o.#d=e}}else if("string"==typeof t){if(!(2&i.#u))continue;s-=t.length,i.#h+=t.length,s<0?(i[i.length-1]=t.slice(0,s),i.#h+=t.length+s):i.#h+=t.length}else Array.isArray(t)?o.#v=t:"object"==typeof t&&(o.#b=t)}return o}trim(t=1/0){const e=this.#p;if(t<0&&(t+=e.#h)<0&&(t=0),t>e.#h)return;let n=0;if(e.#t=null,e.#e=s,e.#s=1,e.#i=1,e.#n=0,e.#o=0,e.#c=0,e.#u=-1,e.#r=0,e.#l=h,e.#h=t<0?0:t)for(;t>0&&n<e.length;){const s=e[n++];if("number"==typeof s){if(s<0){e.#u=s;continue}const t=e[n++];switch(s){case 2:e.#e=t;break;case 3:e.#s=t;break;case 4:e.#n=t;break;case 5:e.#i=t;break;case 6:e.#o=t;break;case 7:e.#c=t;break;case 8:e.#r=t}}else if("string"==typeof s){if(!(2&e.#u))continue;if((t-=s.length)<0){e[n-1]=s.slice(0,t);break}}else Array.isArray(s)?e.#l=s:"object"==typeof s&&(e.#t=s)}else for(;n<e.length;){const t=e[n++];if("number"==typeof t){if(t<0){e.#u=t;continue}const s=e[n++];switch(t){case 1:n-=2;break;case 2:e.#e=s;break;case 3:e.#s=s;break;case 4:e.#n=s;break;case 5:e.#i=s;break;case 6:e.#o=s;break;case 7:e.#c=s;break;case 8:e.#r=s}}else{if("string"==typeof t||"function"==typeof t){n--;break}Array.isArray(t)?e.#l=t:e.#t=t}}this.#b=e.#t,this.#g=e.#e,this.#y=e.#s,this.#w=e.#n,this.#_=e.#i,this.#k=e.#o,this.#m=e.#c,this.#d=e.#r,this.#v=e.#l,e.length=n,e.#a=NaN}concat(t){const e=this.#p,n=t.#p;e.#h+=n.#h;let i=0;this.#b=null,this.#g=s,this.#y=1,this.#w=0,this.#_=1,this.#k=0,this.#m=0,this.#d=0,this.#v=h;const o=n.length;let c=-1;t:for(;i<o;){const t=n[i++];if("number"==typeof t){if(t<0){c=t;continue}const e=n[i++];switch(t){case 1:i-=2;break t;case 2:this.#g=e;break;case 3:this.#y=e;break;case 4:this.#w=e;break;case 5:this.#_=e;break;case 6:this.#k=e;break;case 7:this.#m=e;break;case 8:this.#d=e}}else{if("string"==typeof t||"function"==typeof t){i--;break}Array.isArray(t)?this.#v=t:this.#b=t}}for(this.#A(e),c!=e.#u&&e.push(e.#u=c);i<o;){const t=n[i++];if(e.push(t),"number"==typeof t){if(t<0){e.#u=t;continue}const s=n[i++];switch(e.push(s),t){case 2:this.#g=s;break;case 3:this.#y=s;break;case 4:this.#w=s;break;case 5:this.#_=s;break;case 6:this.#k=s;break;case 7:this.#m=s;break;case 8:this.#d=s}}else"string"==typeof t?2&e.#u&&(e.#h+=t.length):Array.isArray(t)?this.#v=t:"object"==typeof t&&(this.#b=t)}e.#a=NaN}get length(){return this.#p.#h}set length(t){this.trim(t)}get width(){const t=this.#p;let e=t.#a;if(e==e)return e;e=0;let s=r,n=r,i=0,o=1,c=1,l=0,h=-1,a=0,f=0,u=1,p=-1,b=1;for(;i<t.length;){let g=t[i++];if("number"==typeof g){if(g<0){h=g;continue}const s=t[i++];switch(g){case 1:e+=u*s,p=-1;break;case 3:u=(o=s)*c;break;case 5:u=(c=s)*o;break;case 7:l=s;break;case 8:f=1/s,a=s}}else if("string"==typeof g){if(1&h)for(const t of g){const i=t.codePointAt(),o=s.get(i);if(!o)continue;const c=(n.get(i+1114112*p)??0)*min(u,b);p=i,b=u;const r=(o.xadv+l)*u+c;e+=a&&asin(r*a)*f||r,o.tex?.waiting&&o.tex.load()}}else if("object"==typeof g){if(!g){s=n=r;continue}if(Array.isArray(g))continue;s=g.map,n=g.kmap,g.then?.(()=>t.#a=NaN)}}return t.#a=e}add(t){const e=this.#p;e.#f!=this&&this.#A(e),2&e.#u&&(e.#h+=(t+="").length),e.push(t),e.#a=NaN}addCb(t,e=NaN){if("function"!=typeof t)return;const s=this.#p;s.#f!=this&&this.#A(s),e==e?s.push(t,1,e):s.push(t)}indexAt(t=0){const e=this.#p;let s=r,n=r,i=0,o=1,c=1,l=0,h=-1,a=0,f=0,u=1,p=-1,b=1,g=0,y=0;for(;i<e.length;){let _=e[i++];if("number"==typeof _){if(_<0){h=_;continue}const s=e[i++];switch(_){case 1:t-=u*s,p=-1;break;case 3:u=(o=s)*c;break;case 5:u=(c=s)*o;break;case 7:l=s;break;case 8:f=1/s,a=s}}else if("string"==typeof _)if(1&h)for(const e of _){const i=e.codePointAt(),o=s.get(i);if(!o){2&h&&(y=g+=e.length);continue}const c=(n.get(i+1114112*p)??0)*min(u,b);p=i,b=u;const r=(o.xadv+l)*u+c,_=a&&asin(r*a)*f||r;if(t-=_,2&h){if(t<=-.5*_)return y;y=g+=e.length}}else 2&h&&(g+=_.length);else if("object"==typeof _){if(!_){s=n=r;continue}if(Array.isArray(_))continue;s=_.map,n=_.kmap}}return y}draw(t){const n=this.#p;let i=r,o=r,c=0,l=1,a=1,f=1,u=0,p=0,b=0,g=0,y=0,_=-1,k=t.shader=s,m=h,d=3,v=null,w=0;m[3][1]=1;let A=-1,q=1;const x=t.pixelRatio();let R=1,N=0;t:for(;c<n.length;){let s=n[c++];if("number"==typeof s){if(s<0){_=s;continue t}const e=n[c++];switch(s){case 1:if(y){p&&t.skew(-p,0);const s=.5/y,n=e*y*2;t.rotate(N),t.translate(sin(n)*s,(1-cos(n))*s),t.rotate(-n),N=0,p&&t.skew(p,0)}else t.translate(e,0);A=-1;continue t;case 3:const n=e*a;a=1/e,t.scale(n),b*=l*=a,g*=l,q*=n,y*=n,l=e,v&&(R=x*v.normDistRange*l);for(let t=0;t<d;t+=4)("object"==typeof e[t+3]?e[t+3]:e[t+1])[1]=R;continue t;case 4:b=e*a,g=b*p;continue t;case 2:t.shader=k=s;break;case 5:f=e;continue t;case 6:t.skew(e-p,0),p=e,g=b*e;continue t;case 7:u=.5*e;continue t;case 8:y=e*l;continue t;default:continue t}}else{if("string"==typeof s){if(1&_)for(const n of s){const s=n.codePointAt(),c=i.get(s);if(!c)continue;const r=(o.get(s+1114112*A)??0)*min(q,f);A=s,q=f;const l=(c.xadv+u+u)*f+r,h=r-g;y&&(p&&t.skew(-p,0),t.rotate(N+(N=-asin(l*y)||0)),p&&t.skew(p,0));for(let s=0;s<d;s+=4){const n=m[s+1],i=m[s+2]+b,o=m[s+3];if("object"==typeof n){const s=y*l*(i+w);n[0]=e,t.drawRectv(h+s,i+w,l-s-s,o,n)}else c.tex&&(o[0]=c.tex,t.drawRectv((c.x+u)*f+n+h,c.y+i,c.w*f,c.h,o))}t.translate(l,0)}continue}if("function"==typeof s){const e=t.sub();p&&e.skew(-p,0),N&&e.rotate(N),s(e,v)}else{if(!s){i=o=r;continue}if(Array.isArray(s)){d=(m=s).length;for(let t=0;t<d;t+=4)("object"==typeof m[t+3]?m[t+3]:m[t+1])[1]=R;continue}v=s,w=v.ascend-1,i=s.map,o=s.kmap,R=x*v.normDistRange*l;for(let t=0;t<d;t+=4)("object"==typeof m[t+3]?m[t+3]:m[t+1])[1]=R}}if(v){const t=(1&v._flags?.5:-.5)/v.normDistRange;t!=k._unifVal&&k.uniforms(k._unifVal=t)}}p&&t.skew(-p,0),N&&t.rotate(N),1!=l&&t.scale(a)}break(e=1/0,s=o,n={scale:1,letterSpacing:0,curve:0}){const i=this.#p;let l=1,h="",p=0;for(;p<i.length;){const t=i[p++];"number"==typeof t&&(t<0?l=1&t:p++),"string"==typeof t&&l&&(h+=t)}const b=[];let g="number"==typeof e?e:"function"==typeof e?e(b.length,n):e[min(b.length,e.length-1)],y=new u,_=y.l=new t(y),k=0,m="";p=0;let d=r,v=r,w=1,A=1,q=-1,x=0,R=!1;for(;p<h.length;){let o,l=0,N=y.length,S=x,L=_.#g,O=_.#y,j=_.#w,P=_.#_,B=_.#k,E=_.#m,W=_.#b,F=_.#d,V=_.#v,I=y.#u,T=y.#h;t:{if(s)for(o of s){o.lastIndex=p;const t=o.exec(h);if(t){p+=l=t[0].length,s=o.next??s;break t}}p+=l=1,o=c}const M=o.type;16&M&&(b.push(_),y.#a=R?NaN:x,R=!1,_=_.sub(),_.#p=y=new u,g="number"==typeof e?e:"function"==typeof e?e(b.length,n):e[min(b.length,e.length-1)],N=S=x=T=0,-1!=I&&y.push(y.#u=I),_.#A(y));const D=32&M&&y.#u!=a;if(m){let t=m;l<m.length?(t=m.slice(0,l),m=m.slice(l),l=0):(l-=m.length,m=""),D&&y.push(a),t&&y.push(t),2&y.#u&&(y.#h+=t.length),D&&y.push(y.#u)}for(;l>0;){const t=i[k++];if("number"==typeof t){if(t<0){y.#u=t,y.push(t);continue}const e=i[k++];switch(y.push(t,e),t){case 2:_.#g=y.#e=e;break;case 3:_.#y=y.#s=e;break;case 4:_.#w=y.#n=e;break;case 5:_.#_=y.#i=e;break;case 6:_.#k=y.#o=e;break;case 7:_.#m=y.#c=e;break;case 8:_.#d=y.#r=e}}else if("string"==typeof t){if(!(1&y.#u)){y.push(t),y.#h+=t.length;continue}l-=t.length;let e=t;l<0?(e=t.slice(0,l),m=t.slice(l)):m="",D&&y.push(a),y.push(e),2&y.#u&&(y.#h+=e.length),D&&y.push(y.#u)}else y.push(t),Array.isArray(t)?y.#l=_.#v=t:"function"!=typeof t&&(y.#t=_.#b=t)}for(;;){let s=N,i=0,c=0,l=L,h=O,p=j,k=P,m=B,D=E,H=W,C=V,U=I,G=T,K=F,z=1/K,Q=!1,Y=o.sepL==H&&o.sepA==K&&o.sepS==D?o.sepW:f(o,H,K,D);const $=M?!!(36>>M&1):2*S<g,{scale:J=1,letterSpacing:X=0,curve:Z=0}=n;R||=1!=J||0!=X||0!=Z;let tt=K+Z,et=D+X;for(Z&&(z=1/tt);s<y.length;){const t=y[s++];if("number"==typeof t){if(t<0){U=t;continue}const e=y[s++];switch(t){case 1:if(x+=e,q=-1,x>g-(Y-(v.get(o.sep.codePointAt()+1114112*q)??0))*w||!$)break;N=s-2,c=0,Q=!0,S=x,L=l,O=h,j=p,P=k,B=m,E=D,W=H,F=K,V=C,I=U,T=G;break;case 2:l=e;break;case 3:h=e,w=e*k*J;break;case 4:p=e;break;case 5:k=e,w=e*h*J;break;case 6:m=e;break;case 7:D=e,et=e+X;break;case 8:tt=e+Z,z=1/tt,K=e}}else if("string"==typeof t)if(i=0,1&U)for(const e of t){const t=e.codePointAt(),n=d.get(t);if(i+=e.length,2&U&&(G+=e.length),!n)continue;const r=(v.get(t+1114112*q)??0)*min(w,A);A=w,q=t;const a=(n.xadv+et)*w+r;x+=tt&&asin(a*tt)*z||a,x<=g-(Y-(v.get(o.sep.codePointAt()+1114112*t)??0))*w&&$&&(Q=!0,N=s-1,c=i,S=x,L=l,O=h,j=p,P=k,B=m,E=D,W=H,F=K,V=C,I=U,T=G)}else 2&U&&(G+=t.length);else if(Array.isArray(t))C=t;else{if("function"==typeof t)continue;(H=t)?(d=t.map,v=t.kmap,Y=o.sepL==t&&o.sepA==K&&o.sepS==D?o.sepW:f(o,t,K,D)):(d=v=r,Y=0)}}if(!S||x<=g||!N||3==M)break;if(s=N,i=c,l=L,h=O,p=j,k=P,m=B,D=E,H=W,C=V,U=I,K=F,G=T,6==M||7==M&&g-S>=x-g){const t=(g-S)/(x-S),e=y.length;for(y.splice(s,0,5,t*k),s+=2;s<e;){const e=y[s++];"number"!=typeof e||e<0||(5==e?y[s++]*=t:s++)}y.push(5,k);break}x=S;const st=new u,nt=new t(st),it=y.length;nt.#g=l,nt.#y=h,nt.#w=p,nt.#_=k,nt.#k=m,nt.#m=D,nt.#b=H,nt.#v=C,nt.#d=K,st.#u=U;let ot=s+=!!i;const ct=4!=M&&5!=M;if(i){nt.#A(st);const t=y[s-1];y[s-1]=t.slice(0,i),st.push(t.slice(i))}else{t:for(;ot<it;){const t=y[ot++];if("number"==typeof t){if(t<0){st.#u=t;continue}const e=y[ot++];switch(t){case 1:if(ct){ot-=2;break t}break;case 2:nt.#g=e;break;case 3:nt.#y=e;break;case 4:nt.#w=e;break;case 5:nt.#_=e;break;case 6:nt.#k=e;break;case 7:nt.#m=e;break;case 8:nt.#d=e}}else{if("string"==typeof t||"function"==typeof t){ot--;break}Array.isArray(t)?nt.#v=t:nt.#b=t}}nt.#A(st)}if(ct)for(-1!=st.#u&&st.push(st.#u);ot<it;)st.push(y[ot++]);else for(st.push(a);ot<it;){const t=y[ot++];"number"!=typeof t?st.push(t):t>0&&st.push(t,y[ot++])}st.#h=y.#h-G,y.#h=G,y.#a=R?NaN:x,R=!1,nt.#g=st.#e=_.#g,nt.#y=st.#s=_.#y,nt.#w=st.#n=_.#w,nt.#_=st.#i=_.#_,nt.#k=st.#o=_.#k,nt.#m=st.#c=_.#m,nt.#d=st.#r=_.#d,st.#u=y.#u,nt.#v=st.#l=_.#v,y.length=s,ct||st.#u==a||st.push(st.#u),Q&&(-3!=y.#u&&y.push(y.#u=-3),y.push(o.sep)),b.push(_),_=nt,y=st,g="number"==typeof e?e:"function"==typeof e?e(b.length,n):e[min(b.length,e.length-1)],N=c=S=x=T=0}if(8&M){b.push(_),y.#a=R?NaN:x,R=!1;const t=y.#u;x=0,_=_.sub(),_.#p=y=new u,g="number"==typeof e?e:"function"==typeof e?e(b.length,n):e[min(b.length,e.length-1)],-1!=t&&y.push(y.#u=t),_.#A(y)}}for(;k<i.length;){const t=i[k++];if(y.push(t),"number"==typeof t){if(t<0){y.#u=t;continue}const e=i[k++];switch(y.push(e),t){case 2:_.#g=y.#e=e;break;case 3:_.#y=y.#s=e;break;case 4:_.#w=y.#n=e;break;case 5:_.#_=y.#i=e;break;case 6:_.#k=y.#o=e;break;case 7:_.#m=y.#c=e;break;case 8:_.#d=y.#r=e}}else Array.isArray(t)?y.#l=_.#v=t:"object"==typeof t&&(y.#t=_.#b=t)}return y.#a=R?NaN:x,b.push(_),b}toString(){let t="",e=!0,s=0;const n=this.#p,i=n.length;for(;s<i;){const i=n[s++];"number"==typeof i&&(i<0?e=!!(2&i):s++),"string"==typeof i&&e&&(t+=i)}return t}static ctor=(e=null)=>{const s=new u;if(!e)return s.#f=new t(s);const n=new t(s);return n.#b=e,n}}}t.RichText=u.public.ctor;class p{_flags=0;normDistRange=0;#q=[];map=new Map;ascend=0;kmap=new Map;get then(){return this.#q?this.#x:void 0}#x(t,e){this.#q?.push(t,e)}get isMsdf(){return!!(1&this._flags)}set isMsdf(t){this._flags=-2&this._flags|t}done(){const t=this.#q;if(this.#q=null,t)for(let e=0;e<t.length;e+=2)t[e]?.(this)}error(t){const e=this.#q;if(this.#q=null,e)for(let s=1;s<e.length;s+=2)e[s]?.(t)}chlumsky(e,s="atlas.png"){return e.endsWith("/")&&(e+="index.json"),fetch(e).then(t=>(e=t.url,t.json())).then(n=>{const{atlas:{type:i,distanceRange:o,size:c,width:r,height:l},metrics:{ascender:h,descender:a},glyphs:f,kerning:u}=n,p=(this.isMsdf=i.toLowerCase().endsWith("msdf"))?t.Formats.RGB:t.Formats.R,b=t.Img(new URL(s,e).href,t.SMOOTH,p);this.normDistRange=o/c*2,this.ascend=h/(h-a);for(const{unicode1:t,unicode2:e,advance:s}of u)this.kmap.set(e+1114112*t,s);for(const{unicode:t,advance:e,planeBounds:s,atlasBounds:n}of f)this.map.set(t,s?{x:s.left,y:s.bottom,w:s.right-s.left,h:s.top-s.bottom,xadv:e,tex:b.sub(n.left/r,n.bottom/l,(n.right-n.left)/r,(n.top-n.bottom)/l)}:{x:0,y:0,w:0,h:0,xadv:e,tex:null});this.done()},this.error.bind(this)),this}bmfont(e,s=0){return fetch(e).then(t=>(e=t.url,t.json())).then(n=>{const{chars:i,distanceField:o,pages:c,info:{size:r},common:{base:l,lineHeight:h,scaleW:a,scaleH:f},kernings:u}=n,p=(this.isMsdf=o.fieldType.toLowerCase().endsWith("msdf"))?t.Formats.RGB:t.Formats.R;this.normDistRange=o.distanceRange/h*2;const b=this.ascend=l/h,g=c.map(s=>t.Img(new URL(s,e).href,t.SMOOTH,p));for(const{first:t,second:e,amount:s}of u)this.kmap.set(e+1114112*t,s/r);for(const{id:t,x:e,y:n,width:o,height:c,xoffset:l,yoffset:h,xadvance:u,page:p}of i)this.map.set(t,{x:l/r,y:b-(h-s+c)/r,w:o/r,h:c/r,xadv:u/r,tex:o&&c?g[p].sub(e/a,1-(n+c)/f,o/a,c/f):null});this.done()},this.error.bind(this)),this}draw(t,e,n,i=0,o=-1){if(this.#q)return;i*=.5;let c=t.pixelRatio()*this.normDistRange,r=t.shader;void 0===r._unifVal&&(r=t.shader=s);const l=(1&this._flags?.5:-.5)/this.normDistRange;l!=r._unifVal&&r.uniforms(r._unifVal=l);const{map:h,kmap:a}=this;for(const s of e){const e=s.codePointAt(),r=h.get(e);if(!r)continue;const l=a.get(e+1114112*o)??0;o=e;const f=r.xadv+i+i+l;r.tex&&t.drawRect(r.x+i+l,r.y,r.w,r.h,r.tex,c,...n),t.translate(f,0)}return o}measure(t,e=0,s=-1){if(this.#q)return;let n=0;const{map:i,kmap:o}=this;for(const c of t){const t=c.codePointAt(),r=i.get(t);if(!r)continue;const l=o.get(t+1114112*s)??0;s=t,n+=r.xadv+e+l}return n}}t.Font=()=>new p,t.Font.bmfont=(t,e)=>(new p).bmfont(t,e),t.Font.chlumsky=(t,e)=>(new p).chlumsky(t,e)};globalThis.BitField??=class e extends Array{constructor(e){if(super(),Array.isArray(e))for(let t=0;t<e.length;t++)this.push(e[t]);else if(e instanceof Uint8Array)for(let t=0;t<e.length;t+=4)this.push(e[t]|e[1|t]<<8|e[2|t]<<16|e[3|t]<<24);else if(e)for(const t of e)this.set(t)}static parse(t){return Array.isArray(t)?Object.setPrototypeOf(t,e.prototype):new e}static decode(t,r=new e){r.length=0;let o=t.v32();for(;o--;)r.push(t.i32())}static encode(e,t){const r=t.length;e.v32(r);for(let t=0;t<r;t++)e.i32(this[t])}static of(...t){const r=new e;for(const e of t)r.set(e);return r}set(e){const t=e>>>5;for(;t>=this.length;)this.push(0);this[t]|=1<<(31&e)}unset(e){let t=this.length;const r=e>>>5;if(!(r>=t))for(this[r]&=~(1<<(31&e));t&&!this[--t];)super.pop()}toggle(e){let t=this.length;const r=e>>>5;for(;r>=t;)this.push(0),t++;for(this[r]^=1<<(31&e);t&&!this[--t];)super.pop()}has(e){const t=e>>>5;return!(t>=this.length)&&!!(this[t]&1<<(31&e))}pop(e){let t=e>>>5;if(t>=this.length)return!1;let r=this[t];if(r^=this[t]=r&~(1<<(31&e)),t==this.length-1)for(;t>=0&&!this[t--];)super.pop();return!!r}put(e){let t=e>>>5;for(;t>=this.length;)this.push(0);return!!(this[t]^(this[t]|=1<<(31&e)))}xor(e){let t=this.length;if(t==e.length)for(;t&&this[--t]==e[t];)super.pop();else{let r=t;for(t--;r<e.length;)this.push(e[r++])}for(let r=t;r>=0;r--)this[r]^=e[r]}and(e){let t=this.length;for(this.length>e.length&&(t=this.length=e.length);t&&!(this[--t]&e[t]);)super.pop();for(;t>0;)this[--t]&=e[t]}or(e){let t=this.length-1,r=t;for(;++r<e.length;)this.push(e[r]);for(let r=t;r>=0;r--)this[r]|=e[r]}firstUnset(){let e=-1;for(;++e<this.length;){const t=~this[e];if(t)return e<<5|31-clz32(t&-t)}return e<<5}firstSet(){let e=-1;for(;++e<this.length;)if(this[e])return e<<5|31-clz32(this[e]&-this[e]);return-1}lastSet(){let e=this.length;for(;--e>=0;)if(this[e])return e<<5|31-clz32(this[e]);return-1}popFirst(){let e=-1;for(;++e<this.length;)if(this[e]){let t=31-clz32(this[e]&-this[e]);for(this[e]&=~(1<<t),t|=e<<5,e=this.length;e&&!this[--e];)super.pop();return t}return-1}putFirst(){let e=-1;for(;++e<this.length;){const t=~this[e];if(!t)continue;const r=31-clz32(t&-t);return this[e]|=1<<r,e<<5|r}return this.push(1),e<<5}popLast(){let e=this.length;for(;--e>=0;)if(this[e]){let t=31-Math.clz32(this[e]);for(this[e]&=~(1<<t),t|=e<<5,e=this.length;e&&!this[--e];)super.pop();return t}return-1}clear(){this.length=0}[Symbol.iterator](){const e={value:0,done:!1};let t=0,r=-1;return{[Symbol.iterator](){return this},next:()=>{for(;t<this.length;t++,r=-1){const o=this[t]&r,n=31-clz32(o&-o);if(!(n<0))return r=-2<<n,e.value=t<<5|n,e}return t=1/0,e.done=!0,e}}}iter(e){for(let t=0;t<this.length;t++){let r=-1;for(;;){const o=this[t]&r,n=31-clz32(o&-o);if(n<0)break;r=-2<<n,e(t<<5|n)}}}[Symbol.for("nodejs.util.inspect.custom")](){let e="",t=0;for(let r=0;r<this.length;r++){let o=-1;for(;;){const n=this[r]&o,s=31-clz32(n&-n);if(s<0)break;o=-2<<s,e+=" "+(r<<5|s),t++}}return`BitField(${t}) {[33m${e} [m}`}toUint8Array(){let e=this.length-1,t=this[e],r=0;const o=new Uint8Array(e=(e<<2)+(39-clz32(t)>>3));for(;r<e;r+=4){const e=this[r>>2];o[r]=e,o[1|r]=e>>8,o[2|r]=o>>16,o[3|r]=o>>24}for(r-=4;r<e;)o[r++]=t,t>>=8;return o}},"remove"in Array.prototype||Object.defineProperty(Array.prototype,"remove",{value(e){let t=this.indexOf(e);if(t>=0){for(;t<b.length;)b[t]=b[++t];b.pop()}return t},enumerable:!1,configurable:!0});{let e=null,t=null;const r={__proto__:null,ContextMenu:93,Help:26,Semicolon:186,Quote:222,BracketLeft:219,BracketRight:221,Backquote:192,Backslash:220,Minus:189,EQUAL:187,IntlRo:193,IntlYen:255,MetaLeft:91,MetaRight:91,PrintScreen:44,ScrollLock:145,Pause:19,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NumLock:144,Clear:10,NumpadComma:110,NumpadDecimal:110,Numpad0:96,Numpad1:97,Numpad2:98,Numpad3:99,Numpad4:100,Numpad5:101,Numpad6:102,Numpad7:103,Numpad8:104,Numpad9:105};Gamma.input=(r,o=r.canvas)=>{const n=r.keys=new BitField;r.MOUSE=Object.freeze({LEFT:0,RIGHT:2,MIDDLE:1,BACK:3,FORWARD:4}),r.KEY=Object.freeze({A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,SPACE:32,BACKTICK:192,TAB:9,BACK:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,META:91,METARIGHT:93,CAPSLOCK:20,UP:38,RIGHT:39,DOWN:40,LEFT:37,MOD:navigator.platform.startsWith("Mac")?91:17,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,MINUS:189,EQUAL:187,BR_LEFT:219,BR_RIGHT:221,SEMICOLON:186,APOS:222,BACKSLASH:220,COMMA:188,DOT:190,SLASH:191,PAUSE:19,PAD_ENTER:12,CLEAR:10,HOME:36,END:35,PAGE_UP:33,PAGE_DOWN:34,INS:45,DEL:46,CTX_MENU:93,PAD_0:96,PAD_1:97,PAD_2:98,PAD_3:99,PAD_4:100,PAD_5:101,PAD_6:102,PAD_7:103,PAD_8:104,PAD_9:105,PAD_DIV:111,PAD_MULT:106,PAD_SUB:109,PAD_ADD:107,PAD_DOT:110,NUM_LOCK:144,SCROLL_LOCK:145,HELP:26,RO:193,YEN:255,SYSRQ:44,PRINT_SCREEN:44}),r.GAMEPAD=Object.freeze({A:256,B:257,X:258,Y:259,LB:260,RB:261,LT:262,RT:263,UP:268,DOWN:269,LEFT:270,RIGHT:271,MENU:300}),r.rawMouse=r.vec2(.5),r.rawWheel=r.vec2(),r.cursor=r.vec2(.5),r.cursorDelta=r.vec2(.5),r.scrollDelta=r.vec2(),Object.defineProperty(r,"poinerLock",{get:()=>document.pointerLockElement==o,set:e=>{e?document.pointerLockElement!==o&&o.requestPointerLock({unadjustedMovement:!0})?.catch(e=>null):document.pointerLockElement===o&&document.exitPointerLock()}}),Object.defineProperty(r,"fullscreen",{get:()=>document.fullscreenElement==o,set:e=>{e?document.fullscreenElement!==o&&o.requestFullscreen()?.catch(e=>null):document.fullscreenElement===o&&document.exitFullscreen()}});const s=new Map;(r.onKey=(e,t)=>{if(Array.isArray(e)){for(const o of e)r.onKey(o,t);return}const o=s.get(e&=65535);o?o.push(t):s.set(e,[t])}).remove=(e,t)=>{if(Array.isArray(e)){for(const o of e)r.onKey.remove(o,t);return}const o=s.get(e&=65535);o&&(o.remove(t),!o.length)&&s.delete(e)},(r.onKeyRelease=(e,t)=>{if(Array.isArray(e)){for(const o of e)r.onKeyRelease(o,t);return}const o=s.get(e=~(65535&e));o?o.push(t):s.set(e,[t])}).remove=(e,t)=>{if(Array.isArray(e)){for(const o of e)r.onKeyRelease.remove(o,t);return}const o=s.get(e=~(65535&e));o&&(o.remove(t),!o.length)&&s.delete(e)};const i=[],l=[];(r.onWheel=e=>{i.push(e)}).remove=e=>{i.remove(e)},(r.onMouse=e=>{l.push(e)}).remove=e=>{l.remove(e)},o.style.cursor="default",Object.defineProperty(r,"cursorType",{get:()=>o.style.cursor,set(e){o.style.cursor=e||"default"}}),o.addEventListener("mouseover",r=>{e||(e=n,t=s)}),o.addEventListener("mouseout",r=>{e==n&&(n.iter(e=>{const t=s.get(~e);if(t)for(const r of t)try{r(e)}catch(e){Promise.reject(e)}}),n.clear(),e=t=null)}),o.addEventListener("mousedown",e=>{e.preventDefault();const t=e.button;n.set(t);const r=s.get(t);if(r)for(const o of r)try{o(t)}catch(e){Promise.reject(e)}}),o.addEventListener("mouseup",e=>{e.preventDefault();const t=e.button;if(!n.pop(t))return;const r=s.get(~t);if(r)for(const o of r)try{o(t)}catch(e){Promise.reject(e)}}),o.addEventListener("contextmenu",e=>e.preventDefault()),o.addEventListener("wheel",e=>{e.preventDefault(),r.rawWheel.x+=e.wheelDeltaX,r.rawWheel.y+=e.wheelDeltaY,r.scrollDelta.x+=e.wheelDeltaX/innerWidth,r.scrollDelta.y+=e.wheelDeltaY/innerHeight;for(const t of i)t(e.wheelDeltaX,e.wheelDeltaY)},{passive:!1}),o.addEventListener("mousemove",e=>{e.preventDefault(),r.rawMouse.x+=e.movementX,r.rawMouse.y+=e.movementY,r.cursor.x=e.offsetX/e.target.offsetWidth,r.cursor.y=1-e.offsetY/e.target.offsetHeight,r.cursorDelta.x+=e.movementX/e.target.offsetWidth,r.cursorDelta.y-=e.movementY/e.target.offsetHeight;for(const t of i)t(e.movementX,e.movementY)})},document.addEventListener("keydown",o=>{if(!e)return;if(document.activeElement!=document.body&&document.activeElement||o.preventDefault(),o.repeat)return;const n=r[o.code]??o.keyCode;e.set(n);const s=t.get(n);if(s)for(const e of s)try{e(n)}catch(o){Promise.reject(o)}}),document.addEventListener("keyup",o=>{if(!e)return;document.activeElement!=document.body&&document.activeElement||o.preventDefault();const n=r[o.code]??o.keyCode;if(!e.pop(n))return;const s=t.get(~n);if(s)for(const e of s)try{e(n)}catch(o){Promise.reject(o)}})}{const e=Promise.resolve();Gamma.textfield=s=>{const i=({target:t})=>(256&t._field._f||(t._field._f|=256,e.then(t._field.recalc)),t.remove(),r=null),h=t=>{const s=t.target,i=s._field;if(38==t.keyCode||40==t.keyCode){if(i._f>>1&1^t.shiftKey)38==t.keyCode?i.upArrowCb?.():i.downArrowCb?.();else if(2048&i._f)if(i.sel0==i.sel1){let e=i.sel0,s=e,h=i.sel0pos,l=h;for(;l;)e-=i.lines[--l].length;const n=i.lines[h].slice(0,e).width;if(38==t.keyCode&&h){const t=i.lines[h-1];i.sel0=i.sel1=s-e-t.length+t.indexAt(n)}else 40==t.keyCode&&h<i.lines.length-1&&(i.sel0=i.sel1=s-e+i.lines[h].length+i.lines[h+1].indexAt(n))}else 38==t.keyCode?i.sel0=i.sel1:i.sel1=i.sel0}else if(13==t.keyCode){if(!(i._f>>2&1^t.shiftKey))return;i.enterCb?.()}else{if(9!=t.keyCode)return;if(i._f>>3&1^t.shiftKey)i.tabCb?.();else if(1&i._f){const t=s.selectionStart;s.value=s.value.slice(0,t)+"\t"+s.value.slice(s.selectionEnd),s.selectionStart=s.selectionEnd=t+1,256&i._f||(i._f|=256,e.then(i.recalc))}}t.preventDefault()},l=(t,e)=>{const s=document.createElement(t);return s.style="width:1px;height:1px;border:0;padding:0;opacity:0;position:absolute;inset:-100px;font-size:1px;font-family:monospace;white-space:nowrap",s.onblur=i,s.onkeydown=h,s.tabIndex=-1,s._field=e,document.documentElement.append(s),s},n=s.vec4;let r=null,c=0;const f=(t,e)=>t.insertLinePass(-1,0,1,e.focus?n(0,.2,.4,.6):n(.2,.2,.2,.6)),o=(t,e)=>{t.shader=null,(s.t-c)%1<.5&&t.drawRect(0,e.ascend-1,.05,1,n.one)};s.blinkTimer=()=>s.t-c;class a{_f=0;#t=0;#e=0;get allowTabs(){return!!(1&this._f)}set allowTabs(t){this._f=-2&this._f|1&t}get shiftArrows(){return!!(2&this._f)}set shiftArrows(t){this._f=-3&this._f|2&-t}get shiftEnter(){return!!(4&this._f)}set shiftEnter(t){this._f=-5&this._f|4&-t}get shiftTab(){return!!(8&this._f)}set shiftTab(t){this._f=-9&this._f|8&-t}upArrowCb=null;downArrowCb=null;enterCb=null;tabCb=null;scrollable=null;#s;constructor(t){this.#s=l(t?"textarea":"input",this),this._f=t}get value(){return this.#s.value}set value(t){this.#s.value=t,256&this._f||(this._f|=256,e.then(this.recalc))}get sel0(){return this.#t}set sel0(t){this.#s.selectionStart=this.#t=t,256&this._f||(this._f|=256,e.then(this.recalc))}get sel1(){return this.#e}set sel1(t){this.#s.selectionEnd=this.#e=t,256&this._f||(this._f|=256,e.then(this.recalc))}#i=null;get transformer(){return this.#i}set transformer(t){this.#i!=(this.#i=t)&&!(256&this._f)&&(this._f|=256,e.then(this.recalc))}simpleTransformer(t,i="",...h){let l=h.slice();l[0]=h[0]?.times(.4)??n(.4),this.#i=e=>{const n=s.RichText(t);return h.length&&n.setValues(0,...h),e?n.add(e):(n.setValues(0,...l),n.drawOnly(),n.add(i)),n},256&this._f||(this._f|=256,e.then(this.recalc))}#h=o;#l=f;#n=null;#r=null;#c=1/0;#f=0;#o=0;#a=0;get sel0pos(){return this.#f}get sel1pos(){return this.#o}get multiline(){return!!(2048&this._f)}set multiline(t=!0){const s=this.#s,i=s.value,h=document.activeElement==s;if(t){if(2048&this._f)return;this.#n=null,this._f|=2304,this.#s=l("textarea",this)}else{if(!(2048&this._f))return;this.#r=null,this._f=-2049&this._f|256,this.#s=l("input",this)}h?this.focus=!0:(s.remove(),r==s&&(r=null),256&this._f||(this._f|=256,e.then(this.recalc))),this.#s.value=i,this.#s.selectionStart=this.#t,this.#s.selectionEnd=this.#e}get width(){return this.#a}get line(){return this.#n}get lines(){return this.#r}get cursor(){return this.#h}set cursor(t){this.#h!=(this.#h=t)&&!(256&this._f)&&(this._f|=256,e.then(this.recalc))}get selector(){return this.#l}set selector(t){this.#l!=(this.#l=t)&&!(256&this._f)&&(this._f|=256,e.then(this.recalc))}get maxWidth(){return this.#c}set maxWidth(t){this.#c=t,256&this._f||(this._f|=256,e.then(this.recalc))}recalc=()=>{const t=this._f;if(!(256&t))return;const e=this.#s,i=this.#t,h=this.#e;this._f=-257&t,c=s.t;const l=e.value,n=this.#i?.(l,this)??s.RichText();if(i==h){const e=n.slice(i);n.trim(i),2048&t||(this.#f=this.#o=n.width),this.#h&&document.activeElement==this.#s&&n.addCb(this.#h),n.concat(e)}else{const e=n.slice(i),s=e.slice(h-i);e.trim(h-i),n.trim(i),2048&t?(this.#l?.(e,this),n.concat(e)):(this.#f=n.width,this.#l?.(e,this),n.concat(e),this.#o=n.width),n.concat(s)}if(2048&t){const t=this.#r=n.break(this.#c);let e=0;for(const{width:s}of t)s>e&&(e=s);this.#a=e;let s=i,l=0;for(;l<t.length&&s>=0;)s-=t[l++].length;for(s=h-i+s+(l?t[--l].length:0),this.#f=l;l<t.length&&s>=0;)s-=t[l++].length;this.#o=l?l-1:0}else this.#n=n,this.#a=n.width};insert(t="",s=t.length){const i=this.#s,h=i.value,l=i.selectionStart,n=i.selectionEnd;i.value=h.slice(0,l)+t+h.slice(n),i.selectionStart=i.selectionEnd=l+s,256&this._f||(this._f|=256,e.then(this.recalc))}get focus(){return document.activeElement==this.#s}set focus(t=!0){if(t){if(r){if(r==this.#s)return;r.replaceWith(r=this.#s)}else document.documentElement.append(r=this.#s);r.focus(),c=s.t}else r==this.#s&&(r.remove(),r=null)}get isSelecting(){return!!(this._f>>9&3)}lineHeight=1.3;lineAscend=.9;#u=0;get height(){return this.lineHeight*(this.#r?this.#r.length:1)}consumeInputs(i,{x:h,y:l}=i.from(s.cursor),n=s.keys.has(0)){if(l=this.lineAscend-l,cursorType="text",!n)return void(this._f=-1537&this._f);if(!this.focus&&(this.focus=!0,this.#t!=this.#e))return void(this._f|=1536);const r=this._f>>9&3;let c=0;if(this.#n)c=this.#n.indexAt(h);else if(this.#r){let t=floor(l/this.lineHeight);for(t=t<0?0:t>=this.#r.length?this.#r.length-1:t,c=this.#r[t].indexAt(h);t;)c+=this.#r[--t].length}if(1==r)c>this.sel1?(this.sel0=this.sel1,this.sel1=c,this._f=-1537&this._f|1024):c!=this.#t&&(this.#t=this.#s.selectionStart=c,256&this._f||(this._f|=256,e.then(this.recalc)));else if(2==r)c<=this.sel0?(this.sel1=this.sel0,this.sel0=c,this._f=-1537&this._f|512):c!=this.#e&&(this.#e=this.#s.selectionEnd=c,256&this._f||(this._f|=256,e.then(this.recalc)));else if(!r){let s=0,i=c,h=c;if(this.#u<0?this.#u-(this.#u=-t)<.3?s=2:this.#u=t:this.#u>0?this.#u-(this.#u=t)>-.3&&(s=1,this.#u=-t):this.#u=t,this._f=-1537&this._f|512,s){this._f|=1024;const t=this.#s.value,e=33-s;for(;t.codePointAt(h++)>e;);for(;t.codePointAt(--i)>e;);i++,h--}i==this.#t&&h==this.#e||(this.#s.selectionStart=this.#t=i,this.#s.selectionEnd=this.#e=h,256&this._f||(this._f|=256,e.then(this.recalc)))}}get height(){return this.#r?this.#r.length*this.lineHeight:this.lineHeight}get xOffset(){return 0}get yOffset(){return-this.lineAscend}draw(t){if(this.#r)for(const e of this.#r)e.draw(t.sub()),t.translate(0,-this.lineHeight);else this.#n?.draw(t)}static#d=(document.addEventListener("input",t=>{const s=t.target._field;s&&(s.#t=t.target.selectionStart,s.#e=t.target.selectionEnd,256&s._f||(s._f|=256,e.then(s.recalc)))}),document.addEventListener("selectionchange",t=>{const s=t.target._field;s&&(s.#t=t.target.selectionStart,s.#e=t.target.selectionEnd,256&s._f||(s._f|=256,e.then(s.recalc)))}))}s.TextField=(t=!1)=>new a(t<<11&2048)}}{Object.defineProperties(Array.prototype,{best:{enumerable:!1,value(t,s=-1/0){let e;const i=this.length;for(let h=0;h<i;h++){const i=this[h],r=t(i,h,this);r>=s&&(s=r,e=i)}return e}},mmap:{enumerable:!1,value(t){const s=this.length;for(let e=0;e<s;e++)this[e]=t(this[e]);return this}},bind:{enumerable:!1,value(t,s=-1){if((s>>>=0)>=this.length)return this.push(t);let e;for(;s<this.length;)e=this[s],this[s++]=t,t=e;return this.push(e)}},fire:{enumerable:!1,value(...t){for(const s of this)try{s(...t)}catch(t){Promise.reject(t)}}},mapFire:{enumerable:!1,value(...t){const s=[];for(const e of this)try{s.push(e(...t))}catch(t){Promise.reject(t),s.push(void 0)}return s}}}),Uint8Array.fromHex=function(t){const s=new Uint8Array(t.length>>>1);let e=1,i=0;for(let h=0;h<t.length;h++){const r=t.charCodeAt(h);r>47&&r<58?e=e<<4|r-48:r>64&&r<71?e=e<<4|r-55:r>96&&r<103&&(e=e<<4|r-87),256&e&&(s[i++]=e,e=1)}return s.slice(0,i)};const t="0123456789abcdef";Number.prototype.toHex=function(){return t[this>>>28]+t[this>>24&15]+t[this>>20&15]+t[this>>16&15]+t[this>>12&15]+t[this>>8&15]+t[this>>4&15]+t[15&this]},Number.formatData=t=>t<512?t.toFixed(0)+"B":t<524288?(t/1024).toFixed(1)+"KiB":t<536870912?(t/1048576).toFixed(1)+"MiB":t<549755813888?(t/1073741824).toFixed(1)+"GiB":(t/1099511627776).toFixed(1)+"TiB",Date.safestamp=(t=new Date)=>`${t.getYear()+1900}-${("0"+t.getMonth()).slice(-2)}-${("0"+t.getDate()).slice(-2)}-at-${("0"+t.getHours()).slice(-2)}-${("0"+t.getMinutes()).slice(-2)}-${("0"+t.getSeconds()).slice(-2)}`,Math.randint??=()=>4294967296*Math.random()|0;const s=document.createElement("a");globalThis.download=(t,e=t.name??("@"==t.type[0]?"file":t.type.split("/",1)[0]))=>{s.href=URL.createObjectURL(t),s.download=e,s.click(),URL.revokeObjectURL(s.href)},globalThis.loader=({url:t})=>(t=t.slice(0,t.lastIndexOf("/")+1),(...s)=>{if(s[0].raw){const e=[s[0][0]];for(let t=1;t<=s.length;t++)e.push(s[t],s[0][t]);const i=e.join("");return"/"==i[0]?i:t+i}return 1==s.length?"/"==s[0][0]?s[0]:t+s[0]:s.map(s=>"/"==s[0]?s:t+s)}),Array.map??=(t=0,s)=>{const e=[];for(let i=0;i<t;i++)e.push(s(i));return e},Gamma.utils=t=>{t.screenshot=(s="image/png",e)=>new Promise(i=>requestAnimationFrame(()=>t.canvas.toBlob(i,s,e)));class s{x=0;y=0;sensitivity=.5;constructor(t,s,e){this.contents=t,this.width=s,this.height=e}scrollBarX=i;scrollBarY=i;get scrollbar(){return this.scrollBarY}set scrollbar(t){this.scrollBarX=this.scrollBarY=t}consumeInputs(t){const{x:s,y:e}=t.fromDelta(scrollDelta),i=this.sensitivity;scrollDelta.x=scrollDelta.y=0;const h=this.contents.width,r=this.contents.height;this.x=this.width>0?max(0,min(this.x+s*i,h-this.width)):min(0,max(this.x+s*i,-h-this.width)),this.y=this.height>0?max(0,min(this.y+e*i,r-this.height)):min(0,max(this.y+e*i,-r-this.height)),wheel.x=wheel.y=0;const n=this.contents;n&&((t=t.sub()).translate((n.xOffset??0)-this.x,(n.yOffset??0)-this.y),n.consumeInputs?.(t))}draw(t,...s){const e=this.contents;if(!e?.draw)return;const i=t.mask,h=t.sub();if(h.mask=128,h.drawRect(0,0,this.width,this.height),h.mask=15&i|16,h.translate((e.xOffset??0)-this.x,(e.yOffset??0)-this.y),this.contents.draw(h,...s),t.clearStencil(),this.scrollBarX&&this.height){const s=t.sub();s.translate(0,this.height),this.height>0&&s.scale(1,-1);const i=abs(this.width),h=i/e.width;h<1&&this.scrollBarX(s,abs(this.x)*h,i*h)}if(this.scrollBarY&&this.width){const s=t.sub();s.translate(this.width,0),s.multiply(0,1),this.width>0&&s.scale(1,-1);const i=abs(this.height),h=i/e.height;h<1&&this.scrollBarY(s,abs(this.y)*h,i*h)}}}t.Scrollable=(t,e=1,i=-1)=>new s(t,+e,+i);const e=t.vec4(.2),i=t.Scrollable.defaultScrollbar=(t,s,i)=>{t.shader=null,t.drawRect(s,0,i,.1,e)}}}