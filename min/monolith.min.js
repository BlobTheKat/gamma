<<<<<<< HEAD
Gamma.font=e=>{const t=e.vec4.one,s={x:0,y:1},n=e.Geometry2D.SQUARE,r=e.Shader.MSDF=e.Shader("void main(){vec3 c=param0(pos).rgb;color=param2*clamp(param1.y*(max(min(c.r,c.g),min(max(c.r,c.g),c.b))-.5+param1.x)+.5,0.,1.);}",{params:[e.COLOR,e.VEC2,e.VEC4],defaults:[null,{x:0,y:1},t]});r.sdf=!0,e.Shader.sdf=(t,s={})=>{let n="float field(vec2 uv){vec3 c=param0(uv).rgb;return max(min(c.r, c.g), min(max(c.r, c.g), c.b)); }\n#define scale param1\n";Array.isArray(s.params)||(s.params="number"==typeof s.params?[s.params]:[]),Array.isArray(s.defaults)||(s.defaults=void 0===s.defaults?[]:[s.defaults]);for(let e=0;e<s.params.length;e++)n+=`#define value${e} param${e+2}\n`;s.params.unshift(e.COLOR,e.VEC2),s.defaults.unshift(void 0,{x:0,y:1});const r=e.Shader(n+t,s);return r.sdf=!0,r};const i=e.BreakToken=(e,t=0,s="",n=void 0)=>{if(e instanceof RegExp){let t=e.flags,s=t.indexOf("g");s>-1&&(t=t.slice(0,s)+t.slice(s+1)),t.includes("y")||(t+="y"),t!=e.flags&&(e=new RegExp(e.source,t))}else{let t="[";for(const s of e+""){const e=s.codePointAt();t+=e>=92&&e<=94||45==e?"\\"+s:s}e=new RegExp(t+"]","y")}return e.type=t,e.sep=s,e.next=n,e.sepW=e.sepA=e.sepS=0,e.sepL=null,e};i.NORMAL=0,i.NEVER_BREAK=1,i.ALWAYS_BREAK=2,i.OVERFLOW=3,i.VANISH=4,i.TRUNCATE=5,i.SQUISH=6,i.SQUISH_BREAK=7,i.WRAP_AFTER=8,i.WRAP_BEFORE=16,i.INVISIBLE=32;const o=[i(/\r\n?|\n/y,i.WRAP_AFTER|i.INVISIBLE,""),i(/[$£"+]?[\w'\xA0\-]+[,.!?:;"^%€*]?/iy,i.NORMAL,"-"),i(/[ \t]+/y,i.VANISH)],c=i(/[^]/y,i.ALWAYS_BREAK),a={x:0,y:0},l={n:{0:null},off:0,spr:-1,0:null,1:a},h=[0,0,0,l],f=(e,t,s,n=0)=>{if(e.sepL=t,e.sepA=s,e.sepS=n,!t)return e.sepW=0;let r=0;const i=1/s;for(const o of e.sep){const e=o.codePointAt(),c=(t.get(~e)??t._default).width+n+(t.get(e+-16777216)??0);r+=s&&asin(c*s)*i||c}return t.then?.(()=>e.sepL==t&&(e.sepL=null,e.sepW=0)),e.sepW=r};class u extends Array{#e=null;#t=r;#s=n;#n=1;#r=0;#i=1;#o=0;#c=0;#a=0;#l=h;#h=0;#f=NaN;#u=null;#p=!0;static public=class e{constructor(e){this.#b=e}sub(){const t=new e(this.#b);return t.#y=this.#y,t.#g=this.#g,t.#_=this.#_,t.#k=this.#k,t.#m=this.#m,t.#d=this.#d,t.#w=this.#w,t.#A=this.#A,t.#v=this.#v,t.#x=this.#x,t}reset(e=null){this.#y="object"==typeof e?e:null,this.#g=r,this.#_=n,this.#k=1,this.#m=1,this.#d=0,this.#w=0,this.#A=0,this.#v=h,this.#x=!0,this.#b.#u==this&&(this.#b.#u=null)}#b;#y=null;#x=!0;get font(){return this.#y}set font(e){"object"==typeof e&&(this.#y=e),this.#b.#u==this&&(this.#b.#u=null)}#g=r;get shader(){return this.#g}set shader(e){"function"==typeof e&&(this.#g=e),this.#b.#u==this&&(this.#b.#u=null)}#_=n;get geometry(){return this.#_}set geometry(e){this.#_=e,this.#b.#u==this&&(this.#b.#u=null)}#k=1;get scale(){return this.#k}set scale(e){this.#k=+e,this.#b.#u==this&&(this.#b.#u=null)}scaleBy(e=1,t=!0,s=!0){if(1==e)return;const n=this.#b,r=n.length;let i=0,o=0;for(;i<r;){const r=n[i++];"number"==typeof r?(4==r||5==r&&s?(o||(o=1),n[i]*=e):1==r&&t&&(n[i]*=e),i++):"string"!=typeof r&&"function"!=typeof r||o||(o=2)}1!=o&&n.unshift(4,e),n.#n*=e,s&&(n.#r*=e),n.#f=NaN,n.#u=null}#q=0;get yOffset(){return this.#q}set yOffset(e){this.#q=+e,this.#b.#u==this&&(this.#b.#u=null)}offsetBy(e=0,t=!1){if(!e)return;const s=this.#b,n=s.length;let r=0,i=0,o=1,c=!1,a=0;for(;r<n;){const n=s[r++];if("number"==typeof n)5==n?(i||(i=1),a=s[r],s[r]=a+e*o,c=!1):t&&4==n&&(o=1/s[r],c=!0),r++;else if("string"==typeof n||"function"==typeof n){if(c){s.push(null,null);for(let e=s.length-3;e>=r;e--)s[e+2]=s[e];s[r++]=5,s[r++]=a+e*o}i||(i=2)}}1!=i&&s.unshift(5,e),s.#r+=e,s.#u=null}#m=1;get stretch(){return this.#m}set stretch(e){this.#m=+e,this.#b.#u==this&&(this.#b.#u=null)}stretchBy(e=1,t=!0,s=!1){if(1==e)return;const n=this.#b,r=n.length;let i=0,o=0;for(;i<r;){const r=n[i++];"number"==typeof r?(6==r||7==r&&s?(o||(o=1),n[i]*=e):1==r&&t&&(n[i]*=e),i++):"string"!=typeof r&&"function"!=typeof r||o||(o=2)}1!=o&&(s?n.unshift(7,e,6,e):n.unshift(6,e)),n.#i*=e,s&&(n.#o*=e),n.#f=NaN,n.#u=null}get letterWidth(){return this.#k*this.stretch}set letterWidth(e){this.stretch=e/this.#k}#d=0;get skew(){return this.#d}set skew(e){this.#d=+e,this.#b.#u==this&&(this.#b.#u=null)}skewBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,r=0;for(;n<s;){const s=t[n++];"number"==typeof s?(7==s&&(r||(r=1),t[n]+=e),n++):"string"!=typeof s&&"function"!=typeof s||r||(r=2)}1!=r&&t.unshift(7,e),t.#o+=e,t.#u=null}#w=0;get letterSpacing(){return this.#w}set letterSpacing(e){this.#w=+e,this.#b.#u==this&&(this.#b.#u=null)}spaceBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,r=0;for(;n<s;){const s=t[n++];"number"==typeof s?(8==s&&(r||(r=1),t[n]+=e),n++):"string"!=typeof s&&"function"!=typeof s||r||(r=2)}1!=r&&t.unshift(8,e),t.#c+=e,t.#f=NaN,t.#u=null}#A=0;get curve(){return this.#A}set curve(e){this.#A=+e,this.#b.#u==this&&(this.#b.#u=null)}curveBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,r=0;for(;n<s;){const s=t[n++];"number"==typeof s?(9==s?(r||(r=1),t[n]+=e):1!=s||r||(r=2),n++):"string"!=typeof s&&"function"!=typeof s||r||(r=2)}1!=r&&t.unshift(9,e),t.#a+=e,t.#f=NaN,t.#u=null}#v=h;setTextPass(e,t,s=0,n=0,r=0,i=-.5){const o={n:{0:null},off:r,spr:.5/i,0:null,1:a};if(t)for(let e=0;e<t.length;e++)o[e+2]=o.n[e+1]=t[e];const c=this.#v,l=this.#v=[];let h=0;for(;h<c.length;h+=4){if(!(c[h]<e)){c[h]==e&&(h+=4);break}l.push(c[h],c[h+1],c[h+2],c[h+3])}for(l.push(e,+s,+n,o);h<c.length;)l.push(c[h],c[h+1],c[h+2],c[h+3]),h+=4;this.#b.#u=null}setLinePass(e,n,r=0,i=1){const o={0:t,1:s};for(let e=0;e<n.length;e++)o[e+2]=n[e];const c=this.#v,a=this.#v=[];let l=0;for(;l<c.length;l+=4){if(!(c[l]<e)){c[l]==e&&(l+=4);break}a.push(c[l],c[l+1],c[l+2],c[l+3])}for(a.push(e,o,+r,+i);l<c.length;)a.push(c[l],c[l+1],c[l+2],c[l+3]),l+=4;this.#b.#u=null}unsetPass(e){const t=this.#v,s=this.#v=[];let n=0;for(;n<t.length;n+=4){if(!(t[n]<e)){t[n]==e&&(n+=4);break}s.push(t[n],t[n+1],t[n+2],t[n+3])}for(;n<t.length;)s.push(t[n],t[n+1],t[n+2],t[n+3]),n+=4;this.#b.#u=null}insertTextPass(e,t,s=0,n=0,r=0,i=-.5){const o={n:{0:null},off:r,spr:.5/i,0:null,1:a};if(t)for(let e=0;e<t.length;e++)o[e+2]=o.n[e+1]=t[e];const c=this.#b,h=c.length;let f=0,u=0;for(;f<h;){let t=c[f++];if("number"==typeof t&&t>0)f++;else if("string"==typeof t||"function"==typeof t)u||(u=2);else if(Array.isArray(t)){u||(u=1);const r=c[f-1]=[];let i=0;for(;i<t.length;i+=4){if(!(t[i]<e)){t[i]==e&&(i+=4);break}r.push(t[i],t[i+1],t[i+2],t[i+3])}for(r.push(e,+s,+n,o);i<t.length;)r.push(t[i],t[i+1],t[i+2],t[i+3]),i+=4}}1!=u&&c.unshift(e>0?[0,0,0,l,e,s,n,o]:e<0?[e,s,n,o,0,0,0,l]:[e,s,n,o]),c.#u=null}insertLinePass(e,n,r=0,i=1){const o={0:t,1:s};for(let e=0;e<n.length;e++)o[e+2]=n[e];const c=this.#b,a=c.length;let h=0,f=0;for(;h<a;){let t=c[h++];if("number"==typeof t&&t>0)h++;else if("string"==typeof t||"function"==typeof t)f||(f=2);else if(Array.isArray(t)){f||(f=1);const s=c[h-1]=[];let n=0;for(;n<t.length;n+=4){if(!(t[n]<e)){t[n]==e&&(n+=4);break}s.push(t[n],t[n+1],t[n+2],t[n+3])}for(s.push(e,o,r,i);n<t.length;)s.push(t[n],t[n+1],t[n+2],t[n+3]),n+=4}}1!=f&&c.unshift(e>0?[0,0,0,l,e,o,r,i]:e<0?[e,o,r,i,0,0,0,l]:[e,o,r,i]),c.#u=null}removePass(e){const t=this.#b,s=t.length;let n=0;e:for(;n<s;){let s=t[n++];if("number"==typeof s&&s>0)n++;else if(Array.isArray(s)){let t=0;for(;t<s.length;t+=4){if(s[t]>e)continue e;if(s[t]==e){for(t+=4;t<s.length;)s[t-4]=s[t],s[t-3]=s[t+1],s[t-2]=s[t+2],s[t-1]=s[t+3],t+=4;s.length-=4;break}}}}}get index(){return this.#x}set index(e){this.#x=!!e,this.#b.#u==this&&(this.#b.#u=null)}advance(e=0){const t=this.#b;t.#u!=this&&this.#N(t),t.push(1,+e),t.#f=NaN}#N(e){this.#y!=e.#e&&e.push(e.#e=this.#y),this.#g!=e.#t&&e.push(2,e.#t=this.#g),this.#_!=e.#s&&e.push(3,e.#s=this.#_),this.#k!=e.#n&&e.push(4,e.#n=this.#k),this.#q!=e.#r&&e.push(5,e.#r=this.#q),this.#m!=e.#i&&e.push(6,e.#i=this.#m),this.#d!=e.#o&&e.push(7,e.#o=this.#d),this.#w!=e.#c&&e.push(8,e.#c=this.#w),this.#A!=e.#a&&e.push(9,e.#a=this.#A),this.#v!=e.#l&&(e.push(this.#v),e.#l=this.#v),this.#x!=e.#p&&(e.push(this.#x),e.#p=this.#x),e.#u=this}copy(){const e=this.#b,t=e.slice(),s=t.#u=this.sub();return s.#b=t,t.#e=e.#e,t.#t=e.#t,t.#n=e.#n,t.#r=e.#r,t.#i=e.#i,t.#o=e.#o,t.#c=e.#c,t.#a=e.#a,t.#l=e.#l,t.#p=e.#p,t.#h=e.#h,t.#f=e.#f,s}slice(t=0,s=1/0){const n=this.#b,r=new u;t<0&&(t+=n.#h)<0&&(t=0),s<0&&(s+=n.#h)<0&&(s=0);const i=new e(r);let o=0;if(s<=0){for(;o<n.length;){const e=n[o++];if("number"==typeof e){const t=n[o++];switch(e){case 1:o-=2;break;case 2:i.#g=t;break;case 3:i.#_=t;break;case 4:i.#k=t;break;case 5:i.#q=t;break;case 6:i.#m=t;break;case 7:i.#d=t;break;case 8:i.#w=t;break;case 9:i.#A=t}}else{if("string"==typeof e||"function"==typeof e)break;Array.isArray(e)?"boolean"==typeof e?i.#x=e:i.#v=e:i.#y=e}}return i.#N(r),i}s=s>=t?s-t:0;let c="";for(;t>0&&o<n.length;){const e=n[o++];if("number"==typeof e){const t=n[o++];switch(e){case 2:i.#g=t;break;case 3:i.#_=t;break;case 4:i.#k=t;break;case 5:i.#q=t;break;case 6:i.#m=t;break;case 7:i.#d=t;break;case 8:i.#w=t;break;case 9:i.#A=t}}else if("string"==typeof e){if(!r.#p)continue;if((t-=e.length)<0){c=e.slice(t,(s+=t)+e.length);break}}else Array.isArray(e)?i.#v=e:"object"==typeof e?i.#y=e:"boolean"==typeof e&&(i.#x=e)}for(i.#N(r),c&&(r.push(c),r.#h+=c.length);s>0&&o<n.length;){const e=n[o++];if(r.push(e),"number"==typeof e){const t=n[o++];switch(r.push(t),e){case 2:i.#g=t;break;case 3:i.#_=t;break;case 4:i.#k=t;break;case 5:i.#q=t;break;case 6:i.#m=t;break;case 7:i.#d=t;break;case 8:i.#w=t;break;case 9:i.#A=t}}else if("string"==typeof e){if(!r.#p)continue;s-=e.length,r.#h+=e.length,s<0?(r[r.length-1]=e.slice(0,s),r.#h+=e.length+s):r.#h+=e.length}else Array.isArray(e)?i.#v=e:"object"==typeof e?i.#y=e:"boolean"==typeof e&&(i.#x=e)}return i}trim(e=1/0){const t=this.#b;if(e<0&&(e+=t.#h)<0&&(e=0),e>t.#h)return;let s=0;if(t.#e=null,t.#t=r,t.#n=1,t.#i=1,t.#r=0,t.#o=0,t.#c=0,t.#p=!0,t.#a=0,t.#l=h,t.#h=e<0?0:e)for(;e>0&&s<t.length;){const n=t[s++];if("number"==typeof n){const e=t[s++];switch(n){case 2:t.#t=e;break;case 3:t.#s=e;break;case 4:t.#n=e;break;case 5:t.#r=e;break;case 6:t.#i=e;break;case 7:t.#o=e;break;case 8:t.#c=e;break;case 9:t.#a=e}}else if("string"==typeof n){if(!t.#p)continue;if((e-=n.length)<0){t[s-1]=n.slice(0,e);break}}else Array.isArray(n)?t.#l=n:"object"==typeof n?t.#e=n:"boolean"==typeof n&&(t.#p=n)}else for(;s<t.length;){const e=t[s++];if("number"==typeof e){const n=t[s++];switch(e){case 1:s-=2;break;case 2:t.#t=n;break;case 3:t.#s=n;break;case 4:t.#n=n;break;case 5:t.#r=n;break;case 6:t.#i=n;break;case 7:t.#o=n;break;case 8:t.#c=n;break;case 9:t.#a=n}}else{if("string"==typeof e||"function"==typeof e){s--;break}Array.isArray(e)?t.#l=e:"boolean"==typeof e?t.#p=e:t.#e=e}}this.#y=t.#e,this.#g=t.#t,this.#_=t.#s,this.#k=t.#n,this.#q=t.#r,this.#m=t.#i,this.#d=t.#o,this.#w=t.#c,this.#A=t.#a,this.#v=t.#l,t.length=s,t.#f=NaN}concat(e){const t=this.#b,s=e.#b;t.#h+=s.#h;let i=0;this.#y=null,this.#g=r,this.#_=n,this.#k=1,this.#q=0,this.#m=1,this.#d=0,this.#w=0,this.#A=0,this.#v=h;const o=s.length;e:for(;i<o;){const e=s[i++];if("number"==typeof e){const t=s[i++];switch(e){case 1:i-=2;break e;case 2:this.#g=t;break;case 3:this.#_=t;break;case 4:this.#k=t;break;case 5:this.#q=t;break;case 6:this.#m=t;break;case 7:this.#d=t;break;case 8:this.#w=t;break;case 9:this.#A=t}}else{if("string"==typeof e||"function"==typeof e){i--;break}Array.isArray(e)?this.#v=e:"boolean"==typeof e?this.#x=e:this.#y=e}}for(this.#N(t);i<o;){const e=s[i++];if(t.push(e),"number"==typeof e){const n=s[i++];switch(t.push(n),e){case 2:this.#g=n;break;case 3:this.#_=n;break;case 4:this.#k=n;break;case 5:this.#q=n;break;case 6:this.#m=n;break;case 7:this.#d=n;break;case 8:this.#w=n;break;case 9:this.#A=n}}else"string"==typeof e?t.#p&&(t.#h+=e.length):Array.isArray(e)?this.#v=e:"boolean"==typeof e?this.#x=e:"object"==typeof e&&(this.#y=e)}t.#f=NaN}get length(){return this.#b.#h}set length(e){this.trim(e)}get width(){const e=this.#b;let t=e.#f;if(t==t)return t;t=0;let s=null,n=0,r=1,i=1,o=0,c=0,a=0,l=1,h=-1,f=1;for(;n<e.length;){let u=e[n++];if("number"==typeof u){const s=e[n++];switch(u){case 1:t+=l*s,h=-1;break;case 4:l=(r=s)*i,h=-1;break;case 6:l=(i=s)*r,h=-1;break;case 5:case 7:h=-1;break;case 8:o=s;break;case 9:a=1/s,c=s}}else e:if("string"==typeof u){if(!s)break e;let e=0;for(;e<u.length;){const n=u.codePointAt(e);e+=1+(n>65535);const r=s.get(~n)??s._default;if(!r)continue;const i=(s.get(n+16777216*h)??0)*min(l,f);h=n,f=l;const p=(r.width+o)*l+i;t+=c&&asin(p*c)*a||p,r.tex?.waiting&&r.tex.load()}}else if("object"==typeof u){if(!u){s=null;continue}if(Array.isArray(u))continue;s=u,u.then?.(()=>e.#f=NaN)}}return e.#f=t}add(e){const t=this.#b;t.#u!=this&&this.#N(t),t.#p&&(t.#h+=(e+="").length),t.push(e),t.#f=NaN}addCb(e,t=NaN){if("function"!=typeof e)return;const s=this.#b;s.#u!=this&&this.#N(s),t==t?s.push(e,1,t):s.push(e)}indexAt(e=0,t=.5){t--;const s=this.#b;let n=null,r=0,i=1,o=1,c=0,a=!0,l=0,h=0,f=1,u=-1,p=1,b=0,y=0;for(;r<s.length;){let g=s[r++];if("number"==typeof g){const t=s[r++];switch(g){case 1:e-=f*t,u=-1;break;case 4:f=(i=t)*o,u=-1;break;case 6:f=(o=t)*i,u=-1;break;case 5:case 7:u=-1;break;case 8:c=t;break;case 9:h=1/t,l=t}}else if("string"==typeof g)if(n){let s=0;for(;s<g.length;){const r=g.codePointAt(s),i=1+(r>65535);s+=i;const o=n.get(~r)??n._default;if(!o){a&&(y=b+=i);continue}const _=(n.get(r+16777216*u)??0)*min(f,p);u=r,p=f;const k=(o.width+c)*f+_,m=l&&asin(k*l)*h||k;if(e-=m,a){if(e<=m*t)return y;y=b+=i}}}else a&&(b+=g.length);else if("object"==typeof g){if(!g){n=null;continue}if(Array.isArray(g))continue;n=g}else"boolean"==typeof g&&(a=g)}return y}draw(e){const t=this.#b;let s=null,i=0,o=1,c=1,l=1,f=0,u=0,p=0,b=0,y=0;e.shader=r,e.geometry=n;let g=h,_=3,k=null,m=0,d=!0,w=-1,A=1,v=e.perspective,x=-2*e.pixelRatio(),q=1,N=1,R=1,F=0;e:for(;i<t.length;){let n=t[i++];if("number"==typeof n){const s=t[i++];switch(n){case 1:if(y){u&&e.skew(-u,0);const t=.5/y,n=s*y*2;e.rotate(F),e.translate(sin(n)*t,(1-cos(n))*t),e.rotate(-n),F=0,u&&e.skew(u,0)}else e.translate(s,0);w=-1;continue e;case 4:const t=s*c;c=1/s,e.scale(t),p*=o*=c,b*=o,A*=t,y*=t,o=s,k&&(q=x*o*k.rangeFactor),w=-1;continue e;case 5:p=s*c,b=p*u,w=-1;continue e;case 2:e.shader=s,d=!!s.sdf;break;case 3:e.geometry=s;break;case 6:l=s,w=-1;continue e;case 7:e.skew(s-u,0),u=s,b=p*s,w=-1;continue e;case 8:f=.5*s;continue e;case 9:y=s*o;continue e;default:continue e}}else{if("string"==typeof n){if(!s)continue;let t=0;for(;t<n.length;){const r=n.codePointAt(t);t+=1+(r>65535);const i=s.get(~r)??s._default;if(!i)continue;v&&(x=-2*e.pixelRatio(),q=x*o*k.rangeFactor);const c=(s.get(r+16777216*w)??0)*min(A,l);w=r,A=l;const h=(i.width+f+f)*l+c,P=c-b;y&&(u&&e.skew(-u,0),e.rotate(F+(F=-asin(h*y)||0)),u&&e.skew(u,0));for(let t=0;t<_;t+=4){let s=g[t+1],n=g[t+2]+p,r=g[t+3];if(d||(r=r.n),"object"==typeof s){const t=y*h*(n+m);e.drawRectv(P+t,n+m,h-t-t,r,s)}else if(i.tex){if(r[0]=i.tex,d){a.x=r.off*R;const{spr:e}=r;a.y=(e<0?q:N)*e}e.drawRectv((i.x+f)*l+s+P,i.y+n,i.w*l,i.h,r)}}e.translate(h,0)}continue}if("function"==typeof n){const t=e.sub();F&&(t.skew(-u,0),t.rotate(F),t.skew(u,0)),n(t,k)}else if("object"==typeof n){if(!n){s=null;continue}if(Array.isArray(n)){if(_=(g=n).length,v=!1,e.perspective)for(let e=0;e<_;e+=4)if("object"==typeof g[e+3]&&g[e+3].spr<0){v=!0;break}continue}k=n,m=k.ascend-1,s=n,q=x*o*(N=k.rangeFactor),R=1/N}}}u&&e.skew(-u,0),F&&e.rotate(F),1!=o&&e.scale(c)}break(t=1/0,s=o,n={scale:1,letterSpacing:0,curve:0}){const r=this.#b;let i=!0,a="",l=0;for(;l<r.length;){const e=r[l++];"number"!=typeof e?"boolean"==typeof e?i=e:"string"==typeof e&&i&&(a+=e):l++}const h=[];let p="number"==typeof t?t:"function"==typeof t?t(h.length,n):t[min(h.length,t.length-1)],b=new u,y=b.#u=new e(b),g=0,_="";l=0;let k=null,m=1,d=1,w=-1,A=0,v=!1,x=null,q=-1;for(;l<a.length;){let i=0,o=c,N=b.length,R=A,F=y.#g,P=y.#_,S=y.#k,E=y.#q,L=y.#m,O=y.#d,B=y.#w,W=y.#y,j=y.#A,T=y.#v,C=b.#p,I=b.#h;if(q>=0)o=x,i=q,q=-1;else e:for(;;){if(s)for(o of s){if(o.lastIndex=l,!o.test(a))continue;const e=o.lastIndex-l;l+=e,i?(q=e,x=o,o=c):i=e;break e}if(++i,++l==a.length){o=c;break}}s=o.next??s;const H=o.type;16&H&&(h.push(y),b.#f=v?NaN:A,v=!1,y=y.sub(),y.#b=b=new u,p="number"==typeof t?t:"function"==typeof t?t(h.length,n):t[min(h.length,t.length-1)],N=R=A=I=0,C||b.push(b.#p=!1),y.#N(b));const V=!!(32&H);if(_){let e=_;i<_.length?(e=_.slice(0,i),_=_.slice(i),i=0):(i-=_.length,_=""),V&&b.#e&&b.push(null),e&&b.push(e),b.#p&&(b.#h+=e.length),V&&b.#e&&b.push(b.#e)}for(;i>0;){const e=r[g++];if("number"==typeof e){const t=r[g++];switch(b.push(e,t),e){case 2:y.#g=b.#t=t;break;case 3:y.#_=b.#s=t;break;case 4:y.#k=b.#n=t;break;case 5:y.#q=b.#r=t;break;case 6:y.#m=b.#i=t;break;case 7:y.#d=b.#o=t;break;case 8:y.#w=b.#c=t;break;case 9:y.#A=b.#a=t}}else if("string"==typeof e){if(!b.#e){b.push(e),b.#p&&(b.#h+=e.length);continue}i-=e.length;let t=e;i<0?(t=e.slice(0,i),_=e.slice(i)):_="",V&&b.push(null),b.push(t),b.#p&&(b.#h+=t.length),V&&b.push(b.#e)}else"boolean"==typeof e?b.push(b.#p=e):(b.push(e),Array.isArray(e)?b.#l=y.#v=e:"function"!=typeof e&&(b.#e=y.#y=e))}for(;;){let s=N,r=0,i=0,c=F,a=P,l=S,g=E,_=L,x=O,q=B,V=W,G=T,U=C,K=I,M=j,Y=1/M,D=!1,Q=o.sepL==V&&o.sepA==M&&o.sepS==q?o.sepW:f(o,V,M,q);const $=H?!!(36>>H&1):2*R<p,{scale:z=1,letterSpacing:J=0,curve:X=0}=n;v||=1!=z||0!=J||0!=X;let Z=M+X,ee=q+J;for(X&&(Y=1/Z);s<b.length;){const e=b[s++];if("number"==typeof e){const t=b[s++];switch(e){case 1:if(A+=t,w=-1,A>p-(Q-(k?.get(o.sep.codePointAt()+16777216*w)??0))*m||!$)break;N=s-2,i=0,D=!0,R=A,F=c,P=a,S=l,E=g,L=_,O=x,B=q,W=V,j=M,T=G,C=U,I=K;break;case 2:c=t;break;case 3:a=t;break;case 4:l=t,m=t*_*z;break;case 5:g=t;break;case 6:_=t,m=t*l*z;break;case 7:x=t;break;case 8:q=t,ee=t+J;break;case 9:Z=t+X,Y=1/Z,M=t}}else if("string"==typeof e)if(r=0,k){let t=0;for(;t<e.length;){const n=e.codePointAt(t),h=1+(n>65535);t+=h;const f=k.get(~n)??k._default;if(r+=h,U&&(K+=h),!f)continue;const u=(k.get(n+16777216*w)??0)*min(m,d);d=m,w=n;const b=(f.width+ee)*m+u;A+=Z&&asin(b*Z)*Y||b,A<=p-(Q-(k.get(o.sep.codePointAt()+16777216*n)??0))*m&&$&&(D=!0,N=s-1,i=r,R=A,F=c,P=a,S=l,E=g,L=_,O=x,B=q,W=V,j=M,T=G,C=U,I=K)}}else U&&(K+=e.length);else if(Array.isArray(e))G=e;else if("boolean"==typeof e)U=e;else{if("function"==typeof e)continue;(V=e)?(k=e,Q=o.sepL==e&&o.sepA==M&&o.sepS==q?o.sepW:f(o,e,M,q)):(k=null,Q=0)}}if(!R||A<=p||!N||3==H)break;if(s=N,r=i,c=F,a=P,l=S,g=E,_=L,x=O,q=B,V=W,G=T,U=C,M=j,K=I,6==H||7==H&&p-R>=A-p){const e=(p-R)/(A-R),t=b.length;for(b.splice(s,0,6,e*_),s+=2;s<t;){const t=b[s++];"number"==typeof t&&(6==t&&(b[s]*=e),s++)}b.push(6,_);break}A=R;const te=new u,se=new e(te),ne=b.length;se.#g=c,se.#_=a,se.#k=l,se.#q=g,se.#m=_,se.#d=x,se.#w=q,se.#v=G,se.#A=M,se.#x=U;let re=s+=!!r,ie=V;const oe=4!=H&&5!=H;if(r){se.#y=ie,se.#N(te);const e=b[s-1];b[s-1]=e.slice(0,r),te.push(e.slice(r)),oe?ie=null:te.push(se.#y=te.#e=null)}else{e:for(;re<ne;){const e=b[re++];if("number"==typeof e){const t=b[re++];switch(e){case 1:if(oe){re-=2;break e}break;case 2:se.#g=t;break;case 3:se.#_=t;break;case 4:se.#k=t;break;case 5:se.#q=t;break;case 6:se.#m=t;break;case 7:se.#d=t;break;case 8:se.#w=t;break;case 9:se.#A=t}}else{if("string"==typeof e||"function"==typeof e){re--;break}"boolean"==typeof e?se.#x=e:Array.isArray(e)?se.#v=e:ie=e}}se.#N(te)}if(oe)for(ie&&te.push(se.#y=te.#e=ie);re<ne;)te.push(b[re++]);else for(;re<ne;){const e=b[re++];"number"==typeof e?te.push(e,b[re++]):("object"!=typeof e||Array.isArray(e))&&te.push(e)}te.#h=b.#h-K,b.#h=K,b.#f=v?NaN:A,v=!1,se.#g=te.#t=y.#g,se.#_=te.#s=y.#_,se.#k=te.#n=y.#k,se.#q=te.#r=y.#q,se.#m=te.#i=y.#m,se.#d=te.#o=y.#d,se.#w=te.#c=y.#w,se.#A=te.#a=y.#A,se.#x=te.#p=y.#x,se.#v=te.#l=y.#v,b.length=s,!oe&&ie&&te.push(se.#y=te.#e=ie),D&&(b.#p&&b.push(b.#p=!1),b.push(o.sep)),h.push(y),y=se,b=te,p="number"==typeof t?t:"function"==typeof t?t(h.length,n):t[min(h.length,t.length-1)],N=i=R=A=I=0}8&H&&(h.push(y),b.#f=v?NaN:A,v=!1,A=0,y=y.sub(),y.#b=b=new u,p="number"==typeof t?t:"function"==typeof t?t(h.length,n):t[min(h.length,t.length-1)],y.#N(b))}for(;g<r.length;){const e=r[g++];if(b.push(e),"number"==typeof e){const t=r[g++];switch(b.push(t),e){case 2:y.#g=b.#t=t;break;case 3:y.#_=b.#s=t;break;case 4:y.#k=b.#n=t;break;case 5:y.#q=b.#r=t;break;case 6:y.#m=b.#i=t;break;case 7:y.#d=b.#o=t;break;case 8:y.#w=b.#c=t;break;case 9:y.#A=b.#a=t}}else Array.isArray(e)?y.#v=b.#l=e:"object"==typeof e?y.#y=b.#e=e:"boolean"==typeof e&&(y.#x=b.#p=e)}return b.#f=v?NaN:A,h.push(y),h}toString(){let e="",t=!0,s=0;const n=this.#b,r=n.length;for(;s<r;){const r=n[s++];"number"!=typeof r?"boolean"==typeof r?t=r:"string"==typeof r&&t&&(e+=r):s++}return e}clear(){const e=this.#b;e.#e=null,e.#t=r,e.#s=n,e.#n=1,e.#r=0,e.#i=1,e.#o=0,e.#c=0,e.#a=0,e.#l=h,e.#h=0,e.#f=NaN,e.#u=null,e.#p=!0,e.length=0}static ctor=(t=null)=>{const s=new u;if(!t)return s.#u=new e(s);const n=new e(s);return n.#y=t,n}}}e.RichText=u.public.ctor;const p=Texture(4,6,1,0,Formats.RGBA4).pasteData(Uint8Array.fromHex("ffffffffffffffffffff00000000ffffffff00000000ffffffff00000000ffffffff00000000ffffffffffffffffffff"));class b extends Map{rangeFactor=0;ascend=0;#R=[];_default={x:.05,y:-.0625,w:.5,h:.75,width:.6,tex:p};get then(){return this.#R?this.#F:void 0}#F(e,t){this.#R?.push(e,t)}done(){const e=this.#R;if(this.#R=null,e)for(let t=0;t<e.length;t+=2)e[t]?.(this)}error(e){const t=this.#R;if(this.#R=null,t)for(let s=1;s<t.length;s+=2)t[s]?.(e)}setChar(e=-1,t=0,s=null,n=0,r=0,i=0,o=0){if("string"==typeof e&&(e=e.codePointAt()),"object"==typeof t&&({x:n,y:r,w:i,h:o,width:t,tex:s}=t),e<0){const e=this._default;return s||t?(e.x=+n,e.y=+r,e.w=+i,e.h=+o,e.width=+t,e.tex=s):(e.x=e.y=e.w=e.h=e.width=0,e.tex=null),e}if(s||t){const c={x:+n,y:+r,w:+i,h:+o,width:+t,tex:s};return super.set(~e,c),c}return super.delete(~e),null}getChar(e=-1){return"string"==typeof e&&(e=e.codePointAt()),this.get(~e)??null}getWidth(e=-1){return"string"==typeof e&&(e=e.codePointAt()),(e<0?this._default:this.get(~e)??this._default).width}setKerning(e,t,s=0){"string"==typeof e&&(e=e.codePointAt()),"string"==typeof t&&(t=t.codePointAt()),s?super.set(16777216*e+t,s):super.delete(16777216*e+t)}getKerning(e,t){"string"==typeof e&&(e=e.codePointAt()),"string"==typeof t&&(t=t.codePointAt());const s=this.get(16777216*e+t);return"number"==typeof s?s:0}chlumsky(t,s="atlas.png",n=e.ANISOTROPY|e.SMOOTH,r=1,i=e.Font.defaultFixes){return t.endsWith("/")&&(t+="index.json"),fetch(t).then(e=>(t=e.url,e.json())).then(o=>{const{atlas:{type:c,distanceRange:a,size:l,width:h,height:f},metrics:{ascender:u,descender:p},glyphs:b,kerning:y}=o;this.rangeFactor=a/l;const g=e.Texture.from(new URL(s,t).href,n,c.toLowerCase().endsWith("msdf")?e.Formats.RGB:e.Formats.RG,r);this.ascend=u/(u-p);for(const{unicode1:e,unicode2:t,advance:s}of y)super.set(t+16777216*e,s);for(const{unicode:e,advance:t,planeBounds:s,atlasBounds:n}of b)super.set(~e,s?{x:+s.left,y:+s.bottom,w:s.right-s.left,h:s.top-s.bottom,width:t,tex:g.sub(n.left/h,n.bottom/f,(n.right-n.left)/h,(n.top-n.bottom)/f)}:{x:0,y:0,w:0,h:0,width:t,tex:null});i?.(this),g.then(()=>this.done())},this.error.bind(this)),this}bmfont(t,s=0,n=e.ANISOTROPY|e.SMOOTH,r=1,i=e.Font.defaultFixes){return fetch(t).then(e=>(t=e.url,e.json())).then(o=>{const{chars:c,distanceField:a,pages:l,common:{base:h,lineHeight:f,scaleW:u,scaleH:p},kernings:b}=o,y=1/o.info.size;this.rangeFactor=a.distanceRange/f;const g=this.ascend=h/f,_=l.map(s=>e.Texture.from(new URL(s,t).href,n,a.fieldType.toLowerCase().endsWith("msdf")?e.Formats.RGB:e.Formats.RG,r));for(const{first:e,second:t,amount:s}of b)super.set(t+16777216*e,s/y);for(const{id:e,x:t,y:n,width:r,height:i,xoffset:o,yoffset:a,xadvance:l,page:h}of c)super.set(e,{x:o*y,y:g-(a-s+i)*y,w:r*y,h:i*y,width:l*y,tex:r&&i?_[h].sub(t/u,1-(n+i)/p,r/u,i/p):null});i?.(this),Promise.all(_).then(()=>this.done())},this.error.bind(this)),this}draw(e,t,s=[],n=0,r=-.5,i=0,o=-1){if(this.#R)return;i*=.5,n/=this.rangeFactor;const c=!!e.shader.sdf,l=r<0&&e.perspective&&c;let h=r=1/r;l||(h*=(r<0?-e.pixelRatio():.5)*this.rangeFactor);let f=0;for(;f<t.length;){const u=t.codePointAt(f);f+=1+(u>65535);const p=this.get(~u)??this._default;if(!p)continue;l&&(h=-e.pixelRatio()*this.rangeFactor*r);const b=this.get(u+1114112*o)??0;o=u;const y=p.width+i+i+b;p.tex&&(c?(a.x=n,a.y=h,e.drawRect(p.x+i+b,p.y,p.w,p.h,p.tex,a,...s)):e.drawRect(p.x+i+b,p.y,p.w,p.h,p.tex,...s)),e.translate(y,0)}}measure(e,t=0,s=-1){if(this.#R)return 0;let n=0,r=0;for(;r<e.length;){const i=e.codePointAt(r);r+=1+(i>65535);const o=this.get(~i)??this._default;if(!o)continue;const c=this.get(i+1114112*s)??0;s=i,n+=o.width+t+c}return n}}e.Font=()=>new b,e.Font.bmfont=(e,t)=>(new b).bmfont(e,t),e.Font.chlumsky=(e,t)=>(new b).chlumsky(e,t),e.Font.defaultFixes=e=>{const t=e.getChar(32)??e.setChar(32,.5);e.has(160)||e.setChar(160,t),e.has(9)||e.setChar(9,4*t.width)}};globalThis.BitField??=class t extends Array{constructor(t){if(super(),Array.isArray(t))for(let e=0;e<t.length;e++)this.push(t[e]);else if(t instanceof Uint8Array)for(let e=0;e<t.length;e+=4)this.push(t[e]|t[1|e]<<8|t[2|e]<<16|t[3|e]<<24);else if(t)for(const e of t)this.set(e)}static parse(e){return Array.isArray(e)?Object.setPrototypeOf(e,t.prototype):new t}static decode(e,s=new t){s.length=0;let n=e.v32();for(;n--;)s.push(e.i32())}static encode(t,e){const s=e.length;t.v32(s);for(let e=0;e<s;e++)t.i32(this[e])}static of(...e){const s=new t;for(const t of e)s.set(t);return s}set(t=0){const e=t>>>5;for(;e>=this.length;)this.push(0);this[e]|=1<<(31&t)}unset(t=0){let e=this.length;const s=t>>>5;if(!(s>=e))for(this[s]&=~(1<<(31&t));e&&!this[--e];)super.pop()}setRange(t=0,e=0){if(t>e)return;let s=t>>>5,n=e>>>5,i=e+31>>>5;for(;i>=this.length;)this.push(0);if(s!=n){for(this[s]|=-1<<(31&t);++s<n;)this[s]=-1;(i=31&e)&&(this[n]|=~(-1<<i))}else this[s]|=-1<<(31&t)&~(-1<<(31&e))}unsetRange(t=0,e){if(void 0===e){let e=t+31>>>5;for(;e>0&&!this[e-1];)e--;return this.length=e,void(e&&31&t&&(this[e-1]&=~(-1<<(31&t))))}if(t>e)return;let s=t>>>5,n=e>>>5;if(s>=this.length)return;if(s==n)return void(this[s]&=~(-1<<(31&t))|-1<<(31&e));let i=this.length;for(n<i&&(this[n]&=-1<<(31&e),i=n),this[s]&=~(-1<<(31&t));++s<i;)this[s]=0;if(i==this.length)for(;i&&!this[--i];)super.pop()}anyIn(t=0,e){let s=t>>>5;if(s>=this.length)return!1;if(void 0===e){if(31&t){if(this[s]&-1<<(31&t))return!0;s++}for(;s<this.length;)if(this[s++])return!0;return!1}let n=e>>>5;if(s==n)return!!(this[s]&-1<<(31&t)&~(-1<<(31&e)));if(31&t){if(this[s]&-1<<(31&t))return!0;s++}let i=this.length;if(n<i){if(this[n]&~(-1<<(31&e)))return!0;i=n}for(;++s<i;)if(this[s])return!0;return!1}allIn(t=0,e=0){let s=t>>>5;if(s>=this.length)return!1;let n=e>>>5;if(s==n)return-1==(this[s]|~(-1<<(31&t))|-1<<(31&e));if(31&t){if(~this[s]&-1<<(31&t))return!1;s++}let i=this.length;if(n<i){if(~(this[n]|-1<<(31&e)))return!1;i=n}for(;s<i;)if(~this[s++])return!1;return!0}toggle(t=0){let e=this.length;const s=t>>>5;for(;s>=e;)this.push(0),e++;for(this[s]^=1<<(31&t);e&&!this[--e];)super.pop()}has(t=0){const e=t>>>5;return!(e>=this.length)&&!!(this[e]&1<<(31&t))}pop(t=0){let e=t>>>5;if(e>=this.length)return!1;let s=this[e];if(s^=this[e]=s&~(1<<(31&t)),e==this.length-1)for(;e>=0&&!this[e--];)super.pop();return!!s}put(t=0){let e=t>>>5;for(;e>=this.length;)this.push(0);return!!(this[e]^(this[e]|=1<<(31&t)))}xor(t){let e=this.length;if(e==t.length)for(;e&&this[--e]==t[e];)super.pop();else{let s=e;for(e--;s<t.length;)this.push(t[s++])}for(let s=e;s>=0;s--)this[s]^=t[s]}and(t){let e=this.length;for(this.length>t.length&&(e=this.length=t.length);e&&!(this[--e]&t[e]);)super.pop();for(;e>0;)this[--e]&=t[e]}or(t){let e=this.length-1,s=e;for(;++s<t.length;)this.push(t[s]);for(let s=e;s>=0;s--)this[s]|=t[s]}firstUnset(){let t=-1;for(;++t<this.length;){const e=~this[t];if(e)return t<<5|31-clz32(e&-e)}return t<<5}firstSet(){let t=-1;for(;++t<this.length;)if(this[t])return t<<5|31-clz32(this[t]&-this[t]);return-1}lastSet(){let t=this.length;for(;--t>=0;)if(this[t])return t<<5|31-clz32(this[t]);return-1}popFirst(){let t=-1;for(;++t<this.length;)if(this[t]){let e=31-clz32(this[t]&-this[t]);for(this[t]&=~(1<<e),e|=t<<5,t=this.length;t&&!this[--t];)super.pop();return e}return-1}putFirst(){let t=-1;for(;++t<this.length;){const e=~this[t];if(!e)continue;const s=31-clz32(e&-e);return this[t]|=1<<s,t<<5|s}return this.push(1),t<<5}popLast(){let t=this.length;for(;--t>=0;)if(this[t]){let e=31-Math.clz32(this[t]);for(this[t]&=~(1<<e),e|=t<<5,t=this.length;t&&!this[--t];)super.pop();return e}return-1}clear(){this.length=0}[Symbol.iterator](){const t={value:0,done:!1};let e=0,s=-1;return{[Symbol.iterator](){return this},next:()=>{for(;e<this.length;e++,s=-1){const n=this[e]&s,i=31-clz32(n&-n);if(!(i<0))return s=-2<<i,t.value=e<<5|i,t}return e=1/0,t.done=!0,t}}}iter(t,e=0){let s=-1<<(31&e);for(let n=e>>>5;n<this.length;n++){for(;;){const e=this[n]&s,i=31-clz32(e&-e);if(i<0)break;s=-2<<i,t(n<<5|i)}s=-1}}toUint8Array(){let t=this.length-1,e=this[t],s=0;const n=new Uint8Array(t=(t<<2)+(39-clz32(e)>>3));for(;s<t;s+=4){const t=this[s>>2];n[s]=t,n[1|s]=t>>8,n[2|s]=n>>16,n[3|s]=n>>24}for(s-=4;s<t;)n[s++]=e,e>>=8;return n}};{document.addEventListener("pointerlockchange",()=>{const t=document.pointerLockElement?._ictx;t?((u=t.cursor)&&t.setPointer(0,null),a=t):a&&(u&&(a.setPointer(0,u),u=null),a=null)});const t=function(t=1,e=1,s=1,n=1,i=1){this.playEffect?.("dual-rumble",{duration:1e3*i,strongMagnitude:.5*(e+n),weakMagnitude:.5*(t+s)})??this.pulse?.(.25*(t+e+s+n),1e3*i)};function pollGamepads(){e=!1;const s=new Set;let n=document.activeElement?._ictx;if(n instanceof c)for(const t of n._pointers)t<0&&s.add(~t);else n=null;const i=navigator.getGamepads();let r=[];for(const t of i)"standard"==t?.mapping&&r.push(t);const o=r.length;for(const l of r.length?r:i){if(!l)continue;const i=new h,r=l.vibrationActuator??l.hapticActuators?.[0];i.vibrate=r?t.bind(r):null;for(let t=0;t<l.buttons.length;t++)l.buttons[t].pressed&&i.set(t);for(let t=0;t<l.axes.length;t+=2)i._axes.push({x:l.axes[t],y:o?-l.axes[t+1]:l.axes[t+1]});n&&(n.setGamepad(l.index,i),s.delete(l.index)),e=!0}if(n)for(const t of s)n.setGamepad(t,0);e&&requestAnimationFrame(pollGamepads)}let e=!0;requestAnimationFrame(pollGamepads),window.addEventListener("gamepadconnected",()=>{e||(requestAnimationFrame(pollGamepads),e=!0)});const s={__proto__:null,ContextMenu:93,Help:26,Semicolon:186,Quote:222,BracketLeft:219,BracketRight:221,Backquote:192,Backslash:220,Minus:189,EQUAL:187,IntlRo:193,IntlYen:255,MetaLeft:91,MetaRight:91,PrintScreen:44,ScrollLock:145,Pause:19,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NumLock:144,Clear:10,NumpadComma:110,NumpadDecimal:110,Numpad0:96,Numpad1:97,Numpad2:98,Numpad3:99,Numpad4:100,Numpad5:101,Numpad6:102,Numpad7:103,Numpad8:104,Numpad9:105},n=Object.freeze({LEFT:0,RIGHT:2,MIDDLE:1,BACK:3,FORWARD:4}),i=Object.freeze({A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,can:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,SPACE:32,BACKTICK:192,TAB:9,BACK:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,META:91,METARIGHT:93,CAPSLOCK:20,UP:38,RIGHT:39,DOWN:40,LEFT:37,MOD:navigator.platform.startsWith("Mac")?91:17,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,MINUS:189,EQUAL:187,BR_LEFT:219,BR_RIGHT:221,SEMICOLON:186,APOS:222,BACKSLASH:220,COMMA:188,DOT:190,SLASH:191,PAUSE:19,PAD_ENTER:12,CLEAR:10,HOME:36,END:35,PAGE_UP:33,PAGE_DOWN:34,INS:45,DEL:46,CTX_MENU:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,PAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,PAD_DIV:111,PAD_MULT:106,PAD_SUB:109,PAD_ADD:107,PAD_DOT:110,NUM_LOCK:144,SCROLL_LOCK:145,HELP:26,RO:193,YEN:255,SYSRQ:44,PRINT_SCREEN:44}),r=Object.freeze({A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,UP:12,DOWN:13,LEFT:14,RIGHT:15,MENU:16,LEFT_STICK:0,RIGHT_STICK:1,SELECT:8,START:9});class o{static DEFAULT=0;static HIDDEN=1;constructor(t=null){t?(this.x=+t.x,this.y=+t.y,this.tiltX=+t.tiltX,this.tiltY=+t.tiltY,this.pressure=+t.pressure,this.twist=+t.twist,this.buttons=0|t.buttons,this.setHint=t.setHint):(this.x=0,this.y=0,this.tiltX=0,this.tiltY=0,this.pressure=0,this.twist=0,this.buttons=0,this.setHint=null)}update(t){this.x=+t.x,this.y=+t.y,this.buttons=0|t.buttons,this.tiltX=+t.tiltX,this.tiltY=+t.tiltY,this.pressure=+t.pressure,this.twist=+t.twist,this.setHint=t.setHint}has(t){return!!(this.buttons>>t&1)}anyIn(t=0,e){return!!(this.buttons>>t&("number"==typeof e?~(-1<<e-t):-1))}allIn(t=0,e=0){return-1==(this.buttons>>t|-1<<e-t)}firstUnset(){const t=~this.buttons;return 31-clz32(t&-t)}firstSet(){const t=this.buttons;return 31-clz32(t&-t)}lastSet(){return 31-clz32(this.buttons)}[Symbol.iterator](){const t={value:-1,done:!1};return{[Symbol.iterator](){return this},next:()=>{if(t.done)return t;const e=this.buttons&-1<<t.value+1,s=31-clz32(e&-e);return s>=0?(t.value=s,t):(t.value=-1,t.done=!0,t)}}}iter(t,e=0){for(;;){const s=this.buttons&-1<<e,n=31-clz32(s&-s);if(n<0)break;e=n+1,t(n)}}get pressed(){return!!(1&this.buttons)}}const l=["","none","context-menu","help","pointer","progress","wait","cell","crosshair","text","vertical-text","alias","copy","move","no-drop","not-allowed","grab","grabbing","e-resize","n-resize","ne-resize","nw-resize","s-resize","se-resize","sw-resize","w-resize","ew-resize","ns-resize","nesw-resize","nwse-resize","col-resize","row-resize","all-scroll","zoom-in","zoom-out"];for(let p=2;p<l.length;p++)o[l[p].toUpperCase().replace("-","_")]=p;class h extends BitField{_subscribed=[];constructor(t=null){super(t),t?(this._axes=t._axes.slice(),this.vibrate=t.vibrate):(this._axes=[],this.vibrate=null)}update(t){const e=min(this.length,t.length);for(let s=0;s<e;s++){let e=t[s],n=e^this[s];for(this[s]=e;n;){const t=31-clz32(n&-n);for(const n of this._subscribed)n._fireGamepadButtonUpdate(s<<5|t,!!(e>>t&1));n&=-2<<t}}if(e<t.length)for(let s=e;s<t.length;s++){let e=t[s];for(this.push(e);e;){const t=31-clz32(e&-e);for(const e of this._subscribed)e._fireGamepadButtonUpdate(s<<5|t,!0);e&=-2<<t}}else if(e<this.length){for(let t=e;t<this.length;t++){let e=this[t];for(;e;){const s=31-clz32(e&-e);for(const e of this._subscribed)e._fireGamepadButtonUpdate(t<<5|s,!1);e&=-2<<s}}this.length=e}const s=t._axes,n=this._axes,i=min(s.length,n.length);for(let t=0;t<i;t++){const e=s[t],i=n[t];if(e.x!==i.x||e.y!==i.y){i.x=e.x,i.y=e.y;for(const s of this._subscribed)s._fireGamepadAxisUpdate(t,e.x,e.y)}}if(i<s.length)for(let t=i;t<s.length;t++){const e=s[t];if(n.push(e),0!==e.x||0!==e.y)for(const s of this._subscribed)s._fireGamepadAxisUpdate(t,e.x,e.y)}else if(i<n.length){for(let t=i;t<n.length;t++){const e=n[t];if(0!==e.x||0!==e.y)for(const e of this._subscribed)e._fireGamepadAxisUpdate(t,0,0)}n.length=i}this.vibrate=t.vibrate}axis(t){return this._axes[65535&t]??null}}class c extends BitField{next=null;wheel={x:0,y:0};mouse={x:0,y:0};cursor=null;firstPointer=null;gamepad=null;_pointers=new Map;pointer(t){return(t|=0)>=0?this._pointers.get(t)??null:null}iterPointers(t){for(const{0:e,1:s}of this._pointers)e>=0&&t(e,s)}gamepad(t){return(t=~t)<0?this._pointers.get(t)??null:null}iterGamepads(t){for(const{0:e,1:s}of this._pointers)e<0&&t(~e,s)}#t=[];#e=[];_rpcbs=[];#s=[];_rkcbs=[];_npcbs=[];_ngcbs=[];_dpcbs=[];_dgcbs=[];_kcbs=new Map;reset(){this._kcbs.clear(),this._rkcbs.length=0,this.#t.length=0,this.#e.length=0,this._npcbs.length=this._dpcbs.length=this._rpcbs.length=0,this._ngcbs.length=this._dgcbs.length=this.#s.length=0}clear(){this.reset(),this.clear(),this.wheel.x=this.wheel.y=0,this.mouse.x=this.mouse.y=0,this._pointers.clear()}onWheel(t){this.#t.push(t)}onMouse(t){this.#e.push(t)}onPointerUpdate(t){this._rpcbs.push("function"==typeof t?t:t.setPointer.bind(t))}onGamepadUpdate(t){this.#s.push("function"==typeof t?t:t.setGamepad.bind(t))}onNewPointer(t){this._npcbs.push(t)}onDelPointer(t){this._dpcbs.push(t)}onNewGamepad(t){this._ngcbs.push(t)}onDelGamepad(t){this._dgcbs.push(t)}onKey(t,e){if(Array.isArray(t)){for(const s of t)this.onKey(s,e);return}const s=this._kcbs.get(t&=65535);s?s.push(e):this._kcbs.set(t,[e])}onGamepadButton(t,e){if(Array.isArray(t)){for(const s of t)this.onGamepadButton(s,e);return}const s=this._kcbs.get(t=~(65535&t));s?s.push(e):this._kcbs.set(t,[e])}onGamepadAxis(t,e){if(Array.isArray(t)){for(const s of t)this.onGamepadButton(s,e);return}const s=this._kcbs.get(t=~(65535&t|65536));s?s.push(e):this._kcbs.set(t,[e])}onKeyPress(t,e,s=!1){let n=!1;this.onKey(t,(t,i)=>(n==s&(n=t)===!s&&e(i),s))}onGamepadButtonPress(t,e,s=!1){let n=!1;this.onGamepadButton(t,(t,i)=>(n==s&(n=t)===!s&&e(i),s))}onKeyUpdate(t){this._rkcbs.push("function"==typeof t?t:t.setKey.bind(t))}setKey(t,e=!1,s=!1){t&=65535;let n=this;for(;n;){if(e?n.put(t):n.pop(t)){const s=n._kcbs.get(t);if(s){let i=s.length;for(;i--;)try{const r=s[i](e,t,n);"boolean"==typeof r&&(e=r)}catch(t){Promise.reject(t)}}}else if(!s){n=n.next;continue}let i=n._rkcbs.length;for(;i--;)try{const s=n._rkcbs[i](t,e,n);"boolean"==typeof s&&(e=s)}catch(t){Promise.reject(t)}n=n.next}return e}refireKey(t){this.setKey(t,this.has(t),!0)}_fireGamepadButtonUpdate(t=0,e=!1){const s=this._kcbs.get(~t);if(!s)return;let n=s.length;for(;n--;)try{const i=s[n](e,t,this);"boolean"==typeof i&&(e=i)}catch(t){Promise.reject(t)}}_fireGamepadAxisUpdate(t=0,e=0,s=0){const n=this._kcbs.get(~(65536|t));if(!n)return;let i=n.length;for(;i--;)try{const t=n[i](e,s,this);"object"==typeof t&&(t?(e=+t.x,s=+t.y):e=s=0)}catch(t){Promise.reject(t)}}setPointer(t,e=null,s=!1){if((t|=0)<0)return;let n=this;for(;n;){let i=n._pointers.get(t)??null;if(i)if(e)i.update(e);else{if(n._pointers.delete(t),t||(n.cursor=null),i==this.firstPointer){this.firstPointer=null;for(const{0:t,1:e}of this._pointers)if(t>=0){this.firstPointer=e;break}}let s=n._dpcbs.length;for(;s--;)try{const r=n._dpcbs[s](t,e,i,n);"object"==typeof r&&(e=r)}catch(t){Promise.reject(t)}}else if(e){i=new o(e),t||(n.cursor=i),n.firstPointer??=i,n._pointers.set(t,i);let s=n._npcbs.length;for(;s--;)try{const i=n._npcbs[s](t,e,null,n);"object"==typeof i&&(e=i)}catch(t){Promise.reject(t)}}else if(!s){n=n.next;continue}let r=n._rpcbs.length;for(;r--;)try{const s=n._rpcbs[r](t,e,n);"object"==typeof s&&(e=s)}catch(t){Promise.reject(t)}n=n.next}return e}#n(t){this.gamepad=t,t.iter(t=>this._fireGamepadButtonUpdate(t,!0));const e=t._axes;for(let t=0;t<e.length;t++){const s=e[t];0!==s.x&&0!==s.y&&this._fireGamepadAxisUpdate(t,s.x,s.y)}t._subscribed.push(this)}refirePointer(t){const e=this._pointers.get(t);this.setPointer(t,e?new o(e):null,!0)}refirePointers(){for(const{0:t,1:e}of this._pointers)t>=0&&this.setPointer(t,new o(e),!0)}setGamepad(t,e=null,s=!1){if((t=~t)>=0)return;let n=this;for(;n;){let i=n._pointers.get(t)??null;if(i)if(e)i.update(e);else{if(n._pointers.delete(t),i==this.gamepad){this.gamepad=null;const t=i._subscribed;let e=t.indexOf(this);if(e>=0){for(;e<t.length;)t[e]=t[++e];t.pop()}i.iter(t=>this._fireGamepadButtonUpdate(t,!1));const s=i._axes;for(let t=0;t<s.length;t++){const e=s[t];0!==e.x&&0!==e.y&&this._fireGamepadAxisUpdate(t,0,0)}for(const{0:t,1:e}of this._pointers)if(t<0){this.#n(e);break}}let s=n._dgcbs.length;for(;s--;)try{const r=n._dgcbs[s](t,e,i,n);"object"==typeof r&&(e=r)}catch(t){Promise.reject(t)}}else if(e){i=new h(e),this.gamepad||this.#n(i),n._pointers.set(t,i);let s=n._ngcbs.length;for(;s--;)try{const i=n._ngcbs[s](t,e,null,n);"object"==typeof i&&(e=i)}catch(t){Promise.reject(t)}}else if(!s){n=n.next;continue}let r=this.#s.length;for(;r--;)try{const s=this.#s[r](t,e,n);"object"==typeof s&&(e=s)}catch(t){Promise.reject(t)}n=n.next}return e}refireGamepad(t){const e=this._pointers.get(~t);this.setGamepad(t,e?new h(e):null,!0)}refireGamepads(){for(const{0:t,1:e}of this._pointers)t<0&&this.setGamepad(~t,new h(e),!0)}fireWheel(t=0,e=0){"object"==typeof t&&(e=+t.y,t=+t.x);let s=this;for(;s;){this.wheel.x+=t,this.wheel.y+=e;let n=this.#t.length;for(;n--;)try{const i=this.#t[n](t,e,s);"object"==typeof i&&(i?(t=+i.x,e=+i.y):t=e=0)}catch(t){Promise.reject(t)}s=s.next}return{x:t,y:e}}fireMouse(t=0,e=0){"object"==typeof t&&(e=+t.y,t=+t.x);let s=this;for(;s;){this.mouse.x+=t,this.mouse.y+=e;let n=this.#e.length;for(;n--;)try{const i=this.#e[n](t,e,s);"object"==typeof i&&(i?(t=+i.x,e=+i.y):t=e=0)}catch(t){Promise.reject(t)}s=s.next}return{x:t,y:e}}clearDeltas(){this.mouse.x=this.mouse.y=this.wheel.x=this.wheel.y=0}}let u=null,a=null;const f=[];Gamma.input=(t,e=t.canvas)=>{if(e._ictx)return;t.MOUSE=n,t.KEY=i,t.GAMEPAD=r,t.PointerState=o,t.GamepadState=h;const a="undefined"!=typeof ApplePaySession&&!("letterSpacing"in CanvasRenderingContext2D.prototype),p=navigator.platform.startsWith("Linux")||"undefined"!=typeof netscape||a?void 0:{unadjustedMovement:!0};Object.defineProperty(t,"pointerLock",{get:()=>document.pointerLockElement==e,set:t=>{t?document.pointerLockElement!==e&&e.requestPointerLock(p)?.catch(t=>null):document.pointerLockElement===e&&document.exitPointerLock()}}),Object.defineProperty(t,"fullscreen",{get:()=>document.fullscreenElement==e,set:t=>{t?document.fullscreenElement!==e&&e.requestFullscreen()?.catch(t=>null):document.fullscreenElement===e&&document.exitFullscreen()}});const d=t.ictx=e._ictx=new c;t.InputContext=()=>new c,e.style.outline="none",e.style.touchAction="none",e.style.setProperty("-webkit-tap-highlight-color","transparent"),e.tabIndex=0;let m=!1;e.addEventListener("mousedown",t=>{document.activeElement?._ictx!=d&&e.focus(),t.preventDefault(),d.setKey(t.button,!0)}),e.addEventListener("mouseup",t=>{t.preventDefault(),d.setKey(t.button,!1)}),e.addEventListener("contextmenu",t=>t.preventDefault()),e.addEventListener("wheel",t=>{t.preventDefault(),d.fireWheel(t.wheelDeltaX,t.wheelDeltaY)},{passive:!1});let g=NaN,b=NaN;e.addEventListener("mousemove",t=>{t.preventDefault();let s=0,n=0;try{if(document.pointerLockElement==e)if(s=t.movementX,n=t.movementY,a){const{width:t,height:i}=e.getBoundingClientRect();s*=devicePixelRatio*e.offsetWidth/t,n*=devicePixelRatio*e.offsetHeight/i}else p||(s*=devicePixelRatio,n*=devicePixelRatio);else{if(g!=g)return;s=t.offsetX-g,n=t.offsetY-b}}finally{g=t.offsetX,b=t.offsetY}d.fireMouse(s,-n)});let _=0,y=0;t.onFlush(()=>{_!==y&&(e.style.cursor="number"==typeof _?l[_]:`url(${CSS.escape(_)})`,y=_)});let x=null,P=0;const A=new BitField,E=t=>{const n=s[t.code]??t.keyCode;if(t.repeat)return A.has(n);x=null;let i=d.setKey(n,!0);return x&&P==n?(document.activeElement!=x&&(m=!0,x.focus(),m=!1),i=!0):document.activeElement!=e&&(i=!1),i?A.set(n):A.unset(n),i},v=t=>{const n=s[t.code]??t.keyCode;x=null;let i=d.setKey(n,!1);return x&&P==~n?(document.activeElement!=x&&(m=!0,x.focus(),m=!1),i=!0):document.activeElement!=e&&(i=!1),A.unset(n),i},w=t=>{if(!m){d.iter(t=>d.setKey(t,!1));for(const t of d._pointers.keys())t<0&&d.setGamepad(~t,null)}},L=t=>{t._ictx=d,t.addEventListener("keydown",E),t.addEventListener("keyup",v),t.addEventListener("blur",w)};L(e),t.captureKeyEvent=(t,e=0,s=!1)=>{(e|=0)<0||(t._ictx||L(t),x=t,P=e^-!s)},t.setFocused=(t=null)=>{t?t._ictx||L(t):t=e,m=!0,t.focus(),m=!1};const N=t=>{_=t},U=t=>{if(-1==t.pointerId)return;const s=new o;s.x=t.offsetX/e.offsetWidth,s.y=1-t.offsetY/e.offsetHeight,s.buttons=t.buttons,s.pressure=t.pressure,s.tiltX=.017453292519943295*t.tiltX,s.tiltY=.017453292519943295*t.tiltY,s.twist=.017453292519943295*t.twist;let n=0;if("mouse"==t.pointerType){if(s.setHint=N,document.pointerLockElement==e)return void(u=s)}else n=f.indexOf(t.pointerId)+1,n||(n=f.push(t.pointerId));e._ictx.setPointer(n,s)};e.addEventListener("pointerover",U),e.addEventListener("pointerdown",U),e.addEventListener("pointermove",U),e.addEventListener("pointerup",U),e.addEventListener("pointerleave",t=>{if(-1==t.pointerId)return;let s=0;if("mouse"!=t.pointerType){if(s=f.indexOf(t.pointerId)+1,!s)return;if(s==f.length){let t=f.length-1;do{f.pop()}while(t&&!f[--t])}else f[s-1]=null}else if(document.pointerLockElement==e)return void(u=null);d.setPointer(s,null)}),e.addEventListener("touchend",t=>t.preventDefault())}}{const $=globalThis;Math.PI2??=2*Math.PI,Math.HALF_SQRT3??=.8660254037844386,Math.clamp??=(t,s,r)=>t<s?s:t>r?r:t;const{clz32:t,cos:s,sin:r,min:o,round:u}=Math;if(!("setImmediate"in $)){let t=0,s=0,r=[],n=new MessageChannel;n.port1.onmessage=()=>{const n=r[s];r[s++]=null,s>3&&s>r.length>>1&&(r.splice(0,s),t+=s,s=0),n?.()},n=n.port2,$.setImmediate=(s,...o)=>(n.postMessage(0),r.push(o.length?s.bind(void 0,...o):s),r.length-1+t),$.clearImmediate=i=>{(i-=t)===i>>>0&&(i>=r.length||(r[i]=null))}}if(!("sin"in $)){const t=Object.getOwnPropertyDescriptors(Math);delete t[Symbol.toStringTag],Object.defineProperties($,t)}const p={imageOrientation:"flipY",premultiplyAlpha:"premultiply"},v=(t,s,r)=>"string"==typeof t?fetch(t).then(a=>a.blob()).then(t=>createImageBitmap(t,p)).then(s,r):t instanceof Blob?createImageBitmap(t,p).then(s,r):s(t);$.Gamma=(p=document.createElement("canvas"),$={},g=15)=>{$.flags=g;const _=$.gl=($.canvas=p).getContext("webgl2",{preserveDrawingBuffer:!(8&g),antialias:16&g,depth:!1,premultipliedAlpha:4&g,stencil:1&g,alpha:2&g});_.pixelStorei(37440,1),_.stencilMask(1),_.clearStencil(0),_.pixelStorei(3317,1),_.pixelStorei(3333,1);const A=_.getExtension("EXT_clip_control");A?.clipControlEXT(36001,37727);const R=_.createBuffer();_.bindBuffer(35052,R);let G=!0,E=null,T=-1,L=!1,B=302024719,$s=null,$v=null,N=0,F=0,$u=0,S=null,$X=0,$x=0,j=5,I=0,P=4,$p=null,O=0;_.bindFramebuffer(36008,_.createFramebuffer());const C=_.createFramebuffer(),$M=_.createBuffer();_.bindBuffer(34962,$M);const U=o(32,_.getParameter(34930)),D=[];for(let i=U<<1;i-- >0;)D.push(null);Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NEVER:48,UNSET:64,SET:128,FLIP:192,IF_CLOSER:512,IF_FURTHER:1024,DEPTH_NEVER:1536,DEPTH:256,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:104,RGB_DST:8,ONE_MINUS_DST:121,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,ADD:9,RGB_ADD:1,A_ADD:8,SUB:45,RGB_SUB:5,A_SUB:40,SUB_REV:54,RGB_SUB_REV:6,A_SUB_REV:48,MIN:18,RGB_MIN:2,A_MIN:16,MAX:27,RGB_MAX:3,A_MAX:24,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:28,FTEXTURE:29,ITEXTURE:30,UTEXTURE:31,COLOR:12,FCOLOR:13,ICOLOR:14,UCOLOR:15,FLAT:64,CW_ONLY:16,CCW_ONLY:32,ANISOTROPY:128,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0}),$.Formats={R:[33321,6403,5121,0],RG:[33323,33319,5121,0],RGB:[32849,6407,5121,0],RGBA:[32856,6408,5121,0],RGB565:[36194,6407,33635,0],R11F_G11F_B10F:[35898,6407,35899,0],RGB5_A1:[32855,6408,32820,0],RGB10_A2:[32857,6408,33640,0],RGBA4:[32854,6408,32819,0],RGB9_E5:[35901,6407,35902,0],R8:[33330,36244,5121,-2147447584],RG8:[33336,33320,5121,-2147447584],RGB8:[36221,36248,5121,-2147447584],RGBA8:[36220,36249,5121,-2147447584],R16:[33332,36244,5123,-2147447584],RG16:[33338,33320,5123,-2147447584],RGB16:[36215,36248,5123,-2147447584],RGBA16:[36214,36249,5123,-2147447584],R32:[33334,36244,5125,-2147447584],RG32:[33340,33320,5125,-2147447584],RGB32:[36209,36248,5125,-2147447584],RGBA32:[36208,36249,5125,-2147447584],R16F:[33325,6403,5131,0],RG16F:[33327,33319,5131,0],RGB16F:[34843,6407,5131,0],RGBA16F:[34842,6408,5131,0],R16F_32F:[33325,6403,5126,0],RG16F_32F:[33327,33319,5126,0],RGB16F_32F:[34843,6407,5126,0],RGBA16F_32F:[34842,6408,5126,0],R32F:[33326,6403,5126,0],RG32F:[33328,33319,5126,0],RGB32F:[34837,6407,5126,0],RGBA32F:[34836,6408,5126,0],DEPTH32F:[36012,6402,5126,101632],DEPTH32F_STENCIL:[36013,6402,5126,360986],STENCIL:[36168,0,0,298272]},$.vec2=(x=0,y=x)=>({x:x,y:y}),$.vec2.one=$.vec2(1);const M=$.vec2.zero=$.vec2(0);$.vec2.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b}:{x:a.x+b.x,y:a.y+b.y},$.vec2.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y}:{x:a.x-b.x,y:a.y-b.y},$.vec2.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b}:{x:a.x*b.x,y:a.y*b.y},$.vec2.magnitude=a=>sqrt(a.x*a.x+a.y*a.y),$.vec2.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y);return{x:a.x*d,y:a.y*d}},$.vec3=(x=0,y=x,z=x)=>({x:x,y:y,z:z}),$.vec3.one=$.vec3(1);const X=$.vec3.zero=$.vec3(0);$.vec3.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z},$.vec3.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y,z:a-b.z}:{x:a.x-b.x,y:a.y-b.y,z:a.z-b.z},$.vec3.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z},$.vec3.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z),$.vec3.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z);return{x:a.x*d,y:a.y*d,z:a.z*d}},$.vec4=(x=0,y=x,z=x,w=x)=>({x:x,y:y,z:z,w:w}),$.vec4.one=$.vec4(1);const k=$.vec4.zero=$.vec4(0);$.vec4.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b,w:a.w+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z,w:a.w+b.w},$.vec4.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y,z:a-b.z,w:a-b.w}:{x:a.x-b.x,y:a.y-b.y,z:a.z-b.z,w:a.w-b.w},$.vec4.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b,w:a.w*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z,w:a.w*b.w},$.vec4.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w),$.vec4.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w);return{x:a.x*d,y:a.y*d,z:a.z*d,w:a.w*d}};const Y=_.getExtension("EXT_texture_filter_anisotropic")?_.getParameter(34047):0;class $m{get isInteger(){return this.t.f[3]<0}get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get mipmaps(){return this.t.m}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get identity(){return this.t}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,x=0,y=0,w=1,h=1,l=0){this.t=t,this.x=x,this.y=y,this.w=w,this.h=h,this.l=l}get loaded(){return!this.t.src}get usable(){return!this.t.src||(this.t.u||$m.load(this.t),!1)}get then(){return this.t.src?this.#t:null}load(){this.t.u||$m.load(this.t)}sub(x=0,y=0,w=1,h=1,l=this.l){return new $m(this.t,this.x+x*this.w,this.y+y*this.h,this.w*w,this.h*h,l)}super(x=0,y=0,w=1,h=1,l=this.l){const t=this.w/w,s=this.h/h;return new $m(this.t,this.x-x*t,this.y-y*s,t,s,l)}crop(x=0,y=0,w=0,h=0,l=this.l){const{t:t,x:s,y:r,h:n}=this;if(!t.src)return new $m(t,s+x/t.w,r+n-(y+h)/t.h,w/t.w,h/t.h,l);const i=new $m(t,0,0,0,0,l);return t.u||$m.load(t),t.src.push(i=>{i.x=s+x/t.w,i.y=r+n-(y+h)/t.h,i.w=w/t.w,i.h=h/t.h},void 0,i),i}layer(l=this.l){return new $m(this.t,this.x,this.y,this.w,this.h,l)}#t(t,s){"function"!=typeof t&&(t=Function.prototype),this.t.src?(this.t.u||$m.load(this.t),this.t.src.push(t,s,this)):t(this)}static load(t){let s=t.src,r=0;t.src=[];let w=0,h=0;if(t.u=_.createTexture(),262144&t.f[3]){const a=[];for(let i=t.d*t.mips;i>0;i--)a.push({s:0});t.u.s=a}const n=()=>{r=-1,$m.setOptions(t),_.texStorage3D(35866,t.m=1,t.f[0],t.w=w=1,t.h=h=1,t.d),G||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),G=!0),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const s=t.src;t.src=null;for(let i=1;i<s.length;i+=3)s[i]?.(s[i+1])};for(let i=0;i<s.length;i++)v(s[i],u=>{if(r){if(w!=u.width||h!=u.height)return n()}else w=u.width,h=u.height;if(s[i]=u,++r<s.length)return;$m.setOptions(t),_.texStorage3D(35866,t.m=o(t.m,floor(log2(max(w,h)))+1),t.f[0],t.w=w,t.h=h,t.d),G||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),G=!0),_.bindBuffer(35052,null);for(let l=0;l<r;l++)_.texSubImage3D(35866,0,0,0,l,w,h,1,t.f[1],t.f[2],s[l]);_.bindBuffer(35052,R),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const p=t.src;t.src=null;for(let i=0;i<p.length;i+=3)p[i](p[i+2])},n)}paste(t,x=0,y=0,l=0,s=0,r=0,n=0,o=0,u=0,p=0,g=0,A=0){const{t:E}=this;if(E.src)return null;const T=E.f[3];if(t.msaa)return 4194304&T&&t.f[3]==T?(i&&draw(),p=u||t.height,u=o||t.width,S!=C&&(_.bindFramebuffer(36009,S=C),curt=lt=null),15&~B&&(_.colorMask(1,1,1,1),B|=15,lt=null),_.framebufferRenderbuffer(36008,36064,36161,t.u),_.framebufferTextureLayer(36009,36064,E.u,s,l),_.blitFramebuffer(r,n,r+u,n+p,x,y,x+u,y+p,16384,9728),_.framebufferRenderbuffer(36009,36064,36161,null),_.framebufferRenderbuffer(36008,36064,36161,null),this):this;if(298272==T){i&&draw();const{t:v}=t,R=v.f[3];if(!(262144&R))return this;for(S!=C&&(_.bindFramebuffer(36009,S=C),curt=lt=null),64&m?15&~B&&(_.colorMask(1,1,1,1),B|=15,lt=null):1&m&&256&~B&&(_.depthMask(1),B|=256,lt=null);g--;)36128==(65535&R)?_.framebufferRenderbuffer(36008,36128,36161,v.u[A+o++*v.m]):_.framebufferTextureLayer(36009,65535&R,t.u,A,o++),_.framebufferRenderbuffer(36009,36128,36161,E.u[s+l++*E.m]),_.blitFramebuffer(r,n,r+u,n+p,x,y,x+u,y+p,m<<8,9728);return _.framebufferRenderbuffer(36009,65535&T,36161,null),_.framebufferRenderbuffer(36008,65535&R,36161,null),this}if(!(t instanceof $m))return v(t,i=>($m.fakeBind(E),G||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),G=!0),_.bindBuffer(35052,null),_.texSubImage3D(35866,s,x,y,l,i.width,i.height,1,E.f[1],E.f[2],i),_.bindBuffer(35052,R),E.i<0&&_.bindTexture(35866,null),this));const{t:L}=t;if(L.f[3]!=T||L.src||E.u==L.u)return this;for($m.fakeBind(E),u=u||L.w,p=p||L.h,g=g||L.d;g--;)_.framebufferTextureLayer(36008,36064,L.u,A,o++),_.copyTexSubImage3D(35866,s,x,y,l++,r,n,u,p);return _.framebufferRenderbuffer(36008,65535&T,36161,null),E.i<0&&_.bindTexture(35866,null),this}pasteData(t,x=0,y=0,l=0,w=0,h=0,d=0,s=0){const{t:r}=this;return null!==r.src||(w=w||r.w,h=h||r.h,d=d||r.d,$m.fakeBind(r),G&&(_.pixelStorei(37440,0),_.pixelStorei(37441,0),G=!1),_.bufferData(35052,t,35042),_.texSubImage3D(35866,s,x,y,l,w,h,d,r.f[1],r.f[2],0),At+=.25*t.byteLength,r.i<0&&_.bindTexture(35866,null)),this}readData(x=0,y=0,l=0,w=0,h=0,d=0,t=0){const{t:s}=this;return null!==s.src?null:(w=w||s.w,h=h||s.h,d=d||s.d,H(s.f,(r,n,o)=>{let i=0;for(;d--;)_.framebufferTextureLayer(36008,r,s.u,t,l++),_.readPixels(x,y,w,h,n,o,sz*a*i++)}))}delete(){const{t:t}=this;if(t.u){if(Array.isArray(t.u))for(const s of t.u)_.deleteRenderbuffer(s);else _.deleteTexture(t.u);t.u=null,t.d=t.w=t.h=0,t.i>=0&&(D[t.i]=null,t.i=-1)}}static auto(s,i=0){if(s.f[3]>>31!==i)return-2;if(s.i>=0){const t=-2147483648>>>s.i-(U-N&i);if(!(t&(i^F)))return $X|=t,s.i;D[s.i]=null,s.i=-1}s.u||$m.load(s);const r=t(~($X|i^F));if(r>=U)return-1;$X|=-2147483648>>>r;const n=D[i=i?U+r-N:r];return n&&(n.i=-1),_.activeTexture(33984+i),_.bindTexture(35866,(D[i]=s).u),s.i=i}static fakeBind(t){if(t.i>=0)i&&draw(),_.activeTexture(33984+t.i);else{const s=U-1+(N==U&&U);D[s]&&(D[s].t.i=-1),_.activeTexture(33984+s),_.bindTexture(35866,t.u)}}get options(){return this.t.o}static setOptions(t){$m.fakeBind(t);const{o:s}=t;Y&&_.texParameterf(35866,34046,128&s?Y:1),t.f[3]?(_.texParameterf(35866,10240,9728),_.texParameterf(35866,10241,9728)):(_.texParameterf(35866,10240,9728+(1&s)),_.texParameterf(35866,10241,t.m>1?9984+(s>>1&3):9728+(s>>1&1))),_.texParameterf(35866,10242,8&s?10497:16&s?33648:33071),_.texParameterf(35866,10243,32&s?10497:64&s?33648:33071)}set options(t){const{t:s}=this;s.o=t,null===s.src&&($m.setOptions(s),s.i<0&&_.bindTexture(35866,null))}setMipmapRange(t=0,e=65535){const{t:s}=this;null===s.src&&($m.fakeBind(s),_.texParameteri(35866,33082,t),_.texParameteri(35866,33083,e),s.i<0&&_.bindTexture(35866,null))}genMipmaps(){i&&draw();const{t:t}=this;null!==t.src||t.f[3]||($m.fakeBind(t),_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null))}}$m.prototype.msaa=0,$.Drawable=()=>new ht({s:null,p:_.createFramebuffer(),w:0,h:0,m:0,t:[]}),$.Drawable.MAX_TARGETS=_.getParameter(36063),$.Drawable.DRAW_16F=!!_.getExtension("EXT_color_buffer_half_float"),$.Drawable.DRAW_32F=!!_.getExtension("EXT_color_buffer_float"),$.Drawable.BLEND_32F=$.Drawable.DRAW_32F&&!!_.getExtension("EXT_float_blend");let $i=new Float32Array(1024),$I=new Int32Array($i.buffer),i=0;$.Texture=(w=0,h=0,d=1,t=0,f=Formats.RGBA,s=0)=>{if(s=o(s>>>0||1,floor(log2(max(w,h)))+1),w=w>>>0||1,h=h>>>0||1,d=d>>>0||1,298272===f[3]){const r=[];for(let i=d;i>=0;i--){let t=w,s=h;for(;;){const n=_.createRenderbuffer();if(n.s=0,_.bindRenderbuffer(36161,n),r.push(n),_.renderbufferStorage(36161,f[0],t,s),t+s==2)break;t=t+1>>>1,s=s+1>>>1}}return new $m({u:r,i:-1,o:t,f:f,src:void 0,w:w,h:h,d:d,m:s})}{const r={u:_.createTexture(),i:-1,o:t,f:f,src:null,w:w,h:h,d:d,m:s};if(262144&f[3]){const a=[];for(let i=d*s;i>0;i--)a.push({s:0});r.u.s=a}return $m.setOptions(r),_.texStorage3D(35866,s,r.f[0],w,h,d),_.bindTexture(35866,null),new $m(r)}},$.Texture.MAX_WIDTH=$.Texture.MAX_HEIGHT=_.getParameter(3379),$.Texture.MAX_LAYERS=_.getParameter(35071),$.Texture.FILTER_32F=!!_.getExtension("OES_texture_float_linear"),$.Texture.ANISOTROPY=Y;const V=$.Texture.MAX_MSAA=_.getParameter(36183);function Z(){_.deleteRenderbuffer(this.u)}const H=(f,t)=>{i&&draw();let a=f[0],s=33323==a||33338==a||33340==a||33327==a||33328==a||33336==a?2:33321==a||33330==a||33332==a||33334==a||33325==a||33326==a?1:4,r=s<=2?1==s?6403:33319:3==s?6407:6408;36012!=a&&36013!=a||(s=1,r=6402),a=f[2]==5121?1:f[2]==5126||f[2]==5125||f[2]==35899||f[2]==33640||f[2]==35902?4:2,s*=w*h;let n,o=65535&f[3]||36064;return T==s*a?(n=E,T=-1,L=!0):(_.bindBuffer(35051,n=_.createBuffer()),_.bufferData(35051,s*a,35041),s*a>T&&(T=s*a,E=n,L=!0)),t(o,r,f[2]),_.framebufferRenderbuffer(36008,o,36161,null),n!=E&&_.bindBuffer(35051,E),new Promise(t=>{const o=()=>{const $i=1==a?new Uint8Array(s):4==a?f[2]==5126?new Float32Array(s):new Uint32Array(s):new Uint16Array(s);if(n!=E&&_.bindBuffer(35051,n),_.getBufferSubData(35051,0,$i),r==6402)for(let i=$i.length;i--;)$i[i]=1e-19/$i[i];t($i),n!=E&&(s*a>T?(T=s*a,E=n):_.bindBuffer(35051,E)),L=!0};o.sync=_.fenceSync(37143,0),Lt??=o,zt=zt?zt.next=o:o,Nt||(Nt=setInterval(Tt,0))})};function q(x=0,y=0,w=0,h=0){return H(this.f,(t,s,r)=>{w=w||this.width,h=h||this.height,_.framebufferRenderbuffer(36008,t,36161,this.u),_.readPixels(x,y,w,h,s,r,0)})}$.Texture.Surface=(w=0,h=0,t=0,f=Formats.RGBA)=>{t=o(t>>>0,V)||1;const s=_.createRenderbuffer();return 262144&f[3]&&(s.s=0),_.bindRenderbuffer(36161,s),t>1?_.renderbufferStorageMultisample(36161,t,f[0],w,h):_.renderbufferStorage(36161,f[0],w,h),{u:s,width:w,height:h,msaa:t>1?_.getRenderbufferParameter(36161,36011):1,format:f,f:f,delete:Z,readData:q}},$.Texture.from=(t,s=0,r=Formats.RGBA,n=0)=>new $m({u:null,i:-1,o:s,f:r,src:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:t?Array.isArray(t)?t.length:1:0,m:n||1});let W=[];function J(){if(!W.length)return null;let t=1,s=0,r=1,n=0,o=W[0],u=W[1],p=abs(u-.5)<=.5;for(let i=W.length;i;){i-=2;const x=W[i],y=W[i+1];if(!p){let f=((u>=y)-y)/(u-y);abs(f-.5)<=.5&&(f=x+f*(o-x),f<t&&(t=f),f>s&&(s=f))}if(p=abs(y-.5)<=.5,p)x<t&&(t=x),x>s&&(s=x);else{let f=((y>=u)-u)/(y-u);abs(f-.5)<=.5&&(f=o+f*(x-o),f<t&&(t=f),f>s&&(s=f))}o=x,u=y}p=abs(o-.5)<=.5;for(let i=W.length;i;){i-=2;const x=W[i],y=W[i+1];if(!p){let f=((o>=x)-x)/(o-x);abs(f-.5)<=.5&&(f=y+f*(u-y),f<r&&(r=f),f>n&&(n=f))}if(p=abs(x-.5)<=.5,p)y<r&&(r=y),y>n&&(n=y);else{let f=((x>=o)-o)/(x-o);abs(f-.5)<=.5&&(f=u+f*(y-u),f<r&&(r=f),f>n&&(n=f))}o=x,u=y}return W.length=0,s>t&&n>r?{x0:t,y0:r,x1:s,y1:n}:null}function K(){if(!W.length)return null;let t=1,s=0,r=1,n=0,o=W[0],u=W[1],p=W[2];o*=p,u*=p;let m=abs(u-.5)<=.5,v=1,g=0;for(let i=W.length;i;){i-=3;let x=W[i],y=W[i+1],z=W[i+2];x*=z,y*=z;let r=abs(y-.5)<=.5;t:if(z*p>=0){if(!m){let f=((u>=y)-y)/(u-y);abs(f-.5)<=.5&&(f=x+f*(o-x),z>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>g&&(g=f)))}let f;if(r)f=x;else{if(f=((y>=u)-u)/(y-u),!(abs(f-.5)<=.5))break t;f=o+f*(x-o)}z>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>g&&(g=f))}else{if(!r){let f=((u>=y)-u)/(u-y);f>=0&&(f=o+f*(o-x),p>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>g&&(g=f)))}if(r&&(z>=0?(x<t&&(t=x),x>s&&(s=x)):(x<v&&(v=x),x>g&&(g=x))),!m){let f=((y>=u)-y)/(y-u);f>=0&&(f=x+f*(x-o),z>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>g&&(g=f)))}}o=x,u=y,p=z,m=r}t:if(g>=v){if(g<t){s=1;break t}if(v>s){t=0;break t}s=1,t=0}v=1,g=0,m=p>0&&abs(o-.5)<=.5;for(let i=W.length;i;){i-=3;let x=W[i],y=W[i+1],z=W[i+2];x*=z,y*=z;let t=abs(x-.5)<=.5;t:if(z*p>=0){if(!m){let f=((o>=x)-x)/(o-x);abs(f-.5)<=.5&&(f=y+f*(u-y),z>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>g&&(g=f)))}let f;if(t)f=y;else{if(f=((x>=o)-o)/(x-o),!(abs(f-.5)<=.5))break t;f=u+f*(y-u)}z>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>g&&(g=f))}else{if(!t){let f=((o>=x)-o)/(o-x);f>=0&&(f=u+f*(u-y),p>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>g&&(g=f)))}if(t&&(z>=0?(y<r&&(r=y),y>n&&(n=y)):(y<v&&(v=y),y>g&&(g=y))),!m){let f=((x>=o)-x)/(x-o);f>=0&&(f=y+f*(y-u),z>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>g&&(g=f)))}}o=x,u=y,p=z,m=t}t:if(g>=v){if(g<r){n=1;break t}if(v>n){r=0;break t}n=1,r=0}return W.length=0,s>t&&n>r?{x0:t<0?0:t,y0:r<0?0:r,x1:s>1?1:s,y1:n>1?1:n}:null}class Q{constructor(a=1,b=0,c=0,d=1,e=0,f=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f}sub(){return new Q(this.a,this.b,this.c,this.d,this.e,this.f)}subPersp(t=1){return new tt(this.a,this.b,this.c,this.d,this.e,this.f,0,0,t)}sub3d(){return new st(this.a,this.b,this.c,this.d,0,0,this.e,this.f)}sub3dPersp(t=0,s=1){return new it(this.a,this.b,0,this.c,this.d,0,this.e*s,this.f*s,s,this.e*t,this.f*t,t)}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f}project(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y+this.e,y:this.b*x+this.d*y+this.f}}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:((x-=this.e)*d-(y-=this.f)*c)*t,y:(y*a-x*b)*t}}translate(x=0,y=0){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d}=this;this.a=a*n-c*o,this.b=b*n-d*o,this.c=a*o+c*n,this.d=b*o+d*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d;this.a=t*a+r*b,this.b=s*a+n*b,this.c=t*c+r*d,this.d=s*c+n*d,this.e+=t*e+r*f,this.f+=s*e+n*f}skew(x=0,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a+c*y,this.b=b+d*y,this.c=c+a*x,this.d=d+b*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a*x-c*y,this.b=b*x-d*y,this.c=c*x+a*y,this.d=d*x+b*y}box(x=0,y=0,w=1,h=w){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d,this.a*=w,this.b*=w,this.c*=h,this.d*=h}point(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y+this.e,y:this.b*x+this.d*y+this.f}}metric(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y,y:this.b*x+this.d*y}}pointFrom(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:((x-=this.e)*d-(y-=this.f)*c)*t,y:(y*a-x*b)*t}}metricFrom(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:(x*d-y*c)*t,y:(y*a-x*b)*t}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;if(t)for(const{x:x,y:y}of t)W.push(a*x+c*y+e,b*x+d*y+f);else{const t=e+a,s=f+b;W.push(e,f,t,s,t+c,s+d,e+c,f+d)}return J()}}class tt{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i}sub(){return new tt(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}subPersp(t=1){return new tt(this.a,this.b,this.c,this.d,this.e,this.f,this.g*t,this.h*t,this.i*t)}sub3d(){return new it(this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}sub3dPersp(t=0,s=1){return new it(this.a,this.b,this.c,this.d,this.e,this.f,this.g*s,this.h*s,this.i*s,this.g*t,this.h*t,this.i*t)}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i}project(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);let t=this.c*x+this.f*y+this.i;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g)*t,y:(this.b*x+this.e*y+this.h)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);let u=(n*x+(c*d-a*f)*y+(a*e-b*d))*o;return u<=0?{x:NaN,y:NaN}:(u=1/u,{x:(s*x+(f*t-d*i)*y+(d*h-e*t))*o*u,y:(r*x+(a*i-c*t)*y+(b*t-a*h))*o*u})}translate(x=0,y=0){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*n-d*o,this.b=b*n-e*o,this.c=c*n-f*o,this.d=a*o+d*n,this.e=b*o+e*n,this.f=c*o+f*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d,o=this.e,u=this.f;this.a=t*a+n*b,this.b=s*a+o*b,this.c=r*a+u*b,this.d=t*c+n*d,this.e=s*c+o*d,this.f=r*c+u*d,this.g+=t*e+n*f,this.h+=s*e+o*f,this.i+=r*e+u*f}skew(x=0,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a+d*y,this.b=b+e*y,this.c=c+f*y,this.d=d+a*x,this.e=e+b*x,this.f=f+c*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*x-d*y,this.b=b*x-e*y,this.c=c*x-f*y,this.d=a*y+d*x,this.e=b*y+e*x,this.f=c*y+f*x}box(x=0,y=0,w=1,h=w){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h}point(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.d*y+this.g,y:this.b*x+this.e*y+this.h,z:this.c*x+this.f*y+this.i}}metric(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.d*y,y:this.b*x+this.e*y,z:this.c*x+this.f*y}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h,i:i}=this;if(t)for(const{x:x,y:y}of t)W.push(a*x+d*y+s,b*x+e*y+h,1/(c*x+f*y+i));else{const t=s+a,r=h+b,n=i+c;W.push(s,h,1/i,t,r,1/n,t+d,r+e,1/(n+f),s+d,h+e,1/(i+f))}return K()}}class st{constructor(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h}sub(){return new st(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}subPersp(t=0,s=1){return new it(this.a,this.b,0,this.c,this.d,0,this.g*s+this.e,this.h*s+this.f,s,this.g*t,this.h*t,t)}sub2dXY(){return new Q(this.a,this.b,this.c,this.d,this.g,this.h)}sub2dZY(){return new Q(this.e,this.f,this.c,this.d,this.g,this.h)}sub2dXZ(){return new Q(this.a,this.b,this.e,this.f,this.g,this.h)}reset(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h}project(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z+this.j)*t,y:(this.b*x+this.e*y+this.h*z+this.k)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;x-=this.j,y-=this.k;const z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}perspectiveOrigin(){return{x:NaN,y:NaN,z:NaN}}perspectiveRay(t=0,s=0,r=null){return{x:NaN,y:NaN,z:NaN}}translate(x=0,y=0,z=0){this.g+=x*this.a+y*this.c+z*this.e,this.h+=x*this.b+y*this.d+z*this.f}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y,this.e*=z,this.f*=z}rotateXZ(t){let n=r(t),o=s(t);const{a:a,b:b,e:e,f:f}=this;this.a=o*a-n*e,this.e=o*e+n*a,this.b=o*b-n*f,this.f=o*f+n*b}rotateXY(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,d:d}=this;this.a=o*a-n*c,this.c=o*c+n*a,this.b=o*b-n*d,this.d=o*d+n*b}rotateZY(t){let n=r(t),o=s(t);const{c:c,d:d,e:e,f:f}=this;this.e=o*e-n*c,this.c=o*c+n*e,this.f=o*f-n*d,this.d=o*d+n*f}multiplyXZ(x=1,y=0){const{a:a,b:b,e:e,f:f}=this;this.a=x*a-y*e,this.e=x*e+y*a,this.b=x*b-y*f,this.f=x*f+y*b}multiplyXY(x=1,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=x*a-y*c,this.c=x*c+y*a,this.b=x*b-y*d,this.d=x*d+y*b}multiplyZY(x=1,y=0){const{c:c,d:d,e:e,f:f}=this;this.e=x*e-y*c,this.c=x*c+y*e,this.f=x*f-y*d,this.d=x*d+y*f}skewX(t=0,s=0){this.a+=s*this.c+t*this.e,this.b+=s*this.d+t*this.f}skewY(t=0,s=0){this.c+=t*this.a+s*this.e,this.d+=t*this.b+s*this.f}skewZ(t=0,s=0){this.e+=t*this.a+s*this.c,this.f+=t*this.b+s*this.d}skew(t=0,s=0,r=0,n=0,o=0,u=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a+s*c+t*e,this.b=b+s*d+t*f,this.c=c+r*a+n*e,this.d=d+r*b+n*f,this.e=e+o*a+u*c,this.f=f+o*b+u*d}transform(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=this.a,o=this.b,u=this.c,p=this.d,m=this.e,v=this.f;this.a=n*a+u*b+m*c,this.b=o*a+p*b+v*c,this.c=n*d+u*e+m*f,this.d=o*d+p*e+v*f,this.e=n*t+u*h+m*i,this.f=o*t+p*h+v*i,this.g+=n*s+u*r+m*l,this.h+=o*s+p*r+v*l}box(x=0,y=0,z=0,w=1,h=w,d=w){this.g+=x*this.a+y*this.c+z*this.e,this.h+=x*this.b+y*this.d+z*this.f,this.a*=w,this.b*=w,this.c*=h,this.d*=h,this.e*=d,this.f*=d}point(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.c*y+this.e*z+this.g,y:this.b*x+this.d*y+this.f*z+this.h}}metric(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.c*y+this.e*z,y:this.b*x+this.d*y+this.f*z}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h}=this;for(const{x:x,y:y,z:z}of t)W.push(a*x+c*y+e*z+s,b*x+d*y+f*z+h);return J()}}class it{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l}sub(){return new it(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}subPersp(t=0,s=1){return new it(this.a,this.b,this.c,this.d,this.e,this.f,this.j*s+this.g,this.k*s+this.h,this.l*s+this.i,this.j*t,this.k*t,this.l*t)}sub2dXY(){return new tt(this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dZY(){return new tt(this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(){return new tt(this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l}project(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z+this.j)*t,y:(this.b*x+this.e*y+this.h*z+this.k)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;x-=this.j,y-=this.k;const z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}perspectiveOrigin(){const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=this,n=e*i-f*h,o=c*h-b*i,u=b*f-c*e,p=-1/(a*n+d*o+t*u);return{x:(n*s+(t*f-i*d)*r+(d*h-e*t)*l)*p,y:(o*s+(a*i-c*t)*r+(t*b-h*a)*l)*p,z:(u*s+(d*c-f*a)*r+(a*e-b*d)*l)*p}}perspectiveRay(x=0,y=0,t=null){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h,i:i,j:r,k:n,l:l}=this,o=e*i-f*h,u=c*h-b*i,p=b*f-c*e,m=1/(a*o+d*u+s*p),v=s*f-i*d,g=a*i-c*s,A=d*c-f*a,R=d*h-e*s,G=s*b-h*a,E=a*e-b*d;t&&(t.x=-(o*r+v*n+R*l)*m,t.y=-(u*r+g*n+G*l)*m,t.z=-(p*r+A*n+E*l)*m);const z=1-this.l,T=(o*x+v*y+R*z)*m,L=(o*x+v*y+R*z)*m,B=(o*x+v*y+R*z)*m,N=1/sqrt(T*T+L*L+B*B);return{x:T*N,y:L*N,z:B*N}}translate(x=0,y=0,z=0){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y,this.g*=z,this.h*=z,this.i*=z}rotateXZ(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,g:u,h:h,i:i}=this;this.a=o*a-n*u,this.g=o*u+n*a,this.b=o*b-n*h,this.h=o*h+n*b,this.c=o*c-n*i,this.i=o*i+n*c}rotateXY(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=o*a-n*d,this.d=o*d+n*a,this.b=o*b-n*e,this.e=o*e+n*b,this.c=o*c-n*f,this.f=o*f+n*c}rotateZY(t){let n=r(t),o=s(t);const{d:d,e:e,f:f,g:u,h:h,i:i}=this;this.g=o*u-n*d,this.d=o*d+n*u,this.h=o*h-n*e,this.e=o*e+n*h,this.i=o*i-n*f,this.f=o*f+n*i}multiplyXZ(x=1,y=0){const{a:a,b:b,c:c,g:t,h:h,i:i}=this;this.a=x*a-y*t,this.g=x*t+y*a,this.b=x*b-y*h,this.h=x*h+y*b,this.c=x*c-y*i,this.i=x*i+y*c}multiplyXY(x=1,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=x*a-y*d,this.d=x*d+y*a,this.b=x*b-y*e,this.e=x*e+y*b,this.c=x*c-y*f,this.f=x*f+y*c}multiplyZY(x=1,y=0){const{d:d,e:e,f:f,g:t,h:h,i:i}=this;this.g=x*t-y*d,this.d=x*d+y*t,this.h=x*h-y*e,this.e=x*e+y*h,this.i=x*i-y*f,this.f=x*f+y*i}skewX(t=0,s=0){this.a+=s*this.d+t*this.g,this.b+=s*this.e+t*this.h,this.c+=s*this.f+t*this.i}skewY(t=0,s=0){this.d+=t*this.a+s*this.g,this.e+=t*this.b+s*this.h,this.f+=t*this.c+s*this.i}skewZ(t=0,s=0){this.g+=t*this.a+s*this.d,this.h+=t*this.b+s*this.e,this.i+=t*this.c+s*this.f}skew(t=0,s=0,r=0,n=0,o=0,u=0){const{a:a,b:b,c:c,d:d,e:e,f:f,g:p,h:h,i:i}=this;this.a=a+s*d+t*p,this.b=b+s*e+t*h,this.c=c+s*f+t*i,this.d=d+r*a+n*p,this.e=e+r*b+n*h,this.f=f+r*c+n*i,this.g=p+o*a+u*d,this.h=h+o*b+u*e,this.i=i+o*c+u*f}transform(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=this.a,o=this.b,u=this.c,p=this.d,m=this.e,v=this.f,g=this.g,A=this.h,R=this.i;this.a=n*a+p*b+g*c,this.b=o*a+m*b+A*c,this.c=u*a+v*b+R*c,this.d=n*d+p*e+g*f,this.e=o*d+m*e+A*f,this.f=u*d+v*e+R*f,this.g=n*t+p*h+g*i,this.h=o*t+m*h+A*i,this.i=u*t+v*h+R*i,this.j+=n*s+p*r+g*l,this.k+=o*s+m*r+A*l,this.l+=u*s+v*r+R*l}box(x=0,y=0,z=0,w=1,h=w,d=w){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h,this.g*=d,this.h*=d,this.i*=d}point(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.d*y+this.g*z+this.j,y:this.b*x+this.e*y+this.h*z+this.k,z:this.c*x+this.f*y+this.i*z+this.l}}metric(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.d*y+this.g*z,y:this.b*x+this.e*y+this.h*z,z:this.c*x+this.f*y+this.i*z}}pointFrom(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*(x-=this.j)+(f*t-d*i)*(y-=this.k)+(d*h-e*t)*(z-=this.l))*o,y:(r*x+(a*i-c*t)*y+(b*t-a*h)*z)*o,z:(n*x+(c*d-a*f)*y+(a*e-b*d)*z)*o}}metricFrom(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(f*t-d*i)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(b*t-a*h)*z)*o,z:(n*x+(c*d-a*f)*y+(a*e-b*d)*z)*o}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h,i:i,j:r,k:n,l:l}=this;for(const{x:x,y:y,z:z}of t)W.push(a*x+d*y+s*z+r,b*x+e*y+h*z+n,1/(c*x+f*y+i*z+l));return K()}}$.Transform2D=Q,$.Transform2D.Perspective=tt,$.Transform3D=st,$.Transform3D.Perspective=it;const $G=ArrayBuffer.prototype.transfer?t=>{const s=i;return(i=s+t)>$I.length&&($I=new Int32Array($I.buffer.transfer(8*i)),$i=new Float32Array($I.buffer)),s}:t=>{const s=i;if((i=s+t)>$I.length){const t=$I;($I=new Int32Array(2*i)).set(t,0),$i=new Float32Array($I.buffer)}return s};class ht extends Q{set shader($s){this.$="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,lt==this&&(lt=null)}get shader(){return this.$}get geometry(){return this.S}set geometry(a){this.S=a||xt,lt==this&&(lt=null)}constructor(t,s=324306959,r=xt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.M=s,this.S=r,this.$=n}getTransform(){return new Q(this.a,this.b,this.c,this.d,this.e,this.f)}sub(){return new ht(this.t,this.M,this.S,this.$,this.a,this.b,this.c,this.d,this.e,this.f)}subPersp(){return new et(this.t,this.M,this.S,this.$,this.a,this.b,this.c,this.d,this.e,this.f,0,0,1)}sub3d(){return new rt(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,0,0,this.e,this.f)}sub3dPersp(t=0,s=1){return new nt(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,0,this.c,this.d,0,this.e*s,this.f*s,s,this.e*t,this.f*t,t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.M=t.M,this.$=t.$,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.M=324306959,this.$=$.Shader.DEFAULT,this.S=xt}pixelRatio(){return sqrt(abs(this.a*this.d-this.b*this.c)*this.t.w*this.t.h)}draw(...t){const i=this.$(6,t);$i[i]=this.e,$i[i+1]=this.a,$i[i+2]=this.c,$i[i+3]=this.f,$i[i+4]=this.b,$i[i+5]=this.d}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.$(6,t);$i[i]=this.e+x*this.a+y*this.c,$i[i+1]=this.a*w,$i[i+2]=this.c*h,$i[i+3]=this.f+x*this.b+y*this.d,$i[i+4]=this.b*w,$i[i+5]=this.d*h}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.$(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*e+n*f+u,$i[i+1]=s*a+n*b,$i[i+2]=s*c+n*d,$i[i+3]=r*e+o*f+p,$i[i+4]=r*a+o*b,$i[i+5]=r*c+o*d}drawv(t){const i=this.$(6,t);$i[i]=this.e,$i[i+1]=this.a,$i[i+2]=this.c,$i[i+3]=this.f,$i[i+4]=this.b,$i[i+5]=this.d}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.$(6,t);$i[i]=this.e+x*this.a+y*this.c,$i[i+1]=this.a*w,$i[i+2]=this.c*h,$i[i+3]=this.f+x*this.b+y*this.d,$i[i+4]=this.b*w,$i[i+5]=this.d*h}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.$(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*e+n*f+u,$i[i+1]=s*a+n*b,$i[i+2]=s*c+n*d,$i[i+3]=r*e+o*f+p,$i[i+4]=r*a+o*b,$i[i+5]=r*c+o*d}}class et extends tt{set shader($s){this.$="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,lt==this&&(lt=null)}get shader(){return this.$}get geometry(){return this.S}set geometry(a){this.S=a||xt,lt==this&&(lt=null)}constructor(t,s=324306959,r=xt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=0){super(a,b,c,d,e,f,o,h,i),this.t=t,this.M=s,this.S=r,this.$=n}getTransform(){return new tt(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}sub(){return new et(this.t,this.M,this.S,this.$,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}subPersp(){return this.sub()}sub3d(){return new nt(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}sub3dPersp(t=0,s=1){return new nt(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,this.g*s,this.h*s,this.i*s,this.g*t,this.h*t,this.i*t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.M=t.M,this.$=t.$,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.M=324306959,this.$=$.Shader.DEFAULT,this.S=xt}pixelRatio(){const{i:i}=this,t=(this.a*i-this.g*this.c)*(this.e*i-this.h*this.f)-(this.d*i-this.g*this.f)*(this.b*i-this.h*this.c);return sqrt(abs(t)*this.t.w*this.t.h)/(i*i)}draw(...t){const i=this.$(9,t);$i[i]=this.g,$i[i+1]=this.a,$i[i+2]=this.d,$i[i+3]=this.h,$i[i+4]=this.b,$i[i+5]=this.e,$i[i+6]=this.i,$i[i+7]=this.c,$i[i+8]=this.f}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.$(9,t);$i[i]=this.g+x*this.a+y*this.d,$i[i+1]=this.a*w,$i[i+2]=this.d*h,$i[i+3]=this.h+x*this.b+y*this.e,$i[i+4]=this.b*w,$i[i+5]=this.e*h,$i[i+6]=this.i+x*this.c+y*this.f,$i[i+7]=this.c*w,$i[i+8]=this.f*h}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.$(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,m=this.g,v=this.h,g=this.i;$i[i]=s*e+o*f+m,$i[i+1]=s*a+o*b,$i[i+2]=s*c+o*d,$i[i+3]=r*e+u*f+v,$i[i+4]=r*a+u*b,$i[i+5]=r*c+u*d,$i[i+6]=n*e+p*f+g,$i[i+7]=n*a+p*b,$i[i+8]=n*c+p*d}drawv(t){const i=this.$(9,t);$i[i]=this.g,$i[i+1]=this.a,$i[i+2]=this.d,$i[i+3]=this.h,$i[i+4]=this.b,$i[i+5]=this.e,$i[i+6]=this.i,$i[i+7]=this.c,$i[i+8]=this.f}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.$(9,t);$i[i]=this.g+x*this.a+y*this.d,$i[i+1]=this.a*w,$i[i+2]=this.d*h,$i[i+3]=this.h+x*this.b+y*this.e,$i[i+4]=this.b*w,$i[i+5]=this.e*h,$i[i+6]=this.i+x*this.c+y*this.f,$i[i+7]=this.c*w,$i[i+8]=this.f*h}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.$(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,m=this.g,v=this.h,g=this.i;$i[i]=s*e+o*f+m,$i[i+1]=s*a+o*b,$i[i+2]=s*c+o*d,$i[i+3]=r*e+u*f+v,$i[i+4]=r*a+u*b,$i[i+5]=r*c+u*d,$i[i+6]=n*e+p*f+g,$i[i+7]=n*a+p*b,$i[i+8]=n*c+p*d}}class rt extends st{set shader($s){this.$="function"==typeof $s&&!0===$s.three?$s:$.Shader.COLOR_3D_XZ,lt==this&&(lt=null)}get shader(){return this.$}get geometry(){return this.S}set geometry(a){this.S=a||mt,lt==this&&(lt=null)}constructor(t,s=324306959,r=mt,n=$.Shader.COLOR_3D_XZ,a=1,b=0,c=0,d=1,e=0,f=0,o=0,h=0){super(a,b,c,d,e,f,o,h),this.t=t,this.M=s,this.S=r,this.$=n}getTransform(){return new st(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}sub(){return new rt(this.t,this.M,this.S,this.$,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}subPersp(t=0,s=1){return new nt(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,0,this.c,this.d,0,this.g*s+this.e,this.h*s+this.f,s,this.g*t,this.h*t,t)}sub2dXY(){return new ht(this.t,this.M,xt,$.Shader.DEFAULT,this.a,this.b,this.c,this.d,this.g,this.h)}sub2dZY(){return new ht(this.t,this.M,xt,$.Shader.DEFAULT,this.e,this.f,this.c,this.d,this.g,this.h)}sub2dXZ(){return new ht(this.t,this.M,xt,$.Shader.DEFAULT,this.a,this.b,this.e,this.f,this.g,this.h)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.M=t.M,this.$=t.$,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.M=324306959,this.$=$.Shader.COLOR_3D_XZ,this.S=mt}draw(...t){const s=this.$(8,t);$i[s]=this.g,$i[s+1]=this.a,$i[s+2]=this.c,$i[s+3]=this.e,$i[s+4]=this.h,$i[s+5]=this.b,$i[s+6]=this.d,$i[s+7]=this.f}drawCube(x=0,y=0,z=0,t=1,s=1,r=1,...n){const o=this.$(8,n),{a:a,b:b,c:c,d:d,e:e,f:f}=this;$i[o]=this.g+x*a+y*c+z*e,$i[o+1]=a*t,$i[o+2]=c*s,$i[o+3]=e*r,$i[o+4]=this.h+x*b+y*d+z*f,$i[o+5]=b*t,$i[o+6]=d*s,$i[o+7]=f*r}drawMat(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,...n){const o=this.$(8,n),u=this.a,p=this.b,m=this.c,v=this.d,g=this.e,A=this.f;$i[o]=this.g+u*s+m*r+g*l,$i[o+1]=u*a+m*b+g*c,$i[o+2]=u*d+m*e+g*f,$i[o+3]=u*t+m*h+g*i,$i[o+4]=this.h+p*s+v*r+A*l,$i[o+5]=p*a+v*b+A*c,$i[o+6]=p*d+v*e+A*f,$i[o+7]=p*t+v*h+A*i}drawv(t){const s=this.$(8,t);$i[s]=this.g,$i[s+1]=this.a,$i[s+2]=this.c,$i[s+3]=this.e,$i[s+4]=this.h,$i[s+5]=this.b,$i[s+6]=this.d,$i[s+7]=this.f}drawCubev(x=0,y=0,z=0,t=1,s=1,r=1,n){const o=this.$(8,n),{a:a,b:b,c:c,d:d,e:e,f:f}=this;$i[o]=this.g+x*a+y*c+z*e,$i[o+1]=a*t,$i[o+2]=c*s,$i[o+3]=e*r,$i[o+4]=this.h+x*b+y*d+z*f,$i[o+5]=b*t,$i[o+6]=d*s,$i[o+7]=f*r}drawMatv(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,n){const o=this.$(8,n),u=this.a,p=this.b,m=this.c,v=this.d,g=this.e,A=this.f;$i[o]=this.g+u*s+m*r+g*l,$i[o+1]=u*a+m*b+g*c,$i[o+2]=u*d+m*e+g*f,$i[o+3]=u*t+m*h+g*i,$i[o+4]=this.h+p*s+v*r+A*l,$i[o+5]=p*a+v*b+A*c,$i[o+6]=p*d+v*e+A*f,$i[o+7]=p*t+v*h+A*i}}class nt extends it{set shader($s){this.$="function"==typeof $s&&!0===$s.three?$s:$.Shader.COLOR_3D_XZ,lt==this&&(lt=null)}get shader(){return this.$}get geometry(){return this.S}set geometry(a){this.S=a||mt,lt==this&&(lt=null)}constructor(t,s=324306959,r=mt,n=$.Shader.COLOR_3D_XZ,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.M=s,this.S=r,this.$=n}getTransform(){return new it(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}sub(){return new nt(this.t,this.M,this.S,this.$,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}subPersp(t=0,s=1){return new nt(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,this.j*s+this.g,this.k*s+this.h,this.l*s+this.i,this.j*t,this.k*t,this.l*t)}sub2dXY(){return new et(this.t,this.M,xt,$.Shader.DEFAULT,this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dZY(){return new et(this.t,this.M,xt,$.Shader.DEFAULT,this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(){return new et(this.t,this.M,xt,$.Shader.DEFAULT,this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.j=t.j,this.k=t.k,this.l=t.l,this.M=t.M,this.$=t.$,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l,this.M=324306959,this.$=$.Shader.COLOR_3D_XZ,this.S=mt}draw(...t){const s=this.$(12,t);$i[s]=this.j,$i[s+1]=this.a,$i[s+2]=this.d,$i[s+3]=this.g,$i[s+4]=this.k,$i[s+5]=this.b,$i[s+6]=this.e,$i[s+7]=this.h,$i[s+8]=this.l,$i[s+9]=this.c,$i[s+10]=this.f,$i[s+11]=this.i}drawCube(x=0,y=0,z=0,t=1,s=1,r=1,...n){const o=this.$(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=this.j+x*a+y*d+z*u,$i[o+1]=a*t,$i[o+2]=d*s,$i[o+3]=u*r,$i[o+4]=this.k+x*b+y*e+z*h,$i[o+5]=b*t,$i[o+6]=e*s,$i[o+7]=h*r,$i[o+8]=this.l+x*c+y*f+z*i,$i[o+9]=c*t,$i[o+10]=f*s,$i[o+11]=i*r}drawMat(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,...n){const o=this.$(12,n),u=this.a,p=this.b,m=this.c,v=this.d,g=this.e,A=this.f,R=this.g,G=this.h,E=this.i;$i[o]=this.j+u*s+v*r+R*l,$i[o+1]=u*a+v*b+R*c,$i[o+2]=u*d+v*e+R*f,$i[o+3]=u*t+v*h+R*i,$i[o+4]=this.k+p*s+g*r+G*l,$i[o+5]=p*a+g*b+G*c,$i[o+6]=p*d+g*e+G*f,$i[o+7]=p*t+g*h+G*i,$i[o+8]=this.l+m*s+A*r+E*l,$i[o+9]=m*a+A*b+E*c,$i[o+10]=m*d+A*e+E*f,$i[o+11]=m*t+A*h+E*i}drawv(t){const s=this.$(12,t);$i[s]=this.j,$i[s+1]=this.a,$i[s+2]=this.d,$i[s+3]=this.g,$i[s+4]=this.k,$i[s+5]=this.b,$i[s+6]=this.e,$i[s+7]=this.h,$i[s+8]=this.l,$i[s+9]=this.c,$i[s+10]=this.f,$i[s+11]=this.i}drawCubev(x=0,y=0,z=0,t=1,s=1,r=1,n){const o=this.$(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=this.j+x*a+y*d+z*u,$i[o+1]=a*t,$i[o+2]=d*s,$i[o+3]=u*r,$i[o+4]=this.k+x*b+y*e+z*h,$i[o+5]=b*t,$i[o+6]=e*s,$i[o+7]=h*r,$i[o+8]=this.l+x*c+y*f+z*i,$i[o+9]=c*t,$i[o+10]=f*s,$i[o+11]=i*r}drawMatv(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,n){const o=this.$(12,n),u=this.a,p=this.b,m=this.c,v=this.d,g=this.e,A=this.f,R=this.g,G=this.h,E=this.i;$i[o]=this.j+u*s+v*r+R*l,$i[o+1]=u*a+v*b+R*c,$i[o+2]=u*d+v*e+R*f,$i[o+3]=u*t+v*h+R*i,$i[o+4]=this.k+p*s+g*r+G*l,$i[o+5]=p*a+g*b+G*c,$i[o+6]=p*d+g*e+G*f,$i[o+7]=p*t+g*h+G*i,$i[o+8]=this.l+m*s+A*r+E*l,$i[o+9]=m*a+A*b+E*c,$i[o+10]=m*d+A*e+E*f,$i[o+11]=m*t+A*h+E*i}}const ot=t=>{if(t)if(t.msaa)t.delete();else if(t.u){if(Array.isArray(t.u))for(const s of t.u)_.deleteRenderbuffer(s);else _.deleteTexture(t.u);t.u=null,t.d=t.w=t.h=0,t.i>=0&&(D[t.i]=null,t.i=-1)}},x=Object.getOwnPropertyDescriptors({get width(){return this.t.w},get height(){return this.t.h},get identity(){return this.t},set mask(t){this.M=-2048&this.M|2047&t,lt==this&&(lt=null)},get mask(){return 2047&this.M},set blend(b){this.M=2047&this.M|(b||1135889)<<11,lt==this&&(lt=null)},get blend(){return this.M>>11},V(){const{t:t,M:s}=this,r=0|t.s?.s;let d=B^s;if(curt!=t){i&&draw(),curt&&(0|curt.s?.s)==r||(d|=240),S!=t.p&&_.bindFramebuffer(36009,S=t.p),_.viewport(0,0,t.w,t.h);for(const s of t.t)s?.i>=0&&(_.activeTexture(33984+s.i),_.bindTexture(35866,null),D[s.i]=null,s.i=-1);curt=t}if(d){if(i&&draw(),15&d&&_.colorMask(1&s,2&s,4&s,8&s),240&d)if(240&s){240&B||_.enable(2960),_.stencilMask(1<<r),_.stencilFunc(32&s?16&s?512:517:16&s?514:519,255,1<<r);const t=128&s?64&s?5386:7681:64&s?0:7680;_.stencilOp(t,t,t)}else 240&B&&_.disable(2960);if(256&d&&_.depthMask(256&s),1536&d&&(1536&s?(1536&B||_.enable(2929),_.depthFunc(521-3*(s>>9&3))):_.disable(2929)),d>>11){if(s<<1>>12==147473)_.disable(3042);else if(B<<1>>12==147473&&_.enable(3042),2113929216&d&&_.blendEquationSeparate(32773+(s>>25&7),32773+(s>>28&7)),33552384&d){const a=s>>11&15,b=s>>18&15,c=s>>15&7,d=s>>22&7;_.blendFuncSeparate(a+766*(a>1),b+766*(b>1),c+766*(c>1),d+766*(d>1))}-2147483648&d&&(-2147483648&s?_.enable(32926):_.disable(32926))}B=s}lt=this},setTarget(t=0,s=null,l=0,r=0){const{t:n}=this;if(!n.p)return;if(i&&draw(),lt==this&&(lt=null),S!=n.p&&(_.bindFramebuffer(36009,S=n.p),curt=lt=null),t=t+1>>>0,!s){if(!n.w)return;if(!t)return void(n.t[0]&&(_.framebufferRenderbuffer(36009,33306,36161,null),1==n.t.length?n.w=n.h=n.m=n.t.length=0:n.t[0]=null));if(n.t[t]&&(_.framebufferRenderbuffer(36009,36063+t,36161,null),n.t[t]=null,t==n.t.length-1))do{if(n.t.pop(),!t){n.w=n.h=n.m=0;break}}while(!n.t[--t]);return}const o=s.msaa;if(o||(s=s.t),n.t.length<=t){for(n.t.length||(o?(n.w=s.width,n.h=s.height,n.m=o):(n.w=s.w,n.h=s.h,n.m=0));n.t.push(null)<t;);n.t.push(s)}else{n.t[0]&&!t&&_.framebufferRenderbuffer(36009,33306,36161,null),n.t[t]=s;t:{for(let i=t;i--;)if(n.t[i])break t;o?(n.w=s.width,n.h=s.height,n.m=o):(n.w=s.w,n.h=s.h,n.m=0)}}let u=0;t=t?36063+t:65535&(u=s.f[3]),o?(_.framebufferRenderbuffer(36009,t,36161,s.u),u&&(n.s=262144&u?s.u:null)):t==36128?_.framebufferRenderbuffer(36009,t,36161,n.s=s.u[r+l*s.m]):(_.framebufferTextureLayer(36009,t,s.u,r,l),u&&(n.s=262144&u)&&s.u.s[r+l*s.m])},auto(w,h,t=0,...f){const s=this.t,r=f=>f?t?$.Texture.Surface(w,h,t,f):$.Texture(w,h,1,0,f,99):null;if(w==s.w&&h==s.h&&t==s.m){let d=s.t.length-f.length;if(d>0)for(let i=f.length;d--;)ot(s.t[i]),this.setTarget(i++-1,null);else if(d<0)for(let i=s.t.length;d++;)this.setTarget(i-1,r(f[i++]));for(let i=f.length;i--;)s.t[i]?.f!=f[i]&&(ot(s.t[i]),this.setTarget(i-1,r(f[i])))}else{for(const t of s.t)ot(t);this.clearTargets();let i=-1;if(t>=0)for(const s of f)this.setTarget(i++,$.Texture.Surface(w,h,t,s));else for(const t of f)this.setTarget(i++,$.Texture(w,h,1,0,t,99))}const a=s.t.slice(1);return a[-1]=s.t[0],a},clearTargets(){const{t:t}=this;if(t.p&&t.t.length){i&&draw(),lt==this&&(lt=null),t.t[0]&&_.framebufferRenderbuffer(36009,33306,36161,null),t.w=t.h=t.m=0,S!=t.p&&(_.bindFramebuffer(36009,S=t.p),curt=lt=null);for(let b=t.t.length;--b;)_.framebufferRenderbuffer(36009,b?36064+b:33306,36161,null);t.s=null,t.t.length=0}},clear(t,s,b,a,d=1/0,r=!0){"object"==typeof t?(d=s??1/0,r=b??!0,a=t.w??0,b=t.z??0,s=t.y,t=t.x):(t??=0,s??=t,b??=t,a??=t),i&&draw(),lt!==this&&(this.V(),lt=null),15&B&&_.clearColor(t,s,b,a),256&B&&_.clearDepth(1e-19/d);const n=r?this.t.s:null;if(n){const t=n.s=n.s+1&7;_.clear(t?16640:(_.stencilMask(255),17664)),_.stencilMask(1<<t)}else _.clear(16640);vt++},clearStencil(){i&&draw(),lt!==this&&(this.V(),lt=null);const t=this.t.s,s=t?t.s=t.s+1&7:1;s||(_.stencilMask(255),_.clear(1024),vt++),_.stencilMask(1<<s)},delete(){i&&draw();const{t:t}=this;t.p&&(_.deleteFramebuffer(t.p),S==t.p&&(_.bindFramebuffer(36009,S=null),lt=null))},perspective:!1});Object.defineProperties(ht.prototype,x),Object.defineProperties(nt.prototype,x),Object.defineProperties(et.prototype,x),Object.defineProperties(rt.prototype,x),ht.prototype.setTransform=Q.prototype.reset,nt.prototype.setTransform=it.prototype.reset,et.prototype.setTransform=tt.prototype.reset,rt.prototype.setTransform=st.prototype.reset,nt.prototype.perspective=et.prototype.perspective=!0,Object.assign($.Blend=(t=17,s=9,r=0,n=!1)=>t|r<<7|s<<14|n<<20,{REPLACE:147473,DEFAULT:158353,ADD:149633,MULTIPLY:151808,MULTIPLY_MIX:158440,SUBTRACT:739457,REVERSE_SUBTRACT:1017985,MIN:297105,MAX:444561,BEHIND:149751,INVERT:154105});let lt=null;function draw(b=$x){if(_.bufferData(34962,$I.subarray(0,i),35040),At+=i,i/=$u,vt++,gt+=i,O?_.drawElementsInstanced(7&j,P,O,I,i):_.drawArraysInstanced(7&j,I,P,i),i=0,$X=b,Bt.length){Lt??=Bt[0];for(const f of Bt)f.sync=_.fenceSync(37143,0),zt=zt?zt.next=f:f;Bt.length=0}}const ut=(f,t,e)=>{if(e<=t+1)return f(t);const s=t+(e-t>>1);return`if(u<${s}){${ut(f,t,s)}}else{${ut(f,s,e)}}`},at=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"],ct=_.getParameter(34921);function $H(t,s,r,c){$s=t,N=s,F=r,$u=c}function $l(t){_.bindVertexArray($v=t)}const $C=new Float32Array(4),$c=new Int32Array($C.buffer),ft=(t,s,$D=[])=>{s="number"==typeof s?[s]:s||[];let r=0;const n=[],o=[],u=[],p=[],m=[""];let v=2+t,g=0,A=2+t,R=2+t;for(const t of s){if((15&t)>=12)throw"Vertex parameter cannot be a texture";const s=1+(3&t),G=at[3&t|(t>>4&15)<<2],E=t>15;$D[r]??=1==s?0:2==s?M:3==s?X:k,p.push(`${r}:a${r}=$D[${r}]`);const T=(63&t)>13?"$I[i+":"$i[i+";if(1==s)m.push(T+R+"]=a"+r);else for(let t=0;t<s;t++)m.push(T+(R+t)+"]=a"+r+"."+"xyzw"[t]);const L=""+(v>>2),B=3&v,N=3&(v+=s)||4;let F=E?g:A;const S=3&F,j=3&(F+=s)||4;E?g=F:A=F;let I="";if(N<=(B||4)){const t=(v>>2)-(s==4+B);o.push(`layout(location=${ct-1-t})in uvec4 o${t};`)}I=N<=B?`uvec${s}(o${L}.${"xyzw".slice(B,4)},o${v>>2}.${"xyzw".slice(0,N)})`:4==N&&0==B?"v"+L:`o${L}.`+"xyzw".slice(B,N),E||(I=`uintBitsToFloat(${I})`);const P=`GL_${E?"V":"v"}${L}.`;if(j<=(S||4)&&o.push(`${E?"flat out u":"out "}vec4 ${(E?"GL_V":"GL_v")+((F>>2)-(s==4+S))};`),j<=S){const o=(E?"GL_V":"GL_v")+(F>>2),p=`${E?"u":""}vec${s}(${P+"xyzw".slice(S)},${o+"."+"xyzw".slice(0,j)})`;n.push(`${E?"flat in u":"in "}vec4 ${o};\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${p})`:p}\n`),u.push(`${G} t${r}=${I};${P+"xyzw".slice(S)}=t${r}.${"xyzw".slice(0,4-S)};${o}.${"xyzw".slice(0,j)}=t${r}.${"xyzw".slice(4-S,s)};`)}else{const s=P+"xyzw".slice(S,j);n.push(`\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${s})`:s}\n`),u.push(`${P+"xyzw".slice(S,j)}=${I};`)}R+=s,r++}m[0]=`let{i,$i,$I}=this;if((this.i=i+${R})>$i.length){${ArrayBuffer.prototype.transfer?`$I=this.$I=new Int32Array($I.buffer.transfer(i+${R}<<3))`:`const oa=$I;$I=this.$I=new Int32Array(i+${R}<<1);$I.set(oa,0)`};$i=this.$i=new Float32Array($I.buffer)}`,m.push("return i"),g&&(o.push("flat out uvec4 GL_V0;"),n.push("flat in uvec4 GL_V0;"));const G=eval(`(function({${p}}){${m.join(";")}})`);return{three:t,_:G,T:R,fsh:n.join(""),vsh:o.join(""),vshb:u.join("")}};class yt extends Q{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.N=s,this.F=r,this.S=n}sub(t=this.t.I,s=0,r=this.S){return new yt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f)}sub3d(t=this.t.I,s=0,r=this.S){return new bt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,0,0,this.e,this.f)}addPoint(x,y,...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.I++}add(...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.I++}addPointv(x,y,t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.I++}addv(t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.I++}}class pt extends tt{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1){super(a,b,c,d,e,f,o,h,i),this.t=t,this.N=s,this.F=r,this.S=n}sub(t=this.t.I,s=0,r=this.S){return new pt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}sub3d(t=this.t.I,s=0,r=this.S){return new $t(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}addPoint(x,y,...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+this.g,$i[i+1]=x*this.b+y*this.e+this.h,$i[i+2]=x*this.c+y*this.f+this.i,s.I++}add(...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,$i[i+2]=this.i,s.I++}addPointv(x,y,t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+this.g,$i[i+1]=x*this.b+y*this.e+this.h,$i[i+2]=x*this.c+y*this.f+this.i,s.I++}addv(t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,$i[i+2]=this.i,s.I++}}class bt extends st{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=1,e=0,f=0,o=0,h=0){super(a,b,c,d,e,f,o,h),this.t=t,this.N=s,this.F=r,this.S=n}sub(t=this.t.I,s=0,r=this.S){return new bt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}sub2dXY(t=this.t.I,s=0,r=this.S){return new yt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.g,this.h)}sub2dXZ(t=this.t.I,s=0,r=this.S){return new yt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.e,this.f,this.g,this.h)}sub2dZY(t=this.t.I,s=0,r=this.S){return new yt(this.t,t>>>0,s>>>0,63&r,this.e,this.f,this.c,this.d,this.g,this.h)}addPoint(x,y,z,...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+z*this.e+this.g,$i[i+1]=x*this.b+y*this.d+z*this.f+this.h,s.I++}add(...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,s.I++}addPointv(x,y,z,t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+z*this.e+this.g,$i[i+1]=x*this.b+y*this.d+z*this.f+this.h,s.I++}addv(t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,s.I++}}class $t extends it{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.N=s,this.F=r,this.S=n}sub(t=this.t.I,s=0,r=this.S){return new $t(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}sub2dXY(t=this.t.I,s=0,r=this.S){return new pt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(t=this.t.I,s=0,r=this.S){return new pt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}sub2dZY(t=this.t.I,s=0,r=this.S){return new pt(this.t,t>>>0,s>>>0,63&r,this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}addPoint(x,y,z,...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.I++}add(...t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.I++}addPointv(x,y,z,t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.I++}addv(t){const{t:s}=this,i=s._(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.I++}}function $a(t){_.bindBuffer(34962,t.b);const s=ct-(t.T+3>>2);for(let i=ct-1,r=0;i>=s;i--,r+=16)_.enableVertexAttribArray(i),_.vertexAttribIPointer(i,i==s?3&t.T:4,5125,t.T<<2,r);_.enableVertexAttribArray(0),_.enableVertexAttribArray(1),_.vertexAttribDivisor(0,1),_.vertexAttribDivisor(1,1),_.vertexAttribDivisor(2,1),_.bindBuffer(34962,$M)}_.vertexAttrib4f(2,1,0,0,0);const y=Object.getOwnPropertyDescriptors({get size(){return this.t.I},get uploadCount(){return this.t.P},get vertex(){return this.t.vtx},S(){const{t:t}=this;i&&draw(),$p=this;const s=j>>4,r=(j=this.S)>>4;s!=r&&(r?(s||_.enable(2884),_.frontFace(2304+(r>>1))):_.disable(2884)),I=this.N,P=this.F,O=t.O},get end(){return this.N+this.F},set end(a){(a>>>=0)>=this.N?this.F=a-this.N:(this.F=this.N-a,this.N=a),$p==this&&this.S()},get start(){return this.N},set start(a){this.N=a>>>0,$p==this&&(i&&draw(),I=this.N)},get length(){return this.F},set length(a){this.F=a>>>0,$p==this&&(i&&draw(),P=this.F)},get type(){return this.S},set type(a){this.S=63&a,$p==this&&this.S()},get identity(){return this.t},upload(t=null){const{t:s}=this;if($p&&s==$p.t&&i&&draw(),t){let r=0;if(Array.isArray(t)){let s=0;for(const r of t)r>s&&(s=r);const $M=s>254?s>65534?new Uint32Array(t.length):new Uint16Array(t.length):new Uint8Array(t.length);$M.set(t,0),t=$M}r=5121+(262656>>(t.BYTES_PER_ELEMENT<<2)&15),s.O=r,_.bindVertexArray(s.v),_.bindBuffer(34963,s.E??=_.createBuffer()),_.bufferData(34963,t,35044),s.v?s.Ls||(s.Ls=1,$a(s)):_.bindBuffer(34963,null),_.bindVertexArray($v)}else s.v&&(_.bindVertexArray(s.v),s.Ls||(s.Ls=1,$a(s)),s.E&&_.bindBuffer(34963,null),_.bindVertexArray($v)),s.O=0,s.E&&(s.E.delete(),s.E=null);$p&&$p.t==s&&(O=s.O),_.bindBuffer(34962,s.b),_.bufferData(34962,s.$I.subarray(0,s.i),35044),_.bindBuffer(34962,$M),s.$i=_t,s.$I=wt,s.i=0,s.P=this.F=t?t.length:s.I,s.I=0,$p&&s==$p.t&&this.S()},export(){const{t:{$I:$I,i:t}}=this,s=new Uint8Array(4*t);for(let i=0;i<t;i++){const t=4*i,r=$I[i];s[t]=r>>24,s[t+1]=r>>16,s[t+2]=r>>8,s[t+3]=r}return s},import(f){f instanceof ArrayBuffer&&(f=new Uint8Array(f));const{t:t}=this;let{i:i,$I:$I}=t,l=i+(.25*f.length>>>0);if($I.length<l){if(ArrayBuffer.prototype.transfer)$I=t.$I=new Int32Array($I.buffer.transfer(4*l));else{const s=t.$I;$I=t.$I=new Int32Array(l),t.$I.set(s,0)}t.$i=new Float32Array(t.$I.buffer)}let s=0;for(;i<l;)$I[i++]=f[s++]<<24|f[s++]<<16|f[s++]<<8|f[s++];t.i=l},dup(){const{t:t}=this;if(!t.i)return-1;let i=t.i,s=i-t.T,{$I:$I}=t,r=t.i=i+t.T;if($I.length<r){if(ArrayBuffer.prototype.transfer)$I=t.$I=new Int32Array($I.buffer.transfer(8*r));else{const s=t.$I;$I=t.$I=new Int32Array(2*r),t.$I.set(s,0)}t.$i=new Float32Array(t.$I.buffer)}for(;i<r;)$I[i++]=$I[s++];return t.I++}}),_t=new Float32Array,wt=new Int32Array(_t.buffer);Object.defineProperties(yt.prototype,y),Object.defineProperties(pt.prototype,y),Object.defineProperties(bt.prototype,y),Object.defineProperties($t.prototype,y),$.Geometry2D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{_:r,T:n,three:o}=t??$.Geometry2D.Vertex.DEFAULT;if(o)return null;const $i=new Float32Array(16);return new yt({$i:$i,$I:new Int32Array($i.buffer),i:0,vtx:t,b:_.createBuffer(),_:r,T:n,I:0,P:0,v:null,E:null,O:0},0,0,s)},$.Geometry3D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{_:r,T:n,three:o}=t??$.Geometry3D.Vertex.DEFAULT;if(!o)return null;const $i=new Float32Array(16);return new $t({$i:$i,$I:new Int32Array($i.buffer),i:0,vtx:t,b:_.createBuffer(),_:r,T:n,I:0,P:0,v:_.createVertexArray(),L:null,Ls:0,E:null,O:0},0,0,s)},$.Geometry2D.Vertex=ft.bind(null,!1),$.Geometry3D.Vertex=ft.bind(null,!0);const xt=$.Geometry2D.SQUARE=$.Geometry2D($.Geometry2D.Vertex.DEFAULT=ft(!1,[]),5),mt=$.Geometry3D.CUBE=$.Geometry3D($.Geometry3D.Vertex.DEFAULT=ft(!0,[]),21);$.Geometry3D.Vertex.WITH_NORMALS=ft(!0,[$.VEC3]);for(let i=0;i<4;i++)xt.addPoint(1&i,i>>1&1),mt.addPoint(0,1&i,i>>1&1),mt.addPoint(1,1&i,i>>1&1);xt.upload(),mt.upload(new Uint8Array([4,6,0,2,3,6,7,4,5,0,1,3,5,7])),$.Geometry3D.INSIDE_CUBE=mt.sub(0,14,37),$.Geometry3D.XZ_FACE=mt.sub(7,4,21),$.Shader=(t,{params:s,defaults:$D,uniforms:r,uniformDefaults:$U,outputs:p=4,vertex:m=$.Geometry2D.Vertex.DEFAULT,intFrac:v=.5}={})=>{if(s="number"==typeof s?[s]:s||[],r="number"==typeof r?[r]:r||[],$D=void 0!==$D?Array.isArray($D)?[...$D]:[$D]:[],$U=void 0!==$U?Array.isArray($U)?[...$U]:[$U]:[],p="number"==typeof p?[p]:p||[],p.length>Drawable.MAX_TARGETS)throw`Too many shader outputs (Drawable.MAX_TARGETS == ${Drawable.MAX_TARGETS})`;const g=3+m.three,R=[],G=[""],E=[`#version 300 es\nprecision highp float;precision highp int;layout(location=0)in mat3x${g} m;layout(location=${ct-1})in uvec4 o0;out vec4 GL_v0;`],T=[`void main(){gl_Position.xyw=vec${g}(1.,GL_v0.xy${m.three?"z":""}=uintBitsToFloat(o0.xy${m.three?"z":""}))*m;gl_Position.xy=gl_Position.xy*2.-gl_Position.w;gl_Position.z=1e-19;gl_PointSize=1.;`],L=[`#version 300 es\nprecision highp float;precision highp int;in vec4 GL_v0;\n#define color color0\n#define depth (1./gl_FragCoord.w)\n#define setDepth(f) (gl_FragDepth=1e-19/(f))\n#define dGetValue(a,b) (1e-19/fGetColor(a,b).x)\n#define dGetPixel(a,b,c) (1e-19/fGetPixel(a,b,c).x)\n#define pos GL_v0.xy${g>3?"z":""}\n`+p.map((t,i)=>`layout(location=${i})out ${t?16==t||32==t?"u":"lowp ":""}vec4 color${i};`).join(";"),""];A||(L[0]+="void GL_main();void main(){gl_FragDepth=1e-19*gl_FragCoord.w;GL_main();}\n#define main GL_main\n");let B=0,N=0,F=0,S=0;const j=[],I=(t=0)=>{const s=""+(S>>2),r=3&S,n=3&(S+=t)||4;if(n<=(r||4)){const s=(S>>2)-(t==4+r),n=""+s;E.push(`layout(location=${s+3})in uvec4 a${n};flat out uvec4 GL_a${n};`),L.push(`flat in uvec4 GL_a${n};`),T.push(`GL_a${n}=a${n};`)}if(n<=r){let o=`uvec${t}(GL_a${s}.`;for(let i=r;i<4;i++)o+="xyzw"[i];o+=`,GL_a${S>>2}.`;for(let i=0;i<n;i++)o+="xyzw"[i];return o+")"}if(4==n&&0==r)return"GL_a"+s;let o=`GL_a${s}.`;for(let i=r;i<n;i++)o+="xyzw"[i];return o};let P=0;for(const t of s){let s=1+(3&t);(15&t)>=12&&(B|=1<<s-1,(15&t)>13?F++:N++),$D[P]??=1==s?0:2==s?M:3==s?X:t>=28&&t<32?null:k,R.push(`${P}:a${P}=$D[${P}]`);const r=t>13?"$I[j+":"$i[j+",n=S;if(t>=12&&t<16){j.push(`let t${P}=-1;if(a${P}.t){if((t${P}=$m.auto(a${P}.t,${-(8==t)}))==-1){i&&draw(b^$X);t${P}=$m.auto(a${P}.t,${-(8==t)})}t${P}|=a${P}.l<<8}`);const o=I(1),u=I(2),p=I(2);L.push(`${4==t?"lowp ":8==t?"u":"highp "}vec4 param${P}(vec2 uv){int v=int(${o});if(v<0)return vec4(uintBitsToFloat(${u}),uintBitsToFloat(${p}));return ${4==t?"g":8==t?"uG":"fG"}etColor(v&255,vec3(uv*uintBitsToFloat(${p})+uintBitsToFloat(${u}),v>>8));}`),G.push(`$I[j+${n}]=t${P};if(t${P}>=0)$i[j+${n+1}]=a${P}.x,$i[j+${n+2}]=a${P}.y,$i[j+${n+3}]=a${P}.w,$i[j+${n+4}]=a${P}.h;else ${r}${n+1}]=a${P}.x,${r}${n+2}]=a${P}.y,${r}${n+3}]=a${P}.z,${r}${n+4}]=a${P}.w`),s=5}else{t>=28&&t<32&&(j.push(`let q${P}=$m.auto(a${P}.t,${-(t>29)});if(q${P}<0)i&&draw(b^$X),q${P}=$m.auto(a${P}.t,${-(t>29)})`),s=1);const o=I(s);if(L.push(`\n#define param${P} ${t<16?"uintBitsToFloat":t<32?at[3&t|4]:""}(${o})\n`),1==s)G.push(r+n+"]=a"+P);else for(let t=0;t<s;t++)G.push(r+(n+t)+"]=a"+P+"."+"xyzw"[t])}P++}L.push(m.fsh),E.push(m.vsh),T.push(m.vshb),P=0;const O=[],C=[""],D=[],Y=[],V=[];for(const t of r){const s=1+(3&t);if((15&t)>=12&&(B|=1<<s-1,(15&t)>13?F++:N++,n="int"),$U[P]??=1==s?0:2==s?M:3==s?X:t>=28&&t<32?null:k,O.push(`a${P}=$U[${P}]`),t>=28&&t<32)D.push(`_.uniform1i($L[${Y.length}],s${V.length}?$m.auto(s${V.length},${-(t>29)}):-1)`),Y.push("uni"+P),L.push(`uniform ${t>29?"u":""}sampler2DArray uni${P};`),C.push(`s${V.length}=a${P}.t`),V.push(`,s${V.length}=null`);else if(t>=12&&t<16){const s="GL_u"+P,r="GL_U"+P,n="GL_L"+P;D.push(`if(s${V.length})_.uniform1i($L[${Y.length}],$m.auto(s${V.length},${-(t>13)}))`),L.push(t>13?`uniform usampler2DArray ${s};uniform float ${n};uniform uvec4 ${r}; ${14==t?"i":"u"}vec4 uni${P}(vec2 uv){if(${n}<0.)return ${14==t?`ivec4(${r})`:r};return ${14==t?"i":"u"}GetColor(${s},vec3(uv*uintBitsToFloat(${r}.zw)+uintBitsToFloat(${r}.xy),${n}));}`:`uniform sampler2DArray ${s};uniform float ${n};uniform vec4 ${r}; ${12==t?"lowp ":""}vec4 uni${P}(vec2 uv){if(${n}<0.)return ${r};return texture(${s},vec3(uv*${r}.zw+${r}.xy,${n}));}`),C.push(`if(s${V.length}=a${P}.t){_.uniform1f($L[${Y.length+2}],a${P}.l);${t>13?`$C[0]=a${P}.x,$C[1]=a${P}.y,$C[2]=a${P}.w,$C[3]=a${P}.h;_.uniform4ui`:"_.uniform4f"}($L[${Y.length+1}],${t>13?"$c[0],$c[1],$c[2],$c[3]":`a${P}.x,a${P}.y,a${P}.w,a${P}.h`})}else _.uniform1f($L[${Y.length+2}],-1),_.uniform4${t>13?"ui":"f"}($L[${Y.length+1}],a${P}.x,a${P}.y,a${P}.z,a${P}.w)`),Y.push(s,r,n),V.push(`,s${V.length}=null`)}else{L.push(`uniform ${at[3&t|t>>4<<2]} uni${P};`);let r=`_.uniform${s+(t<16?"f":t<32?"i":"ui")}($L[${Y.length}]`;if(Y.push("uni"+P),1==s)r+=",a"+P;else for(let t=0;t<s;t++)r+=",a"+P+"."+"xyzw"[t];C.push(r+")")}P++}if(12+(S+3&-4)+(m.T+3&-4)>ct<<2)throw"Too many shader parameters";if(N+F>16)throw"Shaders cannot use more than 16 textures/colors";Object.freeze($D),Object.freeze($U);const Z=ct-(m.T+3>>2);N=N?F?N+u(v*(U-N-F)):U:0,F=F&&U-N;let H=null,q=`precision highp usampler2DArray; precision ${2&B?"highp":"lowp"} sampler2DArray;`;15&B&&(q+=`uniform sampler2DArray GL_f[${N}];ivec3 textureSize(int u,int l){${ut(i=>`return textureSize(GL_${i<N?"f["+i:"i["+(i-N)}],l);`,0,U)}}\n#define getSize textureSize\n`),12&B&&(q+=`uniform usampler2DArray GL_i[${F}];uvec4 uGetColor(int u,vec3 p){${ut(i=>`return texture(GL_i[${i-U}],p);`,U,2*U-N)}}uvec4 uGetPixel(int u,ivec3 p,int l){${ut(i=>`return texelFetch(GL_i[${i-U}],p,l);`,U,2*U-N)}}uvec4 uGetColor(usampler2DArray u,vec3 p){return texture(u,p);}uvec4 uGetPixel(usampler2DArray u,ivec3 p,int l){return texelFetch(u,p,l);}\n#define iGetColor(a,b) ivec4(uGetColor(a,b))\n#define iGetPixel(a,b,c) ivec4(uGetPixel(a,b,c))\n`),3&B&&(q+=`vec4 fGetColor(int u,vec3 p){${ut(i=>`return texture(GL_f[${i}],p);`,0,N)}}lowp vec4 GL_lp(vec4 x){return x;}vec4 fGetColor(sampler2DArray t,vec3 p){return texture(t,p);}vec4 fGetPixel(sampler2DArray t,ivec3 p,int l){return texelFetch(t,p,l);}vec4 fGetPixel(int u,ivec3 p,int l){${H||ut(i=>`return texelFetch(GL_f[${i}],p,l);`,0,N)}}\n#define getColor(a,b)GL_lp(fGetColor(a,b))\n#define getPixel(a,b,c)GL_lp(fGetPixel(a,b,c))\n`),L[1]=q;const W=32-N&&-1>>>N|0;C[0]=`i&&draw(0);if($s!=s){_.useProgram($P);$H(s,${N},${W},${g>3?S+g*(g-1)+")":`lv==$Q?${S+9}:${S+6});$l(lv)`}}`;const J=Z==ct-1?`_.vertexAttribIPointer(${Z},${3&m.T},5125,${m.T<<2},0)`:`for(let i=${ct-1},j=0;i>=${Z};i--,j+=16){_.vertexAttribIPointer(i,i==${Z}?${3&m.T}:4,5125,${m.T<<2},j)`;G[0]=`sz+=${S};if(lastd!==this){this.V();const sd=$s!=s,{S}=this,_st=S.t;if(sd||sz!=$u){i&&draw(sd?0:$x);$H(s,${N},${W},sz);if(sd)_.useProgram($P),B();${g>3?`}if($v!=_st.v)i&&draw(),$l(_st.v);if(s!=_st.L||sz!=_st.Ls){i&&draw();if(!_st.Ls)$a(_st);$d(sz>${8+S},0,false);_st.L=s;_st.Ls=sz`:`$l(lv=sz>${8+S}?$Q:$q)}if(lv.geo!=_st.b){i&&draw();_.bindBuffer(34962,lv.geo=_st.b);${J};_.bindBuffer(34962,$M);_.bindBuffer(34963,_st.E)`}}if($p!=S)S.S();}let b=$X^$x;`+j.join(";")+`;const k=$G(sz),j=k+sz-${S}`,G.push("return k");const $d=(t=!1,s=0,r=!0)=>{const n=g*(2+t),u=S+n<<2;_.vertexAttribPointer(0,g,5126,!1,u,s),_.vertexAttribPointer(1,g,5126,!1,u,s+(g<<2)),t?(_.enableVertexAttribArray(2),_.vertexAttribPointer(2,g,5126,!1,u,s+(g<<3))):_.disableVertexAttribArray(2);for(let i=0;i<S;i+=4){const t=3+(i>>2);_.enableVertexAttribArray(t),_.vertexAttribIPointer(t,o(4,S-i),5125,u,s+(i+n<<2)),_.vertexAttribDivisor(t,1)}if(r){_.enableVertexAttribArray(0),_.enableVertexAttribArray(1),_.vertexAttribDivisor(0,1),_.vertexAttribDivisor(1,1),_.vertexAttribDivisor(2,1);for(let i=ct-1;i>=Z;i--)_.enableVertexAttribArray(i)}return u>>2};let $q=null,$Q=null;g<4&&(_.bindVertexArray($q=_.createVertexArray()),$q.geo=null,$d(!1),_.bindVertexArray($v=$Q=_.createVertexArray()),$Q.geo=null,$d(!0));const K=eval(`let ${g<4?"lv=$Q":"__"}${V.length?V.join(""):""};const B=function(){${D.join(";")};$x=$X},s=function(sz,{${R}}){${G.join(";")}};s.uniforms=(function(${O}){${C.join(";")};B()});s`),$P=_.createProgram(),Q=_.createShader(35633),f=_.createShader(35632);if(T.push("}"),_.shaderSource(Q,E.join("")+T.join("")),_.compileShader(Q),_.shaderSource(f,L.join("")+"\n"+t),_.compileShader(f),_.attachShader($P,Q),_.attachShader($P,f),H=_.getShaderInfoLog(f))throw"GLSL Error:\n"+H;if(_.linkProgram($P),H=_.getShaderInfoLog(Q))throw"GLSL Error:\n"+E.join("")+T.join("");_.useProgram($P);const $L=Y.map(t=>_.getUniformLocation($P,t));for(let i=0;i<U;i++)_.uniform1i(_.getUniformLocation($P,i<N?"GL_f["+i+"]":"GL_i["+(i-N)+"]"),i>=N?U+i-N:i);return K.vertex=m,K.three=m.three,$s=K};let vt=0,gt=0,At=0;$.Shader.UINT=$.Shader("void main(){color=param0;}",{params:$.UVEC4,outputs:$.UINT}),$.Shader.BLACK=$.Shader("void main(){color=vec4(0,0,0,1);}"),$.Shader.SIMPLE=$.Shader("void main(){color=param0;}",{params:[$.VEC4]}),$.Shader.DEFAULT=$.Shader("void main(){color=param0(pos)*param1;}",{params:[$.COLOR,$.VEC4],defaults:[void 0,$.vec4.one]}),$.Shader.COLOR_3D_XZ=$.Shader("void main(){color=param0(pos.xz);}",{params:[$.COLOR],vertex:Geometry3D.Vertex.DEFAULT}),$.Shader.SHADED_3D=$.Shader("void main(){color=param0(pos.xy);color.rgb*=1.+dot(normalize(cross(dFdx(pos),dFdy(pos))),param1);}",{params:[$.COLOR,$.VEC3],defaults:[void 0,vec3(-.15,-.3,0)],vertex:Geometry3D.Vertex.DEFAULT});let Rt=0;const Gt=[];$.onFlush=f=>Gt.push(f),$.flush=()=>{i&&draw(),L?L=!1:E&&(_.bindBuffer(35051,null),_.deleteBuffer(E),E=null,T=-1);for(let i=0;i<U<<1;i++){const t=D[i];t&&(_.activeTexture(33984+i),_.bindTexture(35866,D[i]=null),t.i=-1)}let t=performance.now();t-Rt>1e3&&(Rt=t,$i=new Float32Array($i.length>>>1),$I=new Int32Array($i.buffer));for(const f of Gt)try{f()}catch(t){Promise.reject(t)}};const Et=$.ctx=new ht(curt={s:{s:0},p:null,w:0,h:0,m:0,t:[]});$.setSize=(w=0,h=0)=>{_.canvas.width=w,_.canvas.height=h,Et.t.w=_.drawingBufferWidth,Et.t.h=_.drawingBufferHeight,curt==Et.t&&(curt=lt=null),Et.t.s.s=0};const Tt=()=>{for(;Lt&&37145==_.getSyncParameter(Lt.sync,37140);)_.deleteSync(Lt.sync),Lt(),Lt=Lt.next;Lt||(zt=null,clearInterval(Nt),Nt=0)};let Lt=null,zt=null;const Bt=[];$.wait=()=>new Promise(t=>{i?(t.sync=null,Bt.push(t)):(t.sync=_.fenceSync(37143,0),Lt??=t,zt=zt?zt.next=t:t),Nt||(Nt=setInterval(Tt,0))});let Nt=0;return $.loop=t=>("t"in $||($.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=.001*performance.now(),$.dt=0,$.frameCpu=0,$.glLost??=null,requestAnimationFrame(function f(){if(requestAnimationFrame(f),_.isContextLost())return $.glLost?.(),$.glLost=Lt=zt=null;i&&draw(),_.bindFramebuffer(36009,S=curt=lt=null),Et.t.s.s=0,dt=max(.001,o(-($.t-($.t=.001*performance.now())),.5)),Et.reset();try{t()}finally{$.flush(),$.frameCpu=.001*performance.now()-$.t,vt||$.ctx.clear(),$.frameDrawCalls=vt,$.frameSprites=gt,$.frameData=4*At+24*vt,vt=gt=At=0}})),$),$},Object.assign($.Gamma,{bitmapOpts:p,STENCIL:1,ALPHA_CHANNEL:2,PREMULTIPLIED_ALPHA:4,AUTO_CLEAR_BUFFER:8,MSAA:16})}{Object.defineProperties(Array.prototype,{best:{enumerable:!1,value(t,i=-1/0){let e;const s=this.length;for(let h=0;h<s;h++){const s=this[h],r=t(s,h,this);r>=i&&(i=r,e=s)}return e}},mmap:{enumerable:!1,value(t){const i=this.length;for(let e=0;e<i;e++)this[e]=t(this[e]);return this}},bind:{enumerable:!1,value(t,i=-1){if((i>>>=0)>=this.length)return this.push(t);let e;for(;i<this.length;)e=this[i],this[i++]=t,t=e;return this.push(e)}},fire:{enumerable:!1,value(...t){for(const i of this)try{i(...t)}catch(t){Promise.reject(t)}}},mapFire:{enumerable:!1,value(...t){const i=[];for(const e of this)try{i.push(e(...t))}catch(t){Promise.reject(t),i.push(void 0)}return i}},remove:{enumerable:!1,value(t){let i=this.indexOf(t);if(i>=0){for(;i<this.length;)this[i]=this[++i];this.pop()}return i}}}),globalThis.TypedArray??=Object.getPrototypeOf(Uint8Array),Uint8Array.fromHex=function(t){const i=new Uint8Array(t.length>>>1);let e=1,s=0;for(let h=0;h<t.length;h++){const r=t.charCodeAt(h);r>47&&r<58?e=e<<4|r-48:r>64&&r<71?e=e<<4|r-55:r>96&&r<103&&(e=e<<4|r-87),256&e&&(i[s++]=e,e=1)}return i.slice(0,s)},Uint16Array.fromHex=function(t){const i=new Uint16Array(t.length>>>2);let e=1,s=0;for(let h=0;h<t.length;h++){const r=t.charCodeAt(h);r>47&&r<58?e=e<<4|r-48:r>64&&r<71?e=e<<4|r-55:r>96&&r<103&&(e=e<<4|r-87),65536&e&&(i[s++]=e,e=1)}return i.slice(0,s)},globalThis.hsla=(t,i,e,s=1)=>{t*=1/30,t%=12,t+=12*(t<0);const h=i*(e<.5?e:1-e);return vec4(max(0,e-h*max(3-abs(t-6),-1)),max(0,e-h*max(3-abs(t+12*(t<4)-10),-1)),max(0,e-h*max(3-abs(t-12*(t>=8)-2),-1)),s)};const t="0123456789abcdef";Number.prototype.toHex=function(){return t[this>>>28]+t[this>>24&15]+t[this>>20&15]+t[this>>16&15]+t[this>>12&15]+t[this>>8&15]+t[this>>4&15]+t[15&this]},Number.formatData=t=>t<512?t.toFixed(0)+"B":t<524288?(t/1024).toFixed(1)+"KiB":t<536870912?(t/1048576).toFixed(1)+"MiB":t<549755813888?(t/1073741824).toFixed(1)+"GiB":(t/1099511627776).toFixed(1)+"TiB",Date.kebab=(t=new Date)=>`${t.getYear()+1900}-${("0"+t.getMonth()).slice(-2)}-${("0"+t.getDate()).slice(-2)}-at-${("0"+t.getHours()).slice(-2)}-${("0"+t.getMinutes()).slice(-2)}-${("0"+t.getSeconds()).slice(-2)}`,globalThis.randint??=Math.randint??=()=>4294967296*Math.random()|0;const i=document.createElement("a");globalThis.download=(t,e=t.name??("@"==t.type[0]?"file":t.type.split("/",1)[0]))=>{i.href=URL.createObjectURL(t),i.download=e,i.click(),URL.revokeObjectURL(i.href)};const{floor:e,trunc:s,fround:h}=Math,r="transfer"in ArrayBuffer.prototype?(t,i=0)=>{t.buf8=new Uint8Array((t.buf=new DataView(t.buf.buffer.transfer(t.cap=(t.cap<<1)+i))).buffer)}:(t,i=0)=>{const e=new Uint8Array(new ArrayBuffer(t.cap=(t.cap<<1)+i));e.set(t.buf8,0),t.buf=new DataView(e.buffer),t.buf8=e};let n=(t,i,e,s)=>(t.encode=i,t.decode=e,t.size=s,t);globalThis.Nanobuf={decoder:new TextDecoder,encoder:new TextEncoder,BufReader:class t extends DataView{constructor(t){t instanceof ArrayBuffer?super(t):super(t.buffer,t.byteOffset,t.byteLength),this.i=this.bitState=0}decode(t,i){return t.decode(this,i)}b1(){let t=this.bitState;if(t<2)try{t=256|this.getUint8(this.i++)}catch{t=256}return this.bitState=t>>1,1&t}b2(){let t=this.bitState;if(t<4)try{t=t&(t=+(t<2))|(256|this.getUint8(this.i++))<<t}catch{t=256<<t}return this.bitState=t>>2,3&t}b4(){let t=this.bitState;if(t<16){let i=-21936>>(t<<1)&3;try{t=t&7>>3-i|(256|this.getUint8(this.i++))<<i}catch{t=256<<i}}return this.bitState=t>>4,15&t}u8(){try{return this.getUint8(this.i++)}catch{return 0}}i8(){try{return this.getInt8(this.i++)}catch{return 0}}u16(){try{return this.getUint16((this.i+=2)-2)}catch{return 0}}i16(){try{return this.getInt16((this.i+=2)-2)}catch{return 0}}u24(){try{return this.getUint8(this.i)<<16|this.getUint16((this.i+=3)-2)}catch{return 0}}i24(){try{return this.getInt8(this.i)<<16|this.getUint16((this.i+=3)-2)}catch{return 0}}u32(){try{return this.getUint32((this.i+=4)-4)}catch{return 0}}i32(){try{return this.getInt32((this.i+=4)-4)}catch{return 0}}u48(){try{return 4294967296*this.getUint16((this.i+=6)-6)+this.getUint32(this.i-4)}catch{return 0}}i48(){try{return 4294967296*this.getInt16((this.i+=6)-6)+this.getUint32(this.i-4)}catch{return 0}}u64(){try{return 4294967296*this.getUint32((this.i+=8)-8)+this.getUint32(this.i-4)}catch{return 0}}i64(){try{return 4294967296*this.getInt32((this.i+=8)-8)+this.getUint32(this.i-4)}catch{return 0}}bu64(){try{return this.getBigUint64((this.i+=8)-8)}catch{return 0}}bi64(){try{return this.getBigInt64((this.i+=8)-8)}catch{return 0}}f32(){try{return this.getFloat32((this.i+=4)-4)}catch{return 0}}f64(){try{return this.getFloat64((this.i+=8)-8)}catch{return 0}}bool(){try{return 0!=this.getUint8(this.i++)}catch{return 0}}v64(){try{const t=this.getUint8(this.i++);return t<64?t:t>=128?4294967296*(2147483647&this.getUint32((this.i+=7)-8))+this.getUint32(this.i-4):t>=96?536870911&this.getUint32((this.i+=3)-4):this.getUint8(this.i++)|t<<8&8191}catch{return 0}}bv64(){try{let t=this.getUint8(this.i++);if(t>=64){if(t>=128)return 0x7FFFFFFFFFFFFFFFn&this.getBigUint64((this.i+=7)-8);t=t>=96?536870911&this.getUint32((this.i+=3)-4):this.getUint8(this.i++)|t<<8&8191}return BigInt(t)}catch{return 0}}v32(){try{const t=this.getUint8(this.i++);return t<64?t:t>=128?2147483647&this.getUint32((this.i+=3)-4):this.getUint8(this.i++)|t<<8&16383}catch{return 0}}v16(){try{const t=this.getUint8(this.i++);return t<128?t:this.getUint8(this.i++)|t<<8&16383}catch{return 0}}skip(t){this.i+=t}u8arr(t=-1){try{let i=this.i;return t<0&&(t=this.getUint8(i++))>=64&&(t>=128?(t=2147483647&this.getUint32(i),i+=3):t=this.getUint8(this.i++)|t<<8&16383),this.i=i+t,new Uint8Array(this.buffer.slice(i+=this.byteOffset,t))}catch{return new Uint8Array}}str(){let t=this.i,i=this.getUint8(t++);return i>=64&&(i>=128?(i=2147483647&this.getUint32(t),t+=3):i=this.getUint8(this.i++)|i<<8&16383),this.i=t+i,decoder.decode(new Uint8Array(this.buffer,this.byteOffset+t,i))}enum({intToStr:t,defaultString:i}){let e=this.getUint8(this.i++);return e>64&&(e=e>=128?2147483647&this.getUint32((this.i+=3)-4):this.getUint8(this.i++)|e<<8&16383),t[e]??i}view(t=0){return new Uint8Array(this.buffer,this.byteOffset+(this.i+=t)-t,t)}get read(){return this.i}get remaining(){return this.byteLength-this.i}get overran(){return this.i>this.byteLength}toUint8Array(){return new Uint8Array(this.buffer,this.byteOffset+this.i,this.byteLength-this.i)}copyReadToArrayBuffer(){return this.buffer.slice(this.byteOffset,this.byteOffset+this.i)}copyRemainingToArrayBuffer(){return this.buffer.slice(this.byteOffset+this.i,this.byteOffset+this.byteLength)}copyToWriter(){return new BufWriter(this.buffer.slice(this.byteOffset,this.byteOffset+this.i),this.i)}copy(){return new t(this.buffer.slice(this.byteOffset+this.i,this.byteOffset+this.byteLength))}[Symbol.for("nodejs.util.inspect.custom")](){let t=`BufReader(${this.byteLength-this.i}) [ [33m`,{i:i}=this;const e=i+50>this.byteLength?this.byteLength:i+50;for(;i<e;){const e=this.getUint8(i++);t+="0123456789abcdef"[e>>4]+"0123456789abcdef"[15&e]+" "}return t+`[m${this.byteLength>e?"... ":""}]`}},BufWriter:class t{constructor(t=new ArrayBuffer(64),i=0){this.buf=new DataView(t),this.buf8=new Uint8Array(t),this.i=i<=(this.cap=t.byteLength)?i:this.cap,this.bitState=0}encode(t,i){return t.encode(this,i)}b1(t=0){let i=this.bitState;7&i||(this.i>=this.cap&&r(this),i=this.i<<3,this.buf8[this.i++]=0),this.buf8[i>>>3]|=t<<(7&i),this.bitState=i+1}b2(t=0){let i=this.bitState,e=7&i;if(e){if(this.buf8[i>>>3]|=t<<e,e<7)return void(this.bitState=i+2);i=e=1}else i=2;this.i>=this.cap&&r(this),this.bitState=i|this.i<<3,this.buf8[this.i++]=t>>e}b4(t=0){let i=this.bitState,e=7&i;if(e){if(this.buf8[i>>>3]|=t<<e,e<5)return void(this.bitState=i+4);i=e-4,e=8-e}else i=4;this.i>=this.cap&&r(this),this.bitState=i|this.i<<3,this.buf8[this.i++]=t>>e}u8(t=0){this.i>=this.cap&&r(this),this.buf8[this.i++]=t}i8(t=0){this.i>=this.cap&&r(this),this.buf8[this.i++]=t}u16(t=0){(this.i+=2)>this.cap&&r(this),this.buf8[this.i-2]=t>>8,this.buf8[this.i-1]=t}i16(t=0){(this.i+=2)>this.cap&&r(this),this.buf8[this.i-2]=t>>8,this.buf8[this.i-1]=t}u24(t=0){(this.i+=3)>this.cap&&r(this),this.buf8[this.i-3]=t>>16,this.buf8[this.i-2]=t>>8,this.buf8[this.i-1]=t}i24(t=0){(this.i+=3)>this.cap&&r(this),this.buf8[this.i-3]=t>>16,this.buf8[this.i-2]=t>>8,this.buf8[this.i-1]=t}u32(t=0){(this.i+=4)>this.cap&&r(this),this.buf.setUint32(this.i-4,t)}i32(t=0){(this.i+=4)>this.cap&&r(this),this.buf.setInt32(this.i-4,t)}u48(t=0){(this.i+=6)>this.cap&&r(this),this.buf.setUint16(this.i-6,e(s(t)/4294967296)),this.buf.setInt32(this.i-4,0|t)}i48(t=0){(this.i+=6)>this.cap&&r(this),this.buf.setInt16(this.i-6,e(s(t)/4294967296)),this.buf.setInt32(this.i-4,0|t)}u64(t=0){(this.i+=8)>this.cap&&r(this),this.buf.setUint32(this.i-8,e(s(t)/4294967296)),this.buf.setInt32(this.i-4,0|t)}i64(t=0){(this.i+=8)>this.cap&&r(this),this.buf.setInt32(this.i-8,e(s(t)/4294967296)),this.buf.setInt32(this.i-4,0|t)}bu64(t=0n){(this.i+=8)>this.cap&&r(this),this.buf.setBigUint64(this.i-8,t)}bi64(t=0n){(this.i+=8)>this.cap&&r(this),this.buf.setBigInt64(this.i-8,t)}f32(t=0){(this.i+=4)>this.cap&&r(this),this.buf.setFloat32(this.i-4,t)}f64(t=0){(this.i+=8)>this.cap&&r(this),this.buf.setFloat64(this.i-8,t)}bool(t=!1){this.i>=this.cap&&r(this),this.buf8[this.i++]=t}v64(t=0){this.i>this.cap-8&&r(this),t>63?t>536870911?(this.buf.setUint32((this.i+=8)-8,2147483648|e(s(t)/4294967296)),this.buf.setInt32(this.i-4,0|t)):t>8191?this.buf.setInt32((this.i+=4)-4,1610612736|t):(this.buf8[this.i++]=t>>8|64,this.buf8[this.i++]=t):this.buf8[this.i++]=t<0?0:t}bv64(t=0n){this.i>this.cap-8&&r(this);const i=Number(t);i>63?i>536870911?this.buf.setBigUint64((this.i+=8)-8,0x8000000000000000n|t):i>0x1FFFn?this.buf.setInt32((this.i+=4)-4,1610612736|i):(this.buf8[this.i++]=i>>8|64,this.buf8[this.i++]=i):this.buf8[this.i++]=i<0?0:i}v32(t=0){this.i>this.cap-4&&r(this),t>63?t>16383?this.buf.setInt32((this.i+=4)-4,2147483648|t):(this.buf8[this.i++]=t>>8|64,this.buf8[this.i++]=t):this.buf8[this.i++]=t<0?0:t}v16(t=0){this.i>this.cap-2&&r(this),t>127?(this.buf8[this.i++]=t>>8|128,this.buf8[this.i++]=t):this.buf8[this.i++]=t>=0?t:0}u8arr(i,e=-1){if(!(i instanceof Uint8Array)){if(!(i instanceof t))return this.i>=this.cap&&r(this),void(this.buf8[this.i++]=0);i=i.buf8.subarray(0,i.i)}if(e<0){if((e=i.byteLength)>2147483647)return this.i>=this.cap&&r(this),void(this.buf8[this.i++]=0);this.i>this.cap-4-e&&r(this,e),e>16383?e>2147483647?this.buf8[this.i++]=e=0:this.buf.setInt32((this.i+=4)-4,2147483648|e):e>63?(this.buf8[this.i++]=e>>8|64,this.buf8[this.i++]=e):this.buf8[this.i++]=e}else this.i>this.cap-e&&r(this,e);this.buf8.set(i,this.i),this.i+=e}skip(t=0){(this.i+=t)>this.cap&&r(this,t)}str(t=""){this.i>this.cap-4&&r(this);const i=encoder.encode(t);let e=i.length;if(e>2147483647)return this.i>=this.cap&&r(this),void(this.buf8[this.i++]=0);this.i>this.cap-4-e&&r(this,e),e>16383?e>2147483647?this.buf8[this.i++]=e=0:this.buf.setInt32((this.i+=4)-4,2147483648|e):e>63?(this.buf8[this.i++]=e>>8|64,this.buf8[this.i++]=e):this.buf8[this.i++]=e,new Uint8Array(this.buffer).set(i,this.i),this.i+=e}enum({strToInt:t,default:i},e){this.i>this.cap-4&&r(this);const s=t.get(e)??i;s>63?s>16383?this.buf.setInt32((this.i+=4)-4,2147483648|s):(this.buf8[this.i++]=s>>8|64,this.buf8[this.i++]=s):this.buf8[this.i++]=s<0?0:s}get written(){return this.i}get buffer(){return this.buf.buffer}get byteOffset(){return 0}get byteLength(){return this.i}toUint8Array(){return this.buf8.subarray(0,this.i)}toReader(){return new BufReader(this)}copyToArrayBuffer(){return this.buf8.buffer.slice(0,this.i)}copy(){return new t(this.buf.buffer.slice(0,this.i),this.i)}copyToReader(){return new BufReader(this.buf8.buffer.slice(0,this.i))}[Symbol.for("nodejs.util.inspect.custom")](){let{i:t}=this,i=`BufWriter(${t}) [ ${t>50?(t-=50,"... "):(t=0,"")}[33m`;for(;t<this.i;){const e=this.buf8[t++];i+="0123456789abcdef"[e>>4]+"0123456789abcdef"[15&e]+" "}return i+"[m]"}},b1:n((t=0)=>+!!t,(t,i)=>t.b1(i),(t,i)=>t.b1(),0),b2:n((t=0)=>3&("number"==typeof t?t:Number(t)),(t,i)=>t.b2(i),(t,i)=>t.b2(),0),b4:n((t=0)=>15&("number"==typeof t?t:Number(t)),(t,i)=>t.b4(i),(t,i)=>t.b4(),0),u8:n((t=0)=>255&("number"==typeof t?t:Number(t)),(t,i)=>t.u8(i),(t,i)=>t.u8(),1),i8:n((t=0)=>("number"==typeof t?t:Number(t))<<24>>24,(t,i)=>t.i8(i),(t,i)=>t.i8(),1),u16:n((t=0)=>65535&("number"==typeof t?t:Number(t)),(t,i)=>t.u16(i),(t,i)=>t.u16(),2),i16:n((t=0)=>("number"==typeof t?t:Number(t))<<16>>16,(t,i)=>t.i16(i),(t,i)=>t.i16(),2),u24:n((t=0)=>16777215&("number"==typeof t?t:Number(t)),(t,i)=>t.u24(i),(t,i)=>t.u24(),3),i24:n((t=0)=>("number"==typeof t?t:Number(t))<<8>>8,(t,i)=>t.i24(i),(t,i)=>t.i24(),3),u32:n((t=0)=>("number"==typeof t?t:Number(t))>>>0,(t,i)=>t.u32(i),(t,i)=>t.u32(),4),i32:n((t=0)=>0|("number"==typeof t?t:Number(t)),(t,i)=>t.i32(i),(t,i)=>t.i32(),4),u48:n((t=0)=>4294967296*(65535&e(s(t="number"==typeof t?t:Number(t))/4294967296))+(t>>>0),(t,i)=>t.u48(i),(t,i)=>t.u48(),6),i48:n((t=0)=>4294967296*(e(s(t="number"==typeof t?t:Number(t))/4294967296)<<16>>16)+(t>>>0),(t,i)=>t.i48(i),(t,i)=>t.i48(),6),u64:n((t=0)=>4294967296*(e(s(t="number"==typeof t?t:Number(t))/4294967296)>>>0)+(t>>>0),(t,i)=>t.u64(i),(t,i)=>t.u64(),8),i64:n((t=0)=>4294967296*(0|e(s(t="number"==typeof t?t:Number(t))/4294967296))+(t>>>0),(t,i)=>t.i64(i),(t,i)=>t.i64(),8),bu64:n((t=0n)=>0xFFFFFFFFFFFFFFFFn&("bigint"==typeof t?t:BigInt(t)),(t,i)=>t.bu64(i),(t,i)=>t.bu64(),8),bi64:n((t=0n)=>BigInt.asIntN(64,"bigint"==typeof t?t:BigInt(t)),(t,i)=>t.bi64(i),(t,i)=>t.bi64(),8),f32:n((t=0)=>h("number"==typeof t?t:Number(t)),(t,i)=>t.f32(i),(t,i)=>t.f32(),4),f64:n((t=0)=>"number"==typeof t?t:Number(t),(t,i)=>t.f64(i),(t,i)=>t.f64(),8),v16:n((t=0)=>(t="number"==typeof t?t:Number(t))<0?0:32767&t,(t,i)=>t.v16(i),(t,i)=>t.v16(),1),v32:n((t=0)=>(t="number"==typeof t?t:Number(t))<0?0:2147483647&t,(t,i)=>t.v32(i),(t,i)=>t.v32(),1),v64:n((t=0)=>("number"==typeof t?t:Number(t))<0?0:t%0x8000000000000000,(t,i)=>t.v32(i),(t,i)=>t.v32(),1),bv64:n((t=0n)=>("bigint"==typeof t?t:BigInt(t))<0n?0n:0x7FFFFFFFFFFFFFFFn&t,(t,i)=>t.v32(i),(t,i)=>t.v32(),1),u8arr:n(t=>{try{const i="string"==typeof t?encoder.encode(t):new Uint8Array(t.buffer?t.buffer.slice(t.byteOffset,t.byteLength):t instanceof ArrayBuffer?t.slice(0,2147483647):t);return i.byteLength>2147483647?i.subarray(0,2147483647):i}catch{return new Uint8Array}},(t,i)=>t.u8arr(i),(t,i)=>t.u8arr(),1),str:n((t="")=>t+"",(t,i)=>t.str(i),(t,i)=>t.str(),1),bool:n(t=>!!t,(t,i)=>t.bool(i),(t,i)=>t.bool(),1),Struct:(t,i)=>{const e=[],s=[],h=[],r=[],n=[];let u=0,f=0;const b={};for(const i in t){let a=/^[a-zA-Z$_][a-zA-Z0-9$_]*$/.test(i)?i:JSON.stringify(i);e.push(a+":a"+u),s.push(a+":this.a"+u+"(a"+u+")"),h.push("this.a"+u+".encode(b,a"+u+")"),n.push(a+":this.a"+u+".decode(b)"),a=a.length==i.length?"v."+a:"v["+a+"]",r.push(a+"=this.a"+u+".decode(b,"+a+")"),f+=(b["a"+u++]=t[i]).size??0}const a=`return{${s}}`;return i??=new Function(`{${e}}={}`,a).bind(b),i.encode=new Function(`b,{${e}}={}`,h.join(";")).bind(b),i.decode=new Function("b,v",`if(!v)return {${n}};${r.join(";")};return v`).bind(b),i.size=f,i.of=new Function(Object.keys(b),a).bind(b),i},Arr:(t,i=-1)=>{(i=e(i))>=0||(i=-1);const s=n(e=>{const s=[];try{for(const i of e)s.push(t(i))}catch{}if(i>=0)if(s.length>i)s.length=i;else for(;s.length<i;)s.push(t());else s.length>2147483647&&(s.length=2147483647);return s},(e,s=[])=>{const h=i<0?(e.v32(s.length),s.length):i;for(let i=0;i<h;i++)t.encode(e,s[i])},(e,s)=>{const h=i<0?e.v32():i;if(s)for(let i=0;i<h;i++)s[i]=t.decode(e,s[i]);else{s=[];for(let i=h;--i>=0;)s.push(t.decode(e))}return s},i<0?1:(t.size??0)*i);return s.of=(...t)=>s(t),s},Optional:t=>n(i=>null==i?null:t(i),(i,e)=>{null==e?i.u8(0):(i.u8(1),t.encode(i,e))},(i,e)=>i.u8()?t.decode(i,e):null,1),Enum:(t=[],i=void 0)=>{const e=new Map,s=[];if(Array.isArray(t))for(let i=0;i<t.length;i++)e.set(t[i]+"",i),s[i]=t[i];else for(const i in t){const h=2147483647&t[i];e.set(i,h),s[h]=i}"string"!=typeof i&&(i=e.keys().next().value??"");let h=-1;for(;s[++h];);const r=n(t=>"string"==typeof t?e.get(t)??h:2147483647&Number(t),(t,i)=>t.v32("string"==typeof i?e.get(i)??h:i),(t,e)=>s[t.v32()]??i,1);return r.strToInt=e,r.intToStr=s,r.default=h,r.defaultString=i,r},Padding:(t=0)=>n(()=>{},(i,e)=>i.skip(t),(i,e)=>{i.i+=t},t)},globalThis.Nanobuf.u8arr.len=t=>((t=e(t))>=0||(t=0),n(i=>i instanceof ArrayBuffer?new Uint8Array(i.byteLength>=t?i.slice(0,t):t):new Uint8Array(i?.length===t?i:t),(i,e)=>i.u8arr(e,t),(i,e)=>i.u8arr(t),t)),globalThis.loader=({url:t})=>(t=t.slice(0,t.lastIndexOf("/")+1),(...i)=>{if(i[0].raw){const e=[i[0][0]];for(let t=1;t<=i.length;t++)e.push(i[t],i[0][t]);const s=e.join("");return"/"==s[0]?s:t+s}return 1==i.length?"/"==i[0][0]?i[0]:t+i[0]:i.map(i=>"/"==i[0]?i:t+i)}),Array.map??=(t=0,i)=>{const e=[];for(let s=0;s<t;s++)e.push(i(s));return e},Gamma.utils=t=>{Object.assign(t,Nanobuf),t.screenshot=(i="image/png",e)=>new Promise(s=>requestAnimationFrame(()=>t.canvas.toBlob(s,i,e)))}}Gamma.gui=e=>{if(!e.Font)throw"Initialize Gamma.font before Gamma.gui";e.GUIElement=class{#t=NaN;#e=NaN;#i=null;_invalidated=!1;_dimensions(){return vec2.zero}invalidate=()=>{this._invalidated=!0,this.#t=this.#e=NaN;const t=this.#i;if(t)if("function"==typeof t)try{t()}catch(t){Promise.reject(t)}else for(const e of t)try{e()}catch(t){Promise.reject(t)}};addDependency(t){if("function"!=typeof t)return;const e=this.#i;e?"function"==typeof e?this.#i=[e,t]:e.push(t):this.#i=t}removeDependency(t){const e=this.#i;if(!e)return;if("function"==typeof e)return void(e===t&&(this.#i=null));let i=e.indexOf(t);if(!(i<0)){for(;i<e.length;)e[i]=e[++i];e.pop()}}get width(){let t=this.#t;if(t!=t){const e=this._dimensions();t=this.#t=e.x,this.#e=e.y}return t}get height(){let t=this.#e;if(t!=t){const e=this._dimensions();this.#t=e.x,t=this.#e=e.y}return t}};class i{#i=null;_invalidated=!1;invalidate=()=>{if(this._invalidated)return;this._invalidated=!0;const t=this.#i;if(t)if("function"==typeof t)try{t()}catch(t){Promise.reject(t)}else for(const e of t)try{e()}catch(t){Promise.reject(t)}};addDependency(t){if("function"!=typeof t)return;const e=this.#i;e?"function"==typeof e?this.#i=[e,t]:e.push(t):this.#i=t}removeDependency(t){const e=this.#i;if(!e)return;if("function"==typeof e)return void(e===t&&(this.#i=null));let i=e.indexOf(t);if(!(i<0)){for(;i<e.length;)e[i]=e[++i];e.pop()}}}class s extends GUIElement{constructor(t){super(),this.texture=t}get width(){return this.texture.width}get height(){return this.texture.height}draw(t,e,i,s){this.texture.then?.(this.invalidate),t.drawRect(0,0,i,s,this.texture)}}class h extends GUIElement{constructor(t){super(),this.text=t}get width(){return this.text.width}get height(){return 1}draw(t,e,i,s){this.text.draw(t)}}e.canvas.style.setProperty("--__gamma__sarea__","env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)"),e.getGUIDimensions=(t=16)=>{t=1/t;const{0:i,1:s,2:h,3:r}=getComputedStyle(e.canvas).getPropertyValue("--__gamma__sarea__").split(" ");return{width:e.canvas.offsetWidth*t,height:e.canvas.offsetHeight*t,paddingLeft:parseFloat(r)*t,paddingRight:parseFloat(s)*t,paddingBottom:parseFloat(h)*t,paddingTop:parseFloat(i)*t}};class r extends i{constructor(t,e,i){super(),this.child=t,this.pos=e,this.size=i}width=0;height=0;sized(t,e){return this.width=t,this.height=e,this}replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}draw(t,e,i,s){if(this._invalidated=!1,!this.child.draw)return;const{width:h,height:r}=this.child;let{size:n,pos:a}=this,l=1,c=1;"function"==typeof n&&(n=n(i/h,s/r)),"number"==typeof n?l=c=n:"object"==typeof n&&n&&(l=n.x,c=n.y);const o=i-h*l,d=s-r*c;"function"==typeof a&&(a=a(o,d)),"object"==typeof a?a&&t.translate(a.x*o,a.y*d):("number"!=typeof a&&(a=.5),t.translate(a*o,a*d)),t.scale(l,c),this.child.draw(t,e,h,r)}}class n extends i{constructor(t,e,i,s){super(),this.child=t,this.child.addDependency(this.invalidate),this.transform=e,this.anchorX=i,this.anchorY=s}get width(){return this.child.width}get height(){return this.child.height}replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}draw(t,e,i,s){if(this._invalidated=!1,!this.child.draw)return;t.translate(i*this.anchorX,s*this.anchorY);const{width:h,height:r}=this.child;this.transform(t,i,s,h,r),t.translate(-h*this.anchorX,-r*this.anchorY),this.child.draw(t,e,h,r)}}class a extends GUIElement{constructor(t,e,i,s){super(),this.texture=t,this.pos=e,this.size=i,this.tint=s}width=0;height=0;draw(t,e,i,s){if(!this.texture)return void t.drawRect(0,0,i,s,this.tint);if(!this.texture.loaded)return void this.texture.then?.(this.invalidate);let{width:h,height:r}=this.texture,{size:n,pos:a}=this;"function"==typeof n&&(n=n(i/h,s/r)),"number"==typeof n?(h*=n,r*=n):"object"==typeof n&&n&&(h*=n.x,r*=n.y);let l=i-h,c=s-r;"function"==typeof a&&(a=a(l,c)),"object"==typeof a?a&&(l*=a.x,c*=a.y):("number"!=typeof a&&(a=.5),l*=a,c*=a);const o=1/i,d=1/s;t.drawRect(0,0,i,s,this.texture.super(l*o,c*d,h*o,r*d),this.tint)}}class l extends GUIElement{#s;#h=[];state=0;hitTest=null;constructor(t,e,i){super(),this.#s=t?[t]:[],this.cursor=e,this.activeCursor=i}reset(){this.#s.length=this.#h.length=0}onClick(t){return this.#s.push(t),this}onStateChange(t){return this.#h.push(t),this}setCursor(t){return this.cur=t,this}rounded(t=0,e=t,i=t,s=t){const h=max(t,i),r=max(e,s);return this.hitTest=(n,a,l,c)=>{if(n<h)if(n<i){if(a<i){const t=n-i,e=a-i;if(t*t-e*e>i*i)return!1}}else if(c-a<t){const e=n-t,i=c-a-t;if(e*e-i*i>t*t)return!1}if(l-n>r)if(l-n<s){if(a<s){const t=l-n-s,e=a-s;if(t*t-e*e>s*s)return!1}}else if(c-a<e){const t=n-e,i=c-a-e;if(t*t-i*i>e*e)return!1}return!0},this}#r=-1;#n(t,e,i,s,h){let r=null;switch(!h){case!1:if(this.#r>=0&&s!=this.#r)return;if(r=t.unproject(h),r.x>=0&&r.x<e&&r.y>=0&&r.y<i&&(this.hitTest?.(r.x,r.y,e,i)??1))break;case!0:if(s==this.#r){this.#r=-1;const t=this.state;this.state=0;for(const e of this.#h)try{e(NaN,NaN,0,t)}catch(t){Promise.reject(t)}}return}const n=h.pressed?this.activeCursor:this.cursor;null!=n&&h.setHint?.(n);let a=this.state;this.state=1+h.pressed,-1==this.#r&&(this.#r=s);for(const t of this.#h)try{t(r.x,r.y,this.state,a)}catch(t){Promise.reject(t)}if(2!=this.state&&2==a)for(const t of this.#s)try{t(r.x,r.y,this.state)}catch(t){Promise.reject(t)}return null}draw(t,e,i,s){e.onPointerUpdate(this.#n.bind(this,t,i,s))}}class c extends i{width=0;height=0;ictx=InputContext();constructor(t){super(),this.child=t,this.child.addDependency(this.invalidate)}sized(t,e){return this.width=t,this.height=e,this}#a=!1;#l=NaN;#c=NaN;#o=NaN;#d=NaN;#f=NaN;#u=NaN;#p=NaN;#e=NaN;#m=NaN;#w=NaN;#g=NaN;#y=0;#x=0;#v=0;#_=-1;#b=0;#T=0;options=0;format=Formats.RGBA;mipmaps=1;#D=null;#E=Drawable();#N=this.#E.subPersp();replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}tolerance=.25;depthTolerance=.01;lastRedraw=-1;draw(e,i,s,h){let r,n,a,l,c,o,d,f,u,p=!0;const{width:m,height:w}=e;e.scale(s,h);const g=+this.tolerance,y=this.#p,x=this.#e;t:if(e.perspective){const t=g*(1-this.depthTolerance);if(({a:r,b:n,c:a,d:l,e:c,f:o,g:d,h:f,i:u}=e),y!=y)break t;let i=u,s=this.#m;if(i>s&&(i=s,s=u),max(abs(d-y)*m+abs(f-x)*w,max(s,1e-6)*t)>max(i,1e-6)*g)break t;const h=d+l,v=y+this.#d,_=f+c,b=x+this.#f,T=u+o,D=this.#m+this.#u;if(T>D?(i=D,s=T):(i=T,s=D),max(abs(h-v)*m+abs(_-b)*w,max(s,1e-6)*t)>max(i,1e-6)*g)break t;if(i=T+a,s=D+this.#o,i>s&&(i=s,s=D+a),max(abs(h+r-(v+this.#l))*m+abs(_+n-(b+this.#c))*w,max(s,1e-6)*t)>max(i,1e-6)*g)break t;if(i=u+a,s=this.#m+this.#o,i>s&&(i=s,s=u+a),max(abs(d+r-(y+this.#l))*m+abs(f+n-(x+this.#c))*w,max(s,1e-6)*t)>max(i,1e-6)*g)break t;p=!1}else{if(({a:r,b:n,c:l,d:c,e:d,f:f}=e),a=0,o=0,u=1,y!=y)break t;if(abs(d-y)*m+abs(f-x)*w>g)break t;if(abs(r-this.#l)*m+abs(n-this.#c)*w>g)break t;if(abs(l-this.#d)*m+abs(c-this.#f)*w>g)break t;p=!1}if(s!=this.#w||this._invalidated||p||h!=this.#g){const i=e.loopBoundary();this.#w=s,this.#g=h,this._invalidated=!1,this.#y=m,this.#x=w,this.#l=r,this.#c=n,this.#o=a,this.#d=l,this.#f=c,this.#u=o,this.#p=d,this.#e=f,this.#m=u;let p=this.#D;if(i){this.lastRedraw=t;const g=this.options,y=floor(i.x0*m),x=ceil(i.x1*m)-y,v=floor(i.y0*w),_=ceil(i.y1*w)-v;this.#v=y/m,this.#_=x/m,this.#b=v/w,this.#T=_/w,p&&p.format==this.format&&p.width==x&&p.height==_&&p.format==this.format?this.#E.clear(0,0,0,0):(p?.delete(),p=this.#D=Texture(x,_,1,g,this.format,this.mipmaps),this.#E.setTarget(0,p),this.mipmaps=p.mipmaps,this.format=p.format),this.#D.options!=g&&(this.#D.option=g),this.ictx.reset();const b=1/this.#_,T=1/this.#T;let D;e.perspective?(D=this.#N).reset((r-this.#v*a)*b,(n-this.#b*a)*T,a,(l-this.#v*o)*b,(c-this.#b*o)*T,o,(d-this.#v*u)*b,(f-this.#b*u)*T,u):(D=this.#E).reset(r*b,n*T,l*b,c*T,(d-this.#v)*b,(f-this.#b)*T),D.scale(1/s,1/h);const E=this.predraw?.(D,this.ictx,s,h);this.child.draw(D,this.ictx,s,h),E?.(),this.mipmaps&&p.genMipmaps()}else this.#_=-1,p&&(this.#E.setTarget(0,null),p.delete(),this.#D=null)}if(this.#_<0)return;const v=e.mask&RGBA;e.mask=SET|NEVER,e.draw(vec4.zero),e.perspective?e.reset(this.#_,0,0,0,this.#T,0,this.#v,this.#b,1):e.reset(this.#_,0,0,this.#T,this.#v,this.#b),e.mask=v|IF_SET|UNSET,e.draw(this.#D),i.onPointerUpdate((t,i)=>{if(t||(this.#a=!!i),!i)return void this.ictx.setPointer(t,null);let s=e.unproject(i);if(s.x>=0&&s.y>=0&&s.x<1&&s.y<1){i.x=s.x,i.y=s.y;const h=this.ictx.setPointer(t,i);return h&&({x:h.x,y:h.y}=e.project(h)),h}this.ictx.setPointer(t,null)}),i.onWheel((t,e)=>{if(this.#a)return this.ictx.fireWheel(t,e)}),i.onMouse((t,e)=>{if(this.#a)return this.ictx.fireMouse(t,e)}),i.onKeyUpdate(this.ictx),i.onGamepadUpdate(this.ictx)}}class o extends c{constructor(t,e,i){super(t),this.anchorX=e,this.anchorY=i}x=0;y=0;scrollSpanX=0;scrollSpanY=0;sensitivity=.0625;easing=.05;_velocityX=0;_velocityY=0;scrollBarX=f;scrollBarY=f;get scrollbar(){return this.scrollBarY}set scrollbar(t){this.scrollBarX=this.scrollBarY=t}predraw(t,e,i,s){let{width:h,height:r}=this.child;h=max(h-i,0),r=max(r-s,0);const n=this.scrollBarX&&h?t.sub():null,a=this.scrollBarY&&r?t.sub():null,l=-h*this.anchorX,c=-r*this.anchorY;let{_velocityX:o,_velocityY:d}=this;if(o||d){const t=dt/this.easing;if(o){if(abs(o)>t){const e=sign(o)*t;this._velocityX=o-e,o-=.5*e}else this._velocityX=0,o*=.5;const e=this.x+o*t;e!=(this.x=clamp(e,l,h+l))&&(this._velocityX=0)}if(d){if(abs(d)>t){const e=sign(d)*t;this._velocityY=d-e,d-=.5*e}else this._velocityY=0,d*=.5;const e=this.y+d*t;e!=(this.y=clamp(e,c,r+c))&&(this._velocityY=0)}this.invalidate()}const f=t.getTransform();return t.translate(l-this.x,c-this.y),e.onWheel((t,n)=>{if(!e.cursor)return;const a=f.unproject(e.cursor);if(!(a.x<0||a.y<0||a.x>i||a.y>s)){if(t*=this.sensitivity,n*=this.sensitivity,this.easing){const{_velocityX:e,_velocityY:i}=this;t=e*abs(e)+t+t,n=i*abs(i)+n+n,this._velocityX=sqrt(abs(t))*sign(t),this._velocityY=sqrt(abs(n))*sign(n)}else this.x=clamp(this.x+t,l,h+l),this.y=clamp(this.y+n,c,r+c);return this.invalidate(),null}}),n||a?()=>{if(n){n.translate(0,s);const t=1/(i+h);this.scrollBarX(n,(this.x-l)*t,i*t,i)}if(a){a.translate(i,0),a.multiply(0,-1);const t=1/(s+r);this.scrollBarY(a,(this.y-c)*t,s*t,s)}}:void 0}}e.GUI={MIDDLE:vec2(.5,.5),LEFT:vec2(0,.5),RIGHT:vec2(1,.5),BOTTOM:vec2(.5,0),TOP:vec2(.5,1),BOTTOM_LEFT:vec2(0,0),BOTTOM_RIGHT:vec2(1,0),TOP_LEFT:vec2(0,1),TOP_RIGHT:vec2(1,1),ZStack:(t=>{class e extends i{width=0;height=0;sized(t,e){return this.width=t,this.height=e,this}children=[];add(t){return this.children.push(t),t.addDependency(this.invalidate),this}remove(t){const e=this.children;if("number"==typeof t){if((t>>>=0)>=e.length)return;for(e[t].removeDependency(this.invalidate);t<e.length;)e[t]=e[++t];e.pop()}else this.children.remove(t)>=0&&t.removeDependency(this.invalidate)}}return e.prototype.draw=t,()=>new e})(function(t,e,i,s){this._invalidated=!1;let h=this.children.length;i=this.width||i,s=this.height||s;for(const r of this.children)r.draw?.(--h?t.sub():t,e,i,s)}),Img:t=>new s(t),Text:(t="",i=null)=>{if("string"==typeof t){const s=t;t=e.RichText(i),s&&t.add(s)}return new h(t)},Target:(t=null,e=PointerState.POINTER,i=PointerState.POINTER)=>new l(t,e,i),Box:(t,e=.5,i=1)=>new r(t,e,i),BoxFill:(t,e=.5,i=max,s)=>t.identity?new a(t,e,i,s):new a(null,1,1,t),Transform:(t,e=Function.prototype,i=.5,s=.5)=>new n(t,e,i,s),Layer:t=>new c(t),ScrollableLayer:(t,e=0,i=1)=>("object"==typeof e&&({x:e,y:i}=e),new o(t,e,i))},e.ParticleContainer=class extends i{width=0;height=0;sized(t,e){return this.width=t,this.height=e,this}#k;constructor(t){super(),this.#k=t}get config(){return this.#k}set config(t){this.#k=t,this.#C.length=0,this.#P.length=0}lastT=NaN;#P=[];#C=[];draw(e,i,s,h){this._invalidated=!1,e=this.#k.prepare?.(e,i,s,h)??e;const r=t-this.lastT||0;this.lastT=t;const n=this.#P.length;if(n){for(let t=n-1;t>=0;t--){const i=this.#P[t];i&&this.#k.update(e,i,r)&&(this.#P[t]=null,this.#C.push(t))}if(this.#C.length>=min(n,max(5,n>>1))){this.#C.length=0;let t=0;for(;this.#P[t];)t++;let e=t+1;for(;e<n;){const i=this.#P[e++];i&&(this.#P[t++]=i)}this.#P.length=t}this.invalidate()}}add(...e){const i=this.#k.init(...e);this.#P.length||(this.lastT=t),this.#C.length?this.#P[this.#C.pop()]=i:this.#P.push(i)}};const d=e.vec4(.2),f=e.GUI.ScrollableLayer.defaultScrollbar=(t,e,i,s)=>{t.shader=null,t.drawRect(e*s,0,i*s,.5,d)},u=({target:t})=>(256&t._field._f||(t._field._f|=256,setImmediate(t._field.recalc)),t.remove(),e.setFocused(g=null)),p=t=>{const e=t.target._field;if(38==t.keyCode||40==t.keyCode){if(e._f>>1&1^t.shiftKey)38==t.keyCode?e.upArrowCb?.():e.downArrowCb?.();else if(2048&e._f)if(e.sel0==e.sel1){let i=e.sel0,s=i,h=e.sel0pos,r=h;for(;r;)i-=e.lines[--r].length;const n=e.lines[h].slice(0,i).width;if(38==t.keyCode&&h){const t=e.lines[h-1];e.sel0=e.sel1=s-i-t.length+t.indexAt(n)}else 40==t.keyCode&&h<e.lines.length-1&&(e.sel0=e.sel1=s-i+e.lines[h].length+e.lines[h+1].indexAt(n))}else 38==t.keyCode?e.sel0=e.sel1:e.sel1=e.sel0}else if(13==t.keyCode){if(!(e._f>>2&1^t.shiftKey))return;e.enterCb?.()}else{if(9!=t.keyCode)return;e._f>>3&1^t.shiftKey?e.tabCb?.():1&e._f&&e.insert("\t")}t.preventDefault()},m=(t,e)=>{const i=document.createElement(t);return i.style="width:1px;height:1px;border:0;padding:0;opacity:0;position:fixed;inset:-9px;font-size:16px;font-family:monospace;white-space:nowrap;pointer-events:none",i.onblur=u,i.onkeydown=p,i.tabIndex=-1,i._field=e,document.documentElement.append(i),i},w=e.vec4;let g=null,y=0;const x=(t,e)=>t.insertLinePass(-1,[e.focus?w(0,.2,.4,.6):w(.2,.2,.2,.6)],0,1),v=(t,i)=>{i&&(t.shader=null,(e.t-y)%1<.5&&t.drawRect(0,i.ascend-1,.05,1,w.one))};class _{_f=0;#I=0;#f=0;get allowTabs(){return!!(1&this._f)}set allowTabs(t){this._f=-2&this._f|1&t}get shiftArrows(){return!!(2&this._f)}set shiftArrows(t){this._f=-3&this._f|2&-t}get shiftEnter(){return!!(4&this._f)}set shiftEnter(t){this._f=-5&this._f|4&-t}get shiftTab(){return!!(8&this._f)}set shiftTab(t){this._f=-9&this._f|8&-t}upArrowCb=null;downArrowCb=null;enterCb=null;tabCb=null;scrollable=null;#m;constructor(t){this.#m=m(t?"textarea":"input",this),this._f=t}get value(){return this.#m.value}set value(t){this.#m.value=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}get sel0(){return this.#I}set sel0(t){t>>>=0,this.#f>=this.#I?t<=this.#f?this.#m.selectionStart=t:(this.#m.selectionStart=this.#f,this.#m.selectionEnd=t,this.#m.selectionDirection="backward"):t>this.#f?this.#m.selectionEnd=t:(this.#m.selectionStart=t,this.#m.selectionEnd=this.#f,this.#m.selectionDirection="forward"),this.#I=t}get sel1(){return this.#f}set sel1(t){t>>>=0,this.#f>=this.#I?t>=this.#I?this.#m.selectionEnd=t:(this.#m.selectionStart=t,this.#m.selectionEnd=this.#I,this.#m.selectionDirection="backward"):t<this.#I?this.#m.selectionStart=t:(this.#m.selectionStart=this.#I,this.#m.selectionEnd=t,this.#m.selectionDirection="forward"),this.#f=t}select(t,e=t){(t>>>=0)<=(e>>>=0)?(this.#m.selectionStart=t,this.#m.selectionEnd=e,this.#I>this.#f&&(this.#m.selectionDirection="forward")):(this.#m.selectionStart=e,this.#m.selectionEnd=t,this.#I<=this.#f&&(this.#m.selectionDirection="backward")),this.#I=t,this.#f=e,256&this._f||(this._f|=256,setImmediate(this.recalc))}get selStart(){return min(this.#I,this.#f)}get selEnd(){return max(this.#I,this.#f)}get isSelecting(){return!!(512&this._f)}#S=null;get transformer(){return this.#S}set transformer(t){this.#S!=(this.#S=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}simpleTransformer(t,i="",...s){let h=s.slice();h[0]=s[0]?w.multiply(s[0],.4):w(.4),this.#S=r=>{const n=e.RichText(t);return s.length&&n.setTextPass(0,s),r?n.add(r):(n.setTextPass(0,h),n.index=!1,n.add(i)),n},256&this._f||(this._f|=256,setImmediate(this.recalc))}#R=v;#U=x;#B=null;#F=null;#X=1/0;#w=0;#Y=0;#t=0;get sel0pos(){return this.#w}get sel1pos(){return this.#Y}get multiline(){return!!(2048&this._f)}set multiline(t=!0){const i=this.#m,s=i.value,h=document.activeElement==i;if(t){if(2048&this._f)return;this.#B=null,this._f|=2304,this.#m=m("textarea",this)}else{if(!(2048&this._f))return;this.#F=null,this._f=-2049&this._f|256,this.#m=m("input",this)}h?this.focus=!0:(i.remove(),g==i&&e.setFocused(g=null),256&this._f||(this._f|=256,setImmediate(this.recalc))),this.#m.value=s,this.#m.selectionStart=this.#I,this.#m.selectionEnd=this.#f,this.#m.selectionDirection=this.#I>this.#f?"backward":"forward"}get width(){return this.#t}get line(){return this.#B}get lines(){return this.#F}get cursor(){return this.#R}set cursor(t){this.#R!=(this.#R=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get selector(){return this.#U}set selector(t){this.#U!=(this.#U=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get maxWidth(){return this.#X}set maxWidth(t){this.#X=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}recalc=()=>{const t=this._f;if(!(256&t))return;const i=this.#m,s=min(this.#I,this.#f),h=max(this.#I,this.#f);this._f=-257&t,y=e.t;const r=i.value,n=this.#S?.(r,this)??e.RichText();if(s==h){const e=n.slice(s);n.trim(s),2048&t||(this.#w=this.#Y=n.width),this.#R&&document.activeElement==this.#m&&n.addCb(this.#R),n.concat(e)}else{const e=n.slice(s),i=e.slice(h-s);e.trim(h-s),n.trim(s),2048&t?(this.#U?.(e,this),n.concat(e)):(this.#w=n.width,this.#U?.(e,this),n.concat(e),this.#Y=n.width),n.concat(i)}if(2048&t){const t=this.#F=n.break(this.#X);let e=0;for(const{width:i}of t)i>e&&(e=i);this.#t=e;let i=s,r=0;for(;r<t.length&&i>=0;)i-=t[r++].length;for(i=h-s+i+(r?t[--r].length:0),this.#w=r;r<t.length&&i>=0;)i-=t[r++].length;this.#Y=r?r-1:0}else this.#B=n,this.#t=n.width};insert(t="",e=t.length){const i=this.#m,s=i.selectionStart;i.setRangeText(t,s,i.selectionEnd,"start"),i.selectionStart=i.selectionEnd=this.#I=this.#f=s+e}get focus(){return document.activeElement==this.#m}set focus(t=!0){if(t){if(g){if(g==this.#m)return;g.replaceWith(g=this.#m)}else document.documentElement.append(g=this.#m);e.setFocused(g),y=e.t,256&this._f||(this._f|=256,setImmediate(this.recalc))}else g==this.#m&&(g.remove(),e.setFocused(g=null))}lineHeight=1.3;lineAscend=.9;#j=0;#A=-1;#n(e,i,s){if(!s)return void(i==this.#A&&(this.#A=-1,this._f&=-1537));if(s.setHint?.(PointerState.TEXT),-1==this.#A&&s.pressed)this.#A=i,this.focus=!0;else if(this.#A!=i)return null;if(!s.pressed)return this.#A=-1,this._f&=-1537,null;let{x:h,y:r}=e.unproject(s);r=this.lineAscend-r;const n=this._f>>9&3;if(3==n)return null;let a=0;if(this.#B)a=this.#B.indexAt(h);else if(this.#F){let t=floor(r/this.lineHeight);for(t=t>=0?t>=this.#F.length?this.#F.length-1:t>>>0:0,a=this.#F[t].indexAt(h);t;)a+=this.#F[--t].length}if(n)this.sel1=a;else{let e=0,i=a,s=a;if(this.#j<0?this.#j-(this.#j=-t)<.3?e=2:this.#j=t:this.#j>0?this.#j-(this.#j=t)>-.3&&(e=1,this.#j=-t):this.#j=t,this._f|=512|(e>0)<<10,e){const t=this.#m.value,h=33-e;for(;t.charCodeAt(s++)>h;);for(;t.charCodeAt(--i)>h;);i++,s--}i==this.#I&&s==this.#f||this.select(i,s)}return null}get height(){return this.lineHeight*(this.#F?this.#F.length:1)}layout(t,i,s=-1/0,h=-1/0,r=1/0,n=1/0){i.onPointerUpdate(this.#n.bind(this,t)),i.onKeyUpdate((t,i)=>(e.captureKeyEvent(this.#m,t,i),!1))}get height(){return this.#F?this.#F.length*this.lineHeight:this.lineHeight}get xOffset(){return 0}get yOffset(){return-this.lineAscend}draw(t,e){if(this.#F)for(const e of this.#F)e.draw(t.sub()),t.translate(0,-this.lineHeight);else this.#B?.draw(t)}static#G=(document.addEventListener("input",({target:t})=>{const e=t._field;if(!e)return;const{selectionStart:i,selectionEnd:s,selectionDirection:h}=t;"backward"==h?(e.#I=s,e.#f=i):(e.#I=i,e.#f=s),256&e._f||(e._f|=256,setImmediate(e.recalc))}),document.addEventListener("selectionchange",({target:t})=>{const e=t._field;if(!e)return;const{selectionStart:i,selectionEnd:s,selectionDirection:h}=t;"backward"==h?(e.#I=s,e.#f=i):(e.#I=i,e.#f=s),256&e._f||(e._f|=256,setImmediate(e.recalc))}))}e.TextField=(t=!1)=>new _(t<<11&2048),e.TextField.cursorTimer=()=>e.t-y};
=======
{const $=globalThis;Math.PI2??=2*Math.PI,Math.HALF_SQRT3??=.8660254037844386,Math.clamp??=(t,s,r)=>t<s?s:t>r?r:t;const{clz32:t,cos:s,sin:r,min:o,round:u}=Math;if(!("setImmediate"in $)){let t=0,s=0,r=[],n=new MessageChannel;n.port1.onmessage=()=>{const n=r[s];r[s++]=null,s>3&&s>r.length>>1&&(r.splice(0,s),t+=s,s=0),n?.()},n=n.port2,$.setImmediate=(s,...o)=>(n.postMessage(0),r.push(o.length?s.bind(void 0,...o):s),r.length-1+t),$.clearImmediate=i=>{(i-=t)===i>>>0&&(i>=r.length||(r[i]=null))}}if(!("sin"in $)){const t=Object.getOwnPropertyDescriptors(Math);delete t[Symbol.toStringTag],Object.defineProperties($,t)}const p={imageOrientation:"flipY",premultiplyAlpha:"premultiply"},m=(t,s,r)=>"string"==typeof t?fetch(t).then(a=>a.blob()).then(t=>createImageBitmap(t,p)).then(s,r):t instanceof Blob?createImageBitmap(t,p).then(s,r):s(t);$.Gamma=(p=document.createElement("canvas"),$={},v=15)=>{$.flags=v;const _=$.gl=($.canvas=p).getContext("webgl2",{preserveDrawingBuffer:!(8&v),antialias:16&v,depth:!1,premultipliedAlpha:4&v,stencil:1&v,alpha:2&v});_.pixelStorei(37440,1),_.stencilMask(1),_.clearStencil(0),_.disable(2929),_.enable(3042),_.pixelStorei(3317,1),_.pixelStorei(3333,1);const A=_.createBuffer();_.bindBuffer(35052,A);let g=!0,R=null,G=-1,T=!1,E=285217039,$s=null,$v=null,L=0,B=0,$u=0,N=null,$X=0,$x=0,F=5,S=0,j=4,$p=null,P=0;_.bindFramebuffer(36008,_.createFramebuffer());const I=_.createFramebuffer(),$M=_.createBuffer();_.bindBuffer(34962,$M);const O=o(32,_.getParameter(34930)),U=[];for(let i=O<<1;i-- >0;)U.push(null);Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NEVER:48,UNSET:64,SET:128,FLIP:192,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:136,RGB_DST:8,ONE_MINUS_DST:153,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,ADD:17,RGB_ADD:1,A_ADD:16,SUB:85,RGB_SUB:5,A_SUB:80,SUB_REV:102,RGB_SUB_REV:6,A_SUB_REV:96,MIN:34,RGB_MIN:2,A_MIN:32,MAX:51,RGB_MAX:3,A_MAX:48,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:28,FTEXTURE:29,ITEXTURE:30,UTEXTURE:31,COLOR:12,FCOLOR:13,ICOLOR:14,UCOLOR:15,FLAT:64,CW_ONLY:16,CCW_ONLY:32,ANISOTROPY:128,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0}),$.Formats={R:[33321,6403,5121],RG:[33323,33319,5121],RGB:[32849,6407,5121],RGBA:[32856,6408,5121],RGB565:[36194,6407,33635],R11F_G11F_B10F:[35898,6407,35899],RGB5_A1:[32855,6408,32820],RGB10_A2:[32857,6408,33640],RGBA4:[32854,6408,32819],RGB9_E5:[35901,6407,35902],R8:[33330,36244,5121,1<<31],RG8:[33336,33320,5121,1<<31],RGB8:[36221,36248,5121,1<<31],RGBA8:[36220,36249,5121,1<<31],R16:[33332,36244,5123,1<<31],RG16:[33338,33320,5123,1<<31],RGB16:[36215,36248,5123,1<<31],RGBA16:[36214,36249,5123,1<<31],R32:[33334,36244,5125,1<<31],RG32:[33340,33320,5125,1<<31],RGB32:[36209,36248,5125,1<<31],RGBA32:[36208,36249,5125,1<<31],R16F:[33325,6403,5131],RG16F:[33327,33319,5131],RGB16F:[34843,6407,5131],RGBA16F:[34842,6408,5131],R16F_32F:[33325,6403,5126],RG16F_32F:[33327,33319,5126],RGB16F_32F:[34843,6407,5126],RGBA16F_32F:[34842,6408,5126],R32F:[33326,6403,5126],RG32F:[33328,33319,5126],RGB32F:[34837,6407,5126],RGBA32F:[34836,6408,5126],DEPTH32F:[36012,6145,5126],DEPTH24:[33190,6145,5125],DEPTH16:[33189,6145,5123]},$.vec2=(x=0,y=x)=>({x:x,y:y}),$.vec2.one=$.vec2(1);const C=$.vec2.zero=$.vec2(0);$.vec2.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b}:{x:a.x+b.x,y:a.y+b.y},$.vec2.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y}:{x:a.x-b.x,y:a.y-b.y},$.vec2.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b}:{x:a.x*b.x,y:a.y*b.y},$.vec2.magnitude=a=>sqrt(a.x*a.x+a.y*a.y),$.vec2.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y);return{x:a.x*d,y:a.y*d}},$.vec3=(x=0,y=x,z=x)=>({x:x,y:y,z:z}),$.vec3.one=$.vec3(1);const D=$.vec3.zero=$.vec3(0);$.vec3.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z},$.vec3.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y,z:a-b.z}:{x:a.x-b.x,y:a.y-b.y,z:a.z-b.z},$.vec3.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z},$.vec3.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z),$.vec3.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z);return{x:a.x*d,y:a.y*d,z:a.z*d}},$.vec4=(x=0,y=x,z=x,w=x)=>({x:x,y:y,z:z,w:w}),$.vec4.one=$.vec4(1);const M=$.vec4.zero=$.vec4(0);$.vec4.add=(a,b)=>"number"==typeof b?{x:a.x+b,y:a.y+b,z:a.z+b,w:a.w+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z,w:a.w+b.w},$.vec4.subtract=(a,b)=>"number"==typeof a?{x:a-b.x,y:a-b.y,z:a-b.z,w:a-b.w}:{x:a.x-b.x,y:a.y-b.y,z:a.z-b.z,w:a.w-b.w},$.vec4.multiply=(a,b)=>"number"==typeof b?{x:a.x*b,y:a.y*b,z:a.z*b,w:a.w*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z,w:a.w*b.w},$.vec4.magnitude=a=>sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w),$.vec4.normalize=a=>{const d=1/sqrt(a.x*a.x+a.y*a.y+a.z*a.z+a.w*a.w);return{x:a.x*d,y:a.y*d,z:a.z*d,w:a.w*d}};const X=_.getExtension("EXT_texture_filter_anisotropic")?_.getParameter(34047):0;class $m{get isInteger(){return this.t.f.length>3}get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get mipmaps(){return this.t.m}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get identity(){return this.t}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,x=0,y=0,w=1,h=1,l=0){this.t=t,this.x=x,this.y=y,this.w=w,this.h=h,this.l=l}get loaded(){return!this.t.src}get usable(){return!this.t.src||(this.t.p||$m.load(this.t),!1)}get then(){return this.t.src?this.#t:null}load(){this.t.p||$m.load(this.t)}sub(x=0,y=0,w=1,h=1,l=this.l){return new $m(this.t,this.x+x*this.w,this.y+y*this.h,this.w*w,this.h*h,l)}super(x=0,y=0,w=1,h=1,l=this.l){const t=this.w/w,s=this.h/h;return new $m(this.t,this.x-x*t,this.y-y*s,t,s,l)}crop(x=0,y=0,w=0,h=0,l=this.l){const{t:t,x:s,y:r,h:n}=this;if(!t.src)return new $m(t,s+x/t.w,r+n-(y+h)/t.h,w/t.w,h/t.h,l);const i=new $m(t,0,0,0,0,l);return t.p||$m.load(t),t.src.push(i=>{i.x=s+x/t.w,i.y=r+n-(y+h)/t.h,i.w=w/t.w,i.h=h/t.h},void 0,i),i}layer(l=this.l){return new $m(this.t,this.x,this.y,this.w,this.h,l)}#t(t,s){"function"!=typeof t&&(t=Function.prototype),this.t.src?(this.t.p||$m.load(this.t),this.t.src.push(t,s,this)):t(this)}static load(t){let s=t.src,r=0;t.src=[];let w=0,h=0;t.p=_.createTexture();const n=()=>{r=-1,$m.setOptions(t),_.texStorage3D(35866,t.m=1,t.f[0],t.w=w=1,t.h=h=1,t.d),g||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),g=!0),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const s=t.src;t.src=null;for(let i=1;i<s.length;i+=3)s[i]?.(s[i+1])};for(let i=0;i<s.length;i++)m(s[i],u=>{if(r){if(w!=u.width||h!=u.height)return n()}else w=u.width,h=u.height;if(s[i]=u,++r<s.length)return;$m.setOptions(t),_.texStorage3D(35866,t.m=o(t.m,floor(log2(max(w,h)))+1),t.f[0],t.w=w,t.h=h,t.d),g||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),g=!0),_.bindBuffer(35052,null);for(let l=0;l<r;l++)_.texSubImage3D(35866,0,0,0,l,w,h,1,t.f[1],t.f[2],s[l]);_.bindBuffer(35052,A),t.m>1&&_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null);const p=t.src;t.src=null;for(let i=0;i<p.length;i+=3)p[i](p[i+2])},n)}paste(t,x=0,y=0,l=0,s=0,r=0,n=0,o=0,u=0,p=0,v=0,R=0){const{t:G}=this;if(G.src)return null;if(t.msaa)return i&&draw(),p=u||t.height,u=o||t.width,_.framebufferRenderbuffer(36008,36064,36161,t.p),N!=I&&(_.bindFramebuffer(36009,N=I),curt=it=null),_.framebufferTextureLayer(36009,36064,G.p,s,l),15&~E&&(_.colorMask(1,1,1,1),E|=15,it=null),_.blitFramebuffer(r,n,r+u,n+p,x,y,x+u,y+p,16384,9728),this;if(!(t instanceof $m))return m(t,i=>($m.fakeBind(G),g||(_.pixelStorei(37440,1),_.pixelStorei(37441,1),g=!0),_.bindBuffer(35052,null),_.texSubImage3D(35866,s,x,y,l,i.width,i.height,1,G.f[1],G.f[2],i),_.bindBuffer(35052,A),G.i<0&&_.bindTexture(35866,null),this));const{t:T}=t;if(T.src)return console.warn("Source texture is not loaded"),this;if(G.p==T.p)return console.warn("Cannot copy from texture to itself"),this;for($m.fakeBind(G),u=u||T.w,p=p||T.h,v=v||T.d;v--;)_.framebufferTextureLayer(36008,36064,T.p,R,o++),_.copyTexSubImage3D(35866,s,x,y,l++,r,n,u,p);return G.i<0&&_.bindTexture(35866,null),this}pasteData(t,x=0,y=0,l=0,w=0,h=0,d=0,s=0){const{t:r}=this;return r.src?null:(w=w||r.w,h=h||r.h,d=d||r.d,$m.fakeBind(r),g&&(_.pixelStorei(37440,0),_.pixelStorei(37441,0),g=!1),_.bufferData(35052,t,35042),_.texSubImage3D(35866,s,x,y,l,w,h,d,r.f[1],r.f[2],0),wt+=.25*t.byteLength,r.i<0&&_.bindTexture(35866,null),this)}readData(x=0,y=0,l=0,w=0,h=0,d=0,t=0){const{t:s}=this;if(s.src)return null;w=w||s.w,h=h||s.h,d=d||s.d,i&&draw();let a=s.f[0],r=33323==a||33338==a||33340==a||33327==a||33328==a||33336==a?2:33321==a||33330==a||33332==a||33334==a||33325==a||33326==a?1:4,n=r<=2?1==r?6403:33319:3==r?6407:6408;a=s.f[2]==5121?1:s.f[2]==5126||s.f[2]==5125||s.f[2]==35899||s.f[2]==33640||s.f[2]==35902?4:2,r*=w*h;let o,u=r*d*a;for(G==u?(o=R,G=-1,T=!0):(_.bindBuffer(35051,o=_.createBuffer()),_.bufferData(35051,u,35041),u>G&&(G=u,R=o,T=!0));d--;)_.framebufferTextureLayer(36008,36064,s.p,t,l),_.readPixels(x,y,w,h,n,s.f[2],r*a*l++);return o!=R&&_.bindBuffer(35051,R),new Promise(t=>{const n=()=>{const $i=1==a?new Uint8Array(r*d):4==a?s.f[2]==5126?new Float32Array(r*d):new Uint32Array(r*d):new Uint16Array(r*d);o!=R&&_.bindBuffer(35051,o),_.getBufferSubData(35051,0,$i),t($i),o!=R&&(u>G?(G=u,R=o):_.bindBuffer(35051,R)),T=!0};n.sync=_.fenceSync(37143,0),At??=n,gt=gt?gt.next=n:n,Gt||(Gt=setInterval(vt,0))})}delete(){this.t.p&&(_.deleteTexture(this.t.p),this.t.p=null,this.t.i>=0&&(U[this.t.i]=null,this.t.i=-1),this.t.d=this.t.w=this.t.h=0)}static auto(s,i=0){if(s.f[3]>>31!=i)return-2;if(s.i>=0){const t=-2147483648>>>s.i-(O-L&i);if(!(t&(i^B)))return $X|=t,s.i;U[s.i]=null,s.i=-1}s.p||$m.load(s);const r=t(~($X|i^B));if(r>=O)return-1;$X|=-2147483648>>>r;const n=U[i=i?O+r-L:r];return n&&(n.i=-1),_.activeTexture(33984+i),_.bindTexture(35866,(U[i]=s).p),s.i=i}static fakeBind(t){if(t.i>=0)i&&draw(),_.activeTexture(33984+t.i);else{const s=O-1+(L==O&&O);U[s]&&(U[s].t.i=-1),_.activeTexture(33984+s),_.bindTexture(35866,t.p)}}get options(){return this.t.o}static setOptions(t){$m.fakeBind(t);const{o:s}=t;X&&_.texParameterf(35866,34046,128&s?X:1),t.f[3]>>31?(_.texParameterf(35866,10240,9728),_.texParameterf(35866,10241,9728)):(_.texParameterf(35866,10240,9728+(1&s)),_.texParameterf(35866,10241,t.m>1?9984+(s>>1&3):9728+(s>>1&1))),_.texParameterf(35866,10242,8&s?10497:16&s?33648:33071),_.texParameterf(35866,10243,32&s?10497:64&s?33648:33071)}set options(t){const{t:s}=this;s.o=t,s.src||($m.setOptions(s),s.i<0&&_.bindTexture(35866,null))}setMipmapRange(t=0,e=65535){const{t:s}=this;s.src||($m.fakeBind(s),_.texParameteri(35866,33082,t),_.texParameteri(35866,33083,e),s.i<0&&_.bindTexture(35866,null))}genMipmaps(){i&&draw();const{t:t}=this;t.m<2||($m.fakeBind(t),_.generateMipmap(35866),t.i<0&&_.bindTexture(35866,null))}}$.Drawable=(t=!1)=>new K({$:_.createFramebuffer(),_:0,T:t?_.createRenderbuffer():null,w:0,h:0,u:0}),$.Drawable.MAX_TARGETS=_.getParameter(36063),$.Drawable.DRAW_32F=!!_.getExtension("EXT_color_buffer_float");let $i=new Float32Array(1024),$I=new Int32Array($i.buffer),i=0;$.Texture=(w=0,h=0,d=1,t=0,f=Formats.RGBA,s=0)=>{s=o(s>>>0||1,floor(log2(max(w,h)))+1),w>>>=0,h>>>=0;const r={p:_.createTexture(),i:-1,o:t,f:f,src:null,w:w,h:h,d:d=d>>>0||1,m:s},n=new $m(r);return $m.setOptions(r),w&&h?_.texStorage3D(35866,s,r.f[0],w,h,d):_.texStorage3D(35866,1,r.f[0],r.w=1,r.h=1,d),_.bindTexture(35866,null),n},$.Texture.MAX_WIDTH=$.Texture.MAX_HEIGHT=_.getParameter(3379),$.Texture.MAX_LAYERS=_.getParameter(35071),$.Texture.FILTER_32F=!!_.getExtension("OES_texture_float_linear");const k=$.Texture.MAX_MSAA=_.getParameter(36183);$.Texture.MSAA=(w=0,h=0,t=65536,f=Formats.RGBA)=>{t=o(t,k);const s=_.createRenderbuffer();return _.bindRenderbuffer(36161,s),_.renderbufferStorageMultisample(36161,t,f[0],w,h),{p:s,width:w,height:h,msaa:_.getRenderbufferParameter(36161,36011),delete(){_.deleteRenderbuffer(this.p)}}},$.Texture.from=(t,s=0,r=Formats.RGBA,n=0)=>new $m({p:null,i:-1,o:s,f:r,src:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:t?Array.isArray(t)?t.length:1:0,m:n||1});let Y=[];function V(){if(!Y.length)return null;let t=1,s=0,r=1,n=0,o=Y[0],u=Y[1],p=abs(u-.5)<=.5;for(let i=Y.length;i;){i-=2;const x=Y[i],y=Y[i+1];if(!p){let f=((u>=y)-y)/(u-y);abs(f-.5)<=.5&&(f=x+f*(o-x),f<t&&(t=f),f>s&&(s=f))}if(p=abs(y-.5)<=.5,p)x<t&&(t=x),x>s&&(s=x);else{let f=((y>=u)-u)/(y-u);abs(f-.5)<=.5&&(f=o+f*(x-o),f<t&&(t=f),f>s&&(s=f))}o=x,u=y}p=abs(o-.5)<=.5;for(let i=Y.length;i;){i-=2;const x=Y[i],y=Y[i+1];if(!p){let f=((o>=x)-x)/(o-x);abs(f-.5)<=.5&&(f=y+f*(u-y),f<r&&(r=f),f>n&&(n=f))}if(p=abs(x-.5)<=.5,p)y<r&&(r=y),y>n&&(n=y);else{let f=((x>=o)-o)/(x-o);abs(f-.5)<=.5&&(f=u+f*(y-u),f<r&&(r=f),f>n&&(n=f))}o=x,u=y}return Y.length=0,s>t&&n>r?{x0:t,y0:r,x1:s,y1:n}:null}function Z(){if(!Y.length)return null;let t=1,s=0,r=1,n=0,o=Y[0],u=Y[1],p=Y[2];o*=p,u*=p;let m=abs(u-.5)<=.5,v=1,A=0;for(let i=Y.length;i;){i-=3;let x=Y[i],y=Y[i+1],z=Y[i+2];x*=z,y*=z;let r=abs(y-.5)<=.5;t:if(z*p>=0){if(!m){let f=((u>=y)-y)/(u-y);abs(f-.5)<=.5&&(f=x+f*(o-x),z>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>A&&(A=f)))}let f;if(r)f=x;else{if(f=((y>=u)-u)/(y-u),!(abs(f-.5)<=.5))break t;f=o+f*(x-o)}z>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>A&&(A=f))}else{if(!r){let f=((u>=y)-u)/(u-y);f>=0&&(f=o+f*(o-x),p>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>A&&(A=f)))}if(r&&(z>=0?(x<t&&(t=x),x>s&&(s=x)):(x<v&&(v=x),x>A&&(A=x))),!m){let f=((y>=u)-y)/(y-u);f>=0&&(f=x+f*(x-o),z>=0?(f<t&&(t=f),f>s&&(s=f)):(f<v&&(v=f),f>A&&(A=f)))}}o=x,u=y,p=z,m=r}t:if(A>=v){if(A<t){s=1;break t}if(v>s){t=0;break t}s=1,t=0}v=1,A=0,m=p>0&&abs(o-.5)<=.5;for(let i=Y.length;i;){i-=3;let x=Y[i],y=Y[i+1],z=Y[i+2];x*=z,y*=z;let t=abs(x-.5)<=.5;t:if(z*p>=0){if(!m){let f=((o>=x)-x)/(o-x);abs(f-.5)<=.5&&(f=y+f*(u-y),z>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>A&&(A=f)))}let f;if(t)f=y;else{if(f=((x>=o)-o)/(x-o),!(abs(f-.5)<=.5))break t;f=u+f*(y-u)}z>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>A&&(A=f))}else{if(!t){let f=((o>=x)-o)/(o-x);f>=0&&(f=u+f*(u-y),p>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>A&&(A=f)))}if(t&&(z>=0?(y<r&&(r=y),y>n&&(n=y)):(y<v&&(v=y),y>A&&(A=y))),!m){let f=((x>=o)-x)/(x-o);f>=0&&(f=y+f*(y-u),z>=0?(f<r&&(r=f),f>n&&(n=f)):(f<v&&(v=f),f>A&&(A=f)))}}o=x,u=y,p=z,m=t}t:if(A>=v){if(A<r){n=1;break t}if(v>n){r=0;break t}n=1,r=0}return Y.length=0,s>t&&n>r?{x0:t<0?0:t,y0:r<0?0:r,x1:s>1?1:s,y1:n>1?1:n}:null}class H{constructor(a=1,b=0,c=0,d=1,e=0,f=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f}sub(){return new H(this.a,this.b,this.c,this.d,this.e,this.f)}subPersp(){return new q(this.a,this.b,this.c,this.d,this.e,this.f,0,0,1)}sub3d(){return new W(this.a,this.b,this.c,this.d,0,0,this.e,this.f)}sub3dPersp(t=0,s=1){return new J(this.a,this.b,0,this.c,this.d,0,this.e*s,this.f*s,s,this.e*t,this.f*t,t)}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f}project(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y+this.e,y:this.b*x+this.d*y+this.f}}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:((x-=this.e)*d-(y-=this.f)*c)*t,y:(y*a-x*b)*t}}translate(x=0,y=0){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d}=this;this.a=a*n-c*o,this.b=b*n-d*o,this.c=a*o+c*n,this.d=b*o+d*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d;this.a=t*a+r*b,this.b=s*a+n*b,this.c=t*c+r*d,this.d=s*c+n*d,this.e+=t*e+r*f,this.f+=s*e+n*f}skew(x=0,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a+c*y,this.b=b+d*y,this.c=c+a*x,this.d=d+b*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=a*x-c*y,this.b=b*x-d*y,this.c=c*x+a*y,this.d=d*x+b*y}box(x=0,y=0,w=1,h=w){this.e+=x*this.a+y*this.c,this.f+=x*this.b+y*this.d,this.a*=w,this.b*=w,this.c*=h,this.d*=h}point(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y+this.e,y:this.b*x+this.d*y+this.f}}metric(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.c*y,y:this.b*x+this.d*y}}pointFrom(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:((x-=this.e)*d-(y-=this.f)*c)*t,y:(y*a-x*b)*t}}metricFrom(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d}=this,t=1/(a*d-b*c);return{x:(x*d-y*c)*t,y:(y*a-x*b)*t}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;if(t)for(const{x:x,y:y}of t)Y.push(a*x+c*y+e,b*x+d*y+f);else{const t=e+a,s=f+b;Y.push(e,f,t,s,t+c,s+d,e+c,f+d)}return V()}}class q{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i}sub(){return new q(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}subPersp(){return this.sub()}sub3d(){return new J(this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}sub3dPersp(t=0,s=1){return new J(this.a,this.b,this.c,this.d,this.e,this.f,this.g*s,this.h*s,this.i*s,this.g*t,this.h*t,this.i*t)}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i}project(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);let t=this.c*x+this.f*y+this.i;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g)*t,y:(this.b*x+this.e*y+this.h)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);let u=(n*x+(c*d-a*f)*y+(a*e-b*d))*o;return u<=0?{x:NaN,y:NaN}:(u=1/u,{x:(s*x+(f*t-d*i)*y+(d*h-e*t))*o*u,y:(r*x+(a*i-c*t)*y+(b*t-a*h))*o*u})}translate(x=0,y=0){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f}scale(x=1,y=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y}rotate(t=0){const n=s(t),o=r(t),{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*n-d*o,this.b=b*n-e*o,this.c=c*n-f*o,this.d=a*o+d*n,this.e=b*o+e*n,this.f=c*o+f*n}transform(a,b,c,d,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a);const t=this.a,s=this.b,r=this.c,n=this.d,o=this.e,u=this.f;this.a=t*a+n*b,this.b=s*a+o*b,this.c=r*a+u*b,this.d=t*c+n*d,this.e=s*c+o*d,this.f=r*c+u*d,this.g+=t*e+n*f,this.h+=s*e+o*f,this.i+=r*e+u*f}skew(x=0,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a+d*y,this.b=b+e*y,this.c=c+f*y,this.d=d+a*x,this.e=e+b*x,this.f=f+c*x}multiply(x=1,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a*x-d*y,this.b=b*x-e*y,this.c=c*x-f*y,this.d=a*y+d*x,this.d=b*y+e*x,this.f=c*y+f*x}box(x=0,y=0,w=1,h=w){this.g+=x*this.a+y*this.d,this.h+=x*this.b+y*this.e,this.i+=x*this.c+y*this.f,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h}point(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.d*y+this.g,y:this.b*x+this.e*y+this.h,z:this.c*x+this.f*y+this.i}}metric(x=0,y=0){return"object"==typeof x&&({x:x,y:y}=x),{x:this.a*x+this.d*y,y:this.b*x+this.e*y,z:this.c*x+this.f*y}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h,i:i}=this;if(t)for(const{x:x,y:y}of t)Y.push(a*x+d*y+s,b*x+e*y+h,1/(c*x+f*y+i));else{const t=s+a,r=h+b,n=i+c;Y.push(s,h,1/i,t,r,1/n,t+d,r+e,1/(n+f),s+d,h+e,1/(i+f))}return Z()}}class W{constructor(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h}sub(){return new W(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}subPersp(t=0,s=1){return new J(this.a,this.b,0,this.c,this.d,0,this.g*s+this.e,this.h*s+this.f,s,this.g*t,this.h*t,t)}sub2dXY(){return new H(this.a,this.b,this.c,this.d,this.g,this.h)}sub2dZY(){return new H(this.e,this.f,this.c,this.d,this.g,this.h)}sub2dXZ(){return new H(this.a,this.b,this.e,this.f,this.g,this.h)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h}reset(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h}project(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z+this.j)*t,y:(this.b*x+this.e*y+this.h*z+this.k)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;x-=this.j,y-=this.k;const z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}perspectiveOrigin(){return{x:NaN,y:NaN,z:NaN}}perspectiveRay(t=0,s=0,r=null){return{x:NaN,y:NaN,z:NaN}}translate(x=0,y=0,z=0){this.g+=x*this.a+y*this.c+z*this.e,this.h+=x*this.b+y*this.d+z*this.f}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=y,this.d*=y,this.e*=z,this.f*=z}rotateXZ(t){let n=r(t),o=s(t);const{a:a,b:b,e:e,f:f}=this;this.a=o*a-n*e,this.e=o*e+n*a,this.b=o*b-n*f,this.f=o*f+n*b}rotateXY(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,d:d}=this;this.a=o*a-n*c,this.c=o*c+n*a,this.b=o*b-n*d,this.d=o*d+n*b}rotateZY(t){let n=r(t),o=s(t);const{c:c,d:d,e:e,f:f}=this;this.e=o*e-n*c,this.c=o*c+n*e,this.f=o*f-n*d,this.d=o*d+n*f}multiplyXZ(x=1,y=0){const{a:a,b:b,e:e,f:f}=this;this.a=x*a-y*e,this.e=x*e+y*a,this.b=x*b-y*f,this.f=x*f+y*b}multiplyXY(x=1,y=0){const{a:a,b:b,c:c,d:d}=this;this.a=x*a-y*c,this.c=x*c+y*a,this.b=x*b-y*d,this.d=x*d+y*b}multiplyZY(x=1,y=0){const{c:c,d:d,e:e,f:f}=this;this.e=x*e-y*c,this.c=x*c+y*e,this.f=x*f-y*d,this.d=x*d+y*f}skewX(t=0,s=0){this.a+=s*this.c+t*this.e,this.b+=s*this.d+t*this.f}skewY(t=0,s=0){this.c+=t*this.a+s*this.e,this.d+=t*this.b+s*this.f}skewZ(t=0,s=0){this.e+=t*this.a+s*this.c,this.f+=t*this.b+s*this.d}skew(t=0,s=0,r=0,n=0,o=0,u=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=a+s*c+t*e,this.b=b+s*d+t*f,this.c=c+r*a+n*e,this.d=d+r*b+n*f,this.e=e+o*a+u*c,this.f=f+o*b+u*d}transform(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=this.a,o=this.b,u=this.c,p=this.d,m=this.e,v=this.f;this.a=n*a+u*b+m*c,this.b=o*a+p*b+v*c,this.c=n*d+u*e+m*f,this.d=o*d+p*e+v*f,this.e=n*t+u*h+m*i,this.f=o*t+p*h+v*i,this.g+=n*s+u*r+m*l,this.h+=o*s+p*r+v*l}box(x=0,y=0,z=0,w=1,h=w,d=w){this.g+=x*this.a+y*this.c+z*this.e,this.h+=x*this.b+y*this.d+z*this.f,this.a*=w,this.b*=w,this.c*=h,this.d*=h,this.e*=d,this.f*=d}point(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.c*y+this.e*z+this.g,y:this.b*x+this.d*y+this.f*z+this.h}}metric(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.c*y+this.e*z,y:this.b*x+this.d*y+this.f*z}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h}=this;for(const{x:x,y:y,z:z}of t)Y.push(a*x+c*y+e*z+s,b*x+d*y+f*z+h);return V()}}class J{constructor(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l}sub(){return new J(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}subPersp(t=0,s=1){return new J(this.a,this.b,this.c,this.d,this.e,this.f,this.j*s+this.g,this.k*s+this.h,this.l*s+this.i,this.j*t,this.k*t,this.l*t)}sub2dXY(){return new q(this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dZY(){return new q(this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(){return new q(this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.j=t.j,this.k=t.k,this.l=t.l}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l}project(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z=0}=x);let t=this.c*x+this.f*y+this.i*z+this.l;return t<=0?{x:NaN,y:NaN}:(t=1/t,{x:(this.a*x+this.d*y+this.g*z+this.j)*t,y:(this.b*x+this.e*y+this.h*z+this.k)*t})}unproject(x=0,y=0){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this;x-=this.j,y-=this.k;const z=1-this.l,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(t*f-i*d)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(t*b-h*a)*z)*o,z:(n*x+(d*c-f*a)*y+(a*e-b*d)*z)*o}}perspectiveOrigin(){const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=this,n=e*i-f*h,o=c*h-b*i,u=b*f-c*e,p=-1/(a*n+d*o+t*u);return{x:(n*s+(t*f-i*d)*r+(d*h-e*t)*l)*p,y:(o*s+(a*i-c*t)*r+(t*b-h*a)*l)*p,z:(u*s+(d*c-f*a)*r+(a*e-b*d)*l)*p}}perspectiveRay(x=0,y=0,t=null){"object"==typeof x&&({x:x,y:y}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h,i:i,j:r,k:n,l:l}=this,o=e*i-f*h,u=c*h-b*i,p=b*f-c*e,m=1/(a*o+d*u+s*p),v=s*f-i*d,A=a*i-c*s,g=d*c-f*a,R=d*h-e*s,G=s*b-h*a,T=a*e-b*d;t&&(t.x=-(o*r+v*n+R*l)*m,t.y=-(u*r+A*n+G*l)*m,t.z=-(p*r+g*n+T*l)*m);const z=1-this.l,E=(o*x+v*y+R*z)*m,L=(o*x+v*y+R*z)*m,B=(o*x+v*y+R*z)*m,N=1/sqrt(E*E+L*L+B*B);return{x:E*N,y:L*N,z:B*N}}translate(x=0,y=0,z=0){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i}scale(x=1,y=x,z=x){this.a*=x,this.b*=x,this.c*=x,this.d*=y,this.e*=y,this.f*=y,this.g*=z,this.h*=z,this.i*=z}rotateXZ(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,g:u,h:h,i:i}=this;this.a=o*a-n*u,this.g=o*u+n*a,this.b=o*b-n*h,this.h=o*h+n*b,this.c=o*c-n*i,this.i=o*i+n*c}rotateXY(t){let n=r(t),o=s(t);const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=o*a-n*d,this.d=o*d+n*a,this.b=o*b-n*e,this.e=o*e+n*b,this.c=o*c-n*f,this.f=o*f+n*c}rotateZY(t){let n=r(t),o=s(t);const{d:d,e:e,f:f,g:u,h:h,i:i}=this;this.g=o*u-n*d,this.d=o*d+n*u,this.h=o*h-n*e,this.e=o*e+n*h,this.i=o*i-n*f,this.f=o*f+n*i}multiplyXZ(x=1,y=0){const{a:a,b:b,c:c,g:t,h:h,i:i}=this;this.a=x*a-y*t,this.g=x*t+y*a,this.b=x*b-y*h,this.h=x*h+y*b,this.c=x*c-y*i,this.i=x*i+y*c}multiplyXY(x=1,y=0){const{a:a,b:b,c:c,d:d,e:e,f:f}=this;this.a=x*a-y*d,this.d=x*d+y*a,this.b=x*b-y*e,this.e=x*e+y*b,this.c=x*c-y*f,this.f=x*f+y*c}multiplyZY(x=1,y=0){const{d:d,e:e,f:f,g:t,h:h,i:i}=this;this.g=x*t-y*d,this.d=x*d+y*t,this.h=x*h-y*e,this.e=x*e+y*h,this.i=x*i-y*f,this.f=x*f+y*i}skewX(t=0,s=0){this.a+=s*this.d+t*this.g,this.b+=s*this.e+t*this.h,this.c+=s*this.f+t*this.i}skewY(t=0,s=0){this.d+=t*this.a+s*this.g,this.e+=t*this.b+s*this.h,this.f+=t*this.c+s*this.i}skewZ(t=0,s=0){this.g+=t*this.a+s*this.d,this.h+=t*this.b+s*this.e,this.i+=t*this.c+s*this.f}skew(t=0,s=0,r=0,n=0,o=0,u=0){const{a:a,b:b,c:c,d:d,e:e,f:f,g:p,h:h,i:i}=this;this.a=a+s*d+t*p,this.b=b+s*e+t*h,this.c=c+s*f+t*i,this.d=d+r*a+n*p,this.e=e+r*b+n*h,this.f=f+r*c+n*i,this.g=p+o*a+u*d,this.h=h+o*b+u*e,this.i=i+o*c+u*f}transform(a,b,c,d,e,f,t,h,i,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a);const n=this.a,o=this.b,u=this.c,p=this.d,m=this.e,v=this.f,A=this.g,g=this.h,R=this.i;this.a=n*a+p*b+A*c,this.b=o*a+m*b+g*c,this.c=u*a+v*b+R*c,this.d=n*d+p*e+A*f,this.e=o*d+m*e+g*f,this.f=u*d+v*e+R*f,this.g=n*t+p*h+A*i,this.h=o*t+m*h+g*i,this.i=u*t+v*h+R*i,this.j+=n*s+p*r+A*l,this.k+=o*s+m*r+g*l,this.l+=u*s+v*r+R*l}box(x=0,y=0,z=0,w=1,h=w,d=w){this.j+=x*this.a+y*this.d+z*this.g,this.k+=x*this.b+y*this.e+z*this.h,this.l+=x*this.c+y*this.f+z*this.i,this.a*=w,this.b*=w,this.c*=w,this.d*=h,this.e*=h,this.f*=h,this.g*=d,this.h*=d,this.i*=d}point(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.d*y+this.g*z+this.j,y:this.b*x+this.e*y+this.h*z+this.k,z:this.c*x+this.f*y+this.i*z+this.l}}metric(x=0,y=0,z=0){return"object"==typeof x&&({x:x,y:y,z:z}=x),{x:this.a*x+this.d*y+this.g*z,y:this.b*x+this.e*y+this.h*z,z:this.c*x+this.f*y+this.i*z}}pointFrom(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*(x-=this.j)+(f*t-d*i)*(y-=this.k)+(d*h-e*t)*(z-=this.l))*o,y:(r*x+(a*i-c*t)*y+(b*t-a*h)*z)*o,z:(n*x+(c*d-a*f)*y+(a*e-b*d)*z)*o}}metricFrom(x=0,y=0,z=0){"object"==typeof x&&({x:x,y:y,z:z}=x);const{a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=this,s=e*i-f*h,r=c*h-b*i,n=b*f-c*e,o=1/(a*s+d*r+t*n);return{x:(s*x+(f*t-d*i)*y+(d*h-e*t)*z)*o,y:(r*x+(a*i-c*t)*y+(b*t-a*h)*z)*o,z:(n*x+(c*d-a*f)*y+(a*e-b*d)*z)*o}}loopBoundary(t=null){const{a:a,b:b,c:c,d:d,e:e,f:f,g:s,h:h,i:i,j:r,k:n,l:l}=this;for(const{x:x,y:y,z:z}of t)Y.push(a*x+d*y+s*z+r,b*x+e*y+h*z+n,1/(c*x+f*y+i*z+l));return Z()}}$.Transform2D=H,$.Transform2D.Perspective=q,$.Transform3D=W,$.Transform3D.Perspective=J;const $G=ArrayBuffer.prototype.transfer?t=>{const s=i;return(i=s+t)>$I.length&&($I=new Int32Array($I.buffer.transfer(8*i)),$i=new Float32Array($I.buffer)),s}:t=>{const s=i;if((i=s+t)>$I.length){const t=$I;($I=new Int32Array(2*i)).set(t,0),$i=new Float32Array($I.buffer)}return s};class K extends H{set shader($s){this.N="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,it==this&&(it=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||yt,it==this&&(it=null)}constructor(t,s=290787599,r=yt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.M=s,this.S=r,this.N=n}getTransform(){return new H(this.a,this.b,this.c,this.d,this.e,this.f)}sub(){return new K(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f)}subPersp(){return new Q(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,0,0,1)}sub3d(){return new tt(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,0,0,this.e,this.f)}sub3dPersp(t=0,s=1){return new st(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,0,this.c,this.d,0,this.e*s,this.f*s,s,this.e*t,this.f*t,t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.M=290787599,this.N=$.Shader.DEFAULT,this.S=yt}pixelRatio(){return sqrt(abs(this.a*this.d-this.b*this.c)*this.t.w*this.t.h)}draw(...t){const i=this.N(6,t);$i[i]=this.e,$i[i+1]=this.a,$i[i+2]=this.c,$i[i+3]=this.f,$i[i+4]=this.b,$i[i+5]=this.d}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.N(6,t);$i[i]=this.e+x*this.a+y*this.c,$i[i+1]=this.a*w,$i[i+2]=this.c*h,$i[i+3]=this.f+x*this.b+y*this.d,$i[i+4]=this.b*w,$i[i+5]=this.d*h}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.N(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*e+n*f+u,$i[i+1]=s*a+n*b,$i[i+2]=s*c+n*d,$i[i+3]=r*e+o*f+p,$i[i+4]=r*a+o*b,$i[i+5]=r*c+o*d}drawv(t){const i=this.N(6,t);$i[i]=this.e,$i[i+1]=this.a,$i[i+2]=this.c,$i[i+3]=this.f,$i[i+4]=this.b,$i[i+5]=this.d}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.N(6,t);$i[i]=this.e+x*this.a+y*this.c,$i[i+1]=this.a*w,$i[i+2]=this.c*h,$i[i+3]=this.f+x*this.b+y*this.d,$i[i+4]=this.b*w,$i[i+5]=this.d*h}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.N(6,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f;$i[i]=s*e+n*f+u,$i[i+1]=s*a+n*b,$i[i+2]=s*c+n*d,$i[i+3]=r*e+o*f+p,$i[i+4]=r*a+o*b,$i[i+5]=r*c+o*d}}class Q extends q{set shader($s){this.N="function"==typeof $s&&!1===$s.three?$s:$.Shader.DEFAULT,it==this&&(it=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||yt,it==this&&(it=null)}constructor(t,s=290787599,r=yt,n=$.Shader.DEFAULT,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=0){super(a,b,c,d,e,f,o,h,i),this.t=t,this.M=s,this.S=r,this.N=n}getTransform(){return new q(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}sub(){return new Q(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}subPersp(){return this.sub()}sub3d(){return new st(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}sub3dPersp(t=0,s=1){return new st(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,this.g*s,this.h*s,this.i*s,this.g*t,this.h*t,this.i*t)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.M=290787599,this.N=$.Shader.DEFAULT,this.S=yt}pixelRatio(){const{i:i}=this,t=(this.a*i-this.g*this.c)*(this.e*i-this.h*this.f)-(this.d*i-this.g*this.f)*(this.b*i-this.h*this.c);return sqrt(abs(t)*this.t.w*this.t.h)/(i*i)}draw(...t){const i=this.N(9,t);$i[i]=this.g,$i[i+1]=this.a,$i[i+2]=this.d,$i[i+3]=this.h,$i[i+4]=this.b,$i[i+5]=this.e,$i[i+6]=this.i,$i[i+7]=this.c,$i[i+8]=this.f}drawRect(x=0,y=0,w=1,h=1,...t){const i=this.N(9,t);$i[i]=this.g+x*this.a+y*this.d,$i[i+1]=this.a*w,$i[i+2]=this.d*h,$i[i+3]=this.h+x*this.b+y*this.e,$i[i+4]=this.b*w,$i[i+5]=this.e*h,$i[i+6]=this.i+x*this.c+y*this.f,$i[i+7]=this.c*w,$i[i+8]=this.f*h}drawMat(a=1,b=0,c=0,d=1,e=0,f=0,...t){const i=this.N(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,m=this.g,v=this.h,A=this.i;$i[i]=s*e+o*f+m,$i[i+1]=s*a+o*b,$i[i+2]=s*c+o*d,$i[i+3]=r*e+u*f+v,$i[i+4]=r*a+u*b,$i[i+5]=r*c+u*d,$i[i+6]=n*e+p*f+A,$i[i+7]=n*a+p*b,$i[i+8]=n*c+p*d}drawv(t){const i=this.N(9,t);$i[i]=this.g,$i[i+1]=this.a,$i[i+2]=this.d,$i[i+3]=this.h,$i[i+4]=this.b,$i[i+5]=this.e,$i[i+6]=this.i,$i[i+7]=this.c,$i[i+8]=this.f}drawRectv(x=0,y=0,w=1,h=1,t){const i=this.N(9,t);$i[i]=this.g+x*this.a+y*this.d,$i[i+1]=this.a*w,$i[i+2]=this.d*h,$i[i+3]=this.h+x*this.b+y*this.e,$i[i+4]=this.b*w,$i[i+5]=this.e*h,$i[i+6]=this.i+x*this.c+y*this.f,$i[i+7]=this.c*w,$i[i+8]=this.f*h}drawMatv(a=1,b=0,c=0,d=1,e=0,f=0,t){const i=this.N(9,t),s=this.a,r=this.b,n=this.c,o=this.d,u=this.e,p=this.f,m=this.g,v=this.h,A=this.i;$i[i]=s*e+o*f+m,$i[i+1]=s*a+o*b,$i[i+2]=s*c+o*d,$i[i+3]=r*e+u*f+v,$i[i+4]=r*a+u*b,$i[i+5]=r*c+u*d,$i[i+6]=n*e+p*f+A,$i[i+7]=n*a+p*b,$i[i+8]=n*c+p*d}}class tt extends W{set shader($s){this.N="function"==typeof $s&&!0===$s.three?$s:$.Shader.COLOR_3D_XZ,it==this&&(it=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||pt,it==this&&(it=null)}constructor(t,s=290787599,r=pt,n=$.Shader.COLOR_3D_XZ,a=1,b=0,c=0,d=1,e=0,f=0,o=0,h=0){super(a,b,c,d,e,f,o,h),this.t=t,this.M=s,this.S=r,this.N=n}getTransform(){return new W(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}sub(){return new tt(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}subPersp(t=0,s=1){return new st(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,0,this.c,this.d,0,this.g*s+this.e,this.h*s+this.f,s,this.g*t,this.h*t,t)}sub2dXY(){return new K(this.t,this.M,yt,$.Shader.DEFAULT,this.a,this.b,this.c,this.d,this.g,this.h)}sub2dZY(){return new K(this.t,this.M,yt,$.Shader.DEFAULT,this.e,this.f,this.c,this.d,this.g,this.h)}sub2dXZ(){return new K(this.t,this.M,yt,$.Shader.DEFAULT,this.a,this.b,this.e,this.f,this.g,this.h)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=1,e=0,f=0,t=0,h=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.M=290787599,this.N=$.Shader.COLOR_3D_XZ,this.S=pt}draw(...t){const s=this.N(8,t);$i[s]=this.g,$i[s+1]=this.a,$i[s+2]=this.c,$i[s+3]=this.e,$i[s+4]=this.h,$i[s+5]=this.b,$i[s+6]=this.d,$i[s+7]=this.f}drawCube(x=0,y=0,z=0,t=1,s=1,r=1,...n){const o=this.N(8,n),{a:a,b:b,c:c,d:d,e:e,f:f}=this;$i[o]=this.g+x*a+y*c+z*e,$i[o+1]=a*t,$i[o+2]=c*s,$i[o+3]=e*r,$i[o+4]=this.h+x*b+y*d+z*f,$i[o+5]=b*t,$i[o+6]=d*s,$i[o+7]=f*r}drawMat(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,...n){const o=this.N(8,n),u=this.a,p=this.b,m=this.c,v=this.d,A=this.e,g=this.f;$i[o]=this.g+u*s+m*r+A*l,$i[o+1]=u*a+m*b+A*c,$i[o+2]=u*d+m*e+A*f,$i[o+3]=u*t+m*h+A*i,$i[o+4]=this.h+p*s+v*r+g*l,$i[o+5]=p*a+v*b+g*c,$i[o+6]=p*d+v*e+g*f,$i[o+7]=p*t+v*h+g*i}drawv(t){const s=this.N(8,t);$i[s]=this.g,$i[s+1]=this.a,$i[s+2]=this.c,$i[s+3]=this.e,$i[s+4]=this.h,$i[s+5]=this.b,$i[s+6]=this.d,$i[s+7]=this.f}drawCubev(x=0,y=0,z=0,t=1,s=1,r=1,n){const o=this.N(8,n),{a:a,b:b,c:c,d:d,e:e,f:f}=this;$i[o]=this.g+x*a+y*c+z*e,$i[o+1]=a*t,$i[o+2]=c*s,$i[o+3]=e*r,$i[o+4]=this.h+x*b+y*d+z*f,$i[o+5]=b*t,$i[o+6]=d*s,$i[o+7]=f*r}drawMatv(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,n){const o=this.N(8,n),u=this.a,p=this.b,m=this.c,v=this.d,A=this.e,g=this.f;$i[o]=this.g+u*s+m*r+A*l,$i[o+1]=u*a+m*b+A*c,$i[o+2]=u*d+m*e+A*f,$i[o+3]=u*t+m*h+A*i,$i[o+4]=this.h+p*s+v*r+g*l,$i[o+5]=p*a+v*b+g*c,$i[o+6]=p*d+v*e+g*f,$i[o+7]=p*t+v*h+g*i}}class st extends J{set shader($s){this.N="function"==typeof $s&&!0===$s.three?$s:$.Shader.COLOR_3D_XZ,it==this&&(it=null)}get shader(){return this.N}get geometry(){return this.S}set geometry(a){this.S=a||pt,it==this&&(it=null)}constructor(t,s=290787599,r=pt,n=$.Shader.COLOR_3D_XZ,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.M=s,this.S=r,this.N=n}getTransform(){return new J(this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}sub(){return new st(this.t,this.M,this.S,this.N,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}subPersp(t=0,s=1){return new st(this.t,this.M,$.Geometry3D.CUBE,$.Shader.COLOR_3D_XZ,this.a,this.b,this.c,this.d,this.e,this.f,this.j*s+this.g,this.k*s+this.h,this.l*s+this.i,this.j*t,this.k*t,this.l*t)}sub2dXY(){return new Q(this.t,this.M,yt,$.Shader.DEFAULT,this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dZY(){return new Q(this.t,this.M,yt,$.Shader.DEFAULT,this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(){return new Q(this.t,this.M,yt,$.Shader.DEFAULT,this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}resetTo(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this.g=t.g,this.h=t.h,this.i=t.i,this.j=t.j,this.k=t.k,this.l=t.l,this.M=t.M,this.N=t.N,this.S=t.S}reset(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0){"object"==typeof a&&({a:a,b:b,c:c,d:d,e:e,f:f,g:t,h:h,i:i,j:s,k:r,l:l}=a),this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f,this.g=t,this.h=h,this.i=i,this.j=s,this.k=r,this.l=l,this.M=290787599,this.N=$.Shader.COLOR_3D_XZ,this.S=pt}draw(...t){const s=this.N(12,t);$i[s]=this.j,$i[s+1]=this.a,$i[s+2]=this.d,$i[s+3]=this.g,$i[s+4]=this.k,$i[s+5]=this.b,$i[s+6]=this.e,$i[s+7]=this.h,$i[s+8]=this.l,$i[s+9]=this.c,$i[s+10]=this.f,$i[s+11]=this.i}drawCube(x=0,y=0,z=0,t=1,s=1,r=1,...n){const o=this.N(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=this.j+x*a+y*d+z*u,$i[o+1]=a*t,$i[o+2]=d*s,$i[o+3]=u*r,$i[o+4]=this.k+x*b+y*e+z*h,$i[o+5]=b*t,$i[o+6]=e*s,$i[o+7]=h*r,$i[o+8]=this.l+x*c+y*f+z*i,$i[o+9]=c*t,$i[o+10]=f*s,$i[o+11]=i*r}drawMat(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,...n){const o=this.N(12,n),u=this.a,p=this.b,m=this.c,v=this.d,A=this.e,g=this.f,R=this.g,G=this.h,T=this.i;$i[o]=this.j+u*s+v*r+R*l,$i[o+1]=u*a+v*b+R*c,$i[o+2]=u*d+v*e+R*f,$i[o+3]=u*t+v*h+R*i,$i[o+4]=this.k+p*s+A*r+G*l,$i[o+5]=p*a+A*b+G*c,$i[o+6]=p*d+A*e+G*f,$i[o+7]=p*t+A*h+G*i,$i[o+8]=this.l+m*s+g*r+T*l,$i[o+9]=m*a+g*b+T*c,$i[o+10]=m*d+g*e+T*f,$i[o+11]=m*t+g*h+T*i}drawv(t){const s=this.N(12,t);$i[s]=this.j,$i[s+1]=this.a,$i[s+2]=this.d,$i[s+3]=this.g,$i[s+4]=this.k,$i[s+5]=this.b,$i[s+6]=this.e,$i[s+7]=this.h,$i[s+8]=this.l,$i[s+9]=this.c,$i[s+10]=this.f,$i[s+11]=this.i}drawCubev(x=0,y=0,z=0,t=1,s=1,r=1,n){const o=this.N(12,n),{a:a,b:b,c:c,d:d,e:e,f:f,g:u,h:h,i:i}=this;$i[o]=this.j+x*a+y*d+z*u,$i[o+1]=a*t,$i[o+2]=d*s,$i[o+3]=u*r,$i[o+4]=this.k+x*b+y*e+z*h,$i[o+5]=b*t,$i[o+6]=e*s,$i[o+7]=h*r,$i[o+8]=this.l+x*c+y*f+z*i,$i[o+9]=c*t,$i[o+10]=f*s,$i[o+11]=i*r}drawMatv(a=1,b=0,c=0,d=0,e=1,f=0,t=0,h=0,i=1,s=0,r=0,l=0,n){const o=this.N(12,n),u=this.a,p=this.b,m=this.c,v=this.d,A=this.e,g=this.f,R=this.g,G=this.h,T=this.i;$i[o]=this.j+u*s+v*r+R*l,$i[o+1]=u*a+v*b+R*c,$i[o+2]=u*d+v*e+R*f,$i[o+3]=u*t+v*h+R*i,$i[o+4]=this.k+p*s+A*r+G*l,$i[o+5]=p*a+A*b+G*c,$i[o+6]=p*d+A*e+G*f,$i[o+7]=p*t+A*h+G*i,$i[o+8]=this.l+m*s+g*r+T*l,$i[o+9]=m*a+g*b+T*c,$i[o+10]=m*d+g*e+T*f,$i[o+11]=m*t+g*h+T*i}}const x=Object.getOwnPropertyDescriptors({get width(){return this.t.w},get height(){return this.t.h},get identity(){return this.t},set mask(t){this.M=-256&this.M|255&t,it==this&&(it=null)},get mask(){return 255&this.M},set blend(b){this.M=255&this.M|(b||1135889)<<8,it==this&&(it=null)},get blend(){return this.M>>8},V(){if(it==this)return!1;const{t:t,M:s}=this,r=t._;let d=E^s;if(curt!=t&&(i&&draw(),curt&&curt._==t._||(d|=240),N!=t.$&&_.bindFramebuffer(36009,N=t.$),_.viewport(0,0,t.w,t.h),curt=t),d){if(i&&draw(),15&d&&_.colorMask(1&s,2&s,4&s,8&s),240&d)if(240&s){240&E||_.enable(2960),_.stencilMask(1<<r),_.stencilFunc(32&s?16&s?512:517:16&s?514:519,255,1<<r);const t=128&s?64&s?5386:7681:64&s?0:7680;_.stencilOp(t,t,t)}else 240&E&&_.disable(2960);1996488704&d&&_.blendEquationSeparate(32773+(s>>24&7),32773+(s>>28&7)),16776960&d&&_.blendFuncSeparate((s>>8&15)+766*!!(3584&s),(s>>16&15)+766*!!(917504&s),(s>>12&15)+766*!!(57344&s),(s>>20&15)+766*!!(14680064&s)),-2147483648&d&&(-2147483648&s?_.enable(32926):_.disable(32926)),E=s}return it=this,!0},setTarget(t=0,s=null,l=0,r=0){const{t:n}=this;if(n.$){if(i&&draw(),it==this&&(it=null),N!=n.$&&(_.bindFramebuffer(36009,N=n.$),curt=it=null),!s){if(!n.u)return;return _.framebufferRenderbuffer(36009,36064+t,36161,null),void((n.u&=~(1<<t))||(n.w=n.h=0,_.framebufferRenderbuffer(36009,36128,36161,null)))}if((n.u&=~(1<<t))||(n.w=n.h=0),n.w){if(n.w!=s.width||n.h!=s.height)return}else n.w=s.width,n.h=s.height,n.T&&(_.bindRenderbuffer(36161,n.T),_.renderbufferStorage(36161,36168,n.w,n.h),_.framebufferRenderbuffer(36009,36128,36161,n.T));n.u|=1<<t,s.msaa?_.framebufferRenderbuffer(36009,36064+t,36161,s.p):_.framebufferTextureLayer(36009,36064+t,s.t.p,l,r)}},clearTargets(){const{t:s}=this;if(!s.$)return;i&&draw(),it==this&&(it=null);let r=s.u;if(s.u=s.w=s.h=0,s.T&&(_.framebufferRenderbuffer(36009,36128,36161,null),_.deleteRenderbuffer(s.T),s.T=_.createRenderbuffer()),r)for(N!=s.$&&(_.bindFramebuffer(36009,N=s.$),curt=it=null);r;){const s=31-t(r);r&=~(1<<s),_.framebufferRenderbuffer(36009,36064+s,36161,null)}},get hasStencil(){return this.t.$?!!this.t.T:!!(1&v)},set hasStencil(t){let{t:s}=this,b=s.T;s.$&&!t!=!b&&(i&&draw(),it==this&&(it=null),s.T=b=b?(_.deleteRenderbuffer(b),null):_.createRenderbuffer(),s.w&&(N!=s.$&&(_.bindFramebuffer(36009,N=s.$),curt=it=null),b?(_.bindRenderbuffer(36161,b),_.renderbufferStorage(36161,36168,s.w,s.h),_.framebufferRenderbuffer(36009,36128,36161,b)):_.framebufferRenderbuffer(36009,36128,36161,null)))},clear(t=0,s=t,b=t,a=s){"object"==typeof t&&(a=t.w??0,b=t.z??0,s=t.y,t=t.x),i&&draw(),this.V()&&(it=null),_.clearColor(t,s,b,a);const r=this.t._=this.t._+1&7;_.clear(r?16384:(_.stencilMask(255),17408)),bt++,_.disable(2960),E&=-241},clearStencil(){i&&draw(),this.V()&&(it=null);(this.t._=this.t._+1&7)||(_.stencilMask(255),_.clear(1024)),_.disable(2960),E&=-241},delete(){i&&draw();const{t:t}=this;t.$&&(_.deleteFramebuffer(t.$),N==t.$&&(_.bindFramebuffer(36009,N=null),it=null),t.T&&_.deleteRenderbuffer(t.T))},perspective:!1});Object.defineProperties(K.prototype,x),Object.defineProperties(st.prototype,x),Object.defineProperties(Q.prototype,x),st.prototype.perspective=Q.prototype.perspective=!0,Object.defineProperties(tt.prototype,x),Object.assign($.Blend=(t=17,s=17,r=0,n=!1)=>t|r<<8|s<<16|n<<23,{REPLACE:1114129,DEFAULT:1135889,ADD:1118465,MULTIPLY:1122816,MULTIPLY_MIX:1136008,SUBTRACT:5574913,REVERSE_SUBTRACT:7737601,MIN:2232593,MAX:3346705,BEHIND:1118583,INVERT:1127321});let it=null;function draw(b=$x){if(_.bufferData(34962,$I.subarray(0,i),35040),wt+=i,i/=$u,bt++,$t+=i,P?_.drawElementsInstanced(7&F,j,P,S,i):_.drawArraysInstanced(7&F,S,j,i),i=0,$X=b,Rt.length){At??=Rt[0];for(const f of Rt)f.sync=_.fenceSync(37143,0),gt=gt?gt.next=f:f;Rt.length=0}}const ht=(f,t,e)=>{if(e<=t+1)return f(t);const s=t+(e-t>>1);return`if(u<${s}){${ht(f,t,s)}}else{${ht(f,s,e)}}`},et=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"],rt=_.getParameter(34921);function $H(t,s,r,c){$s=t,L=s,B=r,$u=c}function $l(t){_.bindVertexArray($v=t)}const $C=new Float32Array(4),$c=new Int32Array($C.buffer),nt=(t,s,$D=[])=>{s="number"==typeof s?[s]:s||[];let r=0;const n=[],o=[],u=[],p=[],m=[""];let v=2+t,A=0,g=2+t,R=2+t;for(const t of s){if((15&t)>=12)throw"Vertex parameter cannot be a texture";const s=1+(3&t),G=et[3&t|(t>>4&15)<<2],T=t>15;$D[r]??=1==s?0:2==s?C:3==s?D:M,p.push(`${r}:a${r}=$D[${r}]`);const E=(63&t)>13?"$I[i+":"$i[i+";if(1==s)m.push(E+R+"]=a"+r);else for(let t=0;t<s;t++)m.push(E+(R+t)+"]=a"+r+"."+"xyzw"[t]);const L=""+(v>>2),B=3&v,N=3&(v+=s)||4;let F=T?A:g;const S=3&F,j=3&(F+=s)||4;T?A=F:g=F;let P="";if(N<=(B||4)){const t=(v>>2)-(s==4+B);o.push(`layout(location=${rt-1-t})in uvec4 o${t};`)}P=N<=B?`uvec${s}(o${L}.${"xyzw".slice(B,4)},o${v>>2}.${"xyzw".slice(0,N)})`:4==N&&0==B?"v"+L:`o${L}.`+"xyzw".slice(B,N),T||(P=`uintBitsToFloat(${P})`);const I=`GL_${T?"V":"v"}${L}.`;if(j<=(S||4)&&o.push(`${T?"flat out u":"out "}vec4 ${(T?"GL_V":"GL_v")+((F>>2)-(s==4+S))};`),j<=S){const o=(T?"GL_V":"GL_v")+(F>>2),p=`${T?"u":""}vec${s}(${I+"xyzw".slice(S)},${o+"."+"xyzw".slice(0,j)})`;n.push(`${T?"flat in u":"in "}vec4 ${o};\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${p})`:p}\n`),u.push(`${G} t${r}=${P};${I+"xyzw".slice(S)}=t${r}.${"xyzw".slice(0,4-S)};${o}.${"xyzw".slice(0,j)}=t${r}.${"xyzw".slice(4-S,s)};`)}else{const s=I+"xyzw".slice(S,j);n.push(`\n#define vparam${L} ${t>=64&&t<80?`uintBitsToFloat(${s})`:s}\n`),u.push(`${I+"xyzw".slice(S,j)}=${P};`)}R+=s,r++}m[0]=`let{i,$i,$I}=this;if((this.i=i+${R})>$i.length){${ArrayBuffer.prototype.transfer?`$I=this.$I=new Int32Array($I.buffer.transfer(i+${R}<<3))`:`const oa=$I;$I=this.$I=new Int32Array(i+${R}<<1);$I.set(oa,0)`};$i=this.$i=new Float32Array($I.buffer)}`,m.push("return i"),A&&(o.push("flat out uvec4 GL_V0;"),n.push("flat in uvec4 GL_V0;"));const G=eval(`(function({${p}}){${m.join(";")}})`);return{three:t,F:G,S:R,fsh:n.join(""),vsh:o.join(""),vshb:u.join("")}};class ot extends H{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=1,e=0,f=0){super(a,b,c,d,e,f),this.t=t,this.P=s,this.I=r,this.O=n}sub(t=this.t.U,s=0,r=this.O){return new ot(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f)}sub3d(t=this.t.U,s=0,r=this.O){return new at(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,0,0,this.e,this.f)}addPoint(x,y,...t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.U++}add(...t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.U++}addPointv(x,y,t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+this.e,$i[i+1]=x*this.b+y*this.d+this.f,s.U++}addv(t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=this.e,$i[i+1]=this.f,s.U++}}class ut extends q{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1){super(a,b,c,d,e,f,o,h,i),this.t=t,this.P=s,this.I=r,this.O=n}sub(t=this.t.U,s=0,r=this.O){return new ut(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i)}sub3d(t=this.t.U,s=0,r=this.O){return new lt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,0,0,0,this.g,this.h,this.i)}addPoint(x,y,...t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+this.g,$i[i+1]=x*this.b+y*this.e+this.h,$i[i+2]=x*this.c+y*this.f+this.i,s.U++}add(...t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,$i[i+2]=this.i,s.U++}addPointv(x,y,t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+this.g,$i[i+1]=x*this.b+y*this.e+this.h,$i[i+2]=x*this.c+y*this.f+this.i,s.U++}addv(t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,$i[i+2]=this.i,s.U++}}class at extends W{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=1,e=0,f=0,o=0,h=0){super(a,b,c,d,e,f,o,h),this.t=t,this.P=s,this.I=r,this.O=n}sub(t=this.t.U,s=0,r=this.O){return new at(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h)}sub2dXY(t=this.t.U,s=0,r=this.O){return new ot(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.g,this.h)}sub2dXZ(t=this.t.U,s=0,r=this.O){return new ot(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.e,this.f,this.g,this.h)}sub2dZY(t=this.t.U,s=0,r=this.O){return new ot(this.t,t>>>0,s>>>0,63&r,this.e,this.f,this.c,this.d,this.g,this.h)}addPoint(x,y,z,...t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+z*this.e+this.g,$i[i+1]=x*this.b+y*this.d+z*this.f+this.h,s.U++}add(...t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,s.U++}addPointv(x,y,z,t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.c+z*this.e+this.g,$i[i+1]=x*this.b+y*this.d+z*this.f+this.h,s.U++}addv(t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=this.g,$i[i+1]=this.h,s.U++}}class lt extends J{constructor(t,s=0,r=0,n=5,a=1,b=0,c=0,d=0,e=1,f=0,o=0,h=0,i=1,u=0,p=0,l=0){super(a,b,c,d,e,f,o,h,i,u,p,l),this.t=t,this.P=s,this.I=r,this.O=n}sub(t=this.t.U,s=0,r=this.O){return new lt(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.g,this.h,this.i,this.j,this.k,this.l)}sub2dXY(t=this.t.U,s=0,r=this.O){return new ut(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.d,this.e,this.f,this.j,this.k,this.l)}sub2dXZ(t=this.t.U,s=0,r=this.O){return new ut(this.t,t>>>0,s>>>0,63&r,this.a,this.b,this.c,this.g,this.h,this.i,this.j,this.k,this.l)}sub2dZY(t=this.t.U,s=0,r=this.O){return new ut(this.t,t>>>0,s>>>0,63&r,this.g,this.h,this.i,this.d,this.e,this.f,this.j,this.k,this.l)}addPoint(x,y,z,...t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.U++}add(...t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.U++}addPointv(x,y,z,t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=x*this.a+y*this.d+z*this.g+this.j,$i[i+1]=x*this.b+y*this.e+z*this.h+this.k,$i[i+2]=x*this.c+y*this.f+z*this.i+this.l,s.U++}addv(t){const{t:s}=this,i=s.F(t),{$i:$i}=s;return $i[i]=this.j,$i[i+1]=this.k,$i[i+2]=this.l,s.U++}}function $a(t){_.bindBuffer(34962,t.b);const s=rt-(t.S+3>>2);for(let i=rt-1,r=0;i>=s;i--,r+=16)_.enableVertexAttribArray(i),_.vertexAttribIPointer(i,i==s?3&t.S:4,5125,t.S<<2,r);_.enableVertexAttribArray(0),_.enableVertexAttribArray(1),_.vertexAttribDivisor(0,1),_.vertexAttribDivisor(1,1),_.vertexAttribDivisor(2,1),_.bindBuffer(34962,$M)}_.vertexAttrib4f(2,1,0,0,0);const y=Object.getOwnPropertyDescriptors({get size(){return this.t.U},get uploadCount(){return this.t.C},get vertex(){return this.t.vtx},S(){const{t:t}=this;i&&draw(),$p=this;const s=F>>4,r=(F=this.O)>>4;s!=r&&(r?(s||_.enable(2884),_.frontFace(2304+(r>>1))):_.disable(2884)),S=this.P,j=this.I,P=t.D},get end(){return this.P+this.I},set end(a){(a>>>=0)>=this.P?this.I=a-this.P:(this.I=this.P-a,this.P=a),$p==this&&this.S()},get start(){return this.P},set start(a){this.P=a>>>0,$p==this&&(i&&draw(),S=this.P)},get length(){return this.I},set length(a){this.I=a>>>0,$p==this&&(i&&draw(),j=this.I)},get type(){return this.O},set type(a){this.O=63&a,$p==this&&this.S()},get identity(){return this.t},upload(t=null){const{t:s}=this;if($p&&s==$p.t&&i&&draw(),t){let r=0;if(Array.isArray(t)){let s=0;for(const r of t)r>s&&(s=r);const $M=s>254?s>65534?new Uint32Array(t.length):new Uint16Array(t.length):new Uint8Array(t.length);$M.set(t,0),t=$M}r=5121+(262656>>(t.BYTES_PER_ELEMENT<<2)&15),s.D=r,_.bindVertexArray(s.v),_.bindBuffer(34963,s.E??=_.createBuffer()),_.bufferData(34963,t,35044),s.v?s.Ls||(s.Ls=1,$a(s)):_.bindBuffer(34963,null),_.bindVertexArray($v)}else s.v&&(_.bindVertexArray(s.v),s.Ls||(s.Ls=1,$a(s)),s.E&&_.bindBuffer(34963,null),_.bindVertexArray($v)),s.D=0,s.E&&(s.E.delete(),s.E=null);$p&&$p.t==s&&(P=s.D),_.bindBuffer(34962,s.b),_.bufferData(34962,s.$I.subarray(0,s.i),35044),_.bindBuffer(34962,$M),s.$i=ct,s.$I=ft,s.i=0,s.C=this.I=t?t.length:s.U,s.U=0,$p&&s==$p.t&&this.S()},export(){const{t:{$I:$I,i:t}}=this,s=new Uint8Array(4*t);for(let i=0;i<t;i++){const t=4*i,r=$I[i];s[t]=r>>24,s[t+1]=r>>16,s[t+2]=r>>8,s[t+3]=r}return s},import(f){f instanceof ArrayBuffer&&(f=new Uint8Array(f));const{t:t}=this;let{i:i,$I:$I}=t,l=i+(.25*f.length>>>0);if($I.length<l){if(ArrayBuffer.prototype.transfer)$I=t.$I=new Int32Array($I.buffer.transfer(4*l));else{const s=t.$I;$I=t.$I=new Int32Array(l),t.$I.set(s,0)}t.$i=new Float32Array(t.$I.buffer)}let s=0;for(;i<l;)$I[i++]=f[s++]<<24|f[s++]<<16|f[s++]<<8|f[s++];t.i=l},dup(){const{t:t}=this;if(!t.i)return-1;let i=t.i,s=i-t.S,{$I:$I}=t,r=t.i=i+t.S;if($I.length<r){if(ArrayBuffer.prototype.transfer)$I=t.$I=new Int32Array($I.buffer.transfer(8*r));else{const s=t.$I;$I=t.$I=new Int32Array(2*r),t.$I.set(s,0)}t.$i=new Float32Array(t.$I.buffer)}for(;i<r;)$I[i++]=$I[s++];return t.U++}}),ct=new Float32Array,ft=new Int32Array(ct.buffer);Object.defineProperties(ot.prototype,y),Object.defineProperties(ut.prototype,y),Object.defineProperties(at.prototype,y),Object.defineProperties(lt.prototype,y),$.Geometry2D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{F:r,S:n,three:o}=t??$.Geometry2D.Vertex.DEFAULT;if(o)return null;const $i=new Float32Array(16);return new ot({$i:$i,$I:new Int32Array($i.buffer),i:0,vtx:t,b:_.createBuffer(),F:r,S:n,U:0,C:0,v:null,E:null,D:0},0,0,s)},$.Geometry3D=(t=null,s=5)=>{"number"==typeof t&&(s=t,t=null);const{F:r,S:n,three:o}=t??$.Geometry3D.Vertex.DEFAULT;if(!o)return null;const $i=new Float32Array(16);return new lt({$i:$i,$I:new Int32Array($i.buffer),i:0,vtx:t,b:_.createBuffer(),F:r,S:n,U:0,C:0,v:_.createVertexArray(),L:null,Ls:0,E:null,D:0},0,0,s)},$.Geometry2D.Vertex=nt.bind(null,!1),$.Geometry3D.Vertex=nt.bind(null,!0);const yt=$.Geometry2D.SQUARE=$.Geometry2D($.Geometry2D.Vertex.DEFAULT=nt(!1,[]),5),pt=$.Geometry3D.CUBE=$.Geometry3D($.Geometry3D.Vertex.DEFAULT=nt(!0,[]),21);$.Geometry3D.Vertex.WITH_NORMALS=nt(!0,[$.VEC3]);for(let i=0;i<4;i++)yt.addPoint(1&i,i>>1&1),pt.addPoint(0,1&i,i>>1&1),pt.addPoint(1,1&i,i>>1&1);yt.upload(),pt.upload(new Uint8Array([4,6,0,2,3,6,7,4,5,0,1,3,5,7])),$.Geometry3D.INSIDE_CUBE=pt.sub(0,14,37),$.Geometry3D.XZ_FACE=pt.sub(7,4,21),$.Shader=(t,{params:s,defaults:$D,uniforms:r,uniformDefaults:$U,outputs:p=4,vertex:m=$.Geometry2D.Vertex.DEFAULT,intFrac:v=.5}={})=>{if(s="number"==typeof s?[s]:s||[],r="number"==typeof r?[r]:r||[],$D=void 0!==$D?Array.isArray($D)?[...$D]:[$D]:[],$U=void 0!==$U?Array.isArray($U)?[...$U]:[$U]:[],p="number"==typeof p?[p]:p||[],p.length>Drawable.MAX_TARGETS)throw`Too many shader outputs (Drawable.MAX_TARGETS == ${Drawable.MAX_TARGETS})`;const A=3+m.three,g=[],R=[""],G=[`#version 300 es\nprecision highp float;precision highp int;layout(location=0)in mat3x${A} m;layout(location=${rt-1})in uvec4 o0;out vec4 GL_v0;`],T=[`void main(){gl_Position.xyw=vec${A}(1.,GL_v0.xy${m.three?"z":""}=uintBitsToFloat(o0.xy${m.three?"z":""}))*m;gl_Position.xy=gl_Position.xy*2.-gl_Position.w;gl_Position.z=0.;gl_PointSize=1.;`],E=[`#version 300 es\nprecision highp float;precision highp int;in vec4 GL_v0;\n#define color color0\n#define i_depth gl_FragCoord.w\n#define pos GL_v0.xy${A>3?"z":""}\n`+p.map((t,i)=>`layout(location=${i})out ${t?16==t||32==t?"u":"lowp ":""}vec4 color${i};`).join(";"),""];let L=0,B=0,N=0,F=0;const S=[],j=(t=0)=>{const s=""+(F>>2),r=3&F,n=3&(F+=t)||4;if(n<=(r||4)){const s=(F>>2)-(t==4+r),n=""+s;G.push(`layout(location=${s+3})in uvec4 a${n};flat out uvec4 GL_a${n};`),E.push(`flat in uvec4 GL_a${n};`),T.push(`GL_a${n}=a${n};`)}if(n<=r){let o=`uvec${t}(GL_a${s}.`;for(let i=r;i<4;i++)o+="xyzw"[i];o+=`,GL_a${F>>2}.`;for(let i=0;i<n;i++)o+="xyzw"[i];return o+")"}if(4==n&&0==r)return"GL_a"+s;let o=`GL_a${s}.`;for(let i=r;i<n;i++)o+="xyzw"[i];return o};let P=0;for(const t of s){let s=1+(3&t);(15&t)>=12&&(L|=1<<s-1,(15&t)>13?N++:B++),$D[P]??=1==s?0:2==s?C:3==s?D:t>=28&&t<32?null:M,g.push(`${P}:a${P}=$D[${P}]`);const r=t>13?"$I[j+":"$i[j+",n=F;if(t>=12&&t<16){S.push(`let t${P}=-1;if(a${P}.t){if((t${P}=$m.auto(a${P}.t,${-(8==t)}))==-1){i&&draw(b^$X);t${P}=$m.auto(a${P}.t,${-(8==t)})}t${P}|=a${P}.l<<8}`);const o=j(1),u=j(2),p=j(2);E.push(`${4==t?"lowp ":8==t?"u":"highp "}vec4 param${P}(vec2 uv){int v=int(${o});if(v<0)return vec4(uintBitsToFloat(${u}),uintBitsToFloat(${p}));return ${4==t?"g":8==t?"uG":"fG"}etColor(v&255,vec3(uv*uintBitsToFloat(${p})+uintBitsToFloat(${u}),v>>8));}`),R.push(`$I[j+${n}]=t${P};if(t${P}>=0)$i[j+${n+1}]=a${P}.x,$i[j+${n+2}]=a${P}.y,$i[j+${n+3}]=a${P}.w,$i[j+${n+4}]=a${P}.h;else ${r}${n+1}]=a${P}.x,${r}${n+2}]=a${P}.y,${r}${n+3}]=a${P}.z,${r}${n+4}]=a${P}.w`),s=5}else{t>=28&&t<32&&(S.push(`let q${P}=$m.auto(a${P}.t,${-(t>29)});if(q${P}<0)i&&draw(b^$X),q${P}=$m.auto(a${P}.t,${-(t>29)})`),s=1);const o=j(s);if(E.push(`\n#define param${P} ${t<16?"uintBitsToFloat":t<32?et[3&t|4]:""}(${o})\n`),1==s)R.push(r+n+"]=a"+P);else for(let t=0;t<s;t++)R.push(r+(n+t)+"]=a"+P+"."+"xyzw"[t])}P++}E.push(m.fsh),G.push(m.vsh),T.push(m.vshb),P=0;const I=[],U=[""],X=[],k=[],Y=[];for(const t of r){const s=1+(3&t);if((15&t)>=12&&(L|=1<<s-1,(15&t)>13?N++:B++,n="int"),$U[P]??=1==s?0:2==s?C:3==s?D:t>=28&&t<32?null:M,I.push(`a${P}=$U[${P}]`),t>=28&&t<32)X.push(`_.uniform1i($L[${k.length}],s${Y.length}?$m.auto(s${Y.length},${-(t>29)}):-1)`),k.push("uni"+P),E.push(`uniform ${t>29?"u":""}sampler2DArray uni${P};`),U.push(`s${Y.length}=a${P}.t`),Y.push(`,s${Y.length}=null`);else if(t>=12&&t<16){const s="GL_u"+P,r="GL_U"+P,n="GL_L"+P;X.push(`if(s${Y.length})_.uniform1i($L[${k.length}],$m.auto(s${Y.length},${-(t>13)}))`),E.push(t>13?`uniform usampler2DArray ${s};uniform float ${n};uniform uvec4 ${r}; ${14==t?"i":"u"}vec4 uni${P}(vec2 uv){if(${n}<0.)return ${14==t?`ivec4(${r})`:r};return ${14==t?"i":"u"}GetColor(${s},vec3(uv*uintBitsToFloat(${r}.zw)+uintBitsToFloat(${r}.xy),${n}));}`:`uniform sampler2DArray ${s};uniform float ${n};uniform vec4 ${r}; ${12==t?"lowp ":""}vec4 uni${P}(vec2 uv){if(${n}<0.)return ${r};return texture(${s},vec3(uv*${r}.zw+${r}.xy,${n}));}`),U.push(`if(s${Y.length}=a${P}.t){_.uniform1f($L[${k.length+2}],a${P}.l);${t>13?`$C[0]=a${P}.x,$C[1]=a${P}.y,$C[2]=a${P}.w,$C[3]=a${P}.h;_.uniform4ui`:"_.uniform4f"}($L[${k.length+1}],${t>13?"$c[0],$c[1],$c[2],$c[3]":`a${P}.x,a${P}.y,a${P}.w,a${P}.h`})}else _.uniform1f($L[${k.length+2}],-1),_.uniform4${t>13?"ui":"f"}($L[${k.length+1}],a${P}.x,a${P}.y,a${P}.z,a${P}.w)`),k.push(s,r,n),Y.push(`,s${Y.length}=null`)}else{E.push(`uniform ${et[3&t|t>>4<<2]} uni${P};`);let r=`_.uniform${s+(t<16?"f":t<32?"i":"ui")}($L[${k.length}]`;if(k.push("uni"+P),1==s)r+=",a"+P;else for(let t=0;t<s;t++)r+=",a"+P+"."+"xyzw"[t];U.push(r+")")}P++}if(12+(F+3&-4)+(m.S+3&-4)>rt<<2)throw"Too many shader parameters";if(B+N>16)throw"Shaders cannot use more than 16 textures/colors";Object.freeze($D),Object.freeze($U);const V=rt-(m.S+3>>2);B=B?N?B+u(v*(O-B-N)):O:0,N=N&&O-B;let Z=null,H=`precision highp usampler2DArray; precision ${2&L?"highp":"lowp"} sampler2DArray;`;15&L&&(H+=`uniform sampler2DArray GL_f[${B}];ivec3 textureSize(int u,int l){${ht(i=>`return textureSize(GL_${i<B?"f["+i:"i["+(i-B)}],l);`,0,O)}}\n#define getSize textureSize\n`),12&L&&(H+=`uniform usampler2DArray GL_i[${N}];uvec4 uGetColor(int u,vec3 p){${ht(i=>`return texture(GL_i[${i-O}],p);`,O,2*O-B)}}uvec4 uGetPixel(int u,ivec3 p,int l){${ht(i=>`return texelFetch(GL_i[${i-O}],p,l);`,O,2*O-B)}}uvec4 uGetColor(usampler2DArray u,vec3 p){return texture(u,p);}uvec4 uGetPixel(usampler2DArray u,ivec3 p,int l){return texelFetch(u,p,l);}\n#define iGetColor(a,b) ivec4(uGetColor(a,b))\n#define iGetPixel(a,b,c) ivec4(uGetPixel(a,b,c))\n`),3&L&&(H+=`vec4 fGetColor(int u,vec3 p){${ht(i=>`return texture(GL_f[${i}],p);`,0,B)}}lowp vec4 GL_lp(vec4 x){return x;}vec4 fGetColor(sampler2DArray t,vec3 p){return texture(t,p);}vec4 fGetPixel(sampler2DArray t,ivec3 p,int l){return texelFetch(t,p,l);}vec4 fGetPixel(int u,ivec3 p,int l){${Z||ht(i=>`return texelFetch(GL_f[${i}],p,l);`,0,B)}}\n#define getColor(a,b)GL_lp(fGetColor(a,b))\n#define getPixel(a,b,c)GL_lp(fGetPixel(a,b,c))\n`),E[1]=H;const q=32-B&&-1>>>B|0;U[0]=`i&&draw(0);if($s!=s){_.useProgram($P);$H(s,${B},${q},${A>3?F+A*(A-1)+")":`lv==$Q?${F+9}:${F+6});$l(lv)`}}`;const W=V==rt-1?`_.vertexAttribIPointer(${V},${3&m.S},5125,${m.S<<2},0)`:`for(let i=${rt-1},j=0;i>=${V};i--,j+=16){_.vertexAttribIPointer(i,i==${V}?${3&m.S}:4,5125,${m.S<<2},j)`;R[0]=`sz+=${F};if(this.V()){const sd=$s!=s,{S}=this,_st=S.t;if(sd||sz!=$u){i&&draw(sd?0:$x);$H(s,${B},${q},sz);if(sd)_.useProgram($P),B();${A>3?`}if($v!=_st.v)i&&draw(),$l(_st.v);if(s!=_st.L||sz!=_st.Ls){i&&draw();if(!_st.Ls)$a(_st);$d(sz>${8+F},0,false);_st.L=s;_st.Ls=sz`:`$l(lv=sz>${8+F}?$Q:$q)}if(lv.geo!=_st.b){i&&draw();_.bindBuffer(34962,lv.geo=_st.b);${W};_.bindBuffer(34962,$M);_.bindBuffer(34963,_st.E)`}}if($p!=S)S.S();}let b=$X^$x;`+S.join(";")+`;const k=$G(sz),j=k+sz-${F}`,R.push("return k");const $d=(t=!1,s=0,r=!0)=>{const n=A*(2+t),u=F+n<<2;_.vertexAttribPointer(0,A,5126,!1,u,s),_.vertexAttribPointer(1,A,5126,!1,u,s+(A<<2)),t?(_.enableVertexAttribArray(2),_.vertexAttribPointer(2,A,5126,!1,u,s+(A<<3))):_.disableVertexAttribArray(2);for(let i=0;i<F;i+=4){const t=3+(i>>2);_.enableVertexAttribArray(t),_.vertexAttribIPointer(t,o(4,F-i),5125,u,s+(i+n<<2)),_.vertexAttribDivisor(t,1)}if(r){_.enableVertexAttribArray(0),_.enableVertexAttribArray(1),_.vertexAttribDivisor(0,1),_.vertexAttribDivisor(1,1),_.vertexAttribDivisor(2,1);for(let i=rt-1;i>=V;i--)_.enableVertexAttribArray(i)}return u>>2};let $q=null,$Q=null;A<4&&(_.bindVertexArray($q=_.createVertexArray()),$q.geo=null,$d(!1),_.bindVertexArray($v=$Q=_.createVertexArray()),$Q.geo=null,$d(!0));const J=eval(`let ${A<4?"lv=$Q":"__"}${Y.length?Y.join(""):""};const B=function(){${X.join(";")};$x=$X},s=function(sz,{${g}}){${R.join(";")}};s.uniforms=(function(${I}){${U.join(";")};B()});s`),$P=_.createProgram(),K=_.createShader(35633),f=_.createShader(35632);if(T.push("}"),_.shaderSource(K,G.join("")+T.join("")),_.compileShader(K),_.shaderSource(f,E.join("")+"\n"+t),_.compileShader(f),_.attachShader($P,K),_.attachShader($P,f),Z=_.getShaderInfoLog(f))throw"GLSL Error:\n"+Z;if(_.linkProgram($P),Z=_.getShaderInfoLog(K))throw"GLSL Error:\n"+G.join("")+T.join("");_.useProgram($P);const $L=k.map(t=>_.getUniformLocation($P,t));for(let i=0;i<O;i++)_.uniform1i(_.getUniformLocation($P,i<B?"GL_f["+i+"]":"GL_i["+(i-B)+"]"),i>=B?O+i-B:i);return J.vertex=m,J.three=m.three,$s=J};let bt=0,$t=0,wt=0;$.Shader.UINT=$.Shader("void main(){color=param0;}",{params:$.UVEC4,outputs:$.UINT}),$.Shader.BLACK=$.Shader("void main(){color=vec4(0,0,0,1);}"),$.Shader.SIMPLE=$.Shader("void main(){color=param0;}",{params:[$.VEC4]}),$.Shader.DEFAULT=$.Shader("void main(){color=param0(pos)*param1;}",{params:[$.COLOR,$.VEC4],defaults:[void 0,$.vec4.one]}),$.Shader.COLOR_3D_XZ=$.Shader("void main(){color=param0(pos.xz);}",{params:[$.COLOR],vertex:Geometry3D.Vertex.DEFAULT}),$.Shader.SHADED_3D=$.Shader("void main(){color=param0(pos.xy);color.rgb*=1.+dot(normalize(cross(dFdx(pos),dFdy(pos))),param1);}",{params:[$.COLOR,$.VEC3],defaults:[void 0,vec3(-.15,-.3,0)],vertex:Geometry3D.Vertex.DEFAULT});let _t=0;const xt=[];$.onFlush=f=>xt.push(f),$.flush=()=>{i&&draw(),T?T=!1:R&&(_.bindBuffer(35051,null),_.deleteBuffer(R),R=null,G=-1);for(let i=0;i<O<<1;i++){const t=U[i];t&&(_.activeTexture(33984+i),_.bindTexture(35866,U[i]=null),t.i=-1)}let t=performance.now();t-_t>1e3&&(_t=t,$i=new Float32Array($i.length>>>1),$I=new Int32Array($i.buffer));for(const f of xt)try{f()}catch(t){Promise.reject(t)}};const mt=$.ctx=new K(curt={$:null,_:0,T:null,w:0,h:0,u:0});$.setSize=(w=0,h=0)=>{_.canvas.width=w,_.canvas.height=h,mt.t.w=_.drawingBufferWidth,mt.t.h=_.drawingBufferHeight,curt==mt.t&&(curt=it=null),mt.t._=0};const vt=()=>{for(;At&&37145==_.getSyncParameter(At.sync,37140);)_.deleteSync(At.sync),At(),At=At.next;At||(gt=null,clearInterval(Gt),Gt=0)};let At=null,gt=null;const Rt=[];$.wait=()=>new Promise(t=>{i?(t.sync=null,Rt.push(t)):(t.sync=_.fenceSync(37143,0),At??=t,gt=gt?gt.next=t:t),Gt||(Gt=setInterval(vt,0))});let Gt=0;return $.loop=t=>("t"in $||($.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=.001*performance.now(),$.dt=0,$.frameCpu=0,$.glLost??=null,requestAnimationFrame(function f(){if(requestAnimationFrame(f),_.isContextLost())return $.glLost?.(),$.glLost=At=gt=null;i&&draw(),_.bindFramebuffer(36009,N=curt=it=null),mt.t._=0,dt=max(.001,o(-($.t-($.t=.001*performance.now())),.5)),mt.reset();try{t()}finally{$.flush(),$.frameCpu=.001*performance.now()-$.t,bt||$.ctx.clear(),$.frameDrawCalls=bt,$.frameSprites=$t,$.frameData=4*wt+24*bt,bt=$t=wt=0}})),$),$},Object.assign($.Gamma,{bitmapOpts:p,STENCIL:1,ALPHA_CHANNEL:2,PREMULTIPLIED_ALPHA:4,AUTO_CLEAR_BUFFER:8,MSAA:16})}Gamma.font=e=>{const t=e.vec4.one,s={x:0,y:1},n=e.Geometry2D.SQUARE,r=e.Shader.MSDF=e.Shader("void main(){vec3 c=param0(pos).rgb;color=param2*clamp(param1.y*(max(min(c.r,c.g),min(max(c.r,c.g),c.b))-.5+param1.x)+.5,0.,1.);}",{params:[e.COLOR,e.VEC2,e.VEC4],defaults:[null,{x:0,y:1},t]});r.sdf=!0,e.Shader.sdf=(t,s={})=>{let n="float field(vec2 uv){vec3 c=param0(uv).rgb;return max(min(c.r, c.g), min(max(c.r, c.g), c.b)); }\n#define scale param1\n";Array.isArray(s.params)||(s.params="number"==typeof s.params?[s.params]:[]),Array.isArray(s.defaults)||(s.defaults=void 0===s.defaults?[]:[s.defaults]);for(let e=0;e<s.params.length;e++)n+=`#define value${e} param${e+2}\n`;s.params.unshift(e.COLOR,e.VEC2),s.defaults.unshift(void 0,{x:0,y:1});const r=e.Shader(n+t,s);return r.sdf=!0,r};const i=e.BreakToken=(e,t=0,s="",n=void 0)=>{if(e instanceof RegExp){let t=e.flags,s=t.indexOf("g");s>-1&&(t=t.slice(0,s)+t.slice(s+1)),t.includes("y")||(t+="y"),t!=e.flags&&(e=new RegExp(e.source,t))}else{let t="[";for(const s of e+""){const e=s.codePointAt();t+=e>=92&&e<=94||45==e?"\\"+s:s}e=new RegExp(t+"]","y")}return e.type=t,e.sep=s,e.next=n,e.sepW=e.sepA=e.sepS=0,e.sepL=null,e};i.NORMAL=0,i.NEVER_BREAK=1,i.ALWAYS_BREAK=2,i.OVERFLOW=3,i.VANISH=4,i.TRUNCATE=5,i.SQUISH=6,i.SQUISH_BREAK=7,i.WRAP_AFTER=8,i.WRAP_BEFORE=16,i.INVISIBLE=32;const o=[i(/\r\n?|\n/y,i.WRAP_AFTER|i.INVISIBLE,""),i(/[$£"+]?[\w'\xA0\-]+[,.!?:;"^%€*]?/iy,i.NORMAL,"-"),i(/[ \t]+/y,i.VANISH)],c=i(/[^]/y,i.ALWAYS_BREAK),a={x:0,y:0},l={n:{0:null},off:0,spr:-1,0:null,1:a},h=[0,0,0,l],f=(e,t,s,n=0)=>{if(e.sepL=t,e.sepA=s,e.sepS=n,!t)return e.sepW=0;let r=0;const i=1/s;for(const o of e.sep){const e=o.codePointAt(),c=(t.get(~e)??t._default).width+n+(t.get(e+-16777216)??0);r+=s&&asin(c*s)*i||c}return t.then?.(()=>e.sepL==t&&(e.sepL=null,e.sepW=0)),e.sepW=r};class u extends Array{#e=null;#t=r;#s=n;#n=1;#r=0;#i=1;#o=0;#c=0;#a=0;#l=h;#h=0;#f=NaN;#u=null;#p=!0;static public=class e{constructor(e){this.#b=e}sub(){const t=new e(this.#b);return t.#y=this.#y,t.#g=this.#g,t.#_=this.#_,t.#k=this.#k,t.#m=this.#m,t.#d=this.#d,t.#w=this.#w,t.#A=this.#A,t.#v=this.#v,t.#x=this.#x,t}reset(e=null){this.#y="object"==typeof e?e:null,this.#g=r,this.#_=n,this.#k=1,this.#m=1,this.#d=0,this.#w=0,this.#A=0,this.#v=h,this.#x=!0,this.#b.#u==this&&(this.#b.#u=null)}#b;#y=null;#x=!0;get font(){return this.#y}set font(e){"object"==typeof e&&(this.#y=e),this.#b.#u==this&&(this.#b.#u=null)}#g=r;get shader(){return this.#g}set shader(e){"function"==typeof e&&(this.#g=e),this.#b.#u==this&&(this.#b.#u=null)}#_=n;get geometry(){return this.#_}set geometry(e){this.#_=e,this.#b.#u==this&&(this.#b.#u=null)}#k=1;get scale(){return this.#k}set scale(e){this.#k=+e,this.#b.#u==this&&(this.#b.#u=null)}scaleBy(e=1,t=!0,s=!0){if(1==e)return;const n=this.#b,r=n.length;let i=0,o=0;for(;i<r;){const r=n[i++];"number"==typeof r?(4==r||5==r&&s?(o||(o=1),n[i]*=e):1==r&&t&&(n[i]*=e),i++):"string"!=typeof r&&"function"!=typeof r||o||(o=2)}1!=o&&n.unshift(4,e),n.#n*=e,s&&(n.#r*=e),n.#f=NaN,n.#u=null}#q=0;get yOffset(){return this.#q}set yOffset(e){this.#q=+e,this.#b.#u==this&&(this.#b.#u=null)}offsetBy(e=0,t=!1){if(!e)return;const s=this.#b,n=s.length;let r=0,i=0,o=1,c=!1,a=0;for(;r<n;){const n=s[r++];if("number"==typeof n)5==n?(i||(i=1),a=s[r],s[r]=a+e*o,c=!1):t&&4==n&&(o=1/s[r],c=!0),r++;else if("string"==typeof n||"function"==typeof n){if(c){s.push(null,null);for(let e=s.length-3;e>=r;e--)s[e+2]=s[e];s[r++]=5,s[r++]=a+e*o}i||(i=2)}}1!=i&&s.unshift(5,e),s.#r+=e,s.#u=null}#m=1;get stretch(){return this.#m}set stretch(e){this.#m=+e,this.#b.#u==this&&(this.#b.#u=null)}stretchBy(e=1,t=!0,s=!1){if(1==e)return;const n=this.#b,r=n.length;let i=0,o=0;for(;i<r;){const r=n[i++];"number"==typeof r?(6==r||7==r&&s?(o||(o=1),n[i]*=e):1==r&&t&&(n[i]*=e),i++):"string"!=typeof r&&"function"!=typeof r||o||(o=2)}1!=o&&(s?n.unshift(7,e,6,e):n.unshift(6,e)),n.#i*=e,s&&(n.#o*=e),n.#f=NaN,n.#u=null}get letterWidth(){return this.#k*this.stretch}set letterWidth(e){this.stretch=e/this.#k}#d=0;get skew(){return this.#d}set skew(e){this.#d=+e,this.#b.#u==this&&(this.#b.#u=null)}skewBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,r=0;for(;n<s;){const s=t[n++];"number"==typeof s?(7==s&&(r||(r=1),t[n]+=e),n++):"string"!=typeof s&&"function"!=typeof s||r||(r=2)}1!=r&&t.unshift(7,e),t.#o+=e,t.#u=null}#w=0;get letterSpacing(){return this.#w}set letterSpacing(e){this.#w=+e,this.#b.#u==this&&(this.#b.#u=null)}spaceBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,r=0;for(;n<s;){const s=t[n++];"number"==typeof s?(8==s&&(r||(r=1),t[n]+=e),n++):"string"!=typeof s&&"function"!=typeof s||r||(r=2)}1!=r&&t.unshift(8,e),t.#c+=e,t.#f=NaN,t.#u=null}#A=0;get curve(){return this.#A}set curve(e){this.#A=+e,this.#b.#u==this&&(this.#b.#u=null)}curveBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,r=0;for(;n<s;){const s=t[n++];"number"==typeof s?(9==s?(r||(r=1),t[n]+=e):1!=s||r||(r=2),n++):"string"!=typeof s&&"function"!=typeof s||r||(r=2)}1!=r&&t.unshift(9,e),t.#a+=e,t.#f=NaN,t.#u=null}#v=h;setTextPass(e,t,s=0,n=0,r=0,i=-.5){const o={n:{0:null},off:r,spr:.5/i,0:null,1:a};if(t)for(let e=0;e<t.length;e++)o[e+2]=o.n[e+1]=t[e];const c=this.#v,l=this.#v=[];let h=0;for(;h<c.length;h+=4){if(!(c[h]<e)){c[h]==e&&(h+=4);break}l.push(c[h],c[h+1],c[h+2],c[h+3])}for(l.push(e,+s,+n,o);h<c.length;)l.push(c[h],c[h+1],c[h+2],c[h+3]),h+=4;this.#b.#u=null}setLinePass(e,n,r=0,i=1){const o={0:t,1:s};for(let e=0;e<n.length;e++)o[e+2]=n[e];const c=this.#v,a=this.#v=[];let l=0;for(;l<c.length;l+=4){if(!(c[l]<e)){c[l]==e&&(l+=4);break}a.push(c[l],c[l+1],c[l+2],c[l+3])}for(a.push(e,o,+r,+i);l<c.length;)a.push(c[l],c[l+1],c[l+2],c[l+3]),l+=4;this.#b.#u=null}unsetPass(e){const t=this.#v,s=this.#v=[];let n=0;for(;n<t.length;n+=4){if(!(t[n]<e)){t[n]==e&&(n+=4);break}s.push(t[n],t[n+1],t[n+2],t[n+3])}for(;n<t.length;)s.push(t[n],t[n+1],t[n+2],t[n+3]),n+=4;this.#b.#u=null}insertTextPass(e,t,s=0,n=0,r=0,i=-.5){const o={n:{0:null},off:r,spr:.5/i,0:null,1:a};if(t)for(let e=0;e<t.length;e++)o[e+2]=o.n[e+1]=t[e];const c=this.#b,h=c.length;let f=0,u=0;for(;f<h;){let t=c[f++];if("number"==typeof t&&t>0)f++;else if("string"==typeof t||"function"==typeof t)u||(u=2);else if(Array.isArray(t)){u||(u=1);const r=c[f-1]=[];let i=0;for(;i<t.length;i+=4){if(!(t[i]<e)){t[i]==e&&(i+=4);break}r.push(t[i],t[i+1],t[i+2],t[i+3])}for(r.push(e,+s,+n,o);i<t.length;)r.push(t[i],t[i+1],t[i+2],t[i+3]),i+=4}}1!=u&&c.unshift(e>0?[0,0,0,l,e,s,n,o]:e<0?[e,s,n,o,0,0,0,l]:[e,s,n,o]),c.#u=null}insertLinePass(e,n,r=0,i=1){const o={0:t,1:s};for(let e=0;e<n.length;e++)o[e+2]=n[e];const c=this.#b,a=c.length;let h=0,f=0;for(;h<a;){let t=c[h++];if("number"==typeof t&&t>0)h++;else if("string"==typeof t||"function"==typeof t)f||(f=2);else if(Array.isArray(t)){f||(f=1);const s=c[h-1]=[];let n=0;for(;n<t.length;n+=4){if(!(t[n]<e)){t[n]==e&&(n+=4);break}s.push(t[n],t[n+1],t[n+2],t[n+3])}for(s.push(e,o,r,i);n<t.length;)s.push(t[n],t[n+1],t[n+2],t[n+3]),n+=4}}1!=f&&c.unshift(e>0?[0,0,0,l,e,o,r,i]:e<0?[e,o,r,i,0,0,0,l]:[e,o,r,i]),c.#u=null}removePass(e){const t=this.#b,s=t.length;let n=0;e:for(;n<s;){let s=t[n++];if("number"==typeof s&&s>0)n++;else if(Array.isArray(s)){let t=0;for(;t<s.length;t+=4){if(s[t]>e)continue e;if(s[t]==e){for(t+=4;t<s.length;)s[t-4]=s[t],s[t-3]=s[t+1],s[t-2]=s[t+2],s[t-1]=s[t+3],t+=4;s.length-=4;break}}}}}get index(){return this.#x}set index(e){this.#x=!!e,this.#b.#u==this&&(this.#b.#u=null)}advance(e=0){const t=this.#b;t.#u!=this&&this.#N(t),t.push(1,+e),t.#f=NaN}#N(e){this.#y!=e.#e&&e.push(e.#e=this.#y),this.#g!=e.#t&&e.push(2,e.#t=this.#g),this.#_!=e.#s&&e.push(3,e.#s=this.#_),this.#k!=e.#n&&e.push(4,e.#n=this.#k),this.#q!=e.#r&&e.push(5,e.#r=this.#q),this.#m!=e.#i&&e.push(6,e.#i=this.#m),this.#d!=e.#o&&e.push(7,e.#o=this.#d),this.#w!=e.#c&&e.push(8,e.#c=this.#w),this.#A!=e.#a&&e.push(9,e.#a=this.#A),this.#v!=e.#l&&(e.push(this.#v),e.#l=this.#v),this.#x!=e.#p&&(e.push(this.#x),e.#p=this.#x),e.#u=this}copy(){const e=this.#b,t=e.slice(),s=t.#u=this.sub();return s.#b=t,t.#e=e.#e,t.#t=e.#t,t.#n=e.#n,t.#r=e.#r,t.#i=e.#i,t.#o=e.#o,t.#c=e.#c,t.#a=e.#a,t.#l=e.#l,t.#p=e.#p,t.#h=e.#h,t.#f=e.#f,s}slice(t=0,s=1/0){const n=this.#b,r=new u;t<0&&(t+=n.#h)<0&&(t=0),s<0&&(s+=n.#h)<0&&(s=0);const i=new e(r);let o=0;if(s<=0){for(;o<n.length;){const e=n[o++];if("number"==typeof e){const t=n[o++];switch(e){case 1:o-=2;break;case 2:i.#g=t;break;case 3:i.#_=t;break;case 4:i.#k=t;break;case 5:i.#q=t;break;case 6:i.#m=t;break;case 7:i.#d=t;break;case 8:i.#w=t;break;case 9:i.#A=t}}else{if("string"==typeof e||"function"==typeof e)break;Array.isArray(e)?"boolean"==typeof e?i.#x=e:i.#v=e:i.#y=e}}return i.#N(r),i}s=s>=t?s-t:0;let c="";for(;t>0&&o<n.length;){const e=n[o++];if("number"==typeof e){const t=n[o++];switch(e){case 2:i.#g=t;break;case 3:i.#_=t;break;case 4:i.#k=t;break;case 5:i.#q=t;break;case 6:i.#m=t;break;case 7:i.#d=t;break;case 8:i.#w=t;break;case 9:i.#A=t}}else if("string"==typeof e){if(!r.#p)continue;if((t-=e.length)<0){c=e.slice(t,(s+=t)+e.length);break}}else Array.isArray(e)?i.#v=e:"object"==typeof e?i.#y=e:"boolean"==typeof e&&(i.#x=e)}for(i.#N(r),c&&(r.push(c),r.#h+=c.length);s>0&&o<n.length;){const e=n[o++];if(r.push(e),"number"==typeof e){const t=n[o++];switch(r.push(t),e){case 2:i.#g=t;break;case 3:i.#_=t;break;case 4:i.#k=t;break;case 5:i.#q=t;break;case 6:i.#m=t;break;case 7:i.#d=t;break;case 8:i.#w=t;break;case 9:i.#A=t}}else if("string"==typeof e){if(!r.#p)continue;s-=e.length,r.#h+=e.length,s<0?(r[r.length-1]=e.slice(0,s),r.#h+=e.length+s):r.#h+=e.length}else Array.isArray(e)?i.#v=e:"object"==typeof e?i.#y=e:"boolean"==typeof e&&(i.#x=e)}return i}trim(e=1/0){const t=this.#b;if(e<0&&(e+=t.#h)<0&&(e=0),e>t.#h)return;let s=0;if(t.#e=null,t.#t=r,t.#n=1,t.#i=1,t.#r=0,t.#o=0,t.#c=0,t.#p=!0,t.#a=0,t.#l=h,t.#h=e<0?0:e)for(;e>0&&s<t.length;){const n=t[s++];if("number"==typeof n){const e=t[s++];switch(n){case 2:t.#t=e;break;case 3:t.#s=e;break;case 4:t.#n=e;break;case 5:t.#r=e;break;case 6:t.#i=e;break;case 7:t.#o=e;break;case 8:t.#c=e;break;case 9:t.#a=e}}else if("string"==typeof n){if(!t.#p)continue;if((e-=n.length)<0){t[s-1]=n.slice(0,e);break}}else Array.isArray(n)?t.#l=n:"object"==typeof n?t.#e=n:"boolean"==typeof n&&(t.#p=n)}else for(;s<t.length;){const e=t[s++];if("number"==typeof e){const n=t[s++];switch(e){case 1:s-=2;break;case 2:t.#t=n;break;case 3:t.#s=n;break;case 4:t.#n=n;break;case 5:t.#r=n;break;case 6:t.#i=n;break;case 7:t.#o=n;break;case 8:t.#c=n;break;case 9:t.#a=n}}else{if("string"==typeof e||"function"==typeof e){s--;break}Array.isArray(e)?t.#l=e:"boolean"==typeof e?t.#p=e:t.#e=e}}this.#y=t.#e,this.#g=t.#t,this.#_=t.#s,this.#k=t.#n,this.#q=t.#r,this.#m=t.#i,this.#d=t.#o,this.#w=t.#c,this.#A=t.#a,this.#v=t.#l,t.length=s,t.#f=NaN}concat(e){const t=this.#b,s=e.#b;t.#h+=s.#h;let i=0;this.#y=null,this.#g=r,this.#_=n,this.#k=1,this.#q=0,this.#m=1,this.#d=0,this.#w=0,this.#A=0,this.#v=h;const o=s.length;e:for(;i<o;){const e=s[i++];if("number"==typeof e){const t=s[i++];switch(e){case 1:i-=2;break e;case 2:this.#g=t;break;case 3:this.#_=t;break;case 4:this.#k=t;break;case 5:this.#q=t;break;case 6:this.#m=t;break;case 7:this.#d=t;break;case 8:this.#w=t;break;case 9:this.#A=t}}else{if("string"==typeof e||"function"==typeof e){i--;break}Array.isArray(e)?this.#v=e:"boolean"==typeof e?this.#x=e:this.#y=e}}for(this.#N(t);i<o;){const e=s[i++];if(t.push(e),"number"==typeof e){const n=s[i++];switch(t.push(n),e){case 2:this.#g=n;break;case 3:this.#_=n;break;case 4:this.#k=n;break;case 5:this.#q=n;break;case 6:this.#m=n;break;case 7:this.#d=n;break;case 8:this.#w=n;break;case 9:this.#A=n}}else"string"==typeof e?t.#p&&(t.#h+=e.length):Array.isArray(e)?this.#v=e:"boolean"==typeof e?this.#x=e:"object"==typeof e&&(this.#y=e)}t.#f=NaN}get length(){return this.#b.#h}set length(e){this.trim(e)}get width(){const e=this.#b;let t=e.#f;if(t==t)return t;t=0;let s=null,n=0,r=1,i=1,o=0,c=0,a=0,l=1,h=-1,f=1;for(;n<e.length;){let u=e[n++];if("number"==typeof u){const s=e[n++];switch(u){case 1:t+=l*s,h=-1;break;case 4:l=(r=s)*i,h=-1;break;case 6:l=(i=s)*r,h=-1;break;case 5:case 7:h=-1;break;case 8:o=s;break;case 9:a=1/s,c=s}}else e:if("string"==typeof u){if(!s)break e;let e=0;for(;e<u.length;){const n=u.codePointAt(e);e+=1+(n>65535);const r=s.get(~n)??s._default;if(!r)continue;const i=(s.get(n+16777216*h)??0)*min(l,f);h=n,f=l;const p=(r.width+o)*l+i;t+=c&&asin(p*c)*a||p,r.tex?.waiting&&r.tex.load()}}else if("object"==typeof u){if(!u){s=null;continue}if(Array.isArray(u))continue;s=u,u.then?.(()=>e.#f=NaN)}}return e.#f=t}add(e){const t=this.#b;t.#u!=this&&this.#N(t),t.#p&&(t.#h+=(e+="").length),t.push(e),t.#f=NaN}addCb(e,t=NaN){if("function"!=typeof e)return;const s=this.#b;s.#u!=this&&this.#N(s),t==t?s.push(e,1,t):s.push(e)}indexAt(e=0,t=.5){t--;const s=this.#b;let n=null,r=0,i=1,o=1,c=0,a=!0,l=0,h=0,f=1,u=-1,p=1,b=0,y=0;for(;r<s.length;){let g=s[r++];if("number"==typeof g){const t=s[r++];switch(g){case 1:e-=f*t,u=-1;break;case 4:f=(i=t)*o,u=-1;break;case 6:f=(o=t)*i,u=-1;break;case 5:case 7:u=-1;break;case 8:c=t;break;case 9:h=1/t,l=t}}else if("string"==typeof g)if(n){let s=0;for(;s<g.length;){const r=g.codePointAt(s),i=1+(r>65535);s+=i;const o=n.get(~r)??n._default;if(!o){a&&(y=b+=i);continue}const _=(n.get(r+16777216*u)??0)*min(f,p);u=r,p=f;const k=(o.width+c)*f+_,m=l&&asin(k*l)*h||k;if(e-=m,a){if(e<=m*t)return y;y=b+=i}}}else a&&(b+=g.length);else if("object"==typeof g){if(!g){n=null;continue}if(Array.isArray(g))continue;n=g}else"boolean"==typeof g&&(a=g)}return y}draw(e){const t=this.#b;let s=null,i=0,o=1,c=1,l=1,f=0,u=0,p=0,b=0,y=0;e.shader=r,e.geometry=n;let g=h,_=3,k=null,m=0,d=!0,w=-1,A=1,v=e.perspective,x=-2*e.pixelRatio(),q=1,N=1,R=1,F=0;e:for(;i<t.length;){let n=t[i++];if("number"==typeof n){const s=t[i++];switch(n){case 1:if(y){u&&e.skew(-u,0);const t=.5/y,n=s*y*2;e.rotate(F),e.translate(sin(n)*t,(1-cos(n))*t),e.rotate(-n),F=0,u&&e.skew(u,0)}else e.translate(s,0);w=-1;continue e;case 4:const t=s*c;c=1/s,e.scale(t),p*=o*=c,b*=o,A*=t,y*=t,o=s,k&&(q=x*o*k.rangeFactor),w=-1;continue e;case 5:p=s*c,b=p*u,w=-1;continue e;case 2:e.shader=s,d=!!s.sdf;break;case 3:e.geometry=s;break;case 6:l=s,w=-1;continue e;case 7:e.skew(s-u,0),u=s,b=p*s,w=-1;continue e;case 8:f=.5*s;continue e;case 9:y=s*o;continue e;default:continue e}}else{if("string"==typeof n){if(!s)continue;let t=0;for(;t<n.length;){const r=n.codePointAt(t);t+=1+(r>65535);const i=s.get(~r)??s._default;if(!i)continue;v&&(x=-2*e.pixelRatio(),q=x*o*k.rangeFactor);const c=(s.get(r+16777216*w)??0)*min(A,l);w=r,A=l;const h=(i.width+f+f)*l+c,P=c-b;y&&(u&&e.skew(-u,0),e.rotate(F+(F=-asin(h*y)||0)),u&&e.skew(u,0));for(let t=0;t<_;t+=4){let s=g[t+1],n=g[t+2]+p,r=g[t+3];if(d||(r=r.n),"object"==typeof s){const t=y*h*(n+m);e.drawRectv(P+t,n+m,h-t-t,r,s)}else if(i.tex){if(r[0]=i.tex,d){a.x=r.off*R;const{spr:e}=r;a.y=(e<0?q:N)*e}e.drawRectv((i.x+f)*l+s+P,i.y+n,i.w*l,i.h,r)}}e.translate(h,0)}continue}if("function"==typeof n){const t=e.sub();F&&(t.skew(-u,0),t.rotate(F),t.skew(u,0)),n(t,k)}else if("object"==typeof n){if(!n){s=null;continue}if(Array.isArray(n)){if(_=(g=n).length,v=!1,e.perspective)for(let e=0;e<_;e+=4)if("object"==typeof g[e+3]&&g[e+3].spr<0){v=!0;break}continue}k=n,m=k.ascend-1,s=n,q=x*o*(N=k.rangeFactor),R=1/N}}}u&&e.skew(-u,0),F&&e.rotate(F),1!=o&&e.scale(c)}break(t=1/0,s=o,n={scale:1,letterSpacing:0,curve:0}){const r=this.#b;let i=!0,a="",l=0;for(;l<r.length;){const e=r[l++];"number"!=typeof e?"boolean"==typeof e?i=e:"string"==typeof e&&i&&(a+=e):l++}const h=[];let p="number"==typeof t?t:"function"==typeof t?t(h.length,n):t[min(h.length,t.length-1)],b=new u,y=b.#u=new e(b),g=0,_="";l=0;let k=null,m=1,d=1,w=-1,A=0,v=!1,x=null,q=-1;for(;l<a.length;){let i=0,o=c,N=b.length,R=A,F=y.#g,P=y.#_,S=y.#k,E=y.#q,L=y.#m,O=y.#d,B=y.#w,W=y.#y,j=y.#A,T=y.#v,C=b.#p,I=b.#h;if(q>=0)o=x,i=q,q=-1;else e:for(;;){if(s)for(o of s){if(o.lastIndex=l,!o.test(a))continue;const e=o.lastIndex-l;l+=e,i?(q=e,x=o,o=c):i=e;break e}if(++i,++l==a.length){o=c;break}}s=o.next??s;const H=o.type;16&H&&(h.push(y),b.#f=v?NaN:A,v=!1,y=y.sub(),y.#b=b=new u,p="number"==typeof t?t:"function"==typeof t?t(h.length,n):t[min(h.length,t.length-1)],N=R=A=I=0,C||b.push(b.#p=!1),y.#N(b));const V=!!(32&H);if(_){let e=_;i<_.length?(e=_.slice(0,i),_=_.slice(i),i=0):(i-=_.length,_=""),V&&b.#e&&b.push(null),e&&b.push(e),b.#p&&(b.#h+=e.length),V&&b.#e&&b.push(b.#e)}for(;i>0;){const e=r[g++];if("number"==typeof e){const t=r[g++];switch(b.push(e,t),e){case 2:y.#g=b.#t=t;break;case 3:y.#_=b.#s=t;break;case 4:y.#k=b.#n=t;break;case 5:y.#q=b.#r=t;break;case 6:y.#m=b.#i=t;break;case 7:y.#d=b.#o=t;break;case 8:y.#w=b.#c=t;break;case 9:y.#A=b.#a=t}}else if("string"==typeof e){if(!b.#e){b.push(e),b.#p&&(b.#h+=e.length);continue}i-=e.length;let t=e;i<0?(t=e.slice(0,i),_=e.slice(i)):_="",V&&b.push(null),b.push(t),b.#p&&(b.#h+=t.length),V&&b.push(b.#e)}else"boolean"==typeof e?b.push(b.#p=e):(b.push(e),Array.isArray(e)?b.#l=y.#v=e:"function"!=typeof e&&(b.#e=y.#y=e))}for(;;){let s=N,r=0,i=0,c=F,a=P,l=S,g=E,_=L,x=O,q=B,V=W,G=T,U=C,K=I,M=j,Y=1/M,D=!1,Q=o.sepL==V&&o.sepA==M&&o.sepS==q?o.sepW:f(o,V,M,q);const $=H?!!(36>>H&1):2*R<p,{scale:z=1,letterSpacing:J=0,curve:X=0}=n;v||=1!=z||0!=J||0!=X;let Z=M+X,ee=q+J;for(X&&(Y=1/Z);s<b.length;){const e=b[s++];if("number"==typeof e){const t=b[s++];switch(e){case 1:if(A+=t,w=-1,A>p-(Q-(k?.get(o.sep.codePointAt()+16777216*w)??0))*m||!$)break;N=s-2,i=0,D=!0,R=A,F=c,P=a,S=l,E=g,L=_,O=x,B=q,W=V,j=M,T=G,C=U,I=K;break;case 2:c=t;break;case 3:a=t;break;case 4:l=t,m=t*_*z;break;case 5:g=t;break;case 6:_=t,m=t*l*z;break;case 7:x=t;break;case 8:q=t,ee=t+J;break;case 9:Z=t+X,Y=1/Z,M=t}}else if("string"==typeof e)if(r=0,k){let t=0;for(;t<e.length;){const n=e.codePointAt(t),h=1+(n>65535);t+=h;const f=k.get(~n)??k._default;if(r+=h,U&&(K+=h),!f)continue;const u=(k.get(n+16777216*w)??0)*min(m,d);d=m,w=n;const b=(f.width+ee)*m+u;A+=Z&&asin(b*Z)*Y||b,A<=p-(Q-(k.get(o.sep.codePointAt()+16777216*n)??0))*m&&$&&(D=!0,N=s-1,i=r,R=A,F=c,P=a,S=l,E=g,L=_,O=x,B=q,W=V,j=M,T=G,C=U,I=K)}}else U&&(K+=e.length);else if(Array.isArray(e))G=e;else if("boolean"==typeof e)U=e;else{if("function"==typeof e)continue;(V=e)?(k=e,Q=o.sepL==e&&o.sepA==M&&o.sepS==q?o.sepW:f(o,e,M,q)):(k=null,Q=0)}}if(!R||A<=p||!N||3==H)break;if(s=N,r=i,c=F,a=P,l=S,g=E,_=L,x=O,q=B,V=W,G=T,U=C,M=j,K=I,6==H||7==H&&p-R>=A-p){const e=(p-R)/(A-R),t=b.length;for(b.splice(s,0,6,e*_),s+=2;s<t;){const t=b[s++];"number"==typeof t&&(6==t&&(b[s]*=e),s++)}b.push(6,_);break}A=R;const te=new u,se=new e(te),ne=b.length;se.#g=c,se.#_=a,se.#k=l,se.#q=g,se.#m=_,se.#d=x,se.#w=q,se.#v=G,se.#A=M,se.#x=U;let re=s+=!!r,ie=V;const oe=4!=H&&5!=H;if(r){se.#y=ie,se.#N(te);const e=b[s-1];b[s-1]=e.slice(0,r),te.push(e.slice(r)),oe?ie=null:te.push(se.#y=te.#e=null)}else{e:for(;re<ne;){const e=b[re++];if("number"==typeof e){const t=b[re++];switch(e){case 1:if(oe){re-=2;break e}break;case 2:se.#g=t;break;case 3:se.#_=t;break;case 4:se.#k=t;break;case 5:se.#q=t;break;case 6:se.#m=t;break;case 7:se.#d=t;break;case 8:se.#w=t;break;case 9:se.#A=t}}else{if("string"==typeof e||"function"==typeof e){re--;break}"boolean"==typeof e?se.#x=e:Array.isArray(e)?se.#v=e:ie=e}}se.#N(te)}if(oe)for(ie&&te.push(se.#y=te.#e=ie);re<ne;)te.push(b[re++]);else for(;re<ne;){const e=b[re++];"number"==typeof e?te.push(e,b[re++]):("object"!=typeof e||Array.isArray(e))&&te.push(e)}te.#h=b.#h-K,b.#h=K,b.#f=v?NaN:A,v=!1,se.#g=te.#t=y.#g,se.#_=te.#s=y.#_,se.#k=te.#n=y.#k,se.#q=te.#r=y.#q,se.#m=te.#i=y.#m,se.#d=te.#o=y.#d,se.#w=te.#c=y.#w,se.#A=te.#a=y.#A,se.#x=te.#p=y.#x,se.#v=te.#l=y.#v,b.length=s,!oe&&ie&&te.push(se.#y=te.#e=ie),D&&(b.#p&&b.push(b.#p=!1),b.push(o.sep)),h.push(y),y=se,b=te,p="number"==typeof t?t:"function"==typeof t?t(h.length,n):t[min(h.length,t.length-1)],N=i=R=A=I=0}8&H&&(h.push(y),b.#f=v?NaN:A,v=!1,A=0,y=y.sub(),y.#b=b=new u,p="number"==typeof t?t:"function"==typeof t?t(h.length,n):t[min(h.length,t.length-1)],y.#N(b))}for(;g<r.length;){const e=r[g++];if(b.push(e),"number"==typeof e){const t=r[g++];switch(b.push(t),e){case 2:y.#g=b.#t=t;break;case 3:y.#_=b.#s=t;break;case 4:y.#k=b.#n=t;break;case 5:y.#q=b.#r=t;break;case 6:y.#m=b.#i=t;break;case 7:y.#d=b.#o=t;break;case 8:y.#w=b.#c=t;break;case 9:y.#A=b.#a=t}}else Array.isArray(e)?y.#v=b.#l=e:"object"==typeof e?y.#y=b.#e=e:"boolean"==typeof e&&(y.#x=b.#p=e)}return b.#f=v?NaN:A,h.push(y),h}toString(){let e="",t=!0,s=0;const n=this.#b,r=n.length;for(;s<r;){const r=n[s++];"number"!=typeof r?"boolean"==typeof r?t=r:"string"==typeof r&&t&&(e+=r):s++}return e}clear(){const e=this.#b;e.#e=null,e.#t=r,e.#s=n,e.#n=1,e.#r=0,e.#i=1,e.#o=0,e.#c=0,e.#a=0,e.#l=h,e.#h=0,e.#f=NaN,e.#u=null,e.#p=!0,e.length=0}static ctor=(t=null)=>{const s=new u;if(!t)return s.#u=new e(s);const n=new e(s);return n.#y=t,n}}}e.RichText=u.public.ctor;const p=Texture(4,6,1,0,Formats.RGBA4).pasteData(Uint8Array.fromHex("ffffffffffffffffffff00000000ffffffff00000000ffffffff00000000ffffffff00000000ffffffffffffffffffff"));class b extends Map{rangeFactor=0;ascend=0;#R=[];_default={x:.05,y:-.0625,w:.5,h:.75,width:.6,tex:p};get then(){return this.#R?this.#F:void 0}#F(e,t){this.#R?.push(e,t)}done(){const e=this.#R;if(this.#R=null,e)for(let t=0;t<e.length;t+=2)e[t]?.(this)}error(e){const t=this.#R;if(this.#R=null,t)for(let s=1;s<t.length;s+=2)t[s]?.(e)}setChar(e=-1,t=0,s=null,n=0,r=0,i=0,o=0){if("string"==typeof e&&(e=e.codePointAt()),"object"==typeof t&&({x:n,y:r,w:i,h:o,width:t,tex:s}=t),e<0){const e=this._default;return s||t?(e.x=+n,e.y=+r,e.w=+i,e.h=+o,e.width=+t,e.tex=s):(e.x=e.y=e.w=e.h=e.width=0,e.tex=null),e}if(s||t){const c={x:+n,y:+r,w:+i,h:+o,width:+t,tex:s};return super.set(~e,c),c}return super.delete(~e),null}getChar(e=-1){return"string"==typeof e&&(e=e.codePointAt()),this.get(~e)??null}getWidth(e=-1){return"string"==typeof e&&(e=e.codePointAt()),(e<0?this._default:this.get(~e)??this._default).width}setKerning(e,t,s=0){"string"==typeof e&&(e=e.codePointAt()),"string"==typeof t&&(t=t.codePointAt()),s?super.set(16777216*e+t,s):super.delete(16777216*e+t)}getKerning(e,t){"string"==typeof e&&(e=e.codePointAt()),"string"==typeof t&&(t=t.codePointAt());const s=this.get(16777216*e+t);return"number"==typeof s?s:0}chlumsky(t,s="atlas.png",n=e.ANISOTROPY|e.SMOOTH,r=1,i=e.Font.defaultFixes){return t.endsWith("/")&&(t+="index.json"),fetch(t).then(e=>(t=e.url,e.json())).then(o=>{const{atlas:{type:c,distanceRange:a,size:l,width:h,height:f},metrics:{ascender:u,descender:p},glyphs:b,kerning:y}=o;this.rangeFactor=a/l;const g=e.Texture.from(new URL(s,t).href,n,c.toLowerCase().endsWith("msdf")?e.Formats.RGB:e.Formats.RG,r);this.ascend=u/(u-p);for(const{unicode1:e,unicode2:t,advance:s}of y)super.set(t+16777216*e,s);for(const{unicode:e,advance:t,planeBounds:s,atlasBounds:n}of b)super.set(~e,s?{x:+s.left,y:+s.bottom,w:s.right-s.left,h:s.top-s.bottom,width:t,tex:g.sub(n.left/h,n.bottom/f,(n.right-n.left)/h,(n.top-n.bottom)/f)}:{x:0,y:0,w:0,h:0,width:t,tex:null});i?.(this),g.then(()=>this.done())},this.error.bind(this)),this}bmfont(t,s=0,n=e.ANISOTROPY|e.SMOOTH,r=1,i=e.Font.defaultFixes){return fetch(t).then(e=>(t=e.url,e.json())).then(o=>{const{chars:c,distanceField:a,pages:l,common:{base:h,lineHeight:f,scaleW:u,scaleH:p},kernings:b}=o,y=1/o.info.size;this.rangeFactor=a.distanceRange/f;const g=this.ascend=h/f,_=l.map(s=>e.Texture.from(new URL(s,t).href,n,a.fieldType.toLowerCase().endsWith("msdf")?e.Formats.RGB:e.Formats.RG,r));for(const{first:e,second:t,amount:s}of b)super.set(t+16777216*e,s/y);for(const{id:e,x:t,y:n,width:r,height:i,xoffset:o,yoffset:a,xadvance:l,page:h}of c)super.set(e,{x:o*y,y:g-(a-s+i)*y,w:r*y,h:i*y,width:l*y,tex:r&&i?_[h].sub(t/u,1-(n+i)/p,r/u,i/p):null});i?.(this),Promise.all(_).then(()=>this.done())},this.error.bind(this)),this}draw(e,t,s=[],n=0,r=-.5,i=0,o=-1){if(this.#R)return;i*=.5,n/=this.rangeFactor;const c=!!e.shader.sdf,l=r<0&&e.perspective&&c;let h=r=1/r;l||(h*=(r<0?-e.pixelRatio():.5)*this.rangeFactor);let f=0;for(;f<t.length;){const u=t.codePointAt(f);f+=1+(u>65535);const p=this.get(~u)??this._default;if(!p)continue;l&&(h=-e.pixelRatio()*this.rangeFactor*r);const b=this.get(u+1114112*o)??0;o=u;const y=p.width+i+i+b;p.tex&&(c?(a.x=n,a.y=h,e.drawRect(p.x+i+b,p.y,p.w,p.h,p.tex,a,...s)):e.drawRect(p.x+i+b,p.y,p.w,p.h,p.tex,...s)),e.translate(y,0)}}measure(e,t=0,s=-1){if(this.#R)return 0;let n=0,r=0;for(;r<e.length;){const i=e.codePointAt(r);r+=1+(i>65535);const o=this.get(~i)??this._default;if(!o)continue;const c=this.get(i+1114112*s)??0;s=i,n+=o.width+t+c}return n}}e.Font=()=>new b,e.Font.bmfont=(e,t)=>(new b).bmfont(e,t),e.Font.chlumsky=(e,t)=>(new b).chlumsky(e,t),e.Font.defaultFixes=e=>{const t=e.getChar(32)??e.setChar(32,.5);e.has(160)||e.setChar(160,t),e.has(9)||e.setChar(9,4*t.width)}};globalThis.BitField??=class t extends Array{constructor(t){if(super(),Array.isArray(t))for(let e=0;e<t.length;e++)this.push(t[e]);else if(t instanceof Uint8Array)for(let e=0;e<t.length;e+=4)this.push(t[e]|t[1|e]<<8|t[2|e]<<16|t[3|e]<<24);else if(t)for(const e of t)this.set(e)}static parse(e){return Array.isArray(e)?Object.setPrototypeOf(e,t.prototype):new t}static decode(e,s=new t){s.length=0;let n=e.v32();for(;n--;)s.push(e.i32())}static encode(t,e){const s=e.length;t.v32(s);for(let e=0;e<s;e++)t.i32(this[e])}static of(...e){const s=new t;for(const t of e)s.set(t);return s}set(t=0){const e=t>>>5;for(;e>=this.length;)this.push(0);this[e]|=1<<(31&t)}unset(t=0){let e=this.length;const s=t>>>5;if(!(s>=e))for(this[s]&=~(1<<(31&t));e&&!this[--e];)super.pop()}setRange(t=0,e=0){if(t>e)return;let s=t>>>5,n=e>>>5,i=e+31>>>5;for(;i>=this.length;)this.push(0);if(s!=n){for(this[s]|=-1<<(31&t);++s<n;)this[s]=-1;(i=31&e)&&(this[n]|=~(-1<<i))}else this[s]|=-1<<(31&t)&~(-1<<(31&e))}unsetRange(t=0,e){if(void 0===e){let e=t+31>>>5;for(;e>0&&!this[e-1];)e--;return this.length=e,void(e&&31&t&&(this[e-1]&=~(-1<<(31&t))))}if(t>e)return;let s=t>>>5,n=e>>>5;if(s>=this.length)return;if(s==n)return void(this[s]&=~(-1<<(31&t))|-1<<(31&e));let i=this.length;for(n<i&&(this[n]&=-1<<(31&e),i=n),this[s]&=~(-1<<(31&t));++s<i;)this[s]=0;if(i==this.length)for(;i&&!this[--i];)super.pop()}anyIn(t=0,e){let s=t>>>5;if(s>=this.length)return!1;if(void 0===e){if(31&t){if(this[s]&-1<<(31&t))return!0;s++}for(;s<this.length;)if(this[s++])return!0;return!1}let n=e>>>5;if(s==n)return!!(this[s]&-1<<(31&t)&~(-1<<(31&e)));if(31&t){if(this[s]&-1<<(31&t))return!0;s++}let i=this.length;if(n<i){if(this[n]&~(-1<<(31&e)))return!0;i=n}for(;++s<i;)if(this[s])return!0;return!1}allIn(t=0,e=0){let s=t>>>5;if(s>=this.length)return!1;let n=e>>>5;if(s==n)return-1==(this[s]|~(-1<<(31&t))|-1<<(31&e));if(31&t){if(~this[s]&-1<<(31&t))return!1;s++}let i=this.length;if(n<i){if(~(this[n]|-1<<(31&e)))return!1;i=n}for(;s<i;)if(~this[s++])return!1;return!0}toggle(t=0){let e=this.length;const s=t>>>5;for(;s>=e;)this.push(0),e++;for(this[s]^=1<<(31&t);e&&!this[--e];)super.pop()}has(t=0){const e=t>>>5;return!(e>=this.length)&&!!(this[e]&1<<(31&t))}pop(t=0){let e=t>>>5;if(e>=this.length)return!1;let s=this[e];if(s^=this[e]=s&~(1<<(31&t)),e==this.length-1)for(;e>=0&&!this[e--];)super.pop();return!!s}put(t=0){let e=t>>>5;for(;e>=this.length;)this.push(0);return!!(this[e]^(this[e]|=1<<(31&t)))}xor(t){let e=this.length;if(e==t.length)for(;e&&this[--e]==t[e];)super.pop();else{let s=e;for(e--;s<t.length;)this.push(t[s++])}for(let s=e;s>=0;s--)this[s]^=t[s]}and(t){let e=this.length;for(this.length>t.length&&(e=this.length=t.length);e&&!(this[--e]&t[e]);)super.pop();for(;e>0;)this[--e]&=t[e]}or(t){let e=this.length-1,s=e;for(;++s<t.length;)this.push(t[s]);for(let s=e;s>=0;s--)this[s]|=t[s]}firstUnset(){let t=-1;for(;++t<this.length;){const e=~this[t];if(e)return t<<5|31-clz32(e&-e)}return t<<5}firstSet(){let t=-1;for(;++t<this.length;)if(this[t])return t<<5|31-clz32(this[t]&-this[t]);return-1}lastSet(){let t=this.length;for(;--t>=0;)if(this[t])return t<<5|31-clz32(this[t]);return-1}popFirst(){let t=-1;for(;++t<this.length;)if(this[t]){let e=31-clz32(this[t]&-this[t]);for(this[t]&=~(1<<e),e|=t<<5,t=this.length;t&&!this[--t];)super.pop();return e}return-1}putFirst(){let t=-1;for(;++t<this.length;){const e=~this[t];if(!e)continue;const s=31-clz32(e&-e);return this[t]|=1<<s,t<<5|s}return this.push(1),t<<5}popLast(){let t=this.length;for(;--t>=0;)if(this[t]){let e=31-Math.clz32(this[t]);for(this[t]&=~(1<<e),e|=t<<5,t=this.length;t&&!this[--t];)super.pop();return e}return-1}clear(){this.length=0}[Symbol.iterator](){const t={value:0,done:!1};let e=0,s=-1;return{[Symbol.iterator](){return this},next:()=>{for(;e<this.length;e++,s=-1){const n=this[e]&s,i=31-clz32(n&-n);if(!(i<0))return s=-2<<i,t.value=e<<5|i,t}return e=1/0,t.done=!0,t}}}iter(t,e=0){let s=-1<<(31&e);for(let n=e>>>5;n<this.length;n++){for(;;){const e=this[n]&s,i=31-clz32(e&-e);if(i<0)break;s=-2<<i,t(n<<5|i)}s=-1}}toUint8Array(){let t=this.length-1,e=this[t],s=0;const n=new Uint8Array(t=(t<<2)+(39-clz32(e)>>3));for(;s<t;s+=4){const t=this[s>>2];n[s]=t,n[1|s]=t>>8,n[2|s]=n>>16,n[3|s]=n>>24}for(s-=4;s<t;)n[s++]=e,e>>=8;return n}};{document.addEventListener("pointerlockchange",()=>{const t=document.pointerLockElement?._ictx;t?((u=t.cursor)&&t.setPointer(0,null),a=t):a&&(u&&(a.setPointer(0,u),u=null),a=null)});const t=function(t=1,e=1,s=1,n=1,i=1){this.playEffect?.("dual-rumble",{duration:1e3*i,strongMagnitude:.5*(e+n),weakMagnitude:.5*(t+s)})??this.pulse?.(.25*(t+e+s+n),1e3*i)};function pollGamepads(){e=!1;const s=new Set;let n=document.activeElement?._ictx;if(n instanceof c)for(const t of n._pointers)t<0&&s.add(~t);else n=null;const i=navigator.getGamepads();let r=[];for(const t of i)"standard"==t?.mapping&&r.push(t);const o=r.length;for(const l of r.length?r:i){if(!l)continue;const i=new h,r=l.vibrationActuator??l.hapticActuators?.[0];i.vibrate=r?t.bind(r):null;for(let t=0;t<l.buttons.length;t++)l.buttons[t].pressed&&i.set(t);for(let t=0;t<l.axes.length;t+=2)i._axes.push({x:l.axes[t],y:o?-l.axes[t+1]:l.axes[t+1]});n&&(n.setGamepad(l.index,i),s.delete(l.index)),e=!0}if(n)for(const t of s)n.setGamepad(t,0);e&&requestAnimationFrame(pollGamepads)}let e=!0;requestAnimationFrame(pollGamepads),window.addEventListener("gamepadconnected",()=>{e||(requestAnimationFrame(pollGamepads),e=!0)});const s={__proto__:null,ContextMenu:93,Help:26,Semicolon:186,Quote:222,BracketLeft:219,BracketRight:221,Backquote:192,Backslash:220,Minus:189,EQUAL:187,IntlRo:193,IntlYen:255,MetaLeft:91,MetaRight:91,PrintScreen:44,ScrollLock:145,Pause:19,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NumLock:144,Clear:10,NumpadComma:110,NumpadDecimal:110,Numpad0:96,Numpad1:97,Numpad2:98,Numpad3:99,Numpad4:100,Numpad5:101,Numpad6:102,Numpad7:103,Numpad8:104,Numpad9:105},n=Object.freeze({LEFT:0,RIGHT:2,MIDDLE:1,BACK:3,FORWARD:4}),i=Object.freeze({A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,can:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,SPACE:32,BACKTICK:192,TAB:9,BACK:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,META:91,METARIGHT:93,CAPSLOCK:20,UP:38,RIGHT:39,DOWN:40,LEFT:37,MOD:navigator.platform.startsWith("Mac")?91:17,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,MINUS:189,EQUAL:187,BR_LEFT:219,BR_RIGHT:221,SEMICOLON:186,APOS:222,BACKSLASH:220,COMMA:188,DOT:190,SLASH:191,PAUSE:19,PAD_ENTER:12,CLEAR:10,HOME:36,END:35,PAGE_UP:33,PAGE_DOWN:34,INS:45,DEL:46,CTX_MENU:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,PAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,PAD_DIV:111,PAD_MULT:106,PAD_SUB:109,PAD_ADD:107,PAD_DOT:110,NUM_LOCK:144,SCROLL_LOCK:145,HELP:26,RO:193,YEN:255,SYSRQ:44,PRINT_SCREEN:44}),r=Object.freeze({A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,UP:12,DOWN:13,LEFT:14,RIGHT:15,MENU:16,LEFT_STICK:0,RIGHT_STICK:1,SELECT:8,START:9});class o{static DEFAULT=0;static HIDDEN=1;constructor(t=null){t?(this.x=+t.x,this.y=+t.y,this.tiltX=+t.tiltX,this.tiltY=+t.tiltY,this.pressure=+t.pressure,this.twist=+t.twist,this.buttons=0|t.buttons,this.setHint=t.setHint):(this.x=0,this.y=0,this.tiltX=0,this.tiltY=0,this.pressure=0,this.twist=0,this.buttons=0,this.setHint=null)}update(t){this.x=+t.x,this.y=+t.y,this.buttons=0|t.buttons,this.tiltX=+t.tiltX,this.tiltY=+t.tiltY,this.pressure=+t.pressure,this.twist=+t.twist,this.setHint=t.setHint}has(t){return!!(this.buttons>>t&1)}anyIn(t=0,e){return!!(this.buttons>>t&("number"==typeof e?~(-1<<e-t):-1))}allIn(t=0,e=0){return-1==(this.buttons>>t|-1<<e-t)}firstUnset(){const t=~this.buttons;return 31-clz32(t&-t)}firstSet(){const t=this.buttons;return 31-clz32(t&-t)}lastSet(){return 31-clz32(this.buttons)}[Symbol.iterator](){const t={value:-1,done:!1};return{[Symbol.iterator](){return this},next:()=>{if(t.done)return t;const e=this.buttons&-1<<t.value+1,s=31-clz32(e&-e);return s>=0?(t.value=s,t):(t.value=-1,t.done=!0,t)}}}iter(t,e=0){for(;;){const s=this.buttons&-1<<e,n=31-clz32(s&-s);if(n<0)break;e=n+1,t(n)}}get pressed(){return!!(1&this.buttons)}}const l=["","none","context-menu","help","pointer","progress","wait","cell","crosshair","text","vertical-text","alias","copy","move","no-drop","not-allowed","grab","grabbing","e-resize","n-resize","ne-resize","nw-resize","s-resize","se-resize","sw-resize","w-resize","ew-resize","ns-resize","nesw-resize","nwse-resize","col-resize","row-resize","all-scroll","zoom-in","zoom-out"];for(let p=2;p<l.length;p++)o[l[p].toUpperCase().replace("-","_")]=p;class h extends BitField{_subscribed=[];constructor(t=null){super(t),t?(this._axes=t._axes.slice(),this.vibrate=t.vibrate):(this._axes=[],this.vibrate=null)}update(t){const e=min(this.length,t.length);for(let s=0;s<e;s++){let e=t[s],n=e^this[s];for(this[s]=e;n;){const t=31-clz32(n&-n);for(const n of this._subscribed)n._fireGamepadButtonUpdate(s<<5|t,!!(e>>t&1));n&=-2<<t}}if(e<t.length)for(let s=e;s<t.length;s++){let e=t[s];for(this.push(e);e;){const t=31-clz32(e&-e);for(const e of this._subscribed)e._fireGamepadButtonUpdate(s<<5|t,!0);e&=-2<<t}}else if(e<this.length){for(let t=e;t<this.length;t++){let e=this[t];for(;e;){const s=31-clz32(e&-e);for(const e of this._subscribed)e._fireGamepadButtonUpdate(t<<5|s,!1);e&=-2<<s}}this.length=e}const s=t._axes,n=this._axes,i=min(s.length,n.length);for(let t=0;t<i;t++){const e=s[t],i=n[t];if(e.x!==i.x||e.y!==i.y){i.x=e.x,i.y=e.y;for(const s of this._subscribed)s._fireGamepadAxisUpdate(t,e.x,e.y)}}if(i<s.length)for(let t=i;t<s.length;t++){const e=s[t];if(n.push(e),0!==e.x||0!==e.y)for(const s of this._subscribed)s._fireGamepadAxisUpdate(t,e.x,e.y)}else if(i<n.length){for(let t=i;t<n.length;t++){const e=n[t];if(0!==e.x||0!==e.y)for(const e of this._subscribed)e._fireGamepadAxisUpdate(t,0,0)}n.length=i}this.vibrate=t.vibrate}axis(t){return this._axes[65535&t]??null}}class c extends BitField{next=null;wheel={x:0,y:0};mouse={x:0,y:0};cursor=null;gamepad=null;_pointers=new Map;pointer(t){return(t|=0)>=0?this._pointers.get(t)??null:null}iterPointers(t){for(const{0:e,1:s}of this._pointers)e>=0&&t(e,s)}gamepad(t){return(t=~t)<0?this._pointers.get(t)??null:null}iterGamepads(t){for(const{0:e,1:s}of this._pointers)e<0&&t(~e,s)}#t=[];#e=[];_rpcbs=[];#s=[];_rkcbs=[];_npcbs=[];_ngcbs=[];_dpcbs=[];_dgcbs=[];_kcbs=new Map;reset(){this._kcbs.clear(),this._rkcbs.length=0,this.#t.length=0,this.#e.length=0,this._npcbs.length=this._dpcbs.length=this._rpcbs.length=0,this._ngcbs.length=this._dgcbs.length=this.#s.length=0}clear(){this.reset(),this.clear(),this.wheel.x=this.wheel.y=0,this.mouse.x=this.mouse.y=0,this._pointers.clear()}onWheel(t){this.#t.push(t)}onMouse(t){this.#e.push(t)}onPointerUpdate(t){this._rpcbs.push("function"==typeof t?t:t.setPointer.bind(t))}onGamepadUpdate(t){this.#s.push("function"==typeof t?t:t.setGamepad.bind(t))}onNewPointer(t){this._npcbs.push(t)}onDelPointer(t){this._dpcbs.push(t)}onNewGamepad(t){this._ngcbs.push(t)}onDelGamepad(t){this._dgcbs.push(t)}onKey(t,e){if(Array.isArray(t)){for(const s of t)this.onKey(s,e);return}const s=this._kcbs.get(t&=65535);s?s.push(e):this._kcbs.set(t,[e])}onGamepadButton(t,e){if(Array.isArray(t)){for(const s of t)this.onGamepadButton(s,e);return}const s=this._kcbs.get(t=~(65535&t));s?s.push(e):this._kcbs.set(t,[e])}onGamepadAxis(t,e){if(Array.isArray(t)){for(const s of t)this.onGamepadButton(s,e);return}const s=this._kcbs.get(t=~(65535&t|65536));s?s.push(e):this._kcbs.set(t,[e])}onKeyPress(t,e,s=!1){let n=!1;this.onKey(t,(t,i)=>(n==s&(n=t)===!s&&e(i),s))}onGamepadButtonPress(t,e,s=!1){let n=!1;this.onGamepadButton(t,(t,i)=>(n==s&(n=t)===!s&&e(i),s))}onKeyUpdate(t){this._rkcbs.push("function"==typeof t?t:t.setKey.bind(t))}setKey(t,e=!1,s=!1){t&=65535;let n=this;for(;n;){if(e?n.put(t):n.pop(t)){const s=n._kcbs.get(t);if(s){let i=s.length;for(;i--;)try{const r=s[i](e,t,n);"boolean"==typeof r&&(e=r)}catch(t){Promise.reject(t)}}}else if(!s){n=n.next;continue}let i=n._rkcbs.length;for(;i--;)try{const s=n._rkcbs[i](t,e,n);"boolean"==typeof s&&(e=s)}catch(t){Promise.reject(t)}n=n.next}return e}refireKey(t){this.setKey(t,this.has(t),!0)}_fireGamepadButtonUpdate(t=0,e=!1){const s=this._kcbs.get(~t);if(!s)return;let n=s.length;for(;n--;)try{const i=s[n](e,t,this);"boolean"==typeof i&&(e=i)}catch(t){Promise.reject(t)}}_fireGamepadAxisUpdate(t=0,e=0,s=0){const n=this._kcbs.get(~(65536|t));if(!n)return;let i=n.length;for(;i--;)try{const t=n[i](e,s,this);"object"==typeof t&&(t?(e=+t.x,s=+t.y):e=s=0)}catch(t){Promise.reject(t)}}setPointer(t,e=null,s=!1){if((t|=0)<0)return;let n=this;for(;n;){let i=n._pointers.get(t)??null;if(i)if(e)i.update(e);else{n._pointers.delete(t),t||(n.cursor=null);let s=n._dpcbs.length;for(;s--;)try{const r=n._dpcbs[s](t,e,i,n);"object"==typeof r&&(e=r)}catch(t){Promise.reject(t)}}else if(e){i=new o(e),t||(n.cursor=i),n._pointers.set(t,i);let s=n._npcbs.length;for(;s--;)try{const i=n._npcbs[s](t,e,null,n);"object"==typeof i&&(e=i)}catch(t){Promise.reject(t)}}else if(!s){n=n.next;continue}let r=n._rpcbs.length;for(;r--;)try{const s=n._rpcbs[r](t,e,n);"object"==typeof s&&(e=s)}catch(t){Promise.reject(t)}n=n.next}return e}#n(t){this.gamepad=t,t.iter(t=>this._fireGamepadButtonUpdate(t,!0));const e=t._axes;for(let t=0;t<e.length;t++){const s=e[t];0!==s.x&&0!==s.y&&this._fireGamepadAxisUpdate(t,s.x,s.y)}t._subscribed.push(this)}refirePointer(t){const e=this._pointers.get(t);this.setPointer(t,e?new o(e):null,!0)}refirePointers(){for(const{0:t,1:e}of this._pointers)t>=0&&this.setPointer(t,new o(e),!0)}setGamepad(t,e=null,s=!1){if((t=~t)>=0)return;let n=this;for(;n;){let i=n._pointers.get(t)??null;if(i)if(e)i.update(e);else{if(n._pointers.delete(t),i==this.gamepad){this.gamepad=null;const t=i._subscribed;let e=t.indexOf(this);if(e>=0){for(;e<t.length;)t[e]=t[++e];t.pop()}i.iter(t=>this._fireGamepadButtonUpdate(t,!1));const s=i._axes;for(let t=0;t<s.length;t++){const e=s[t];0!==e.x&&0!==e.y&&this._fireGamepadAxisUpdate(t,0,0)}for(const{0:t,1:e}of this._pointers)if(t<0){this.#n(i);break}}let s=n._dgcbs.length;for(;s--;)try{const r=n._dgcbs[s](t,e,i,n);"object"==typeof r&&(e=r)}catch(t){Promise.reject(t)}}else if(e){i=new h(e),this.gamepad||this.#n(i),n._pointers.set(t,i);let s=n._ngcbs.length;for(;s--;)try{const i=n._ngcbs[s](t,e,null,n);"object"==typeof i&&(e=i)}catch(t){Promise.reject(t)}}else if(!s){n=n.next;continue}let r=this.#s.length;for(;r--;)try{const s=this.#s[r](t,e,n);"object"==typeof s&&(e=s)}catch(t){Promise.reject(t)}n=n.next}return e}refireGamepad(t){const e=this._pointers.get(~t);this.setGamepad(t,e?new h(e):null,!0)}refireGamepads(){for(const{0:t,1:e}of this._pointers)t<0&&this.setGamepad(~t,new h(e),!0)}fireWheel(t=0,e=0){"object"==typeof t&&(e=+t.y,t=+t.x);let s=this;for(;s;){this.wheel.x+=t,this.wheel.y+=e;let n=this.#t.length;for(;n--;)try{const i=this.#t[n](t,e,s);"object"==typeof i&&(i?(t=+i.x,e=+i.y):t=e=0)}catch(t){Promise.reject(t)}s=s.next}return{x:t,y:e}}fireMouse(t=0,e=0){"object"==typeof t&&(e=+t.y,t=+t.x);let s=this;for(;s;){this.mouse.x+=t,this.mouse.y+=e;let n=this.#e.length;for(;n--;)try{const i=this.#e[n](t,e,s);"object"==typeof i&&(i?(t=+i.x,e=+i.y):t=e=0)}catch(t){Promise.reject(t)}s=s.next}return{x:t,y:e}}clearDeltas(){this.mouse.x=this.mouse.y=this.wheel.x=this.wheel.y=0}}let u=null,a=null;const f=[];Gamma.input=(t,e=t.canvas)=>{if(e._ictx)return;t.MOUSE=n,t.KEY=i,t.GAMEPAD=r,t.PointerState=o,t.GamepadState=h;const a="undefined"!=typeof ApplePaySession&&!("letterSpacing"in CanvasRenderingContext2D.prototype),p=navigator.platform.startsWith("Linux")||"undefined"!=typeof netscape||a?void 0:{unadjustedMovement:!0};Object.defineProperty(t,"pointerLock",{get:()=>document.pointerLockElement==e,set:t=>{t?document.pointerLockElement!==e&&e.requestPointerLock(p)?.catch(t=>null):document.pointerLockElement===e&&document.exitPointerLock()}}),Object.defineProperty(t,"fullscreen",{get:()=>document.fullscreenElement==e,set:t=>{t?document.fullscreenElement!==e&&e.requestFullscreen()?.catch(t=>null):document.fullscreenElement===e&&document.exitFullscreen()}});const d=t.ictx=e._ictx=new c;t.InputContext=()=>new c,e.style.outline="none",e.style.touchAction="none",e.style.setProperty("-webkit-tap-highlight-color","transparent"),e.tabIndex=0;let m=!1;e.addEventListener("mousedown",t=>{document.activeElement?._ictx!=d&&e.focus(),t.preventDefault(),d.setKey(t.button,!0)}),e.addEventListener("mouseup",t=>{t.preventDefault(),d.setKey(t.button,!1)}),e.addEventListener("contextmenu",t=>t.preventDefault()),e.addEventListener("wheel",t=>{t.preventDefault(),d.fireWheel(t.wheelDeltaX,t.wheelDeltaY)},{passive:!1});let g=NaN,b=NaN;e.addEventListener("mousemove",t=>{t.preventDefault();let s=0,n=0;try{if(document.pointerLockElement==e)if(s=t.movementX,n=t.movementY,a){const{width:t,height:i}=e.getBoundingClientRect();s*=devicePixelRatio*e.offsetWidth/t,n*=devicePixelRatio*e.offsetHeight/i}else p||(s*=devicePixelRatio,n*=devicePixelRatio);else{if(g!=g)return;s=t.offsetX-g,n=t.offsetY-b}}finally{g=t.offsetX,b=t.offsetY}d.fireMouse(s,-n)});let _=0,y=0;t.onFlush(()=>{_!==y&&(e.style.cursor="number"==typeof _?l[_]:`url(${CSS.escape(_)})`,y=_)});let x=null,A=0;const E=new BitField,P=t=>{const n=s[t.code]??t.keyCode;if(t.repeat)return E.has(n);x=null;let i=d.setKey(n,!0);return x&&A==n?(document.activeElement!=x&&(m=!0,x.focus(),m=!1),i=!0):document.activeElement!=e&&(i=!1),i?E.set(n):E.unset(n),i},v=t=>{const n=s[t.code]??t.keyCode;x=null;let i=d.setKey(n,!1);return x&&A==~n?(document.activeElement!=x&&(m=!0,x.focus(),m=!1),i=!0):document.activeElement!=e&&(i=!1),E.unset(n),i},w=t=>{if(!m){d.iter(t=>d.setKey(t,!1));for(const t of d._pointers.keys())t<0&&d.setGamepad(~t,null)}},L=t=>{t._ictx=d,t.addEventListener("keydown",P),t.addEventListener("keyup",v),t.addEventListener("blur",w)};L(e),t.captureKeyEvent=(t,e=0,s=!1)=>{(e|=0)<0||(t._ictx||L(t),x=t,A=e^-!s)},t.setFocused=(t=null)=>{t?t._ictx||L(t):t=e,m=!0,t.focus(),m=!1};const N=t=>{_=t},U=t=>{if(-1==t.pointerId)return;const s=new o;s.x=t.offsetX/e.offsetWidth,s.y=1-t.offsetY/e.offsetHeight,s.buttons=t.buttons,s.pressure=t.pressure,s.tiltX=.017453292519943295*t.tiltX,s.tiltY=.017453292519943295*t.tiltY,s.twist=.017453292519943295*t.twist;let n=0;if("mouse"==t.pointerType){if(s.setHint=N,document.pointerLockElement==e)return void(u=s)}else n=f.indexOf(t.pointerId)+1,n||(n=f.push(t.pointerId));e._ictx.setPointer(n,s)};e.addEventListener("pointerover",U),e.addEventListener("pointerdown",U),e.addEventListener("pointermove",U),e.addEventListener("pointerup",U),e.addEventListener("pointerleave",t=>{if(-1==t.pointerId)return;let s=0;if("mouse"!=t.pointerType){if(s=f.indexOf(t.pointerId)+1,!s)return;if(s==f.length){let t=f.length-1;do{f.pop()}while(t&&!f[--t])}else f[s-1]=null}else if(document.pointerLockElement==e)return void(u=null);d.setPointer(s,null)}),e.addEventListener("touchend",t=>t.preventDefault())}}Gamma.gui=e=>{if(!e.Font)throw"Initialize Gamma.font before Gamma.gui";e.GUIElement=class{#t=NaN;#e=NaN;#i=null;_invalidated=!1;_dimensions(){return vec2.zero}invalidate=()=>{this._invalidated=!0,this.#t=this.#e=NaN;const t=this.#i;if(t)if("function"==typeof t)try{t()}catch(t){Promise.reject(t)}else for(const e of t)try{e()}catch(t){Promise.reject(t)}};addDependency(t){if("function"!=typeof t)return;const e=this.#i;e?"function"==typeof e?this.#i=[e,t]:e.push(t):this.#i=t}removeDependency(t){const e=this.#i;if(!e)return;if("function"==typeof e)return void(e===t&&(this.#i=null));let i=e.indexOf(t);if(!(i<0)){for(;i<e.length;)e[i]=e[++i];e.pop()}}get width(){let t=this.#t;if(t!=t){const e=this._dimensions();t=this.#t=e.x,this.#e=e.y}return t}get height(){let t=this.#e;if(t!=t){const e=this._dimensions();this.#t=e.x,t=this.#e=e.y}return t}};class i extends GUIElement{constructor(t){super(),this.texture=t}get width(){return this.texture.width}get height(){return this.texture.height}draw(t,e,i,s){this.texture.then?.(this.invalidate),t.drawRect(0,0,i,s,this.texture)}}class s extends GUIElement{constructor(t){super(),this.text=t}get width(){return this.text.width}get height(){return 1}draw(t,e,i,s){this.text.draw(t)}}e.canvas.style.setProperty("--__gamma__sarea__","env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)"),e.getGUIDimensions=(t=16)=>{t=1/t;const{0:i,1:s,2:h,3:n}=getComputedStyle(e.canvas).getPropertyValue("--__gamma__sarea__").split(" ");return{width:e.canvas.offsetWidth*t,height:e.canvas.offsetHeight*t,paddingLeft:parseFloat(n)*t,paddingRight:parseFloat(s)*t,paddingBottom:parseFloat(h)*t,paddingTop:parseFloat(i)*t}};class h extends GUIElement{constructor(t,e,i){super(),this.child=t,this.pos=e,this.size=i}width=0;height=0;replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}sized(t,e){return this.width=t,this.height=e,this}draw(t,e,i,s){if(!this.child.draw)return;const{width:h,height:n}=this.child;let{size:r,pos:a}=this,l=1,c=1;"function"==typeof r&&(r=r(i/h,s/n)),"number"==typeof r?l=c=r:"object"==typeof r&&r&&(l=r.x,c=r.y);const o=i-h*l,d=s-n*c;"function"==typeof a&&(a=a(o,d)),"object"==typeof a?a&&t.translate(a.x*o,a.y*d):("number"!=typeof a&&(a=.5),t.translate(a*o,a*d)),t.scale(l,c),this.child.draw(t,e,h,n)}}class n extends GUIElement{constructor(t,e,i,s){super(),this.child=t,this.child.addDependency(this.invalidate),this.transform=e,this.anchorX=i,this.anchorY=s}get width(){return this.child.width}get height(){return this.child.height}replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}draw(t,e,i,s){if(!this.child.draw)return;t.translate(i*this.anchorX,s*this.anchorY),this.transform(t,i,s);const{width:h,height:n}=this.child;t.translate(-h*this.anchorX,-n*this.anchorY),this.child.draw(t,e,h,n)}}class r extends GUIElement{constructor(t,e,i,s){super(),this.texture=t,this.pos=e,this.size=i,this.tint=s}width=0;height=0;draw(t,e,i,s){if(!this.texture)return void t.drawRect(0,0,i,s,this.tint);if(!this.texture.loaded)return void this.texture.then?.(this.invalidate);let{width:h,height:n}=this.texture,{size:r,pos:a}=this;"function"==typeof r&&(r=r(i/h,s/n)),"number"==typeof r?(h*=r,n*=r):"object"==typeof r&&r&&(h*=r.x,n*=r.y);let l=i-h,c=s-n;"function"==typeof a&&(a=a(l,c)),"object"==typeof a?a&&(l*=a.x,c*=a.y):("number"!=typeof a&&(a=.5),l*=a,c*=a);const o=1/i,d=1/s;t.drawRect(0,0,i,s,this.texture.super(l*o,c*d,h*o,n*d),this.tint)}}class a extends GUIElement{#s;#h=[];state=0;hitTest=null;constructor(t,e,i){super(),this.#s=t?[t]:[],this.cursor=e,this.activeCursor=i}reset(){this.#s.length=this.#h.length=0}onClick(t){return this.#s.push(t),this}onStateChange(t){return this.#h.push(t),this}setCursor(t){return this.cur=t,this}rounded(t=0,e=t,i=t,s=t){const h=max(t,i),n=max(e,s);return this.hitTest=(r,a,l,c)=>{if(r<h)if(r<i){if(a<i){const t=r-i,e=a-i;if(t*t-e*e>i*i)return!1}}else if(c-a<t){const e=r-t,i=c-a-t;if(e*e-i*i>t*t)return!1}if(l-r>n)if(l-r<s){if(a<s){const t=l-r-s,e=a-s;if(t*t-e*e>s*s)return!1}}else if(c-a<e){const t=r-e,i=c-a-e;if(t*t-i*i>e*e)return!1}return!0},this}#n=-1;#r(t,e,i,s,h){let n=null;switch(!h){case!1:if(this.#n>=0&&s!=this.#n)return;if(n=t.unproject(h),n.x>=0&&n.x<e&&n.y>=0&&n.y<i&&(this.hitTest?.(n.x,n.y,e,i)??1))break;case!0:if(s==this.#n){this.#n=-1;const t=this.state;this.state=0;for(const e of this.#h)try{e(NaN,NaN,0,t)}catch(t){Promise.reject(t)}}return}const r=h.pressed?this.activeCursor:this.cursor;null!=r&&h.setHint?.(r);let a=this.state;this.state=1+h.pressed,-1==this.#n&&(this.#n=s);for(const t of this.#h)try{t(n.x,n.y,this.state,a)}catch(t){Promise.reject(t)}if(2!=this.state&&2==a)for(const t of this.#s)try{t(n.x,n.y,this.state)}catch(t){Promise.reject(t)}return null}draw(t,e,i,s){e.onPointerUpdate(this.#r.bind(this,t,i,s))}}GUIElement;class l extends GUIElement{width=0;height=0;ictx=InputContext();constructor(t){super(),this.child=t,this.child.addDependency(this.invalidate)}sized(t,e){return this.width=t,this.height=e,this}#a=!1;#l=NaN;#c=NaN;#o=NaN;#d=NaN;#f=NaN;#u=NaN;#p=NaN;#e=NaN;#w=NaN;#m=NaN;#g=NaN;#x=0;#y=0;#_=0;#v=-1;#T=0;#E=0;options=0;format=Formats.RGBA;mipmaps=1;hasStencil=!0;#b=null;#D=Drawable();#N=this.#D.subPersp();replace(t){this.child.removeDependency(this.invalidate),(this.child=t).addDependency(this.invalidate)}draw(t,e,i,s){let h,n,r,a,l,c,o,d,f;t.perspective?({a:h,b:n,c:r,d:a,e:l,f:c,g:o,h:d,i:f}=t):(({a:h,b:n,c:a,d:l,e:o,f:d}=t),r=0,c=0,f=1);const{width:u,height:p}=t;if(t.scale(i,s),i!=this.#m||this._invalidated||h!=this.#l||n!=this.#c||s!=this.#g||r!=this.#o||a!=this.#d||l!=this.#f||c!=this.#u||o!=this.#p||d!=this.#e||f!=this.#w||this.#x!=u||this.#y!=p){const e=t.loopBoundary();this.#m=i,this.#g=s,this._invalidated=!1,this.#x=u,this.#y=p,this.#l=h,this.#c=n,this.#o=r,this.#d=a,this.#f=l,this.#u=c,this.#p=o,this.#e=d,this.#w=f,this.#D.hasStencil=this.hasStencil;let w=this.#b;if(e){const m=this.options,g=floor(e.x0*u),x=ceil(e.x1*u)-g,y=floor(e.y0*p),_=ceil(e.y1*p)-y;this.#_=g/u,this.#v=x/u,this.#T=y/p,this.#E=_/p,w&&w.format==this.format&&w.width==x&&w.height==_&&w.format==this.format?(this.#D.clear(0,0,0,0),this.hasStencil&&this.#D.clearStencil()):(w?.delete(),w=this.#b=Texture(x,_,1,m,this.format,this.mipmaps),this.#D.setTarget(0,w),this.mipmaps=w.mipmaps,this.format=w.format),this.#b.options!=m&&(this.#b.option=m),this.ictx.reset();const v=1/this.#v,T=1/this.#E;t.perspective?(this.#N.reset((h-this.#_*r)*v,(n-this.#T*r)*T,r,(a-this.#_*c)*v,(l-this.#T*c)*T,c,(o-this.#_*f)*v,(d-this.#T*f)*T,f),this.child.draw(this.#N,this.ictx,i,s)):(this.#D.reset(h*v,n*T,a*v,l*T,(o-this.#_)*v,(d-this.#T)*T),this.child.draw(this.#D,this.ictx,i,s)),this.mipmaps&&w.genMipmaps()}else this.#v=-1,w&&(this.#D.setTarget(0,null),w.delete(),this.#b=null)}if(this.#v<0)return;const w=t.mask&RGBA;t.mask=SET|NEVER,t.draw(vec4.zero),t.perspective?t.reset(this.#v,0,0,0,this.#E,0,this.#_,this.#T,1):t.reset(this.#v,0,0,this.#E,this.#_,this.#T),t.mask=w|IF_SET|UNSET,t.draw(this.#b),e.onPointerUpdate((e,i)=>{if(e||(this.#a=!!i),!i)return void this.ictx.setPointer(e,null);let s=t.unproject(i);if(s.x>=0&&s.y>=0&&s.x<1&&s.y<1){i.x=s.x,i.y=s.y;const h=this.ictx.setPointer(e,i);return h&&({x:h.x,y:h.y}=t.project(h)),h}this.ictx.setPointer(e,null)}),e.onWheel((t,e)=>{if(this.#a)return this.ictx.fireWheel(t,e)}),e.onMouse((t,e)=>{if(this.#a)return this.ictx.fireMouse(t,e)}),e.onKeyUpdate(this.ictx),e.onGamepadUpdate(this.ictx)}}class c extends GUIElement{#C;constructor(t){super(),this.#C=t}get config(){return this.#C}set config(t){this.#C=t,this.#I.length=0,this.#P.length=0}lastT=NaN;#P=[];#I=[];draw(e){this.#C.prepare?.(e);const i=t-this.lastT||0;this.lastT=t;const s=this.#P.length;if(s){for(let t=s-1;t>=0;t--){const s=this.#P[t];s&&this.#C.update(e,s,i)&&(this.#P[t]=null,this.#I.push(t))}if(this.#I.length>min(s,max(5,s>>1))){this.#I.length=0;let t=0;for(;this.#P[t];)t++;let e=t+1;for(;e<s;){const i=this.#P[e++];i&&(this.#P[t++]=i)}this.#P.length=t}this.invalidate()}}add(...e){const i=this.#C.init(...e);this.#P.length||(this.lastT=t),this.#I.length?this.#P[this.#I.pop()]=i:this.#P.push(i)}}e.GUI={CENTERED:vec2(.5,.5),LEFT:vec2(0,.5),RIGHT:vec2(1,.5),BOTTOM:vec2(.5,0),TOP:vec2(.5,1),BOTTOM_LEFT:vec2(0,0),BOTTOM_RIGHT:vec2(1,0),TOP_LEFT:vec2(0,1),TOP_RIGHT:vec2(1,1),ZStack:(t=>{class e extends GUIElement{children=[];add(t){return this.children.push(t),t.addDependency(this.invalidate),this}remove(t){const e=this.children;if("number"==typeof t){if((t>>>=0)>=e.length)return;for(e[t].removeDependency(this.invalidate);t<e.length;)e[t]=e[++t];e.pop()}else this.children.remove(t)>=0&&t.removeDependency(this.invalidate)}}return e.prototype.draw=t,()=>new e})(function(t,e,i,s){let h=this.children.length;for(const n of this.children)n.draw?.(--h?t.sub():t,e,i,s)}),Img:t=>new i(t),Text:(t="",i=null)=>{if("string"==typeof t){const s=t;t=e.RichText(i),s&&t.add(s)}return new s(t)},Target:(t=null,e=PointerState.POINTER,i=PointerState.POINTER)=>new a(t,e,i),Box:(t,e=.5,i=1)=>new h(t,e,i),BoxFill:(t,e=.5,i=max,s)=>t.identity?new r(t,e,i,s):new r(null,1,1,t),Transform:(t,e=Function.prototype,i=.5,s=.5)=>new n(t,e,i,s),Layer:t=>new l(t),ParticleContainer:t=>new c(t)};e.vec4(.2);const o=({target:t})=>(256&t._field._f||(t._field._f|=256,setImmediate(t._field.recalc)),t.remove(),e.setFocused(p=null)),d=t=>{const e=t.target._field;if(38==t.keyCode||40==t.keyCode){if(e._f>>1&1^t.shiftKey)38==t.keyCode?e.upArrowCb?.():e.downArrowCb?.();else if(2048&e._f)if(e.sel0==e.sel1){let i=e.sel0,s=i,h=e.sel0pos,n=h;for(;n;)i-=e.lines[--n].length;const r=e.lines[h].slice(0,i).width;if(38==t.keyCode&&h){const t=e.lines[h-1];e.sel0=e.sel1=s-i-t.length+t.indexAt(r)}else 40==t.keyCode&&h<e.lines.length-1&&(e.sel0=e.sel1=s-i+e.lines[h].length+e.lines[h+1].indexAt(r))}else 38==t.keyCode?e.sel0=e.sel1:e.sel1=e.sel0}else if(13==t.keyCode){if(!(e._f>>2&1^t.shiftKey))return;e.enterCb?.()}else{if(9!=t.keyCode)return;e._f>>3&1^t.shiftKey?e.tabCb?.():1&e._f&&e.insert("\t")}t.preventDefault()},f=(t,e)=>{const i=document.createElement(t);return i.style="width:1px;height:1px;border:0;padding:0;opacity:0;position:fixed;inset:-9px;font-size:16px;font-family:monospace;white-space:nowrap;pointer-events:none",i.onblur=o,i.onkeydown=d,i.tabIndex=-1,i._field=e,document.documentElement.append(i),i},u=e.vec4;let p=null,w=0;const m=(t,e)=>t.insertLinePass(-1,[e.focus?u(0,.2,.4,.6):u(.2,.2,.2,.6)],0,1),g=(t,i)=>{i&&(t.shader=null,(e.t-w)%1<.5&&t.drawRect(0,i.ascend-1,.05,1,u.one))};class x{_f=0;#S=0;#f=0;get allowTabs(){return!!(1&this._f)}set allowTabs(t){this._f=-2&this._f|1&t}get shiftArrows(){return!!(2&this._f)}set shiftArrows(t){this._f=-3&this._f|2&-t}get shiftEnter(){return!!(4&this._f)}set shiftEnter(t){this._f=-5&this._f|4&-t}get shiftTab(){return!!(8&this._f)}set shiftTab(t){this._f=-9&this._f|8&-t}upArrowCb=null;downArrowCb=null;enterCb=null;tabCb=null;scrollable=null;#w;constructor(t){this.#w=f(t?"textarea":"input",this),this._f=t}get value(){return this.#w.value}set value(t){this.#w.value=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}get sel0(){return this.#S}set sel0(t){t>>>=0,this.#f>=this.#S?t<=this.#f?this.#w.selectionStart=t:(this.#w.selectionStart=this.#f,this.#w.selectionEnd=t,this.#w.selectionDirection="backward"):t>this.#f?this.#w.selectionEnd=t:(this.#w.selectionStart=t,this.#w.selectionEnd=this.#f,this.#w.selectionDirection="forward"),this.#S=t}get sel1(){return this.#f}set sel1(t){t>>>=0,this.#f>=this.#S?t>=this.#S?this.#w.selectionEnd=t:(this.#w.selectionStart=t,this.#w.selectionEnd=this.#S,this.#w.selectionDirection="backward"):t<this.#S?this.#w.selectionStart=t:(this.#w.selectionStart=this.#S,this.#w.selectionEnd=t,this.#w.selectionDirection="forward"),this.#f=t}select(t,e=t){(t>>>=0)<=(e>>>=0)?(this.#w.selectionStart=t,this.#w.selectionEnd=e,this.#S>this.#f&&(this.#w.selectionDirection="forward")):(this.#w.selectionStart=e,this.#w.selectionEnd=t,this.#S<=this.#f&&(this.#w.selectionDirection="backward")),this.#S=t,this.#f=e,256&this._f||(this._f|=256,setImmediate(this.recalc))}get selStart(){return min(this.#S,this.#f)}get selEnd(){return max(this.#S,this.#f)}get isSelecting(){return!!(512&this._f)}#k=null;get transformer(){return this.#k}set transformer(t){this.#k!=(this.#k=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}simpleTransformer(t,i="",...s){let h=s.slice();h[0]=s[0]?u.multiply(s[0],.4):u(.4),this.#k=n=>{const r=e.RichText(t);return s.length&&r.setTextPass(0,s),n?r.add(n):(r.setTextPass(0,h),r.index=!1,r.add(i)),r},256&this._f||(this._f|=256,setImmediate(this.recalc))}#U=g;#G=m;#F=null;#R=null;#A=1/0;#m=0;#H=0;#t=0;get sel0pos(){return this.#m}get sel1pos(){return this.#H}get multiline(){return!!(2048&this._f)}set multiline(t=!0){const i=this.#w,s=i.value,h=document.activeElement==i;if(t){if(2048&this._f)return;this.#F=null,this._f|=2304,this.#w=f("textarea",this)}else{if(!(2048&this._f))return;this.#R=null,this._f=-2049&this._f|256,this.#w=f("input",this)}h?this.focus=!0:(i.remove(),p==i&&e.setFocused(p=null),256&this._f||(this._f|=256,setImmediate(this.recalc))),this.#w.value=s,this.#w.selectionStart=this.#S,this.#w.selectionEnd=this.#f,this.#w.selectionDirection=this.#S>this.#f?"backward":"forward"}get width(){return this.#t}get line(){return this.#F}get lines(){return this.#R}get cursor(){return this.#U}set cursor(t){this.#U!=(this.#U=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get selector(){return this.#G}set selector(t){this.#G!=(this.#G=t)&&!(256&this._f)&&(this._f|=256,setImmediate(this.recalc))}get maxWidth(){return this.#A}set maxWidth(t){this.#A=t,256&this._f||(this._f|=256,setImmediate(this.recalc))}recalc=()=>{const t=this._f;if(!(256&t))return;const i=this.#w,s=min(this.#S,this.#f),h=max(this.#S,this.#f);this._f=-257&t,w=e.t;const n=i.value,r=this.#k?.(n,this)??e.RichText();if(s==h){const e=r.slice(s);r.trim(s),2048&t||(this.#m=this.#H=r.width),this.#U&&document.activeElement==this.#w&&r.addCb(this.#U),r.concat(e)}else{const e=r.slice(s),i=e.slice(h-s);e.trim(h-s),r.trim(s),2048&t?(this.#G?.(e,this),r.concat(e)):(this.#m=r.width,this.#G?.(e,this),r.concat(e),this.#H=r.width),r.concat(i)}if(2048&t){const t=this.#R=r.break(this.#A);let e=0;for(const{width:i}of t)i>e&&(e=i);this.#t=e;let i=s,n=0;for(;n<t.length&&i>=0;)i-=t[n++].length;for(i=h-s+i+(n?t[--n].length:0),this.#m=n;n<t.length&&i>=0;)i-=t[n++].length;this.#H=n?n-1:0}else this.#F=r,this.#t=r.width};insert(t="",e=t.length){const i=this.#w,s=i.selectionStart;i.setRangeText(t,s,i.selectionEnd,"start"),i.selectionStart=i.selectionEnd=this.#S=this.#f=s+e}get focus(){return document.activeElement==this.#w}set focus(t=!0){if(t){if(p){if(p==this.#w)return;p.replaceWith(p=this.#w)}else document.documentElement.append(p=this.#w);e.setFocused(p),w=e.t,256&this._f||(this._f|=256,setImmediate(this.recalc))}else p==this.#w&&(p.remove(),e.setFocused(p=null))}lineHeight=1.3;lineAscend=.9;#O=0;#j=-1;#r(e,i,s){if(!s)return void(i==this.#j&&(this.#j=-1,this._f&=-1537));if(s.setHint?.(PointerState.TEXT),-1==this.#j&&s.pressed)this.#j=i,this.focus=!0;else if(this.#j!=i)return null;if(!s.pressed)return this.#j=-1,this._f&=-1537,null;let{x:h,y:n}=e.unproject(s);n=this.lineAscend-n;const r=this._f>>9&3;if(3==r)return null;let a=0;if(this.#F)a=this.#F.indexAt(h);else if(this.#R){let t=floor(n/this.lineHeight);for(t=t>=0?t>=this.#R.length?this.#R.length-1:t>>>0:0,a=this.#R[t].indexAt(h);t;)a+=this.#R[--t].length}if(r)this.sel1=a;else{let e=0,i=a,s=a;if(this.#O<0?this.#O-(this.#O=-t)<.3?e=2:this.#O=t:this.#O>0?this.#O-(this.#O=t)>-.3&&(e=1,this.#O=-t):this.#O=t,this._f|=512|(e>0)<<10,e){const t=this.#w.value,h=33-e;for(;t.charCodeAt(s++)>h;);for(;t.charCodeAt(--i)>h;);i++,s--}i==this.#S&&s==this.#f||this.select(i,s)}return null}get height(){return this.lineHeight*(this.#R?this.#R.length:1)}layout(t,i,s=-1/0,h=-1/0,n=1/0,r=1/0){i.onPointerUpdate(this.#r.bind(this,t)),i.onKeyUpdate((t,i)=>(e.captureKeyEvent(this.#w,t,i),!1))}get height(){return this.#R?this.#R.length*this.lineHeight:this.lineHeight}get xOffset(){return 0}get yOffset(){return-this.lineAscend}draw(t,e){if(this.#R)for(const e of this.#R)e.draw(t.sub()),t.translate(0,-this.lineHeight);else this.#F?.draw(t)}static#z=(document.addEventListener("input",({target:t})=>{const e=t._field;if(!e)return;const{selectionStart:i,selectionEnd:s,selectionDirection:h}=t;"backward"==h?(e.#S=s,e.#f=i):(e.#S=i,e.#f=s),256&e._f||(e._f|=256,setImmediate(e.recalc))}),document.addEventListener("selectionchange",({target:t})=>{const e=t._field;if(!e)return;const{selectionStart:i,selectionEnd:s,selectionDirection:h}=t;"backward"==h?(e.#S=s,e.#f=i):(e.#S=i,e.#f=s),256&e._f||(e._f|=256,setImmediate(e.recalc))}))}e.TextField=(t=!1)=>new x(t<<11&2048),e.TextField.cursorTimer=()=>e.t-w};{Object.defineProperties(Array.prototype,{best:{enumerable:!1,value(t,i=-1/0){let e;const s=this.length;for(let h=0;h<s;h++){const s=this[h],r=t(s,h,this);r>=i&&(i=r,e=s)}return e}},mmap:{enumerable:!1,value(t){const i=this.length;for(let e=0;e<i;e++)this[e]=t(this[e]);return this}},bind:{enumerable:!1,value(t,i=-1){if((i>>>=0)>=this.length)return this.push(t);let e;for(;i<this.length;)e=this[i],this[i++]=t,t=e;return this.push(e)}},fire:{enumerable:!1,value(...t){for(const i of this)try{i(...t)}catch(t){Promise.reject(t)}}},mapFire:{enumerable:!1,value(...t){const i=[];for(const e of this)try{i.push(e(...t))}catch(t){Promise.reject(t),i.push(void 0)}return i}},remove:{enumerable:!1,value(t){let i=this.indexOf(t);if(i>=0){for(;i<this.length;)this[i]=this[++i];this.pop()}return i}}}),globalThis.TypedArray??=Object.getPrototypeOf(Uint8Array),Uint8Array.fromHex=function(t){const i=new Uint8Array(t.length>>>1);let e=1,s=0;for(let h=0;h<t.length;h++){const r=t.charCodeAt(h);r>47&&r<58?e=e<<4|r-48:r>64&&r<71?e=e<<4|r-55:r>96&&r<103&&(e=e<<4|r-87),256&e&&(i[s++]=e,e=1)}return i.slice(0,s)},Uint16Array.fromHex=function(t){const i=new Uint16Array(t.length>>>2);let e=1,s=0;for(let h=0;h<t.length;h++){const r=t.charCodeAt(h);r>47&&r<58?e=e<<4|r-48:r>64&&r<71?e=e<<4|r-55:r>96&&r<103&&(e=e<<4|r-87),65536&e&&(i[s++]=e,e=1)}return i.slice(0,s)},globalThis.hsla=(t,i,e,s=1)=>{t*=1/30,t%=12,t+=12*(t<0);const h=i*(e<.5?e:1-e);return vec4(max(0,e-h*max(3-abs(t-6),-1)),max(0,e-h*max(3-abs(t+12*(t<4)-10),-1)),max(0,e-h*max(3-abs(t-12*(t>=8)-2),-1)),s)};const t="0123456789abcdef";Number.prototype.toHex=function(){return t[this>>>28]+t[this>>24&15]+t[this>>20&15]+t[this>>16&15]+t[this>>12&15]+t[this>>8&15]+t[this>>4&15]+t[15&this]},Number.formatData=t=>t<512?t.toFixed(0)+"B":t<524288?(t/1024).toFixed(1)+"KiB":t<536870912?(t/1048576).toFixed(1)+"MiB":t<549755813888?(t/1073741824).toFixed(1)+"GiB":(t/1099511627776).toFixed(1)+"TiB",Date.safestamp=(t=new Date)=>`${t.getYear()+1900}-${("0"+t.getMonth()).slice(-2)}-${("0"+t.getDate()).slice(-2)}-at-${("0"+t.getHours()).slice(-2)}-${("0"+t.getMinutes()).slice(-2)}-${("0"+t.getSeconds()).slice(-2)}`,globalThis.randint??=Math.randint??=()=>4294967296*Math.random()|0;const i=document.createElement("a");globalThis.download=(t,e=t.name??("@"==t.type[0]?"file":t.type.split("/",1)[0]))=>{i.href=URL.createObjectURL(t),i.download=e,i.click(),URL.revokeObjectURL(i.href)};const{floor:e,trunc:s,fround:h}=Math,r="transfer"in ArrayBuffer.prototype?(t,i=0)=>{t.buf8=new Uint8Array((t.buf=new DataView(t.buf.buffer.transfer(t.cap=(t.cap<<1)+i))).buffer)}:(t,i=0)=>{const e=new Uint8Array(new ArrayBuffer(t.cap=(t.cap<<1)+i));e.set(t.buf8,0),t.buf=new DataView(e.buffer),t.buf8=e};let n=(t,i,e,s)=>(t.encode=i,t.decode=e,t.size=s,t);globalThis.Nanobuf={decoder:new TextDecoder,encoder:new TextEncoder,BufReader:class t extends DataView{constructor(t){t instanceof ArrayBuffer?super(t):super(t.buffer,t.byteOffset,t.byteLength),this.i=this.bitState=0}decode(t,i){return t.decode(this,i)}b1(){let t=this.bitState;if(t<2)try{t=256|this.getUint8(this.i++)}catch{t=256}return this.bitState=t>>1,1&t}b2(){let t=this.bitState;if(t<4)try{t=t&(t=+(t<2))|(256|this.getUint8(this.i++))<<t}catch{t=256<<t}return this.bitState=t>>2,3&t}b4(){let t=this.bitState;if(t<16){let i=-21936>>(t<<1)&3;try{t=t&7>>3-i|(256|this.getUint8(this.i++))<<i}catch{t=256<<i}}return this.bitState=t>>4,15&t}u8(){try{return this.getUint8(this.i++)}catch{return 0}}i8(){try{return this.getInt8(this.i++)}catch{return 0}}u16(){try{return this.getUint16((this.i+=2)-2)}catch{return 0}}i16(){try{return this.getInt16((this.i+=2)-2)}catch{return 0}}u24(){try{return this.getUint8(this.i)<<16|this.getUint16((this.i+=3)-2)}catch{return 0}}i24(){try{return this.getInt8(this.i)<<16|this.getUint16((this.i+=3)-2)}catch{return 0}}u32(){try{return this.getUint32((this.i+=4)-4)}catch{return 0}}i32(){try{return this.getInt32((this.i+=4)-4)}catch{return 0}}u48(){try{return 4294967296*this.getUint16((this.i+=6)-6)+this.getUint32(this.i-4)}catch{return 0}}i48(){try{return 4294967296*this.getInt16((this.i+=6)-6)+this.getUint32(this.i-4)}catch{return 0}}u64(){try{return 4294967296*this.getUint32((this.i+=8)-8)+this.getUint32(this.i-4)}catch{return 0}}i64(){try{return 4294967296*this.getInt32((this.i+=8)-8)+this.getUint32(this.i-4)}catch{return 0}}bu64(){try{return this.getBigUint64((this.i+=8)-8)}catch{return 0}}bi64(){try{return this.getBigInt64((this.i+=8)-8)}catch{return 0}}f32(){try{return this.getFloat32((this.i+=4)-4)}catch{return 0}}f64(){try{return this.getFloat64((this.i+=8)-8)}catch{return 0}}bool(){try{return 0!=this.getUint8(this.i++)}catch{return 0}}v64(){try{const t=this.getUint8(this.i++);return t<64?t:t>=128?4294967296*(2147483647&this.getUint32((this.i+=7)-8))+this.getUint32(this.i-4):t>=96?536870911&this.getUint32((this.i+=3)-4):this.getUint8(this.i++)|t<<8&8191}catch{return 0}}bv64(){try{let t=this.getUint8(this.i++);if(t>=64){if(t>=128)return 0x7FFFFFFFFFFFFFFFn&this.getBigUint64((this.i+=7)-8);t=t>=96?536870911&this.getUint32((this.i+=3)-4):this.getUint8(this.i++)|t<<8&8191}return BigInt(t)}catch{return 0}}v32(){try{const t=this.getUint8(this.i++);return t<64?t:t>=128?2147483647&this.getUint32((this.i+=3)-4):this.getUint8(this.i++)|t<<8&16383}catch{return 0}}v16(){try{const t=this.getUint8(this.i++);return t<128?t:this.getUint8(this.i++)|t<<8&16383}catch{return 0}}skip(t){this.i+=t}u8arr(t=-1){try{let i=this.i;return t<0&&(t=this.getUint8(i++))>=64&&(t>=128?(t=2147483647&this.getUint32(i),i+=3):t=this.getUint8(this.i++)|t<<8&16383),this.i=i+t,new Uint8Array(this.buffer.slice(i+=this.byteOffset,t))}catch{return new Uint8Array}}str(){let t=this.i,i=this.getUint8(t++);return i>=64&&(i>=128?(i=2147483647&this.getUint32(t),t+=3):i=this.getUint8(this.i++)|i<<8&16383),this.i=t+i,decoder.decode(new Uint8Array(this.buffer,this.byteOffset+t,i))}enum({intToStr:t,defaultString:i}){let e=this.getUint8(this.i++);return e>64&&(e=e>=128?2147483647&this.getUint32((this.i+=3)-4):this.getUint8(this.i++)|e<<8&16383),t[e]??i}view(t=0){return new Uint8Array(this.buffer,this.byteOffset+(this.i+=t)-t,t)}get read(){return this.i}get remaining(){return this.byteLength-this.i}get overran(){return this.i>this.byteLength}toUint8Array(){return new Uint8Array(this.buffer,this.byteOffset+this.i,this.byteLength-this.i)}copyReadToArrayBuffer(){return this.buffer.slice(this.byteOffset,this.byteOffset+this.i)}copyRemainingToArrayBuffer(){return this.buffer.slice(this.byteOffset+this.i,this.byteOffset+this.byteLength)}copyToWriter(){return new BufWriter(this.buffer.slice(this.byteOffset,this.byteOffset+this.i),this.i)}copy(){return new t(this.buffer.slice(this.byteOffset+this.i,this.byteOffset+this.byteLength))}[Symbol.for("nodejs.util.inspect.custom")](){let t=`BufReader(${this.byteLength-this.i}) [ [33m`,{i:i}=this;const e=i+50>this.byteLength?this.byteLength:i+50;for(;i<e;){const e=this.getUint8(i++);t+="0123456789abcdef"[e>>4]+"0123456789abcdef"[15&e]+" "}return t+`[m${this.byteLength>e?"... ":""}]`}},BufWriter:class t{constructor(t=new ArrayBuffer(64),i=0){this.buf=new DataView(t),this.buf8=new Uint8Array(t),this.i=i<=(this.cap=t.byteLength)?i:this.cap,this.bitState=0}encode(t,i){return t.encode(this,i)}b1(t=0){let i=this.bitState;7&i||(this.i>=this.cap&&r(this),i=this.i<<3,this.buf8[this.i++]=0),this.buf8[i>>>3]|=t<<(7&i),this.bitState=i+1}b2(t=0){let i=this.bitState,e=7&i;if(e){if(this.buf8[i>>>3]|=t<<e,e<7)return void(this.bitState=i+2);i=e=1}else i=2;this.i>=this.cap&&r(this),this.bitState=i|this.i<<3,this.buf8[this.i++]=t>>e}b4(t=0){let i=this.bitState,e=7&i;if(e){if(this.buf8[i>>>3]|=t<<e,e<5)return void(this.bitState=i+4);i=e-4,e=8-e}else i=4;this.i>=this.cap&&r(this),this.bitState=i|this.i<<3,this.buf8[this.i++]=t>>e}u8(t=0){this.i>=this.cap&&r(this),this.buf8[this.i++]=t}i8(t=0){this.i>=this.cap&&r(this),this.buf8[this.i++]=t}u16(t=0){(this.i+=2)>this.cap&&r(this),this.buf8[this.i-2]=t>>8,this.buf8[this.i-1]=t}i16(t=0){(this.i+=2)>this.cap&&r(this),this.buf8[this.i-2]=t>>8,this.buf8[this.i-1]=t}u24(t=0){(this.i+=3)>this.cap&&r(this),this.buf8[this.i-3]=t>>16,this.buf8[this.i-2]=t>>8,this.buf8[this.i-1]=t}i24(t=0){(this.i+=3)>this.cap&&r(this),this.buf8[this.i-3]=t>>16,this.buf8[this.i-2]=t>>8,this.buf8[this.i-1]=t}u32(t=0){(this.i+=4)>this.cap&&r(this),this.buf.setUint32(this.i-4,t)}i32(t=0){(this.i+=4)>this.cap&&r(this),this.buf.setInt32(this.i-4,t)}u48(t=0){(this.i+=6)>this.cap&&r(this),this.buf.setUint16(this.i-6,e(s(t)/4294967296)),this.buf.setInt32(this.i-4,0|t)}i48(t=0){(this.i+=6)>this.cap&&r(this),this.buf.setInt16(this.i-6,e(s(t)/4294967296)),this.buf.setInt32(this.i-4,0|t)}u64(t=0){(this.i+=8)>this.cap&&r(this),this.buf.setUint32(this.i-8,e(s(t)/4294967296)),this.buf.setInt32(this.i-4,0|t)}i64(t=0){(this.i+=8)>this.cap&&r(this),this.buf.setInt32(this.i-8,e(s(t)/4294967296)),this.buf.setInt32(this.i-4,0|t)}bu64(t=0n){(this.i+=8)>this.cap&&r(this),this.buf.setBigUint64(this.i-8,t)}bi64(t=0n){(this.i+=8)>this.cap&&r(this),this.buf.setBigInt64(this.i-8,t)}f32(t=0){(this.i+=4)>this.cap&&r(this),this.buf.setFloat32(this.i-4,t)}f64(t=0){(this.i+=8)>this.cap&&r(this),this.buf.setFloat64(this.i-8,t)}bool(t=!1){this.i>=this.cap&&r(this),this.buf8[this.i++]=t}v64(t=0){this.i>this.cap-8&&r(this),t>63?t>536870911?(this.buf.setUint32((this.i+=8)-8,2147483648|e(s(t)/4294967296)),this.buf.setInt32(this.i-4,0|t)):t>8191?this.buf.setInt32((this.i+=4)-4,1610612736|t):(this.buf8[this.i++]=t>>8|64,this.buf8[this.i++]=t):this.buf8[this.i++]=t<0?0:t}bv64(t=0n){this.i>this.cap-8&&r(this);const i=Number(t);i>63?i>536870911?this.buf.setBigUint64((this.i+=8)-8,0x8000000000000000n|t):i>0x1FFFn?this.buf.setInt32((this.i+=4)-4,1610612736|i):(this.buf8[this.i++]=i>>8|64,this.buf8[this.i++]=i):this.buf8[this.i++]=i<0?0:i}v32(t=0){this.i>this.cap-4&&r(this),t>63?t>16383?this.buf.setInt32((this.i+=4)-4,2147483648|t):(this.buf8[this.i++]=t>>8|64,this.buf8[this.i++]=t):this.buf8[this.i++]=t<0?0:t}v16(t=0){this.i>this.cap-2&&r(this),t>127?(this.buf8[this.i++]=t>>8|128,this.buf8[this.i++]=t):this.buf8[this.i++]=t>=0?t:0}u8arr(i,e=-1){if(!(i instanceof Uint8Array)){if(!(i instanceof t))return this.i>=this.cap&&r(this),void(this.buf8[this.i++]=0);i=i.buf8.subarray(0,i.i)}if(e<0){if((e=i.byteLength)>2147483647)return this.i>=this.cap&&r(this),void(this.buf8[this.i++]=0);this.i>this.cap-4-e&&r(this,e),e>16383?e>2147483647?this.buf8[this.i++]=e=0:this.buf.setInt32((this.i+=4)-4,2147483648|e):e>63?(this.buf8[this.i++]=e>>8|64,this.buf8[this.i++]=e):this.buf8[this.i++]=e}else this.i>this.cap-e&&r(this,e);this.buf8.set(i,this.i),this.i+=e}skip(t=0){(this.i+=t)>this.cap&&r(this,t)}str(t=""){this.i>this.cap-4&&r(this);const i=encoder.encode(t);let e=i.length;if(e>2147483647)return this.i>=this.cap&&r(this),void(this.buf8[this.i++]=0);this.i>this.cap-4-e&&r(this,e),e>16383?e>2147483647?this.buf8[this.i++]=e=0:this.buf.setInt32((this.i+=4)-4,2147483648|e):e>63?(this.buf8[this.i++]=e>>8|64,this.buf8[this.i++]=e):this.buf8[this.i++]=e,new Uint8Array(this.buffer).set(i,this.i),this.i+=e}enum({strToInt:t,default:i},e){this.i>this.cap-4&&r(this);const s=t.get(e)??i;s>63?s>16383?this.buf.setInt32((this.i+=4)-4,2147483648|s):(this.buf8[this.i++]=s>>8|64,this.buf8[this.i++]=s):this.buf8[this.i++]=s<0?0:s}get written(){return this.i}get buffer(){return this.buf.buffer}get byteOffset(){return 0}get byteLength(){return this.i}toUint8Array(){return this.buf8.subarray(0,this.i)}toReader(){return new BufReader(this)}copyToArrayBuffer(){return this.buf8.buffer.slice(0,this.i)}copy(){return new t(this.buf.buffer.slice(0,this.i),this.i)}copyToReader(){return new BufReader(this.buf8.buffer.slice(0,this.i))}[Symbol.for("nodejs.util.inspect.custom")](){let{i:t}=this,i=`BufWriter(${t}) [ ${t>50?(t-=50,"... "):(t=0,"")}[33m`;for(;t<this.i;){const e=this.buf8[t++];i+="0123456789abcdef"[e>>4]+"0123456789abcdef"[15&e]+" "}return i+"[m]"}},b1:n((t=0)=>+!!t,(t,i)=>t.b1(i),(t,i)=>t.b1(),0),b2:n((t=0)=>3&("number"==typeof t?t:Number(t)),(t,i)=>t.b2(i),(t,i)=>t.b2(),0),b4:n((t=0)=>15&("number"==typeof t?t:Number(t)),(t,i)=>t.b4(i),(t,i)=>t.b4(),0),u8:n((t=0)=>255&("number"==typeof t?t:Number(t)),(t,i)=>t.u8(i),(t,i)=>t.u8(),1),i8:n((t=0)=>("number"==typeof t?t:Number(t))<<24>>24,(t,i)=>t.i8(i),(t,i)=>t.i8(),1),u16:n((t=0)=>65535&("number"==typeof t?t:Number(t)),(t,i)=>t.u16(i),(t,i)=>t.u16(),2),i16:n((t=0)=>("number"==typeof t?t:Number(t))<<16>>16,(t,i)=>t.i16(i),(t,i)=>t.i16(),2),u24:n((t=0)=>16777215&("number"==typeof t?t:Number(t)),(t,i)=>t.u24(i),(t,i)=>t.u24(),3),i24:n((t=0)=>("number"==typeof t?t:Number(t))<<8>>8,(t,i)=>t.i24(i),(t,i)=>t.i24(),3),u32:n((t=0)=>("number"==typeof t?t:Number(t))>>>0,(t,i)=>t.u32(i),(t,i)=>t.u32(),4),i32:n((t=0)=>0|("number"==typeof t?t:Number(t)),(t,i)=>t.i32(i),(t,i)=>t.i32(),4),u48:n((t=0)=>4294967296*(65535&e(s(t="number"==typeof t?t:Number(t))/4294967296))+(t>>>0),(t,i)=>t.u48(i),(t,i)=>t.u48(),6),i48:n((t=0)=>4294967296*(e(s(t="number"==typeof t?t:Number(t))/4294967296)<<16>>16)+(t>>>0),(t,i)=>t.i48(i),(t,i)=>t.i48(),6),u64:n((t=0)=>4294967296*(e(s(t="number"==typeof t?t:Number(t))/4294967296)>>>0)+(t>>>0),(t,i)=>t.u64(i),(t,i)=>t.u64(),8),i64:n((t=0)=>4294967296*(0|e(s(t="number"==typeof t?t:Number(t))/4294967296))+(t>>>0),(t,i)=>t.i64(i),(t,i)=>t.i64(),8),bu64:n((t=0n)=>0xFFFFFFFFFFFFFFFFn&("bigint"==typeof t?t:BigInt(t)),(t,i)=>t.bu64(i),(t,i)=>t.bu64(),8),bi64:n((t=0n)=>BigInt.asIntN(64,"bigint"==typeof t?t:BigInt(t)),(t,i)=>t.bi64(i),(t,i)=>t.bi64(),8),f32:n((t=0)=>h("number"==typeof t?t:Number(t)),(t,i)=>t.f32(i),(t,i)=>t.f32(),4),f64:n((t=0)=>"number"==typeof t?t:Number(t),(t,i)=>t.f64(i),(t,i)=>t.f64(),8),v16:n((t=0)=>(t="number"==typeof t?t:Number(t))<0?0:32767&t,(t,i)=>t.v16(i),(t,i)=>t.v16(),1),v32:n((t=0)=>(t="number"==typeof t?t:Number(t))<0?0:2147483647&t,(t,i)=>t.v32(i),(t,i)=>t.v32(),1),v64:n((t=0)=>("number"==typeof t?t:Number(t))<0?0:t%0x8000000000000000,(t,i)=>t.v32(i),(t,i)=>t.v32(),1),bv64:n((t=0n)=>("bigint"==typeof t?t:BigInt(t))<0n?0n:0x7FFFFFFFFFFFFFFFn&t,(t,i)=>t.v32(i),(t,i)=>t.v32(),1),u8arr:n(t=>{try{const i="string"==typeof t?encoder.encode(t):new Uint8Array(t.buffer?t.buffer.slice(t.byteOffset,t.byteLength):t instanceof ArrayBuffer?t.slice(0,2147483647):t);return i.byteLength>2147483647?i.subarray(0,2147483647):i}catch{return new Uint8Array}},(t,i)=>t.u8arr(i),(t,i)=>t.u8arr(),1),str:n((t="")=>t+"",(t,i)=>t.str(i),(t,i)=>t.str(),1),bool:n(t=>!!t,(t,i)=>t.bool(i),(t,i)=>t.bool(),1),Struct:(t,i)=>{const e=[],s=[],h=[],r=[],n=[];let u=0,f=0;const b={};for(const i in t){let a=/^[a-zA-Z$_][a-zA-Z0-9$_]*$/.test(i)?i:JSON.stringify(i);e.push(a+":a"+u),s.push(a+":this.a"+u+"(a"+u+")"),h.push("this.a"+u+".encode(b,a"+u+")"),n.push(a+":this.a"+u+".decode(b)"),a=a.length==i.length?"v."+a:"v["+a+"]",r.push(a+"=this.a"+u+".decode(b,"+a+")"),f+=(b["a"+u++]=t[i]).size??0}const a=`return{${s}}`;return i??=new Function(`{${e}}={}`,a).bind(b),i.encode=new Function(`b,{${e}}={}`,h.join(";")).bind(b),i.decode=new Function("b,v",`if(!v)return {${n}};${r.join(";")};return v`).bind(b),i.size=f,i.of=new Function(Object.keys(b),a).bind(b),i},Arr:(t,i=-1)=>{(i=e(i))>=0||(i=-1);const s=n(e=>{const s=[];try{for(const i of e)s.push(t(i))}catch{}if(i>=0)if(s.length>i)s.length=i;else for(;s.length<i;)s.push(t());else s.length>2147483647&&(s.length=2147483647);return s},(e,s=[])=>{const h=i<0?(e.v32(s.length),s.length):i;for(let i=0;i<h;i++)t.encode(e,s[i])},(e,s)=>{const h=i<0?e.v32():i;if(s)for(let i=0;i<h;i++)s[i]=t.decode(e,s[i]);else{s=[];for(let i=h;--i>=0;)s.push(t.decode(e))}return s},i<0?1:(t.size??0)*i);return s.of=(...t)=>s(t),s},Optional:t=>n(i=>null==i?null:t(i),(i,e)=>{null==e?i.u8(0):(i.u8(1),t.encode(i,e))},(i,e)=>i.u8()?t.decode(i,e):null,1),Enum:(t=[],i=void 0)=>{const e=new Map,s=[];if(Array.isArray(t))for(let i=0;i<t.length;i++)e.set(t[i]+"",i),s[i]=t[i];else for(const i in t){const h=2147483647&t[i];e.set(i,h),s[h]=i}"string"!=typeof i&&(i=e.keys().next().value??"");let h=-1;for(;s[++h];);const r=n(t=>"string"==typeof t?e.get(t)??h:2147483647&Number(t),(t,i)=>t.v32("string"==typeof i?e.get(i)??h:i),(t,e)=>s[t.v32()]??i,1);return r.strToInt=e,r.intToStr=s,r.default=h,r.defaultString=i,r},Padding:(t=0)=>n(()=>{},(i,e)=>i.skip(t),(i,e)=>{i.i+=t},t)},globalThis.Nanobuf.u8arr.len=t=>((t=e(t))>=0||(t=0),n(i=>i instanceof ArrayBuffer?new Uint8Array(i.byteLength>=t?i.slice(0,t):t):new Uint8Array(i?.length===t?i:t),(i,e)=>i.u8arr(e,t),(i,e)=>i.u8arr(t),t)),globalThis.loader=({url:t})=>(t=t.slice(0,t.lastIndexOf("/")+1),(...i)=>{if(i[0].raw){const e=[i[0][0]];for(let t=1;t<=i.length;t++)e.push(i[t],i[0][t]);const s=e.join("");return"/"==s[0]?s:t+s}return 1==i.length?"/"==i[0][0]?i[0]:t+i[0]:i.map(i=>"/"==i[0]?i:t+i)}),Array.map??=(t=0,i)=>{const e=[];for(let s=0;s<t;s++)e.push(i(s));return e},Gamma.utils=t=>{Object.assign(t,Nanobuf),t.screenshot=(i="image/png",e)=>new Promise(s=>requestAnimationFrame(()=>t.canvas.toBlob(s,i,e)))}}
>>>>>>> dbafe13 (build in order)
