Gamma.font=e=>{const t=e.vec4.one,s={x:0,y:1},n=e.Geometry2D.SQUARE,o=e.Shader.MSDF=e.Shader("void main(){vec3 c=param0(pos).rgb;color=param2*clamp(param1.y*(max(min(c.r,c.g),min(max(c.r,c.g),c.b))-.5+param1.x)+.5,0.,1.);}",{params:[e.COLOR,e.VEC2,e.VEC4],defaults:[null,{x:0,y:1},t]});e.Shader.font=(t,s={})=>{let n="float field(vec2 uv){vec3 c=param0(uv).rgb;return max(min(c.r, c.g), min(max(c.r, c.g), c.b)); }\n#define scale param1\n";Array.isArray(s.params)||(s.params="number"==typeof s.params?[s.params]:[]),Array.isArray(s.defaults)||(s.defaults=void 0===s.defaults?[]:[s.defaults]);for(let e=0;e<s.params.length;e++)n+=`#define value${e} param${e+2}\n`;return s.params.unshift(e.COLOR,e.VEC2),s.defaults.unshift(void 0,{x:0,y:1}),e.Shader(n+t,s)};const r=e.BreakToken=(e,t=0,s="",n=void 0)=>{if(e instanceof RegExp){let t=e.flags,s=t.indexOf("g");s>-1&&(t=t.slice(0,s)+t.slice(s+1)),t.includes("y")||(t+="y"),t!=e.flags&&(e=new RegExp(e.source,t))}else{let t="[";for(const s of e+""){const e=s.codePointAt();t+=e>=92&&e<=94||45==e?"\\"+s:s}e=new RegExp(t+"]","y")}return e.type=t,e.sep=s,e.next=n,e.sepW=e.sepA=e.sepS=0,e.sepL=null,e};r.NORMAL=0,r.NEVER_BREAK=1,r.ALWAYS_BREAK=2,r.OVERFLOW=3,r.VANISH=4,r.TRUNCATE=5,r.SQUISH=6,r.SQUISH_BREAK=7,r.WRAP_AFTER=8,r.WRAP_BEFORE=16,r.INVISIBLE=32;const i=[r(/\r\n?|\n/y,r.WRAP_AFTER|r.INVISIBLE,""),r(/[$£"+]?[\w'-]+[,.!?:;"^%€*]?/iy,r.NORMAL,"-"),r(/[ \t]+/y,r.VANISH)],a=r(/[^]/y,r.ALWAYS_BREAK),c={x:0,y:0},l={off:0,spr:-1,0:null,1:c},f=[0,0,0,l],h=(e,t,s,n=0)=>{if(e.sepL=t,e.sepA=s,e.sepS=n,!t)return e.sepW=0;let o=0;const r=1/s;for(const i of e.sep){const e=i.codePointAt(),a=(t.get(~e)??t._default)._xadv+n+(t.get(e+-1114112)??0);o+=s&&asin(a*s)*r||a}return t.then?.(()=>e.sepL==t&&(e.sepL=null,e.sepW=0)),e.sepW=o};class u extends Array{#e=null;#t=o;#s=n;#n=1;#o=0;#r=1;#i=0;#a=0;#c=0;#l=f;#f=0;#h=NaN;#u=null;#p=!0;static public=class e{constructor(e){this.#b=e}sub(){const t=new e(this.#b);return t.#y=this.#y,t.#g=this.#g,t.#_=this.#_,t.#k=this.#k,t.#m=this.#m,t.#d=this.#d,t.#v=this.#v,t.#A=this.#A,t.#w=this.#w,t}reset(e=null){this.#y="object"==typeof e?e:null,this.#g=o,this.#_=n,this.#k=1,this.#m=0,this.#d=0,this.#v=0,this.#w=null,this.#A=0,this.#b.#u==this&&(this.#b.#u=null)}#b;#y=null;#x=!0;get font(){return this.#y}set font(e){"object"==typeof e&&(this.#y=e),this.#b.#u==this&&(this.#b.#u=null)}#g=o;get shader(){return this.#g}set shader(e){"function"==typeof e&&(this.#g=e),this.#b.#u==this&&(this.#b.#u=null)}#_=n;get geometry(){return this.#_}set geometry(e){this.#_=e,this.#b.#u==this&&(this.#b.#u=null)}#k=1;get scale(){return this.#k}set scale(e){this.#k=+e,this.#b.#u==this&&(this.#b.#u=null)}scaleBy(e=1,t=!0,s=!0){if(1==e)return;const n=this.#b,o=n.length;let r=0,i=0;for(;r<o;){const o=n[r++];"number"==typeof o?(4==o||5==o&&s?(i||(i=1),n[r]*=e):1==o&&t&&(n[r]*=e),r++):"string"!=typeof o&&"function"!=typeof o||i||(i=2)}1!=i&&n.unshift(4,e),n.#n*=e,s&&(n.#o*=e),n.#h=NaN,n.#u=null}#q=0;get yOffset(){return this.#q}set yOffset(e){this.#q=+e,this.#b.#u==this&&(this.#b.#u=null)}offsetBy(e=0,t=!1){if(!e)return;const s=this.#b,n=s.length;let o=0,r=0,i=1,a=!1,c=0;for(;o<n;){const n=s[o++];if("number"==typeof n)5==n?(r||(r=1),c=s[o],s[o]=c+e*i,a=!1):t&&4==n&&(i=1/s[o],a=!0),o++;else if("string"==typeof n||"function"==typeof n){if(a){s.push(null,null);for(let e=s.length-3;e>=o;e--)s[e+2]=s[e];s[o++]=5,s[o++]=c+e*i}r||(r=2)}}1!=r&&s.unshift(5,e),s.#o+=e,s.#u=null}#m=1;get stretch(){return this.#m}set stretch(e){this.#m=+e,this.#b.#u==this&&(this.#b.#u=null)}stretchBy(e=1,t=!0,s=!1){if(1==e)return;const n=this.#b,o=n.length;let r=0,i=0;for(;r<o;){const o=n[r++];"number"==typeof o?(6==o||7==o&&s?(i||(i=1),n[r]*=e):1==o&&t&&(n[r]*=e),r++):"string"!=typeof o&&"function"!=typeof o||i||(i=2)}1!=i&&(s?n.unshift(7,e,6,e):n.unshift(6,e)),n.#r*=e,s&&(n.#i*=e),n.#h=NaN,n.#u=null}get letterWidth(){return this.#k*this.stretch}set letterWidth(e){this.stretch=e/this.#k}#d=0;get skew(){return this.#d}set skew(e){this.#d=+e,this.#b.#u==this&&(this.#b.#u=null)}skewBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,o=0;for(;n<s;){const s=t[n++];"number"==typeof s?(7==s&&(o||(o=1),t[n]+=e),n++):"string"!=typeof s&&"function"!=typeof s||o||(o=2)}1!=o&&t.unshift(7,e),t.#i+=e,t.#u=null}#v=0;get letterSpacing(){return this.#v}set letterSpacing(e){this.#v=+e,this.#b.#u==this&&(this.#b.#u=null)}spaceBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,o=0;for(;n<s;){const s=t[n++];"number"==typeof s?(8==s&&(o||(o=1),t[n]+=e),n++):"string"!=typeof s&&"function"!=typeof s||o||(o=2)}1!=o&&t.unshift(8,e),t.#a+=e,t.#h=NaN,t.#u=null}#A=0;get curve(){return this.#A}set curve(e){this.#A=+e,this.#b.#u==this&&(this.#b.#u=null)}curveBy(e=0){if(!e)return;const t=this.#b,s=t.length;let n=0,o=0;for(;n<s;){const s=t[n++];"number"==typeof s?(9==s?(o||(o=1),t[n]+=e):1!=s||o||(o=2),n++):"string"!=typeof s&&"function"!=typeof s||o||(o=2)}1!=o&&t.unshift(9,e),t.#c+=e,t.#h=NaN,t.#u=null}#w=f;addTextPass(e,t,s=0,n=0,o=0,r=-.5){const i={off:o,spr:.5/r,0:null,1:c};if(t)for(let e=0;e<t.length;e++)i[e+2]=t[e];const a=this.#w,l=this.#w=[];let f=0;for(;f<a.length;f+=4){if(!(a[f]<e)){a[f]==e&&(f+=4);break}l.push(a[f],a[f+1],a[f+2],a[f+3])}for(l.push(e,+s,+n,i);f<a.length;)l.push(a[f],a[f+1],a[f+2],a[f+3]),f+=4;this.#b.#u=null}addLinePass(e,n,o=0,r=1){const i={0:t,1:s};for(let e=0;e<n.length;e++)i[e+2]=n[e];const a=this.#w,c=this.#w=[];let l=0;for(;l<a.length;l+=4){if(!(a[l]<e)){a[l]==e&&(l+=4);break}c.push(a[l],a[l+1],a[l+2],a[l+3])}for(c.push(e,i,+o,+r);l<a.length;)c.push(a[l],a[l+1],a[l+2],a[l+3]),l+=4;this.#b.#u=null}delPass(e){const t=this.#w,s=this.#w=[];let n=0;for(;n<t.length;n+=4){if(!(t[n]<e)){t[n]==e&&(n+=4);break}s.push(t[n],t[n+1],t[n+2],t[n+3])}for(;n<t.length;)s.push(t[n],t[n+1],t[n+2],t[n+3]),n+=4;this.#b.#u=null}insertTextPass(e,t,s=0,n=0,o=0,r=-.5){const i={off:o,spr:.5/r,0:null,1:c};if(t)for(let e=0;e<t.length;e++)i[e+2]=t[e];const a=this.#b,f=a.length;let h=0,u=0;for(;h<f;){let t=a[h++];if("number"==typeof t&&t>0)h++;else if("string"==typeof t||"function"==typeof t)u||(u=2);else if(Array.isArray(t)){u||(u=1);const o=a[h-1]=[];let r=0;for(;r<t.length;r+=4){if(!(t[r]<e)){t[r]==e&&(r+=4);break}o.push(t[r],t[r+1],t[r+2],t[r+3])}for(o.push(e,+s,+n,i);r<t.length;)o.push(t[r],t[r+1],t[r+2],t[r+3]),r+=4}}1!=u&&a.unshift(e>0?[0,0,0,l,e,s,n,i]:e<0?[e,s,n,i,0,0,0,l]:[e,s,n,i]),a.#u=null}insertLinePass(e,n,o=0,r=1){const i={0:t,1:s};for(let e=0;e<n.length;e++)i[e+2]=n[e];const a=this.#b,c=a.length;let f=0,h=0;for(;f<c;){let t=a[f++];if("number"==typeof t&&t>0)f++;else if("string"==typeof t||"function"==typeof t)h||(h=2);else if(Array.isArray(t)){h||(h=1);const s=a[f-1]=[];let n=0;for(;n<t.length;n+=4){if(!(t[n]<e)){t[n]==e&&(n+=4);break}s.push(t[n],t[n+1],t[n+2],t[n+3])}for(s.push(e,i,o,r);n<t.length;)s.push(t[n],t[n+1],t[n+2],t[n+3]),n+=4}}1!=h&&a.unshift(e>0?[0,0,0,l,e,i,o,r]:e<0?[e,i,o,r,0,0,0,l]:[e,i,o,r]),a.#u=null}removePass(e){const t=this.#b,s=t.length;let n=0;e:for(;n<s;){let s=t[n++];if("number"==typeof s&&s>0)n++;else if(Array.isArray(s)){let t=0;for(;t<s.length;t+=4){if(s[t]>e)continue e;if(s[t]==e){for(t+=4;t<s.length;)s[t-4]=s[t],s[t-3]=s[t+1],s[t-2]=s[t+2],s[t-1]=s[t+3],t+=4;s.length-=4;break}}}}}get index(){return this.#x}set index(e){this.#x=!!e,this.#b.#u==this&&(this.#b.#u=null)}advance(e=0){const t=this.#b;t.#u!=this&&this.#N(t),t.push(1,+e),t.#h=NaN}#N(e){this.#y!=e.#e&&e.push(e.#e=this.#y),this.#g!=e.#t&&e.push(2,e.#t=this.#g),this.#_!=e.#s&&e.push(3,e.#s=this.#_),this.#k!=e.#n&&e.push(4,e.#n=this.#k),this.#q!=e.#o&&e.push(5,e.#o=this.#q),this.#m!=e.#r&&e.push(6,e.#r=this.#m),this.#d!=e.#i&&e.push(7,e.#i=this.#d),this.#v!=e.#a&&e.push(8,e.#a=this.#v),this.#A!=e.#c&&e.push(9,e.#c=this.#A),this.#w!=e.#l&&(e.push(this.#w),e.#l=this.#w),this.#x!=e.#p&&(e.push(this.#x),e.#p=this.#x),e.#u=this}copy(){const e=this.#b,t=e.slice(),s=t.#u=this.sub();return s.#b=t,t.#e=e.#e,t.#t=e.#t,t.#n=e.#n,t.#o=e.#o,t.#r=e.#r,t.#i=e.#i,t.#a=e.#a,t.#c=e.#c,t.#l=e.#l,t.#p=e.#p,t.#f=e.#f,t.#h=e.#h,s}slice(t=0,s=1/0){const n=this.#b,o=new u;t<0&&(t+=n.#f)<0&&(t=0),s<0&&(s+=n.#f)<0&&(s=0);const r=new e(o);let i=0;if(s<=0){for(;i<n.length;){const e=n[i++];if("number"==typeof e){const t=n[i++];switch(e){case 1:i-=2;break;case 2:r.#g=t;break;case 3:r.#_=t;break;case 4:r.#k=t;break;case 5:r.#q=t;break;case 6:r.#m=t;break;case 7:r.#d=t;break;case 8:r.#v=t;break;case 9:r.#A=t}}else{if("string"==typeof e||"function"==typeof e)break;Array.isArray(e)?"boolean"==typeof e?r.#x=e:r.#w=e:r.#y=e}}return r.#N(o),r}s=s>=t?s-t:0;let a="";for(;t>0&&i<n.length;){const e=n[i++];if("number"==typeof e){const t=n[i++];switch(e){case 2:r.#g=t;break;case 3:r.#_=t;break;case 4:r.#k=t;break;case 5:r.#q=t;break;case 6:r.#m=t;break;case 7:r.#d=t;break;case 8:r.#v=t;break;case 9:r.#A=t}}else if("string"==typeof e){if(!o.#p)continue;if((t-=e.length)<0){a=e.slice(t,(s+=t)+e.length);break}}else Array.isArray(e)?r.#w=e:"object"==typeof e?r.#y=e:"boolean"==typeof e&&(r.#x=e)}for(r.#N(o),a&&(o.push(a),o.#f+=a.length);s>0&&i<n.length;){const e=n[i++];if(o.push(e),"number"==typeof e){const t=n[i++];switch(o.push(t),e){case 2:r.#g=t;break;case 3:r.#_=t;break;case 4:r.#k=t;break;case 5:r.#q=t;break;case 6:r.#m=t;break;case 7:r.#d=t;break;case 8:r.#v=t;break;case 9:r.#A=t}}else if("string"==typeof e){if(!o.#p)continue;s-=e.length,o.#f+=e.length,s<0?(o[o.length-1]=e.slice(0,s),o.#f+=e.length+s):o.#f+=e.length}else Array.isArray(e)?r.#w=e:"object"==typeof e?r.#y=e:"boolean"==typeof e&&(r.#x=e)}return r}trim(e=1/0){const t=this.#b;if(e<0&&(e+=t.#f)<0&&(e=0),e>t.#f)return;let s=0;if(t.#e=null,t.#t=o,t.#n=1,t.#r=1,t.#o=0,t.#i=0,t.#a=0,t.#p=!0,t.#c=0,t.#l=f,t.#f=e<0?0:e)for(;e>0&&s<t.length;){const n=t[s++];if("number"==typeof n){const e=t[s++];switch(n){case 2:t.#t=e;break;case 3:t.#s=e;break;case 4:t.#n=e;break;case 5:t.#o=e;break;case 6:t.#r=e;break;case 7:t.#i=e;break;case 8:t.#a=e;break;case 9:t.#c=e}}else if("string"==typeof n){if(!t.#p)continue;if((e-=n.length)<0){t[s-1]=n.slice(0,e);break}}else Array.isArray(n)?t.#l=n:"object"==typeof n?t.#e=n:"boolean"==typeof n&&(t.#p=n)}else for(;s<t.length;){const e=t[s++];if("number"==typeof e){const n=t[s++];switch(e){case 1:s-=2;break;case 2:t.#t=n;break;case 3:t.#s=n;break;case 4:t.#n=n;break;case 5:t.#o=n;break;case 6:t.#r=n;break;case 7:t.#i=n;break;case 8:t.#a=n;break;case 9:t.#c=n}}else{if("string"==typeof e||"function"==typeof e){s--;break}Array.isArray(e)?t.#l=e:"boolean"==typeof e?t.#p=e:t.#e=e}}this.#y=t.#e,this.#g=t.#t,this.#_=t.#s,this.#k=t.#n,this.#q=t.#o,this.#m=t.#r,this.#d=t.#i,this.#v=t.#a,this.#A=t.#c,this.#w=t.#l,t.length=s,t.#h=NaN}concat(e){const t=this.#b,s=e.#b;t.#f+=s.#f;let r=0;this.#y=null,this.#g=o,this.#_=n,this.#k=1,this.#q=0,this.#m=1,this.#d=0,this.#v=0,this.#A=0,this.#w=f;const i=s.length;e:for(;r<i;){const e=s[r++];if("number"==typeof e){const t=s[r++];switch(e){case 1:r-=2;break e;case 2:this.#g=t;break;case 3:this.#_=t;break;case 4:this.#k=t;break;case 5:this.#q=t;break;case 6:this.#m=t;break;case 7:this.#d=t;break;case 8:this.#v=t;break;case 9:this.#A=t}}else{if("string"==typeof e||"function"==typeof e){r--;break}Array.isArray(e)?this.#w=e:"boolean"==typeof e?this.#x=e:this.#y=e}}for(this.#N(t);r<i;){const e=s[r++];if(t.push(e),"number"==typeof e){const n=s[r++];switch(t.push(n),e){case 2:this.#g=n;break;case 3:this.#_=n;break;case 4:this.#k=n;break;case 5:this.#q=n;break;case 6:this.#m=n;break;case 7:this.#d=n;break;case 8:this.#v=n;break;case 9:this.#A=n}}else"string"==typeof e?t.#p&&(t.#f+=e.length):Array.isArray(e)?this.#w=e:"boolean"==typeof e?this.#x=e:"object"==typeof e&&(this.#y=e)}t.#h=NaN}get length(){return this.#b.#f}set length(e){this.trim(e)}get width(){const e=this.#b;let t=e.#h;if(t==t)return t;t=0;let s=null,n=0,o=1,r=1,i=0,a=0,c=0,l=1,f=-1,h=1;for(;n<e.length;){let u=e[n++];if("number"==typeof u){const s=e[n++];switch(u){case 1:t+=l*s,f=-1;break;case 4:l=(o=s)*r,f=-1;break;case 6:l=(r=s)*o,f=-1;break;case 5:case 7:f=-1;break;case 8:i=s;break;case 9:c=1/s,a=s}}else if("string"==typeof u){if(s)for(const e of u){const n=e.codePointAt(),o=s.get(~n)??s._default;if(!o)continue;const r=(s.get(n+1114112*f)??0)*min(l,h);f=n,h=l;const u=(o._xadv+i)*l+r;t+=a&&asin(u*a)*c||u,o._tex?.waiting&&o._tex.load()}}else if("object"==typeof u){if(!u){s=null;continue}if(Array.isArray(u))continue;s=u,u.then?.(()=>e.#h=NaN)}}return e.#h=t}add(e){const t=this.#b;t.#u!=this&&this.#N(t),t.#p&&(t.#f+=(e+="").length),t.push(e),t.#h=NaN}addCb(e,t=NaN){if("function"!=typeof e)return;const s=this.#b;s.#u!=this&&this.#N(s),t==t?s.push(e,1,t):s.push(e)}indexAt(e=0,t=.5){t--;const s=this.#b;let n=null,o=0,r=1,i=1,a=0,c=!0,l=0,f=0,h=1,u=-1,p=1,b=0,y=0;for(;o<s.length;){let g=s[o++];if("number"==typeof g){const t=s[o++];switch(g){case 1:e-=h*t,u=-1;break;case 4:h=(r=t)*i,u=-1;break;case 6:h=(i=t)*r,u=-1;break;case 5:case 7:u=-1;break;case 8:a=t;break;case 9:f=1/t,l=t}}else if("string"==typeof g)if(n)for(const s of g){const o=s.codePointAt(),r=n.get(~o)??n._default;if(!r){c&&(y=b+=s.length);continue}const i=(n.get(o+1114112*u)??0)*min(h,p);u=o,p=h;const g=(r._xadv+a)*h+i,_=l&&asin(g*l)*f||g;if(e-=_,c){if(e<=_*t)return y;y=b+=s.length}}else c&&(b+=g.length);else if("object"==typeof g){if(!g){n=null;continue}if(Array.isArray(g))continue;n=g}else"boolean"==typeof g&&(c=g)}return y}draw(e){const t=this.#b;let s=null,r=0,i=1,a=1,l=1,h=0,u=0,p=0,b=0,y=0;e.shader=o,e.geometry=n;let g=f,_=3,k=null,m=0,d=-1,v=1,A=e.projection,w=-2*e.pixelRatio(),x=1,q=1,N=1,R=0;e:for(;r<t.length;){let n=t[r++];if("number"==typeof n){const s=t[r++];switch(n){case 1:if(y){u&&e.skew(-u,0);const t=.5/y,n=s*y*2;e.rotate(R),e.translate(sin(n)*t,(1-cos(n))*t),e.rotate(-n),R=0,u&&e.skew(u,0)}else e.translate(s,0);d=-1;continue e;case 4:const t=s*a;a=1/s,e.scale(t),p*=i*=a,b*=i,v*=t,y*=t,i=s,k&&(x=w*i*k.rangeFactor),d=-1;continue e;case 5:p=s*a,b=p*u,d=-1;continue e;case 2:e.shader=s;break;case 3:e.geometry=s;break;case 6:l=s,d=-1;continue e;case 7:e.skew(s-u,0),u=s,b=p*s,d=-1;continue e;case 8:h=.5*s;continue e;case 9:y=s*i;continue e;default:continue e}}else{if("string"==typeof n){if(s)for(const t of n){const n=t.codePointAt(),o=s.get(~n)??s._default;if(!o)continue;A&&(w=-2*e.pixelRatio(),x=w*i*k.rangeFactor);const r=(s.get(n+1114112*d)??0)*min(v,l);d=n,v=l;const a=(o._xadv+h+h)*l+r,f=r-b;y&&(u&&e.skew(-u,0),e.rotate(R+(R=-asin(a*y)||0)),u&&e.skew(u,0));for(let t=0;t<_;t+=4){const s=g[t+1],n=g[t+2]+p,r=g[t+3];if("object"==typeof s){const t=y*a*(n+m);e.drawRectv(f+t,n+m,a-t-t,r,s)}else if(o._tex){r[0]=o._tex,c.x=r.off*N;const{spr:t}=r;c.y=(t<0?x:q)*t,e.drawRectv((o.x+h)*l+s+f,o.y+n,o.w*l,o.h,r)}}e.translate(a,0)}continue}if("function"==typeof n){const t=e.sub();R&&(t.skew(-u,0),t.rotate(R),t.skew(u,0)),n(t,k)}else if("object"==typeof n){if(!n){s=null;continue}if(Array.isArray(n)){if(_=(g=n).length,A=!1,e.projection)for(let e=0;e<_;e+=4)if("object"==typeof g[e+3]&&g[e+3].spr<0){A=!0;break}continue}k=n,m=k.ascend-1,s=n,x=w*i*(q=k.rangeFactor),N=1/q}}}u&&e.skew(-u,0),R&&e.rotate(R),1!=i&&e.scale(a)}break(t=1/0,s=i,n={scale:1,letterSpacing:0,curve:0}){const o=this.#b;let r=!0,c="",l=0;for(;l<o.length;){const e=o[l++];"number"!=typeof e?"boolean"==typeof e?r=e:"string"==typeof e&&r&&(c+=e):l++}const f=[];let p="number"==typeof t?t:"function"==typeof t?t(f.length,n):t[min(f.length,t.length-1)],b=new u,y=b.#u=new e(b),g=0,_="";l=0;let k=null,m=1,d=1,v=-1,A=0,w=!1;for(;l<c.length;){let r=0,i=a,x=b.length,q=A,N=y.#g,R=y.#_,P=y.#k,S=y.#q,F=y.#m,E=y.#d,L=y.#v,O=y.#y,j=y.#A,B=y.#w,W=b.#p,T=b.#f;e:do{if(s)for(i of s)if(i.lastIndex=l,i.test(c)){if(r){i=a;break e}r=i.lastIndex-l,l=i.lastIndex,s=i.next??s;break e}++r}while(++l<c.length);const I=i.type;16&I&&(f.push(y),b.#h=w?NaN:A,w=!1,y=y.sub(),y.#b=b=new u,p="number"==typeof t?t:"function"==typeof t?t(f.length,n):t[min(f.length,t.length-1)],x=q=A=T=0,W||b.push(b.#p=!1),y.#N(b));const C=!!(32&I);if(_){let e=_;r<_.length?(e=_.slice(0,r),_=_.slice(r),r=0):(r-=_.length,_=""),C&&b.#e&&b.push(null),e&&b.push(e),b.#p&&(b.#f+=e.length),C&&b.#e&&b.push(b.#e)}for(;r>0;){const e=o[g++];if("number"==typeof e){const t=o[g++];switch(b.push(e,t),e){case 2:y.#g=b.#t=t;break;case 3:y.#_=b.#s=t;break;case 4:y.#k=b.#n=t;break;case 5:y.#q=b.#o=t;break;case 6:y.#m=b.#r=t;break;case 7:y.#d=b.#i=t;break;case 8:y.#v=b.#a=t;break;case 9:y.#A=b.#c=t}}else if("string"==typeof e){if(!b.#e){b.push(e),b.#p&&(b.#f+=e.length);continue}r-=e.length;let t=e;r<0?(t=e.slice(0,r),_=e.slice(r)):_="",C&&b.push(null),b.push(t),b.#p&&(b.#f+=t.length),C&&b.push(b.#e)}else"boolean"==typeof e?b.push(b.#p=e):(b.push(e),Array.isArray(e)?b.#l=y.#w=e:"function"!=typeof e&&(b.#e=y.#y=e))}for(;;){let s=x,o=0,r=0,a=N,c=R,l=P,g=S,_=F,C=E,H=L,V=O,G=B,U=W,K=T,M=j,Y=1/M,D=!1,Q=i.sepL==V&&i.sepA==M&&i.sepS==H?i.sepW:h(i,V,M,H);const $=I?!!(36>>I&1):2*q<p,{scale:z=1,letterSpacing:J=0,curve:X=0}=n;w||=1!=z||0!=J||0!=X;let Z=M+X,ee=H+J;for(X&&(Y=1/Z);s<b.length;){const e=b[s++];if("number"==typeof e){const t=b[s++];switch(e){case 1:if(A+=t,v=-1,A>p-(Q-(k?.get(i.sep.codePointAt()+1114112*v)??0))*m||!$)break;x=s-2,r=0,D=!0,q=A,N=a,R=c,P=l,S=g,F=_,E=C,L=H,O=V,j=M,B=G,W=U,T=K;break;case 2:a=t;break;case 3:c=t;break;case 4:l=t,m=t*_*z;break;case 5:g=t;break;case 6:_=t,m=t*l*z;break;case 7:C=t;break;case 8:H=t,ee=t+J;break;case 9:Z=t+X,Y=1/Z,M=t}}else if("string"==typeof e)if(o=0,k)for(const t of e){const e=t.codePointAt(),n=k.get(~e)??k._default;if(o+=t.length,U&&(K+=t.length),!n)continue;const f=(k.get(e+1114112*v)??0)*min(m,d);d=m,v=e;const h=(n._xadv+ee)*m+f;A+=Z&&asin(h*Z)*Y||h,A<=p-(Q-(k.get(i.sep.codePointAt()+1114112*e)??0))*m&&$&&(D=!0,x=s-1,r=o,q=A,N=a,R=c,P=l,S=g,F=_,E=C,L=H,O=V,j=M,B=G,W=U,T=K)}else U&&(K+=e.length);else if(Array.isArray(e))G=e;else if("boolean"==typeof e)U=e;else{if("function"==typeof e)continue;(V=e)?(k=e,Q=i.sepL==e&&i.sepA==M&&i.sepS==H?i.sepW:h(i,e,M,H)):(k=null,Q=0)}}if(!q||A<=p||!x||3==I)break;if(s=x,o=r,a=N,c=R,l=P,g=S,_=F,C=E,H=L,V=O,G=B,U=W,M=j,K=T,6==I||7==I&&p-q>=A-p){const e=(p-q)/(A-q),t=b.length;for(b.splice(s,0,6,e*_),s+=2;s<t;){const t=b[s++];"number"==typeof t&&(6==t&&(b[s]*=e),s++)}b.push(6,_);break}A=q;const te=new u,se=new e(te),ne=b.length;se.#g=a,se.#_=c,se.#k=l,se.#q=g,se.#m=_,se.#d=C,se.#v=H,se.#w=G,se.#A=M,se.#x=U;let oe=s+=!!o,re=V;const ie=4!=I&&5!=I;if(o){se.#y=re,se.#N(te);const e=b[s-1];b[s-1]=e.slice(0,o),te.push(e.slice(o)),ie?re=null:te.push(se.#y=te.#e=null)}else{e:for(;oe<ne;){const e=b[oe++];if("number"==typeof e){const t=b[oe++];switch(e){case 1:if(ie){oe-=2;break e}break;case 2:se.#g=t;break;case 3:se.#_=t;break;case 4:se.#k=t;break;case 5:se.#q=t;break;case 6:se.#m=t;break;case 7:se.#d=t;break;case 8:se.#v=t;break;case 9:se.#A=t}}else{if("string"==typeof e||"function"==typeof e){oe--;break}"boolean"==typeof e?se.#x=e:Array.isArray(e)?se.#w=e:re=e}}se.#N(te)}if(ie)for(re&&te.push(se.#y=te.#e=re);oe<ne;)te.push(b[oe++]);else for(;oe<ne;){const e=b[oe++];"number"==typeof e?te.push(e,b[oe++]):("object"!=typeof e||Array.isArray(e))&&te.push(e)}te.#f=b.#f-K,b.#f=K,b.#h=w?NaN:A,w=!1,se.#g=te.#t=y.#g,se.#_=te.#s=y.#_,se.#k=te.#n=y.#k,se.#q=te.#o=y.#q,se.#m=te.#r=y.#m,se.#d=te.#i=y.#d,se.#v=te.#a=y.#v,se.#A=te.#c=y.#A,se.#x=te.#p=y.#x,se.#w=te.#l=y.#w,b.length=s,!ie&&re&&te.push(se.#y=te.#e=re),D&&(b.#p&&b.push(b.#p=!1),b.push(i.sep)),f.push(y),y=se,b=te,p="number"==typeof t?t:"function"==typeof t?t(f.length,n):t[min(f.length,t.length-1)],x=r=q=A=T=0}8&I&&(f.push(y),b.#h=w?NaN:A,w=!1,A=0,y=y.sub(),y.#b=b=new u,p="number"==typeof t?t:"function"==typeof t?t(f.length,n):t[min(f.length,t.length-1)],y.#N(b))}for(;g<o.length;){const e=o[g++];if(b.push(e),"number"==typeof e){const t=o[g++];switch(b.push(t),e){case 2:y.#g=b.#t=t;break;case 3:y.#_=b.#s=t;break;case 4:y.#k=b.#n=t;break;case 5:y.#q=b.#o=t;break;case 6:y.#m=b.#r=t;break;case 7:y.#d=b.#i=t;break;case 8:y.#v=b.#a=t;break;case 9:y.#A=b.#c=t}}else Array.isArray(e)?y.#w=b.#l=e:"object"==typeof e?y.#y=b.#e=e:"boolean"==typeof e&&(y.#x=b.#p=e)}return b.#h=w?NaN:A,f.push(y),f}toString(){let e="",t=!0,s=0;const n=this.#b,o=n.length;for(;s<o;){const o=n[s++];"number"!=typeof o?"boolean"==typeof o?t=o:"string"==typeof o&&t&&(e+=o):s++}return e}static ctor=(t=null)=>{const s=new u;if(!t)return s.#u=new e(s);const n=new e(s);return n.#y=t,n}}}e.RichText=u.public.ctor;const p=Texture(4,6,1,0,Formats.RGBA4).pasteData(Uint8Array.fromHex("ffff ffff ffff ffffffff 0000 0000 ffffffff 0000 0000 ffffffff 0000 0000 ffffffff 0000 0000 ffffffff ffff ffff ffff"));class b extends Map{rangeFactor=0;ascend=0;#R=[];_default={x:.05,y:-.0625,w:.5,h:.75,_xadv:.6,_tex:p};get then(){return this.#R?this.#P:void 0}#P(e,t){this.#R?.push(e,t)}done(){const e=this.#R;if(this.#R=null,e)for(let t=0;t<e.length;t+=2)e[t]?.(this)}error(e){const t=this.#R;if(this.#R=null,t)for(let s=1;s<t.length;s+=2)t[s]?.(e)}set(e=-1,t=0,s=null,n=0,o=0,r=0,i=0){if("string"==typeof e&&(e=e.codePointAt()),e<0){const e=this._default;s||t?(e.x=+n,e.y=+o,e.w=+r,e.h=+i,e._xadv=+t,e._tex=s):(e.x=e.y=e.w=e.h=e._xadv=0,e._tex=null)}else{if(!s&&!t)return super.delete(~e);super.set(~e,{x:+n,y:+o,w:+r,h:+i,_xadv:+t,_tex:s})}}getAdvance(e=-1){return"string"==typeof e&&(e=e.codePointAt()),(e<0?this._default:this.get(~e)??this._default)._xadv}setKerning(e,t,s=0){let n=0;if("string"==typeof e){const o=e.codePointAt();n=1114112*o,"number"==typeof t?(s=t,n+=e.codePointAt(1+(o>65535))):n+=t.codePointAt()}else n=1114112*e+t;s?super.set(n,s):super.delete(n)}getKerning(e,t){let s=0;if("string"==typeof e){const n=e.codePointAt();s=1114112*n,s+="string"==typeof t?t.codePointAt():void 0!==t?16777215&t:e.codePointAt(1+(n>65535))}else s=1114112*(16777215&e)+(16777215&t);return this.get(s)??0}chlumsky(t,s="atlas.png",n=e.ANISOTROPY|e.SMOOTH,o=1){return t.endsWith("/")&&(t+="index.json"),fetch(t).then(e=>(t=e.url,e.json())).then(r=>{const{atlas:{type:i,distanceRange:a,size:c,width:l,height:f},metrics:{ascender:h,descender:u},glyphs:p,kerning:b}=r;this.rangeFactor=a/c;const y=e.Texture.from(new URL(s,t).href,n,i.toLowerCase().endsWith("msdf")?e.Formats.RGB:e.Formats.RG,o);this.ascend=h/(h-u);for(const{unicode1:e,unicode2:t,advance:s}of b)super.set(t+1114112*e,s);for(const{unicode:e,advance:t,planeBounds:s,atlasBounds:n}of p)super.set(~e,s?{x:+s.left,y:+s.bottom,w:s.right-s.left,h:s.top-s.bottom,_xadv:t,_tex:y.sub(n.left/l,n.bottom/f,(n.right-n.left)/l,(n.top-n.bottom)/f)}:{x:0,y:0,w:0,h:0,_xadv:t,_tex:null});this.done()},this.error.bind(this)),this}bmfont(t,s=0,n=e.ANISOTROPY|e.SMOOTH,o=1){return fetch(t).then(e=>(t=e.url,e.json())).then(r=>{const{chars:i,distanceField:a,pages:c,common:{base:l,lineHeight:f,scaleW:h,scaleH:u},kernings:p}=r,b=1/r.info.size;this.rangeFactor=a.distanceRange/f;const y=this.ascend=l/f,g=c.map(s=>e.Texture.from(new URL(s,t).href,n,a.fieldType.toLowerCase().endsWith("msdf")?e.Formats.RGB:e.Formats.RG,o));for(const{first:e,second:t,amount:s}of p)super.set(t+1114112*e,s/b);for(const{id:e,x:t,y:n,width:o,height:r,xoffset:a,yoffset:c,xadvance:l,page:f}of i)super.set(e,{x:a*b,y:y-(c-s+r)*b,w:o*b,h:r*b,_xadv:l*b,_tex:o&&r?g[f].sub(t/h,1-(n+r)/u,o/h,r/u):null});this.done()},this.error.bind(this)),this}draw(e,t,s=[],n=0,o=-.5,r=0,i=-1){if(this.#R)return;r*=.5,n/=this.rangeFactor;const a=o<0&&e.projection;let l=o=1/o;a||(l*=(o<0?-e.pixelRatio():.5)*this.rangeFactor);for(const f of t){const t=f.codePointAt(),h=this.get(~t)??this._default;if(!h)continue;a&&(l=-e.pixelRatio()*this.rangeFactor*o);const u=this.get(t+1114112*i)??0;i=t;const p=h._xadv+r+r+u;h._tex&&(c.x=n,c.y=l,e.drawRect(h.x+r+u,h.y,h.w,h.h,h._tex,c,...s)),e.translate(p,0)}return i}measure(e,t=0,s=-1){if(this.#R)return;let n=0;for(const o of e){const e=o.codePointAt(),r=this.get(~e)??this._default;if(!r)continue;const i=this.get(e+1114112*s)??0;s=e,n+=r._xadv+t+i}return n}}e.Font=()=>new b,e.Font.bmfont=(e,t)=>(new b).bmfont(e,t),e.Font.chlumsky=(e,t)=>(new b).chlumsky(e,t)};