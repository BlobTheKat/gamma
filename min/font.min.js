Gamma.font=t=>{const e=t.vec4.one,s=t.vec2.zero,n=t.Shader.MSDF=t.Shader("void main(){vec3 c = arg0().rgb;float sd = max(min(c.r, c.g), min(max(c.r, c.g), c.b))-.5+arg1.x;color = arg2 * clamp(arg1.y*sd*2.+.5,0.,1.);}",[t.COLOR,t.VEC2,t.VEC4],[void 0,{x:0,y:1},e,0]);t.TEXT_AA=NaN;const o=t.BreakToken=(t,e=0,s="",n=void 0)=>{if(t instanceof RegExp){let e=t.flags,s=e.indexOf("g");s>-1&&(e=e.slice(0,s)+e.slice(s+1)),e.includes("y")||(e+="y"),t=new RegExp(t.source,e)}else{let e="[";for(const s of t+""){const t=s.codePointAt();e+=t>=92&&t<=94||45==t?"\\"+s:s}t=new RegExp(e+"]","y")}return t.type=e,t.sep=s,t.next=n,t.sepW=t.sepA=t.sepS=0,t.sepL=null,t};o.NORMAL=0,o.NEVER_BREAK=1,o.ALWAYS_BREAK=2,o.OVERFLOW=3,o.VANISH=4,o.TRUNCATE=5,o.SQUISH=6,o.SQUISH_BREAK=7,o.WRAP_AFTER=8,o.WRAP_BEFORE=16,o.INVISIBLE=32;const r=[o(/\r\n?|\n/y,o.WRAP_AFTER|o.INVISIBLE,""),o(/[$£"+]?[\w'-]+[,.!?:;"^%€*]?/iy,o.NORMAL,"-"),o(/[ \t]+/y,o.VANISH)],c=o(/[^]/y),a=new Map,h={x:0,y:0},l={off:0,spr:NaN,0:null,1:h},f=[0,0,0,l],u=-2,p=(t,e,s,n=0)=>{if(t.sepL=e,t.sepA=s,t.sepS=n,!e)return t.sepW=0;let i=0;const{map:o,kmap:r}=e,c=1/s;for(const e of t.sep){const t=e.codePointAt(),a=o.get(t);if(!a)continue;const h=a.xadv+n+(r.get(t+-1114112)??0);i+=s&&asin(h*s)*c||h}return e.then?.(()=>t.sepL==e&&(t.sepL=null,t.sepW=0)),t.sepW=i};class b extends Array{#t=null;#e=n;#s=1;#n=0;#i=1;#o=0;#r=0;#c=0;#a=f;#h=0;#l=NaN;#f=null;#u=-1;static public=class t{constructor(t){this.#p=t}sub(){const e=new t(this.#p);return e.#b=this.#b,e.#y=this.#y,e.#g=this.#g,e.#_=this.#_,e.#k=this.#k,e.#m=this.#m,e.#d=this.#d,e.#v=this.#v,e}reset(t=null){this.#b="object"==typeof t?t:null,this.#y=n,this.#g=1,this.#_=0,this.#k=0,this.#m=0,this.#v=null,this.#d=0,this.#p.#f==this&&(this.#p.#f=null)}#p;#b=null;get font(){return this.#b}set font(t){"object"==typeof t&&(this.#b=t),this.#p.#f==this&&(this.#p.#f=null)}#y=n;get shader(){return this.#y}set shader(t){"function"==typeof t&&(this.#y=t),this.#p.#f==this&&(this.#p.#f=null)}#g=1;get scale(){return this.#g}set scale(t){this.#g=+t,this.#p.#f==this&&(this.#p.#f=null)}scaleBy(t=1,e=!0,s=!0){if(1==t)return;const n=this.#p,i=n.length;let o=0,r=0;for(;o<i;){const i=n[o++];if("number"==typeof i){if(i<0)continue;o++,3==i||4==i&&s?(r||(r=1),n[o-1]*=t):1==i&&e&&(n[o-1]*=t)}else"string"!=typeof i&&"function"!=typeof i||r||(r=2)}1!=r&&n.unshift(3,t),n.#s*=t,s&&(n.#n*=t),n.#l=NaN,n.#f=null}#w=0;get yOffset(){return this.#w}set yOffset(t){this.#w=+t,this.#p.#f==this&&(this.#p.#f=null)}offsetBy(t=0){if(!t)return;const e=this.#p,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,4==s&&(i||(i=1),e[n-1]+=t)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(4,t),e.#n+=t,e.#f=null}#_=1;get stretch(){return this.#_}set stretch(t){this.#_=+t,this.#p.#f==this&&(this.#p.#f=null)}stretchBy(t=1,e=!0,s=!1){if(1==t)return;const n=this.#p,i=n.length;let o=0,r=0;for(;o<i;){const i=n[o++];if("number"==typeof i){if(i<0)continue;o++,5==i||6==i&&s?(r||(r=1),n[o-1]*=t):1==i&&e&&(n[o-1]*=t)}else"string"!=typeof i&&"function"!=typeof i||r||(r=2)}1!=r&&(s?n.unshift(6,t,5,t):n.unshift(5,t)),n.#i*=t,s&&(n.#o*=t),n.#l=NaN,n.#f=null}get letterWidth(){return this.#g*this.stretch}set letterWidth(t){this.stretch=t/this.#g}#k=0;get skew(){return this.#k}set skew(t){this.#k=+t,this.#p.#f==this&&(this.#p.#f=null)}skewBy(t=0){if(!t)return;const e=this.#p,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,6==s&&(i||(i=1),e[n-1]+=t)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(6,t),e.#o+=t,e.#f=null}#m=0;get letterSpacing(){return this.#m}set letterSpacing(t){this.#m=+t,this.#p.#f==this&&(this.#p.#f=null)}spaceBy(t=0){if(!t)return;const e=this.#p,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,7==s&&(i||(i=1),e[n-1]+=t)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(7,t),e.#r+=t,e.#l=NaN,e.#f=null}#d=0;get curve(){return this.#d}set curve(t){this.#d=+t,this.#p.#f==this&&(this.#p.#f=null)}curveBy(t=0){if(!t)return;const e=this.#p,s=e.length;let n=0,i=0;for(;n<s;){const s=e[n++];if("number"==typeof s){if(s<0)continue;n++,8==s?(i||(i=1),e[n-1]+=t):1!=s||i||(i=2)}else"string"!=typeof s&&"function"!=typeof s||i||(i=2)}1!=i&&e.unshift(8,t),e.#c+=t,e.#l=NaN,e.#f=null}#v=f;addTextPass(t,e,s,n,i=0,o=NaN){const r={off:i,spr:1/o,0:null,1:h};for(let t=0;t<n.length;t++)r[t+2]=n[t];const c=this.#v,a=this.#v=[];let l=0;for(;l<c.length;l+=4){if(!(c[l]<t)){c[l]==t&&(l+=4);break}a.push(c[l],c[l+1],c[l+2],c[l+3])}for(a.push(t,+e,+s,r);l<c.length;)a.push(c[l],c[l+1],c[l+2],c[l+3]),l+=4;this.#p.#f=null}addLinePass(t,n,i,o){const r={0:e,1:s};for(let t=0;t<o.length;t++)r[t+2]=o[t];const c=this.#v,a=this.#v=[];let h=0;for(;h<c.length;h+=4){if(!(c[h]<t)){c[h]==t&&(h+=4);break}a.push(c[h],c[h+1],c[h+2],c[h+3])}for(a.push(t,r,+n,+i);h<c.length;)a.push(c[h],c[h+1],c[h+2],c[h+3]),h+=4;this.#p.#f=null}setValues(t,e){const s=this.#v=this.#v.slice();for(let n=0;n<s.length;n+=4){if(s[n]==t){let t=s[n+=3];"number"==typeof t&&(t=s[n-=2]),s[n]=t=Object.assign({},t);for(let s=e.length-1;s>=0;s--){const n=e[s];void 0!==n&&(t[s+2]=n)}break}if(s[n]>t)break}this.#p.#f=null}delPass(t){const e=this.#v,s=this.#v=[];for(let n=0;n<e.length;n+=4){if(!(e[n]<t)){e[n]==t&&(n+=4);break}s.push(e[n],e[n+1],e[n+2],e[n+3])}for(;i<e.length;)s.push(e[i],e[i+1],e[i+2],e[i+3]),i+=4;this.#p.#f=null}insertTextPass(t,e,s,n,i=0,o=NaN){const r={off:i,spr:1/o,0:null,1:h};for(let t=0;t<n.length;t++)r[t+2]=n[t];const c=this.#p,a=c.length;let f=0,u=0;for(;f<a;){let n=c[f++];if("number"==typeof n&&n>0)f++;else if("string"==typeof n||"function"==typeof n)u||(u=2);else if(Array.isArray(n)){u||(u=1);const i=c[f-1]=[];let o=0;for(;o<n.length;o+=4){if(!(n[o]<t)){n[o]==t&&(o+=4);break}i.push(n[o],n[o+1],n[o+2],n[o+3])}for(i.push(t,+e,+s,r);o<n.length;)i.push(n[o],n[o+1],n[o+2],n[o+3]),o+=4}}1!=u&&c.unshift(t>0?[0,0,0,l,t,e,s,r]:t<0?[t,e,s,r,0,0,0,l]:[t,e,s,r]),c.#f=null}insertLinePass(t,n,i,o){const r={0:e,1:s};for(let t=0;t<o.length;t++)r[t+2]=o[t];const c=this.#p,a=c.length;let h=0,f=0;for(;h<a;){let e=c[h++];if("number"==typeof e&&e>0)h++;else if("string"==typeof e||"function"==typeof e)f||(f=2);else if(Array.isArray(e)){f||(f=1);const s=c[h-1]=[];let o=0;for(;o<e.length;o+=4){if(!(e[o]<t)){e[o]==t&&(o+=4);break}s.push(e[o],e[o+1],e[o+2],e[o+3])}for(s.push(t,r,n,i);o<e.length;)s.push(e[o],e[o+1],e[o+2],e[o+3]),o+=4}}1!=f&&c.unshift(t>0?[0,0,0,l,t,r,n,i]:t<0?[t,r,n,i,0,0,0,l]:[t,r,n,i]),c.#f=null}adjustValues(t,e){const s=this.#p,n=s.length;let i=0,o=0;for(;i<n;){const n=s[i++];if("number"==typeof n&&n>0)i++;else if("string"==typeof n||"function"==typeof n)o||(o=2);else if(Array.isArray(n)){const o=s[i-1]=n.slice();n==s.#a&&(s.#a=o);let r=0;for(;r<o.length;r+=4)if(o[r]==t){let t=o[r+=3];"number"==typeof t&&(t=o[r-=2]),o[r]=t=Object.assign({},t);for(let s=e.length-1;s>=0;s--){const n=e[s];void 0!==n&&(t[s+2]=n)}break}}}s.#f=null}removePass(t){const e=this.#p,s=e.length;let n=0;t:for(;n<s;){let s=e[n++];if("number"==typeof s&&s>0)n++;else if(Array.isArray(s)){let e=0;for(;e<s.length;e+=4){if(s[e]>t)continue t;if(s[e]==t){for(e+=4;e<s.length;)s[e-4]=s[e],s[e-3]=s[e+1],s[e-2]=s[e+2],s[e-1]=s[e+3],e+=4;s.length-=4;break}}}}}drawOnly(){this.#p.push(this.#p.#u=-3)}indexOnly(){this.#p.push(this.#p.#u=u)}drawAndIndex(){this.#p.push(this.#p.#u=-1)}advance(t=0){const e=this.#p;e.l!=this&&this.#A(e),e.push(1,+t),e.w=NaN}#A(t){this.#b!=t.#t&&t.push(t.#t=this.#b),this.#y!=t.#e&&t.push(2,t.#e=this.#y),this.#g!=t.#s&&t.push(3,t.#s=this.#g),this.#w!=t.#n&&t.push(4,t.#n=this.#w),this.#_!=t.#i&&t.push(5,t.#i=this.#_),this.#k!=t.#o&&t.push(6,t.#o=this.#k),this.#m!=t.#r&&t.push(7,t.#r=this.#m),this.#d!=t.#c&&t.push(8,t.#c=this.#d),this.#v!=t.#a&&(t.push(this.#v),t.#a=this.#v),t.#f=this}copy(){const t=this.#p,e=t.slice(),s=e.#f=this.sub();return s.#p=e,e.#t=t.#t,e.#e=t.#e,e.#s=t.#s,e.#n=t.#n,e.#i=t.#i,e.#o=t.#o,e.#r=t.#r,e.#c=t.#c,e.#a=t.#a,e.#u=t.#u,e.#h=t.#h,e.#l=t.#l,s}slice(e=0,s=1/0){const n=this.#p,i=new b;e<0&&(e+=n.#h)<0&&(e=0),s<0&&(s+=n.#h)<0&&(s=0);const o=new t(i);let r=0;if(s<=0){for(;r<n.length;){const t=n[r++];if("number"==typeof t){if(t<0){i.#u=t;continue}const e=n[r++];switch(t){case 1:r-=2;break;case 2:o.#y=e;break;case 3:o.#g=e;break;case 4:o.#w=e;break;case 5:o.#_=e;break;case 6:o.#k=e;break;case 7:o.#m=e;break;case 8:o.#d=e}}else{if("string"==typeof t||"function"==typeof t)break;Array.isArray(t)?o.#v=t:o.#b=t}}return-1!=i.#u&&i.push(i.#u),o.#A(i),o}s=s>=e?s-e:0;let c="";for(;e>0&&r<n.length;){const t=n[r++];if("number"==typeof t){if(t<0){i.#u=t;continue}const e=n[r++];switch(t){case 2:o.#y=e;break;case 3:o.#g=e;break;case 4:o.#w=e;break;case 5:o.#_=e;break;case 6:o.#k=e;break;case 7:o.#m=e;break;case 8:o.#d=e}}else if("string"==typeof t){if(!(2&i.#u))continue;if((e-=t.length)<0){c=t.slice(e,(s+=e)+t.length);break}}else Array.isArray(t)?o.#v=t:"object"==typeof t&&(o.#b=t)}for(o.#A(i),-1!=i.#u&&i.push(i.#u),c&&(i.push(c),i.#h+=c.length);s>0&&r<n.length;){const t=n[r++];if(i.push(t),"number"==typeof t){if(t<0){i.#u=t;continue}const e=n[r++];switch(i.push(e),t){case 2:o.#y=e;break;case 3:o.#g=e;break;case 4:o.#w=e;break;case 5:o.#_=e;break;case 6:o.#k=e;break;case 7:o.#m=e;break;case 8:o.#d=e}}else if("string"==typeof t){if(!(2&i.#u))continue;s-=t.length,i.#h+=t.length,s<0?(i[i.length-1]=t.slice(0,s),i.#h+=t.length+s):i.#h+=t.length}else Array.isArray(t)?o.#v=t:"object"==typeof t&&(o.#b=t)}return o}trim(t=1/0){const e=this.#p;if(t<0&&(t+=e.#h)<0&&(t=0),t>e.#h)return;let s=0;if(e.#t=null,e.#e=n,e.#s=1,e.#i=1,e.#n=0,e.#o=0,e.#r=0,e.#u=-1,e.#c=0,e.#a=f,e.#h=t<0?0:t)for(;t>0&&s<e.length;){const n=e[s++];if("number"==typeof n){if(n<0){e.#u=n;continue}const t=e[s++];switch(n){case 2:e.#e=t;break;case 3:e.#s=t;break;case 4:e.#n=t;break;case 5:e.#i=t;break;case 6:e.#o=t;break;case 7:e.#r=t;break;case 8:e.#c=t}}else if("string"==typeof n){if(!(2&e.#u))continue;if((t-=n.length)<0){e[s-1]=n.slice(0,t);break}}else Array.isArray(n)?e.#a=n:"object"==typeof n&&(e.#t=n)}else for(;s<e.length;){const t=e[s++];if("number"==typeof t){if(t<0){e.#u=t;continue}const n=e[s++];switch(t){case 1:s-=2;break;case 2:e.#e=n;break;case 3:e.#s=n;break;case 4:e.#n=n;break;case 5:e.#i=n;break;case 6:e.#o=n;break;case 7:e.#r=n;break;case 8:e.#c=n}}else{if("string"==typeof t||"function"==typeof t){s--;break}Array.isArray(t)?e.#a=t:e.#t=t}}this.#b=e.#t,this.#y=e.#e,this.#g=e.#s,this.#w=e.#n,this.#_=e.#i,this.#k=e.#o,this.#m=e.#r,this.#d=e.#c,this.#v=e.#a,e.length=s,e.#l=NaN}concat(t){const e=this.#p,s=t.#p;e.#h+=s.#h;let i=0;this.#b=null,this.#y=n,this.#g=1,this.#w=0,this.#_=1,this.#k=0,this.#m=0,this.#d=0,this.#v=f;const o=s.length;let r=-1;t:for(;i<o;){const t=s[i++];if("number"==typeof t){if(t<0){r=t;continue}const e=s[i++];switch(t){case 1:i-=2;break t;case 2:this.#y=e;break;case 3:this.#g=e;break;case 4:this.#w=e;break;case 5:this.#_=e;break;case 6:this.#k=e;break;case 7:this.#m=e;break;case 8:this.#d=e}}else{if("string"==typeof t||"function"==typeof t){i--;break}Array.isArray(t)?this.#v=t:this.#b=t}}for(this.#A(e),r!=e.#u&&e.push(e.#u=r);i<o;){const t=s[i++];if(e.push(t),"number"==typeof t){if(t<0){e.#u=t;continue}const n=s[i++];switch(e.push(n),t){case 2:this.#y=n;break;case 3:this.#g=n;break;case 4:this.#w=n;break;case 5:this.#_=n;break;case 6:this.#k=n;break;case 7:this.#m=n;break;case 8:this.#d=n}}else"string"==typeof t?2&e.#u&&(e.#h+=t.length):Array.isArray(t)?this.#v=t:"object"==typeof t&&(this.#b=t)}e.#l=NaN}get length(){return this.#p.#h}set length(t){this.trim(t)}get width(){const t=this.#p;let e=t.#l;if(e==e)return e;e=0;let s=a,n=a,i=0,o=1,r=1,c=0,h=-1,l=0,f=0,u=1,p=-1,b=1;for(;i<t.length;){let y=t[i++];if("number"==typeof y){if(y<0){h=y;continue}const s=t[i++];switch(y){case 1:e+=u*s,p=-1;break;case 3:u=(o=s)*r;break;case 5:u=(r=s)*o;break;case 7:c=s;break;case 8:f=1/s,l=s}}else if("string"==typeof y){if(1&h)for(const t of y){const i=t.codePointAt(),o=s.get(i);if(!o)continue;const r=(n.get(i+1114112*p)??0)*min(u,b);p=i,b=u;const a=(o.xadv+c)*u+r;e+=l&&asin(a*l)*f||a,o.tex?.waiting&&o.tex.load()}}else if("object"==typeof y){if(!y){s=n=a;continue}if(Array.isArray(y))continue;s=y.map,n=y.kmap,y.then?.(()=>t.#l=NaN)}}return t.#l=e}add(t){const e=this.#p;e.#f!=this&&this.#A(e),2&e.#u&&(e.#h+=(t+="").length),e.push(t),e.#l=NaN}addCb(t,e=NaN){if("function"!=typeof t)return;const s=this.#p;s.#f!=this&&this.#A(s),e==e?s.push(t,1,e):s.push(t)}indexAt(t=0){const e=this.#p;let s=a,n=a,i=0,o=1,r=1,c=0,h=-1,l=0,f=0,u=1,p=-1,b=1,y=0,g=0;for(;i<e.length;){let _=e[i++];if("number"==typeof _){if(_<0){h=_;continue}const s=e[i++];switch(_){case 1:t-=u*s,p=-1;break;case 3:u=(o=s)*r;break;case 5:u=(r=s)*o;break;case 7:c=s;break;case 8:f=1/s,l=s}}else if("string"==typeof _)if(1&h)for(const e of _){const i=e.codePointAt(),o=s.get(i);if(!o){2&h&&(g=y+=e.length);continue}const r=(n.get(i+1114112*p)??0)*min(u,b);p=i,b=u;const a=(o.xadv+c)*u+r,_=l&&asin(a*l)*f||a;if(t-=_,2&h){if(t<=-.5*_)return g;g=y+=e.length}}else 2&h&&(y+=_.length);else if("object"==typeof _){if(!_){s=n=a;continue}if(Array.isArray(_))continue;s=_.map,n=_.kmap}}return g}draw(t){const e=this.#p;let s=a,i=a,o=0,r=1,c=1,l=1,u=0,p=0,b=0,y=0,g=0,_=-1,k=t.shader=n,m=f,d=3,v=null,w=0;m[3][1]=1;let A=-1,q=1;const x=t.pixelRatio();let N=1,R=1,P=0;t:for(;o<e.length;){let n=e[o++];if("number"==typeof n){if(n<0){_=n;continue t}const s=e[o++];switch(n){case 1:if(g){p&&t.skew(-p,0);const e=.5/g,n=s*g*2;t.rotate(P),t.translate(sin(n)*e,(1-cos(n))*e),t.rotate(-n),P=0,p&&t.skew(p,0)}else t.translate(s,0);A=-1;continue t;case 3:const e=s*c;c=1/s,t.scale(e),b*=r*=c,y*=r,q*=e,g*=e,r=s,v&&(N=x*r*v.rangeFactor);for(let t=0;t<d;t+=4)("object"==typeof m[t+3]?m[t+3]:m[t+1])[1]=N;continue t;case 4:b=s*c,y=b*p;continue t;case 2:t.shader=k=n;break;case 5:l=s;continue t;case 6:t.skew(s-p,0),p=s,y=b*s;continue t;case 7:u=.5*s;continue t;case 8:g=s*r;continue t;default:continue t}}else{if("string"==typeof n){if(1&_)for(const e of n){const n=e.codePointAt(),o=s.get(n);if(!o)continue;const r=(i.get(n+1114112*A)??0)*min(q,l);A=n,q=l;const c=(o.xadv+u+u)*l+r,a=r-y;g&&(p&&t.skew(-p,0),t.rotate(P+(P=-asin(c*g)||0)),p&&t.skew(p,0));for(let e=0;e<d;e+=4){const s=m[e+1],n=m[e+2]+b,i=m[e+3];if("object"==typeof s){const e=g*c*(n+w);t.drawRectv(a+e,n+w,c-e-e,i,s)}else if(o.tex){i[0]=o.tex,console.assert(i[1]==h),h.x=i.off*R;const{spr:e}=i;h.y=e!=e?N:e*R,t.drawRectv((o.x+u)*l+s+a,o.y+n,o.w*l,o.h,i)}}t.translate(c,0)}continue}if("function"==typeof n){const e=t.sub();p&&e.skew(-p,0),P&&e.rotate(P),n(e,v)}else{if(!n){s=i=a;continue}if(Array.isArray(n)){d=(m=n).length;for(let t=0;t<d;t+=4)("object"==typeof m[t+3]?m[t+3]:m[t+1])[1]=N;continue}v=n,w=v.ascend-1,s=n.map,i=n.kmap,N=x*r*(R=v.rangeFactor);for(let t=0;t<d;t+=4)("object"==typeof m[t+3]?m[t+3]:m[t+1])[1]=N}}}p&&t.skew(-p,0),P&&t.rotate(P),1!=r&&t.scale(c)}break(e=1/0,s=r,n={scale:1,letterSpacing:0,curve:0}){const i=this.#p;let o=1,h="",l=0;for(;l<i.length;){const t=i[l++];"number"==typeof t&&(t<0?o=1&t:l++),"string"==typeof t&&o&&(h+=t)}const f=[];let y="number"==typeof e?e:"function"==typeof e?e(f.length,n):e[min(f.length,e.length-1)],g=new b,_=g.l=new t(g),k=0,m="";l=0;let d=a,v=a,w=1,A=1,q=-1,x=0,N=!1;for(;l<h.length;){let o,r=0,R=g.length,P=x,S=_.#y,F=_.#g,j=_.#w,E=_.#_,L=_.#k,O=_.#m,W=_.#b,B=_.#d,I=_.#v,T=g.#u,V=g.#h;t:{if(s)for(o of s){o.lastIndex=l;const t=o.exec(h);if(t){l+=r=t[0].length,s=o.next??s;break t}}l+=r=1,o=c}const H=o.type;16&H&&(f.push(_),g.#l=N?NaN:x,N=!1,_=_.sub(),_.#p=g=new b,y="number"==typeof e?e:"function"==typeof e?e(f.length,n):e[min(f.length,e.length-1)],R=P=x=V=0,-1!=T&&g.push(g.#u=T),_.#A(g));const M=32&H&&g.#u!=u;if(m){let t=m;r<m.length?(t=m.slice(0,r),m=m.slice(r),r=0):(r-=m.length,m=""),M&&g.push(u),t&&g.push(t),2&g.#u&&(g.#h+=t.length),M&&g.push(g.#u)}for(;r>0;){const t=i[k++];if("number"==typeof t){if(t<0){g.#u=t,g.push(t);continue}const e=i[k++];switch(g.push(t,e),t){case 2:_.#y=g.#e=e;break;case 3:_.#g=g.#s=e;break;case 4:_.#w=g.#n=e;break;case 5:_.#_=g.#i=e;break;case 6:_.#k=g.#o=e;break;case 7:_.#m=g.#r=e;break;case 8:_.#d=g.#c=e}}else if("string"==typeof t){if(!(1&g.#u)){g.push(t),g.#h+=t.length;continue}r-=t.length;let e=t;r<0?(e=t.slice(0,r),m=t.slice(r)):m="",M&&g.push(u),g.push(e),2&g.#u&&(g.#h+=e.length),M&&g.push(g.#u)}else g.push(t),Array.isArray(t)?g.#a=_.#v=t:"function"!=typeof t&&(g.#t=_.#b=t)}for(;;){let s=R,i=0,r=0,c=S,h=F,l=j,k=E,m=L,M=O,C=W,G=I,K=T,U=V,z=B,Q=1/z,D=!1,X=o.sepL==C&&o.sepA==z&&o.sepS==M?o.sepW:p(o,C,z,M);const Y=H?!!(36>>H&1):2*P<y,{scale:$=1,letterSpacing:J=0,curve:Z=0}=n;N||=1!=$||0!=J||0!=Z;let tt=z+Z,et=M+J;for(Z&&(Q=1/tt);s<g.length;){const t=g[s++];if("number"==typeof t){if(t<0){K=t;continue}const e=g[s++];switch(t){case 1:if(x+=e,q=-1,x>y-(X-(v.get(o.sep.codePointAt()+1114112*q)??0))*w||!Y)break;R=s-2,r=0,D=!0,P=x,S=c,F=h,j=l,E=k,L=m,O=M,W=C,B=z,I=G,T=K,V=U;break;case 2:c=e;break;case 3:h=e,w=e*k*$;break;case 4:l=e;break;case 5:k=e,w=e*h*$;break;case 6:m=e;break;case 7:M=e,et=e+J;break;case 8:tt=e+Z,Q=1/tt,z=e}}else if("string"==typeof t)if(i=0,1&K)for(const e of t){const t=e.codePointAt(),n=d.get(t);if(i+=e.length,2&K&&(U+=e.length),!n)continue;const a=(v.get(t+1114112*q)??0)*min(w,A);A=w,q=t;const f=(n.xadv+et)*w+a;x+=tt&&asin(f*tt)*Q||f,x<=y-(X-(v.get(o.sep.codePointAt()+1114112*t)??0))*w&&Y&&(D=!0,R=s-1,r=i,P=x,S=c,F=h,j=l,E=k,L=m,O=M,W=C,B=z,I=G,T=K,V=U)}else 2&K&&(U+=t.length);else if(Array.isArray(t))G=t;else{if("function"==typeof t)continue;(C=t)?(d=t.map,v=t.kmap,X=o.sepL==t&&o.sepA==z&&o.sepS==M?o.sepW:p(o,t,z,M)):(d=v=a,X=0)}}if(!P||x<=y||!R||3==H)break;if(s=R,i=r,c=S,h=F,l=j,k=E,m=L,M=O,C=W,G=I,K=T,z=B,U=V,6==H||7==H&&y-P>=x-y){const t=(y-P)/(x-P),e=g.length;for(g.splice(s,0,5,t*k),s+=2;s<e;){const e=g[s++];"number"!=typeof e||e<0||(5==e?g[s++]*=t:s++)}g.push(5,k);break}x=P;const st=new b,nt=new t(st),it=g.length;nt.#y=c,nt.#g=h,nt.#w=l,nt.#_=k,nt.#k=m,nt.#m=M,nt.#b=C,nt.#v=G,nt.#d=z,st.#u=K;let ot=s+=!!i;const rt=4!=H&&5!=H;if(i){nt.#A(st);const t=g[s-1];g[s-1]=t.slice(0,i),st.push(t.slice(i))}else{t:for(;ot<it;){const t=g[ot++];if("number"==typeof t){if(t<0){st.#u=t;continue}const e=g[ot++];switch(t){case 1:if(rt){ot-=2;break t}break;case 2:nt.#y=e;break;case 3:nt.#g=e;break;case 4:nt.#w=e;break;case 5:nt.#_=e;break;case 6:nt.#k=e;break;case 7:nt.#m=e;break;case 8:nt.#d=e}}else{if("string"==typeof t||"function"==typeof t){ot--;break}Array.isArray(t)?nt.#v=t:nt.#b=t}}nt.#A(st)}if(rt)for(-1!=st.#u&&st.push(st.#u);ot<it;)st.push(g[ot++]);else for(st.push(u);ot<it;){const t=g[ot++];"number"!=typeof t?st.push(t):t>0&&st.push(t,g[ot++])}st.#h=g.#h-U,g.#h=U,g.#l=N?NaN:x,N=!1,nt.#y=st.#e=_.#y,nt.#g=st.#s=_.#g,nt.#w=st.#n=_.#w,nt.#_=st.#i=_.#_,nt.#k=st.#o=_.#k,nt.#m=st.#r=_.#m,nt.#d=st.#c=_.#d,st.#u=g.#u,nt.#v=st.#a=_.#v,g.length=s,rt||st.#u==u||st.push(st.#u),D&&(-3!=g.#u&&g.push(g.#u=-3),g.push(o.sep)),f.push(_),_=nt,g=st,y="number"==typeof e?e:"function"==typeof e?e(f.length,n):e[min(f.length,e.length-1)],R=r=P=x=V=0}if(8&H){f.push(_),g.#l=N?NaN:x,N=!1;const t=g.#u;x=0,_=_.sub(),_.#p=g=new b,y="number"==typeof e?e:"function"==typeof e?e(f.length,n):e[min(f.length,e.length-1)],-1!=t&&g.push(g.#u=t),_.#A(g)}}for(;k<i.length;){const t=i[k++];if(g.push(t),"number"==typeof t){if(t<0){g.#u=t;continue}const e=i[k++];switch(g.push(e),t){case 2:_.#y=g.#e=e;break;case 3:_.#g=g.#s=e;break;case 4:_.#w=g.#n=e;break;case 5:_.#_=g.#i=e;break;case 6:_.#k=g.#o=e;break;case 7:_.#m=g.#r=e;break;case 8:_.#d=g.#c=e}}else Array.isArray(t)?g.#a=_.#v=t:"object"==typeof t&&(g.#t=_.#b=t)}return g.#l=N?NaN:x,f.push(_),f}toString(){let t="",e=!0,s=0;const n=this.#p,i=n.length;for(;s<i;){const i=n[s++];"number"==typeof i&&(i<0?e=!!(2&i):s++),"string"==typeof i&&e&&(t+=i)}return t}static ctor=(e=null)=>{const s=new b;if(!e)return s.#f=new t(s);const n=new t(s);return n.#b=e,n}}}t.RichText=b.public.ctor;class y{rangeFactor=0;#q=[];map=new Map;ascend=0;kmap=new Map;get then(){return this.#q?this.#x:void 0}#x(t,e){this.#q?.push(t,e)}done(){const t=this.#q;if(this.#q=null,t)for(let e=0;e<t.length;e+=2)t[e]?.(this)}error(t){const e=this.#q;if(this.#q=null,e)for(let s=1;s<e.length;s+=2)e[s]?.(t)}set(t,e=null,s=0,n=0,i=0,o=0,r=0){if("number"==typeof e&&(s=e,e=null),"string"==typeof t&&(t=t.codePointAt()),!e&&!s)return this.map.delete(t);this.map.set(t,{x:+n,y:+i,w:+o,h:+r,xadv:+s,tex:e})}getWidth(t){return"string"==typeof t&&(t=t.codePointAt()),this.map.get(t).xadv}setKerning(t,e,s=0){let n=0;if("string"==typeof t){const i=t.codePointAt();n=1114112*i,"number"==typeof e?(s=e,n+=t.codePointAt(1+(i>65535))):n+=e.codePointAt()}else n=1114112*t+e;s?this.kmap.set(n,s):this.kmap.delete(n)}getKerning(t,e){let s=0;if("string"==typeof t){const n=t.codePointAt();s=1114112*n,"number"==typeof e?(adv=e,s+=t.codePointAt(1+(n>65535))):s+=e.codePointAt()}else s=1114112*t+e;return this.kmap.get(s)}chlumsky(e,s="atlas.png"){return e.endsWith("/")&&(e+="index.json"),fetch(e).then(t=>(e=t.url,t.json())).then(n=>{const{atlas:{type:i,distanceRange:o,size:r,width:c,height:a},metrics:{ascender:h,descender:l},glyphs:f,kerning:u}=n;this.rangeFactor=o/r;const p=t.Img(new URL(s,e).href,t.SMOOTH,i.toLowerCase().endsWith("msdf")?t.Formats.RGB:t.Formats.RG);this.ascend=h/(h-l);for(const{unicode1:t,unicode2:e,advance:s}of u)this.kmap.set(e+1114112*t,s);for(const{unicode:t,advance:e,planeBounds:s,atlasBounds:n}of f)this.map.set(t,s?{x:+s.left,y:+s.bottom,w:s.right-s.left,h:s.top-s.bottom,xadv:e,tex:p.sub(n.left/c,n.bottom/a,(n.right-n.left)/c,(n.top-n.bottom)/a)}:{x:0,y:0,w:0,h:0,xadv:e,tex:null});this.done()},this.error.bind(this)),this}bmfont(e,s=0){return fetch(e).then(t=>(e=t.url,t.json())).then(n=>{const{chars:i,distanceField:o,pages:r,common:{base:c,lineHeight:a,scaleW:h,scaleH:l},kernings:f}=n,u=1/n.info.size;this.rangeFactor=o.distanceRange/a;const p=this.ascend=c/a,b=r.map(s=>t.Img(new URL(s,e).href,t.SMOOTH,o.fieldType.toLowerCase().endsWith("msdf")?t.Formats.RGB:t.Formats.RG));for(const{first:t,second:e,amount:s}of f)this.kmap.set(e+1114112*t,s/u);for(const{id:t,x:e,y:n,width:o,height:r,xoffset:c,yoffset:a,xadvance:f,page:y}of i)this.map.set(t,{x:c*u,y:p-(a-s+r)*u,w:o*u,h:r*u,xadv:f*u,tex:o&&r?b[y].sub(e/h,1-(n+r)/l,o/h,r/l):null});this.done()},this.error.bind(this)),this}draw(t,e,s=[],n=0,i=NaN,o=0,r=-1){if(this.#q)return;o*=.5,i=i!=i?t.pixelRatio()*this.rangeFactor:this.rangeFactor/i;const{map:c,kmap:a}=this;for(const l of e){const e=l.codePointAt(),f=c.get(e);if(!f)continue;const u=a.get(e+1114112*r)??0;r=e;const p=f.xadv+o+o+u;f.tex&&(h.x=n,h.y=i,t.drawRect(f.x+o+u,f.y,f.w,f.h,f.tex,h,...s)),t.translate(p,0)}return r}measure(t,e=0,s=-1){if(this.#q)return;let n=0;const{map:i,kmap:o}=this;for(const r of t){const t=r.codePointAt(),c=i.get(t);if(!c)continue;const a=o.get(t+1114112*s)??0;s=t,n+=c.xadv+e+a}return n}}t.Font=()=>new y,t.Font.bmfont=(t,e)=>(new y).bmfont(t,e),t.Font.chlumsky=(t,e)=>(new y).chlumsky(t,e)};