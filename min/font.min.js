Gamma.font=e=>{const t=e.vec4.one,s={x:0,y:1},n=e.Geometry2D.SQUARE,r=e.Shader.MSDF=e.Shader("void main(){vec3 c=param0(pos).rgb;color=param2*clamp(param1.y*(max(min(c.r,c.g),min(max(c.r,c.g),c.b))-.5+param1.x)+.5,0.,1.);}",{params:[e.COLOR,e.VEC2,e.VEC4],defaults:[null,{x:0,y:1},t]});r.sdf=!0,e.Shader.sdf=(t,s={})=>{let n="float field(vec2 uv){vec3 c=param0(uv).rgb;return max(min(c.r, c.g), min(max(c.r, c.g), c.b)); }\n#define scale param1\n";Array.isArray(s.params)||(s.params="number"==typeof s.params?[s.params]:[]),Array.isArray(s.defaults)||(s.defaults=void 0===s.defaults?[]:[s.defaults]);for(let e=0;e<s.params.length;e++)n+=`#define value${e} param${e+2}\n`;s.params.unshift(e.COLOR,e.VEC2),s.defaults.unshift(void 0,{x:0,y:1});const r=e.Shader(n+t,s);return r.sdf=!0,r};const i=e.BreakToken=(e,t=0,s="",n=void 0)=>{if(e instanceof RegExp){let t=e.flags,s=t.indexOf("g");s>-1&&(t=t.slice(0,s)+t.slice(s+1)),t.includes("y")||(t+="y"),t!=e.flags&&(e=new RegExp(e.source,t))}else{let t="[";for(const s of e+""){const e=s.codePointAt();t+=e>=92&&e<=94||45==e?"\\"+s:s}e=new RegExp(t+"]","y")}return e.type=t,e.sep=s,e.next=n,e.sepW=e.sepA=e.sepS=0,e.sepL=null,e};i.NORMAL=0,i.NEVER_BREAK=1,i.ALWAYS_BREAK=2,i.OVERFLOW=3,i.VANISH=4,i.TRUNCATE=5,i.SQUISH=6,i.SQUISH_BREAK=7,i.WRAP_AFTER=8,i.WRAP_BEFORE=16,i.INVISIBLE=32;const o=[i(/\r\n?|\n/y,i.WRAP_AFTER|i.INVISIBLE,""),i(/[$£"+]?[\w'\xA0\-]+[,.!?:;"^%€*]?/iy,i.NORMAL,"-"),i(/[ \t]+/y,i.VANISH)],c=i(/[^]/y,i.ALWAYS_BREAK),h={x:0,y:0},a={n:{0:null},off:0,spr:-1,0:null,1:h},l=[0,0,0,a],f=(e,t,s,n=0)=>{if(e.sepL=t,e.sepA=s,e.sepS=n,!t)return e.sepW=0;let r=0;const i=1/s;for(const o of e.sep){const e=o.codePointAt(),c=(t.get(~e)??t._default).width+n+(t.get(e+-16777216)??0);r+=s&&asin(c*s)*i||c}return t.then?.(()=>e.sepL==t&&(e.sepL=null,e.sepW=0)),e.sepW=r};class u extends Array{#e=null;#t=r;#s=n;#n=1;#r=0;#i=1;#o=0;#c=0;#h=0;#a=l;#l=0;#f=NaN;#u=null;#p=!0;#b=0;#y=null;#g(){if(this.#f=NaN,--this.#b)return;const e=this.#y;if(e)for(let t=0;t<e.length;t+=2)try{e[t](e[t+1])}catch(e){Promise.reject(e)}}static public=class e{constructor(e){this.#_=e}sub(){const t=new e(this.#_);return t.#k=this.#k,t.#d=this.#d,t.#m=this.#m,t.#w=this.#w,t.#A=this.#A,t.#v=this.#v,t.#x=this.#x,t.#q=this.#q,t.#N=this.#N,t.#R=this.#R,t}reset(e=null){this.#k="object"==typeof e?e:null,this.#d=r,this.#m=n,this.#w=1,this.#A=1,this.#v=0,this.#x=0,this.#q=0,this.#N=l,this.#R=!0,this.#_.#u==this&&(this.#_.#u=null)}#_;#k=null;#R=!0;get font(){return this.#k}set font(e){"object"==typeof e&&(this.#k=e),this.#_.#u==this&&(this.#_.#u=null)}#d=r;get shader(){return this.#d}set shader(e){"function"==typeof e&&(this.#d=e),this.#_.#u==this&&(this.#_.#u=null)}#m=n;get geometry(){return this.#m}set geometry(e){this.#m=e,this.#_.#u==this&&(this.#_.#u=null)}#w=1;get scale(){return this.#w}set scale(e){this.#w=+e,this.#_.#u==this&&(this.#_.#u=null)}scaleBy(e=1,t=!0,s=!0){if(1==e)return;const n=this.#_,r=n.length;let i=0,o=0;for(;i<r;){const r=n[i++];"number"==typeof r?(4==r||5==r&&s?(o||(o=1),n[i]*=e):1==r&&t&&(n[i]*=e),i++):"string"!=typeof r&&"function"!=typeof r||o||(o=2)}1!=o&&n.unshift(4,e),n.#n*=e,s&&(n.#r*=e),n.#f=NaN,n.#u=null}#P=0;get yOffset(){return this.#P}set yOffset(e){this.#P=+e,this.#_.#u==this&&(this.#_.#u=null)}offsetBy(e=0,t=!1){if(!e)return;const s=this.#_,n=s.length;let r=0,i=0,o=1,c=!1,h=0;for(;r<n;){const n=s[r++];if("number"==typeof n)5==n?(i||(i=1),h=s[r],s[r]=h+e*o,c=!1):t&&4==n&&(o=1/s[r],c=!0),r++;else if("string"==typeof n||"function"==typeof n){if(c){s.push(null,null);for(let e=s.length-3;e>=r;e--)s[e+2]=s[e];s[r++]=5,s[r++]=h+e*o}i||(i=2)}}1!=i&&s.unshift(5,e),s.#r+=e,s.#u=null}#A=1;get stretch(){return this.#A}set stretch(e){this.#A=+e,this.#_.#u==this&&(this.#_.#u=null)}stretchBy(e=1,t=!0,s=!1){if(1==e)return;const n=this.#_,r=n.length;let i=0,o=0;for(;i<r;){const r=n[i++];"number"==typeof r?(6==r||7==r&&s?(o||(o=1),n[i]*=e):1==r&&t&&(n[i]*=e),i++):"string"!=typeof r&&"function"!=typeof r||o||(o=2)}1!=o&&(s?n.unshift(7,e,6,e):n.unshift(6,e)),n.#i*=e,s&&(n.#o*=e),n.#f=NaN,n.#u=null}get letterWidth(){return this.#w*this.stretch}set letterWidth(e){this.stretch=e/this.#w}#v=0;get skew(){return this.#v}set skew(e){this.#v=+e,this.#_.#u==this&&(this.#_.#u=null)}skewBy(e=0){if(!e)return;const t=this.#_,s=t.length;let n=0,r=0;for(;n<s;){const s=t[n++];"number"==typeof s?(7==s&&(r||(r=1),t[n]+=e),n++):"string"!=typeof s&&"function"!=typeof s||r||(r=2)}1!=r&&t.unshift(7,e),t.#o+=e,t.#u=null}#x=0;get letterSpacing(){return this.#x}set letterSpacing(e){this.#x=+e,this.#_.#u==this&&(this.#_.#u=null)}spaceBy(e=0){if(!e)return;const t=this.#_,s=t.length;let n=0,r=0;for(;n<s;){const s=t[n++];"number"==typeof s?(8==s&&(r||(r=1),t[n]+=e),n++):"string"!=typeof s&&"function"!=typeof s||r||(r=2)}1!=r&&t.unshift(8,e),t.#c+=e,t.#f=NaN,t.#u=null}#q=0;get curve(){return this.#q}set curve(e){this.#q=+e,this.#_.#u==this&&(this.#_.#u=null)}curveBy(e=0){if(!e)return;const t=this.#_,s=t.length;let n=0,r=0;for(;n<s;){const s=t[n++];"number"==typeof s?(9==s?(r||(r=1),t[n]+=e):1!=s||r||(r=2),n++):"string"!=typeof s&&"function"!=typeof s||r||(r=2)}1!=r&&t.unshift(9,e),t.#h+=e,t.#f=NaN,t.#u=null}#N=l;setTextPass(e,t,s=0,n=0,r=0,i=-.5){const o={n:{0:null},off:r,spr:.5/i,0:null,1:h};if(t)for(let e=0;e<t.length;e++)o[e+2]=o.n[e+1]=t[e];const c=this.#N,a=this.#N=[];let l=0;for(;l<c.length;l+=4){if(!(c[l]<e)){c[l]==e&&(l+=4);break}a.push(c[l],c[l+1],c[l+2],c[l+3])}for(a.push(e,+s,+n,o);l<c.length;)a.push(c[l],c[l+1],c[l+2],c[l+3]),l+=4;this.#_.#u=null}setLinePass(e,n,r=0,i=1){const o={0:t,1:s};for(let e=0;e<n.length;e++)o[e+2]=n[e];const c=this.#N,h=this.#N=[];let a=0;for(;a<c.length;a+=4){if(!(c[a]<e)){c[a]==e&&(a+=4);break}h.push(c[a],c[a+1],c[a+2],c[a+3])}for(h.push(e,o,+r,+i);a<c.length;)h.push(c[a],c[a+1],c[a+2],c[a+3]),a+=4;this.#_.#u=null}unsetPass(e){const t=this.#N,s=this.#N=[];let n=0;for(;n<t.length;n+=4){if(!(t[n]<e)){t[n]==e&&(n+=4);break}s.push(t[n],t[n+1],t[n+2],t[n+3])}for(;n<t.length;)s.push(t[n],t[n+1],t[n+2],t[n+3]),n+=4;this.#_.#u=null}insertTextPass(e,t,s=0,n=0,r=0,i=-.5){const o={n:{0:null},off:r,spr:.5/i,0:null,1:h};if(t)for(let e=0;e<t.length;e++)o[e+2]=o.n[e+1]=t[e];const c=this.#_,l=c.length;let f=0,u=0;for(;f<l;){let t=c[f++];if("number"==typeof t&&t>0)f++;else if("string"==typeof t||"function"==typeof t)u||(u=2);else if(Array.isArray(t)){u||(u=1);const r=c[f-1]=[];let i=0;for(;i<t.length;i+=4){if(!(t[i]<e)){t[i]==e&&(i+=4);break}r.push(t[i],t[i+1],t[i+2],t[i+3])}for(r.push(e,+s,+n,o);i<t.length;)r.push(t[i],t[i+1],t[i+2],t[i+3]),i+=4}}1!=u&&c.unshift(e>0?[0,0,0,a,e,s,n,o]:e<0?[e,s,n,o,0,0,0,a]:[e,s,n,o]),c.#u=null}insertLinePass(e,n,r=0,i=1){const o={0:t,1:s};for(let e=0;e<n.length;e++)o[e+2]=n[e];const c=this.#_,h=c.length;let l=0,f=0;for(;l<h;){let t=c[l++];if("number"==typeof t&&t>0)l++;else if("string"==typeof t||"function"==typeof t)f||(f=2);else if(Array.isArray(t)){f||(f=1);const s=c[l-1]=[];let n=0;for(;n<t.length;n+=4){if(!(t[n]<e)){t[n]==e&&(n+=4);break}s.push(t[n],t[n+1],t[n+2],t[n+3])}for(s.push(e,o,r,i);n<t.length;)s.push(t[n],t[n+1],t[n+2],t[n+3]),n+=4}}1!=f&&c.unshift(e>0?[0,0,0,a,e,o,r,i]:e<0?[e,o,r,i,0,0,0,a]:[e,o,r,i]),c.#u=null}removePass(e){const t=this.#_,s=t.length;let n=0;e:for(;n<s;){let s=t[n++];if("number"==typeof s&&s>0)n++;else if(Array.isArray(s)){let t=0;for(;t<s.length;t+=4){if(s[t]>e)continue e;if(s[t]==e){for(t+=4;t<s.length;)s[t-4]=s[t],s[t-3]=s[t+1],s[t-2]=s[t+2],s[t-1]=s[t+3],t+=4;s.length-=4;break}}}}}#F(e){const t=this.#_.#y;t?t.push(e,this):this.#_.#y=[e,this]}get ready(){return!this.#_.#b}get then(){return this.#_.#b?this.#F:void 0}get index(){return this.#R}set index(e){this.#R=!!e,this.#_.#u==this&&(this.#_.#u=null)}advance(e=0){const t=this.#_;t.#u!=this&&this.#S(t),t.push(1,+e),t.#f=NaN}#S(e){this.#k!=e.#e&&(e.push(e.#e=this.#k),this.#k.ready||(e.#b++,this.#k.then(e.#g.bind(e)))),this.#d!=e.#t&&e.push(2,e.#t=this.#d),this.#m!=e.#s&&e.push(3,e.#s=this.#m),this.#w!=e.#n&&e.push(4,e.#n=this.#w),this.#P!=e.#r&&e.push(5,e.#r=this.#P),this.#A!=e.#i&&e.push(6,e.#i=this.#A),this.#v!=e.#o&&e.push(7,e.#o=this.#v),this.#x!=e.#c&&e.push(8,e.#c=this.#x),this.#q!=e.#h&&e.push(9,e.#h=this.#q),this.#N!=e.#a&&(e.push(this.#N),e.#a=this.#N),this.#R!=e.#p&&(e.push(this.#R),e.#p=this.#R),e.#u=this}copy(){const e=this.#_,t=e.slice(),s=t.#u=this.sub();return s.#_=t,t.#e=e.#e,t.#t=e.#t,t.#n=e.#n,t.#r=e.#r,t.#i=e.#i,t.#o=e.#o,t.#c=e.#c,t.#h=e.#h,t.#a=e.#a,t.#p=e.#p,t.#l=e.#l,t.#f=e.#f,s}slice(t=0,s=1/0){const n=this.#_,r=new u;t<0&&(t+=n.#l)<0&&(t=0),s<0&&(s+=n.#l)<0&&(s=0);const i=new e(r);let o=0;if(s<=0){for(;o<n.length;){const e=n[o++];if("number"==typeof e){const t=n[o++];switch(e){case 1:o-=2;break;case 2:i.#d=t;break;case 3:i.#m=t;break;case 4:i.#w=t;break;case 5:i.#P=t;break;case 6:i.#A=t;break;case 7:i.#v=t;break;case 8:i.#x=t;break;case 9:i.#q=t}}else{if("string"==typeof e||"function"==typeof e)break;Array.isArray(e)?"boolean"==typeof e?i.#R=e:i.#N=e:i.#k=e}}return i.#S(r),i}s=s>=t?s-t:0;let c="";for(;t>0&&o<n.length;){const e=n[o++];if("number"==typeof e){const t=n[o++];switch(e){case 2:i.#d=t;break;case 3:i.#m=t;break;case 4:i.#w=t;break;case 5:i.#P=t;break;case 6:i.#A=t;break;case 7:i.#v=t;break;case 8:i.#x=t;break;case 9:i.#q=t}}else if("string"==typeof e){if(!r.#p)continue;if((t-=e.length)<0){c=e.slice(t,(s+=t)+e.length);break}}else Array.isArray(e)?i.#N=e:"object"==typeof e?i.#k=e:"boolean"==typeof e&&(i.#R=e)}for(i.#S(r),c&&(r.push(c),r.#l+=c.length);s>0&&o<n.length;){const e=n[o++];if(r.push(e),"number"==typeof e){const t=n[o++];switch(r.push(t),e){case 2:i.#d=t;break;case 3:i.#m=t;break;case 4:i.#w=t;break;case 5:i.#P=t;break;case 6:i.#A=t;break;case 7:i.#v=t;break;case 8:i.#x=t;break;case 9:i.#q=t}}else if("string"==typeof e){if(!r.#p)continue;s-=e.length,r.#l+=e.length,s<0?(r[r.length-1]=e.slice(0,s),r.#l+=e.length+s):r.#l+=e.length}else Array.isArray(e)?i.#N=e:"object"==typeof e?i.#k=e:"boolean"==typeof e&&(i.#R=e)}return i}trim(e=1/0){const t=this.#_;if(e<0&&(e+=t.#l)<0&&(e=0),e>t.#l)return;let s=0;if(t.#e=null,t.#t=r,t.#n=1,t.#i=1,t.#r=0,t.#o=0,t.#c=0,t.#p=!0,t.#h=0,t.#a=l,t.#l=e<0?0:e)for(;e>0&&s<t.length;){const n=t[s++];if("number"==typeof n){const e=t[s++];switch(n){case 2:t.#t=e;break;case 3:t.#s=e;break;case 4:t.#n=e;break;case 5:t.#r=e;break;case 6:t.#i=e;break;case 7:t.#o=e;break;case 8:t.#c=e;break;case 9:t.#h=e}}else if("string"==typeof n){if(!t.#p)continue;if((e-=n.length)<0){t[s-1]=n.slice(0,e);break}}else Array.isArray(n)?t.#a=n:"object"==typeof n?t.#e=n:"boolean"==typeof n&&(t.#p=n)}else for(;s<t.length;){const e=t[s++];if("number"==typeof e){const n=t[s++];switch(e){case 1:s-=2;break;case 2:t.#t=n;break;case 3:t.#s=n;break;case 4:t.#n=n;break;case 5:t.#r=n;break;case 6:t.#i=n;break;case 7:t.#o=n;break;case 8:t.#c=n;break;case 9:t.#h=n}}else{if("string"==typeof e||"function"==typeof e){s--;break}Array.isArray(e)?t.#a=e:"boolean"==typeof e?t.#p=e:t.#e=e}}this.#k=t.#e,this.#d=t.#t,this.#m=t.#s,this.#w=t.#n,this.#P=t.#r,this.#A=t.#i,this.#v=t.#o,this.#x=t.#c,this.#q=t.#h,this.#N=t.#a,t.length=s,t.#f=NaN}concat(e){const t=this.#_,s=e.#_;t.#l+=s.#l;let i=0;this.#k=null,this.#d=r,this.#m=n,this.#w=1,this.#P=0,this.#A=1,this.#v=0,this.#x=0,this.#q=0,this.#N=l;const o=s.length;e:for(;i<o;){const e=s[i++];if("number"==typeof e){const t=s[i++];switch(e){case 1:i-=2;break e;case 2:this.#d=t;break;case 3:this.#m=t;break;case 4:this.#w=t;break;case 5:this.#P=t;break;case 6:this.#A=t;break;case 7:this.#v=t;break;case 8:this.#x=t;break;case 9:this.#q=t}}else{if("string"==typeof e||"function"==typeof e){i--;break}Array.isArray(e)?this.#N=e:"boolean"==typeof e?this.#R=e:this.#k=e}}for(this.#S(t);i<o;){const e=s[i++];if(t.push(e),"number"==typeof e){const n=s[i++];switch(t.push(n),e){case 2:this.#d=n;break;case 3:this.#m=n;break;case 4:this.#w=n;break;case 5:this.#P=n;break;case 6:this.#A=n;break;case 7:this.#v=n;break;case 8:this.#x=n;break;case 9:this.#q=n}}else"string"==typeof e?t.#p&&(t.#l+=e.length):Array.isArray(e)?this.#N=e:"boolean"==typeof e?this.#R=e:"object"==typeof e&&(this.#k=e)}t.#f=NaN}get length(){return this.#_.#l}set length(e){this.trim(e)}get width(){const e=this.#_;let t=e.#f;if(t==t)return t;t=0;let s=null,n=0,r=1,i=1,o=0,c=0,h=0,a=1,l=-1,f=1;for(;n<e.length;){let u=e[n++];if("number"==typeof u){const s=e[n++];switch(u){case 1:t+=a*s,l=-1;break;case 4:a=(r=s)*i,l=-1;break;case 6:a=(i=s)*r,l=-1;break;case 5:case 7:l=-1;break;case 8:o=s;break;case 9:h=1/s,c=s}}else e:if("string"==typeof u){if(!s)break e;let e=0;for(;e<u.length;){const n=u.codePointAt(e);e+=1+(n>65535);const r=s.get(~n)??s._default;if(!r)continue;const i=(s.get(n+16777216*l)??0)*min(a,f);l=n,f=a;const p=(r.width+o)*a+i;t+=c&&asin(p*c)*h||p,r.tex?.waiting&&r.tex.load()}}else if("object"==typeof u){if(!u){s=null;continue}if(Array.isArray(u))continue;s=u,u.then?.(()=>e.#f=NaN)}}return e.#f=t}add(e){const t=this.#_;t.#u!=this&&this.#S(t),t.#p&&(t.#l+=(e+="").length),t.push(e),t.#f=NaN}addCb(e,t=NaN){if("function"!=typeof e)return;const s=this.#_;s.#u!=this&&this.#S(s),t==t?s.push(e,1,t):s.push(e)}indexAt(e=0,t=.5){t--;const s=this.#_;let n=null,r=0,i=1,o=1,c=0,h=!0,a=0,l=0,f=1,u=-1,p=1,b=0,y=0;for(;r<s.length;){let g=s[r++];if("number"==typeof g){const t=s[r++];switch(g){case 1:e-=f*t,u=-1;break;case 4:f=(i=t)*o,u=-1;break;case 6:f=(o=t)*i,u=-1;break;case 5:case 7:u=-1;break;case 8:c=t;break;case 9:l=1/t,a=t}}else if("string"==typeof g)if(n){let s=0;for(;s<g.length;){const r=g.codePointAt(s),i=1+(r>65535);s+=i;const o=n.get(~r)??n._default;if(!o){h&&(y=b+=i);continue}const _=(n.get(r+16777216*u)??0)*min(f,p);u=r,p=f;const k=(o.width+c)*f+_,d=a&&asin(k*a)*l||k;if(e-=d,h){if(e<=d*t)return y;y=b+=i}}}else h&&(b+=g.length);else if("object"==typeof g){if(!g){n=null;continue}if(Array.isArray(g))continue;n=g}else"boolean"==typeof g&&(h=g)}return y}draw(e){const t=this.#_;let s=null,i=0,o=1,c=1,a=1,f=0,u=0,p=0,b=0,y=0;e.shader=r,e.geometry=n;let g=l,_=3,k=null,d=0,m=!0,w=-1,A=1,v=e.perspective,x=-2*e.pixelRatio(),q=1,N=1,R=1,P=0;e:for(;i<t.length;){let n=t[i++];if("number"==typeof n){const s=t[i++];switch(n){case 1:if(y){u&&e.skew(-u,0);const t=.5/y,n=s*y*2;e.rotate(P),e.translate(sin(n)*t,(1-cos(n))*t),e.rotate(-n),P=0,u&&e.skew(u,0)}else e.translate(s,0);w=-1;continue e;case 4:const t=s*c;c=1/s,e.scale(t),p*=o*=c,b*=o,A*=t,y*=t,o=s,k&&(q=x*o*k.rangeFactor),w=-1;continue e;case 5:p=s*c,b=p*u,w=-1;continue e;case 2:e.shader=s,m=!!s.sdf;break;case 3:e.geometry=s;break;case 6:a=s,w=-1;continue e;case 7:e.skew(s-u,0),u=s,b=p*s,w=-1;continue e;case 8:f=.5*s;continue e;case 9:y=s*o;continue e;default:continue e}}else{if("string"==typeof n){if(!s)continue;let t=0;for(;t<n.length;){const r=n.codePointAt(t);t+=1+(r>65535);const i=s.get(~r)??s._default;if(!i)continue;v&&(x=-2*e.pixelRatio(),q=x*o*k.rangeFactor);const c=(s.get(r+16777216*w)??0)*min(A,a);w=r,A=a;const l=(i.width+f+f)*a+c,F=c-b;y&&(u&&e.skew(-u,0),e.rotate(P+(P=-asin(l*y)||0)),u&&e.skew(u,0));for(let t=0;t<_;t+=4){let s=g[t+1],n=g[t+2]+p,r=g[t+3];if(m||(r=r.n),"object"==typeof s){const t=y*l*(n+d);e.drawRectv(F+t,n+d,l-t-t,r,s)}else if(i.tex){if(r[0]=i.tex,m){h.x=r.off*R;const{spr:e}=r;h.y=(e<0?q:N)*e}e.drawRectv((i.x+f)*a+s+F,i.y+n,i.w*a,i.h,r)}}e.translate(l,0)}continue}if("function"==typeof n){const t=e.sub();P&&(t.skew(-u,0),t.rotate(P),t.skew(u,0)),n(t,k)}else if("object"==typeof n){if(!n){s=null;continue}if(Array.isArray(n)){if(_=(g=n).length,v=!1,e.perspective)for(let e=0;e<_;e+=4)if("object"==typeof g[e+3]&&g[e+3].spr<0){v=!0;break}continue}k=n,d=k.ascend-1,s=n,q=x*o*(N=k.rangeFactor),R=1/N}}}u&&e.skew(-u,0),P&&e.rotate(P),1!=o&&e.scale(c)}break(t=1/0,s=o,n={scale:1,letterSpacing:0,curve:0}){const r=this.#_;let i=!1,h="",a=0;for(;a<r.length;){const e=r[a++];"number"!=typeof e?"object"!=typeof e||Array.isArray(e)?"string"==typeof e&&i&&(h+=e):i=!!e:a++}const l=[];let p="number"==typeof t?t:"function"==typeof t?t(l.length,n):t[min(l.length,t.length-1)],b=new u,y=b.#u=new e(b),g=0,_="";a=0;let k=null,d=1,m=1,w=-1,A=0,v=!1,x=null,q=-1;for(;a<h.length;){let i=0,o=c,N=b.length,R=A,P=y.#d,F=y.#m,S=y.#w,E=y.#P,L=y.#A,O=y.#v,j=y.#x,B=y.#k,W=y.#q,T=y.#N,C=b.#p,I=b.#l;if(q>=0)o=x,i=q,q=-1;else e:for(;;){if(s)for(o of s){if(o.lastIndex=a,!o.test(h))continue;const e=o.lastIndex-a;a+=e,i?(q=e,x=o,o=c):i=e;break e}if(++i,++a==h.length){o=c;break}}s=o.next??s;const H=o.type;16&H&&(l.push(y),b.#f=v?NaN:A,v=!1,y=y.sub(),y.#_=b=new u,p="number"==typeof t?t:"function"==typeof t?t(l.length,n):t[min(l.length,t.length-1)],N=R=A=I=0,C||b.push(b.#p=!1),y.#S(b));const V=!!(32&H);if(_){let e=_;i<_.length?(e=_.slice(0,i),_=_.slice(i),i=0):(i-=_.length,_=""),V&&b.#e&&b.push(null),e&&b.push(e),b.#p&&(b.#l+=e.length),V&&b.#e&&b.push(b.#e)}for(;i>0;){const e=r[g++];if("number"==typeof e){const t=r[g++];switch(b.push(e,t),e){case 2:y.#d=b.#t=t;break;case 3:y.#m=b.#s=t;break;case 4:y.#w=b.#n=t;break;case 5:y.#P=b.#r=t;break;case 6:y.#A=b.#i=t;break;case 7:y.#v=b.#o=t;break;case 8:y.#x=b.#c=t;break;case 9:y.#q=b.#h=t}}else if("string"==typeof e){if(!b.#e){b.push(e),b.#p&&(b.#l+=e.length);continue}i-=e.length;let t=e;i<0?(t=e.slice(0,i),_=e.slice(i)):_="",V&&b.push(null),b.push(t),b.#p&&(b.#l+=t.length),V&&b.push(b.#e)}else"boolean"==typeof e?b.push(b.#p=e):(b.push(e),Array.isArray(e)?b.#a=y.#N=e:"function"!=typeof e&&(b.#e=y.#k=e))}for(;;){let s=N,r=0,i=0,c=P,h=F,a=S,g=E,_=L,x=O,q=j,V=B,G=T,U=C,K=I,M=W,Y=1/M,D=!1,Q=o.sepL==V&&o.sepA==M&&o.sepS==q?o.sepW:f(o,V,M,q);const $=H?!!(36>>H&1):2*R<p,{scale:z=1,letterSpacing:J=0,curve:X=0}=n;v||=1!=z||0!=J||0!=X;let Z=M+X,ee=q+J;for(X&&(Y=1/Z);s<b.length;){const e=b[s++];if("number"==typeof e){const t=b[s++];switch(e){case 1:if(A+=t,w=-1,A>p-(Q-(k?.get(o.sep.codePointAt()+16777216*w)??0))*d||!$)break;N=s-2,i=0,D=!0,R=A,P=c,F=h,S=a,E=g,L=_,O=x,j=q,B=V,W=M,T=G,C=U,I=K;break;case 2:c=t;break;case 3:h=t;break;case 4:a=t,d=t*_*z;break;case 5:g=t;break;case 6:_=t,d=t*a*z;break;case 7:x=t;break;case 8:q=t,ee=t+J;break;case 9:Z=t+X,Y=1/Z,M=t}}else if("string"==typeof e)if(r=0,k){let t=0;for(;t<e.length;){const n=e.codePointAt(t),l=1+(n>65535);t+=l;const f=k.get(~n)??k._default;if(r+=l,U&&(K+=l),!f)continue;const u=(k.get(n+16777216*w)??0)*min(d,m);m=d,w=n;const b=(f.width+ee)*d+u;A+=Z&&asin(b*Z)*Y||b,A<=p-(Q-(k.get(o.sep.codePointAt()+16777216*n)??0))*d&&$&&(D=!0,N=s-1,i=r,R=A,P=c,F=h,S=a,E=g,L=_,O=x,j=q,B=V,W=M,T=G,C=U,I=K)}}else U&&(K+=e.length);else if(Array.isArray(e))G=e;else if("boolean"==typeof e)U=e;else{if("function"==typeof e)continue;(V=e)?(k=e,Q=o.sepL==e&&o.sepA==M&&o.sepS==q?o.sepW:f(o,e,M,q)):(k=null,Q=0)}}if(!R||A<=p||!N||3==H)break;if(s=N,r=i,c=P,h=F,a=S,g=E,_=L,x=O,q=j,V=B,G=T,U=C,M=W,K=I,6==H||7==H&&p-R>=A-p){const e=(p-R)/(A-R),t=b.length;for(b.splice(s,0,6,e*_),s+=2;s<t;){const t=b[s++];"number"==typeof t&&(6==t&&(b[s]*=e),s++)}b.push(6,_);break}A=R;const te=new u,se=new e(te),ne=b.length;se.#d=c,se.#m=h,se.#w=a,se.#P=g,se.#A=_,se.#v=x,se.#x=q,se.#N=G,se.#q=M,se.#R=U;let re=s+=!!r,ie=V;const oe=4!=H&&5!=H;if(r){se.#k=ie,se.#S(te);const e=b[s-1];b[s-1]=e.slice(0,r),te.push(e.slice(r)),oe?ie=null:te.push(se.#k=te.#e=null)}else{e:for(;re<ne;){const e=b[re++];if("number"==typeof e){const t=b[re++];switch(e){case 1:if(oe){re-=2;break e}break;case 2:se.#d=t;break;case 3:se.#m=t;break;case 4:se.#w=t;break;case 5:se.#P=t;break;case 6:se.#A=t;break;case 7:se.#v=t;break;case 8:se.#x=t;break;case 9:se.#q=t}}else{if("string"==typeof e||"function"==typeof e){re--;break}"boolean"==typeof e?se.#R=e:Array.isArray(e)?se.#N=e:ie=e}}se.#S(te)}if(oe)for(ie&&te.push(se.#k=te.#e=ie);re<ne;)te.push(b[re++]);else for(;re<ne;){const e=b[re++];"number"==typeof e?te.push(e,b[re++]):("object"!=typeof e||Array.isArray(e))&&te.push(e)}te.#l=b.#l-K,b.#l=K,b.#f=v?NaN:A,v=!1,se.#d=te.#t=y.#d,se.#m=te.#s=y.#m,se.#w=te.#n=y.#w,se.#P=te.#r=y.#P,se.#A=te.#i=y.#A,se.#v=te.#o=y.#v,se.#x=te.#c=y.#x,se.#q=te.#h=y.#q,se.#R=te.#p=y.#R,se.#N=te.#a=y.#N,b.length=s,!oe&&ie&&te.push(se.#k=te.#e=ie),D&&(b.#p&&b.push(b.#p=!1),b.push(o.sep)),l.push(y),y=se,b=te,p="number"==typeof t?t:"function"==typeof t?t(l.length,n):t[min(l.length,t.length-1)],N=i=R=A=I=0}8&H&&(l.push(y),b.#f=v?NaN:A,v=!1,A=0,y=y.sub(),y.#_=b=new u,p="number"==typeof t?t:"function"==typeof t?t(l.length,n):t[min(l.length,t.length-1)],y.#S(b))}for(;g<r.length;){const e=r[g++];if(b.push(e),"number"==typeof e){const t=r[g++];switch(b.push(t),e){case 2:y.#d=b.#t=t;break;case 3:y.#m=b.#s=t;break;case 4:y.#w=b.#n=t;break;case 5:y.#P=b.#r=t;break;case 6:y.#A=b.#i=t;break;case 7:y.#v=b.#o=t;break;case 8:y.#x=b.#c=t;break;case 9:y.#q=b.#h=t}}else Array.isArray(e)?y.#N=b.#a=e:"object"==typeof e?y.#k=b.#e=e:"boolean"==typeof e&&(y.#R=b.#p=e)}return b.#f=v?NaN:A,l.push(y),l}toString(){let e="",t=!0,s=0;const n=this.#_,r=n.length;for(;s<r;){const r=n[s++];"number"!=typeof r?"boolean"==typeof r?t=r:"string"==typeof r&&t&&(e+=r):s++}return e}clear(){const e=this.#_;e.#e=null,e.#t=r,e.#s=n,e.#n=1,e.#r=0,e.#i=1,e.#o=0,e.#c=0,e.#h=0,e.#a=l,e.#l=0,e.#f=NaN,e.#u=null,e.#p=!0,e.length=0}static ctor=(t=null)=>{const s=new u;if(!t)return s.#u=new e(s);const n=new e(s);return n.#k=t,n}}}e.RichText=u.public.ctor;const p=Texture(4,6,1,0,Formats.RGBA4).pasteData(Uint8Array.fromHex("ffffffffffffffffffff00000000ffffffff00000000ffffffff00000000ffffffff00000000ffffffffffffffffffff"));class b extends Map{rangeFactor=0;ascend=0;#E=[];_default={x:.05,y:-.0625,w:.5,h:.75,width:.6,tex:p};get ready(){return!this.#E}get then(){return this.#E?this.#F:void 0}#F(e,t){this.#E?.push(e,t)}done(){const e=this.#E;if(this.#E=null,e)for(let t=0;t<e.length;t+=2)e[t]?.(this)}error(e){const t=this.#E;if(this.#E=null,t)for(let s=1;s<t.length;s+=2)t[s]?.(e)}setChar(e=-1,t=0,s=null,n=0,r=0,i=0,o=0){if("string"==typeof e&&(e=e.codePointAt()),"object"==typeof t&&({x:n,y:r,w:i,h:o,width:t,tex:s}=t),e<0){const e=this._default;return s||t?(e.x=+n,e.y=+r,e.w=+i,e.h=+o,e.width=+t,e.tex=s):(e.x=e.y=e.w=e.h=e.width=0,e.tex=null),e}if(s||t){const c={x:+n,y:+r,w:+i,h:+o,width:+t,tex:s};return super.set(~e,c),c}return super.delete(~e),null}getChar(e=-1){return"string"==typeof e&&(e=e.codePointAt()),this.get(~e)??null}getWidth(e=-1){return"string"==typeof e&&(e=e.codePointAt()),(e<0?this._default:this.get(~e)??this._default).width}setKerning(e,t,s=0){"string"==typeof e&&(e=e.codePointAt()),"string"==typeof t&&(t=t.codePointAt()),s?super.set(16777216*e+t,s):super.delete(16777216*e+t)}getKerning(e,t){"string"==typeof e&&(e=e.codePointAt()),"string"==typeof t&&(t=t.codePointAt());const s=this.get(16777216*e+t);return"number"==typeof s?s:0}chlumsky(t,s="atlas.png",n=e.ANISOTROPY|e.SMOOTH,r=1,i=e.Font.defaultFixes){return t.endsWith("/")&&(t+="index.json"),fetch(t).then(e=>(t=e.url,e.json())).then(o=>{const{atlas:{type:c,distanceRange:h,size:a,width:l,height:f},metrics:{ascender:u,descender:p},glyphs:b,kerning:y}=o;this.rangeFactor=h/a;const g=e.Texture.from(new URL(s,t).href,n,c.toLowerCase().endsWith("msdf")?e.Formats.RGB:e.Formats.RG,r);this.ascend=u/(u-p);for(const{unicode1:e,unicode2:t,advance:s}of y)super.set(t+16777216*e,s);for(const{unicode:e,advance:t,planeBounds:s,atlasBounds:n}of b)super.set(~e,s?{x:+s.left,y:+s.bottom,w:s.right-s.left,h:s.top-s.bottom,width:t,tex:g.sub(n.left/l,n.bottom/f,(n.right-n.left)/l,(n.top-n.bottom)/f)}:{x:0,y:0,w:0,h:0,width:t,tex:null});i?.(this),g.then(()=>this.done())},this.error.bind(this)),this}bmfont(t,s=0,n=e.ANISOTROPY|e.SMOOTH,r=1,i=e.Font.defaultFixes){return fetch(t).then(e=>(t=e.url,e.json())).then(o=>{const{chars:c,distanceField:h,pages:a,common:{base:l,lineHeight:f,scaleW:u,scaleH:p},kernings:b}=o,y=1/o.info.size;this.rangeFactor=h.distanceRange/f;const g=this.ascend=l/f,_=a.map(s=>e.Texture.from(new URL(s,t).href,n,h.fieldType.toLowerCase().endsWith("msdf")?e.Formats.RGB:e.Formats.RG,r));for(const{first:e,second:t,amount:s}of b)super.set(t+16777216*e,s/y);for(const{id:e,x:t,y:n,width:r,height:i,xoffset:o,yoffset:h,xadvance:a,page:l}of c)super.set(e,{x:o*y,y:g-(h-s+i)*y,w:r*y,h:i*y,width:a*y,tex:r&&i?_[l].sub(t/u,1-(n+i)/p,r/u,i/p):null});i?.(this),Promise.all(_).then(()=>this.done())},this.error.bind(this)),this}draw(e,t,s=[],n=0,r=-.5,i=0,o=-1){if(this.#E)return;i*=.5,n/=this.rangeFactor;const c=!!e.shader.sdf,a=r<0&&e.perspective&&c;let l=r=1/r;a||(l*=(r<0?-e.pixelRatio():.5)*this.rangeFactor);let f=0;for(;f<t.length;){const u=t.codePointAt(f);f+=1+(u>65535);const p=this.get(~u)??this._default;if(!p)continue;a&&(l=-e.pixelRatio()*this.rangeFactor*r);const b=this.get(u+1114112*o)??0;o=u;const y=p.width+i+i+b;p.tex&&(c?(h.x=n,h.y=l,e.drawRect(p.x+i+b,p.y,p.w,p.h,p.tex,h,...s)):e.drawRect(p.x+i+b,p.y,p.w,p.h,p.tex,...s)),e.translate(y,0)}}measure(e,t=0,s=-1){if(this.#E)return 0;let n=0,r=0;for(;r<e.length;){const i=e.codePointAt(r);r+=1+(i>65535);const o=this.get(~i)??this._default;if(!o)continue;const c=this.get(i+1114112*s)??0;s=i,n+=o.width+t+c}return n}}e.Font=()=>new b,e.Font.bmfont=(e,t)=>(new b).bmfont(e,t),e.Font.chlumsky=(e,t)=>(new b).chlumsky(e,t),e.Font.defaultFixes=e=>{const t=e.getChar(32)??e.setChar(32,.5);e.has(160)||e.setChar(160,t),e.has(9)||e.setChar(9,4*t.width)}};