{const $=globalThis,{clz32,cos,sin,min,round}=Math;Math.PI2??=2*Math.PI;if(!('setImmediate'in $)){let t=0,o=0,m=new MessageChannel,c=[];m.port1.onmessage=v=>{v=c[o];c[o++]=null;if(o>3&&o>(c.length>>1))c.splice(0,o),t+=o,o=0;v?.()};m=m.port2;$.setImmediate=(f,...a)=>(m.postMessage(0),c.push(a.length?f.bind(void 0,...a):f)+t-1);$.clearImmediate=i=>{(i-=t)===i>>>0&&i<c.length&&(c[i]=null)}}if(!('sin'in $)){let p=Object.getOwnPropertyDescriptors(Math);delete p[Symbol.toStringTag];Object.defineProperties($,p)};const q={imageOrientation:"flipY",premultiplyAlpha:"premultiply"},R=(t,e,i)=>"string"==typeof t?fetch(t).then((t=>t.blob())).then((t=>createImageBitmap(t,q))).then(e,i):t instanceof Blob?createImageBitmap(t,q).then(e,i):e(t);Object.assign($.Gamma=(T=document.createElement('canvas'),$={},f=15)=>{const g=$.gl=($.canvas=T).getContext("webgl2",{preserveDrawingBuffer:!(f&8),antialias:f&16,depth:!1,premultipliedAlpha:f&4,stencil:f&1,alpha:f&2}),pp=g.createBuffer();g.pixelStorei(37440,1),g.stencilMask(1),g.clearStencil(0),g.disable(2929),g.enable(3042),g.pixelStorei(3317,1),g.pixelStorei(3333,1),g.bindBuffer(35052,pp);class c{get isInteger(){return this.t.f.length>3}get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get mipmaps(){return this.t.m}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,e=0,i=0,s=1,r=1,n=0){this.t=t,this.x=e,this.y=i,this.w=s,this.h=r,this.l=n}get loaded(){return!this.t.S}get then(){return this.t.S?this.#t:null}load(){this.t.T||c.load(this.t)}sub(t=0,e=0,i=1,s=1,r=this.l){return new c(this.t,this.x+t*this.w,this.y+e*this.h,this.w*i,this.h*s,r)}super(t=0,e=0,i=1,s=1,l=this.l){const r=this.w/i,n=this.h/s;return new c(this.t,this.x-t*r,this.y-e*n,r,n,l)}crop(t=0,e=0,i=0,s=0,r=this.l){const{t:n,x:h,y:a,h:u}=this;if(!n.S)return new c(n,h+t/n.w,a+u-(e+s)/n.h,i/n.w,s/n.h,r);const o=new c(n,0,0,0,0,r);return n.T||c.load(n),n.S.push((r=>{r.x=h+t/n.w,r.y=a+u-(e+s)/n.h,r.w=i/n.w,r.h=s/n.h}),void 0,o),o}layer(t=this.l){return new c(this.t,this.x,this.y,this.w,this.h,t)}#t(t,e){"function"!=typeof t&&(t=Function.prototype),this.t.S?(this.t.T||c.load(this.t),this.t.S.push(t,e,this)):t(this)}static load(t){let e=t.S,i=0,s=0,r=0;t.S=[];t.T=g.createTexture();const n=n=>{i=-1,c.sO(t),g.texStorage3D(35866,t.m,t.f[0],t.w=s=1,t.h=r=1,t.d),z||(g.pixelStorei(37440,1),g.pixelStorei(37441,z=1)),t.m>1&&g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null);const l=t.S;t.S=null;for(let e=1;e<l.length;e+=3)l[e]?.(l[e+1])};for(let h=0;h<e.length;h++)R(e[h],(a=>{if(i){if(s!=a.width||r!=a.height)return n()}else s=a.width,r=a.height;if(e[h]=a,!(++i<e.length)){c.sO(t),g.texStorage3D(35866,t.m,t.f[0],t.w=s,t.h=r,t.d),z||(g.pixelStorei(37440,1),g.pixelStorei(37441,z=1));g.bindBuffer(35052,null);for(let n=0;n<i;n++)g.texSubImage3D(35866,0,0,0,n,s,r,1,t.f[1],t.f[2],e[n]);g.bindBuffer(35052,pp);t.m>1&&g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null);const l=t.S;t.S=null;for(let e=0;e<l.length;e+=3)l[e](l[e+2])}}),n)}paste(t,e=0,s=0,r=0,w=0,n=0,h=0,a=0,u=0,o=0,l=0,q=0){const{t:f}=this;if(f.S)return null;if(t instanceof can){const b=t.t;b.c?g.framebufferTextureLayer(36008,36064,b.T,b.L&255,b.L>>>8):g.framebufferRenderbuffer(36008,36064,36161,b.T);ca==c0&&(g.bindFramebuffer(36009,fb),ca=null);g.framebufferTextureLayer(36009,36064,fT=f.T,w,r);fL=w&255|r<<8;g.blitFramebuffer(n,h,n+(a=a||b.w),h+(u=u||b.h),x,y,x+a,y+u,16384,9728);return this}if(!(t instanceof c))return R(t,(t=>(c.B(f),z||(g.pixelStorei(37440,1),g.pixelStorei(37441,z=1)),g.bindBuffer(35052,null),g.texSubImage3D(35866,w,e,s,r,t.width,t.height,1,f.f[1],f.f[2],t),g.bindBuffer(35052,pp),f.i<0&&g.bindTexture(35866,null),this)));const b=t.t;if(b.S)return console.warn('Source texture is not loaded'),this;if(f.T==b.T)return console.warn("Cannot copy from texture to itself"),this;i&&L();c.B(f),u=u||b.w,o=o||b.h,l=l||b.d;while(l--)g.framebufferTextureLayer(36008,36064,b.T,q,a++),g.copyTexSubImage3D(35866,w,e,s,r++,n,h,u,o);return f.i<0&&g.bindTexture(35866,null),this}pasteData(t,e=0,i=0,s=0,r=0,n=0,h=0,q=0){const{t:a}=this;if(a.S)return null;r=r||a.w,n=n||a.h,h=h||a.d,c.B(a),z&&(g.pixelStorei(37440,0),g.pixelStorei(37441,z=0)),g.bufferData(35052,t,35042),g.texSubImage3D(35866,q,e,i,s,r,n,h,a.f[1],a.f[2],0),fd+=.25*t.byteLength,a.i<0&&g.bindTexture(35866,null);return this}readData(t=0,e=0,s=0,r=0,n=0,h=0,q=0){const{t:u}=this;if(u.S)return null;r=r||u.w,n=n||u.h,h=h||u.d,i&&L();let o=u.f[0],l=(o==33323||o==33338||o==33340||o==33327||o==33328||o==33336?2:o==33321||o==33330||o==33332||o==33334||o==33325||o==33326?1:4),F=l<3?l==1?6403:33319:l==3?6407:6408;o=u.f[2];o=5121==o?1:5126==o||5125==o||35899==o||33640==o||35902==o?4:2;l*=r*n;let p,S=l*h*o;pS==S?(p=pL,pS=-1,pU=!0):(g.bindBuffer(35051,p=g.createBuffer()),g.bufferData(35051,S,35041),S>pS&&(pS=S,pL=p,pU=!0));while(h--)g.framebufferTextureLayer(36008,36064,u.T,q,s),g.readPixels(t,e,r,n,F,u.f[2],l*o*(s++));p!=pL&&g.bindBuffer(35041,pL);return new Promise(R=>{const r=()=>{const a=5121==o==1?new Uint8Array(l*h):o==4?u.f[2]==5126?new Float32Array(l*h):new Uint32Array(l*h):new Uint16Array(l*h);p!=pL&&g.bindBuffer(35041,p);g.getBufferSubData(35041,0,a);R(a);p!=pL&&(S>pS?(pS=S,pL=p):g.bindBuffer(35041,pL));pU=!0};r.s=g.fenceSync(37143,0);tl??=r;hd=hd?hd.n=r:r;iv=iv||setInterval(iF)})}delete(){this.t.T&&(g.deleteTexture(this.t.T),this.t.T=null,this.t.i>=0&&(bd[this.t.i]=null,this.t.i=-1),this.t.d=this.t.w=this.t.h=0)}static L(t,e=0){if(t.f[3]>>31!=e)return-2;if(t.i>=0){const i=-2147483648>>>t.i-(H-F&e);if(!(i&(e^M)))return Q|=i,t.i;bd[t.i]=null,t.i=-1}t.T||c.load(t);const i=clz32(~(Q|e^M));if(i>=H)return-1;Q|=-2147483648>>>i;const s=bd[e=e?H+i-F:i];return s&&(s.i=-1),g.activeTexture(33984+e),g.bindTexture(35866,(bd[e]=t).T),t.i=e}static B(t){if(t.i>=0)i&&L(),g.activeTexture(33984+t.i);else{const e=H-1+(F==H&&H);bd[e]&&(bd[e].t.i=-1),g.activeTexture(33984+e),g.bindTexture(35866,t.T)}}get options(){return this.t.o}static sO(t){c.B(t);const{o:e}=t;t.f[3]>>31?(g.texParameterf(35866,10240,9728),g.texParameterf(35866,10241,9728)):(g.texParameterf(35866,10240,9728+(1&e)),g.texParameterf(35866,10241,t.m>1?9984+(e>>1&3):9728+(e>>1&1))),g.texParameterf(35866,10242,8&e?10497:16&e?33648:33071),g.texParameterf(35866,10243,32&e?10497:64&e?33648:33071)}set options(t){const{t:e}=this;e.o=t,e.S||(c.sO(e),e.i<0&&g.bindTexture(35866,null))}setMipmapRange(s=0,e=65535){const{t}=this;t.src||(c.B(t),g.texParameteri(35866,33082,s),g.texParameteri(35866,33083,e),t.i<0&g.bindTexture(35866,null))}genMipmaps(){const{t:t}=this;t.m>1&&(c.B(t),g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null))}};$.Drawable=(x,t=x.l,m=0,e=!1)=>{const{t:i}=x;if(i.S)return null;let s=null;return e&&(g.bindRenderbuffer(36161,s=g.createRenderbuffer()),g.renderbufferStorage(36161,36168,i.w,i.h)),new can({T:i.T,c:x,L:m&255|t<<8,S:0,s:s,w:i.w>>m,h:i.h>>m})};$.DrawableMSAA=(w=0,h=0,f=Formats.RGBA,m=65536,s=!1)=>{let S=null,r=g.createRenderbuffer();g.bindRenderbuffer(36161,r);g.renderbufferStorageMultisample(36161,m=min(m,mS),f[0],w,h);s&&(g.bindRenderbuffer(36161,S=g.createRenderbuffer()),g.renderbufferStorageMultisample(36161,m,36168,w,h));return new can({T:r,c:null,S:0,L:g.getRenderbufferParameter(36161,36011),s:S,w,h})};let C,z=1,pL=null,pS=-1,pU=!1,ar=new Float32Array(16),ir=new Int32Array(ar.buffer),i=0;T=$.Texture=(t=0,e=0,i=0,s=0,f=Formats.RGBA,m=0)=>{const h={T:g.createTexture(),i:-1,a:-1,o:s,f,S:null,w:t,h:e,d:+i||1,m:m=m||1},a=new c(h);return c.sO(h),t&&e?g.texStorage3D(35866,m,h.f[0],t,e,h.d):g.texStorage3D(35866,m,h.f[0],h.w=1,h.h=1,h.d),g.bindTexture(35866,null),a},T.MAX_WIDTH=T.MAX_HEIGHT=g.getParameter(3379),T.MAX_LAYERS=g.getParameter(35071),T.FILTER_32F=!!g.getExtension('OES_texture_float_linear'),$.Img=(t,e=0,i=Formats.RGBA,s=0)=>new c({T:null,i:-1,a:-1,o:e,f:i,S:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:t?Array.isArray(t)?t.length:1:0,m:s||1}),Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NEVER:48,UNSET:64,SET:128,FLIP:192,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:136,RGB_DST:8,ONE_MINUS_DST:153,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,ADD:17,RGB_ADD:1,A_ADD:16,SUB:85,RGB_SUB:5,A_SUB:80,SUB_REV:102,RGB_SUB_REV:6,A_SUB_REV:96,MIN:34,RGB_MIN:2,A_MIN:32,MAX:51,RGB_MAX:3,A_MAX:48,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:20,UTEXTURE:24,FTEXTURE:28,COLOR:4,UCOLOR:8,FCOLOR:12,FIXED:4,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0});T=$.vec2=(x=0,y=x)=>({x,y}),T.one=T(1);const v2z=T.zero=T(0);T.add=(a,b)=>typeof b=='number'?{x:a.x+b,y:a.y+b}:{x:a.x+b.x,y:a.y+b.y};T.multiply=(a,b)=>typeof b=='number'?{x:a.x*b,y:a.y*b}:{x:a.x*b.x,y:a.y*b.y};T=$.vec3=(x=0,y=x,z=x)=>({x,y,z}),T.one=T(1);const v3z=T.zero=T(0);T.add=(a,b)=>typeof b=='number'?{x:a.x+b,y:a.y+b,z:a.z+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z};T.multiply=(a,b)=>typeof b=='number'?{x:a.x*b,y:a.y*b,z:a.z*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z};T=$.vec4=(x=0,y=x,z=x,w=x)=>({x,y,z,w}),T.one=T(1);const v4z=T.zero=T(0);T.add=(a,b)=>typeof b=='number'?{x:a.x+b,y:a.y+b,z:a.z+b,w:a.w+b}:{x:a.x+b.x,y:a.y+b.y,z:a.z+b.z,w:a.w+b.w};T.multiply=(a,b)=>typeof b=='number'?{x:a.x*b,y:a.y*b,z:a.z*b,w:a.w*b}:{x:a.x*b.x,y:a.y*b.y,z:a.z*b.z,w:a.w*b.w};$.Formats={R:[33321,6403,5121],RG:[33323,33319,5121],RGB:[32849,6407,5121],RGBA:[32856,T=6408,5121],RGB565:[36194,6407,33635],R11F_G11F_B10F:[35898,6407,35899],RGB5_A1:[32855,T,32820],RGB10_A2:[32857,T,33640],RGBA4:[32854,T,32819],RGB9_E5:[35901,6407,35902],R8:[33330,T=36244,5121,1<<31],RG8:[33336,33320,5121,1<<31],RGB8:[36221,36248,5121,1<<31],RGBA8:[36220,36249,5121,1<<31],R16:[33332,T,5123,1<<31],RG16:[33338,33320,5123,1<<31],RGB16:[36215,36248,5123,1<<31],RGBA16:[36214,36249,5123,1<<31],R32:[33334,T,5125,1<<31],RG32:[33340,33320,5125,1<<31],RGB32:[36209,36248,5125,1<<31],RGBA32:[36208,36249,5125,1<<31],R16F:[33325,6403,5131],RG16F:[33327,33319,5131],RGB16F:[34843,6407,5131],RGBA16F:[34842,6408,5131],R16F_32F:[33325,6403,5126],RG16F_32F:[33327,33319,5126],RGB16F_32F:[34843,6407,5126],RGBA16F_32F:[34842,6408,5126],R32F:[33326,6403,5126],RG32F:[33328,33319,5126],RGB32F:[34837,6407,5126],RGBA32F:[34836,6408,5126]},$.loader=({url:t})=>(t=t.slice(0,t.lastIndexOf("/")+1),(...e)=>{if(e[0].raw){const i=[e[0][0]];for(let t=1;t<=e.length;t++)i.push(e[t],e[0][t]);const s=i.join("");return"/"==s[0]?s:t+s}return 1==e.length?"/"==e[0][0]?e[0]:t+e[0]:e.map((e=>"/"==e[0]?e:t+e))});const gr=ArrayBuffer.prototype.transfer?()=>{(ar=new Float32Array(ar.buffer.transfer(i*8))),ir=new Int32Array(ar.buffer)}:()=>{const oa=ar;(ar=new Float32Array(i*2)).set(oa,0);ir=new Int32Array(ar.buffer)};class can{t;#e;#i;#s;#r;#n;#h;#a;#u;s;get width(){return this.t.w}get height(){return this.t.h}get texture(){return this.t.c}set texture(x){let{t}=this;t.c&&x instanceof c&&((t.s&&(t.w!=x.t.w||t.h!=x.t.h)?(i&&L(),ca==c0&&g.bindFramebuffer(36009,fb),ca=null,g.framebufferRenderbuffer(36008,36128,36161,t.s),g.bindRenderbuffer(36161,fS=g.createRenderbuffer()),g.renderbufferStorage(36161,36168,x.t.w,x.t.h),g.framebufferRenderbuffer(36009,36128,36161,fS),g.blitFramebuffer(0,0,t.w,t.h,0,0,x.t.w,x.t.h,1024,9728),g.deleteRenderbuffer(t.s),t.s=fS):ca==t&&(i&&L(),ca=null)),t.c=x,t.T=x.t.T)}get hasStencil(){return this.t==c0?!!(f&1):!!this.t.s}set hasStencil(s){let{t}=this,b=t.s;t!=c0&&(s?b||(ca==t&&(i&&L(),ca=null),g.bindRenderbuffer(36161,t.s=b=g.createRenderbuffer()),t.T&&!t.c?g.renderbufferStorageMultisample(36161,t.L,36168,t.w,t.h):g.renderbufferStorage(36161,36168,t.w,t.h)):b&&(ca==t&&(i&&L(),ca=null),t.s=null,g.deleteRenderbuffer(b)))}get msaa(){return this.t.c?1:this.t.L}get textureLayer(){return this.t.c?this.t.L>>>8:0}get textureMipmap(){return this.t.c?this.t.L&255:0}set textureLayer(l=0){const{t}=this;t.c&&(ca==t&&(i&&L(),ca=null),t.L=t.L&255|l<<8)}set textureMipmap(m=0){const{t}=this;t.c&&(ca==t&&(i&&L(),ca=null),t.L=t.L&-256|m&255)}paste(d,x=0,y=0,a=0,b=0,w=0,h=0){i&&L();const{t}=this,e=d.t;e.c?g.framebufferTextureLayer(36008,36064,e.T,e.L&255,e.L>>>8):g.framebufferRenderbuffer(36008,36064,36161,e.T);ca!=t&&(t==c0?(g.bindFramebuffer(36009,null),ca=t):(ca==c0&&g.bindFramebuffer(36009,fb),(fT!=t.T||fL!=t.L)&&(t.c?g.framebufferTextureLayer(36009,36064,fT=t.T,(fL=t.L)&255,fL>>>8):(fL=t.L,g.framebufferRenderbuffer(36009,36064,36161,fT=t.T))),ca=null));g.blitFramebuffer(a,b,a+(w=w||e.w),b+(h=h||e.h),x,y,x+w,y+h,16384,9728)}constructor(t,e=1,i=0,s=0,r=1,n=0,h=0,a=290787599,u=$.Shader.DEFAULT,o=df){this.t=t,this.#e=e,this.#i=i,this.#s=s,this.#r=r,this.#n=n,this.#h=h,this.#a=a,this.#u=u,this.s=o}translate(t=0,e=0){this.#n+=t*this.#e+e*this.#s,this.#h+=t*this.#i+e*this.#r}scale(t=1,e=t){this.#e*=t,this.#i*=t,this.#s*=e,this.#r*=e}rotate(t=0){const e=cos(t),i=sin(t),s=this.#e,r=this.#i,n=this.#s,h=this.#r;this.#e=s*e-n*i,this.#i=r*e-h*i,this.#s=s*i+n*e,this.#r=r*i+h*e}transform(t,e,i,s,r,n){const h=this.#e,a=this.#i,u=this.#s,o=this.#r,l=this.#n,f=this.#h;this.#e=h*t+u*e,this.#i=a*t+o*e,this.#s=h*i+u*s,this.#r=a*i+o*s,this.#n=h*r+u*n+l,this.#h=a*r+o*n+f}skew(t=0,e=0){const i=this.#e,s=this.#i;this.#e+=this.#s*e,this.#i+=this.#r*e,this.#s+=i*t,this.#r+=s*t}multiply(t=1,e=0){const i=this.#e,s=this.#i;this.#e=i*t-this.#s*e,this.#i=s*t-this.#r*e,this.#s=i*e+this.#s*t,this.#r=s*e+this.#r*t}getTransform(){return{a:this.#e,b:this.#i,c:this.#s,d:this.#r,e:this.#n,f:this.#h}}reset(t=1,e=0,i=0,s=1,r=0,n=0){this.#e=t,this.#i=e,this.#s=i,this.#r=s,this.#n=r,this.#h=n,this.#a=290787599,this.#u=$.Shader.DEFAULT,this.s=df}box(t=0,e=0,i=1,s=i){this.#n+=t*this.#e+e*this.#s,this.#h+=t*this.#i+e*this.#r,this.#e*=i,this.#i*=i,this.#s*=s,this.#r*=s}to(t=0,e=0){return"object"==typeof t&&(e=t.y,t=t.x),{x:this.#e*t+this.#s*e+this.#n,y:this.#i*t+this.#r*e+this.#h}}from(t=0,e=0){"object"==typeof t&&(e=t.y,t=t.x);const i=this.#e,s=this.#i,r=this.#s,n=this.#r,h=i*n-s*r;return{x:(t*n-e*r+r*this.#h-n*this.#n)/h,y:(e*i-t*s+s*this.#n-i*this.#h)/h}}toDelta(t=0,e=0){return"object"==typeof t&&(e=t.y,t=t.x),{x:this.#e*t+this.#s*e,y:this.#i*t+this.#r*e}}fromDelta(t=0,e=0){"object"==typeof t&&(e=t.y,t=t.x);const i=this.#e,s=this.#i,r=this.#s,n=this.#r,h=i*n-s*r;return{x:(t*n-e*r)/h,y:(e*i-t*s)/h}}determinant(){return this.#e*this.#r-this.#i*this.#s}pixelRatio(){return sqrt(abs(this.#e*this.#r-this.#i*this.#s)*this.t.w*this.t.h)}sub(){return new can(this.t,this.#e,this.#i,this.#s,this.#r,this.#n,this.#h,this.#a,this.#u,this.s)}resetTo(t){this.#e=t.#e,this.#i=t.#i,this.#s=t.#s,this.#r=t.#r,this.#n=t.#n,this.#h=t.#h,this.#a=t.#a,this.#u=t.#u,this.s=t.s}set shader(t){this.#u="function"==typeof t?t:$.Shader.DEFAULT}get shader(){return this.#u}set mask(t){this.#a=-256&this.#a|255&t}get mask(){return 255&this.#a}set blend(t){this.#a=255&this.#a|(t||1135889)<<8}get blend(){return this.#a>>8}get geometry(){return this.s}set geometry(t){this.s=t||df}draw(...t){J(this.t,this.#a);const e=this.#u(t);ar[e]=this.#e,ar[e+1]=this.#s,ar[e+2]=this.#n,ar[e+3]=this.#i,ar[e+4]=this.#r,ar[e+5]=this.#h}drawRect(t=0,e=0,i=1,s=1,...r){J(this.t,this.#a);const n=this.#u(r);ar[n]=this.#e*i,ar[n+1]=this.#s*s,ar[n+2]=this.#n+t*this.#e+e*this.#s,ar[n+3]=this.#i*i,ar[n+4]=this.#r*s,ar[n+5]=this.#h+t*this.#i+e*this.#r}drawMat(t=1,e=0,i=0,s=1,r=0,n=0,...h){J(this.t,this.#a);const a=this.#u(h),u=this.#e,o=this.#i,l=this.#s,f=this.#r,c=this.#n,q=this.#h;ar[a]=u*t+l*e,ar[a+1]=u*i+l*s,ar[a+2]=u*r+l*n+c,ar[a+3]=o*t+f*e,ar[a+4]=o*i+f*s,ar[a+5]=o*r+f*n+q}drawv(t){J(this.t,this.#a);const e=this.#u(t);ar[e]=this.#e,ar[e+1]=this.#s,ar[e+2]=this.#n,ar[e+3]=this.#i,ar[e+4]=this.#r,ar[e+5]=this.#h}drawRectv(t=0,e=0,i=1,s=1,r){J(this.t,this.#a);const n=this.#u(r);ar[n]=this.#e*i,ar[n+1]=this.#s*s,ar[n+2]=this.#n+t*this.#e+e*this.#s,ar[n+3]=this.#i*i,ar[n+4]=this.#r*s,ar[n+5]=this.#h+t*this.#i+e*this.#r}drawMatv(t=1,e=0,i=0,s=1,r=0,n=0,h){J(this.t,this.#a);const a=this.#u(h),u=this.#e,o=this.#i,l=this.#s,f=this.#r,c=this.#n,q=this.#h;ar[a]=u*t+l*e,ar[a+1]=u*i+l*s,ar[a+2]=u*r+l*n+c,ar[a+3]=o*t+f*e,ar[a+4]=o*i+f*s,ar[a+5]=o*r+f*n+q}dup(i){if(i){const w=sh.count;if(i+w>ar.length)gr();for(let j=i-w;j<i;j++)ir[j+w]=ir[j];ar[i]=this.#e,ar[i+1]=this.#s,ar[i+2]=this.#n,ar[i+3]=this.#i,ar[i+4]=this.#r,ar[i+5]=this.#h;i+=w}}dupRect(t=0,e=0,i=1,s=1){if(i){const w=sh.count;if(i+w>ar.length)gr();for(let j=i-w;j<i;j++)ir[j+w]=ir[j];ar[i]=this.#e*i,ar[i+1]=this.#s*s,ar[i+2]=this.#n+t*this.#e+e*this.#s,ar[i+3]=this.#i*i,ar[i+4]=this.#r*s,ar[i+5]=this.#h+t*this.#i+e*this.#r;i+=w}}dupMat(t=1,e=0,i=0,s=1,r=0,n=0){if(i){const w=sh.count;if(i+w>ar.length)gr();for(let j=i-w;j<i;j++)ir[j+w]=ir[j];const u=this.#e,o=this.#i,l=this.#s,f=this.#r,c=this.#n,q=this.#h;ar[i]=u*t+l*e,ar[i+1]=u*i+l*s,ar[i+2]=u*r+l*n+c,ar[i+3]=o*t+f*e,ar[i+4]=o*i+f*s,ar[i+5]=o*r+f*n+q;i+=w}}clear(t=0,e=t,s=t,r=e){"object"==typeof t&&(r=t.w??0,s=t.z??0,e=t.y,t=t.x),i&&L(),J(this.t,this.#a),g.clearColor(t,e,s,r);const n=this.t.S=this.t.S+1&7;g.clear(n?16384:(g.stencilMask(255),17408)),g.disable(2960),pmask&=-241;fdc++}clearStencil(){i&&L(),J(this.t,this.#a);(this.t.S=this.t.S+1&7)||(g.stencilMask(255),g.clear(1024)),g.disable(2960),pmask&=-241;fdc++}}let pmask=285217039;function J(t,e){const s=t.S;let r=pmask^e;if(ca!=t){if(i&&L(),t!=c0){fA&&(fA=0,g.drawBuffers([36064]));ca==c0&&g.bindFramebuffer(36009,fb),t.T==fT&&t.L==fL||(t.c?g.framebufferTextureLayer(36009,36064,fT=t.T,(fL=t.L)&255,fL>>>8):(fL=t.L,g.framebufferRenderbuffer(36009,36064,36161,fT=t.T))),t.s!=fS&&(g.bindRenderbuffer(36161,fS=t.s),g.framebufferRenderbuffer(36009,36128,36161,fS));g.viewport(0,0,t.w,t.h);if(t.c){const e=t.c.t;e.i>=0&&(g.activeTexture(33984+e.i),g.bindTexture(35866,bd[e.i]=null),e.i=-1)};if(!ca||ca.S!=s)r|=240}else g.bindFramebuffer(36009,null),g.viewport(0,0,t.w,t.h);ca=t}if(r){if(i&&L(),15&r&&g.colorMask(1&e,2&e,4&e,8&e),240&r)if(240&e){240&pmask||g.enable(2960),g.stencilMask(1<<s),g.stencilFunc(32&e?16&e?g.NEVER:g.NOTEQUAL:16&e?g.EQUAL:g.ALWAYS,255,1<<s);const t=128&e?64&e?g.INVERT:g.REPLACE:64&e?g.ZERO:g.KEEP;g.stencilOp(t,t,t)}else 240&pmask&&g.disable(2960);1996488704&r&&g.blendEquationSeparate(32773+(e>>24&7),32773+(e>>28&7)),16776960&r&&g.blendFuncSeparate((e>>8&15)+766*!!(3584&e),(e>>16&15)+766*!!(917504&e),(e>>12&15)+766*!!(57344&e),(e>>20&15)+766*!!(14680064&e)),-2147483648&r&&(-2147483648&e?g.enable(32926):g.disable(32926)),pmask=e}}function L(t=S){g.bufferData(34962,ir.subarray(0,i),35040);const{type:e,start:s,length:r}=sp;fd+=i,i/=sh.count,fdc++,fs+=i,g.drawArraysInstanced(e,s,r,i),i=0,Q=t;if(pf.length){tl??=pf[0];for(let f of pf)f.s=g.fenceSync(37143,0),hd=hd?hd.n=f:f;pf.length=0}}$.Blend=T=(t=17,e=17,i=0,s=!1)=>t|i<<8|e<<16|s<<23,Object.assign(T,{REPLACE:1114129,DEFAULT:1135889,ADD:1118465,MULTIPLY:1122816,SUBTRACT:5574913,REVERSE_SUBTRACT:7737601,MIN:2232593,MAX:3346705,BEHIND:1118583,INVERT:1127321});const fb=g.createFramebuffer(),buf=g.createBuffer(),Bd=[],mA=g.getParameter(36063)||4,mS=g.getParameter(36183),H=min(32,g.getParameter(34930)),bd=[];let sh=null,ca={T:g.canvas,c:null,L:f&16?mS:1,S:0,s:null,w:0,h:0},c0=ca,fT=null,fS=null,fL=0,F=0,M=0,fA=0;g.bindFramebuffer(36008,g.createFramebuffer());g.bindBuffer(34962,buf);for(let t=H<<1;t-->0;)bd.push(null);for(let t=mA;t-->0;)Bd.push(null);T=$.Geometry=(t,e)=>{if(e.length&3)throw"points.length is not a multiple of 4";e instanceof Float32Array||(T=new Float32Array(e.length),T.set(e,0),e=T);const i=g.createBuffer();return g.bindBuffer(34962,i),g.bufferData(34962,e,35044),i.type=t,g.bindBuffer(34962,buf),{type:t,b:i,start:0,length:e.length>>2,sub}};function sub(e=0,i=this.length-e,s=this.type){return{type:s,b:this.b,start:this.start+e,length:i,sub}};let Q=0,sp=T.DEFAULT=T($.TRIANGLE_STRIP,[0,0,0,0,0,1,0,1,1,0,1,0,1,1,1,1]),S=0,w,tl=null,hd=null,iv=0;const df=sp,pf=[],iF=()=>{while(tl&&g.getSyncParameter(tl.s,37140)==37145)g.deleteSync(tl.s),tl(),tl=tl.n;tl||(hd=null,clearInterval(iv),iv=0)},treeIf=(t=0,e=H,i=0)=>{if(e<=t+1)return w(t);const s=t+(1<<31-clz32(e-t-1));return`if(u<${s+i}){${treeIf(t,s,i)}}else{${treeIf(s,e,i)}}`},nm=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"];T=$.Shader=(P,Y,de,U,ud,Z=4,frat=.5)=>{const E1=["(function({"],G=["",""],A=["#version 300 es\nprecision mediump float;precision highp int;layout(location=0)in vec4 _pos;out vec2 uv,xy;layout(location=1)in mat2x3 m;",""],D=["void main(){gl_PointSize=1.0;uv=_pos.zw;gl_Position=vec4((xy=vec3(_pos.xy,1.)*m)*2.-1.,0.,1.);"],C=["#version 300 es\nprecision mediump float;precision highp int;in vec2 uv,xy;out "+(0==Z?"highp vec4 color;":16==Z||32==Z?"uvec4 color;":"lowp vec4 color;"),""];let j=6,o=0,K=0,I=0;const tp=[3,3],tc=[];let id=0;Y="number"==typeof Y?[Y]:Y||[],U="number"==typeof U?[U]:U||[],de=null!=de?Array.isArray(de)?de:[de]:[],ud=null!=ud?Array.isArray(ud)?ud:[ud]:[];for(const t of Y){let e=1+(3&t),i=nm[3&t|t>>4<<2];const s=4==t||8==t||12==t;de[id]??=4==t?v4z:1==e?0:2==e?v2z:3==e?v3z:v4z,E1.push(id+":a"+j+"=de["+id+"],");const r=t>15?(o|=1,"ir[j+"):"ar[j+";if(20!=t&&24!=t&&28!=t||(i="int",o|=1<<(t>>2)-3,K++,tc.push(`a${j}=(c.L(a${j+(24==t?".t,-1":".t,0")})+1||(i&&L(b^Q),c.L(a${j+(24==t?".t,-1":".t,0")})+1))-1`)),12!=t&&28!=t||(o|=2),8!=t&&24!=t||(I++,K--),s){tc.push(`let a${j+1}=${4==t?`-1;if(a${j}.t&&(a${j+1}=c.L(a${j}.t,0))==-1)`:`c.L(a${j+(8==t?".t,-1":".t,0")});if(a${j+1}==-1)`}{i&&L(b^Q);a${j+1}=c.L(a${j+(8==t?".t,-1":".t,0")})}`),K++;const i=`arg${id}raw`;for(A.push(`layout(location=${tp.length+1})in int i${j};layout(location=${tp.length+2})in vec4 i${j+1};centroid out vec4 ${i};`),D.push(4!=t?`${i}=vec4(i${j+1}.xy+uv*i${j+1}.zw,i${j}>>8,i${j}&255);`:`if(i${j}==-1){${i}=i${j+1};${i}.w=max(-15856.,${i}.w);}else{${i}=vec4(i${j+1}.xy+uv*i${j+1}.zw,i${j}>>8,(i${j}&255)==0?-15872:((i${j}&255)<<4)-16384);}`),C.push(`centroid in vec4 ${i};${4==t?"lowp ":8==t?"u":"highp "}vec4 arg${id}(){`+(4==t?`if(${i}.w>-15872.)return ${i};return getColor(int(${i}.w)>>4&31,${i}.xyz);}`:8==t?`return uGetColor(int(${i}.w),${i}.xyz);}`:`return fGetColor(int(${i}.w),${i}.xyz);}`)),o|=1<<1+(t>>2),tp.push(17,4),G.push("ir[j+"+j+"]=a"+(j+1)+"|a"+j+".l<<8"),e=0;++e<3;)G.push(r+(j+e)+"]=a"+j+"."+" xy"[e]);G.push(`if(a${j+1}>=0)${r+(j+3)}]=a${j}.w,${r+(j+4)}]=a${j}.h;else ${r+(j+3)}]=a${j}.z,${r+(j+4)}]=a${j}.w`),e=5}else if(A.push("layout(location="+(tp.length+1)+")in "+i+" i"+j+";flat out "+i+" arg"+id+";"),D.push("arg"+id+"=i"+j+";"),C.push("flat in "+i+" arg"+id+";"),tp.push(e|48&t),1==e)G.push(r+j+"]=a"+j);else for(let t=-1;++t<e;)G.push(r+(j+t)+"]=a"+j+"."+"xyzw"[t]);j+=e,id++}id=0;let j2=0,j3=0;const fn2Params=[],E=["fd+=j2;i&&L(0);if(sh!=s){F=K;M=R;g.useProgram((sh=s).p);g.bindVertexArray(s.v)}"],F1=[],N=[],O=[];for(const t of U){let e=1+(3&t),i=nm[3&t|t>>4<<2];if(ud[id]??=4==t?v4z:1==e?0:2==e?v2z:3==e?v3z:v4z,fn2Params.push("a"+j2+"=ud["+id+"]"),12!=t&&28!=t||(o|=2),8!=t&&24!=t||(I++,K--),20==t||24==t||28==t)o|=1<<(t>>2)-3,K++,F1.push(`g.uniform1i(O[${j3}],N[${N.length}]?c.L(N[${N.length}]${24==t?",-1":",0"}):${24==t?H:0})`),C.push("uniform int uni"+id+";"),E.push(`N[${N.length}]=a${j2}.t`),N.push(null);else if(4==t||8==t||12==t){F1.push(`g.uniform1i((O[${j3++}],N[${N.length}]?c.L(N[${N.length}]${8==t?",-1":",0"}):${8==t?H:0})|N[${N.length+1}])`),N.push(null,0),K++;const e=`uni${id}raw`;A.push(`uniform int u${j2};uniform vec4 u${j2+1};centroid out vec4 ${e};`),D.push(4!=t?`${e}=vec4(u${j2+1}.xy+uv*u${j2+1}.zw,u${j2}>>8,u${j2}&255);`:`if(u${j2}==-1){${e}=u${j2+1};${e}.w=max(-15856.,${e}.w);}else{${e}=vec4(u${j2+1}.xy+uv*u${j2+1}.zw,u${j2}>>8,(u${j2}&255)==0?-15872:((u${j2}&255)<<4)-16384);}`),C.push(`centroid in vec4 ${e};${4==t?"lowp ":8==t?"u":"highp "}vec4 uni${id}(){`+(4==t?`if(${e}.w>-15872.)return ${e};return getColor(int(${e}.w)>>4&31,${e}.xyz);}`:8==t?`return uGetColor(int(${e}.w),${e}.xyz);}`:`return fGetColor(int(${e}.w),${e}.xyz);}`)),o|=1<<1+(t>>2),E.push(`N[${N.length-2}]=a${j2}.t;N[${N.length-1}]=a${j2}.l<<8;g.uniform4f(O[${j3}],a${j2}.x,a${j2}.y,a${j2}.w,a${j2}.h)`)}else{C.push("uniform "+i+" uni"+id+";");let s=`g.uniform${e+(t<16?"f":t<32?"i":"ui")}(O[${j3}]`;if(1==e)s+=",a"+j2;else for(let t=-1;++t<e;)s+=",a"+j2+"."+"xyzw"[t];E.push(s+")")}j2+=e,id++,j3++}if(K+I>16)throw"Shaders cannot use more than 16 textures/colors";K=K?I?K+round(frat*(H-K-I)):H:0,I=I&&H-K,w=t=>"return texture(GL_f["+t+"],p);";let T=null;C[1]=(20&o?"uniform "+(2&o?"highp":"lowp")+" sampler2DArray GL_f["+K+"];":"")+(8&o?"uniform highp usampler2DArray GL_i["+I+"];":"")+(4&o?`lowp vec4 getColor(int u,vec3 p){${T=treeIf(0,K)}}`:"")+(16&o?`highp vec4 fGetColor(int u,vec3 p){${T||treeIf(0,K)}}`:"")+(8&o?`uvec4 uGetColor(int u,vec3 p){${w=t=>"return texture(GL_i["+t+"],p);",treeIf(0,H-K,H)}}`:""),C[1]+=(4&o?`lowp vec4 getPixel(int u,ivec3 p,int l){${w=t=>"return texelFetch(GL_f["+t+"],p,l);",T=treeIf(0,K)}}`:"")+(16&o?`highp vec4 fGetPixel(int u,ivec3 p,int l){${T||treeIf(0,K)}}`:"")+(8&o?`uvec4 uGetPixel(int u,ivec3 p,int l){${w=t=>"return texelFetch(GL_i["+t+"],p,l);",treeIf(0,H-K,H)}}`:"")+(28&o?`ivec3 getSize(int u,int l){${w=t=>"return textureSize(GL_"+(t<K?"f["+t:"i["+(t-K))+"],l);",T=treeIf(0,H)}}`:""),G[0]="}){if(sh!=s){i&&L(0);F=K;M=R;g.useProgram((sh=s).p);g.bindVertexArray(s.v);B()}if(sp!=this.s){i&&L();sp=this.s}if(s.g!=this.s.b){g.bindBuffer(34962,s.g=this.s.b);g.vertexAttribPointer(0,4,5126,0,0,0);g.bindBuffer(34962,buf)}const b=Q^S;"+tc.join(";")+";const j=i;if((i=j+"+j+")>ar.length)"+(ArrayBuffer.prototype.transfer?"ar=new Float32Array(ar.buffer.transfer(i*8)),ir=new Int32Array(ar.buffer)":"{const oa=ar;(ar=new Float32Array(i*2)).set(oa,0);ir=new Int32Array(ar.buffer)}"),G.push("return j})");const s=eval(E1.join("")+G.join(";")),p=s.p=g.createProgram();s.uniforms=eval(`(function(${fn2Params}){${E.join(";")};B()})`);const B=eval(`(function(){${F1.join(";")};S=Q})`),R=32-K&&-1>>>K;const v=g.createShader(35633),f=g.createShader(35632);for(D.push("}"),g.shaderSource(v,A.join("")+D.join("")),g.compileShader(v),g.shaderSource(f,P=C.join("")+"\n"+P),g.compileShader(f),g.attachShader(p,v),g.attachShader(p,f),(T=g.getShaderInfoLog(f))&&console.warn("GLSL Error:\n"+T),g.linkProgram(p),g.useProgram(p);j3--;)O.push(g.getUniformLocation(p,"uni"+O.length));for(let t=0;t<H;t++)g.uniform1i(g.getUniformLocation(p,t<K?"GL_f["+t+"]":"GL_i["+(t-K)+"]"),t>=K?H+t-K:t);s.count=j,g.bindVertexArray(s.v=g.createVertexArray());let i1=1,i2=0;g.bindBuffer(34962,s.g=df.b),g.enableVertexAttribArray(0),g.vertexAttribPointer(0,4,5126,0,0,0),g.bindBuffer(34962,buf);for(const t of tp)g.enableVertexAttribArray(i1),t>>4?g.vertexAttribIPointer(i1,15&t,(t>31)+5124,j<<2,i2):g.vertexAttribPointer(i1,15&t,5126,0,j<<2,i2),g.vertexAttribDivisor(i1++,1),i2+=(15&t)<<2;return sh&&(g.useProgram(sh.p),g.bindVertexArray(sh.v)),s};let fdc=0,fs=0,fd=0;return T.DEFAULT=sh=T("void main(){color=arg0()*arg1;}",[4,3],[void 0,$.vec4.one]),T.UINT=T("void main(){color=arg0();}",8,void 0,void 0,void 0,32),T.BLACK=T("void main(){color=vec4(0,0,0,1);}"),g.useProgram(sh.p),g.bindVertexArray(sh.v),$.flush=()=>{i&&L();pU?(pU=!1):pL&&(g.bindBuffer(35051,null),g.deleteBuffer(pL),pL=null,pU=-1);for(let i=H;i-->0;){const t=bd[i];t&&(t.i=-1,g.activeTexture(33984+i),g.bindTexture(35866,bd[i]=null))}},C=$.ctx=new can(ca),$.setSize=(w=0,h=0)=>{C.t.w=g.canvas.width=w;C.t.h=g.canvas.height=h,ca==c0&&g.viewport(0,0,w,h)},$.wait=()=>new Promise(r=>{r.s=i?(pf.push(r),null):(tl??=r,hd=hd?hd.n=r:r,g.fenceSync(37143,0));iv=iv||setInterval(iF)}),$.loop=F=>{if("t"in $)return $;$.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=performance.now()*.001,$.dt=0,$.timeToFrame=0,$.glLost??=null;let e=0;return requestAnimationFrame(function t(){if(g.isContextLost())return $.glLost?.(),$.glLost=tl=hd=null;requestAnimationFrame(t),i&&L,g.bindFramebuffer(36009,null),ca=c0,g.viewport(0,0,ca.w,ca.h),dt=max(.001,min(-($.t-($.t=performance.now()*.001)),.5)),C.reset();try{F()}finally{$.flush();timeToFrame=performance.now()*.001-$.t;fdc||$.ctx.clear();$.frameDrawCalls=fdc,$.frameSprites=fs,$.frameData=4*fd+24*fdc,fdc=fs=fd=0}}),$},$},{bitmapOpts:q,STENCIL:1,ALPHA_CHANNEL:2,PREMULTIPLIED_ALPHA:4,AUTO_CLEAR_BUFFER:8,MSAA:16})}