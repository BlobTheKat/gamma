{Math.randint??=()=>4294967296*Math.random()|0,Math.PI2??=2*Math.PI;const $=globalThis;if(!("setImmediate"in $)){let t=0,e=new MessageChannel,i=new Map;e.port1.onmessage=({data:t},e=i.get(t))=>i.delete(t)&&e(),e=e.port2,$.setImmediate=(s,...r)=>(i.set(++t,r.length?s.bind(void 0,...r):s),e.postMessage(t),t),$.clearImmediate=t=>i.delete(t)}"sin"in $||Object.defineProperties($,Object.getOwnPropertyDescriptors(Math));const q={imageOrientation:"flipY",premultiplyAlpha:"none"},R=(t,e,i)=>"string"==typeof t?fetch(t).then((t=>t.blob())).then((t=>createImageBitmap(t,q))).then(e,i):t instanceof Blob?createImageBitmap(t,q).then(e,i):t instanceof ImageBitmap?e(t):(i??Promise.reject)(new TypeError('Invalid src'));($.Gamma=(T=document.createElement('canvas'),$={})=>{const g=$.gl=($.canvas=T).getContext("webgl2",{preserveDrawingBuffer:!1,antialias:!1,depth:!1,premultipliedAlpha:!0,stencil:!0});g.pixelStorei(37440,1),g.stencilMask(1),g.clearStencil(0),g.disable(2929),g.enable(3042),g.disable(3024),g.pixelStorei(3317,1),g.pixelStorei(3333,1);let z=1;class c{get format(){return this.t.f}get width(){return this.t.w}get height(){return this.t.h}get layers(){return this.t.d}get subWidth(){return this.t.w*this.w}get subHeight(){return this.t.h*this.h}get aspectRatio(){return this.t.w*this.w/(this.t.h*this.h)}constructor(t,e=0,i=0,s=1,r=1,n=0){this.t=t,this.x=e,this.y=i,this.w=s,this.h=r,this.l=n}get loaded(){return!this.t.S}get then(){return this.t.S?this.#t:null}load(){this.t.T||c.load(this.t)}sub(t=0,e=0,i=1,s=1,r=this.l){return new c(this.t,this.x+t*this.w,this.y+e*this.h,this.w*i,this.h*s,r)}sup(t=0,e=0,i=1,s=1){const r=this.w/i,n=this.h/s;return new c(this.t,this.x-t*r,this.y-e*n,r,n)}crop(t=0,e=0,i=1,s=1,r=this.l){const{t:n,x:h,y:a,h:u}=this;if(!n.S)return new c(n,h+t/n.w,a+u-(e+s)/n.h,i/n.w,s/n.h,r);const o=new c(n,0,0,0,0,r);return n.T||c.load(n),n.S.push((r=>{r.x=h+t/n.w,r.y=a+u-(e+s)/n.h,r.w=i/n.w,r.h=s/n.h}),void 0,o),o}layer(t=this.l){return new c(this.t,this.x,this.y,this.w,this.h,t)}#t(t,e){"function"!=typeof t&&(t=Function.prototype),this.t.S?(this.t.T||c.load(this.t),this.t.S.push(t,e,this)):t(this)}static load(t){let e=t.S,i=0;t.S=[];let s=0,r=0;t.T=g.createTexture();const n=n=>{i=-1,c.setOptions(t),g.texStorage3D(35866,t.m||1,t.f[0],t.w=s=1,t.h=r=1,t.d=e.length),z||(g.pixelStorei(37440,1),g.pixelStorei(37441,z=1)),t.m&&g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null);const l=t.S;t.S=null;for(let e=1;e<l.length;e+=3)l[e]?.(l[e+1])};for(let h=0;h<e.length;h++)R(e[h],(a=>{if(i){if(s!=a.width||r!=a.height)return n()}else s=a.width,r=a.height;if(e[h]=a,!(++i<e.length)){c.setOptions(t),g.texStorage3D(35866,t.m||1,t.f[0],t.w=s,t.h=r,t.d=i),z||(g.pixelStorei(37440,1),g.pixelStorei(37441,z=1));for(let n=0;n<i;n++)g.texSubImage3D(35866,0,0,0,n,s,r,1,t.f[1],t.f[2],e[n]);t.m&&g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null);const l=t.S;t.S=null;for(let e=0;e<l.length;e+=3)l[e](l[e+2])}}),n)}paste(t,e=0,s=0,r=0,n=0,h=0,a=0,u=0,o=0,l=0){const{t:f}=this;if(f.S)return this;if(!(t instanceof c))return R(t,(t=>(c.fakeBind(f),z||(g.pixelStorei(37440,1),g.pixelStorei(37441,z=1)),g.texSubImage3D(35866,0,e,s,r,t.width,t.height,1,f.f[1],f.f[2],t),f.i<0&&g.bindTexture(35866,null),this)));const{t:b}=t;if(!b.d)return t.#t((()=>this.paste(t,e,s,r,n,h,a,u,o,l))),this;if(b.S)return this;if(f.T==b.T)return console.warn("cannot copy from texture to itself"),this;for(c.fakeBind(f),ca.c||g.bindFramebuffer(36160,fb),J&&g.framebufferRenderbuffer(36160,36128,36161,null),u=u||b.w,o=o||b.h,l=l||b.d;l--;)g.framebufferTextureLayer(36160,36064,b.T,0,a++),g.copyTexSubImage3D(35866,0,e,s,r++,n,h,u,o);return f.i<0&&g.bindTexture(35866,null),ca.c&&i?(g.framebufferTextureLayer(36160,36064,fbTex,0,fbLayer),J&&g.framebufferRenderbuffer(36160,36128,36161,J)):(g.bindFramebuffer(36160,null),ca=ctx.t,fbLayer=a-1,fbTex=b.T,J=null),this}pasteData(t,e=0,i=0,s=0,r=0,n=0,h=0){const{t:a}=this;if(a.S)return null;r=r||a.w,n=n||a.h,h=h||a.d,c.fakeBind(a),z&&(g.pixelStorei(37440,0),g.pixelStorei(37441,z=0)),g.texSubImage3D(35866,0,e,i,s,r,n,h,a.f[1],a.f[2],t),fd+=.25*t.byteLength,a.i<0&&g.bindTexture(35866,null)}readData(t=0,e=0,s=0,r=0,n=0,h=0,a=null){const{t:u}=this;if(u.S)return null;r=r||u.w,n=n||u.h,h=h||u.d,ca.c||g.bindFramebuffer(36160,fb),J&&g.framebufferRenderbuffer(36160,36128,36161,null);let o=u.f[0],l=(o==33323||o==33338||o==33340||o==33327||o==33328||o==33336?2:o==33321||o==33330||o==33332||o==33334||o==33325||o==33326?1:4)*r*n;o=l==1?6403:l==2?33319:6408;for(a&&a.length==l||(a=5121==u.f[2]?new Uint8Array(l*h):5126==u.f[2]?new Float32Array(l*h):5125==u.f[2]||35899==u.f[2]||33640==u.f[2]||35902==u.f[2]?new Uint32Array(l*h):new Uint16Array(l*h));h--;)g.framebufferTextureLayer(36160,36064,u.T,0,s),g.readPixels(t,e,r,n,o==1?6403:o==2?33319:6408,u.f[2],a.subarray(l*s,l*++s));return u.i<0&&g.bindTexture(35866,null),ca.c&&i?(g.framebufferTextureLayer(36160,36064,fbTex,0,fbLayer),J&&g.framebufferRenderbuffer(36160,36128,36161,J)):(g.bindFramebuffer(36160,null),ca=ctx.t,fbLayer=s-1,fbTex=u.T,J=null),a}delete(){this.t.T&&(g.deleteTexture(this.t.T),this.t.T=null,this.t.i>=0&&(bound[this.t.i]=null,this.t.i=-1),this.t.d=this.t.w=this.t.h=0)}static L(t,e=0){if(t.f[3]>>31!=e)return-2;if(t.i>=0){const i=-2147483648>>>t.i-(H-F&e);if(!(i&(e^M)))return Q|=i,t.i;bound[t.i]=null,t.i=-1}t.T||c.load(t);const i=Math.clz32(~(Q|e^M));if(i>=H)return-1;Q|=-2147483648>>>i;const s=bound[e=e?H+i-F:i];return s&&(s.i=-1),g.activeTexture(33984+e),g.bindTexture(35866,(bound[e]=t).T),t.i=e}static fakeBind(t){if(t.i>=0)g.activeTexture(33984+t.i);else{const e=H-1+(F==H&&H);bound[e]&&(bound[e].t.i=-1),g.activeTexture(33984+e),g.bindTexture(35866,t.T)}}get options(){return this.t.o}static setOptions(t){c.fakeBind(t);const{o:e}=t;t.f[3]>>31?(g.texParameterf(35866,10240,9728),g.texParameterf(35866,10241,9728)):(g.texParameterf(35866,10240,9728+(1&e)),g.texParameterf(35866,10241,t.m?9984+(e>>1&3):9728+(e>>1&1))),g.texParameterf(35866,10242,8&e?10497:16&e?33648:33071),g.texParameterf(35866,10243,32&e?10497:64&e?33648:33071)}set options(t){const{t:e}=this;e.o=t,e.S||(c.fakeBind(e),e.f[3]>>31?(g.texParameterf(35866,10240,9728),g.texParameterf(35866,10241,9728)):(g.texParameterf(35866,10240,9728+(1&t)),g.texParameterf(35866,10241,e.m?9984+(t>>1&3):9728+(t>>1&1))),g.texParameterf(35866,10242,8&t?10497:16&t?33648:33071),g.texParameterf(35866,10243,32&t?10497:64&t?33648:33071),e.i<0&&g.bindTexture(35866,null))}drawable(t=this.l,e=!1){const{t:i}=this;if(i.S)return null;let s=null;return e&&(g.bindRenderbuffer(36161,s=g.createRenderbuffer()),g.renderbufferStorage(36161,36168,i.w,i.h)),new can({T:i.T,c:this,layer:t,stencil:0,stencilBuf:s,w:i.w,h:i.h})}genMipmaps(){const{t:t}=this;t.m&&(c.fakeBind(t),g.generateMipmap(35866),t.i<0&&g.bindTexture(35866,null))}}let arr=new Float32Array(16),iarr=new Int32Array(arr.buffer),i=0;$.Texture=(t=0,e=0,i=0,s=0,r=Formats.RGBA,n=0)=>{const h={T:g.createTexture(),i:-1,o:s,S:null,f:r,w:t,h:e,d:+i||1,m:n},a=new c(h);return c.setOptions(h),t&&e?g.texStorage3D(35866,(h.m=n)||1,h.f[0],h.w=t,h.h=e,h.d=+i||1):g.texStorage3D(35866,(h.m=n)||1,h.f[0],h.w=1,h.h=1,h.d=1),g.bindTexture(35866,null),a},$.Img=(t,e=0,i=Formats.RGBA,s=0)=>new c({T:null,i:-1,f:i,o:e,S:t?Array.isArray(t)?t:[t]:[],w:0,h:0,d:0,m:s}),Object.assign($,{UPSCALE_SMOOTH:1,DOWNSCALE_SMOOTH:2,MIPMAP_SMOOTH:4,SMOOTH:7,REPEAT_X:8,REPEAT_MIRRORED_X:16,REPEAT_Y:32,REPEAT_MIRRORED_Y:64,REPEAT:40,REPEAT_MIRRORED:80,R:1,G:2,B:4,A:8,RGB:7,RGBA:15,IF_SET:16,IF_UNSET:32,NO_DRAW:48,UNSET:64,SET:128,FLIP:192,ONE:17,ZERO:0,RGB_ONE:1,A_ONE:16,SRC:34,RGB_SRC:2,ONE_MINUS_SRC:51,RGB_ONE_MINUS_SRC:3,SRC_ALPHA:68,RGB_SRC_ALPHA:4,A_SRC:64,ONE_MINUS_SRC_ALPHA:85,RGB_ONE_MINUS_SRC_ALPHA:5,A_ONE_MINUS_SRC:80,DST:136,RGB_DST:8,ONE_MINUS_DST:153,RGB_ONE_MINUS_DST:9,DST_ALPHA:102,RGB_DST_ALPHA:6,A_DST:96,ONE_MINUS_DST_ALPHA:119,RGB_ONE_MINUS_DST_ALPHA:7,A_ONE_MINUS_DST:112,SRC_ALPHA_SATURATE:170,RGB_SRC_ALPHA_SATURATE:10,ADD:17,RGB_ADD:1,A_ADD:16,SUBTRACT:85,RGB_SUBTRACT:5,A_SUBTRACT:80,REVERSE_SUBTRACT:102,RGB_REVERSE_SUBTRACT:6,A_REVERSE_SUBTRACT:96,MIN:34,RGB_MIN:2,A_MIN:32,MAX:51,RGB_MAX:3,A_MAX:48,FLOAT:0,VEC2:1,VEC3:2,VEC4:3,INT:16,IVEC2:17,IVEC3:18,IVEC4:19,UINT:32,UVEC2:33,UVEC3:34,UVEC4:35,TEXTURE:20,UTEXTURE:24,FTEXTURE:28,COLOR:4,UCOLOR:8,FCOLOR:12,FIXED:4,_:void 0,TRIANGLE_STRIP:5,TRIANGLES:4,TRIANGLE_FAN:6,LINE_LOOP:2,LINE_STRIP:3,LINES:1,POINTS:0});const V=class{constructor(t,e){this.x=t,this.y=e}copy(){return new V(this.x,this.y)}plus(t=0){return"number"==typeof t?new V(this.x+t,this.y+t):new V(this.x+t.x,this.y+t.y)}minus(t=0){return"number"==typeof t?new V(this.x-t,this.y-t):new V(this.x-t.x,this.y-t.y)}neg(){return new V(-this.x,-this.y)}recip(){return new V(1/this.x,1/this.y)}times(t=1){return"number"==typeof t?new V(this.x*t,this.y*t):new V(this.x*t.x,this.y*t.y)}div(t=1){return"number"==typeof t?new V(this.x/t,this.y/t):new V(this.x/t.x,this.y/t.y)}pow(t=1){return"number"==typeof t?new V(this.x**t,this.y**t):new V(this.x**t.x,this.y**t.y)}set(t=0){"number"==typeof t?this.x=this.y=t:(this.x=t.x,this.y=t.y)}map(t){return new V(t(this.x),t(this.y))}eq(t){return"number"==typeof t?this.x==t&&this.y==t:this.x==t.x&&this.y==t.y}length(){return hypot(this.x,this.y)}get yx(){return V(this.y,this.x)}},W=class{constructor(t,e,i){this.x=t,this.y=e,this.z=i}copy(){return new W(this.x,this.y,this.z)}plus(t=0){return"number"==typeof t?new W(this.x+t,this.y+t,this.z+t):new W(this.x+t.x,this.y+t.y,this.z+t.z)}minus(t=0){return"number"==typeof t?new W(this.x-t,this.y-t,this.z-t):new W(this.x-t.x,this.y-t.y,this.z-t.z)}neg(){return new W(-this.x,-this.y,-this.z)}recip(){return new W(1/this.x,1/this.y,1/this.z)}times(t=1){return"number"==typeof t?new W(this.x*t,this.y*t,this.z*t):new W(this.x*t.x,this.y*t.y,this.z*t.z)}div(t=1){return"number"==typeof t?new W(this.x/t,this.y/t,this.z/t):new W(this.x/t.x,this.y/t.y,this.z/t.z)}pow(t=1){return"number"==typeof t?new W(this.x**t,this.y**t,this.z**t):new W(this.x**t.x,this.y**t.y,this.z**t.z)}set(t=0){"number"==typeof t?this.x=this.y=this.z=t:(this.x=t.x,this.y=t.y,this.z=t.z)}map(t){return new W(t(this.x),t(this.y),t(this.z))}eq(t){return"number"==typeof t?this.x==t&&this.y==t&&this.z==t:this.x==t.x&&this.y==t.y&&this.z==t.z}length(){return hypot(this.x,this.y,this.z)}get xy(){return new V(this.x,this.y)}get xz(){return new V(this.x,this.z)}get yz(){return new V(this.y,this.z)}get zyx(){return new W(this.z,this.y,this.x)}},X=class{constructor(t,e,i,s){this.x=t,this.y=e,this.z=i,this.w=s}copy(){return new X(this.x,this.y,this.z,this.w)}plus(t=0){return"number"==typeof t?new X(this.x+t,this.y+t,this.z+t,this.w+t):new X(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}minus(t=0){return"number"==typeof t?new X(this.x-t,this.y-t,this.z-t,this.w-t):new X(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}neg(){return new X(-this.x,-this.y,-this.z,-this.w)}recip(){return new X(1/this.x,1/this.y,1/this.z,1/this.w)}times(t=1){return"number"==typeof t?new X(this.x*t,this.y*t,this.z*t,this.w*t):new X(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)}div(t=1){return"number"==typeof t?new X(this.x/t,this.y/t,this.z/t,this.w/t):new X(this.x/t.x,this.y/t.y,this.z/t.z,this.w/t.w)}pow(t=1){return"number"==typeof t?new X(this.x**t,this.y**t,this.z**t,this.w**t):new X(this.x**t.x,this.y**t.y,this.z**t.z,this.w**t.w)}set(t=0){"number"==typeof t?this.x=this.y=this.z=this.w=t:(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w)}map(t){return new X(t(this.x),t(this.y),t(this.z),t(this.w))}eq(t){return"number"==typeof t?this.x==t&&this.y==t&&this.z==t&&this.w==t:this.x==t.x&&this.y==t.y&&this.z==t.z&&this.w==t.w}length(){return hypot(this.x,this.y,this.z,this.w)}get xy(){return new V(this.x,this.y)}get xz(){return new V(this.x,this.z)}get xw(){return new V(this.x,this.w)}get yz(){return new V(this.y,this.z)}get yw(){return new V(this.y,this.w)}get zw(){return new V(this.z,this.w)}get xyz(){return new W(this.x,this.y,this.z)}get xyw(){return new W(this.x,this.y,this.w)}get xzw(){return new W(this.x,this.z,this.w)}get yzw(){return new W(this.y,this.z,this.w)}get wzyx(){return new X(this.w,this.z,this.y,this.x)}};T=$.vec2=(t=0,e=t)=>new V(t,e),T.one=T(1);const v2z=T.zero=T(0);T=$.vec3=(t=0,e=t,i=t)=>new W(t,e,i),T.one=T(1);const v3z=T.zero=T(0);T=$.vec4=(t=0,e=t,i=t,s=t)=>new X(t,e,i,s),T.one=T(1);const v4z=T.zero=T(0);$.Formats={LUM:[6409,6409,5121],A:[6406,6406,5121],LUM_A:[6410,6410,5121],R:[33321,6403,5121],RG:[33323,33319,5121],RGB:[32849,6407,5121],RGBA:[32856,T=6408,5121],RGB565:[36194,6407,33635],R11F_G11F_B10F:[35898,6407,35899],RGB5_A1:[32855,T,32820],RGB10_A2:[32857,T,33640],RGBA4:[32854,T,32819],RGB9_E5:[35901,6407,35902],R8:[33330,T=36244,5121,1<<31],RG8:[33336,33320,5121,1<<31],RGB8:[36221,36248,5121,1<<31],RGBA8:[36220,36249,5121,1<<31],R16:[33332,T,5123,1<<31],RG16:[33338,33320,5123,1<<31],RGB16:[36215,36248,5123,1<<31],RGBA16:[36214,36249,5123,1<<31],R32:[33334,T,5125,1<<31],RG32:[33340,33320,5125,1<<31],RGB32:[36209,36248,5125,1<<31],RGBA32:[36208,36249,5125,1<<31],R16F:[33325,6403,5131],RG16F:[33327,33319,5131],RGB16F:[34843,6407,5131],RGBA16F:[34842,6408,5131],R16F_32F:[33325,6403,5126],RG16F_32F:[33327,33319,5126],RGB16F_32F:[34843,6407,5126],RGBA16F_32F:[34842,6408,5126],R32F:[33326,6403,5126],RG32F:[33328,33319,5126],RGB32F:[34837,6407,5126],RGBA32F:[34836,6408,5126]},$.loader=({url:t})=>(t=t.slice(0,t.lastIndexOf("/")+1),(...e)=>{if(e[0].raw){const i=[e[0][0]];for(let t=1;t<=e.length;t++)i.push(e[t],e[0][t]);const s=i.join("");return"/"==s[0]?s:t+s}return 1==e.length?"/"==e[0][0]?e[0]:t+e[0]:e.map((e=>"/"==e[0]?e:t+e))});const gr=new Function(ArrayBuffer.prototype.transfer?"(arr=new Float32Array(arr.buffer.transfer(i*8))),iarr=new Int32Array(arr.buffer)":"{const oa=arr;(arr=new Float32Array(i*2)).set(oa,0);iarr=new Int32Array(arr.buffer)}");class can{t;#e;#i;#s;#r;#n;#h;#a;#u;s;get width(){return this.t.w}get height(){return this.t.h}get texture(){return this.t.c}constructor(t,e=1,i=0,s=0,r=1,n=0,h=0,a=290787599,u=$.Shader.DEFAULT,o=df){this.t=t,this.#e=e,this.#i=i,this.#s=s,this.#r=r,this.#n=n,this.#h=h,this.#a=a,this.#u=u,this.s=o}translate(t=0,e=0){this.#n+=t*this.#e+e*this.#s,this.#h+=t*this.#i+e*this.#r}scale(t=1,e=t){this.#e*=t,this.#i*=t,this.#s*=e,this.#r*=e}rotate(t=0){const e=Math.cos(t),i=Math.sin(t),s=this.#e,r=this.#i,n=this.#s,h=this.#r;this.#e=s*e-n*i,this.#i=r*e-h*i,this.#s=s*i+n*e,this.#r=r*i+h*e}transform(t,e,i,s,r,n){const h=this.#e,a=this.#i,u=this.#s,o=this.#r,l=this.#n,f=this.#h;this.#e=h*t+u*e,this.#i=a*t+o*e,this.#s=h*i+u*s,this.#r=a*i+o*s,this.#n=h*r+u*n+l,this.#h=a*r+o*n+f}skew(t=0,e=0){const i=this.#e,s=this.#i;this.#e+=this.#s*e,this.#i+=this.#r*e,this.#s+=i*t,this.#r+=s*t}multiply(t=1,e=0){const i=this.#e,s=this.#i;this.#e=i*t-this.#s*e,this.#i=s*t-this.#r*e,this.#s=i*e+this.#s*t,this.#r=s*e+this.#r*t}getTransform(){return{a:this.#e,b:this.#i,c:this.#s,d:this.#r,e:this.#n,f:this.#h}}new(t=1,e=0,i=0,s=1,r=0,n=0){return new can(this.t,t,e,i,s,r,n,this.#a,this.#u,this.s)}reset(t=1,e=0,i=0,s=1,r=0,n=0){this.#e=t,this.#i=e,this.#s=i,this.#r=s,this.#n=r,this.#h=n,this.#a=290787599,this.#u=$.Shader.DEFAULT,this.s=df}box(t=0,e=0,i=1,s=i){this.#n+=t*this.#e+e*this.#s,this.#h+=t*this.#i+e*this.#r,this.#e*=i,this.#i*=i,this.#s*=s,this.#r*=s}to(t=0,e=0){return"object"==typeof t&&(e=t.y,t=t.x),new V(this.#e*t+this.#s*e+this.#n,this.#i*t+this.#r*e+this.#h)}from(t=0,e=0){"object"==typeof t&&(e=t.y,t=t.x);const i=this.#e,s=this.#i,r=this.#s,n=this.#r,h=i*n-s*r;return new V((t*n-t*r+r*this.#h-n*this.#n)/h,(e*i-e*s+s*this.#n-i*this.#h)/h)}toDelta(t=0,e=0){return"object"==typeof t&&(e=t.y,t=t.x),new V(this.#e*t+this.#s*e,this.#i*t+this.#r*e)}fromDelta(t=0,e=0){"object"==typeof t&&(e=t.y,t=t.x);const i=this.#e,s=this.#i,r=this.#s,n=this.#r,h=i*n-s*r;return new V((t*n-t*r)/h,(e*i-e*s)/h)}determinant(){return this.#e*this.#r-this.#i*this.#s}pixelRatio(){return sqrt((this.#e*this.#r-this.#i*this.#s)*this.t.w*this.t.h)}sub(){return new can(this.t,this.#e,this.#i,this.#s,this.#r,this.#n,this.#h,this.#a,this.#u,this.s)}resetTo(t){this.#e=t.#e,this.#i=t.#i,this.#s=t.#s,this.#r=t.#r,this.#n=t.#n,this.#h=t.#h,this.#a=t.#a,this.#u=t.#u,this.s=t.s}set shader(t){this.#u="function"==typeof t?t:$.Shader.DEFAULT}get shader(){return this.#u}set mask(t){this.#a=-256&this.#a|255&t}get mask(){return 255&this.#a}set blend(t){this.#a=255&this.#a|(t||1135889)<<8}get blend(){return this.#a>>8}get geometry(){return this.s}set geometry(t){this.s=t||df}draw(...t){setv(this.t,this.#a);const e=this.#u(t);arr[e]=this.#e,arr[e+1]=this.#s,arr[e+2]=this.#n,arr[e+3]=this.#i,arr[e+4]=this.#r,arr[e+5]=this.#h}drawRect(t=0,e=0,i=1,s=1,...r){setv(this.t,this.#a);const n=this.#u(r);arr[n]=this.#e*i,arr[n+1]=this.#s*s,arr[n+2]=this.#n+t*this.#e+e*this.#s,arr[n+3]=this.#i*i,arr[n+4]=this.#r*s,arr[n+5]=this.#h+t*this.#i+e*this.#r}drawMat(t=1,e=0,i=0,s=1,r=0,n=0,...h){setv(this.t,this.#a);const a=this.#u(h),u=this.#e,o=this.#i,l=this.#s,f=this.#r,c=this.#n,q=this.#h;arr[a]=u*t+l*e,arr[a+1]=u*i+l*s,arr[a+2]=u*r+l*n+c,arr[a+3]=o*t+f*e,arr[a+4]=o*i+f*s,arr[a+5]=o*r+f*n+q}dup(i){if(i){const w=sh.count;if(i+w>arr.length)gr();for(let j=i-w;j<i;j++)iarr[j+w]=iarr[j];arr[i]=this.#e,arr[i+1]=this.#s,arr[i+2]=this.#n,arr[i+3]=this.#i,arr[i+4]=this.#r,arr[i+5]=this.#h;i+=w}}dupRect(t=0,e=0,i=1,s=1){if(i){const w=sh.count;if(i+w>arr.length)gr();for(let j=i-w;j<i;j++)iarr[j+w]=iarr[j];arr[i]=this.#e*i,arr[i+1]=this.#s*s,arr[i+2]=this.#n+t*this.#e+e*this.#s,arr[i+3]=this.#i*i,arr[i+4]=this.#r*s,arr[i+5]=this.#h+t*this.#i+e*this.#r;i+=w}}dupMat(t=1,e=0,i=0,s=1,r=0,n=0){if(i){const w=sh.count;if(i+w>arr.length)gr();for(let j=i-w;j<i;j++)iarr[j+w]=iarr[j];const u=this.#e,o=this.#i,l=this.#s,f=this.#r,c=this.#n,q=this.#h;arr[i]=u*t+l*e,arr[i+1]=u*i+l*s,arr[i+2]=u*r+l*n+c,arr[i+3]=o*t+f*e,arr[i+4]=o*i+f*s,arr[i+5]=o*r+f*n+q;i+=w}}clear(t=0,e=t,s=t,r=e){"object"==typeof t&&(r=t.w??0,s=t.z??0,e=t.y,t=t.x),i&&L(),setv(this.t,this.#a),g.clearColor(t,e,s,r);const n=this.t.stencil=this.t.stencil+1&7;g.clear(n?16384:(g.stencilMask(255),17408)),g.disable(2960),pmask&=-241}clearStencil(){i&&L(),setv(this.t,this.#a);(this.t.stencil=this.t.stencil+1&7)||(g.stencilMask(255),g.clear(1024)),g.disable(2960),pmask&=-241}}let pmask=285217039;function setv(t,e){const s=t.stencil;let r=pmask^e;if(ca!=t){if(i&&L(),t.c){ca.c||g.bindFramebuffer(36160,fb),t.T==fbTex&&t.layer==fbLayer||g.framebufferTextureLayer(36160,36064,fbTex=t.T,0,fbLayer=t.layer),t.stencilBuf!=J&&(g.bindRenderbuffer(36161,J=t.stencilBuf),g.framebufferRenderbuffer(36160,36128,36161,J));const e=t.c.t;g.viewport(0,0,e.w,e.h),e.i>=0&&(g.activeTexture(33984+e.i),g.bindTexture(35866,bound[e.i]=null),e.i=-1),ca.stencil==s||240&r||(r^=240)}else g.bindFramebuffer(36160,null),g.viewport(0,0,g.canvas.width,g.canvas.height);ca=t}if(r){if(i&&L(),15&r&&g.colorMask(1&e,2&e,4&e,8&e),240&r)if(240&e){240&pmask||g.enable(2960),g.stencilMask(1<<s),g.stencilFunc(32&e?16&e?g.NEVER:g.NOTEQUAL:16&e?g.EQUAL:g.ALWAYS,255,1<<s);const t=128&e?64&e?g.INVERT:g.REPLACE:64&e?g.ZERO:g.KEEP;g.stencilOp(t,t,t)}else 240&pmask&&g.disable(2960);1996488704&r&&g.blendEquationSeparate(32773+(e>>24&7),32773+(e>>28&7)),16776960&r&&g.blendFuncSeparate((e>>8&15)+766*!!(3584&e),(e>>16&15)+766*!!(917504&e),(e>>12&15)+766*!!(57344&e),(e>>20&15)+766*!!(14680064&e)),-2147483648&r&&(-2147483648&e?g.enable(3024):g.disable(3024)),pmask=e}}function L(t=S){g.bufferData(34962,iarr.subarray(0,i),35040);const{type:e,start:s,length:r}=sp;fd+=i,i/=sh.count,fdc++,fs+=i,g.drawArraysInstanced(e,s,r,i),i=0,Q=t;if(pf.length){tl??=pf[0];for(let f of pf)f.s=g.fenceSync(37143,0),hd=hd?hd.n=f:f;pf.length=0}}$.Blend=T=(t=17,e=17,i=0,s=!1)=>t|i<<8|e<<16|s<<23,Object.assign(T,{REPLACE:1114129,DEFAULT:1135889,ADD:1118481,MULTIPLY:1122816,SUBTRACT:5574929,REVERSE_SUBTRACT:6689041,MIN:2232593,MAX:3346705,BEHIND:1118583});let sh=null,ca=null,fbTex=null,J=null,fbLayer=0,F=0,M=0;const fb=g.createFramebuffer(),buf=g.createBuffer();g.bindBuffer(34962,buf);const H=Math.min(32,g.getParameter(34930)),bound=[];for(let t=H<<1;t>0;t--)bound.push(null);T=$.Geometry=(t,e)=>{if(e.length&3)throw"points.length is not a multiple of 4";e instanceof Float32Array||(T=new Float32Array(e.length),T.set(e,0),e=T);const i=g.createBuffer();return g.bindBuffer(34962,i),g.bufferData(34962,e,35044),i.type=t,g.bindBuffer(34962,buf),{type:t,b:i,start:0,length:e.length>>2,sub}};function sub(e=0,i=this.length-e,s=this.type){return{type:s,b:this.b,start:this.start+e,length:i,sub}};let Q=0,sp=T.DEFAULT=T($.TRIANGLE_STRIP,[0,0,0,0,0,1,0,1,1,0,1,0,1,1,1,1]),S=0,w,tl=null,hd=null;const df=sp,pf=[],treeIf=(t=0,e=H,i=0)=>{if(e<=t+1)return w(t);const s=t+(1<<31-Math.clz32(e-t-1));return`if(u<${s+i}){${treeIf(t,s,i)}}else{${treeIf(s,e,i)}}`},names=["float","vec2","vec3","vec4","int","ivec2","ivec3","ivec4","uint","uvec2","uvec3","uvec4"];T=$.Shader=(P,Y,U,Z=4,defaults,uDefaults,frat=.5)=>{const E1=["(function({"],G=["",""],A=["#version 300 es\nprecision mediump float;precision highp int;layout(location=0)in vec4 _pos;out vec2 uv,xy;layout(location=1)in mat2x3 m;",""],D=["void main(){gl_PointSize=1.0;uv=_pos.zw;gl_Position=vec4((xy=vec3(_pos.xy,1.)*m)*2.-1.,0.,1.);"],C=["#version 300 es\nprecision mediump float;precision highp int;in vec2 uv,xy;uniform vec2 viewport;out "+(0==Z?"highp vec4 color;":16==Z||32==Z?"uvec4 color;":"lowp vec4 color;"),""];let j=6,o=0,K=0,I=0;const types=[3,3],texCheck=[];let id=0;Y="number"==typeof Y?[Y]:Y||[],U="number"==typeof U?[U]:U||[],defaults=null!=defaults?Array.isArray(defaults)?defaults:[defaults]:[],uDefaults=null!=uDefaults?Array.isArray(uDefaults)?uDefaults:[uDefaults]:[];for(const t of Y){let e=1+(3&t),i=names[3&t|t>>4<<2];const s=4==t||8==t||12==t;defaults[id]??=4==t?v4z:1==e?0:2==e?v2z:3==e?v3z:v4z,E1.push(id+":a"+j+"=defaults["+id+"],");const r=t>15?(o|=1,"iarr[j+"):"arr[j+";if(20!=t&&24!=t&&28!=t||(i="int",o|=1<<(t>>2)-3,K++,texCheck.push(`a${j}=(c.L(a${j+(24==t?".t,-1":".t,0")})+1||(i&&L(b^Q),c.L(a${j+(24==t?".t,-1":".t,0")})+1))-1`)),12!=t&&28!=t||(o|=2),8!=t&&24!=t||(I++,K--),s){texCheck.push(`let a${j+1}=${4==t?`-1;if(a${j}.t&&(a${j+1}=c.L(a${j}.t,0))==-1)`:`c.L(a${j+(8==t?".t,-1":".t,0")});if(a${j+1}==-1)`}{i&&L(b^Q);a${j+1}=c.L(a${j+(8==t?".t,-1":".t,0")})}`),K++;const i=`arg${id}raw`;for(A.push(`layout(location=${types.length+1})in int i${j};layout(location=${types.length+2})in vec4 i${j+1};centroid out vec4 ${i};`),D.push(4!=t?`${i}=vec4(i${j+1}.xy+uv*i${j+1}.zw,i${j}&255,i${j}>>8);`:`if(i${j}<0){${i}=i${j+1};${i}.w=max(-15856.,${i}.w);}else{${i}=vec4(i${j+1}.xy+uv*i${j+1}.zw,i${j}&255,i${j}<256?-15872:(i${j}>>8<<4)-16384);}`),C.push(`centroid in vec4 ${i};${4==t?"lowp ":8==t?"u":"highp "}vec4 arg${id}(){`+(4==t?`if(${i}.w>-15872.)return ${i};return getCol(int(${i}.w)>>4&31,${i}.xyz);}`:8==t?`return uGetCol(int(${i}.w),${i}.xyz);}`:`return fGetCol(int(${i}.w),${i}.xyz);}`)),o|=1<<1+(t>>2),types.push(17,4),G.push("iarr[j+"+j+"]=a"+(j+1)+"<<8|a"+j+".l&255"),e=0;++e<3;)G.push(r+(j+e)+"]=a"+j+"."+" xy"[e]);G.push(`if(a${j+1}>=0)${r+(j+3)}]=a${j}.w,${r+(j+4)}]=a${j}.h;else ${r+(j+3)}]=a${j}.z,${r+(j+4)}]=a${j}.w`),e=5}else if(A.push("layout(location="+(types.length+1)+")in "+i+" i"+j+";flat out "+i+" arg"+id+";"),D.push("arg"+id+"=i"+j+";"),C.push("flat in "+i+" arg"+id+";"),types.push(e|48&t),1==e)G.push(r+j+"]=a"+j);else for(let t=-1;++t<e;)G.push(r+(j+t)+"]=a"+j+"."+"xyzw"[t]);j+=e,id++}id=0;let j2=0,j3=0;const fn2Params=[],E=["fd+=j2;i&&L(0);if(sh!=s){F=K;M=R;g.useProgram((sh=s).p);g.bindVertexArray(s.vao)}"],F1=[],N=[],O=[];for(const t of U){let e=1+(3&t),i=names[3&t|t>>4<<2];if(uDefaults[id]??=4==t?v4z:1==e?0:2==e?v2z:3==e?v3z:v4z,fn2Params.push("a"+j2+"=uDefaults["+id+"]"),12!=t&&28!=t||(o|=2),8!=t&&24!=t||(I++,K--),20==t||24==t||28==t)o|=1<<(t>>2)-3,K++,F1.push(`g.uniform1i(O[${j3}],N[${N.length}]?c.L(N[${N.length}]${24==t?",-1":",0"}):${24==t?H:0})`),C.push("uniform int uni"+id+";"),E.push(`N[${N.length}]=a${j2}.t`),N.push(null);else if(4==t||8==t||12==t){F1.push(`g.uniform1i(O[${j3++}],N[${N.length}]?c.L(N[${N.length}]${8==t?",-1":",0"}):${8==t?H:0})`),N.push(null),K++;const e=`uni${id}raw`;A.push(`uniform int u${j2};uniform vec4 u${j2+1};centroid out vec4 ${e};`),D.push(4!=t?`${e}=vec4(u${j2+1}.xy+uv*u${j2+1}.zw,u${j2}&255,u${j2}>>8);`:`if(u${j2}<0){${e}=u${j2+1};${e}.w=max(-15856.,${e}.w);}else{${e}=vec4(u${j2+1}.xy+uv*u${j2+1}.zw,u${j2}&255,u${j2}<256?-15872:(u${j2}>>8<<4)-16384);}`),C.push(`centroid in vec4 ${e};${4==t?"lowp ":8==t?"u":"highp "}vec4 uni${id}(){`+(4==t?`if(${e}.w>-15872.)return ${e};return getCol(int(${e}.w)>>4&31,${e}.xyz);}`:8==t?`return uGetCol(int(${e}.w),${e}.xyz);}`:`return fGetCol(int(${e}.w),${e}.xyz);}`)),o|=1<<1+(t>>2),E.push(`N[${N.length-1}]=a${j2}.t;g.uniform4f(O[${j3}],a${j2}.x,a${j2}.y,a${j2}.w,a${j2}.h)`)}else{C.push("uniform "+i+" uni"+id+";");let s=`g.uniform${e+(t<16?"f":t<32?"i":"ui")}(O[${j3}]`;if(1==e)s+=",a"+j2;else for(let t=-1;++t<e;)s+=",a"+j2+"."+"xyzw"[t];E.push(s+")")}j2+=e,id++,j3++}if(K+I>16)throw"Shaders cannot use more than 16 textures/colors";K=K?I?K+Math.round(frat*(H-K-I)):H:0,I=I&&H-K,w=t=>"return texture(GL_f["+t+"],p);";let T=null;C[1]=(20&o?"uniform "+(2&o?"highp":"lowp")+" sampler2DArray GL_f["+K+"];":"")+(8&o?"uniform highp usampler2DArray GL_i["+I+"];":"")+(4&o?`lowp vec4 getCol(int u,vec3 p){${T=treeIf(0,K)}}`:"")+(16&o?`highp vec4 fGetCol(int u,vec3 p){${T||treeIf(0,K)}}`:"")+(8&o?`uvec4 uGetCol(int u,vec3 p){${w=t=>"return texture(GL_i["+t+"],p);",treeIf(0,H-K,H)}}`:""),C[1]+=(4&o?`lowp vec4 getPixel(int u,ivec3 p,int l){${w=t=>"return texelFetch(GL_f["+t+"],p,l);",T=treeIf(0,K)}}`:"")+(16&o?`highp vec4 fGetPixel(int u,ivec3 p,int l){${T||treeIf(0,K)}}`:"")+(8&o?`uvec4 uGetPixel(int u,ivec3 p,int l){${w=t=>"return texelFetch(GL_i["+t+"],p,l);",treeIf(0,H-K,H)}}`:"")+(28&o?`ivec3 getSize(int u,int l){${w=t=>"return textureSize(GL_"+(t<K?"f["+t:"i["+(t-K))+"],l);",T=treeIf(0,H)}}`:""),G[0]="}){if(sh!=s){i&&L(0);F=K;M=R;g.useProgram((sh=s).p);g.bindVertexArray(s.vao);B()}if(sp!=this.s){i&&L();sp=this.s}if(s.geometry!=this.s.b){g.bindBuffer(34962,s.geometry=this.s.b);g.vertexAttribPointer(0,4,5126,0,0,0);g.bindBuffer(34962,buf)}const b=Q^S;"+texCheck.join(";")+";const j=i;if((i=j+"+j+")>arr.length)"+(ArrayBuffer.prototype.transfer?"arr=new Float32Array(arr.buffer.transfer(i*8)),iarr=new Int32Array(arr.buffer)":"{const oa=arr;(arr=new Float32Array(i*2)).set(oa,0);iarr=new Int32Array(arr.buffer)}"),G.push("return j})");const s=eval(E1.join("")+G.join(";")),p=s.p=g.createProgram();s.uniforms=eval(`(function(${fn2Params}){${E.join(";")};B()})`);const B=eval(`(function(){${F1.join(";")};S=Q})`),R=32-K&&-1>>>K;const v=g.createShader(35633),f=g.createShader(35632);for(D.push("}"),g.shaderSource(v,A.join("")+D.join("")),g.compileShader(v),g.shaderSource(f,P=C.join("")+"\n"+P),g.compileShader(f),g.attachShader(p,v),g.attachShader(p,f),(T=g.getShaderInfoLog(f))&&console.warn("GLSL Error:\n"+T),g.linkProgram(p),g.useProgram(p);j3--;)O.push(g.getUniformLocation(p,"uni"+O.length));for(let t=0;t<H;t++)g.uniform1i(g.getUniformLocation(p,t<K?"GL_f["+t+"]":"GL_i["+(t-K)+"]"),t>=K?H+t-K:t);s.count=j,g.bindVertexArray(s.vao=g.createVertexArray());let i1=1,i2=0;g.bindBuffer(34962,s.geometry=df.b),g.enableVertexAttribArray(0),g.vertexAttribPointer(0,4,5126,0,0,0),g.bindBuffer(34962,buf);for(const t of types)g.enableVertexAttribArray(i1),t>>4?g.vertexAttribIPointer(i1,15&t,(t>31)+5124,j<<2,i2):g.vertexAttribPointer(i1,15&t,5126,0,j<<2,i2),g.vertexAttribDivisor(i1++,1),i2+=(15&t)<<2;return sh&&(g.useProgram(sh.p),g.bindVertexArray(sh.vao)),s};let fdc=0,fs=0,fd=0;return T.DEFAULT=sh=T("void main(){color=arg0()*arg1;}",[4,3],void 0,void 0,[void 0,$.vec4.one]),T.UINT=T("void main(){color=arg0();}",8,void 0,32),T.NONE=T("void main(){color=vec4(0,0,0,1);}"),g.useProgram(sh.p),g.bindVertexArray(sh.vao),$.flush=()=>i&&L(),$.ctx=new can(ca={T:g.canvas,c:null,layer:0,stencil:0,stencilBuf:null,w:0,h:0}),$.setSize=(w=0,h=0)=>g.viewport(0,0,$.ctx.t.w=g.canvas.width=w,$.ctx.t.h=g.canvas.height=h),$.wait=()=>{let r,p=new Promise(R=>r=R);p.s=i?(pf.push(p),null):(tl??=p,hd=hd?hd.n=p:p,g.fenceSync(37143,0));p.r=r;p.done=!1;return p},$.loop=(F=null)=>{if("t"in $)return $;$.render??=null;$.frameDrawCalls=0,$.frameSprites=0,$.frameData=0,$.t=performance.now()/1e3,$.dt=0,$.ctxFramerate??=-1,$.timeToFrame=0,$.glLost??=null;let e=0;return setInterval((function t(){while(tl?.s&&g.getSyncParameter(tl.s,37140)==37145)g.deleteSync(tl.s),tl.done=!0,tl.r(),tl=tl.n;if(!tl)hd=null;if($.ctxFramerate<0)return;if(g.isContextLost?.())return $.glLost?.(),$.glLost=tl=hd=null;let s=performance.now()/1e3;if(!(s<e)){dt=max(.01/$.ctxFramerate,-($.t-($.t=s))),frameDrawCalls=fdc,frameSprites=fs,frameData=4*fd+24*fdc,fdc=fs=fd=0,ctx.clear(),ctx.reset();try{$.render?.()}catch(t){Promise.reject(t)}i&&L(),(s=performance.now()/1e3)>=(e+=1/$.ctxFramerate)&&setImmediate(t),timeToFrame=s-$.t}}),0),requestAnimationFrame((function t(){if(g.isContextLost?.())return $.glLost?.(),$.glLost=tl=hd=null;if(requestAnimationFrame(t),i&&L(),!($.ctxFramerate>=0)){F?.(),g.bindFramebuffer(36160,null),ca=ctx.t,dt=max(.001,min(-($.t-($.t=performance.now()/1e3)),.5)),$.frameDrawCalls=fdc,$.frameSprites=fs,$.frameData=4*fd+24*fdc,fdc=fs=fd=0,ctx.reset();try{$.render?.()}catch(t){Promise.reject(t)}i&&L(),timeToFrame=performance.now()/1e3-$.t}})),g.canvas},$}).bitmapOpts=q;Gamma.font=s=>{const t=s.Shader.MSDF=s.Shader("\nvoid main(){\n\tvec3 c = arg0().rgb;\n\tfloat sd = (uni0 < 0. ? c.r : max(min(c.r, c.g), min(max(c.r, c.g), c.b)))-.5+arg2*abs(uni0);\n\tfloat o = clamp(arg1*sd+.5,0.,1.);\n\tcolor = arg3*o;\n}",[COLOR,FLOAT,FLOAT,VEC4],[FLOAT],_,[_,1,0,vec4.one]);t.oldfv=0;const e=s.BreakToken=(s,t=0,e="",n)=>{if(s instanceof RegExp){let t=s.flags,e=t.indexOf("g");e>-1&&(t=t.slice(0,e)+t.slice(e+1)),t.includes("y")||(t+="y"),s=new RegExp(s.source,t)}else{let t="[";for(const e of s+""){const s=e.codePointAt();t+=s>=92&&s<=94||45==s?"\\"+e:e}s=new RegExp(t+"]","y")}return s.type=t,s.sep=e,s.next=n,s.sepW=s.sepA=s.sepS=0,s.sepL=null,s};e.NORMAL=0,e.NEVER_SPLIT=1,e.ALWAYS_SPLIT=2,e.OVERFLOW=3,e.VANISH=4,e.TRIM=5,e.SQUISH=6,e.SQUISH_SPLIT=7,e.BREAK_AFTER=8,e.BREAK_BEFORE=16,e.INVISIBLE=32;const n=[e(/\r\n?|\n/y,48,""),e(/[$£"+]?[\w'-]+[,.!?:;"^%€*]?/iy,0,"-"),e(/\s+/y,4)],i=e(/[^]/y),c=new Map,h=[],l=10,r=(s,t,e,n=0)=>{if(s.sepL=t,s.sepA=e,s.sepS=n,!t)return s.sepW=0;let i=0;const{map:c,kmap:h}=t,l=1/e;for(const t of s.sep){const s=t.codePointAt(),r=c.get(s);if(!r)continue;const a=r.xadv+n+(h.get(s+-1114112)??0);i+=e&&asin(a*e)*l||a}return t.then?.((()=>s.sepL==t&&(s.sepL=null,s.sepW=0))),s.sepW=i};class a extends Array{#s=null;#t=t;#e=1;#n=0;#i=1;#c=0;#h=0;#l=0;#r=null;#a=null;#o=null;#f=0;#u=NaN;#b=null;#g=-1;get width(){return this.#u}get length(){return this.#f}static#p=class e{constructor(s){this.#k=s}sub(){const s=new e(this.#k);return s.#y=this.#y,s.#m=this.#m,s.#_=this.#_,s.#d=this.#d,s.#w=this.#w,s.#v=this.#v,s.#q=this.#q,s.#A=this.#A,s}reset(s=null){this.#y="object"==typeof s?s:null,this.#m=t,this.#_=1,this.#d=0,this.#w=0,this.#v=0,this.#A=null,this.#q=0,this.#k.#b==this&&(this.#k.#b=null)}#k;#y=null;get font(){return this.#y}set font(s){"object"==typeof s&&(this.#y=s),this.#k.#b==this&&(this.#k.#b=null)}#m=t;get shader(){return this.#m}set shader(s){"function"==typeof s&&(this.#m=s),this.#k.#b==this&&(this.#k.#b=null)}#_=1;get scale(){return this.#_}set scale(s){this.#_=+s,this.#k.#b==this&&(this.#k.#b=null)}scaleBy(s=1,t=!0,e=!0){if(1==s)return;const n=this.#k,i=n.length;let c=0,h=0;for(;c<i;){const i=n[c++];if("number"==typeof i){if(i<0)continue;c++,3==i||4==i&&e?(h||(h=1),n[c-1]*=s):1==i&&t&&(n[c-1]*=s)}else"string"==typeof i&&(h||(h=2))}1!=h&&n.unshift(3,s),this.#_*=s,e&&(this.#x*=s),n.#u=NaN}#x=0;get yOffset(){return this.#x}set yOffset(s){this.#x=+s,this.#k.#b==this&&(this.#k.#b=null)}offsetBy(s=0){if(!s)return;const t=this.#k,e=t.length;let n=0,i=0;for(;n<e;){const e=t[n++];if("number"==typeof e){if(e<0)continue;n++,4==e&&(i||(i=1),t[n-1]+=s)}else"string"==typeof e&&(i||(i=2))}1!=i&&t.unshift(4,s),this.#x+=s}#d=1;get stretch(){return this.#d}set stretch(s){this.#d=+s,this.#k.#b==this&&(this.#k.#b=null)}stretchBy(s=1,t=!0,e=!1){if(1==s)return;const n=this.#k,i=n.length;let c=0,h=0;for(;c<i;){const i=n[c++];if("number"==typeof i){if(i<0)continue;c++,5==i||6==i&&e?(h||(h=1),n[c-1]*=s):1==i&&t&&(n[c-1]*=s)}else"string"==typeof i&&(h||(h=2))}1!=h&&(e?n.unshift(6,s,5,s):n.unshift(5,s)),this.#d*=s,e&&(this.#w*=s),n.#u=NaN}get letterWidth(){return this.#_*this.stretch}set letterWidth(s){this.stretch=s/this.#_}#w=0;get skew(){return this.#w}set skew(s){this.#w=+s,this.#k.#b==this&&(this.#k.#b=null)}skewBy(s=0){if(!s)return;const t=this.#k,e=t.length;let n=0,i=0;for(;n<e;){const e=t[n++];if("number"==typeof e){if(e<0)continue;n++,6==e&&(i||(i=1),t[n-1]+=s)}else"string"==typeof e&&(i||(i=2))}1!=i&&t.unshift(6,s),this.#w+=s}#v=0;get letterSpacing(){return this.#v}set letterSpacing(s){this.#v=+s,this.#k.#b==this&&(this.#k.#b=null)}spaceBy(s=0){if(!s)return;const t=this.#k,e=t.length;let n=0,i=0;for(;n<e;){const e=t[n++];if("number"==typeof e){if(e<0)continue;n++,7==e&&(i||(i=1),t[n-1]+=s)}else"string"==typeof e&&(i||(i=2))}1!=i&&t.unshift(7,s),this.#v+=s,t.#u=NaN}#q=0;get curve(){return this.#q}set curve(s){this.#q=+s,this.#k.#b==this&&(this.#k.#b=null)}curveBy(s=0){if(!s)return;const t=this.#k,e=t.length;let n=0,i=0;for(;n<e;){const e=t[n++];if("number"==typeof e){if(e<0)continue;n++,8==e?(i||(i=1),t[n-1]+=s):1!=e||i||(i=2)}else"string"==typeof e&&(i||(i=2))}1!=i&&t.unshift(8,s),this.#q+=s,t.#u=NaN}#A=null;get values(){return this.#A}set values(s){this.#A=s?.length?s:null,this.#k.#b==this&&(this.#k.#b=null)}#R=null;get backLines(){return this.#R}set backLines(s){this.#R=s?.length?s:null,this.#k.#b==this&&(this.#k.#b=null)}#N=null;get frontLines(){return this.#N}set frontLines(s){this.#N=s?.length?s:null,this.#k.#b==this&&(this.#k.#b=null)}drawOnly(){this.#k.push(this.#k._m=-3)}indexOnly(){this.#k.push(this.#k._m=-2)}drawAndIndex(){this.#k.push(this.#k._m=-1)}advance(s=0){const t=this.#k;t.l!=this&&this.#S(t),t.push(1,+s),t.w=NaN}#S(s){this.#y!=s.#s&&s.push(s.#s=this.#y),this.#m!=s.#t&&s.push(2,s.#t=this.#m),this.#_!=s.#e&&s.push(3,s.#e=this.#_),this.#x!=s.#n&&s.push(4,s.#n=this.#x),this.#d!=s.#i&&s.push(5,s.#i=this.#d),this.#w!=s.#c&&s.push(6,s.#c=this.#w),this.#v!=s.#h&&s.push(7,s.#h=this.#v),this.#q!=s.#l&&s.push(8,s.#l=this.#q),this.#A!=s.#r&&(s.push(this.#A??h),s.#r=this.#A),this.#R!=s.#a&&(s.push(9,this.#R??h),s.#a=this.#R),this.#N!=s.#o&&(s.push(l,this.#N??h),s.#o=this.#N),s.#b=this}slice(s=0,t=this.#k.#f){const n=this.#k,i=new a;s<0&&(s+=n.#f)<0&&(s=0),t<0&&(t+=n.#f)<0&&(t=0),t-=s;const c=new e(i);let h=0,r="";for(;s>0&&h<n.length;){const e=n[h++];if("number"==typeof e){if(e<0){i.#g=e;continue}const s=n[h++];switch(e){case 2:c.#m=s;break;case 3:c.#_=s;break;case 4:c.#x=s;break;case 5:c.#d=s;break;case 6:c.#w=s;break;case 7:c.#v=s;break;case 8:c.#q=s;break;case 9:c.#R=s;break;case l:c.#N=s}}else if("string"==typeof e){if(!(2&i.#g))continue;if((s-=e.length)<0){r=e.slice(s,(t+=s)+e.length);break}}else Array.isArray(e)?c.#A=e:c.#y=e}for(c.#S(i),-1!=i.#g&&i.push(i.#g),r&&(i.push(r),i.#f+=r.length);t>0&&h<n.length;){const s=n[h++];if(i.push(s),"number"==typeof s){if(s<0){i.#g=s;continue}const t=n[h++];switch(i.push(t),s){case 2:c.#m=t;break;case 3:c.#_=t;break;case 4:c.#x=t;break;case 5:c.#d=t;break;case 6:c.#w=t;break;case 7:c.#v=t;break;case 8:c.#q=t;break;case 9:c.#R=t;break;case l:c.#N=t}}else if("string"==typeof s){if(!(2&i.#g))continue;t-=s.length,i.#f+=s.length,t<0?(i[i.length-1]=s.slice(0,t),i.#f+=s.length+t):i.#f+=s.length}else Array.isArray(s)?c.#A=s:c.#y=s}return c}trim(s=0){const e=this.#k;if(s<0&&(s+=e.#f)<0&&(s=0),s>=e.#f)return;e.#f=s<0?0:s;let n=0;for(e.#s=null,e.#t=t,e.#e=1,e.#i=1,e.#n=0,e.#c=0,e.#h=0,e.#g=-1,e.#l=0,e.#r=null;s>0&&n<e.length;){const t=e[n++];if("number"==typeof t){if(t<0){e.#g=t;continue}const s=e[n++];switch(t){case 2:e.#t=s;break;case 3:e.#e=s;break;case 4:e.#n=s;break;case 5:e.#i=s;break;case 6:e.#c=s;break;case 7:e.#h=s;break;case 8:e.#l=s;break;case 9:e.#a=s;break;case l:e.#o=s}}else if("string"==typeof t){if(!(2&mask))continue;if((s-=t.length)<0){e[n-1]=t.slice(0,s);break}}else Array.isArray(t)?e.#r=t:e.#s=t}this.#y=e.#s,this.#m=e.#t,this.#_=e.#e,this.#x=e.#n,this.#d=e.#i,this.#w=e.#c,this.#v=e.#h,this.#q=e.#l,this.#A=e.#r,this.#R=e.#a,this.#N=e.#o,e.length=n,e.#u=NaN}concat(s){const e=this.#k,n=s.#k;e.#f+=n.#f;let i=0;this.#y=null,this.#m=t,this.#_=1,this.#x=0,this.#d=1,this.#w=0,this.#v=0,this.#q=0,this.#A=null;const c=n.length;let h=-1,r="";for(;i<c;){const s=n[i++];if("number"==typeof s){if(s<0){h=s;continue}const t=e[i++];switch(s){case 1:e.push(s,t);break;case 2:this.#m=t;break;case 3:this.#_=t;break;case 4:this.#x=t;break;case 5:this.#d=t;break;case 6:this.#w=t;break;case 7:this.#v=t;break;case 8:this.#q=t;break;case 9:this.#R=t;break;case l:this.#N=t}}else if("string"==typeof s){if(2&h){r=s;break}}else Array.isArray(s)?this.#A=s:this.#y=s}for(this.#S(e),h!=e.#g&&e.push(e.#g=h),r&&e.push(r);i<c;){const s=n[i++];if(e.push(s),"number"==typeof s){if(s<0){e.#g=s;continue}const t=n[i++];switch(e.push(t),s){case 2:this.#m=t;break;case 3:this.#_=t;break;case 4:this.#x=t;break;case 5:this.#d=t;break;case 6:this.#w=t;break;case 7:this.#v=t;break;case 8:this.#q=t;break;case 9:this.#R=t;break;case l:this.#N=t}}else if("string"==typeof s){if(!(2&e.#g))continue;j-=s.length,e.#f+=s.length,j<0?(e[e.length-1]=s.slice(0,j),e.#f+=s.length+j):e.#f+=s.length}else Array.isArray(s)?this.#A=s:this.#y=s}e.#u=NaN}get length(){return this.#k.#f}set length(s){this.trim(s)}get width(){let s=this.#k.#u;if(s==s)return s;s=0;const t=this.#k;let e=c,n=c,i=0,h=1,l=1,r=0,a=-1,o=0,f=0,u=1,b=-1,g=1;for(;i<t.length;){let p=t[i++];if("number"==typeof p){if(p<0){a=p;continue}const e=t[i++];switch(p){case 1:s+=u*e;break;case 3:u=(h=e)*l;break;case 5:u=(l=e)*h;break;case 7:r=e;break;case 8:f=1/e,o=e}}else if("string"==typeof p){if(1&a)for(const t of p){const i=t.codePointAt(),c=e.get(i);if(!c)continue;const h=(n.get(i+1114112*b)??0)*min(u,g);b=i,g=u;const l=(c.xadv+r)*u+h;s+=o&&asin(l*o)*f||l,c.tex?.waiting&&c.tex.load()}}else if("object"==typeof p){if(!p){e=n=c;continue}if(Array.isArray(p))continue;e=p.map,n=p.kmap,p.then?.((()=>t.#u=NaN))}}return t.#u=s}add(s){const t=this.#k;t.#b!=this&&this.#S(t),2&t.#g&&(t.#f+=(s+="").length),t.push(s),t.#u=NaN}indexAt(s=0){const t=this.#k;let e=c,n=c,i=0,h=1,l=1,r=0,a=-1,o=0,f=0,u=1,b=-1,g=1,p=0;for(;i<t.length;){let k=t[i++];if("number"==typeof k){if(k<0){a=k;continue}const s=t[i++];switch(k){case 1:w+=u*s;break;case 3:u=(h=s)*l;break;case 5:u=(l=s)*h;break;case 7:r=s;break;case 8:f=1/s,o=s}}else if("string"==typeof k)if(1&a)for(const t of k){const i=t.codePointAt(),c=e.get(i);if(!c){2&a&&(p+=t.length);continue}const h=(n.get(i+1114112*b)??0)*min(u,g);b=i,g=u;const l=(c.xadv+r)*u+h,k=o&&asin(l*o)*f||l;if(s-=k,2&a){if(s<=-.5*k)return p;p+=t.length}}else 2&a&&(p+=k.length);else if("object"==typeof k){if(!k){e=n=c;continue}if(Array.isArray(k))continue;e=k.map,n=k.kmap}}}draw(s,e=null){const n=this.#k;let i=c,h=c,r=0,a=0,o=0,f=1,u=1,b=1,g=0,p=0,k=0,y=0,m=0,_=-1,d=null,w=null,v=s.shader=t,q=null,A=null,x=-1,R=1;const N=s.pixelRatio();let S=1,L=0;s:for(;r<n.length;){let t=n[r++];if("number"==typeof t){if(t<0){_=t;continue s}const e=n[r++];switch(t){case 1:if(m){p&&s.skew(-p,0);const t=.5/m,n=e*m*2;s.rotate(L),s.translate(sin(n)*t,(1-cos(n))*t),s.rotate(-n),L=0,p&&s.skew(p,0)}else s.translate(e,0);continue s;case 3:const n=e*u;u=1/e,s.scale(n),k*=f*=u,y*=f,R*=n,m*=n,f=e,A&&(S=N*A.normDistRange*f);continue s;case 4:k=e*u,y=k*p;continue s;case 2:s.shader=v=t;break;case 5:b=e;continue s;case 6:s.skew(e-p,0),p=e,y=k*e;continue s;case 7:g=.5*e;continue s;case 8:m=e*f;continue s;case 9:d=e;continue s;case l:w=e;continue s;default:continue s}}else{if("string"==typeof t){if(1&_)for(const n of t){const t=n.codePointAt(),c=i.get(t);if(e&&2&_){for(;a>=e[o];){const t=e[o++]=s.sub();p&&t.skew(-p,0),L&&t.rotate(L)}a+=n.length}if(!c)continue;const l=(h.get(t+1114112*x)??0)*min(R,b);x=t,R=b;const r=(c.xadv+g+g)*b+l,f=l-y;if(m&&(p&&s.skew(-p,0),s.rotate(L+(L=-asin(r*m)||0)),p&&s.skew(p,0)),d)for(let t=0;t<d.length;t+=2){const e=d[t],n=m*r*e;q?s.drawRect(f+n,e,r-n-n,d[t+1],vec4.one,S,...q):s.drawRect(f+n,e,r-n-n,d[t+1],vec4.one,S)}if(c.tex&&(q?s.drawRect((c.x+g)*b+f,c.y+k,c.w*b,c.h,c.tex,S,...q):s.drawRect((c.x+g)*b+f,c.y+k,c.w*b,c.h,c.tex,S)),w)for(let t=0;t<w.length;t+=2){const e=m*r*w[t];q?s.drawRect(f+e,w[t],r-e-e,w[t+1],vec4.one,S,...q):s.drawRect(f+e,w[t],r-e-e,w[t+1],vec4.one,S)}s.translate(r,0)}else if(ret&&2&_){for(;a>=e[ret.length];){const t=e[o++]=s.sub();p&&t.skew(-p,0),L&&t.rotate(L)}a+=t.length}continue}if(!t){i=h=c;continue}if(Array.isArray(t)){q=t.length?t:null;continue}A=t,i=t.map,h=t.kmap,S=N*A.normDistRange*f}if(A){const s=(1&A._flags?.5:-.5)/A.normDistRange;s!=v.oldfv&&v.uniforms(v.oldfv=s)}}p&&s.skew(-p,0),L&&s.rotate(L),1!=f&&s.scale(u)}break(s=1/0,t=n,h={scale:1,letterSpacing:0,curve:0}){const o=this.#k,f=this.toString(),u=[];let b="number"==typeof s?s:"function"==typeof s?s(u.length,h):s[min(u.length,s.length-1)],g=new a,p=g.l=new e(g),k=0,y=0,m="",_=c,d=c,w=1,v=1,q=-1,A=0,x=!1;for(;k<f.length;){let n,R=0,N=g.length,S=0,L=A,O=p.#m,B=p.#_,F=p.#x,I=p.#d,E=p.#w,P=p.#v,T=p.#y,W=p.#q,M=p.#A,j=g.#g,D=g.#f,H=p.#R,V=p.#N;s:{if(t)for(n of t){n.lastIndex=k;const s=n.exec(f);if(s){k+=R=s[0].length,t=n.next??t;break s}}k+=R=1,n=i}const C=n.type;16&C&&(u.push(p),g.#u=x?NaN:A,x=!1,p=p.sub(),p.#k=g=new a,b="number"==typeof s?s:"function"==typeof s?s(u.length,h):s[min(u.length,s.length-1)],N=L=A=D=0,-1!=j&&g.push(g.#g=j),p.#S(g));const G=32&C&&-2!=g.#g;if(m){let s=m;R<m.length?(s=m.slice(0,R),m=m.slice(R),R=0):(R-=m.length,m=""),G&&g.push(-2),s&&g.push(s),2&g.#g&&(g.#f+=s.length),G&&g.push(g.#g)}let U=!1;for(;R>0;){const s=o[y++];if("number"==typeof s){if(s<0){g.#g=s,g.push(s);continue}const t=o[y++];switch(U=!0,s){case 1:g.push(s,t);break;case 2:p.#m=t;break;case 3:p.#_=t,p.#d;break;case 4:p.#x=t;break;case 5:p.#d=t,p.#_;break;case 6:p.#w=t;break;case 7:p.#v=t;break;case 8:p.#q=t;break;case 9:p.#R=t;break;case l:p.#N=t}}else if("string"==typeof s){if(!(2&g.#g)){g.push(s);continue}R-=s.length;let t=s;R<0?(t=s.slice(0,R),m=s.slice(R)):m="",U&&p.#S(g),G&&g.push(-2),g.push(t),g.#f+=t.length,G&&g.push(g.#g)}else Array.isArray(s)?(p.#A=s,U=!0):(p.#y=s,U=!0)}for(U&&p.#S(g);;){let t=N,i=S,o=O,f=B,k=F,y=I,m=E,R=P,G=T,U=M,z=j,K=D,Q=W,Y=H,$=V,J=1/Q,X=!1,Z=!1,ss=n.sepL==G&&n.sepA==Q&&n.sepS==R?n.sepW:r(n,G,Q,R);const ts=C?0!=(36>>C&1):2*L<b,{scale:es=1,letterSpacing:ns=0,curve:is=0}=h;x||=1!=es||0!=ns||0!=is;let cs=Q+is,hs=R+ns;for(is&&(J=1/cs);t<g.length;){const s=g[t++];if("number"==typeof s){if(s<0){z=s;continue}const e=g[t++];switch(s){case 1:if(A+=e,X||!ts)break;const s=A-(b-(ss-(d.get(n.sep.codePointAt()+1114112*q)??0))*w);(X=s>0)?(N=t-1,S=U-s):(N=t,S=0),Z=!0,L=A,O=o,B=f,F=k,I=y,E=m,P=R,T=G,W=Q,M=U,H=Y,V=$,j=z,D=K;break;case 2:o=e;break;case 3:f=e,w=e*y*es;break;case 4:k=e;break;case 5:y=e,w=e*f*es;break;case 6:m=e;break;case 7:R=e,hs=e+ns;break;case 8:cs=e+is,J=1/cs,Q=e;break;case 9:Y=e;break;case l:$=e}}else if("string"==typeof s){if(1&z)for(const e of s){const s=e.codePointAt(),c=_.get(s);if(i+=e.length,!c)continue;const h=(d.get(s+1114112*q)??0)*min(w,v);v=w,q=s;const l=(c.xadv+hs)*w+h;A+=cs&&asin(l*cs)*J||l,!(X=A>b-(ss-(d.get(n.sep.codePointAt()+1114112*s)??0))*w)&&ts&&(Z=!0,N=t-1,S=i,L=A,O=o,B=f,F=k,I=y,E=m,P=R,T=G,W=Q,M=U,H=Y,V=$,j=z,D=K)}}else Array.isArray(s)?U=s:(G=s)?(_=s.map,d=s.kmap,ss=n.sepL==s&&n.sepA==Q&&n.sepS==R?n.sepW:r(n,s,Q,R)):(_=d=c,ss=0)}if(!L||A<=b||!N||3==C)break;if(t=N,i=S,o=O,f=B,k=F,y=I,m=E,R=P,G=T,U=M,Y=H,$=V,z=j,Q=W,K=D,6==C||7==C&&b-L>=A-b){const s=(b-L)/(A-L),e=g.length;for(g.splice(t,0,5,s*y),t+=2;t<e;){const e=g[t++];"number"!=typeof e||e<0||(5==e?g[t++]*=s:t++)}g.push(5,y);break}A=L;const ls=g[t],rs=new a,as=new e(rs),os=g.length;as.#m=o,as.#_=f,as.#x=k,as.#d=y,as.#w=m,as.#v=R,as.#R=Y,as.#N=$,as.#y=G,as.#A=U,as.#q=Q,rs.#g=z;let fs=t+=!!i;const us=4!=C&&5!=C;s:for(;fs<os;){const s=g[fs++];if("number"==typeof s){if(s<0){rs.#g=s;continue}const t=g[fs++];switch(s){case 1:if(us){fs--;break s}break;case 2:as.#m=t;break;case 3:as.#_=t;break;case 4:as.#x=t;break;case 5:as.#d=t;break;case 6:as.#w=t;break;case 7:as.#v=t;break;case 8:as.#q=t;break;case 9:as.#R=t;break;case l:as.#N=t}}else if("string"==typeof s){if(us){fs--;break}}else Array.isArray(s)?as.#A=s:as.#y=s}for(as.#S(rs);fs<os;)rs.push(g[fs++]);rs.#f=g.#f-K,g.#f=us?K:0,g.#u=x?NaN:A,x=!1,-1!=rs.#g&&rs.push(rs.#g),as.#m=rs.#t=p.#m,as.#_=rs.#e=p.#_,as.#x=rs.#n=p.#x,as.#d=rs.#i=p.#d,as.#w=rs.#c=p.#w,as.#v=rs.#h=p.#v,as.#R=rs.#a=p.#R,as.#N=rs.#o=p.#N,as.#q=rs.#l=p.#q,rs.#g=g.#g,g.length=t,i&&("number"==typeof ls?(g[t-1]=i,us&&rs.push(1,ls-i)):(g[t-1]=ls.slice(0,i),us&&rs.push(ls.slice(i)))),Z&&(-3!=g.#g&&g.push(g.#g=-3),g.push(n.sep)),u.push(p),p=as,g=rs,b="number"==typeof s?s:"function"==typeof s?s(u.length,h):s[min(u.length,s.length-1)],N=S=L=A=D=0}if(8&C){u.push(p),g.#u=x?NaN:A,x=!1;const t=g.#g;A=0,p=p.sub(),p.#k=g=new a,b="number"==typeof s?s:"function"==typeof s?s(u.length,h):s[min(u.length,s.length-1)],-1!=t&&g.push(g.#g=t),p.#S(g)}}return g.#u=x?NaN:A,u.push(p),u}toString(){let s="",t=!0,e=0;const n=this.#k,i=n.length;for(;e<i;){const i=n[e++];"number"==typeof i&&(i<0?t=!!(2&i):e++),"string"==typeof i&&t&&(s+=i)}return s}static#p=s.RichText=s=>s?new e(s):(s=new a).#b=new e(s)}}class o{_flags=0;normDistRange=0;#L=[];map=new Map;ascend=0;kmap=new Map;get then(){return this.#L?this.#O:void 0}#O(s,t){this.#L?.push(s,t)}get isMsdf(){return!!(1&this._flags)}set isMsdf(s){this._flags=-2&this._flags|s}done(){const s=this.#L;if(this.#L=null,s)for(let t=0;t<s.length;t+=2)s[t]?.(this)}error(s){const t=this.#L;if(this.#L=null,t)for(let e=1;e<t.length;e+=2)t[e]?.(s)}chlumsky(s,t){return fetch(s).then((t=>(s=t.url,t.json()))).then((s=>{const{atlas:{type:e,distanceRange:n,size:i,width:c,height:h},metrics:{ascender:l,descender:r},glyphs:a,kerning:o}=s,f=(this.isMsdf=e.toLowerCase().endsWith("msdf"))?Formats.RGB:Formats.R,u=Img(t,SMOOTH,f);this.normDistRange=n/i*2,this.ascend=l/(l-r);for(const{unicode1:s,unicode2:t,advance:e}of o)this.kmap.set(t+1114112*s,e);for(const{unicode:s,advance:t,planeBounds:e,atlasBounds:n}of a)this.map.set(s,e?{x:e.left,y:e.bottom,w:e.right-e.left,h:e.top-e.bottom,xadv:t,tex:u.sub(n.left/c,n.bottom/h,(n.right-n.left)/c,(n.top-n.bottom)/h)}:{x:0,y:0,w:0,h:0,xadv:t,tex:null});this.done()}),this.error.bind(this)),this}bmfont(s,t=0){return fetch(s).then((t=>(s=t.url,t.json()))).then((e=>{const{chars:n,distanceField:i,pages:c,info:{size:h},common:{base:l,lineHeight:r,scaleW:a,scaleH:o},kernings:f}=e,u=(this.isMsdf=i.fieldType.toLowerCase().endsWith("msdf"))?Formats.RGB:Formats.R;this.normDistRange=i.distanceRange/r*2;const b=this.ascend=l/r,g=c.map((t=>Img(new URL(t,s).href,SMOOTH,u)));for(const{first:s,second:t,amount:e}of f)this.kmap.set(t+1114112*s,e/h);for(const{id:s,x:e,y:i,width:c,height:l,xoffset:r,yoffset:f,xadvance:u,page:p}of n)this.map.set(s,{x:r/h,y:b-(f-t+l)/h,w:c/h,h:l/h,xadv:u/h,tex:c&&l?g[p].sub(e/a,1-(i+l)/o,c/a,l/o):null});this.done()}),this.error.bind(this)),this}draw(s,e,h=-1,n=0,i=0,c=0,...l){if(this.#L)return;c*=.5;let r=s.pixelRatio()*this.normDistRange,a=s.shader;void 0===a.oldfv&&(a=s.shader=t);const o=(1&this._flags?.5:-.5)/this.normDistRange;o!=a.oldfv&&a.uniforms(a.oldfv=o);let f=0;const{map:u,kmap:b}=this;i&&s.skew(i,0);for(const t of e){const e=t.codePointAt(),a=u.get(e);if(!a)continue;const o=b.get(e+1114112*h)??0;h=e;const g=a.xadv+c+c+o;n&&(i&&s.skew(-i,0),s.rotate(f+(f=-asin(g*n)||0)),i&&s.skew(i,0)),a.tex&&s.drawRect(a.x+c+o,a.y,a.w,a.h,a.tex,r,...l),s.translate(g,0)}return i&&s.skew(-i,0),f&&s.rotate(f),h}measure(s,t=0,e=0,n=-1){if(this.#L)return;const i=1/t;let c=0;const{map:h,kmap:l}=this;for(const r of s){const s=r.codePointAt(),a=h.get(s);if(!a)continue;const o=l.get(s+1114112*n)??0;n=s;const f=a.xadv+e+o;c+=t&&asin(f*t)*i||f}return c}}s.Font=()=>new o,s.Font.bmfont=(s,t)=>(new o).bmfont(s,t),s.Font.chlumsky=(s,t)=>(new o).chlumsky(s,t)};$.BitField??=class t extends Array{constructor(t){if(super(),Array.isArray(t))for(let e=0;e<t.length;e++)this.push(t[e]);else if(t instanceof Uint8Array)for(let e=0;e<t.length;e+=4)this.push(t[e]|t[1|e]<<8|t[2|e]<<16|t[3|e]<<24);else if(t)for(const e of t)this.set(e)}static parse(e){return Array.isArray(e)?Object.setPrototypeOf(e,t.prototype):new t}static decode(e,r=new t){r.length=0;let s=e.v32();for(;s--;)r.push(e.i32())}static encode(t,e){const r=e.length;t.v32(r);for(let e=0;e<r;e++)t.i32(this[e])}static of(...e){const r=new t;for(const t of e)r.set(t);return r}set(t){const e=t>>>5;for(;e>=this.length;)this.push(0);this[e]|=1<<(31&t)}unset(t){let e=this.length;const r=t>>>5;if(!(r>=e))for(this[r]&=~(1<<(31&t));e&&!this[--e];)super.pop()}toggle(t){let e=this.length;const r=t>>>5;for(;r>=e;)this.push(0),e++;for(this[r]^=1<<(31&t);e&&!this[--e];)super.pop()}has(t){const e=t>>>5;return!(e>=this.length)&&!!(this[e]&1<<(31&t))}pop(t){let e=t>>>5;if(e>=this.length)return!1;let r=this[e];if(r^=this[e]=r&~(1<<(31&t)),e==this.length-1)for(;e>=0&&!this[e--];)super.pop();return!!r}put(t){let e=t>>>5;for(;e>=this.length;)this.push(0);return!!(this[e]^(this[e]|=1<<(31&t)))}xor(t){let e=this.length;if(e==t.length)for(;e&&this[--e]==t[e];)super.pop();else{let r=e;for(e--;r<t.length;)this.push(t[r++])}for(let r=e;r>=0;r--)this[r]^=t[r]}and(t){let e=this.length;for(this.length>t.length&&(e=this.length=t.length);e&&!(this[--e]&t[e]);)super.pop();for(;e>0;)this[--e]&=t[e]}or(t){let e=this.length-1,r=e;for(;++r<t.length;)this.push(t[r]);for(let r=e;r>=0;r--)this[r]|=t[r]}firstUnset(){let t=-1;for(;++t<this.length;){const e=~this[t];if(e)return t<<5|31-clz32(e&-e)}return t<<5}firstSet(){let t=-1;for(;++t<this.length;)if(this[t])return t<<5|31-clz32(this[t]&-this[t]);return-1}lastSet(){let t=this.length;for(;--t>=0;)if(this[t])return t<<5|31-clz32(this[t]);return-1}popFirst(){let t=-1;for(;++t<this.length;)if(this[t]){let e=31-clz32(this[t]&-this[t]);for(this[t]&=~(1<<e),e|=t<<5,t=this.length;t&&!this[--t];)super.pop();return e}return-1}putFirst(){let t=-1;for(;++t<this.length;){const e=~this[t];if(!e)continue;const r=31-clz32(e&-e);return this[t]|=1<<r,t<<5|r}return this.push(1),t<<5}popLast(){let t=this.length;for(;--t>=0;)if(this[t]){let e=31-Math.clz32(this[t]);for(this[t]&=~(1<<e),e|=t<<5,t=this.length;t&&!this[--t];)super.pop();return e}return-1}clear(){this.length=0}[Symbol.iterator](){const t={value:0,done:!1};let e=0,r=-1;return{[Symbol.iterator](){return this},next:()=>{for(;e<this.length;e++,r=-1){const s=this[e]&r,o=31-clz32(s&-s);if(!(o<0))return r=-2<<o,t.value=e<<5|o,t}return e=1/0,t.done=!0,t}}}iter(t){for(let e=0;e<this.length;e++){let r=-1;for(;;){const s=this[e]&r,o=31-clz32(s&-s);if(o<0)break;r=-2<<o,t(e<<5|o)}}}[Symbol.for("nodejs.util.inspect.custom")](){let t="",e=0;for(let r=0;r<this.length;r++){let s=-1;for(;;){const o=this[r]&s,n=31-clz32(o&-o);if(n<0)break;s=-2<<n,t+=" "+(r<<5|n),e++}}return`BitField(${e}) {[33m${t} [m}`}toUint8Array(){let t=this.length-1,e=this[t],r=0;const s=new Uint8Array(t=(t<<2)+(39-clz32(e)>>3));for(;r<t;r+=4){const t=this[r>>2];s[r]=t,s[1|r]=t>>8,s[2|r]=s>>16,s[3|r]=s>>24}for(r-=4;r<t;)s[r++]=e,e>>=8;return s}},"remove"in[]||Object.defineProperty(Array.prototype,"remove",{value(t){let e=this.indexOf(t);if(e>-1){for(;e<b.length;)b[e]=b[++e];b.pop()}return e},enumerable:!1,configurable:!0});{let t=null,e=null;Gamma.input=(r,s=r.canvas)=>{const o=r.keys=new BitField;r.MOUSE=Object.freeze({LEFT:0,RIGHT:2,MIDDLE:1,BACK:3,FORWARD:4}),r.KEY=Object.freeze({A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,SPACE:32,SECTION:192,BACKTICK:223,TAB:9,BACK:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,META:91,METARIGHT:93,CAPSLOCK:20,UP:38,RIGHT:39,DOWN:40,LEFT:37,MOD:navigator.platform.startsWith("Mac")?91:17,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,MINUS:189,PLUS:187,OPENBR:219,CLOSEBR:221,SEMICOLON:186,APOS_HASH:222,BACKSLASH:220,COMMA:188,DOT:190,SLASH:191,PAUSE:19,CLEAR:12,HOME:36,END:35,PAGE_UP:33,PAGE_DOWN:34,INS:45,DEL:46,CTX_MENU:93,PAD_0:96,PAD_1:97,PAD_2:98,PAD_3:99,PAD_4:100,PAD_5:101,PAD_6:102,PAD_7:103,PAD_8:104,PAD_9:105,AT:192,PAD_DIV:111,PAD_MULT:106,PAD_SUB:109,PAD_ADD:107,PAD_DOT:110,NUM_LOCK:144,SCROLL_LOCK:145}),r.GAMEPAD=Object.freeze({A:256,B:257,X:258,Y:259,LB:260,RB:261,LT:262,RT:263,UP:268,DOWN:269,LEFT:270,RIGHT:271,MENU:300}),r.cursor=r.vec2(),r.mouse=r.vec2(),r.wheel=r.vec2();const n=new Map;(r.onKey=(t,e)=>{if(Array.isArray(t)){for(const s of t)r.onKey(s,e);return}const s=n.get(t&=65535);s?s.push(e):n.set(t,[e])}).remove=(t,e)=>{if(Array.isArray(t)){for(const s of t)r.onKey.remove(s,e);return}const s=n.get(t&=65535);s&&(s.remove(e),!s.length)&&n.delete(t)},(r.onKeyRelease=(t,e)=>{if(Array.isArray(t)){for(const s of t)r.onKeyRelease(s,e);return}const s=n.get(t=~(65535&t));s?s.push(e):n.set(t,[e])}).remove=(t,e)=>{if(Array.isArray(t)){for(const s of t)r.onKeyRelease.remove(s,e);return}const s=n.get(t=~(65535&t));s&&(s.remove(e),!s.length)&&n.delete(t)};const i=[],h=[];(r.onWheel=t=>{i.push(t)}).remove=t=>{i.remove(t)},(r.onMouse=t=>{h.push(t)}).remove=t=>{h.remove(t)},s.addEventListener("mouseover",(()=>{t||(t=o,e=n)})),s.addEventListener("mouseout",(()=>{if(t!=o)return;const r=new BitField(o);o.clear(),r.iter((t=>{const e=n.get(~t);if(e)for(const r of e)try{r(t)}catch(t){Promise.reject(t)}})),o.clear(),t=e=null})),s.addEventListener("mousedown",(t=>{t.preventDefault();const e=t.button;o.set(e);const r=n.get(e);if(r)for(const s of r)try{s(e)}catch(t){Promise.reject(t)}})),s.addEventListener("mouseup",(t=>{t.preventDefault();const e=t.button;if(!o.pop(e))return;const r=n.get(~e);if(r)for(const s of r)try{s(e)}catch(t){Promise.reject(t)}})),s.addEventListener("contextmenu",(t=>t.preventDefault())),s.addEventListener("wheel",(t=>{t.preventDefault(),wheel.x+=t.deltaX,wheel.y+=t.deltaY;for(const e of i)e(t.deltaX,t.deltaY)}),{passive:!1}),s.addEventListener("mousemove",(t=>{t.preventDefault(),mouse.x+=t.movementX,mouse.y+=t.movementY,cursor.x=t.offsetX/t.target.offsetWidth,cursor.y=1-t.offsetY/t.target.offsetHeight;for(const e of i)e(t.movementX,t.movementY)}))},document.addEventListener("keydown",(r=>{if(!t)return;if(r.preventDefault(),r.repeat)return;const s=r.keyCode;t.set(s);const o=e.get(s);if(o)for(const t of o)try{t(s)}catch(r){Promise.reject(r)}})),document.addEventListener("keyup",(r=>{if(!t)return;r.preventDefault();const s=r.keyCode;if(!t.pop(s))return;const o=e.get(~s);if(o)for(const t of o)try{t(s)}catch(r){Promise.reject(r)}}))}}